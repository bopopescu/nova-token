begin_unit
name|'from'
name|'__future__'
name|'import'
name|'absolute_import'
op|','
name|'division'
newline|'\n'
nl|'\n'
name|'import'
name|'time'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
nl|'\n'
name|'from'
op|'.'
name|'import'
name|'LockBase'
op|','
name|'NotLocked'
op|','
name|'NotMyLock'
op|','
name|'LockTimeout'
op|','
name|'AlreadyLocked'
newline|'\n'
nl|'\n'
DECL|class|SQLiteLockFile
name|'class'
name|'SQLiteLockFile'
op|'('
name|'LockBase'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"Demonstrate SQL-based locking."'
newline|'\n'
nl|'\n'
name|'import'
name|'tempfile'
newline|'\n'
name|'_fd'
op|','
name|'testdb'
op|'='
name|'tempfile'
op|'.'
name|'mkstemp'
op|'('
op|')'
newline|'\n'
name|'os'
op|'.'
name|'close'
op|'('
name|'_fd'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'unlink'
op|'('
name|'testdb'
op|')'
newline|'\n'
name|'del'
name|'_fd'
op|','
name|'tempfile'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'path'
op|','
name|'threaded'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        >>> lock = SQLiteLockFile(\'somefile\')\n        >>> lock = SQLiteLockFile(\'somefile\', threaded=False)\n        """'
newline|'\n'
name|'LockBase'
op|'.'
name|'__init__'
op|'('
name|'self'
op|','
name|'path'
op|','
name|'threaded'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'lock_file'
op|'='
name|'unicode'
op|'('
name|'self'
op|'.'
name|'lock_file'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'unique_name'
op|'='
name|'unicode'
op|'('
name|'self'
op|'.'
name|'unique_name'
op|')'
newline|'\n'
nl|'\n'
name|'import'
name|'sqlite3'
newline|'\n'
name|'self'
op|'.'
name|'connection'
op|'='
name|'sqlite3'
op|'.'
name|'connect'
op|'('
name|'SQLiteLockFile'
op|'.'
name|'testdb'
op|')'
newline|'\n'
nl|'\n'
name|'c'
op|'='
name|'self'
op|'.'
name|'connection'
op|'.'
name|'cursor'
op|'('
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'c'
op|'.'
name|'execute'
op|'('
string|'"create table locks"'
nl|'\n'
string|'"("'
nl|'\n'
string|'"   lock_file varchar(32),"'
nl|'\n'
string|'"   unique_name varchar(32)"'
nl|'\n'
string|'")"'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'sqlite3'
op|'.'
name|'OperationalError'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'connection'
op|'.'
name|'commit'
op|'('
op|')'
newline|'\n'
name|'import'
name|'atexit'
newline|'\n'
name|'atexit'
op|'.'
name|'register'
op|'('
name|'os'
op|'.'
name|'unlink'
op|','
name|'SQLiteLockFile'
op|'.'
name|'testdb'
op|')'
newline|'\n'
nl|'\n'
DECL|member|acquire
dedent|''
dedent|''
name|'def'
name|'acquire'
op|'('
name|'self'
op|','
name|'timeout'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'end_time'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'if'
name|'timeout'
name|'is'
name|'not'
name|'None'
name|'and'
name|'timeout'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'end_time'
op|'+='
name|'timeout'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'timeout'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'wait'
op|'='
number|'0.1'
newline|'\n'
dedent|''
name|'elif'
name|'timeout'
op|'<='
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'wait'
op|'='
number|'0'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'wait'
op|'='
name|'timeout'
op|'/'
number|'10'
newline|'\n'
nl|'\n'
dedent|''
name|'cursor'
op|'='
name|'self'
op|'.'
name|'connection'
op|'.'
name|'cursor'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'while'
name|'True'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'self'
op|'.'
name|'is_locked'
op|'('
op|')'
op|':'
newline|'\n'
comment|'# Not locked.  Try to lock it.'
nl|'\n'
indent|'                '
name|'cursor'
op|'.'
name|'execute'
op|'('
string|'"insert into locks"'
nl|'\n'
string|'"  (lock_file, unique_name)"'
nl|'\n'
string|'"  values"'
nl|'\n'
string|'"  (?, ?)"'
op|','
nl|'\n'
op|'('
name|'self'
op|'.'
name|'lock_file'
op|','
name|'self'
op|'.'
name|'unique_name'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'connection'
op|'.'
name|'commit'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# Check to see if we are the only lock holder.'
nl|'\n'
name|'cursor'
op|'.'
name|'execute'
op|'('
string|'"select * from locks"'
nl|'\n'
string|'"  where unique_name = ?"'
op|','
nl|'\n'
op|'('
name|'self'
op|'.'
name|'unique_name'
op|','
op|')'
op|')'
newline|'\n'
name|'rows'
op|'='
name|'cursor'
op|'.'
name|'fetchall'
op|'('
op|')'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'rows'
op|')'
op|'>'
number|'1'
op|':'
newline|'\n'
comment|'# Nope.  Someone else got there.  Remove our lock.'
nl|'\n'
indent|'                    '
name|'cursor'
op|'.'
name|'execute'
op|'('
string|'"delete from locks"'
nl|'\n'
string|'"  where unique_name = ?"'
op|','
nl|'\n'
op|'('
name|'self'
op|'.'
name|'unique_name'
op|','
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'connection'
op|'.'
name|'commit'
op|'('
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
comment|"# Yup.  We're done, so go home."
nl|'\n'
indent|'                    '
name|'return'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
comment|'# Check to see if we are the only lock holder.'
nl|'\n'
indent|'                '
name|'cursor'
op|'.'
name|'execute'
op|'('
string|'"select * from locks"'
nl|'\n'
string|'"  where unique_name = ?"'
op|','
nl|'\n'
op|'('
name|'self'
op|'.'
name|'unique_name'
op|','
op|')'
op|')'
newline|'\n'
name|'rows'
op|'='
name|'cursor'
op|'.'
name|'fetchall'
op|'('
op|')'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'rows'
op|')'
op|'=='
number|'1'
op|':'
newline|'\n'
comment|"# We're the locker, so go home."
nl|'\n'
indent|'                    '
name|'return'
newline|'\n'
nl|'\n'
comment|'# Maybe we should wait a bit longer.'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'timeout'
name|'is'
name|'not'
name|'None'
name|'and'
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'>'
name|'end_time'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'timeout'
op|'>'
number|'0'
op|':'
newline|'\n'
comment|'# No more waiting.'
nl|'\n'
indent|'                    '
name|'raise'
name|'LockTimeout'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
comment|'# Someone else has the lock and we are impatient..'
nl|'\n'
indent|'                    '
name|'raise'
name|'AlreadyLocked'
newline|'\n'
nl|'\n'
comment|"# Well, okay.  We'll give it a bit longer."
nl|'\n'
dedent|''
dedent|''
name|'time'
op|'.'
name|'sleep'
op|'('
name|'wait'
op|')'
newline|'\n'
nl|'\n'
DECL|member|release
dedent|''
dedent|''
name|'def'
name|'release'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'self'
op|'.'
name|'is_locked'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'NotLocked'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'self'
op|'.'
name|'i_am_locking'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'NotMyLock'
op|'('
op|'('
name|'self'
op|'.'
name|'_who_is_locking'
op|'('
op|')'
op|','
name|'self'
op|'.'
name|'unique_name'
op|')'
op|')'
newline|'\n'
dedent|''
name|'cursor'
op|'='
name|'self'
op|'.'
name|'connection'
op|'.'
name|'cursor'
op|'('
op|')'
newline|'\n'
name|'cursor'
op|'.'
name|'execute'
op|'('
string|'"delete from locks"'
nl|'\n'
string|'"  where unique_name = ?"'
op|','
nl|'\n'
op|'('
name|'self'
op|'.'
name|'unique_name'
op|','
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'connection'
op|'.'
name|'commit'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|_who_is_locking
dedent|''
name|'def'
name|'_who_is_locking'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cursor'
op|'='
name|'self'
op|'.'
name|'connection'
op|'.'
name|'cursor'
op|'('
op|')'
newline|'\n'
name|'cursor'
op|'.'
name|'execute'
op|'('
string|'"select unique_name from locks"'
nl|'\n'
string|'"  where lock_file = ?"'
op|','
nl|'\n'
op|'('
name|'self'
op|'.'
name|'lock_file'
op|','
op|')'
op|')'
newline|'\n'
name|'return'
name|'cursor'
op|'.'
name|'fetchone'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
DECL|member|is_locked
dedent|''
name|'def'
name|'is_locked'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cursor'
op|'='
name|'self'
op|'.'
name|'connection'
op|'.'
name|'cursor'
op|'('
op|')'
newline|'\n'
name|'cursor'
op|'.'
name|'execute'
op|'('
string|'"select * from locks"'
nl|'\n'
string|'"  where lock_file = ?"'
op|','
nl|'\n'
op|'('
name|'self'
op|'.'
name|'lock_file'
op|','
op|')'
op|')'
newline|'\n'
name|'rows'
op|'='
name|'cursor'
op|'.'
name|'fetchall'
op|'('
op|')'
newline|'\n'
name|'return'
name|'not'
name|'not'
name|'rows'
newline|'\n'
nl|'\n'
DECL|member|i_am_locking
dedent|''
name|'def'
name|'i_am_locking'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cursor'
op|'='
name|'self'
op|'.'
name|'connection'
op|'.'
name|'cursor'
op|'('
op|')'
newline|'\n'
name|'cursor'
op|'.'
name|'execute'
op|'('
string|'"select * from locks"'
nl|'\n'
string|'"  where lock_file = ?"'
nl|'\n'
string|'"    and unique_name = ?"'
op|','
nl|'\n'
op|'('
name|'self'
op|'.'
name|'lock_file'
op|','
name|'self'
op|'.'
name|'unique_name'
op|')'
op|')'
newline|'\n'
name|'return'
name|'not'
name|'not'
name|'cursor'
op|'.'
name|'fetchall'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|break_lock
dedent|''
name|'def'
name|'break_lock'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cursor'
op|'='
name|'self'
op|'.'
name|'connection'
op|'.'
name|'cursor'
op|'('
op|')'
newline|'\n'
name|'cursor'
op|'.'
name|'execute'
op|'('
string|'"delete from locks"'
nl|'\n'
string|'"  where lock_file = ?"'
op|','
nl|'\n'
op|'('
name|'self'
op|'.'
name|'lock_file'
op|','
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'connection'
op|'.'
name|'commit'
op|'('
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
