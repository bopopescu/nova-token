begin_unit
name|'from'
name|'__future__'
name|'import'
name|'absolute_import'
op|','
name|'division'
newline|'\n'
nl|'\n'
name|'import'
name|'time'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'sys'
newline|'\n'
name|'import'
name|'errno'
newline|'\n'
nl|'\n'
name|'from'
op|'.'
name|'import'
op|'('
name|'LockBase'
op|','
name|'LockFailed'
op|','
name|'NotLocked'
op|','
name|'NotMyLock'
op|','
name|'LockTimeout'
op|','
nl|'\n'
name|'AlreadyLocked'
op|')'
newline|'\n'
nl|'\n'
DECL|class|MkdirLockFile
name|'class'
name|'MkdirLockFile'
op|'('
name|'LockBase'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Lock file by creating a directory."""'
newline|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'path'
op|','
name|'threaded'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        >>> lock = MkdirLockFile(\'somefile\')\n        >>> lock = MkdirLockFile(\'somefile\', threaded=False)\n        """'
newline|'\n'
name|'LockBase'
op|'.'
name|'__init__'
op|'('
name|'self'
op|','
name|'path'
op|','
name|'threaded'
op|')'
newline|'\n'
comment|'# Lock file itself is a directory.  Place the unique file name into'
nl|'\n'
comment|'# it.'
nl|'\n'
name|'self'
op|'.'
name|'unique_name'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'lock_file'
op|','
nl|'\n'
string|'"%s.%s%s"'
op|'%'
op|'('
name|'self'
op|'.'
name|'hostname'
op|','
nl|'\n'
name|'self'
op|'.'
name|'tname'
op|','
nl|'\n'
name|'self'
op|'.'
name|'pid'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|acquire
dedent|''
name|'def'
name|'acquire'
op|'('
name|'self'
op|','
name|'timeout'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'end_time'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'if'
name|'timeout'
name|'is'
name|'not'
name|'None'
name|'and'
name|'timeout'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'end_time'
op|'+='
name|'timeout'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'timeout'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'wait'
op|'='
number|'0.1'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'wait'
op|'='
name|'max'
op|'('
number|'0'
op|','
name|'timeout'
op|'/'
number|'10'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'while'
name|'True'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'os'
op|'.'
name|'mkdir'
op|'('
name|'self'
op|'.'
name|'lock_file'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'OSError'
op|':'
newline|'\n'
indent|'                '
name|'err'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
op|'['
number|'1'
op|']'
newline|'\n'
name|'if'
name|'err'
op|'.'
name|'errno'
op|'=='
name|'errno'
op|'.'
name|'EEXIST'
op|':'
newline|'\n'
comment|'# Already locked.'
nl|'\n'
indent|'                    '
name|'if'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'self'
op|'.'
name|'unique_name'
op|')'
op|':'
newline|'\n'
comment|'# Already locked by me.'
nl|'\n'
indent|'                        '
name|'return'
newline|'\n'
dedent|''
name|'if'
name|'timeout'
name|'is'
name|'not'
name|'None'
name|'and'
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'>'
name|'end_time'
op|':'
newline|'\n'
indent|'                        '
name|'if'
name|'timeout'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'                            '
name|'raise'
name|'LockTimeout'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
comment|'# Someone else has the lock.'
nl|'\n'
indent|'                            '
name|'raise'
name|'AlreadyLocked'
newline|'\n'
dedent|''
dedent|''
name|'time'
op|'.'
name|'sleep'
op|'('
name|'wait'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
comment|"# Couldn't create the lock for some other reason"
nl|'\n'
indent|'                    '
name|'raise'
name|'LockFailed'
op|'('
string|'"failed to create %s"'
op|'%'
name|'self'
op|'.'
name|'lock_file'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'open'
op|'('
name|'self'
op|'.'
name|'unique_name'
op|','
string|'"wb"'
op|')'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'return'
newline|'\n'
nl|'\n'
DECL|member|release
dedent|''
dedent|''
dedent|''
name|'def'
name|'release'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'self'
op|'.'
name|'is_locked'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'NotLocked'
newline|'\n'
dedent|''
name|'elif'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'self'
op|'.'
name|'unique_name'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'NotMyLock'
newline|'\n'
dedent|''
name|'os'
op|'.'
name|'unlink'
op|'('
name|'self'
op|'.'
name|'unique_name'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'rmdir'
op|'('
name|'self'
op|'.'
name|'lock_file'
op|')'
newline|'\n'
nl|'\n'
DECL|member|is_locked
dedent|''
name|'def'
name|'is_locked'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'self'
op|'.'
name|'lock_file'
op|')'
newline|'\n'
nl|'\n'
DECL|member|i_am_locking
dedent|''
name|'def'
name|'i_am_locking'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
op|'('
name|'self'
op|'.'
name|'is_locked'
op|'('
op|')'
name|'and'
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'self'
op|'.'
name|'unique_name'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|break_lock
dedent|''
name|'def'
name|'break_lock'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'self'
op|'.'
name|'lock_file'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'name'
name|'in'
name|'os'
op|'.'
name|'listdir'
op|'('
name|'self'
op|'.'
name|'lock_file'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'os'
op|'.'
name|'unlink'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'lock_file'
op|','
name|'name'
op|')'
op|')'
newline|'\n'
dedent|''
name|'os'
op|'.'
name|'rmdir'
op|'('
name|'self'
op|'.'
name|'lock_file'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
endmarker|''
end_unit
