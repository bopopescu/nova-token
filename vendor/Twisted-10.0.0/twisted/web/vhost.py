begin_unit
comment|'# -*- test-case-name: twisted.web.'
nl|'\n'
comment|'# Copyright (c) 2001-2009 Twisted Matrix Laboratories.'
nl|'\n'
comment|'# See LICENSE for details.'
nl|'\n'
nl|'\n'
string|'"""\nI am a virtual hosts implementation.\n"""'
newline|'\n'
nl|'\n'
comment|'# Twisted Imports'
nl|'\n'
name|'from'
name|'twisted'
op|'.'
name|'python'
name|'import'
name|'roots'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'web'
name|'import'
name|'resource'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|VirtualHostCollection
name|'class'
name|'VirtualHostCollection'
op|'('
name|'roots'
op|'.'
name|'Homogenous'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Wrapper for virtual hosts collection.\n\n    This exists for configuration purposes.\n    """'
newline|'\n'
DECL|variable|entityType
name|'entityType'
op|'='
name|'resource'
op|'.'
name|'Resource'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'nvh'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'nvh'
op|'='
name|'nvh'
newline|'\n'
nl|'\n'
DECL|member|listStaticEntities
dedent|''
name|'def'
name|'listStaticEntities'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'nvh'
op|'.'
name|'hosts'
op|'.'
name|'items'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|getStaticEntity
dedent|''
name|'def'
name|'getStaticEntity'
op|'('
name|'self'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'nvh'
op|'.'
name|'hosts'
op|'.'
name|'get'
op|'('
name|'self'
op|')'
newline|'\n'
nl|'\n'
DECL|member|reallyPutEntity
dedent|''
name|'def'
name|'reallyPutEntity'
op|'('
name|'self'
op|','
name|'name'
op|','
name|'entity'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'nvh'
op|'.'
name|'addHost'
op|'('
name|'name'
op|','
name|'entity'
op|')'
newline|'\n'
nl|'\n'
DECL|member|delEntity
dedent|''
name|'def'
name|'delEntity'
op|'('
name|'self'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'nvh'
op|'.'
name|'removeHost'
op|'('
name|'name'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|NameVirtualHost
dedent|''
dedent|''
name|'class'
name|'NameVirtualHost'
op|'('
name|'resource'
op|'.'
name|'Resource'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""I am a resource which represents named virtual hosts.\n    """'
newline|'\n'
nl|'\n'
DECL|variable|default
name|'default'
op|'='
name|'None'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Initialize.\n        """'
newline|'\n'
name|'resource'
op|'.'
name|'Resource'
op|'.'
name|'__init__'
op|'('
name|'self'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'hosts'
op|'='
op|'{'
op|'}'
newline|'\n'
nl|'\n'
DECL|member|listStaticEntities
dedent|''
name|'def'
name|'listStaticEntities'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'resource'
op|'.'
name|'Resource'
op|'.'
name|'listStaticEntities'
op|'('
name|'self'
op|')'
op|'+'
op|'['
op|'('
string|'"Virtual Hosts"'
op|','
name|'VirtualHostCollection'
op|'('
name|'self'
op|')'
op|')'
op|']'
newline|'\n'
nl|'\n'
DECL|member|getStaticEntity
dedent|''
name|'def'
name|'getStaticEntity'
op|'('
name|'self'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'name'
op|'=='
string|'"Virtual Hosts"'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'VirtualHostCollection'
op|'('
name|'self'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'resource'
op|'.'
name|'Resource'
op|'.'
name|'getStaticEntity'
op|'('
name|'self'
op|','
name|'name'
op|')'
newline|'\n'
nl|'\n'
DECL|member|addHost
dedent|''
dedent|''
name|'def'
name|'addHost'
op|'('
name|'self'
op|','
name|'name'
op|','
name|'resrc'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Add a host to this virtual host.\n\n        This will take a host named `name\', and map it to a resource\n        `resrc\'.  For example, a setup for our virtual hosts would be::\n\n            nvh.addHost(\'divunal.com\', divunalDirectory)\n            nvh.addHost(\'www.divunal.com\', divunalDirectory)\n            nvh.addHost(\'twistedmatrix.com\', twistedMatrixDirectory)\n            nvh.addHost(\'www.twistedmatrix.com\', twistedMatrixDirectory)\n        """'
newline|'\n'
name|'self'
op|'.'
name|'hosts'
op|'['
name|'name'
op|']'
op|'='
name|'resrc'
newline|'\n'
nl|'\n'
DECL|member|removeHost
dedent|''
name|'def'
name|'removeHost'
op|'('
name|'self'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Remove a host."""'
newline|'\n'
name|'del'
name|'self'
op|'.'
name|'hosts'
op|'['
name|'name'
op|']'
newline|'\n'
nl|'\n'
DECL|member|_getResourceForRequest
dedent|''
name|'def'
name|'_getResourceForRequest'
op|'('
name|'self'
op|','
name|'request'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""(Internal) Get the appropriate resource for the given host.\n        """'
newline|'\n'
name|'hostHeader'
op|'='
name|'request'
op|'.'
name|'getHeader'
op|'('
string|"'host'"
op|')'
newline|'\n'
name|'if'
name|'hostHeader'
op|'=='
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'default'
name|'or'
name|'resource'
op|'.'
name|'NoResource'
op|'('
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'host'
op|'='
name|'hostHeader'
op|'.'
name|'lower'
op|'('
op|')'
op|'.'
name|'split'
op|'('
string|"':'"
op|','
number|'1'
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
dedent|''
name|'return'
op|'('
name|'self'
op|'.'
name|'hosts'
op|'.'
name|'get'
op|'('
name|'host'
op|','
name|'self'
op|'.'
name|'default'
op|')'
nl|'\n'
name|'or'
name|'resource'
op|'.'
name|'NoResource'
op|'('
string|'"host %s not in vhost map"'
op|'%'
name|'repr'
op|'('
name|'host'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|render
dedent|''
name|'def'
name|'render'
op|'('
name|'self'
op|','
name|'request'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Implementation of resource.Resource\'s render method.\n        """'
newline|'\n'
name|'resrc'
op|'='
name|'self'
op|'.'
name|'_getResourceForRequest'
op|'('
name|'request'
op|')'
newline|'\n'
name|'return'
name|'resrc'
op|'.'
name|'render'
op|'('
name|'request'
op|')'
newline|'\n'
nl|'\n'
DECL|member|getChild
dedent|''
name|'def'
name|'getChild'
op|'('
name|'self'
op|','
name|'path'
op|','
name|'request'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Implementation of resource.Resource\'s getChild method.\n        """'
newline|'\n'
name|'resrc'
op|'='
name|'self'
op|'.'
name|'_getResourceForRequest'
op|'('
name|'request'
op|')'
newline|'\n'
name|'if'
name|'resrc'
op|'.'
name|'isLeaf'
op|':'
newline|'\n'
indent|'            '
name|'request'
op|'.'
name|'postpath'
op|'.'
name|'insert'
op|'('
number|'0'
op|','
name|'request'
op|'.'
name|'prepath'
op|'.'
name|'pop'
op|'('
op|'-'
number|'1'
op|')'
op|')'
newline|'\n'
name|'return'
name|'resrc'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'resrc'
op|'.'
name|'getChildWithDefault'
op|'('
name|'path'
op|','
name|'request'
op|')'
newline|'\n'
nl|'\n'
DECL|class|_HostResource
dedent|''
dedent|''
dedent|''
name|'class'
name|'_HostResource'
op|'('
name|'resource'
op|'.'
name|'Resource'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|getChild
indent|'    '
name|'def'
name|'getChild'
op|'('
name|'self'
op|','
name|'path'
op|','
name|'request'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
string|"':'"
name|'in'
name|'path'
op|':'
newline|'\n'
indent|'            '
name|'host'
op|','
name|'port'
op|'='
name|'path'
op|'.'
name|'split'
op|'('
string|"':'"
op|','
number|'1'
op|')'
newline|'\n'
name|'port'
op|'='
name|'int'
op|'('
name|'port'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'host'
op|','
name|'port'
op|'='
name|'path'
op|','
number|'80'
newline|'\n'
dedent|''
name|'request'
op|'.'
name|'setHost'
op|'('
name|'host'
op|','
name|'port'
op|')'
newline|'\n'
name|'prefixLen'
op|'='
number|'3'
op|'+'
name|'request'
op|'.'
name|'isSecure'
op|'('
op|')'
op|'+'
number|'4'
op|'+'
name|'len'
op|'('
name|'path'
op|')'
op|'+'
name|'len'
op|'('
name|'request'
op|'.'
name|'prepath'
op|'['
op|'-'
number|'3'
op|']'
op|')'
newline|'\n'
name|'request'
op|'.'
name|'path'
op|'='
string|"'/'"
op|'+'
string|"'/'"
op|'.'
name|'join'
op|'('
name|'request'
op|'.'
name|'postpath'
op|')'
newline|'\n'
name|'request'
op|'.'
name|'uri'
op|'='
name|'request'
op|'.'
name|'uri'
op|'['
name|'prefixLen'
op|':'
op|']'
newline|'\n'
name|'del'
name|'request'
op|'.'
name|'prepath'
op|'['
op|':'
number|'3'
op|']'
newline|'\n'
name|'return'
name|'request'
op|'.'
name|'site'
op|'.'
name|'getResourceFor'
op|'('
name|'request'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|VHostMonsterResource
dedent|''
dedent|''
name|'class'
name|'VHostMonsterResource'
op|'('
name|'resource'
op|'.'
name|'Resource'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'    '
string|'"""\n    Use this to be able to record the hostname and method (http vs. https)\n    in the URL without disturbing your web site. If you put this resource\n    in a URL http://foo.com/bar then requests to\n    http://foo.com/bar/http/baz.com/something will be equivalent to\n    http://foo.com/something, except that the hostname the request will\n    appear to be accessing will be "baz.com". So if "baz.com" is redirecting\n    all requests for to foo.com, while foo.com is inaccessible from the outside,\n    then redirect and url generation will work correctly\n    """'
newline|'\n'
DECL|member|getChild
name|'def'
name|'getChild'
op|'('
name|'self'
op|','
name|'path'
op|','
name|'request'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'path'
op|'=='
string|"'http'"
op|':'
newline|'\n'
indent|'            '
name|'request'
op|'.'
name|'isSecure'
op|'='
name|'lambda'
op|':'
number|'0'
newline|'\n'
dedent|''
name|'elif'
name|'path'
op|'=='
string|"'https'"
op|':'
newline|'\n'
indent|'            '
name|'request'
op|'.'
name|'isSecure'
op|'='
name|'lambda'
op|':'
number|'1'
newline|'\n'
dedent|''
name|'return'
name|'_HostResource'
op|'('
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
