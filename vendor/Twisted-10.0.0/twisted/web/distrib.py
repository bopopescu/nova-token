begin_unit
comment|'# -*- test-case-name: twisted.web.test.test_distrib -*-'
nl|'\n'
comment|'# Copyright (c) 2001-2010 Twisted Matrix Laboratories.'
nl|'\n'
comment|'# See LICENSE for details.'
nl|'\n'
nl|'\n'
string|'"""\nDistributed web servers.\n\nThis is going to have to be refactored so that argument parsing is done\nby each subprocess and not by the main web server (i.e. GET, POST etc.).\n"""'
newline|'\n'
nl|'\n'
comment|'# System Imports'
nl|'\n'
name|'import'
name|'types'
op|','
name|'os'
op|','
name|'copy'
op|','
name|'cStringIO'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'    '
name|'import'
name|'pwd'
newline|'\n'
dedent|''
name|'except'
name|'ImportError'
op|':'
newline|'\n'
DECL|variable|pwd
indent|'    '
name|'pwd'
op|'='
name|'None'
newline|'\n'
nl|'\n'
dedent|''
name|'from'
name|'xml'
op|'.'
name|'dom'
op|'.'
name|'minidom'
name|'import'
name|'Element'
op|','
name|'Text'
newline|'\n'
nl|'\n'
comment|'# Twisted Imports'
nl|'\n'
name|'from'
name|'twisted'
op|'.'
name|'spread'
name|'import'
name|'pb'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'spread'
op|'.'
name|'banana'
name|'import'
name|'SIZE_LIMIT'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'web'
name|'import'
name|'http'
op|','
name|'resource'
op|','
name|'server'
op|','
name|'html'
op|','
name|'static'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'web'
op|'.'
name|'http_headers'
name|'import'
name|'Headers'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'python'
name|'import'
name|'log'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'persisted'
name|'import'
name|'styles'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'internet'
name|'import'
name|'address'
op|','
name|'reactor'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|_ReferenceableProducerWrapper
name|'class'
name|'_ReferenceableProducerWrapper'
op|'('
name|'pb'
op|'.'
name|'Referenceable'
op|')'
op|':'
newline|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'producer'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'producer'
op|'='
name|'producer'
newline|'\n'
nl|'\n'
DECL|member|remote_resumeProducing
dedent|''
name|'def'
name|'remote_resumeProducing'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'producer'
op|'.'
name|'resumeProducing'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|remote_pauseProducing
dedent|''
name|'def'
name|'remote_pauseProducing'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'producer'
op|'.'
name|'pauseProducing'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|remote_stopProducing
dedent|''
name|'def'
name|'remote_stopProducing'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'producer'
op|'.'
name|'stopProducing'
op|'('
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|Request
dedent|''
dedent|''
name|'class'
name|'Request'
op|'('
name|'pb'
op|'.'
name|'RemoteCopy'
op|','
name|'server'
op|'.'
name|'Request'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    A request which was received by a L{ResourceSubscription} and sent via\n    PB to a distributed node.\n    """'
newline|'\n'
DECL|member|setCopyableState
name|'def'
name|'setCopyableState'
op|'('
name|'self'
op|','
name|'state'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Initialize this L{twisted.web.distrib.Request} based on the copied\n        state so that it closely resembles a L{twisted.web.server.Request}.\n        """'
newline|'\n'
name|'for'
name|'k'
name|'in'
string|"'host'"
op|','
string|"'client'"
op|':'
newline|'\n'
indent|'            '
name|'tup'
op|'='
name|'state'
op|'['
name|'k'
op|']'
newline|'\n'
name|'addrdesc'
op|'='
op|'{'
string|"'INET'"
op|':'
string|"'TCP'"
op|','
string|"'UNIX'"
op|':'
string|"'UNIX'"
op|'}'
op|'['
name|'tup'
op|'['
number|'0'
op|']'
op|']'
newline|'\n'
name|'addr'
op|'='
op|'{'
string|"'TCP'"
op|':'
name|'lambda'
op|':'
name|'address'
op|'.'
name|'IPv4Address'
op|'('
name|'addrdesc'
op|','
nl|'\n'
name|'tup'
op|'['
number|'1'
op|']'
op|','
name|'tup'
op|'['
number|'2'
op|']'
op|','
nl|'\n'
name|'_bwHack'
op|'='
string|"'INET'"
op|')'
op|','
nl|'\n'
string|"'UNIX'"
op|':'
name|'lambda'
op|':'
name|'address'
op|'.'
name|'UNIXAddress'
op|'('
name|'tup'
op|'['
number|'1'
op|']'
op|')'
op|'}'
op|'['
name|'addrdesc'
op|']'
op|'('
op|')'
newline|'\n'
name|'state'
op|'['
name|'k'
op|']'
op|'='
name|'addr'
newline|'\n'
dedent|''
name|'state'
op|'['
string|"'requestHeaders'"
op|']'
op|'='
name|'Headers'
op|'('
name|'dict'
op|'('
name|'state'
op|'['
string|"'requestHeaders'"
op|']'
op|')'
op|')'
newline|'\n'
name|'pb'
op|'.'
name|'RemoteCopy'
op|'.'
name|'setCopyableState'
op|'('
name|'self'
op|','
name|'state'
op|')'
newline|'\n'
comment|'# Emulate the local request interface --'
nl|'\n'
name|'self'
op|'.'
name|'content'
op|'='
name|'cStringIO'
op|'.'
name|'StringIO'
op|'('
name|'self'
op|'.'
name|'content_data'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'finish'
op|'='
name|'self'
op|'.'
name|'remote'
op|'.'
name|'remoteMethod'
op|'('
string|"'finish'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'setHeader'
op|'='
name|'self'
op|'.'
name|'remote'
op|'.'
name|'remoteMethod'
op|'('
string|"'setHeader'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'addCookie'
op|'='
name|'self'
op|'.'
name|'remote'
op|'.'
name|'remoteMethod'
op|'('
string|"'addCookie'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'setETag'
op|'='
name|'self'
op|'.'
name|'remote'
op|'.'
name|'remoteMethod'
op|'('
string|"'setETag'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'setResponseCode'
op|'='
name|'self'
op|'.'
name|'remote'
op|'.'
name|'remoteMethod'
op|'('
string|"'setResponseCode'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'setLastModified'
op|'='
name|'self'
op|'.'
name|'remote'
op|'.'
name|'remoteMethod'
op|'('
string|"'setLastModified'"
op|')'
newline|'\n'
nl|'\n'
comment|'# To avoid failing if a resource tries to write a very long string'
nl|'\n'
comment|'# all at once, this one will be handled slightly differently.'
nl|'\n'
name|'self'
op|'.'
name|'_write'
op|'='
name|'self'
op|'.'
name|'remote'
op|'.'
name|'remoteMethod'
op|'('
string|"'write'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|member|write
dedent|''
name|'def'
name|'write'
op|'('
name|'self'
op|','
name|'bytes'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Write the given bytes to the response body.\n\n        @param bytes: The bytes to write.  If this is longer than 640k, it\n            will be split up into smaller pieces.\n        """'
newline|'\n'
name|'start'
op|'='
number|'0'
newline|'\n'
name|'end'
op|'='
name|'SIZE_LIMIT'
newline|'\n'
name|'while'
name|'True'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_write'
op|'('
name|'bytes'
op|'['
name|'start'
op|':'
name|'end'
op|']'
op|')'
newline|'\n'
name|'start'
op|'+='
name|'SIZE_LIMIT'
newline|'\n'
name|'end'
op|'+='
name|'SIZE_LIMIT'
newline|'\n'
name|'if'
name|'start'
op|'>='
name|'len'
op|'('
name|'bytes'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'break'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|member|registerProducer
dedent|''
dedent|''
dedent|''
name|'def'
name|'registerProducer'
op|'('
name|'self'
op|','
name|'producer'
op|','
name|'streaming'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'remote'
op|'.'
name|'callRemote'
op|'('
string|'"registerProducer"'
op|','
nl|'\n'
name|'_ReferenceableProducerWrapper'
op|'('
name|'producer'
op|')'
op|','
nl|'\n'
name|'streaming'
op|')'
op|'.'
name|'addErrback'
op|'('
name|'self'
op|'.'
name|'fail'
op|')'
newline|'\n'
nl|'\n'
DECL|member|unregisterProducer
dedent|''
name|'def'
name|'unregisterProducer'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'remote'
op|'.'
name|'callRemote'
op|'('
string|'"unregisterProducer"'
op|')'
op|'.'
name|'addErrback'
op|'('
name|'self'
op|'.'
name|'fail'
op|')'
newline|'\n'
nl|'\n'
DECL|member|fail
dedent|''
name|'def'
name|'fail'
op|'('
name|'self'
op|','
name|'failure'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'log'
op|'.'
name|'err'
op|'('
name|'failure'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
name|'pb'
op|'.'
name|'setUnjellyableForClass'
op|'('
name|'server'
op|'.'
name|'Request'
op|','
name|'Request'
op|')'
newline|'\n'
nl|'\n'
DECL|class|Issue
name|'class'
name|'Issue'
op|':'
newline|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'request'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'request'
op|'='
name|'request'
newline|'\n'
nl|'\n'
DECL|member|finished
dedent|''
name|'def'
name|'finished'
op|'('
name|'self'
op|','
name|'result'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'result'
op|'!='
name|'server'
op|'.'
name|'NOT_DONE_YET'
op|':'
newline|'\n'
indent|'            '
name|'assert'
name|'isinstance'
op|'('
name|'result'
op|','
name|'types'
op|'.'
name|'StringType'
op|')'
op|','
string|'"return value not a string"'
newline|'\n'
name|'self'
op|'.'
name|'request'
op|'.'
name|'write'
op|'('
name|'result'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'request'
op|'.'
name|'finish'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|failed
dedent|''
dedent|''
name|'def'
name|'failed'
op|'('
name|'self'
op|','
name|'failure'
op|')'
op|':'
newline|'\n'
comment|'#XXX: Argh. FIXME.'
nl|'\n'
indent|'        '
name|'failure'
op|'='
name|'str'
op|'('
name|'failure'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'request'
op|'.'
name|'write'
op|'('
nl|'\n'
name|'resource'
op|'.'
name|'ErrorPage'
op|'('
name|'http'
op|'.'
name|'INTERNAL_SERVER_ERROR'
op|','
nl|'\n'
string|'"Server Connection Lost"'
op|','
nl|'\n'
string|'"Connection to distributed server lost:"'
op|'+'
nl|'\n'
name|'html'
op|'.'
name|'PRE'
op|'('
name|'failure'
op|')'
op|')'
op|'.'
nl|'\n'
name|'render'
op|'('
name|'self'
op|'.'
name|'request'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'request'
op|'.'
name|'finish'
op|'('
op|')'
newline|'\n'
name|'log'
op|'.'
name|'msg'
op|'('
name|'failure'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ResourceSubscription
dedent|''
dedent|''
name|'class'
name|'ResourceSubscription'
op|'('
name|'resource'
op|'.'
name|'Resource'
op|')'
op|':'
newline|'\n'
DECL|variable|isLeaf
indent|'    '
name|'isLeaf'
op|'='
number|'1'
newline|'\n'
DECL|variable|waiting
name|'waiting'
op|'='
number|'0'
newline|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'host'
op|','
name|'port'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'resource'
op|'.'
name|'Resource'
op|'.'
name|'__init__'
op|'('
name|'self'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'host'
op|'='
name|'host'
newline|'\n'
name|'self'
op|'.'
name|'port'
op|'='
name|'port'
newline|'\n'
name|'self'
op|'.'
name|'pending'
op|'='
op|'['
op|']'
newline|'\n'
name|'self'
op|'.'
name|'publisher'
op|'='
name|'None'
newline|'\n'
nl|'\n'
DECL|member|__getstate__
dedent|''
name|'def'
name|'__getstate__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Get persistent state for this ResourceSubscription.\n        """'
newline|'\n'
comment|'# When I unserialize,'
nl|'\n'
name|'state'
op|'='
name|'copy'
op|'.'
name|'copy'
op|'('
name|'self'
op|'.'
name|'__dict__'
op|')'
newline|'\n'
comment|"# Publisher won't be connected..."
nl|'\n'
name|'state'
op|'['
string|"'publisher'"
op|']'
op|'='
name|'None'
newline|'\n'
comment|"# I won't be making a connection"
nl|'\n'
name|'state'
op|'['
string|"'waiting'"
op|']'
op|'='
number|'0'
newline|'\n'
comment|'# There will be no pending requests.'
nl|'\n'
name|'state'
op|'['
string|"'pending'"
op|']'
op|'='
op|'['
op|']'
newline|'\n'
name|'return'
name|'state'
newline|'\n'
nl|'\n'
DECL|member|connected
dedent|''
name|'def'
name|'connected'
op|'('
name|'self'
op|','
name|'publisher'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""I\'ve connected to a publisher; I\'ll now send all my requests.\n        """'
newline|'\n'
name|'log'
op|'.'
name|'msg'
op|'('
string|"'connected to publisher'"
op|')'
newline|'\n'
name|'publisher'
op|'.'
name|'broker'
op|'.'
name|'notifyOnDisconnect'
op|'('
name|'self'
op|'.'
name|'booted'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'publisher'
op|'='
name|'publisher'
newline|'\n'
name|'self'
op|'.'
name|'waiting'
op|'='
number|'0'
newline|'\n'
name|'for'
name|'request'
name|'in'
name|'self'
op|'.'
name|'pending'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'render'
op|'('
name|'request'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'pending'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
DECL|member|notConnected
dedent|''
name|'def'
name|'notConnected'
op|'('
name|'self'
op|','
name|'msg'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""I can\'t connect to a publisher; I\'ll now reply to all pending\n        requests.\n        """'
newline|'\n'
name|'log'
op|'.'
name|'msg'
op|'('
string|'"could not connect to distributed web service: %s"'
op|'%'
name|'msg'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'waiting'
op|'='
number|'0'
newline|'\n'
name|'self'
op|'.'
name|'publisher'
op|'='
name|'None'
newline|'\n'
name|'for'
name|'request'
name|'in'
name|'self'
op|'.'
name|'pending'
op|':'
newline|'\n'
indent|'            '
name|'request'
op|'.'
name|'write'
op|'('
string|'"Unable to connect to distributed server."'
op|')'
newline|'\n'
name|'request'
op|'.'
name|'finish'
op|'('
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'pending'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
DECL|member|booted
dedent|''
name|'def'
name|'booted'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'notConnected'
op|'('
string|'"connection dropped"'
op|')'
newline|'\n'
nl|'\n'
DECL|member|render
dedent|''
name|'def'
name|'render'
op|'('
name|'self'
op|','
name|'request'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Render this request, from my server.\n\n        This will always be asynchronous, and therefore return NOT_DONE_YET.\n        It spins off a request to the pb client, and either adds it to the list\n        of pending issues or requests it immediately, depending on if the\n        client is already connected.\n        """'
newline|'\n'
name|'if'
name|'not'
name|'self'
op|'.'
name|'publisher'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'pending'
op|'.'
name|'append'
op|'('
name|'request'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'self'
op|'.'
name|'waiting'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'waiting'
op|'='
number|'1'
newline|'\n'
name|'bf'
op|'='
name|'pb'
op|'.'
name|'PBClientFactory'
op|'('
op|')'
newline|'\n'
name|'timeout'
op|'='
number|'10'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'host'
op|'=='
string|'"unix"'
op|':'
newline|'\n'
indent|'                    '
name|'reactor'
op|'.'
name|'connectUNIX'
op|'('
name|'self'
op|'.'
name|'port'
op|','
name|'bf'
op|','
name|'timeout'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'reactor'
op|'.'
name|'connectTCP'
op|'('
name|'self'
op|'.'
name|'host'
op|','
name|'self'
op|'.'
name|'port'
op|','
name|'bf'
op|','
name|'timeout'
op|')'
newline|'\n'
dedent|''
name|'d'
op|'='
name|'bf'
op|'.'
name|'getRootObject'
op|'('
op|')'
newline|'\n'
name|'d'
op|'.'
name|'addCallbacks'
op|'('
name|'self'
op|'.'
name|'connected'
op|','
name|'self'
op|'.'
name|'notConnected'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'i'
op|'='
name|'Issue'
op|'('
name|'request'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'publisher'
op|'.'
name|'callRemote'
op|'('
string|"'request'"
op|','
name|'request'
op|')'
op|'.'
name|'addCallbacks'
op|'('
name|'i'
op|'.'
name|'finished'
op|','
name|'i'
op|'.'
name|'failed'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'server'
op|'.'
name|'NOT_DONE_YET'
newline|'\n'
nl|'\n'
nl|'\n'
nl|'\n'
DECL|class|ResourcePublisher
dedent|''
dedent|''
name|'class'
name|'ResourcePublisher'
op|'('
name|'pb'
op|'.'
name|'Root'
op|','
name|'styles'
op|'.'
name|'Versioned'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    L{ResourcePublisher} exposes a remote API which can be used to respond\n    to request.\n\n    @ivar site: The site which will be used for resource lookup.\n    @type site: L{twisted.web.server.Site}\n    """'
newline|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'site'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'site'
op|'='
name|'site'
newline|'\n'
nl|'\n'
DECL|variable|persistenceVersion
dedent|''
name|'persistenceVersion'
op|'='
number|'2'
newline|'\n'
nl|'\n'
DECL|member|upgradeToVersion2
name|'def'
name|'upgradeToVersion2'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'application'
op|'.'
name|'authorizer'
op|'.'
name|'removeIdentity'
op|'('
string|'"web"'
op|')'
newline|'\n'
name|'del'
name|'self'
op|'.'
name|'application'
op|'.'
name|'services'
op|'['
name|'self'
op|'.'
name|'serviceName'
op|']'
newline|'\n'
name|'del'
name|'self'
op|'.'
name|'serviceName'
newline|'\n'
name|'del'
name|'self'
op|'.'
name|'application'
newline|'\n'
name|'del'
name|'self'
op|'.'
name|'perspectiveName'
newline|'\n'
nl|'\n'
DECL|member|getPerspectiveNamed
dedent|''
name|'def'
name|'getPerspectiveNamed'
op|'('
name|'self'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|member|remote_request
dedent|''
name|'def'
name|'remote_request'
op|'('
name|'self'
op|','
name|'request'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Look up the resource for the given request and render it.\n        """'
newline|'\n'
name|'res'
op|'='
name|'self'
op|'.'
name|'site'
op|'.'
name|'getResourceFor'
op|'('
name|'request'
op|')'
newline|'\n'
name|'log'
op|'.'
name|'msg'
op|'('
name|'request'
op|')'
newline|'\n'
name|'result'
op|'='
name|'res'
op|'.'
name|'render'
op|'('
name|'request'
op|')'
newline|'\n'
name|'if'
name|'result'
name|'is'
name|'not'
name|'server'
op|'.'
name|'NOT_DONE_YET'
op|':'
newline|'\n'
indent|'            '
name|'request'
op|'.'
name|'write'
op|'('
name|'result'
op|')'
newline|'\n'
name|'request'
op|'.'
name|'finish'
op|'('
op|')'
newline|'\n'
dedent|''
name|'return'
name|'server'
op|'.'
name|'NOT_DONE_YET'
newline|'\n'
nl|'\n'
nl|'\n'
nl|'\n'
DECL|class|UserDirectory
dedent|''
dedent|''
name|'class'
name|'UserDirectory'
op|'('
name|'resource'
op|'.'
name|'Resource'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    A resource which lists available user resources and serves them as\n    children.\n\n    @ivar _pwd: An object like L{pwd} which is used to enumerate users and\n        their home directories.\n    """'
newline|'\n'
nl|'\n'
DECL|variable|userDirName
name|'userDirName'
op|'='
string|"'public_html'"
newline|'\n'
DECL|variable|userSocketName
name|'userSocketName'
op|'='
string|"'.twistd-web-pb'"
newline|'\n'
nl|'\n'
name|'template'
op|'='
string|'"""\n<html>\n    <head>\n    <title>twisted.web.distrib.UserDirectory</title>\n    <style>\n\n    a\n    {\n        font-family: Lucida, Verdana, Helvetica, Arial, sans-serif;\n        color: #369;\n        text-decoration: none;\n    }\n\n    th\n    {\n        font-family: Lucida, Verdana, Helvetica, Arial, sans-serif;\n        font-weight: bold;\n        text-decoration: none;\n        text-align: left;\n    }\n\n    pre, code\n    {\n        font-family: "Courier New", Courier, monospace;\n    }\n\n    p, body, td, ol, ul, menu, blockquote, div\n    {\n        font-family: Lucida, Verdana, Helvetica, Arial, sans-serif;\n        color: #000;\n    }\n    </style>\n    </head>\n\n    <body>\n    <h1>twisted.web.distrib.UserDirectory</h1>\n\n    %(users)s\n</body>\n</html>\n"""'
newline|'\n'
nl|'\n'
DECL|function|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'userDatabase'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'resource'
op|'.'
name|'Resource'
op|'.'
name|'__init__'
op|'('
name|'self'
op|')'
newline|'\n'
name|'if'
name|'userDatabase'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'userDatabase'
op|'='
name|'pwd'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_pwd'
op|'='
name|'userDatabase'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|_users
dedent|''
name|'def'
name|'_users'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Return a list of two-tuples giving links to user resources and text to\n        associate with those links.\n        """'
newline|'\n'
name|'users'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'user'
name|'in'
name|'self'
op|'.'
name|'_pwd'
op|'.'
name|'getpwall'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'name'
op|','
name|'passwd'
op|','
name|'uid'
op|','
name|'gid'
op|','
name|'gecos'
op|','
name|'dir'
op|','
name|'shell'
op|'='
name|'user'
newline|'\n'
name|'realname'
op|'='
name|'gecos'
op|'.'
name|'split'
op|'('
string|"','"
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'if'
name|'not'
name|'realname'
op|':'
newline|'\n'
indent|'                '
name|'realname'
op|'='
name|'name'
newline|'\n'
dedent|''
name|'if'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'dir'
op|','
name|'self'
op|'.'
name|'userDirName'
op|')'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'users'
op|'.'
name|'append'
op|'('
op|'('
name|'name'
op|','
name|'realname'
op|'+'
string|"' (file)'"
op|')'
op|')'
newline|'\n'
dedent|''
name|'twistdsock'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'dir'
op|','
name|'self'
op|'.'
name|'userSocketName'
op|')'
newline|'\n'
name|'if'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'twistdsock'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'linkName'
op|'='
name|'name'
op|'+'
string|"'.twistd'"
newline|'\n'
name|'users'
op|'.'
name|'append'
op|'('
op|'('
name|'linkName'
op|','
name|'realname'
op|'+'
string|"' (twistd)'"
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'users'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|render_GET
dedent|''
name|'def'
name|'render_GET'
op|'('
name|'self'
op|','
name|'request'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Render as HTML a listing of all known users with links to their\n        personal resources.\n        """'
newline|'\n'
name|'listing'
op|'='
name|'Element'
op|'('
string|"'ul'"
op|')'
newline|'\n'
name|'for'
name|'link'
op|','
name|'text'
name|'in'
name|'self'
op|'.'
name|'_users'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'linkElement'
op|'='
name|'Element'
op|'('
string|"'a'"
op|')'
newline|'\n'
name|'linkElement'
op|'.'
name|'setAttribute'
op|'('
string|"'href'"
op|','
name|'link'
op|'+'
string|"'/'"
op|')'
newline|'\n'
name|'textNode'
op|'='
name|'Text'
op|'('
op|')'
newline|'\n'
name|'textNode'
op|'.'
name|'data'
op|'='
name|'text'
newline|'\n'
name|'linkElement'
op|'.'
name|'appendChild'
op|'('
name|'textNode'
op|')'
newline|'\n'
name|'item'
op|'='
name|'Element'
op|'('
string|"'li'"
op|')'
newline|'\n'
name|'item'
op|'.'
name|'appendChild'
op|'('
name|'linkElement'
op|')'
newline|'\n'
name|'listing'
op|'.'
name|'appendChild'
op|'('
name|'item'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'template'
op|'%'
op|'{'
string|"'users'"
op|':'
name|'listing'
op|'.'
name|'toxml'
op|'('
op|')'
op|'}'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|getChild
dedent|''
name|'def'
name|'getChild'
op|'('
name|'self'
op|','
name|'name'
op|','
name|'request'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'name'
op|'=='
string|"''"
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
newline|'\n'
nl|'\n'
dedent|''
name|'td'
op|'='
string|"'.twistd'"
newline|'\n'
nl|'\n'
name|'if'
name|'name'
op|'['
op|'-'
name|'len'
op|'('
name|'td'
op|')'
op|':'
op|']'
op|'=='
name|'td'
op|':'
newline|'\n'
indent|'            '
name|'username'
op|'='
name|'name'
op|'['
op|':'
op|'-'
name|'len'
op|'('
name|'td'
op|')'
op|']'
newline|'\n'
name|'sub'
op|'='
number|'1'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'username'
op|'='
name|'name'
newline|'\n'
name|'sub'
op|'='
number|'0'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'pw_name'
op|','
name|'pw_passwd'
op|','
name|'pw_uid'
op|','
name|'pw_gid'
op|','
name|'pw_gecos'
op|','
name|'pw_dir'
op|','
name|'pw_shell'
op|'='
name|'self'
op|'.'
name|'_pwd'
op|'.'
name|'getpwnam'
op|'('
name|'username'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'KeyError'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'resource'
op|'.'
name|'NoResource'
op|'('
op|')'
newline|'\n'
dedent|''
name|'if'
name|'sub'
op|':'
newline|'\n'
indent|'            '
name|'twistdsock'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'pw_dir'
op|','
name|'self'
op|'.'
name|'userSocketName'
op|')'
newline|'\n'
name|'rs'
op|'='
name|'ResourceSubscription'
op|'('
string|"'unix'"
op|','
name|'twistdsock'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'putChild'
op|'('
name|'name'
op|','
name|'rs'
op|')'
newline|'\n'
name|'return'
name|'rs'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'pw_dir'
op|','
name|'self'
op|'.'
name|'userDirName'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'resource'
op|'.'
name|'NoResource'
op|'('
op|')'
newline|'\n'
dedent|''
name|'return'
name|'static'
op|'.'
name|'File'
op|'('
name|'path'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
endmarker|''
end_unit
