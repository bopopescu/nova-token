begin_unit
comment|'# -*- test-case-name: twisted.test.test_internet -*-'
nl|'\n'
comment|'# Copyright (c) 2001-2007 Twisted Matrix Laboratories.'
nl|'\n'
comment|'# See LICENSE for details.'
nl|'\n'
nl|'\n'
nl|'\n'
string|'"""\nSelect reactor\n\nMaintainer: Itamar Shtull-Trauring\n"""'
newline|'\n'
nl|'\n'
name|'from'
name|'time'
name|'import'
name|'sleep'
newline|'\n'
name|'import'
name|'sys'
newline|'\n'
name|'import'
name|'select'
newline|'\n'
name|'from'
name|'errno'
name|'import'
name|'EINTR'
op|','
name|'EBADF'
newline|'\n'
nl|'\n'
name|'from'
name|'zope'
op|'.'
name|'interface'
name|'import'
name|'implements'
newline|'\n'
nl|'\n'
name|'from'
name|'twisted'
op|'.'
name|'internet'
op|'.'
name|'interfaces'
name|'import'
name|'IReactorFDSet'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'internet'
name|'import'
name|'error'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'internet'
name|'import'
name|'posixbase'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'python'
name|'import'
name|'log'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'python'
op|'.'
name|'runtime'
name|'import'
name|'platformType'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|win32select
name|'def'
name|'win32select'
op|'('
name|'r'
op|','
name|'w'
op|','
name|'e'
op|','
name|'timeout'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Win32 select wrapper."""'
newline|'\n'
name|'if'
name|'not'
op|'('
name|'r'
name|'or'
name|'w'
op|')'
op|':'
newline|'\n'
comment|'# windows select() exits immediately when no sockets'
nl|'\n'
indent|'        '
name|'if'
name|'timeout'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'timeout'
op|'='
number|'0.01'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'timeout'
op|'='
name|'min'
op|'('
name|'timeout'
op|','
number|'0.001'
op|')'
newline|'\n'
dedent|''
name|'sleep'
op|'('
name|'timeout'
op|')'
newline|'\n'
name|'return'
op|'['
op|']'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
newline|'\n'
comment|"# windows doesn't process 'signals' inside select(), so we set a max"
nl|'\n'
comment|'# time or ctrl-c will never be recognized'
nl|'\n'
dedent|''
name|'if'
name|'timeout'
name|'is'
name|'None'
name|'or'
name|'timeout'
op|'>'
number|'0.5'
op|':'
newline|'\n'
indent|'        '
name|'timeout'
op|'='
number|'0.5'
newline|'\n'
dedent|''
name|'r'
op|','
name|'w'
op|','
name|'e'
op|'='
name|'select'
op|'.'
name|'select'
op|'('
name|'r'
op|','
name|'w'
op|','
name|'w'
op|','
name|'timeout'
op|')'
newline|'\n'
name|'return'
name|'r'
op|','
name|'w'
op|'+'
name|'e'
op|','
op|'['
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'platformType'
op|'=='
string|'"win32"'
op|':'
newline|'\n'
DECL|variable|_select
indent|'    '
name|'_select'
op|'='
name|'win32select'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
DECL|variable|_select
indent|'    '
name|'_select'
op|'='
name|'select'
op|'.'
name|'select'
newline|'\n'
nl|'\n'
comment|'# Exceptions that doSelect might return frequently'
nl|'\n'
DECL|variable|_NO_FILENO
dedent|''
name|'_NO_FILENO'
op|'='
name|'error'
op|'.'
name|'ConnectionFdescWentAway'
op|'('
string|"'Handler has no fileno method'"
op|')'
newline|'\n'
DECL|variable|_NO_FILEDESC
name|'_NO_FILEDESC'
op|'='
name|'error'
op|'.'
name|'ConnectionFdescWentAway'
op|'('
string|"'Filedescriptor went away'"
op|')'
newline|'\n'
nl|'\n'
DECL|class|SelectReactor
name|'class'
name|'SelectReactor'
op|'('
name|'posixbase'
op|'.'
name|'PosixReactorBase'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    A select() based reactor - runs on all POSIX platforms and on Win32.\n\n    @ivar _reads: A dictionary mapping L{FileDescriptor} instances to arbitrary\n        values (this is essentially a set).  Keys in this dictionary will be\n        checked for read events.\n\n    @ivar _writes: A dictionary mapping L{FileDescriptor} instances to\n        arbitrary values (this is essentially a set).  Keys in this dictionary\n        will be checked for writability.\n    """'
newline|'\n'
name|'implements'
op|'('
name|'IReactorFDSet'
op|')'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Initialize file descriptor tracking dictionaries and the base class.\n        """'
newline|'\n'
name|'self'
op|'.'
name|'_reads'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'_writes'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'posixbase'
op|'.'
name|'PosixReactorBase'
op|'.'
name|'__init__'
op|'('
name|'self'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|member|_preenDescriptors
dedent|''
name|'def'
name|'_preenDescriptors'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'log'
op|'.'
name|'msg'
op|'('
string|'"Malformed file descriptor found.  Preening lists."'
op|')'
newline|'\n'
name|'readers'
op|'='
name|'self'
op|'.'
name|'_reads'
op|'.'
name|'keys'
op|'('
op|')'
newline|'\n'
name|'writers'
op|'='
name|'self'
op|'.'
name|'_writes'
op|'.'
name|'keys'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_reads'
op|'.'
name|'clear'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_writes'
op|'.'
name|'clear'
op|'('
op|')'
newline|'\n'
name|'for'
name|'selDict'
op|','
name|'selList'
name|'in'
op|'('
op|'('
name|'self'
op|'.'
name|'_reads'
op|','
name|'readers'
op|')'
op|','
nl|'\n'
op|'('
name|'self'
op|'.'
name|'_writes'
op|','
name|'writers'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'selectable'
name|'in'
name|'selList'
op|':'
newline|'\n'
indent|'                '
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'select'
op|'.'
name|'select'
op|'('
op|'['
name|'selectable'
op|']'
op|','
op|'['
name|'selectable'
op|']'
op|','
op|'['
name|'selectable'
op|']'
op|','
number|'0'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|','
name|'e'
op|':'
newline|'\n'
indent|'                    '
name|'log'
op|'.'
name|'msg'
op|'('
string|'"bad descriptor %s"'
op|'%'
name|'selectable'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_disconnectSelectable'
op|'('
name|'selectable'
op|','
name|'e'
op|','
name|'False'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'selDict'
op|'['
name|'selectable'
op|']'
op|'='
number|'1'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|member|doSelect
dedent|''
dedent|''
dedent|''
dedent|''
name|'def'
name|'doSelect'
op|'('
name|'self'
op|','
name|'timeout'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Run one iteration of the I/O monitor loop.\n\n        This will run all selectables who had input or output readiness\n        waiting for them.\n        """'
newline|'\n'
name|'while'
number|'1'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'r'
op|','
name|'w'
op|','
name|'ignored'
op|'='
name|'_select'
op|'('
name|'self'
op|'.'
name|'_reads'
op|'.'
name|'keys'
op|'('
op|')'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_writes'
op|'.'
name|'keys'
op|'('
op|')'
op|','
nl|'\n'
op|'['
op|']'
op|','
name|'timeout'
op|')'
newline|'\n'
name|'break'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|','
name|'ve'
op|':'
newline|'\n'
comment|'# Possibly a file descriptor has gone negative?'
nl|'\n'
indent|'                '
name|'log'
op|'.'
name|'err'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_preenDescriptors'
op|'('
op|')'
newline|'\n'
dedent|''
name|'except'
name|'TypeError'
op|','
name|'te'
op|':'
newline|'\n'
comment|'# Something *totally* invalid (object w/o fileno, non-integral'
nl|'\n'
comment|'# result) was passed'
nl|'\n'
indent|'                '
name|'log'
op|'.'
name|'err'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_preenDescriptors'
op|'('
op|')'
newline|'\n'
dedent|''
name|'except'
op|'('
name|'select'
op|'.'
name|'error'
op|','
name|'IOError'
op|')'
op|','
name|'se'
op|':'
newline|'\n'
comment|'# select(2) encountered an error'
nl|'\n'
indent|'                '
name|'if'
name|'se'
op|'.'
name|'args'
op|'['
number|'0'
op|']'
name|'in'
op|'('
number|'0'
op|','
number|'2'
op|')'
op|':'
newline|'\n'
comment|'# windows does this if it got an empty list'
nl|'\n'
indent|'                    '
name|'if'
op|'('
name|'not'
name|'self'
op|'.'
name|'_reads'
op|')'
name|'and'
op|'('
name|'not'
name|'self'
op|'.'
name|'_writes'
op|')'
op|':'
newline|'\n'
indent|'                        '
name|'return'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                        '
name|'raise'
newline|'\n'
dedent|''
dedent|''
name|'elif'
name|'se'
op|'.'
name|'args'
op|'['
number|'0'
op|']'
op|'=='
name|'EINTR'
op|':'
newline|'\n'
indent|'                    '
name|'return'
newline|'\n'
dedent|''
name|'elif'
name|'se'
op|'.'
name|'args'
op|'['
number|'0'
op|']'
op|'=='
name|'EBADF'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'_preenDescriptors'
op|'('
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
comment|"# OK, I really don't know what's going on.  Blow up."
nl|'\n'
indent|'                    '
name|'raise'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'_drdw'
op|'='
name|'self'
op|'.'
name|'_doReadOrWrite'
newline|'\n'
name|'_logrun'
op|'='
name|'log'
op|'.'
name|'callWithLogger'
newline|'\n'
name|'for'
name|'selectables'
op|','
name|'method'
op|','
name|'fdset'
name|'in'
op|'('
op|'('
name|'r'
op|','
string|'"doRead"'
op|','
name|'self'
op|'.'
name|'_reads'
op|')'
op|','
nl|'\n'
op|'('
name|'w'
op|','
string|'"doWrite"'
op|','
name|'self'
op|'.'
name|'_writes'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'selectable'
name|'in'
name|'selectables'
op|':'
newline|'\n'
comment|'# if this was disconnected in another thread, kill it.'
nl|'\n'
comment|'# ^^^^ --- what the !@#*?  serious!  -exarkun'
nl|'\n'
indent|'                '
name|'if'
name|'selectable'
name|'not'
name|'in'
name|'fdset'
op|':'
newline|'\n'
indent|'                    '
name|'continue'
newline|'\n'
comment|"# This for pausing input when we're not ready for more."
nl|'\n'
dedent|''
name|'_logrun'
op|'('
name|'selectable'
op|','
name|'_drdw'
op|','
name|'selectable'
op|','
name|'method'
op|','
name|'dict'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|doIteration
dedent|''
dedent|''
dedent|''
name|'doIteration'
op|'='
name|'doSelect'
newline|'\n'
nl|'\n'
DECL|member|_doReadOrWrite
name|'def'
name|'_doReadOrWrite'
op|'('
name|'self'
op|','
name|'selectable'
op|','
name|'method'
op|','
name|'dict'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'why'
op|'='
name|'getattr'
op|'('
name|'selectable'
op|','
name|'method'
op|')'
op|'('
op|')'
newline|'\n'
name|'handfn'
op|'='
name|'getattr'
op|'('
name|'selectable'
op|','
string|"'fileno'"
op|','
name|'None'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'handfn'
op|':'
newline|'\n'
indent|'                '
name|'why'
op|'='
name|'_NO_FILENO'
newline|'\n'
dedent|''
name|'elif'
name|'handfn'
op|'('
op|')'
op|'=='
op|'-'
number|'1'
op|':'
newline|'\n'
indent|'                '
name|'why'
op|'='
name|'_NO_FILEDESC'
newline|'\n'
dedent|''
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'            '
name|'why'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
op|'['
number|'1'
op|']'
newline|'\n'
name|'log'
op|'.'
name|'err'
op|'('
op|')'
newline|'\n'
dedent|''
name|'if'
name|'why'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_disconnectSelectable'
op|'('
name|'selectable'
op|','
name|'why'
op|','
name|'method'
op|'=='
string|'"doRead"'
op|')'
newline|'\n'
nl|'\n'
DECL|member|addReader
dedent|''
dedent|''
name|'def'
name|'addReader'
op|'('
name|'self'
op|','
name|'reader'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Add a FileDescriptor for notification of data available to read.\n        """'
newline|'\n'
name|'self'
op|'.'
name|'_reads'
op|'['
name|'reader'
op|']'
op|'='
number|'1'
newline|'\n'
nl|'\n'
DECL|member|addWriter
dedent|''
name|'def'
name|'addWriter'
op|'('
name|'self'
op|','
name|'writer'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Add a FileDescriptor for notification of data available to write.\n        """'
newline|'\n'
name|'self'
op|'.'
name|'_writes'
op|'['
name|'writer'
op|']'
op|'='
number|'1'
newline|'\n'
nl|'\n'
DECL|member|removeReader
dedent|''
name|'def'
name|'removeReader'
op|'('
name|'self'
op|','
name|'reader'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Remove a Selectable for notification of data available to read.\n        """'
newline|'\n'
name|'if'
name|'reader'
name|'in'
name|'self'
op|'.'
name|'_reads'
op|':'
newline|'\n'
indent|'            '
name|'del'
name|'self'
op|'.'
name|'_reads'
op|'['
name|'reader'
op|']'
newline|'\n'
nl|'\n'
DECL|member|removeWriter
dedent|''
dedent|''
name|'def'
name|'removeWriter'
op|'('
name|'self'
op|','
name|'writer'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Remove a Selectable for notification of data available to write.\n        """'
newline|'\n'
name|'if'
name|'writer'
name|'in'
name|'self'
op|'.'
name|'_writes'
op|':'
newline|'\n'
indent|'            '
name|'del'
name|'self'
op|'.'
name|'_writes'
op|'['
name|'writer'
op|']'
newline|'\n'
nl|'\n'
DECL|member|removeAll
dedent|''
dedent|''
name|'def'
name|'removeAll'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'_removeAll'
op|'('
name|'self'
op|'.'
name|'_reads'
op|','
name|'self'
op|'.'
name|'_writes'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|member|getReaders
dedent|''
name|'def'
name|'getReaders'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'_reads'
op|'.'
name|'keys'
op|'('
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|member|getWriters
dedent|''
name|'def'
name|'getWriters'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'_writes'
op|'.'
name|'keys'
op|'('
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
nl|'\n'
DECL|function|install
dedent|''
dedent|''
name|'def'
name|'install'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Configure the twisted mainloop to be run using the select() reactor.\n    """'
newline|'\n'
name|'reactor'
op|'='
name|'SelectReactor'
op|'('
op|')'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'internet'
op|'.'
name|'main'
name|'import'
name|'installReactor'
newline|'\n'
name|'installReactor'
op|'('
name|'reactor'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|__all__
dedent|''
name|'__all__'
op|'='
op|'['
string|"'install'"
op|']'
newline|'\n'
endmarker|''
end_unit
