begin_unit
begin_comment
comment|/* Copyright (c) 2008 Twisted Matrix Laboratories.  * See LICENSE for details.  */
end_comment
begin_include
include|#
directive|include
file|<winsock2.h>
end_include
begin_include
include|#
directive|include
file|<assert.h>
end_include
begin_include
include|#
directive|include
file|<stdio.h>
end_include
begin_include
include|#
directive|include
file|<stdlib.h>
end_include
begin_ifndef
ifndef|#
directive|ifndef
name|WSAID_CONNECTEX
end_ifndef
begin_define
DECL|macro|WSAID_CONNECTEX
define|#
directive|define
name|WSAID_CONNECTEX
value|{0x25a207b9,0xddf3,0x4660,{0x8e,0xe9,0x76,0xe5,0x8c,0x74,0x06,0x3e}}
end_define
begin_endif
endif|#
directive|endif
end_endif
begin_ifndef
ifndef|#
directive|ifndef
name|WSAID_GETACCEPTEXSOCKADDRS
end_ifndef
begin_define
DECL|macro|WSAID_GETACCEPTEXSOCKADDRS
define|#
directive|define
name|WSAID_GETACCEPTEXSOCKADDRS
value|{0xb5367df2,0xcbac,0x11cf,{0x95,0xca,0x00,0x80,0x5f,0x48,0xa1,0x92}}
end_define
begin_endif
endif|#
directive|endif
end_endif
begin_ifndef
ifndef|#
directive|ifndef
name|WSAID_ACCEPTEX
end_ifndef
begin_define
DECL|macro|WSAID_ACCEPTEX
define|#
directive|define
name|WSAID_ACCEPTEX
value|{0xb5367df1,0xcbac,0x11cf,{0x95,0xca,0x00,0x80,0x5f,0x48,0xa1,0x92}}
end_define
begin_endif
endif|#
directive|endif
end_endif
begin_comment
comment|/*#ifndef WSAID_TRANSMITFILE #define WSAID_TRANSMITFILE {0xb5367df0,0xcbac,0x11cf,{0x95,0xca,0x00,0x80,0x5f,0x48,0xa1,0x92}} #endif*/
end_comment
begin_decl_stmt
DECL|variable|lpAcceptEx
DECL|variable|lpGetAcceptExSockaddrs
DECL|variable|lpConnectEx
DECL|variable|lpTransmitFile
name|void
modifier|*
name|lpAcceptEx
decl_stmt|,
modifier|*
name|lpGetAcceptExSockaddrs
decl_stmt|,
modifier|*
name|lpConnectEx
decl_stmt|,
modifier|*
name|lpTransmitFile
decl_stmt|;
end_decl_stmt
begin_function
DECL|function|initPointer
name|int
name|initPointer
parameter_list|(
name|SOCKET
name|s
parameter_list|,
name|void
modifier|*
modifier|*
name|fun
parameter_list|,
name|GUID
name|guid
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|DWORD
name|bytes
decl_stmt|;
operator|*
name|fun
operator|=
name|NULL
expr_stmt|;
name|res
operator|=
name|WSAIoctl
argument_list|(
name|s
argument_list|,
name|SIO_GET_EXTENSION_FUNCTION_POINTER
argument_list|,
operator|&
name|guid
argument_list|,
sizeof|sizeof
argument_list|(
name|guid
argument_list|)
argument_list|,
name|fun
argument_list|,
sizeof|sizeof
argument_list|(
name|fun
argument_list|)
argument_list|,
operator|&
name|bytes
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|!
name|res
return|;
block|}
end_function
begin_function
DECL|function|initWinsockPointers
name|int
name|initWinsockPointers
parameter_list|()
block|{
name|SOCKET
name|s
init|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
decl_stmt|;
comment|/* I hate C */
name|GUID
name|guid1
init|=
name|WSAID_ACCEPTEX
decl_stmt|;
name|GUID
name|guid2
init|=
name|WSAID_GETACCEPTEXSOCKADDRS
decl_stmt|;
name|GUID
name|guid3
init|=
name|WSAID_CONNECTEX
decl_stmt|;
comment|/*GUID guid4 = WSAID_TRANSMITFILE;*/
if|if
condition|(
operator|!
name|s
condition|)
block|{
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|initPointer
argument_list|(
name|s
argument_list|,
operator|&
name|lpAcceptEx
argument_list|,
name|guid1
argument_list|)
condition|)
block|{
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|initPointer
argument_list|(
name|s
argument_list|,
operator|&
name|lpGetAcceptExSockaddrs
argument_list|,
name|guid2
argument_list|)
condition|)
block|{
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|initPointer
argument_list|(
name|s
argument_list|,
operator|&
name|lpConnectEx
argument_list|,
name|guid3
argument_list|)
condition|)
block|{
return|return
literal|0
return|;
block|}
empty_stmt|;
comment|/*initPointer(s,&lpTransmitFile, guid4);*/
return|return
literal|1
return|;
block|}
end_function
end_unit
