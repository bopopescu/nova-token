begin_unit
comment|'# Copyright (c) 2001-2006 Twisted Matrix Laboratories.'
nl|'\n'
comment|'# See LICENSE for details.'
nl|'\n'
nl|'\n'
name|'from'
name|'twisted'
op|'.'
name|'internet'
name|'import'
name|'task'
op|','
name|'defer'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'names'
name|'import'
name|'dns'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'names'
name|'import'
name|'common'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'names'
name|'import'
name|'client'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'names'
name|'import'
name|'resolve'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'python'
name|'import'
name|'log'
op|','
name|'failure'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'application'
name|'import'
name|'service'
newline|'\n'
nl|'\n'
DECL|class|SecondaryAuthorityService
name|'class'
name|'SecondaryAuthorityService'
op|'('
name|'service'
op|'.'
name|'Service'
op|')'
op|':'
newline|'\n'
DECL|variable|calls
indent|'    '
name|'calls'
op|'='
name|'None'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'primary'
op|','
name|'domains'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        @param primary: The IP address of the server from which to perform\n        zone transfers.\n\n        @param domains: A sequence of domain names for which to perform\n        zone transfers.\n        """'
newline|'\n'
name|'self'
op|'.'
name|'primary'
op|'='
name|'primary'
newline|'\n'
name|'self'
op|'.'
name|'domains'
op|'='
op|'['
name|'SecondaryAuthority'
op|'('
name|'primary'
op|','
name|'d'
op|')'
name|'for'
name|'d'
name|'in'
name|'domains'
op|']'
newline|'\n'
nl|'\n'
DECL|member|getAuthority
dedent|''
name|'def'
name|'getAuthority'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'resolve'
op|'.'
name|'ResolverChain'
op|'('
name|'self'
op|'.'
name|'domains'
op|')'
newline|'\n'
nl|'\n'
DECL|member|startService
dedent|''
name|'def'
name|'startService'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'service'
op|'.'
name|'Service'
op|'.'
name|'startService'
op|'('
name|'self'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'calls'
op|'='
op|'['
name|'task'
op|'.'
name|'LoopingCall'
op|'('
name|'d'
op|'.'
name|'transfer'
op|')'
name|'for'
name|'d'
name|'in'
name|'self'
op|'.'
name|'domains'
op|']'
newline|'\n'
name|'i'
op|'='
number|'0'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'internet'
name|'import'
name|'reactor'
newline|'\n'
name|'for'
name|'c'
name|'in'
name|'self'
op|'.'
name|'calls'
op|':'
newline|'\n'
comment|'# XXX Add errbacks, respect proper timeouts'
nl|'\n'
indent|'            '
name|'reactor'
op|'.'
name|'callLater'
op|'('
name|'i'
op|','
name|'c'
op|'.'
name|'start'
op|','
number|'60'
op|'*'
number|'60'
op|')'
newline|'\n'
name|'i'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
DECL|member|stopService
dedent|''
dedent|''
name|'def'
name|'stopService'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'service'
op|'.'
name|'Service'
op|'.'
name|'stopService'
op|'('
name|'self'
op|')'
newline|'\n'
name|'for'
name|'c'
name|'in'
name|'self'
op|'.'
name|'calls'
op|':'
newline|'\n'
indent|'            '
name|'c'
op|'.'
name|'stop'
op|'('
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
name|'from'
name|'twisted'
op|'.'
name|'names'
op|'.'
name|'authority'
name|'import'
name|'FileAuthority'
newline|'\n'
nl|'\n'
DECL|class|SecondaryAuthority
name|'class'
name|'SecondaryAuthority'
op|'('
name|'common'
op|'.'
name|'ResolverBase'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""An Authority that keeps itself updated by performing zone transfers"""'
newline|'\n'
nl|'\n'
DECL|variable|transferring
name|'transferring'
op|'='
name|'False'
newline|'\n'
nl|'\n'
name|'soa'
op|'='
name|'records'
op|'='
name|'None'
newline|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'primaryIP'
op|','
name|'domain'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'common'
op|'.'
name|'ResolverBase'
op|'.'
name|'__init__'
op|'('
name|'self'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'primary'
op|'='
name|'primaryIP'
newline|'\n'
name|'self'
op|'.'
name|'domain'
op|'='
name|'domain'
newline|'\n'
nl|'\n'
DECL|member|transfer
dedent|''
name|'def'
name|'transfer'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'transferring'
op|':'
newline|'\n'
indent|'            '
name|'return'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'transfering'
op|'='
name|'True'
newline|'\n'
name|'return'
name|'client'
op|'.'
name|'Resolver'
op|'('
name|'servers'
op|'='
op|'['
op|'('
name|'self'
op|'.'
name|'primary'
op|','
name|'dns'
op|'.'
name|'PORT'
op|')'
op|']'
nl|'\n'
op|')'
op|'.'
name|'lookupZone'
op|'('
name|'self'
op|'.'
name|'domain'
nl|'\n'
op|')'
op|'.'
name|'addCallback'
op|'('
name|'self'
op|'.'
name|'_cbZone'
nl|'\n'
op|')'
op|'.'
name|'addErrback'
op|'('
name|'self'
op|'.'
name|'_ebZone'
nl|'\n'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|member|_lookup
dedent|''
name|'def'
name|'_lookup'
op|'('
name|'self'
op|','
name|'name'
op|','
name|'cls'
op|','
name|'type'
op|','
name|'timeout'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'self'
op|'.'
name|'soa'
name|'or'
name|'not'
name|'self'
op|'.'
name|'records'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'defer'
op|'.'
name|'fail'
op|'('
name|'failure'
op|'.'
name|'Failure'
op|'('
name|'dns'
op|'.'
name|'DomainError'
op|'('
name|'name'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
name|'return'
name|'FileAuthority'
op|'.'
name|'__dict__'
op|'['
string|"'_lookup'"
op|']'
op|'('
name|'self'
op|','
name|'name'
op|','
name|'cls'
op|','
name|'type'
op|','
name|'timeout'
op|')'
newline|'\n'
nl|'\n'
comment|"#shouldn't we just subclass? :P"
nl|'\n'
nl|'\n'
DECL|variable|lookupZone
dedent|''
name|'lookupZone'
op|'='
name|'FileAuthority'
op|'.'
name|'__dict__'
op|'['
string|"'lookupZone'"
op|']'
newline|'\n'
nl|'\n'
DECL|member|_cbZone
name|'def'
name|'_cbZone'
op|'('
name|'self'
op|','
name|'zone'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ans'
op|','
name|'_'
op|','
name|'_'
op|'='
name|'zone'
newline|'\n'
name|'self'
op|'.'
name|'records'
op|'='
name|'r'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'rec'
name|'in'
name|'ans'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'self'
op|'.'
name|'soa'
name|'and'
name|'rec'
op|'.'
name|'type'
op|'=='
name|'dns'
op|'.'
name|'SOA'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'soa'
op|'='
op|'('
name|'str'
op|'('
name|'rec'
op|'.'
name|'name'
op|')'
op|'.'
name|'lower'
op|'('
op|')'
op|','
name|'rec'
op|'.'
name|'payload'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'r'
op|'.'
name|'setdefault'
op|'('
name|'str'
op|'('
name|'rec'
op|'.'
name|'name'
op|')'
op|'.'
name|'lower'
op|'('
op|')'
op|','
op|'['
op|']'
op|')'
op|'.'
name|'append'
op|'('
name|'rec'
op|'.'
name|'payload'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_ebZone
dedent|''
dedent|''
dedent|''
name|'def'
name|'_ebZone'
op|'('
name|'self'
op|','
name|'failure'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'log'
op|'.'
name|'msg'
op|'('
string|'"Updating %s from %s failed during zone transfer"'
op|'%'
op|'('
name|'self'
op|'.'
name|'domain'
op|','
name|'self'
op|'.'
name|'primary'
op|')'
op|')'
newline|'\n'
name|'log'
op|'.'
name|'err'
op|'('
name|'failure'
op|')'
newline|'\n'
nl|'\n'
DECL|member|update
dedent|''
name|'def'
name|'update'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'transfer'
op|'('
op|')'
op|'.'
name|'addCallbacks'
op|'('
name|'self'
op|'.'
name|'_cbTransferred'
op|','
name|'self'
op|'.'
name|'_ebTransferred'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_cbTransferred
dedent|''
name|'def'
name|'_cbTransferred'
op|'('
name|'self'
op|','
name|'result'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'transferring'
op|'='
name|'False'
newline|'\n'
nl|'\n'
DECL|member|_ebTransferred
dedent|''
name|'def'
name|'_ebTransferred'
op|'('
name|'self'
op|','
name|'failure'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'transferred'
op|'='
name|'False'
newline|'\n'
name|'log'
op|'.'
name|'msg'
op|'('
string|'"Transferring %s from %s failed after zone transfer"'
op|'%'
op|'('
name|'self'
op|'.'
name|'domain'
op|','
name|'self'
op|'.'
name|'primary'
op|')'
op|')'
newline|'\n'
name|'log'
op|'.'
name|'err'
op|'('
name|'failure'
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
