begin_unit
comment|'# -*- test-case-name: twisted.mail.test.test_mail -*-'
nl|'\n'
comment|'# Copyright (c) 2001-2004 Twisted Matrix Laboratories.'
nl|'\n'
comment|'# See LICENSE for details.'
nl|'\n'
nl|'\n'
nl|'\n'
string|'"""Support for relaying mail for twisted.mail"""'
newline|'\n'
nl|'\n'
name|'from'
name|'twisted'
op|'.'
name|'mail'
name|'import'
name|'smtp'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'python'
name|'import'
name|'log'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'internet'
op|'.'
name|'address'
name|'import'
name|'UNIXAddress'
newline|'\n'
nl|'\n'
name|'import'
name|'os'
newline|'\n'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'    '
name|'import'
name|'cPickle'
name|'as'
name|'pickle'
newline|'\n'
dedent|''
name|'except'
name|'ImportError'
op|':'
newline|'\n'
indent|'    '
name|'import'
name|'pickle'
newline|'\n'
nl|'\n'
DECL|class|DomainQueuer
dedent|''
name|'class'
name|'DomainQueuer'
op|':'
newline|'\n'
indent|'    '
string|'"""An SMTP domain which add messages to a queue intended for relaying."""'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'service'
op|','
name|'authenticated'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'service'
op|'='
name|'service'
newline|'\n'
name|'self'
op|'.'
name|'authed'
op|'='
name|'authenticated'
newline|'\n'
nl|'\n'
DECL|member|exists
dedent|''
name|'def'
name|'exists'
op|'('
name|'self'
op|','
name|'user'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Check whether we will relay\n\n        Call overridable willRelay method\n        """'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'willRelay'
op|'('
name|'user'
op|'.'
name|'dest'
op|','
name|'user'
op|'.'
name|'protocol'
op|')'
op|':'
newline|'\n'
comment|'# The most cursor form of verification of the addresses'
nl|'\n'
indent|'            '
name|'orig'
op|'='
name|'filter'
op|'('
name|'None'
op|','
name|'str'
op|'('
name|'user'
op|'.'
name|'orig'
op|')'
op|'.'
name|'split'
op|'('
string|"'@'"
op|','
number|'1'
op|')'
op|')'
newline|'\n'
name|'dest'
op|'='
name|'filter'
op|'('
name|'None'
op|','
name|'str'
op|'('
name|'user'
op|'.'
name|'dest'
op|')'
op|'.'
name|'split'
op|'('
string|"'@'"
op|','
number|'1'
op|')'
op|')'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'orig'
op|')'
op|'=='
number|'2'
name|'and'
name|'len'
op|'('
name|'dest'
op|')'
op|'=='
number|'2'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'lambda'
op|':'
name|'self'
op|'.'
name|'startMessage'
op|'('
name|'user'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'raise'
name|'smtp'
op|'.'
name|'SMTPBadRcpt'
op|'('
name|'user'
op|')'
newline|'\n'
nl|'\n'
DECL|member|willRelay
dedent|''
name|'def'
name|'willRelay'
op|'('
name|'self'
op|','
name|'address'
op|','
name|'protocol'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Check whether we agree to relay\n\n        The default is to relay for all connections over UNIX\n        sockets and all connections from localhost.\n        """'
newline|'\n'
name|'peer'
op|'='
name|'protocol'
op|'.'
name|'transport'
op|'.'
name|'getPeer'
op|'('
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'authed'
name|'or'
name|'isinstance'
op|'('
name|'peer'
op|','
name|'UNIXAddress'
op|')'
name|'or'
name|'peer'
op|'.'
name|'host'
op|'=='
string|"'127.0.0.1'"
newline|'\n'
nl|'\n'
DECL|member|startMessage
dedent|''
name|'def'
name|'startMessage'
op|'('
name|'self'
op|','
name|'user'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Add envelope to queue and returns ISMTPMessage."""'
newline|'\n'
name|'queue'
op|'='
name|'self'
op|'.'
name|'service'
op|'.'
name|'queue'
newline|'\n'
name|'envelopeFile'
op|','
name|'smtpMessage'
op|'='
name|'queue'
op|'.'
name|'createNewMessage'
op|'('
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'log'
op|'.'
name|'msg'
op|'('
string|"'Queueing mail %r -> %r'"
op|'%'
op|'('
name|'str'
op|'('
name|'user'
op|'.'
name|'orig'
op|')'
op|','
name|'str'
op|'('
name|'user'
op|'.'
name|'dest'
op|')'
op|')'
op|')'
newline|'\n'
name|'pickle'
op|'.'
name|'dump'
op|'('
op|'['
name|'str'
op|'('
name|'user'
op|'.'
name|'orig'
op|')'
op|','
name|'str'
op|'('
name|'user'
op|'.'
name|'dest'
op|')'
op|']'
op|','
name|'envelopeFile'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'envelopeFile'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
dedent|''
name|'return'
name|'smtpMessage'
newline|'\n'
nl|'\n'
DECL|class|RelayerMixin
dedent|''
dedent|''
name|'class'
name|'RelayerMixin'
op|':'
newline|'\n'
nl|'\n'
comment|'# XXX - This is -totally- bogus'
nl|'\n'
comment|'# It opens about a -hundred- -billion- files'
nl|'\n'
comment|'# and -leaves- them open!'
nl|'\n'
nl|'\n'
DECL|member|loadMessages
indent|'    '
name|'def'
name|'loadMessages'
op|'('
name|'self'
op|','
name|'messagePaths'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'messages'
op|'='
op|'['
op|']'
newline|'\n'
name|'self'
op|'.'
name|'names'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'message'
name|'in'
name|'messagePaths'
op|':'
newline|'\n'
indent|'            '
name|'fp'
op|'='
name|'open'
op|'('
name|'message'
op|'+'
string|"'-H'"
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'messageContents'
op|'='
name|'pickle'
op|'.'
name|'load'
op|'('
name|'fp'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'                '
name|'fp'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
dedent|''
name|'fp'
op|'='
name|'open'
op|'('
name|'message'
op|'+'
string|"'-D'"
op|')'
newline|'\n'
name|'messageContents'
op|'.'
name|'append'
op|'('
name|'fp'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'messages'
op|'.'
name|'append'
op|'('
name|'messageContents'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'names'
op|'.'
name|'append'
op|'('
name|'message'
op|')'
newline|'\n'
nl|'\n'
DECL|member|getMailFrom
dedent|''
dedent|''
name|'def'
name|'getMailFrom'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'self'
op|'.'
name|'messages'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'messages'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
DECL|member|getMailTo
dedent|''
name|'def'
name|'getMailTo'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'self'
op|'.'
name|'messages'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'return'
op|'['
name|'self'
op|'.'
name|'messages'
op|'['
number|'0'
op|']'
op|'['
number|'1'
op|']'
op|']'
newline|'\n'
nl|'\n'
DECL|member|getMailData
dedent|''
name|'def'
name|'getMailData'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'self'
op|'.'
name|'messages'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'messages'
op|'['
number|'0'
op|']'
op|'['
number|'2'
op|']'
newline|'\n'
nl|'\n'
DECL|member|sentMail
dedent|''
name|'def'
name|'sentMail'
op|'('
name|'self'
op|','
name|'code'
op|','
name|'resp'
op|','
name|'numOk'
op|','
name|'addresses'
op|','
name|'log'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Since we only use one recipient per envelope, this\n        will be called with 0 or 1 addresses. We probably want\n        to do something with the error message if we failed.\n        """'
newline|'\n'
name|'if'
name|'code'
name|'in'
name|'smtp'
op|'.'
name|'SUCCESS'
op|':'
newline|'\n'
comment|'# At least one, i.e. all, recipients successfully delivered'
nl|'\n'
indent|'            '
name|'os'
op|'.'
name|'remove'
op|'('
name|'self'
op|'.'
name|'names'
op|'['
number|'0'
op|']'
op|'+'
string|"'-D'"
op|')'
newline|'\n'
name|'os'
op|'.'
name|'remove'
op|'('
name|'self'
op|'.'
name|'names'
op|'['
number|'0'
op|']'
op|'+'
string|"'-H'"
op|')'
newline|'\n'
dedent|''
name|'del'
name|'self'
op|'.'
name|'messages'
op|'['
number|'0'
op|']'
newline|'\n'
name|'del'
name|'self'
op|'.'
name|'names'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
DECL|class|SMTPRelayer
dedent|''
dedent|''
name|'class'
name|'SMTPRelayer'
op|'('
name|'RelayerMixin'
op|','
name|'smtp'
op|'.'
name|'SMTPClient'
op|')'
op|':'
newline|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'messagePaths'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kw'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'smtp'
op|'.'
name|'SMTPClient'
op|'.'
name|'__init__'
op|'('
name|'self'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kw'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'loadMessages'
op|'('
name|'messagePaths'
op|')'
newline|'\n'
nl|'\n'
DECL|class|ESMTPRelayer
dedent|''
dedent|''
name|'class'
name|'ESMTPRelayer'
op|'('
name|'RelayerMixin'
op|','
name|'smtp'
op|'.'
name|'ESMTPClient'
op|')'
op|':'
newline|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'messagePaths'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kw'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'smtp'
op|'.'
name|'ESMTPClient'
op|'.'
name|'__init__'
op|'('
name|'self'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kw'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'loadMessages'
op|'('
name|'messagePaths'
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
