begin_unit
comment|'# -*- test-case-name: twisted.mail.test.test_bounce -*-'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Copyright (c) 2001-2004 Twisted Matrix Laboratories.'
nl|'\n'
comment|'# See LICENSE for details.'
nl|'\n'
nl|'\n'
nl|'\n'
name|'import'
name|'StringIO'
newline|'\n'
name|'import'
name|'rfc822'
newline|'\n'
name|'import'
name|'string'
newline|'\n'
name|'import'
name|'time'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
nl|'\n'
nl|'\n'
name|'from'
name|'twisted'
op|'.'
name|'mail'
name|'import'
name|'smtp'
newline|'\n'
nl|'\n'
name|'BOUNCE_FORMAT'
op|'='
string|'"""\\\nFrom: postmaster@%(failedDomain)s\nTo: %(failedFrom)s\nSubject: Returned Mail: see transcript for details\nMessage-ID: %(messageID)s\nContent-Type: multipart/report; report-type=delivery-status;\n    boundary="%(boundary)s"\n\n--%(boundary)s\n\n%(transcript)s\n\n--%(boundary)s\nContent-Type: message/delivery-status\nArrival-Date: %(ctime)s\nFinal-Recipient: RFC822; %(failedTo)s\n"""'
newline|'\n'
nl|'\n'
DECL|function|generateBounce
name|'def'
name|'generateBounce'
op|'('
name|'message'
op|','
name|'failedFrom'
op|','
name|'failedTo'
op|','
name|'transcript'
op|'='
string|"''"
op|')'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'not'
name|'transcript'
op|':'
newline|'\n'
indent|'        '
name|'transcript'
op|'='
string|"'''\\\nI'm sorry, the following address has permanent errors: %(failedTo)s.\nI've given up, and I will not retry the message again.\n'''"
op|'%'
name|'vars'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'boundary'
op|'='
string|'"%s_%s_%s"'
op|'%'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|','
name|'os'
op|'.'
name|'getpid'
op|'('
op|')'
op|','
string|"'XXXXX'"
op|')'
newline|'\n'
name|'failedAddress'
op|'='
name|'rfc822'
op|'.'
name|'AddressList'
op|'('
name|'failedTo'
op|')'
op|'['
number|'0'
op|']'
op|'['
number|'1'
op|']'
newline|'\n'
name|'failedDomain'
op|'='
name|'string'
op|'.'
name|'split'
op|'('
name|'failedAddress'
op|','
string|"'@'"
op|','
number|'1'
op|')'
op|'['
number|'1'
op|']'
newline|'\n'
name|'messageID'
op|'='
name|'smtp'
op|'.'
name|'messageid'
op|'('
name|'uniq'
op|'='
string|"'bounce'"
op|')'
newline|'\n'
name|'ctime'
op|'='
name|'time'
op|'.'
name|'ctime'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'fp'
op|'='
name|'StringIO'
op|'.'
name|'StringIO'
op|'('
op|')'
newline|'\n'
name|'fp'
op|'.'
name|'write'
op|'('
name|'BOUNCE_FORMAT'
op|'%'
name|'vars'
op|'('
op|')'
op|')'
newline|'\n'
name|'orig'
op|'='
name|'message'
op|'.'
name|'tell'
op|'('
op|')'
newline|'\n'
name|'message'
op|'.'
name|'seek'
op|'('
number|'2'
op|','
number|'0'
op|')'
newline|'\n'
name|'sz'
op|'='
name|'message'
op|'.'
name|'tell'
op|'('
op|')'
newline|'\n'
name|'message'
op|'.'
name|'seek'
op|'('
number|'0'
op|','
name|'orig'
op|')'
newline|'\n'
name|'if'
name|'sz'
op|'>'
number|'10000'
op|':'
newline|'\n'
indent|'        '
name|'while'
number|'1'
op|':'
newline|'\n'
indent|'            '
name|'line'
op|'='
name|'message'
op|'.'
name|'readline'
op|'('
op|')'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'line'
op|')'
op|'<='
number|'1'
op|':'
newline|'\n'
indent|'                '
name|'break'
newline|'\n'
dedent|''
name|'fp'
op|'.'
name|'write'
op|'('
name|'line'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'fp'
op|'.'
name|'write'
op|'('
name|'message'
op|'.'
name|'read'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
name|'return'
string|"''"
op|','
name|'failedFrom'
op|','
name|'fp'
op|'.'
name|'getvalue'
op|'('
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit
