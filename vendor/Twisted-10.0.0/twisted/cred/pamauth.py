begin_unit
comment|'# Copyright (c) 2001-2008 Twisted Matrix Laboratories.'
nl|'\n'
comment|'# See LICENSE for details.'
nl|'\n'
nl|'\n'
string|'"""\nSupport for asynchronously authenticating using PAM.\n"""'
newline|'\n'
nl|'\n'
nl|'\n'
name|'import'
name|'PAM'
newline|'\n'
nl|'\n'
name|'import'
name|'getpass'
op|','
name|'threading'
op|','
name|'os'
newline|'\n'
nl|'\n'
name|'from'
name|'twisted'
op|'.'
name|'internet'
name|'import'
name|'threads'
op|','
name|'defer'
newline|'\n'
nl|'\n'
DECL|function|pamAuthenticateThread
name|'def'
name|'pamAuthenticateThread'
op|'('
name|'service'
op|','
name|'user'
op|','
name|'conv'
op|')'
op|':'
newline|'\n'
DECL|function|_conv
indent|'    '
name|'def'
name|'_conv'
op|'('
name|'items'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'from'
name|'twisted'
op|'.'
name|'internet'
name|'import'
name|'reactor'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'d'
op|'='
name|'conv'
op|'('
name|'items'
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'            '
name|'import'
name|'traceback'
newline|'\n'
name|'traceback'
op|'.'
name|'print_exc'
op|'('
op|')'
newline|'\n'
name|'return'
newline|'\n'
dedent|''
name|'ev'
op|'='
name|'threading'
op|'.'
name|'Event'
op|'('
op|')'
newline|'\n'
DECL|function|cb
name|'def'
name|'cb'
op|'('
name|'r'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ev'
op|'.'
name|'r'
op|'='
op|'('
number|'1'
op|','
name|'r'
op|')'
newline|'\n'
name|'ev'
op|'.'
name|'set'
op|'('
op|')'
newline|'\n'
DECL|function|eb
dedent|''
name|'def'
name|'eb'
op|'('
name|'e'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ev'
op|'.'
name|'r'
op|'='
op|'('
number|'0'
op|','
name|'e'
op|')'
newline|'\n'
name|'ev'
op|'.'
name|'set'
op|'('
op|')'
newline|'\n'
dedent|''
name|'reactor'
op|'.'
name|'callFromThread'
op|'('
name|'d'
op|'.'
name|'addCallbacks'
op|','
name|'cb'
op|','
name|'eb'
op|')'
newline|'\n'
name|'ev'
op|'.'
name|'wait'
op|'('
op|')'
newline|'\n'
name|'done'
op|'='
name|'ev'
op|'.'
name|'r'
newline|'\n'
name|'if'
name|'done'
op|'['
number|'0'
op|']'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'done'
op|'['
number|'1'
op|']'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'done'
op|'['
number|'1'
op|']'
op|'.'
name|'type'
op|','
name|'done'
op|'['
number|'1'
op|']'
op|'.'
name|'value'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'return'
name|'callIntoPAM'
op|'('
name|'service'
op|','
name|'user'
op|','
name|'_conv'
op|')'
newline|'\n'
nl|'\n'
DECL|function|callIntoPAM
dedent|''
name|'def'
name|'callIntoPAM'
op|'('
name|'service'
op|','
name|'user'
op|','
name|'conv'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""A testing hook.\n    """'
newline|'\n'
name|'pam'
op|'='
name|'PAM'
op|'.'
name|'pam'
op|'('
op|')'
newline|'\n'
name|'pam'
op|'.'
name|'start'
op|'('
name|'service'
op|')'
newline|'\n'
name|'pam'
op|'.'
name|'set_item'
op|'('
name|'PAM'
op|'.'
name|'PAM_USER'
op|','
name|'user'
op|')'
newline|'\n'
name|'pam'
op|'.'
name|'set_item'
op|'('
name|'PAM'
op|'.'
name|'PAM_CONV'
op|','
name|'conv'
op|')'
newline|'\n'
name|'gid'
op|'='
name|'os'
op|'.'
name|'getegid'
op|'('
op|')'
newline|'\n'
name|'uid'
op|'='
name|'os'
op|'.'
name|'geteuid'
op|'('
op|')'
newline|'\n'
name|'os'
op|'.'
name|'setegid'
op|'('
number|'0'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'seteuid'
op|'('
number|'0'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'pam'
op|'.'
name|'authenticate'
op|'('
op|')'
comment|'# these will raise'
newline|'\n'
name|'pam'
op|'.'
name|'acct_mgmt'
op|'('
op|')'
newline|'\n'
name|'return'
number|'1'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'        '
name|'os'
op|'.'
name|'setegid'
op|'('
name|'gid'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'seteuid'
op|'('
name|'uid'
op|')'
newline|'\n'
nl|'\n'
DECL|function|defConv
dedent|''
dedent|''
name|'def'
name|'defConv'
op|'('
name|'items'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'resp'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
name|'len'
op|'('
name|'items'
op|')'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'message'
op|','
name|'kind'
op|'='
name|'items'
op|'['
name|'i'
op|']'
newline|'\n'
name|'if'
name|'kind'
op|'=='
number|'1'
op|':'
comment|'# password'
newline|'\n'
indent|'            '
name|'p'
op|'='
name|'getpass'
op|'.'
name|'getpass'
op|'('
name|'message'
op|')'
newline|'\n'
name|'resp'
op|'.'
name|'append'
op|'('
op|'('
name|'p'
op|','
number|'0'
op|')'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'kind'
op|'=='
number|'2'
op|':'
comment|'# text'
newline|'\n'
indent|'            '
name|'p'
op|'='
name|'raw_input'
op|'('
name|'message'
op|')'
newline|'\n'
name|'resp'
op|'.'
name|'append'
op|'('
op|'('
name|'p'
op|','
number|'0'
op|')'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'kind'
name|'in'
op|'('
number|'3'
op|','
number|'4'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'print'
name|'message'
newline|'\n'
name|'resp'
op|'.'
name|'append'
op|'('
op|'('
string|'""'
op|','
number|'0'
op|')'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'defer'
op|'.'
name|'fail'
op|'('
string|"'foo'"
op|')'
newline|'\n'
dedent|''
dedent|''
name|'d'
op|'='
name|'defer'
op|'.'
name|'succeed'
op|'('
name|'resp'
op|')'
newline|'\n'
name|'return'
name|'d'
newline|'\n'
nl|'\n'
DECL|function|pamAuthenticate
dedent|''
name|'def'
name|'pamAuthenticate'
op|'('
name|'service'
op|','
name|'user'
op|','
name|'conv'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'return'
name|'threads'
op|'.'
name|'deferToThread'
op|'('
name|'pamAuthenticateThread'
op|','
name|'service'
op|','
name|'user'
op|','
name|'conv'
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit
