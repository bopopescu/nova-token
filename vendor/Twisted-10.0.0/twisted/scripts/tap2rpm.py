begin_unit
comment|'#  based off the tap2deb.py file'
nl|'\n'
comment|'#  tap2rpm.py built by Sean Reifschneider, <jafo@tummy.com>'
nl|'\n'
nl|'\n'
comment|'#  TODO: need to implement log-file rotation'
nl|'\n'
nl|'\n'
name|'import'
name|'sys'
op|','
name|'os'
op|','
name|'shutil'
op|','
name|'time'
op|','
name|'glob'
newline|'\n'
nl|'\n'
name|'from'
name|'twisted'
op|'.'
name|'python'
name|'import'
name|'usage'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'scripts'
name|'import'
name|'tap2deb'
newline|'\n'
nl|'\n'
nl|'\n'
comment|'#################################'
nl|'\n'
comment|'#  data that goes in /etc/inittab'
nl|'\n'
name|'initFileData'
op|'='
string|'\'\'\'\\\n#!/bin/sh\n#\n#  Startup script for a Twisted service.\n#\n#  chkconfig: - 85 15\n#  description: Start-up script for the Twisted service "%(tap_file)s".\n\nPATH=/usr/bin:/bin:/usr/sbin:/sbin\n\npidfile=/var/run/%(rpm_file)s.pid\nrundir=/var/lib/twisted-taps/%(rpm_file)s/\nfile=/etc/twisted-taps/%(tap_file)s\nlogfile=/var/log/%(rpm_file)s.log\n\n#  load init function library\n. /etc/init.d/functions\n\n[ -r /etc/default/%(rpm_file)s ] && . /etc/default/%(rpm_file)s\n\n#  check for required files\nif [ ! -x /usr/bin/twistd ]\nthen\n\techo "$0: Aborting, no /usr/bin/twistd found"\n\texit 0\nfi\nif [ ! -r "$file" ]\nthen\n\techo "$0: Aborting, no file $file found."\n\texit 0\nfi\n\n#  set up run directory if necessary\nif [ ! -d "${rundir}" ]\nthen\n\tmkdir -p "${rundir}"\nfi\n\n\ncase "$1" in\n\tstart)\n\t\techo -n "Starting %(rpm_file)s: twistd"\n\t\tdaemon twistd  \\\\\n\t\t\t\t--pidfile=$pidfile \\\\\n\t\t\t\t--rundir=$rundir \\\\\n\t\t\t\t--%(twistd_option)s=$file \\\\\n\t\t\t\t--logfile=$logfile\n\t\tstatus %(rpm_file)s\n\t\t;;\n\n\tstop)\n\t\techo -n "Stopping %(rpm_file)s: twistd"\n\t\tkill `cat "${pidfile}"`\n\t\tstatus %(rpm_file)s\n\t\t;;\n\n\trestart)\n\t\t"${0}" stop\n\t\t"${0}" start\n\t\t;;\n\n    *)\n\t\techo "Usage: ${0} {start|stop|restart|}" >&2\n\t\texit 1\n\t\t;;\nesac\n\nexit 0\n\'\'\''
newline|'\n'
nl|'\n'
comment|'#######################################'
nl|'\n'
comment|'#  the data for creating the spec file'
nl|'\n'
name|'specFileData'
op|'='
string|'\'\'\'\\\nSummary:    %(description)s\nName:       %(rpm_file)s\nVersion:    %(version)s\nRelease:    1\nCopyright:  Unknown\nGroup:      Networking/Daemons\nSource:     %(tarfile_basename)s\nBuildRoot:  /var/tmp/%%{name}-%%{version}-root\nRequires:   /usr/bin/twistd\nBuildArch:  noarch\n\n%%description\n%(long_description)s\n\n%%prep\n%%setup\n%%build\n\n%%install\n[ ! -z "$RPM_BUILD_ROOT" -a "$RPM_BUILD_ROOT" != \'/\' ] \\\n\t\t&& rm -rf "$RPM_BUILD_ROOT"\nmkdir -p "$RPM_BUILD_ROOT"/etc/twisted-taps\nmkdir -p "$RPM_BUILD_ROOT"/etc/init.d\nmkdir -p "$RPM_BUILD_ROOT"/var/lib/twisted-taps\ncp "%(tap_file)s" "$RPM_BUILD_ROOT"/etc/twisted-taps/\ncp "%(rpm_file)s.init" "$RPM_BUILD_ROOT"/etc/init.d/"%(rpm_file)s"\n\n%%clean\n[ ! -z "$RPM_BUILD_ROOT" -a "$RPM_BUILD_ROOT" != \'/\' ] \\\n\t\t&& rm -rf "$RPM_BUILD_ROOT"\n\n%%post\n/sbin/chkconfig --add %(rpm_file)s\n/sbin/chkconfig --level 35 %(rpm_file)s\n/etc/init.d/%(rpm_file)s start\n\n%%preun\n/etc/init.d/%(rpm_file)s stop\n/sbin/chkconfig --del %(rpm_file)s\n\n%%files\n%%defattr(-,root,root)\n%%attr(0755,root,root) /etc/init.d/%(rpm_file)s\n%%attr(0660,root,root) /etc/twisted-taps/%(tap_file)s\n\n%%changelog\n* %(date)s %(maintainer)s \n- Created by tap2rpm: %(rpm_file)s (%(version)s)\n\'\'\''
newline|'\n'
nl|'\n'
comment|'###############################'
nl|'\n'
DECL|class|MyOptions
name|'class'
name|'MyOptions'
op|'('
name|'usage'
op|'.'
name|'Options'
op|')'
op|':'
newline|'\n'
DECL|variable|optFlags
indent|'    '
name|'optFlags'
op|'='
op|'['
op|'['
string|'"unsigned"'
op|','
string|'"u"'
op|']'
op|']'
newline|'\n'
DECL|variable|optParameters
name|'optParameters'
op|'='
op|'['
nl|'\n'
op|'['
string|'"tapfile"'
op|','
string|'"t"'
op|','
string|'"twistd.tap"'
op|']'
op|','
nl|'\n'
op|'['
string|'"maintainer"'
op|','
string|'"m"'
op|','
string|'""'
op|']'
op|','
nl|'\n'
op|'['
string|'"protocol"'
op|','
string|'"p"'
op|','
string|'""'
op|']'
op|','
nl|'\n'
op|'['
string|'"description"'
op|','
string|'"e"'
op|','
string|'""'
op|']'
op|','
nl|'\n'
op|'['
string|'"long_description"'
op|','
string|'"l"'
op|','
string|'""'
op|']'
op|','
nl|'\n'
op|'['
string|'"set-version"'
op|','
string|'"V"'
op|','
string|'"1.0"'
op|']'
op|','
nl|'\n'
op|'['
string|'"rpmfile"'
op|','
string|'"r"'
op|','
name|'None'
op|']'
op|','
nl|'\n'
op|'['
string|'"type"'
op|','
string|'"y"'
op|','
string|'"tap"'
op|','
string|'"type of configuration: \'tap\', \'xml, "'
nl|'\n'
string|'"\'source\' or \'python\'"'
op|']'
op|','
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
comment|'#zsh_altArgDescr = {"foo":"use this description for foo instead"}'
nl|'\n'
comment|'#zsh_multiUse = ["foo", "bar"]'
nl|'\n'
comment|'#zsh_mutuallyExclusive = [("foo", "bar"), ("bar", "baz")]'
nl|'\n'
DECL|variable|zsh_actions
name|'zsh_actions'
op|'='
op|'{'
string|'"type"'
op|':'
string|'"(tap xml source python)"'
op|','
nl|'\n'
string|'"rpmfile"'
op|':'
string|'\'_files -g "*.rpm"\''
op|'}'
newline|'\n'
comment|'#zsh_actionDescr = {"logfile":"log file name", "random":"random seed"}'
nl|'\n'
nl|'\n'
nl|'\n'
DECL|variable|type_dict
dedent|''
name|'type_dict'
op|'='
op|'{'
nl|'\n'
string|"'tap'"
op|':'
string|"'file'"
op|','
nl|'\n'
string|"'python'"
op|':'
string|"'python'"
op|','
nl|'\n'
string|"'source'"
op|':'
string|"'source'"
op|','
nl|'\n'
string|"'xml'"
op|':'
string|"'xml'"
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
nl|'\n'
comment|'##########################'
nl|'\n'
DECL|function|makeBuildDir
name|'def'
name|'makeBuildDir'
op|'('
name|'baseDir'
op|')'
op|':'
newline|'\n'
indent|'    '
string|"'''Set up the temporary directory for building RPMs.\n    Returns: Tuple: ( buildDir, rpmrcFile )\n    '''"
newline|'\n'
name|'import'
name|'random'
op|','
name|'string'
newline|'\n'
nl|'\n'
comment|'#  make top directory'
nl|'\n'
name|'oldMask'
op|'='
name|'os'
op|'.'
name|'umask'
op|'('
number|'0077'
op|')'
newline|'\n'
name|'while'
number|'1'
op|':'
newline|'\n'
indent|'        '
name|'tmpDir'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'baseDir'
op|','
string|"'tap2rpm-%s-%s'"
op|'%'
op|'('
name|'os'
op|'.'
name|'getpid'
op|'('
op|')'
op|','
nl|'\n'
name|'random'
op|'.'
name|'randint'
op|'('
number|'0'
op|','
number|'999999999'
op|')'
op|')'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'tmpDir'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'tmpDir'
op|')'
newline|'\n'
name|'break'
newline|'\n'
dedent|''
dedent|''
name|'os'
op|'.'
name|'umask'
op|'('
name|'oldMask'
op|')'
newline|'\n'
nl|'\n'
comment|'#  set up initial directory contents'
nl|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpDir'
op|','
string|"'RPMS'"
op|','
string|"'noarch'"
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpDir'
op|','
string|"'SPECS'"
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpDir'
op|','
string|"'BUILD'"
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpDir'
op|','
string|"'SOURCES'"
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpDir'
op|','
string|"'SRPMS'"
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'#  set up rpmmacros file'
nl|'\n'
name|'macroFile'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpDir'
op|','
string|"'rpmmacros'"
op|')'
newline|'\n'
name|'rcFile'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpDir'
op|','
string|"'rpmrc'"
op|')'
newline|'\n'
name|'rpmrcData'
op|'='
name|'open'
op|'('
string|"'/usr/lib/rpm/rpmrc'"
op|','
string|"'r'"
op|')'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'rpmrcData'
op|'='
name|'string'
op|'.'
name|'replace'
op|'('
name|'rpmrcData'
op|','
string|"'~/.rpmmacros'"
op|','
name|'macroFile'
op|')'
newline|'\n'
name|'fp'
op|'='
name|'open'
op|'('
name|'macroFile'
op|','
string|"'w'"
op|')'
newline|'\n'
name|'fp'
op|'.'
name|'write'
op|'('
string|"'%%_topdir %s\\n'"
op|'%'
name|'tmpDir'
op|')'
newline|'\n'
name|'fp'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'#  set up the rpmrc file'
nl|'\n'
name|'fp'
op|'='
name|'open'
op|'('
name|'rcFile'
op|','
string|"'w'"
op|')'
newline|'\n'
name|'fp'
op|'.'
name|'write'
op|'('
name|'rpmrcData'
op|')'
newline|'\n'
name|'fp'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'return'
op|'('
op|'('
name|'tmpDir'
op|','
name|'rcFile'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
comment|'##########'
nl|'\n'
DECL|function|run
dedent|''
name|'def'
name|'run'
op|'('
op|')'
op|':'
newline|'\n'
comment|'#  parse options'
nl|'\n'
indent|'    '
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'config'
op|'='
name|'MyOptions'
op|'('
op|')'
newline|'\n'
name|'config'
op|'.'
name|'parseOptions'
op|'('
op|')'
newline|'\n'
dedent|''
name|'except'
name|'usage'
op|'.'
name|'error'
op|','
name|'ue'
op|':'
newline|'\n'
indent|'         '
name|'sys'
op|'.'
name|'exit'
op|'('
string|'"%s: %s"'
op|'%'
op|'('
name|'sys'
op|'.'
name|'argv'
op|'['
number|'0'
op|']'
op|','
name|'ue'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'#  set up some useful local variables'
nl|'\n'
dedent|''
name|'tap_file'
op|'='
name|'config'
op|'['
string|"'tapfile'"
op|']'
newline|'\n'
name|'base_tap_file'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'basename'
op|'('
name|'config'
op|'['
string|"'tapfile'"
op|']'
op|')'
newline|'\n'
name|'protocol'
op|'='
op|'('
name|'config'
op|'['
string|"'protocol'"
op|']'
name|'or'
name|'os'
op|'.'
name|'path'
op|'.'
name|'splitext'
op|'('
name|'base_tap_file'
op|')'
op|'['
number|'0'
op|']'
op|')'
newline|'\n'
name|'rpm_file'
op|'='
name|'config'
op|'['
string|"'rpmfile'"
op|']'
name|'or'
string|"'twisted-'"
op|'+'
name|'protocol'
newline|'\n'
name|'version'
op|'='
name|'config'
op|'['
string|"'set-version'"
op|']'
newline|'\n'
name|'maintainer'
op|'='
name|'config'
op|'['
string|"'maintainer'"
op|']'
newline|'\n'
name|'description'
op|'='
name|'config'
op|'['
string|"'description'"
op|']'
name|'or'
op|'('
string|"'A TCP server for %(protocol)s'"
op|'%'
nl|'\n'
name|'vars'
op|'('
op|')'
op|')'
newline|'\n'
name|'long_description'
op|'='
op|'('
name|'config'
op|'['
string|"'long_description'"
op|']'
nl|'\n'
name|'or'
string|'"Automatically created by tap2rpm"'
op|')'
newline|'\n'
name|'twistd_option'
op|'='
name|'type_dict'
op|'['
name|'config'
op|'['
string|"'type'"
op|']'
op|']'
newline|'\n'
name|'date'
op|'='
name|'time'
op|'.'
name|'strftime'
op|'('
string|"'%a %b %d %Y'"
op|','
name|'time'
op|'.'
name|'localtime'
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'directory'
op|'='
name|'rpm_file'
op|'+'
string|"'-'"
op|'+'
name|'version'
newline|'\n'
name|'python_version'
op|'='
string|"'%s.%s'"
op|'%'
name|'sys'
op|'.'
name|'version_info'
op|'['
op|':'
number|'2'
op|']'
newline|'\n'
nl|'\n'
comment|'#  set up a blank maintainer if not present'
nl|'\n'
name|'if'
name|'not'
name|'maintainer'
op|':'
newline|'\n'
indent|'        '
name|'maintainer'
op|'='
string|"'tap2rpm'"
newline|'\n'
nl|'\n'
comment|'#  create source archive directory'
nl|'\n'
dedent|''
name|'tmp_dir'
op|','
name|'rpmrc_file'
op|'='
name|'makeBuildDir'
op|'('
string|"'/var/tmp'"
op|')'
newline|'\n'
name|'source_dir'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmp_dir'
op|','
name|'directory'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'source_dir'
op|')'
newline|'\n'
nl|'\n'
comment|'#  populate source directory'
nl|'\n'
name|'tarfile_name'
op|'='
name|'source_dir'
op|'+'
string|"'.tar.gz'"
newline|'\n'
name|'tarfile_basename'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'basename'
op|'('
name|'tarfile_name'
op|')'
newline|'\n'
name|'tap2deb'
op|'.'
name|'save_to_file'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'source_dir'
op|','
string|"'%s.spec'"
op|'%'
name|'rpm_file'
op|')'
op|','
nl|'\n'
name|'specFileData'
op|'%'
name|'vars'
op|'('
op|')'
op|')'
newline|'\n'
name|'tap2deb'
op|'.'
name|'save_to_file'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'source_dir'
op|','
string|"'%s.init'"
op|'%'
name|'rpm_file'
op|')'
op|','
nl|'\n'
name|'initFileData'
op|'%'
name|'vars'
op|'('
op|')'
op|')'
newline|'\n'
name|'shutil'
op|'.'
name|'copy'
op|'('
name|'tap_file'
op|','
name|'source_dir'
op|')'
newline|'\n'
nl|'\n'
comment|'#  create source tar'
nl|'\n'
name|'os'
op|'.'
name|'system'
op|'('
string|'\'cd "%(tmp_dir)s"; tar cfz "%(tarfile_name)s" "%(directory)s"\''
nl|'\n'
op|'%'
name|'vars'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'#  build rpm'
nl|'\n'
name|'print'
string|"'Starting build...'"
newline|'\n'
name|'print'
string|"'='"
op|'*'
number|'70'
newline|'\n'
name|'sys'
op|'.'
name|'stdout'
op|'.'
name|'flush'
op|'('
op|')'
newline|'\n'
name|'os'
op|'.'
name|'system'
op|'('
string|'\'rpmbuild -ta --rcfile "%s" %s\''
op|'%'
op|'('
name|'rpmrc_file'
op|','
name|'tarfile_name'
op|')'
op|')'
newline|'\n'
name|'print'
string|"'Done with build...'"
newline|'\n'
name|'print'
string|"'='"
op|'*'
number|'70'
newline|'\n'
nl|'\n'
comment|'#  copy the RPMs to the local directory'
nl|'\n'
name|'rpm_path'
op|'='
name|'glob'
op|'.'
name|'glob'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmp_dir'
op|','
string|"'RPMS'"
op|','
string|"'noarch'"
op|','
string|"'*'"
op|')'
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'srpm_path'
op|'='
name|'glob'
op|'.'
name|'glob'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmp_dir'
op|','
string|"'SRPMS'"
op|','
string|"'*'"
op|')'
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'print'
string|'\'Writing "%s"...\''
op|'%'
name|'os'
op|'.'
name|'path'
op|'.'
name|'basename'
op|'('
name|'rpm_path'
op|')'
newline|'\n'
name|'shutil'
op|'.'
name|'copy'
op|'('
name|'rpm_path'
op|','
string|"'.'"
op|')'
newline|'\n'
name|'print'
string|'\'Writing "%s"...\''
op|'%'
name|'os'
op|'.'
name|'path'
op|'.'
name|'basename'
op|'('
name|'srpm_path'
op|')'
newline|'\n'
name|'shutil'
op|'.'
name|'copy'
op|'('
name|'srpm_path'
op|','
string|"'.'"
op|')'
newline|'\n'
nl|'\n'
comment|'#  remove the build directory'
nl|'\n'
name|'shutil'
op|'.'
name|'rmtree'
op|'('
name|'tmp_dir'
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit
