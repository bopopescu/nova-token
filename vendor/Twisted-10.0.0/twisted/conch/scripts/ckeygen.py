begin_unit
comment|'# -*- test-case-name: twisted.conch.test.test_ckeygen -*-'
nl|'\n'
comment|'# Copyright (c) 2001-2008 Twisted Matrix Laboratories.'
nl|'\n'
comment|'# See LICENSE for details.'
nl|'\n'
nl|'\n'
string|'"""\nImplementation module for the `ckeygen` command.\n"""'
newline|'\n'
nl|'\n'
name|'import'
name|'sys'
op|','
name|'os'
op|','
name|'getpass'
op|','
name|'socket'
newline|'\n'
name|'if'
name|'getpass'
op|'.'
name|'getpass'
op|'=='
name|'getpass'
op|'.'
name|'unix_getpass'
op|':'
newline|'\n'
indent|'    '
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'import'
name|'termios'
comment|'# hack around broken termios'
newline|'\n'
name|'termios'
op|'.'
name|'tcgetattr'
op|','
name|'termios'
op|'.'
name|'tcsetattr'
newline|'\n'
dedent|''
name|'except'
op|'('
name|'ImportError'
op|','
name|'AttributeError'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'sys'
op|'.'
name|'modules'
op|'['
string|"'termios'"
op|']'
op|'='
name|'None'
newline|'\n'
name|'reload'
op|'('
name|'getpass'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'from'
name|'twisted'
op|'.'
name|'conch'
op|'.'
name|'ssh'
name|'import'
name|'keys'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'python'
name|'import'
name|'filepath'
op|','
name|'log'
op|','
name|'usage'
op|','
name|'randbytes'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|GeneralOptions
name|'class'
name|'GeneralOptions'
op|'('
name|'usage'
op|'.'
name|'Options'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'synopsis'
op|'='
string|'"""Usage:    ckeygen [options]\n """'
newline|'\n'
nl|'\n'
DECL|variable|longdesc
name|'longdesc'
op|'='
string|'"ckeygen manipulates public/private keys in various ways."'
newline|'\n'
nl|'\n'
DECL|variable|optParameters
name|'optParameters'
op|'='
op|'['
op|'['
string|"'bits'"
op|','
string|"'b'"
op|','
number|'1024'
op|','
string|"'Number of bits in the key to create.'"
op|']'
op|','
nl|'\n'
op|'['
string|"'filename'"
op|','
string|"'f'"
op|','
name|'None'
op|','
string|"'Filename of the key file.'"
op|']'
op|','
nl|'\n'
op|'['
string|"'type'"
op|','
string|"'t'"
op|','
name|'None'
op|','
string|"'Specify type of key to create.'"
op|']'
op|','
nl|'\n'
op|'['
string|"'comment'"
op|','
string|"'C'"
op|','
name|'None'
op|','
string|"'Provide new comment.'"
op|']'
op|','
nl|'\n'
op|'['
string|"'newpass'"
op|','
string|"'N'"
op|','
name|'None'
op|','
string|"'Provide new passphrase.'"
op|']'
op|','
nl|'\n'
op|'['
string|"'pass'"
op|','
string|"'P'"
op|','
name|'None'
op|','
string|"'Provide old passphrase'"
op|']'
op|']'
newline|'\n'
nl|'\n'
DECL|variable|optFlags
name|'optFlags'
op|'='
op|'['
op|'['
string|"'fingerprint'"
op|','
string|"'l'"
op|','
string|"'Show fingerprint of key file.'"
op|']'
op|','
nl|'\n'
op|'['
string|"'changepass'"
op|','
string|"'p'"
op|','
string|"'Change passphrase of private key file.'"
op|']'
op|','
nl|'\n'
op|'['
string|"'quiet'"
op|','
string|"'q'"
op|','
string|"'Quiet.'"
op|']'
op|','
nl|'\n'
op|'['
string|"'showpub'"
op|','
string|"'y'"
op|','
string|"'Read private key file and print public key.'"
op|']'
op|']'
newline|'\n'
nl|'\n'
comment|'#zsh_altArgDescr = {"bits":"Number of bits in the key (default: 1024)"}'
nl|'\n'
comment|'#zsh_multiUse = ["foo", "bar"]'
nl|'\n'
comment|'#zsh_mutuallyExclusive = [("foo", "bar"), ("bar", "baz")]'
nl|'\n'
DECL|variable|zsh_actions
name|'zsh_actions'
op|'='
op|'{'
string|'"type"'
op|':'
string|'"(rsa dsa)"'
op|'}'
newline|'\n'
comment|'#zsh_actionDescr = {"logfile":"log file name", "random":"random seed"}'
nl|'\n'
nl|'\n'
DECL|function|run
dedent|''
name|'def'
name|'run'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'options'
op|'='
name|'GeneralOptions'
op|'('
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'options'
op|'.'
name|'parseOptions'
op|'('
name|'sys'
op|'.'
name|'argv'
op|'['
number|'1'
op|':'
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'usage'
op|'.'
name|'UsageError'
op|','
name|'u'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|"'ERROR: %s'"
op|'%'
name|'u'
newline|'\n'
name|'options'
op|'.'
name|'opt_help'
op|'('
op|')'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
number|'1'
op|')'
newline|'\n'
dedent|''
name|'log'
op|'.'
name|'discardLogs'
op|'('
op|')'
newline|'\n'
name|'log'
op|'.'
name|'deferr'
op|'='
name|'handleError'
comment|'# HACK'
newline|'\n'
name|'if'
name|'options'
op|'['
string|"'type'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'options'
op|'['
string|"'type'"
op|']'
op|'=='
string|"'rsa'"
op|':'
newline|'\n'
indent|'            '
name|'generateRSAkey'
op|'('
name|'options'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'options'
op|'['
string|"'type'"
op|']'
op|'=='
string|"'dsa'"
op|':'
newline|'\n'
indent|'            '
name|'generateDSAkey'
op|'('
name|'options'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'sys'
op|'.'
name|'exit'
op|'('
string|"'Key type was %s, must be one of: rsa, dsa'"
op|'%'
name|'options'
op|'['
string|"'type'"
op|']'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'elif'
name|'options'
op|'['
string|"'fingerprint'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'printFingerprint'
op|'('
name|'options'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'options'
op|'['
string|"'changepass'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'changePassPhrase'
op|'('
name|'options'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'options'
op|'['
string|"'showpub'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'displayPublicKey'
op|'('
name|'options'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'options'
op|'.'
name|'opt_help'
op|'('
op|')'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|function|handleError
dedent|''
dedent|''
name|'def'
name|'handleError'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'from'
name|'twisted'
op|'.'
name|'python'
name|'import'
name|'failure'
newline|'\n'
name|'global'
name|'exitStatus'
newline|'\n'
name|'exitStatus'
op|'='
number|'2'
newline|'\n'
name|'log'
op|'.'
name|'err'
op|'('
name|'failure'
op|'.'
name|'Failure'
op|'('
op|')'
op|')'
newline|'\n'
name|'reactor'
op|'.'
name|'stop'
op|'('
op|')'
newline|'\n'
name|'raise'
newline|'\n'
nl|'\n'
DECL|function|generateRSAkey
dedent|''
name|'def'
name|'generateRSAkey'
op|'('
name|'options'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'from'
name|'Crypto'
op|'.'
name|'PublicKey'
name|'import'
name|'RSA'
newline|'\n'
name|'print'
string|"'Generating public/private rsa key pair.'"
newline|'\n'
name|'key'
op|'='
name|'RSA'
op|'.'
name|'generate'
op|'('
name|'int'
op|'('
name|'options'
op|'['
string|"'bits'"
op|']'
op|')'
op|','
name|'randbytes'
op|'.'
name|'secureRandom'
op|')'
newline|'\n'
name|'_saveKey'
op|'('
name|'key'
op|','
name|'options'
op|')'
newline|'\n'
nl|'\n'
DECL|function|generateDSAkey
dedent|''
name|'def'
name|'generateDSAkey'
op|'('
name|'options'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'from'
name|'Crypto'
op|'.'
name|'PublicKey'
name|'import'
name|'DSA'
newline|'\n'
name|'print'
string|"'Generating public/private dsa key pair.'"
newline|'\n'
name|'key'
op|'='
name|'DSA'
op|'.'
name|'generate'
op|'('
name|'int'
op|'('
name|'options'
op|'['
string|"'bits'"
op|']'
op|')'
op|','
name|'randbytes'
op|'.'
name|'secureRandom'
op|')'
newline|'\n'
name|'_saveKey'
op|'('
name|'key'
op|','
name|'options'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|printFingerprint
dedent|''
name|'def'
name|'printFingerprint'
op|'('
name|'options'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'not'
name|'options'
op|'['
string|"'filename'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'filename'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'expanduser'
op|'('
string|"'~/.ssh/id_rsa'"
op|')'
newline|'\n'
name|'options'
op|'['
string|"'filename'"
op|']'
op|'='
name|'raw_input'
op|'('
string|"'Enter file in which the key is (%s): '"
op|'%'
name|'filename'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'options'
op|'['
string|"'filename'"
op|']'
op|'+'
string|"'.pub'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'options'
op|'['
string|"'filename'"
op|']'
op|'+='
string|"'.pub'"
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'key'
op|'='
name|'keys'
op|'.'
name|'Key'
op|'.'
name|'fromFile'
op|'('
name|'options'
op|'['
string|"'filename'"
op|']'
op|')'
newline|'\n'
name|'obj'
op|'='
name|'key'
op|'.'
name|'keyObject'
newline|'\n'
name|'string'
op|'='
name|'key'
op|'.'
name|'blob'
op|'('
op|')'
newline|'\n'
name|'print'
string|"'%s %s %s'"
op|'%'
op|'('
nl|'\n'
name|'obj'
op|'.'
name|'size'
op|'('
op|')'
op|'+'
number|'1'
op|','
nl|'\n'
name|'key'
op|'.'
name|'fingerprint'
op|'('
op|')'
op|','
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'basename'
op|'('
name|'options'
op|'['
string|"'filename'"
op|']'
op|')'
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'        '
name|'sys'
op|'.'
name|'exit'
op|'('
string|"'bad key'"
op|')'
newline|'\n'
nl|'\n'
DECL|function|changePassPhrase
dedent|''
dedent|''
name|'def'
name|'changePassPhrase'
op|'('
name|'options'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'not'
name|'options'
op|'['
string|"'filename'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'filename'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'expanduser'
op|'('
string|"'~/.ssh/id_rsa'"
op|')'
newline|'\n'
name|'options'
op|'['
string|"'filename'"
op|']'
op|'='
name|'raw_input'
op|'('
string|"'Enter file in which the key is (%s): '"
op|'%'
name|'filename'
op|')'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'key'
op|'='
name|'keys'
op|'.'
name|'getPrivateKeyObject'
op|'('
name|'options'
op|'['
string|"'filename'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'keys'
op|'.'
name|'BadKeyError'
op|','
name|'e'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'e'
op|'.'
name|'args'
op|'['
number|'0'
op|']'
op|'!='
string|"'encrypted key with no passphrase'"
op|':'
newline|'\n'
indent|'            '
name|'raise'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'options'
op|'['
string|"'pass'"
op|']'
op|':'
newline|'\n'
indent|'                '
name|'options'
op|'['
string|"'pass'"
op|']'
op|'='
name|'getpass'
op|'.'
name|'getpass'
op|'('
string|"'Enter old passphrase: '"
op|')'
newline|'\n'
dedent|''
name|'key'
op|'='
name|'keys'
op|'.'
name|'getPrivateKeyObject'
op|'('
name|'options'
op|'['
string|"'filename'"
op|']'
op|','
name|'passphrase'
op|'='
name|'options'
op|'['
string|"'pass'"
op|']'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'not'
name|'options'
op|'['
string|"'newpass'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'while'
number|'1'
op|':'
newline|'\n'
indent|'            '
name|'p1'
op|'='
name|'getpass'
op|'.'
name|'getpass'
op|'('
string|"'Enter new passphrase (empty for no passphrase): '"
op|')'
newline|'\n'
name|'p2'
op|'='
name|'getpass'
op|'.'
name|'getpass'
op|'('
string|"'Enter same passphrase again: '"
op|')'
newline|'\n'
name|'if'
name|'p1'
op|'=='
name|'p2'
op|':'
newline|'\n'
indent|'                '
name|'break'
newline|'\n'
dedent|''
name|'print'
string|"'Passphrases do not match.  Try again.'"
newline|'\n'
dedent|''
name|'options'
op|'['
string|"'newpass'"
op|']'
op|'='
name|'p1'
newline|'\n'
dedent|''
name|'open'
op|'('
name|'options'
op|'['
string|"'filename'"
op|']'
op|','
string|"'w'"
op|')'
op|'.'
name|'write'
op|'('
nl|'\n'
name|'keys'
op|'.'
name|'makePrivateKeyString'
op|'('
name|'key'
op|','
name|'passphrase'
op|'='
name|'options'
op|'['
string|"'newpass'"
op|']'
op|')'
op|')'
newline|'\n'
name|'print'
string|"'Your identification has been saved with the new passphrase.'"
newline|'\n'
nl|'\n'
DECL|function|displayPublicKey
dedent|''
name|'def'
name|'displayPublicKey'
op|'('
name|'options'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'not'
name|'options'
op|'['
string|"'filename'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'filename'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'expanduser'
op|'('
string|"'~/.ssh/id_rsa'"
op|')'
newline|'\n'
name|'options'
op|'['
string|"'filename'"
op|']'
op|'='
name|'raw_input'
op|'('
string|"'Enter file in which the key is (%s): '"
op|'%'
name|'filename'
op|')'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'key'
op|'='
name|'keys'
op|'.'
name|'getPrivateKeyObject'
op|'('
name|'options'
op|'['
string|"'filename'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'keys'
op|'.'
name|'BadKeyError'
op|','
name|'e'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'e'
op|'.'
name|'args'
op|'['
number|'0'
op|']'
op|'!='
string|"'encrypted key with no passphrase'"
op|':'
newline|'\n'
indent|'            '
name|'raise'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'options'
op|'['
string|"'pass'"
op|']'
op|':'
newline|'\n'
indent|'                '
name|'options'
op|'['
string|"'pass'"
op|']'
op|'='
name|'getpass'
op|'.'
name|'getpass'
op|'('
string|"'Enter passphrase: '"
op|')'
newline|'\n'
dedent|''
name|'key'
op|'='
name|'keys'
op|'.'
name|'getPrivateKeyObject'
op|'('
name|'options'
op|'['
string|"'filename'"
op|']'
op|','
name|'passphrase'
op|'='
name|'options'
op|'['
string|"'pass'"
op|']'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'print'
name|'keys'
op|'.'
name|'makePublicKeyString'
op|'('
name|'key'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_saveKey
dedent|''
name|'def'
name|'_saveKey'
op|'('
name|'key'
op|','
name|'options'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'not'
name|'options'
op|'['
string|"'filename'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'kind'
op|'='
name|'keys'
op|'.'
name|'objectType'
op|'('
name|'key'
op|')'
newline|'\n'
name|'kind'
op|'='
op|'{'
string|"'ssh-rsa'"
op|':'
string|"'rsa'"
op|','
string|"'ssh-dss'"
op|':'
string|"'dsa'"
op|'}'
op|'['
name|'kind'
op|']'
newline|'\n'
name|'filename'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'expanduser'
op|'('
string|"'~/.ssh/id_%s'"
op|'%'
name|'kind'
op|')'
newline|'\n'
name|'options'
op|'['
string|"'filename'"
op|']'
op|'='
name|'raw_input'
op|'('
string|"'Enter file in which to save the key (%s): '"
op|'%'
name|'filename'
op|')'
op|'.'
name|'strip'
op|'('
op|')'
name|'or'
name|'filename'
newline|'\n'
dedent|''
name|'if'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'options'
op|'['
string|"'filename'"
op|']'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|"'%s already exists.'"
op|'%'
name|'options'
op|'['
string|"'filename'"
op|']'
newline|'\n'
name|'yn'
op|'='
name|'raw_input'
op|'('
string|"'Overwrite (y/n)? '"
op|')'
newline|'\n'
name|'if'
name|'yn'
op|'['
number|'0'
op|']'
op|'.'
name|'lower'
op|'('
op|')'
op|'!='
string|"'y'"
op|':'
newline|'\n'
indent|'            '
name|'sys'
op|'.'
name|'exit'
op|'('
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'not'
name|'options'
op|'['
string|"'pass'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'while'
number|'1'
op|':'
newline|'\n'
indent|'            '
name|'p1'
op|'='
name|'getpass'
op|'.'
name|'getpass'
op|'('
string|"'Enter passphrase (empty for no passphrase): '"
op|')'
newline|'\n'
name|'p2'
op|'='
name|'getpass'
op|'.'
name|'getpass'
op|'('
string|"'Enter same passphrase again: '"
op|')'
newline|'\n'
name|'if'
name|'p1'
op|'=='
name|'p2'
op|':'
newline|'\n'
indent|'                '
name|'break'
newline|'\n'
dedent|''
name|'print'
string|"'Passphrases do not match.  Try again.'"
newline|'\n'
dedent|''
name|'options'
op|'['
string|"'pass'"
op|']'
op|'='
name|'p1'
newline|'\n'
nl|'\n'
dedent|''
name|'keyObj'
op|'='
name|'keys'
op|'.'
name|'Key'
op|'('
name|'key'
op|')'
newline|'\n'
name|'comment'
op|'='
string|"'%s@%s'"
op|'%'
op|'('
name|'getpass'
op|'.'
name|'getuser'
op|'('
op|')'
op|','
name|'socket'
op|'.'
name|'gethostname'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'filepath'
op|'.'
name|'FilePath'
op|'('
name|'options'
op|'['
string|"'filename'"
op|']'
op|')'
op|'.'
name|'setContent'
op|'('
nl|'\n'
name|'keyObj'
op|'.'
name|'toString'
op|'('
string|"'openssh'"
op|','
name|'options'
op|'['
string|"'pass'"
op|']'
op|')'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'chmod'
op|'('
name|'options'
op|'['
string|"'filename'"
op|']'
op|','
number|'33152'
op|')'
newline|'\n'
nl|'\n'
name|'filepath'
op|'.'
name|'FilePath'
op|'('
name|'options'
op|'['
string|"'filename'"
op|']'
op|'+'
string|"'.pub'"
op|')'
op|'.'
name|'setContent'
op|'('
nl|'\n'
name|'keyObj'
op|'.'
name|'public'
op|'('
op|')'
op|'.'
name|'toString'
op|'('
string|"'openssh'"
op|','
name|'comment'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'print'
string|"'Your identification has been saved in %s'"
op|'%'
name|'options'
op|'['
string|"'filename'"
op|']'
newline|'\n'
name|'print'
string|"'Your public key has been saved in %s.pub'"
op|'%'
name|'options'
op|'['
string|"'filename'"
op|']'
newline|'\n'
name|'print'
string|"'The key fingerprint is:'"
newline|'\n'
name|'print'
name|'keyObj'
op|'.'
name|'fingerprint'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'__name__'
op|'=='
string|"'__main__'"
op|':'
newline|'\n'
indent|'    '
name|'run'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
endmarker|''
end_unit
