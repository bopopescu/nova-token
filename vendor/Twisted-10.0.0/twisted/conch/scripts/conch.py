begin_unit
comment|'# -*- test-case-name: twisted.conch.test.test_conch -*-'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Copyright (c) 2001-2004 Twisted Matrix Laboratories.'
nl|'\n'
comment|'# See LICENSE for details.'
nl|'\n'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# $Id: conch.py,v 1.65 2004/03/11 00:29:14 z3p Exp $'
nl|'\n'
nl|'\n'
comment|'#""" Implementation module for the `conch` command.'
nl|'\n'
comment|'#"""'
nl|'\n'
name|'from'
name|'twisted'
op|'.'
name|'conch'
op|'.'
name|'client'
name|'import'
name|'connect'
op|','
name|'default'
op|','
name|'options'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'conch'
op|'.'
name|'error'
name|'import'
name|'ConchError'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'conch'
op|'.'
name|'ssh'
name|'import'
name|'connection'
op|','
name|'common'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'conch'
op|'.'
name|'ssh'
name|'import'
name|'session'
op|','
name|'forwarding'
op|','
name|'channel'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'internet'
name|'import'
name|'reactor'
op|','
name|'stdio'
op|','
name|'task'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'python'
name|'import'
name|'log'
op|','
name|'usage'
newline|'\n'
nl|'\n'
name|'import'
name|'os'
op|','
name|'sys'
op|','
name|'getpass'
op|','
name|'struct'
op|','
name|'tty'
op|','
name|'fcntl'
op|','
name|'signal'
newline|'\n'
nl|'\n'
DECL|class|ClientOptions
name|'class'
name|'ClientOptions'
op|'('
name|'options'
op|'.'
name|'ConchOptions'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'    '
name|'synopsis'
op|'='
string|'"""Usage:   conch [options] host [command]\n"""'
newline|'\n'
DECL|variable|longdesc
name|'longdesc'
op|'='
op|'('
string|'"conch is a SSHv2 client that allows logging into a remote "'
nl|'\n'
string|'"machine and executing commands."'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|optParameters
name|'optParameters'
op|'='
op|'['
op|'['
string|"'escape'"
op|','
string|"'e'"
op|','
string|"'~'"
op|']'
op|','
nl|'\n'
op|'['
string|"'localforward'"
op|','
string|"'L'"
op|','
name|'None'
op|','
string|"'listen-port:host:port   Forward local port to remote address'"
op|']'
op|','
nl|'\n'
op|'['
string|"'remoteforward'"
op|','
string|"'R'"
op|','
name|'None'
op|','
string|"'listen-port:host:port   Forward remote port to local address'"
op|']'
op|','
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
DECL|variable|optFlags
name|'optFlags'
op|'='
op|'['
op|'['
string|"'null'"
op|','
string|"'n'"
op|','
string|"'Redirect input from /dev/null.'"
op|']'
op|','
nl|'\n'
op|'['
string|"'fork'"
op|','
string|"'f'"
op|','
string|"'Fork to background after authentication.'"
op|']'
op|','
nl|'\n'
op|'['
string|"'tty'"
op|','
string|"'t'"
op|','
string|"'Tty; allocate a tty even if command is given.'"
op|']'
op|','
nl|'\n'
op|'['
string|"'notty'"
op|','
string|"'T'"
op|','
string|"'Do not allocate a tty.'"
op|']'
op|','
nl|'\n'
op|'['
string|"'noshell'"
op|','
string|"'N'"
op|','
string|"'Do not execute a shell or command.'"
op|']'
op|','
nl|'\n'
op|'['
string|"'subsystem'"
op|','
string|"'s'"
op|','
string|"'Invoke command (mandatory) as SSH2 subsystem.'"
op|']'
op|','
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
comment|'#zsh_altArgDescr = {"foo":"use this description for foo instead"}'
nl|'\n'
comment|'#zsh_multiUse = ["foo", "bar"]'
nl|'\n'
comment|'#zsh_mutuallyExclusive = [("foo", "bar"), ("bar", "baz")]'
nl|'\n'
comment|'#zsh_actions = {"foo":\'_files -g "*.foo"\', "bar":"(one two three)"}'
nl|'\n'
DECL|variable|zsh_actionDescr
name|'zsh_actionDescr'
op|'='
op|'{'
string|'"localforward"'
op|':'
string|'"listen-port:host:port"'
op|','
nl|'\n'
string|'"remoteforward"'
op|':'
string|'"listen-port:host:port"'
op|'}'
newline|'\n'
DECL|variable|zsh_extras
name|'zsh_extras'
op|'='
op|'['
string|'"*:command: "'
op|']'
newline|'\n'
nl|'\n'
DECL|variable|localForwards
name|'localForwards'
op|'='
op|'['
op|']'
newline|'\n'
DECL|variable|remoteForwards
name|'remoteForwards'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
DECL|member|opt_escape
name|'def'
name|'opt_escape'
op|'('
name|'self'
op|','
name|'esc'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"Set escape character; ``none\'\' = disable"'
newline|'\n'
name|'if'
name|'esc'
op|'=='
string|"'none'"
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'['
string|"'escape'"
op|']'
op|'='
name|'None'
newline|'\n'
dedent|''
name|'elif'
name|'esc'
op|'['
number|'0'
op|']'
op|'=='
string|"'^'"
name|'and'
name|'len'
op|'('
name|'esc'
op|')'
op|'=='
number|'2'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'['
string|"'escape'"
op|']'
op|'='
name|'chr'
op|'('
name|'ord'
op|'('
name|'esc'
op|'['
number|'1'
op|']'
op|')'
op|'-'
number|'64'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'len'
op|'('
name|'esc'
op|')'
op|'=='
number|'1'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'['
string|"'escape'"
op|']'
op|'='
name|'esc'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'sys'
op|'.'
name|'exit'
op|'('
string|'"Bad escape character \'%s\'."'
op|'%'
name|'esc'
op|')'
newline|'\n'
nl|'\n'
DECL|member|opt_localforward
dedent|''
dedent|''
name|'def'
name|'opt_localforward'
op|'('
name|'self'
op|','
name|'f'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"Forward local port to remote address (lport:host:port)"'
newline|'\n'
name|'localPort'
op|','
name|'remoteHost'
op|','
name|'remotePort'
op|'='
name|'f'
op|'.'
name|'split'
op|'('
string|"':'"
op|')'
comment|"# doesn't do v6 yet"
newline|'\n'
name|'localPort'
op|'='
name|'int'
op|'('
name|'localPort'
op|')'
newline|'\n'
name|'remotePort'
op|'='
name|'int'
op|'('
name|'remotePort'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'localForwards'
op|'.'
name|'append'
op|'('
op|'('
name|'localPort'
op|','
op|'('
name|'remoteHost'
op|','
name|'remotePort'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|opt_remoteforward
dedent|''
name|'def'
name|'opt_remoteforward'
op|'('
name|'self'
op|','
name|'f'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Forward remote port to local address (rport:host:port)"""'
newline|'\n'
name|'remotePort'
op|','
name|'connHost'
op|','
name|'connPort'
op|'='
name|'f'
op|'.'
name|'split'
op|'('
string|"':'"
op|')'
comment|"# doesn't do v6 yet"
newline|'\n'
name|'remotePort'
op|'='
name|'int'
op|'('
name|'remotePort'
op|')'
newline|'\n'
name|'connPort'
op|'='
name|'int'
op|'('
name|'connPort'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'remoteForwards'
op|'.'
name|'append'
op|'('
op|'('
name|'remotePort'
op|','
op|'('
name|'connHost'
op|','
name|'connPort'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|parseArgs
dedent|''
name|'def'
name|'parseArgs'
op|'('
name|'self'
op|','
name|'host'
op|','
op|'*'
name|'command'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'['
string|"'host'"
op|']'
op|'='
name|'host'
newline|'\n'
name|'self'
op|'['
string|"'command'"
op|']'
op|'='
string|"' '"
op|'.'
name|'join'
op|'('
name|'command'
op|')'
newline|'\n'
nl|'\n'
comment|'# Rest of code in "run"'
nl|'\n'
DECL|variable|options
dedent|''
dedent|''
name|'options'
op|'='
name|'None'
newline|'\n'
DECL|variable|conn
name|'conn'
op|'='
name|'None'
newline|'\n'
DECL|variable|exitStatus
name|'exitStatus'
op|'='
number|'0'
newline|'\n'
DECL|variable|old
name|'old'
op|'='
name|'None'
newline|'\n'
DECL|variable|_inRawMode
name|'_inRawMode'
op|'='
number|'0'
newline|'\n'
DECL|variable|_savedRawMode
name|'_savedRawMode'
op|'='
name|'None'
newline|'\n'
nl|'\n'
DECL|function|run
name|'def'
name|'run'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'global'
name|'options'
op|','
name|'old'
newline|'\n'
name|'args'
op|'='
name|'sys'
op|'.'
name|'argv'
op|'['
number|'1'
op|':'
op|']'
newline|'\n'
name|'if'
string|"'-l'"
name|'in'
name|'args'
op|':'
comment|'# cvs is an idiot'
newline|'\n'
indent|'        '
name|'i'
op|'='
name|'args'
op|'.'
name|'index'
op|'('
string|"'-l'"
op|')'
newline|'\n'
name|'args'
op|'='
name|'args'
op|'['
name|'i'
op|':'
name|'i'
op|'+'
number|'2'
op|']'
op|'+'
name|'args'
newline|'\n'
name|'del'
name|'args'
op|'['
name|'i'
op|'+'
number|'2'
op|':'
name|'i'
op|'+'
number|'4'
op|']'
newline|'\n'
dedent|''
name|'for'
name|'arg'
name|'in'
name|'args'
op|'['
op|':'
op|']'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'i'
op|'='
name|'args'
op|'.'
name|'index'
op|'('
name|'arg'
op|')'
newline|'\n'
name|'if'
name|'arg'
op|'['
op|':'
number|'2'
op|']'
op|'=='
string|"'-o'"
name|'and'
name|'args'
op|'['
name|'i'
op|'+'
number|'1'
op|']'
op|'['
number|'0'
op|']'
op|'!='
string|"'-'"
op|':'
newline|'\n'
indent|'                '
name|'args'
op|'['
name|'i'
op|':'
name|'i'
op|'+'
number|'2'
op|']'
op|'='
op|'['
op|']'
comment|'# suck on it scp'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
dedent|''
name|'options'
op|'='
name|'ClientOptions'
op|'('
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'options'
op|'.'
name|'parseOptions'
op|'('
name|'args'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'usage'
op|'.'
name|'UsageError'
op|','
name|'u'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|"'ERROR: %s'"
op|'%'
name|'u'
newline|'\n'
name|'options'
op|'.'
name|'opt_help'
op|'('
op|')'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
number|'1'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'options'
op|'['
string|"'log'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'options'
op|'['
string|"'logfile'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'options'
op|'['
string|"'logfile'"
op|']'
op|'=='
string|"'-'"
op|':'
newline|'\n'
indent|'                '
name|'f'
op|'='
name|'sys'
op|'.'
name|'stdout'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'f'
op|'='
name|'file'
op|'('
name|'options'
op|'['
string|"'logfile'"
op|']'
op|','
string|"'a+'"
op|')'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'f'
op|'='
name|'sys'
op|'.'
name|'stderr'
newline|'\n'
dedent|''
name|'realout'
op|'='
name|'sys'
op|'.'
name|'stdout'
newline|'\n'
name|'log'
op|'.'
name|'startLogging'
op|'('
name|'f'
op|')'
newline|'\n'
name|'sys'
op|'.'
name|'stdout'
op|'='
name|'realout'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'log'
op|'.'
name|'discardLogs'
op|'('
op|')'
newline|'\n'
dedent|''
name|'doConnect'
op|'('
op|')'
newline|'\n'
name|'fd'
op|'='
name|'sys'
op|'.'
name|'stdin'
op|'.'
name|'fileno'
op|'('
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'old'
op|'='
name|'tty'
op|'.'
name|'tcgetattr'
op|'('
name|'fd'
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'        '
name|'old'
op|'='
name|'None'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'oldUSR1'
op|'='
name|'signal'
op|'.'
name|'signal'
op|'('
name|'signal'
op|'.'
name|'SIGUSR1'
op|','
name|'lambda'
op|'*'
name|'a'
op|':'
name|'reactor'
op|'.'
name|'callLater'
op|'('
number|'0'
op|','
name|'reConnect'
op|')'
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'        '
name|'oldUSR1'
op|'='
name|'None'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'reactor'
op|'.'
name|'run'
op|'('
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'old'
op|':'
newline|'\n'
indent|'            '
name|'tty'
op|'.'
name|'tcsetattr'
op|'('
name|'fd'
op|','
name|'tty'
op|'.'
name|'TCSANOW'
op|','
name|'old'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'oldUSR1'
op|':'
newline|'\n'
indent|'            '
name|'signal'
op|'.'
name|'signal'
op|'('
name|'signal'
op|'.'
name|'SIGUSR1'
op|','
name|'oldUSR1'
op|')'
newline|'\n'
dedent|''
name|'if'
op|'('
name|'options'
op|'['
string|"'command'"
op|']'
name|'and'
name|'options'
op|'['
string|"'tty'"
op|']'
op|')'
name|'or'
name|'not'
name|'options'
op|'['
string|"'notty'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'signal'
op|'.'
name|'signal'
op|'('
name|'signal'
op|'.'
name|'SIGWINCH'
op|','
name|'signal'
op|'.'
name|'SIG_DFL'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'sys'
op|'.'
name|'stdout'
op|'.'
name|'isatty'
op|'('
op|')'
name|'and'
name|'not'
name|'options'
op|'['
string|"'command'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|"'Connection to %s closed.'"
op|'%'
name|'options'
op|'['
string|"'host'"
op|']'
newline|'\n'
dedent|''
name|'sys'
op|'.'
name|'exit'
op|'('
name|'exitStatus'
op|')'
newline|'\n'
nl|'\n'
DECL|function|handleError
dedent|''
name|'def'
name|'handleError'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'from'
name|'twisted'
op|'.'
name|'python'
name|'import'
name|'failure'
newline|'\n'
name|'global'
name|'exitStatus'
newline|'\n'
name|'exitStatus'
op|'='
number|'2'
newline|'\n'
name|'reactor'
op|'.'
name|'callLater'
op|'('
number|'0.01'
op|','
name|'_stopReactor'
op|')'
newline|'\n'
name|'log'
op|'.'
name|'err'
op|'('
name|'failure'
op|'.'
name|'Failure'
op|'('
op|')'
op|')'
newline|'\n'
name|'raise'
newline|'\n'
nl|'\n'
DECL|function|_stopReactor
dedent|''
name|'def'
name|'_stopReactor'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'reactor'
op|'.'
name|'stop'
op|'('
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
name|'pass'
newline|'\n'
nl|'\n'
DECL|function|doConnect
dedent|''
name|'def'
name|'doConnect'
op|'('
op|')'
op|':'
newline|'\n'
comment|'#    log.deferr = handleError # HACK'
nl|'\n'
indent|'    '
name|'if'
string|"'@'"
name|'in'
name|'options'
op|'['
string|"'host'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'options'
op|'['
string|"'user'"
op|']'
op|','
name|'options'
op|'['
string|"'host'"
op|']'
op|'='
name|'options'
op|'['
string|"'host'"
op|']'
op|'.'
name|'split'
op|'('
string|"'@'"
op|','
number|'1'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'options'
op|'.'
name|'identitys'
op|':'
newline|'\n'
indent|'        '
name|'options'
op|'.'
name|'identitys'
op|'='
op|'['
string|"'~/.ssh/id_rsa'"
op|','
string|"'~/.ssh/id_dsa'"
op|']'
newline|'\n'
dedent|''
name|'host'
op|'='
name|'options'
op|'['
string|"'host'"
op|']'
newline|'\n'
name|'if'
name|'not'
name|'options'
op|'['
string|"'user'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'options'
op|'['
string|"'user'"
op|']'
op|'='
name|'getpass'
op|'.'
name|'getuser'
op|'('
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'options'
op|'['
string|"'port'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'options'
op|'['
string|"'port'"
op|']'
op|'='
number|'22'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'options'
op|'['
string|"'port'"
op|']'
op|'='
name|'int'
op|'('
name|'options'
op|'['
string|"'port'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'host'
op|'='
name|'options'
op|'['
string|"'host'"
op|']'
newline|'\n'
name|'port'
op|'='
name|'options'
op|'['
string|"'port'"
op|']'
newline|'\n'
name|'vhk'
op|'='
name|'default'
op|'.'
name|'verifyHostKey'
newline|'\n'
name|'uao'
op|'='
name|'default'
op|'.'
name|'SSHUserAuthClient'
op|'('
name|'options'
op|'['
string|"'user'"
op|']'
op|','
name|'options'
op|','
name|'SSHConnection'
op|'('
op|')'
op|')'
newline|'\n'
name|'connect'
op|'.'
name|'connect'
op|'('
name|'host'
op|','
name|'port'
op|','
name|'options'
op|','
name|'vhk'
op|','
name|'uao'
op|')'
op|'.'
name|'addErrback'
op|'('
name|'_ebExit'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_ebExit
dedent|''
name|'def'
name|'_ebExit'
op|'('
name|'f'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'global'
name|'exitStatus'
newline|'\n'
name|'if'
name|'hasattr'
op|'('
name|'f'
op|'.'
name|'value'
op|','
string|"'value'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'s'
op|'='
name|'f'
op|'.'
name|'value'
op|'.'
name|'value'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'s'
op|'='
name|'str'
op|'('
name|'f'
op|')'
newline|'\n'
dedent|''
name|'exitStatus'
op|'='
string|'"conch: exiting with error %s"'
op|'%'
name|'f'
newline|'\n'
name|'reactor'
op|'.'
name|'callLater'
op|'('
number|'0.1'
op|','
name|'_stopReactor'
op|')'
newline|'\n'
nl|'\n'
DECL|function|onConnect
dedent|''
name|'def'
name|'onConnect'
op|'('
op|')'
op|':'
newline|'\n'
comment|"#    if keyAgent and options['agent']:"
nl|'\n'
comment|'#        cc = protocol.ClientCreator(reactor, SSHAgentForwardingLocal, conn)'
nl|'\n'
comment|"#        cc.connectUNIX(os.environ['SSH_AUTH_SOCK'])"
nl|'\n'
indent|'    '
name|'if'
name|'hasattr'
op|'('
name|'conn'
op|'.'
name|'transport'
op|','
string|"'sendIgnore'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'_KeepAlive'
op|'('
name|'conn'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'options'
op|'.'
name|'localForwards'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'localPort'
op|','
name|'hostport'
name|'in'
name|'options'
op|'.'
name|'localForwards'
op|':'
newline|'\n'
indent|'            '
name|'s'
op|'='
name|'reactor'
op|'.'
name|'listenTCP'
op|'('
name|'localPort'
op|','
nl|'\n'
name|'forwarding'
op|'.'
name|'SSHListenForwardingFactory'
op|'('
name|'conn'
op|','
nl|'\n'
name|'hostport'
op|','
nl|'\n'
name|'SSHListenClientForwardingChannel'
op|')'
op|')'
newline|'\n'
name|'conn'
op|'.'
name|'localForwards'
op|'.'
name|'append'
op|'('
name|'s'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'options'
op|'.'
name|'remoteForwards'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'remotePort'
op|','
name|'hostport'
name|'in'
name|'options'
op|'.'
name|'remoteForwards'
op|':'
newline|'\n'
indent|'            '
name|'log'
op|'.'
name|'msg'
op|'('
string|"'asking for remote forwarding for %s:%s'"
op|'%'
nl|'\n'
op|'('
name|'remotePort'
op|','
name|'hostport'
op|')'
op|')'
newline|'\n'
name|'conn'
op|'.'
name|'requestRemoteForwarding'
op|'('
name|'remotePort'
op|','
name|'hostport'
op|')'
newline|'\n'
dedent|''
name|'reactor'
op|'.'
name|'addSystemEventTrigger'
op|'('
string|"'before'"
op|','
string|"'shutdown'"
op|','
name|'beforeShutdown'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'options'
op|'['
string|"'noshell'"
op|']'
name|'or'
name|'options'
op|'['
string|"'agent'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'conn'
op|'.'
name|'openChannel'
op|'('
name|'SSHSession'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'options'
op|'['
string|"'fork'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'os'
op|'.'
name|'fork'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'os'
op|'.'
name|'_exit'
op|'('
number|'0'
op|')'
newline|'\n'
dedent|''
name|'os'
op|'.'
name|'setsid'
op|'('
op|')'
newline|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
number|'3'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'os'
op|'.'
name|'close'
op|'('
name|'i'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'OSError'
op|','
name|'e'
op|':'
newline|'\n'
indent|'                '
name|'import'
name|'errno'
newline|'\n'
name|'if'
name|'e'
op|'.'
name|'errno'
op|'!='
name|'errno'
op|'.'
name|'EBADF'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
newline|'\n'
nl|'\n'
DECL|function|reConnect
dedent|''
dedent|''
dedent|''
dedent|''
dedent|''
name|'def'
name|'reConnect'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'beforeShutdown'
op|'('
op|')'
newline|'\n'
name|'conn'
op|'.'
name|'transport'
op|'.'
name|'transport'
op|'.'
name|'loseConnection'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|beforeShutdown
dedent|''
name|'def'
name|'beforeShutdown'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'remoteForwards'
op|'='
name|'options'
op|'.'
name|'remoteForwards'
newline|'\n'
name|'for'
name|'remotePort'
op|','
name|'hostport'
name|'in'
name|'remoteForwards'
op|':'
newline|'\n'
indent|'        '
name|'log'
op|'.'
name|'msg'
op|'('
string|"'cancelling %s:%s'"
op|'%'
op|'('
name|'remotePort'
op|','
name|'hostport'
op|')'
op|')'
newline|'\n'
name|'conn'
op|'.'
name|'cancelRemoteForwarding'
op|'('
name|'remotePort'
op|')'
newline|'\n'
nl|'\n'
DECL|function|stopConnection
dedent|''
dedent|''
name|'def'
name|'stopConnection'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'not'
name|'options'
op|'['
string|"'reconnect'"
op|']'
op|':'
newline|'\n'
indent|'        '
name|'reactor'
op|'.'
name|'callLater'
op|'('
number|'0.1'
op|','
name|'_stopReactor'
op|')'
newline|'\n'
nl|'\n'
DECL|class|_KeepAlive
dedent|''
dedent|''
name|'class'
name|'_KeepAlive'
op|':'
newline|'\n'
nl|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'conn'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'conn'
op|'='
name|'conn'
newline|'\n'
name|'self'
op|'.'
name|'globalTimeout'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'lc'
op|'='
name|'task'
op|'.'
name|'LoopingCall'
op|'('
name|'self'
op|'.'
name|'sendGlobal'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'lc'
op|'.'
name|'start'
op|'('
number|'300'
op|')'
newline|'\n'
nl|'\n'
DECL|member|sendGlobal
dedent|''
name|'def'
name|'sendGlobal'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'d'
op|'='
name|'self'
op|'.'
name|'conn'
op|'.'
name|'sendGlobalRequest'
op|'('
string|'"conch-keep-alive@twistedmatrix.com"'
op|','
nl|'\n'
string|'""'
op|','
name|'wantReply'
op|'='
number|'1'
op|')'
newline|'\n'
name|'d'
op|'.'
name|'addBoth'
op|'('
name|'self'
op|'.'
name|'_cbGlobal'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'globalTimeout'
op|'='
name|'reactor'
op|'.'
name|'callLater'
op|'('
number|'30'
op|','
name|'self'
op|'.'
name|'_ebGlobal'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_cbGlobal
dedent|''
name|'def'
name|'_cbGlobal'
op|'('
name|'self'
op|','
name|'res'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'globalTimeout'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'globalTimeout'
op|'.'
name|'cancel'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'globalTimeout'
op|'='
name|'None'
newline|'\n'
nl|'\n'
DECL|member|_ebGlobal
dedent|''
dedent|''
name|'def'
name|'_ebGlobal'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'globalTimeout'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'globalTimeout'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'conn'
op|'.'
name|'transport'
op|'.'
name|'loseConnection'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|class|SSHConnection
dedent|''
dedent|''
dedent|''
name|'class'
name|'SSHConnection'
op|'('
name|'connection'
op|'.'
name|'SSHConnection'
op|')'
op|':'
newline|'\n'
DECL|member|serviceStarted
indent|'    '
name|'def'
name|'serviceStarted'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'global'
name|'conn'
newline|'\n'
name|'conn'
op|'='
name|'self'
newline|'\n'
name|'self'
op|'.'
name|'localForwards'
op|'='
op|'['
op|']'
newline|'\n'
name|'self'
op|'.'
name|'remoteForwards'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'if'
name|'not'
name|'isinstance'
op|'('
name|'self'
op|','
name|'connection'
op|'.'
name|'SSHConnection'
op|')'
op|':'
newline|'\n'
comment|'# make these fall through'
nl|'\n'
indent|'            '
name|'del'
name|'self'
op|'.'
name|'__class__'
op|'.'
name|'requestRemoteForwarding'
newline|'\n'
name|'del'
name|'self'
op|'.'
name|'__class__'
op|'.'
name|'cancelRemoteForwarding'
newline|'\n'
dedent|''
name|'onConnect'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|serviceStopped
dedent|''
name|'def'
name|'serviceStopped'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'lf'
op|'='
name|'self'
op|'.'
name|'localForwards'
newline|'\n'
name|'self'
op|'.'
name|'localForwards'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'s'
name|'in'
name|'lf'
op|':'
newline|'\n'
indent|'            '
name|'s'
op|'.'
name|'loseConnection'
op|'('
op|')'
newline|'\n'
dedent|''
name|'stopConnection'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|requestRemoteForwarding
dedent|''
name|'def'
name|'requestRemoteForwarding'
op|'('
name|'self'
op|','
name|'remotePort'
op|','
name|'hostport'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'data'
op|'='
name|'forwarding'
op|'.'
name|'packGlobal_tcpip_forward'
op|'('
op|'('
string|"'0.0.0.0'"
op|','
name|'remotePort'
op|')'
op|')'
newline|'\n'
name|'d'
op|'='
name|'self'
op|'.'
name|'sendGlobalRequest'
op|'('
string|"'tcpip-forward'"
op|','
name|'data'
op|','
nl|'\n'
name|'wantReply'
op|'='
number|'1'
op|')'
newline|'\n'
name|'log'
op|'.'
name|'msg'
op|'('
string|"'requesting remote forwarding %s:%s'"
op|'%'
op|'('
name|'remotePort'
op|','
name|'hostport'
op|')'
op|')'
newline|'\n'
name|'d'
op|'.'
name|'addCallback'
op|'('
name|'self'
op|'.'
name|'_cbRemoteForwarding'
op|','
name|'remotePort'
op|','
name|'hostport'
op|')'
newline|'\n'
name|'d'
op|'.'
name|'addErrback'
op|'('
name|'self'
op|'.'
name|'_ebRemoteForwarding'
op|','
name|'remotePort'
op|','
name|'hostport'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_cbRemoteForwarding
dedent|''
name|'def'
name|'_cbRemoteForwarding'
op|'('
name|'self'
op|','
name|'result'
op|','
name|'remotePort'
op|','
name|'hostport'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'log'
op|'.'
name|'msg'
op|'('
string|"'accepted remote forwarding %s:%s'"
op|'%'
op|'('
name|'remotePort'
op|','
name|'hostport'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'remoteForwards'
op|'['
name|'remotePort'
op|']'
op|'='
name|'hostport'
newline|'\n'
name|'log'
op|'.'
name|'msg'
op|'('
name|'repr'
op|'('
name|'self'
op|'.'
name|'remoteForwards'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_ebRemoteForwarding
dedent|''
name|'def'
name|'_ebRemoteForwarding'
op|'('
name|'self'
op|','
name|'f'
op|','
name|'remotePort'
op|','
name|'hostport'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'log'
op|'.'
name|'msg'
op|'('
string|"'remote forwarding %s:%s failed'"
op|'%'
op|'('
name|'remotePort'
op|','
name|'hostport'
op|')'
op|')'
newline|'\n'
name|'log'
op|'.'
name|'msg'
op|'('
name|'f'
op|')'
newline|'\n'
nl|'\n'
DECL|member|cancelRemoteForwarding
dedent|''
name|'def'
name|'cancelRemoteForwarding'
op|'('
name|'self'
op|','
name|'remotePort'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'data'
op|'='
name|'forwarding'
op|'.'
name|'packGlobal_tcpip_forward'
op|'('
op|'('
string|"'0.0.0.0'"
op|','
name|'remotePort'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'sendGlobalRequest'
op|'('
string|"'cancel-tcpip-forward'"
op|','
name|'data'
op|')'
newline|'\n'
name|'log'
op|'.'
name|'msg'
op|'('
string|"'cancelling remote forwarding %s'"
op|'%'
name|'remotePort'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'del'
name|'self'
op|'.'
name|'remoteForwards'
op|'['
name|'remotePort'
op|']'
newline|'\n'
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
name|'log'
op|'.'
name|'msg'
op|'('
name|'repr'
op|'('
name|'self'
op|'.'
name|'remoteForwards'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|channel_forwarded_tcpip
dedent|''
name|'def'
name|'channel_forwarded_tcpip'
op|'('
name|'self'
op|','
name|'windowSize'
op|','
name|'maxPacket'
op|','
name|'data'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'log'
op|'.'
name|'msg'
op|'('
string|"'%s %s'"
op|'%'
op|'('
string|"'FTCP'"
op|','
name|'repr'
op|'('
name|'data'
op|')'
op|')'
op|')'
newline|'\n'
name|'remoteHP'
op|','
name|'origHP'
op|'='
name|'forwarding'
op|'.'
name|'unpackOpen_forwarded_tcpip'
op|'('
name|'data'
op|')'
newline|'\n'
name|'log'
op|'.'
name|'msg'
op|'('
name|'self'
op|'.'
name|'remoteForwards'
op|')'
newline|'\n'
name|'log'
op|'.'
name|'msg'
op|'('
name|'remoteHP'
op|')'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'remoteForwards'
op|'.'
name|'has_key'
op|'('
name|'remoteHP'
op|'['
number|'1'
op|']'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'connectHP'
op|'='
name|'self'
op|'.'
name|'remoteForwards'
op|'['
name|'remoteHP'
op|'['
number|'1'
op|']'
op|']'
newline|'\n'
name|'log'
op|'.'
name|'msg'
op|'('
string|"'connect forwarding %s'"
op|'%'
op|'('
name|'connectHP'
op|','
op|')'
op|')'
newline|'\n'
name|'return'
name|'SSHConnectForwardingChannel'
op|'('
name|'connectHP'
op|','
nl|'\n'
name|'remoteWindow'
op|'='
name|'windowSize'
op|','
nl|'\n'
name|'remoteMaxPacket'
op|'='
name|'maxPacket'
op|','
nl|'\n'
name|'conn'
op|'='
name|'self'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'ConchError'
op|'('
name|'connection'
op|'.'
name|'OPEN_CONNECT_FAILED'
op|','
string|'"don\'t know about that port"'
op|')'
newline|'\n'
nl|'\n'
comment|'#    def channel_auth_agent_openssh_com(self, windowSize, maxPacket, data):'
nl|'\n'
comment|"#        if options['agent'] and keyAgent:"
nl|'\n'
comment|'#            return agent.SSHAgentForwardingChannel(remoteWindow = windowSize,'
nl|'\n'
comment|'#                                             remoteMaxPacket = maxPacket,'
nl|'\n'
comment|'#                                             conn = self)'
nl|'\n'
comment|'#        else:'
nl|'\n'
comment|'#            return connection.OPEN_CONNECT_FAILED, "don\'t have an agent"'
nl|'\n'
nl|'\n'
DECL|member|channelClosed
dedent|''
dedent|''
name|'def'
name|'channelClosed'
op|'('
name|'self'
op|','
name|'channel'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'log'
op|'.'
name|'msg'
op|'('
string|"'connection closing %s'"
op|'%'
name|'channel'
op|')'
newline|'\n'
name|'log'
op|'.'
name|'msg'
op|'('
name|'self'
op|'.'
name|'channels'
op|')'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'self'
op|'.'
name|'channels'
op|')'
op|'=='
number|'1'
op|':'
comment|'# just us left'
newline|'\n'
indent|'            '
name|'log'
op|'.'
name|'msg'
op|'('
string|"'stopping connection'"
op|')'
newline|'\n'
name|'stopConnection'
op|'('
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
comment|'# because of the unix thing'
nl|'\n'
indent|'            '
name|'self'
op|'.'
name|'__class__'
op|'.'
name|'__bases__'
op|'['
number|'0'
op|']'
op|'.'
name|'channelClosed'
op|'('
name|'self'
op|','
name|'channel'
op|')'
newline|'\n'
nl|'\n'
DECL|class|SSHSession
dedent|''
dedent|''
dedent|''
name|'class'
name|'SSHSession'
op|'('
name|'channel'
op|'.'
name|'SSHChannel'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|variable|name
indent|'    '
name|'name'
op|'='
string|"'session'"
newline|'\n'
nl|'\n'
DECL|member|channelOpen
name|'def'
name|'channelOpen'
op|'('
name|'self'
op|','
name|'foo'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'log'
op|'.'
name|'msg'
op|'('
string|"'session %s open'"
op|'%'
name|'self'
op|'.'
name|'id'
op|')'
newline|'\n'
name|'if'
name|'options'
op|'['
string|"'agent'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'d'
op|'='
name|'self'
op|'.'
name|'conn'
op|'.'
name|'sendRequest'
op|'('
name|'self'
op|','
string|"'auth-agent-req@openssh.com'"
op|','
string|"''"
op|','
name|'wantReply'
op|'='
number|'1'
op|')'
newline|'\n'
name|'d'
op|'.'
name|'addBoth'
op|'('
name|'lambda'
name|'x'
op|':'
name|'log'
op|'.'
name|'msg'
op|'('
name|'x'
op|')'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'options'
op|'['
string|"'noshell'"
op|']'
op|':'
name|'return'
newline|'\n'
name|'if'
op|'('
name|'options'
op|'['
string|"'command'"
op|']'
name|'and'
name|'options'
op|'['
string|"'tty'"
op|']'
op|')'
name|'or'
name|'not'
name|'options'
op|'['
string|"'notty'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'_enterRawMode'
op|'('
op|')'
newline|'\n'
dedent|''
name|'c'
op|'='
name|'session'
op|'.'
name|'SSHSessionClient'
op|'('
op|')'
newline|'\n'
name|'if'
name|'options'
op|'['
string|"'escape'"
op|']'
name|'and'
name|'not'
name|'options'
op|'['
string|"'notty'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'escapeMode'
op|'='
number|'1'
newline|'\n'
name|'c'
op|'.'
name|'dataReceived'
op|'='
name|'self'
op|'.'
name|'handleInput'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'c'
op|'.'
name|'dataReceived'
op|'='
name|'self'
op|'.'
name|'write'
newline|'\n'
dedent|''
name|'c'
op|'.'
name|'connectionLost'
op|'='
name|'lambda'
name|'x'
op|'='
name|'None'
op|','
name|'s'
op|'='
name|'self'
op|':'
name|'s'
op|'.'
name|'sendEOF'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stdio'
op|'='
name|'stdio'
op|'.'
name|'StandardIO'
op|'('
name|'c'
op|')'
newline|'\n'
name|'fd'
op|'='
number|'0'
newline|'\n'
name|'if'
name|'options'
op|'['
string|"'subsystem'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'conn'
op|'.'
name|'sendRequest'
op|'('
name|'self'
op|','
string|"'subsystem'"
op|','
name|'common'
op|'.'
name|'NS'
op|'('
name|'options'
op|'['
string|"'command'"
op|']'
op|')'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'options'
op|'['
string|"'command'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'options'
op|'['
string|"'tty'"
op|']'
op|':'
newline|'\n'
indent|'                '
name|'term'
op|'='
name|'os'
op|'.'
name|'environ'
op|'['
string|"'TERM'"
op|']'
newline|'\n'
name|'winsz'
op|'='
name|'fcntl'
op|'.'
name|'ioctl'
op|'('
name|'fd'
op|','
name|'tty'
op|'.'
name|'TIOCGWINSZ'
op|','
string|"'12345678'"
op|')'
newline|'\n'
name|'winSize'
op|'='
name|'struct'
op|'.'
name|'unpack'
op|'('
string|"'4H'"
op|','
name|'winsz'
op|')'
newline|'\n'
name|'ptyReqData'
op|'='
name|'session'
op|'.'
name|'packRequest_pty_req'
op|'('
name|'term'
op|','
name|'winSize'
op|','
string|"''"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'conn'
op|'.'
name|'sendRequest'
op|'('
name|'self'
op|','
string|"'pty-req'"
op|','
name|'ptyReqData'
op|')'
newline|'\n'
name|'signal'
op|'.'
name|'signal'
op|'('
name|'signal'
op|'.'
name|'SIGWINCH'
op|','
name|'self'
op|'.'
name|'_windowResized'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'conn'
op|'.'
name|'sendRequest'
op|'('
name|'self'
op|','
string|"'exec'"
op|','
name|'common'
op|'.'
name|'NS'
op|'('
name|'options'
op|'['
string|"'command'"
op|']'
op|')'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'options'
op|'['
string|"'notty'"
op|']'
op|':'
newline|'\n'
indent|'                '
name|'term'
op|'='
name|'os'
op|'.'
name|'environ'
op|'['
string|"'TERM'"
op|']'
newline|'\n'
name|'winsz'
op|'='
name|'fcntl'
op|'.'
name|'ioctl'
op|'('
name|'fd'
op|','
name|'tty'
op|'.'
name|'TIOCGWINSZ'
op|','
string|"'12345678'"
op|')'
newline|'\n'
name|'winSize'
op|'='
name|'struct'
op|'.'
name|'unpack'
op|'('
string|"'4H'"
op|','
name|'winsz'
op|')'
newline|'\n'
name|'ptyReqData'
op|'='
name|'session'
op|'.'
name|'packRequest_pty_req'
op|'('
name|'term'
op|','
name|'winSize'
op|','
string|"''"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'conn'
op|'.'
name|'sendRequest'
op|'('
name|'self'
op|','
string|"'pty-req'"
op|','
name|'ptyReqData'
op|')'
newline|'\n'
name|'signal'
op|'.'
name|'signal'
op|'('
name|'signal'
op|'.'
name|'SIGWINCH'
op|','
name|'self'
op|'.'
name|'_windowResized'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'conn'
op|'.'
name|'sendRequest'
op|'('
name|'self'
op|','
string|"'shell'"
op|','
string|"''"
op|')'
newline|'\n'
comment|"#if hasattr(conn.transport, 'transport'):"
nl|'\n'
comment|'#    conn.transport.transport.setTcpNoDelay(1)'
nl|'\n'
nl|'\n'
DECL|member|handleInput
dedent|''
dedent|''
name|'def'
name|'handleInput'
op|'('
name|'self'
op|','
name|'char'
op|')'
op|':'
newline|'\n'
comment|"#log.msg('handling %s' % repr(char))"
nl|'\n'
indent|'        '
name|'if'
name|'char'
name|'in'
op|'('
string|"'\\n'"
op|','
string|"'\\r'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'escapeMode'
op|'='
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'write'
op|'('
name|'char'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'self'
op|'.'
name|'escapeMode'
op|'=='
number|'1'
name|'and'
name|'char'
op|'=='
name|'options'
op|'['
string|"'escape'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'escapeMode'
op|'='
number|'2'
newline|'\n'
dedent|''
name|'elif'
name|'self'
op|'.'
name|'escapeMode'
op|'=='
number|'2'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'escapeMode'
op|'='
number|'1'
comment|'# so we can chain escapes together'
newline|'\n'
name|'if'
name|'char'
op|'=='
string|"'.'"
op|':'
comment|'# disconnect'
newline|'\n'
indent|'                '
name|'log'
op|'.'
name|'msg'
op|'('
string|"'disconnecting from escape'"
op|')'
newline|'\n'
name|'stopConnection'
op|'('
op|')'
newline|'\n'
name|'return'
newline|'\n'
dedent|''
name|'elif'
name|'char'
op|'=='
string|"'\\x1a'"
op|':'
comment|'# ^Z, suspend'
newline|'\n'
DECL|function|_
indent|'                '
name|'def'
name|'_'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'_leaveRawMode'
op|'('
op|')'
newline|'\n'
name|'sys'
op|'.'
name|'stdout'
op|'.'
name|'flush'
op|'('
op|')'
newline|'\n'
name|'sys'
op|'.'
name|'stdin'
op|'.'
name|'flush'
op|'('
op|')'
newline|'\n'
name|'os'
op|'.'
name|'kill'
op|'('
name|'os'
op|'.'
name|'getpid'
op|'('
op|')'
op|','
name|'signal'
op|'.'
name|'SIGTSTP'
op|')'
newline|'\n'
name|'_enterRawMode'
op|'('
op|')'
newline|'\n'
dedent|''
name|'reactor'
op|'.'
name|'callLater'
op|'('
number|'0'
op|','
name|'_'
op|')'
newline|'\n'
name|'return'
newline|'\n'
dedent|''
name|'elif'
name|'char'
op|'=='
string|"'R'"
op|':'
comment|'# rekey connection'
newline|'\n'
indent|'                '
name|'log'
op|'.'
name|'msg'
op|'('
string|"'rekeying connection'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'conn'
op|'.'
name|'transport'
op|'.'
name|'sendKexInit'
op|'('
op|')'
newline|'\n'
name|'return'
newline|'\n'
dedent|''
name|'elif'
name|'char'
op|'=='
string|"'#'"
op|':'
comment|'# display connections'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'stdio'
op|'.'
name|'write'
op|'('
string|"'\\r\\nThe following connections are open:\\r\\n'"
op|')'
newline|'\n'
name|'channels'
op|'='
name|'self'
op|'.'
name|'conn'
op|'.'
name|'channels'
op|'.'
name|'keys'
op|'('
op|')'
newline|'\n'
name|'channels'
op|'.'
name|'sort'
op|'('
op|')'
newline|'\n'
name|'for'
name|'channelId'
name|'in'
name|'channels'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'stdio'
op|'.'
name|'write'
op|'('
string|"'  #%i %s\\r\\n'"
op|'%'
op|'('
name|'channelId'
op|','
name|'str'
op|'('
name|'self'
op|'.'
name|'conn'
op|'.'
name|'channels'
op|'['
name|'channelId'
op|']'
op|')'
op|')'
op|')'
newline|'\n'
dedent|''
name|'return'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'write'
op|'('
string|"'~'"
op|'+'
name|'char'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'escapeMode'
op|'='
number|'0'
newline|'\n'
name|'self'
op|'.'
name|'write'
op|'('
name|'char'
op|')'
newline|'\n'
nl|'\n'
DECL|member|dataReceived
dedent|''
dedent|''
name|'def'
name|'dataReceived'
op|'('
name|'self'
op|','
name|'data'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'stdio'
op|'.'
name|'write'
op|'('
name|'data'
op|')'
newline|'\n'
nl|'\n'
DECL|member|extReceived
dedent|''
name|'def'
name|'extReceived'
op|'('
name|'self'
op|','
name|'t'
op|','
name|'data'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'t'
op|'=='
name|'connection'
op|'.'
name|'EXTENDED_DATA_STDERR'
op|':'
newline|'\n'
indent|'            '
name|'log'
op|'.'
name|'msg'
op|'('
string|"'got %s stderr data'"
op|'%'
name|'len'
op|'('
name|'data'
op|')'
op|')'
newline|'\n'
name|'sys'
op|'.'
name|'stderr'
op|'.'
name|'write'
op|'('
name|'data'
op|')'
newline|'\n'
nl|'\n'
DECL|member|eofReceived
dedent|''
dedent|''
name|'def'
name|'eofReceived'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'log'
op|'.'
name|'msg'
op|'('
string|"'got eof'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stdio'
op|'.'
name|'loseWriteConnection'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|closeReceived
dedent|''
name|'def'
name|'closeReceived'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'log'
op|'.'
name|'msg'
op|'('
string|"'remote side closed %s'"
op|'%'
name|'self'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'conn'
op|'.'
name|'sendClose'
op|'('
name|'self'
op|')'
newline|'\n'
nl|'\n'
DECL|member|closed
dedent|''
name|'def'
name|'closed'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'global'
name|'old'
newline|'\n'
name|'log'
op|'.'
name|'msg'
op|'('
string|"'closed %s'"
op|'%'
name|'self'
op|')'
newline|'\n'
name|'log'
op|'.'
name|'msg'
op|'('
name|'repr'
op|'('
name|'self'
op|'.'
name|'conn'
op|'.'
name|'channels'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|request_exit_status
dedent|''
name|'def'
name|'request_exit_status'
op|'('
name|'self'
op|','
name|'data'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'global'
name|'exitStatus'
newline|'\n'
name|'exitStatus'
op|'='
name|'int'
op|'('
name|'struct'
op|'.'
name|'unpack'
op|'('
string|"'>L'"
op|','
name|'data'
op|')'
op|'['
number|'0'
op|']'
op|')'
newline|'\n'
name|'log'
op|'.'
name|'msg'
op|'('
string|"'exit status: %s'"
op|'%'
name|'exitStatus'
op|')'
newline|'\n'
nl|'\n'
DECL|member|sendEOF
dedent|''
name|'def'
name|'sendEOF'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'conn'
op|'.'
name|'sendEOF'
op|'('
name|'self'
op|')'
newline|'\n'
nl|'\n'
DECL|member|stopWriting
dedent|''
name|'def'
name|'stopWriting'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'stdio'
op|'.'
name|'pauseProducing'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|startWriting
dedent|''
name|'def'
name|'startWriting'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'stdio'
op|'.'
name|'resumeProducing'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|_windowResized
dedent|''
name|'def'
name|'_windowResized'
op|'('
name|'self'
op|','
op|'*'
name|'args'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'winsz'
op|'='
name|'fcntl'
op|'.'
name|'ioctl'
op|'('
number|'0'
op|','
name|'tty'
op|'.'
name|'TIOCGWINSZ'
op|','
string|"'12345678'"
op|')'
newline|'\n'
name|'winSize'
op|'='
name|'struct'
op|'.'
name|'unpack'
op|'('
string|"'4H'"
op|','
name|'winsz'
op|')'
newline|'\n'
name|'newSize'
op|'='
name|'winSize'
op|'['
number|'1'
op|']'
op|','
name|'winSize'
op|'['
number|'0'
op|']'
op|','
name|'winSize'
op|'['
number|'2'
op|']'
op|','
name|'winSize'
op|'['
number|'3'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'conn'
op|'.'
name|'sendRequest'
op|'('
name|'self'
op|','
string|"'window-change'"
op|','
name|'struct'
op|'.'
name|'pack'
op|'('
string|"'!4L'"
op|','
op|'*'
name|'newSize'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|SSHListenClientForwardingChannel
dedent|''
dedent|''
name|'class'
name|'SSHListenClientForwardingChannel'
op|'('
name|'forwarding'
op|'.'
name|'SSHListenClientForwardingChannel'
op|')'
op|':'
name|'pass'
newline|'\n'
DECL|class|SSHConnectForwardingChannel
name|'class'
name|'SSHConnectForwardingChannel'
op|'('
name|'forwarding'
op|'.'
name|'SSHConnectForwardingChannel'
op|')'
op|':'
name|'pass'
newline|'\n'
nl|'\n'
DECL|function|_leaveRawMode
name|'def'
name|'_leaveRawMode'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'global'
name|'_inRawMode'
newline|'\n'
name|'if'
name|'not'
name|'_inRawMode'
op|':'
newline|'\n'
indent|'        '
name|'return'
newline|'\n'
dedent|''
name|'fd'
op|'='
name|'sys'
op|'.'
name|'stdin'
op|'.'
name|'fileno'
op|'('
op|')'
newline|'\n'
name|'tty'
op|'.'
name|'tcsetattr'
op|'('
name|'fd'
op|','
name|'tty'
op|'.'
name|'TCSANOW'
op|','
name|'_savedMode'
op|')'
newline|'\n'
name|'_inRawMode'
op|'='
number|'0'
newline|'\n'
nl|'\n'
DECL|function|_enterRawMode
dedent|''
name|'def'
name|'_enterRawMode'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'global'
name|'_inRawMode'
op|','
name|'_savedMode'
newline|'\n'
name|'if'
name|'_inRawMode'
op|':'
newline|'\n'
indent|'        '
name|'return'
newline|'\n'
dedent|''
name|'fd'
op|'='
name|'sys'
op|'.'
name|'stdin'
op|'.'
name|'fileno'
op|'('
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'old'
op|'='
name|'tty'
op|'.'
name|'tcgetattr'
op|'('
name|'fd'
op|')'
newline|'\n'
name|'new'
op|'='
name|'old'
op|'['
op|':'
op|']'
newline|'\n'
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'        '
name|'log'
op|'.'
name|'msg'
op|'('
string|"'not a typewriter!'"
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
comment|'# iflage'
nl|'\n'
indent|'        '
name|'new'
op|'['
number|'0'
op|']'
op|'='
name|'new'
op|'['
number|'0'
op|']'
op|'|'
name|'tty'
op|'.'
name|'IGNPAR'
newline|'\n'
name|'new'
op|'['
number|'0'
op|']'
op|'='
name|'new'
op|'['
number|'0'
op|']'
op|'&'
op|'~'
op|'('
name|'tty'
op|'.'
name|'ISTRIP'
op|'|'
name|'tty'
op|'.'
name|'INLCR'
op|'|'
name|'tty'
op|'.'
name|'IGNCR'
op|'|'
name|'tty'
op|'.'
name|'ICRNL'
op|'|'
nl|'\n'
name|'tty'
op|'.'
name|'IXON'
op|'|'
name|'tty'
op|'.'
name|'IXANY'
op|'|'
name|'tty'
op|'.'
name|'IXOFF'
op|')'
newline|'\n'
name|'if'
name|'hasattr'
op|'('
name|'tty'
op|','
string|"'IUCLC'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'new'
op|'['
number|'0'
op|']'
op|'='
name|'new'
op|'['
number|'0'
op|']'
op|'&'
op|'~'
name|'tty'
op|'.'
name|'IUCLC'
newline|'\n'
nl|'\n'
comment|'# lflag'
nl|'\n'
dedent|''
name|'new'
op|'['
number|'3'
op|']'
op|'='
name|'new'
op|'['
number|'3'
op|']'
op|'&'
op|'~'
op|'('
name|'tty'
op|'.'
name|'ISIG'
op|'|'
name|'tty'
op|'.'
name|'ICANON'
op|'|'
name|'tty'
op|'.'
name|'ECHO'
op|'|'
name|'tty'
op|'.'
name|'ECHO'
op|'|'
nl|'\n'
name|'tty'
op|'.'
name|'ECHOE'
op|'|'
name|'tty'
op|'.'
name|'ECHOK'
op|'|'
name|'tty'
op|'.'
name|'ECHONL'
op|')'
newline|'\n'
name|'if'
name|'hasattr'
op|'('
name|'tty'
op|','
string|"'IEXTEN'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'new'
op|'['
number|'3'
op|']'
op|'='
name|'new'
op|'['
number|'3'
op|']'
op|'&'
op|'~'
name|'tty'
op|'.'
name|'IEXTEN'
newline|'\n'
nl|'\n'
comment|'#oflag'
nl|'\n'
dedent|''
name|'new'
op|'['
number|'1'
op|']'
op|'='
name|'new'
op|'['
number|'1'
op|']'
op|'&'
op|'~'
name|'tty'
op|'.'
name|'OPOST'
newline|'\n'
nl|'\n'
name|'new'
op|'['
number|'6'
op|']'
op|'['
name|'tty'
op|'.'
name|'VMIN'
op|']'
op|'='
number|'1'
newline|'\n'
name|'new'
op|'['
number|'6'
op|']'
op|'['
name|'tty'
op|'.'
name|'VTIME'
op|']'
op|'='
number|'0'
newline|'\n'
nl|'\n'
name|'_savedMode'
op|'='
name|'old'
newline|'\n'
name|'tty'
op|'.'
name|'tcsetattr'
op|'('
name|'fd'
op|','
name|'tty'
op|'.'
name|'TCSANOW'
op|','
name|'new'
op|')'
newline|'\n'
comment|'#tty.setraw(fd)'
nl|'\n'
name|'_inRawMode'
op|'='
number|'1'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'__name__'
op|'=='
string|"'__main__'"
op|':'
newline|'\n'
indent|'    '
name|'run'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
endmarker|''
end_unit
