begin_unit
begin_comment
comment|/*  * Copyright (c) 2001-2004 Twisted Matrix Laboratories.  * See LICENSE for details.   *  */
end_comment
begin_comment
comment|/* _c_urlarg.c */
end_comment
begin_ifdef
ifdef|#
directive|ifdef
name|__cplusplus
end_ifdef
begin_extern
extern|extern
literal|"C"
block|{
endif|#
directive|endif
include|#
directive|include
file|<Python.h>
ifdef|#
directive|ifdef
name|__cplusplus
block|}
end_extern
begin_endif
endif|#
directive|endif
end_endif
begin_ifdef
ifdef|#
directive|ifdef
name|__GNUC__
end_ifdef
begin_define
DECL|macro|TM_INLINE
define|#
directive|define
name|TM_INLINE
value|inline
end_define
begin_else
else|#
directive|else
end_else
begin_define
DECL|macro|TM_INLINE
define|#
directive|define
name|TM_INLINE
end_define
begin_comment
DECL|macro|TM_INLINE
comment|/* */
end_comment
begin_endif
endif|#
directive|endif
end_endif
begin_decl_stmt
DECL|variable|UrlargError
specifier|static
name|PyObject
modifier|*
name|UrlargError
decl_stmt|;
end_decl_stmt
begin_define
DECL|macro|OUTPUTCHAR
define|#
directive|define
name|OUTPUTCHAR
parameter_list|(
name|c
parameter_list|,
name|n
parameter_list|)
value|do{memcpy(output, c, n);output+=n;}while(0)
end_define
begin_define
DECL|macro|STATE_INITIAL
define|#
directive|define
name|STATE_INITIAL
value|0
end_define
begin_define
DECL|macro|STATE_PERCENT
define|#
directive|define
name|STATE_PERCENT
value|1
end_define
begin_define
DECL|macro|STATE_HEXDIGIT
define|#
directive|define
name|STATE_HEXDIGIT
value|2
end_define
begin_define
DECL|macro|NOT_HEXDIGIT
define|#
directive|define
name|NOT_HEXDIGIT
value|255
end_define
begin_decl_stmt
DECL|variable|hexdigits
name|unsigned
name|char
name|hexdigits
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt
begin_function
DECL|function|ishexdigit
name|TM_INLINE
name|int
name|ishexdigit
parameter_list|(
name|unsigned
name|char
name|c
parameter_list|)
block|{
return|return
name|hexdigits
index|[
name|c
index|]
return|;
block|}
end_function
begin_function
DECL|function|unquote
specifier|static
name|PyObject
modifier|*
name|unquote
parameter_list|(
name|PyObject
modifier|*
name|self
parameter_list|,
name|PyObject
modifier|*
name|args
parameter_list|,
name|PyObject
modifier|*
name|kwargs
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|r
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|output_start
decl_stmt|,
modifier|*
name|output
decl_stmt|;
name|unsigned
name|char
name|quotedchar
decl_stmt|,
name|quotedchartmp
init|=
literal|0
decl_stmt|,
name|tmp
decl_stmt|;
name|unsigned
name|char
name|escchar
init|=
literal|'%'
decl_stmt|;
comment|/* the character we use to begin %AB sequences */
specifier|static
name|char
modifier|*
name|kwlist
index|[]
init|=
block|{
literal|"s"
block|,
literal|"escchar"
block|,
name|NULL
block|}
decl_stmt|;
name|int
name|state
init|=
name|STATE_INITIAL
decl_stmt|,
name|length
decl_stmt|;
name|PyObject
modifier|*
name|str
decl_stmt|;
if|if
condition|(
operator|!
name|PyArg_ParseTupleAndKeywords
argument_list|(
name|args
argument_list|,
name|kwargs
argument_list|,
literal|"s#|c:unquote"
argument_list|,
name|kwlist
argument_list|,
operator|&
name|s
argument_list|,
operator|&
name|length
argument_list|,
operator|&
name|escchar
argument_list|)
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|length
operator|==
literal|0
condition|)
block|{
return|return
name|PyString_FromStringAndSize
argument_list|(
literal|""
argument_list|,
literal|0
argument_list|)
return|;
block|}
comment|/* Allocating an output buffer of length will be sufficient,        as the output can only be smaller. We resize the output in the end. */
name|str
operator|=
name|PyString_FromStringAndSize
argument_list|(
name|NULL
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|output
operator|=
name|output_start
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|PyString_AsString
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|end
operator|=
name|s
operator|+
name|length
expr_stmt|;
name|s
operator|=
name|s
operator|-
literal|1
expr_stmt|;
while|while
condition|(
operator|(
operator|++
name|s
operator|)
operator|<
name|end
condition|)
block|{
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|STATE_INITIAL
case|:
if|if
condition|(
operator|*
name|s
operator|==
name|escchar
condition|)
block|{
name|state
operator|=
name|STATE_PERCENT
expr_stmt|;
block|}
else|else
block|{
name|r
operator|=
name|s
operator|-
literal|1
expr_stmt|;
while|while
condition|(
operator|*
operator|(
operator|++
name|r
operator|)
operator|!=
name|escchar
operator|&&
name|r
operator|<
name|end
condition|)
empty_stmt|;
name|OUTPUTCHAR
argument_list|(
name|s
argument_list|,
name|r
operator|-
name|s
argument_list|)
expr_stmt|;
name|s
operator|=
name|r
operator|-
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|STATE_PERCENT
case|:
if|if
condition|(
operator|(
name|quotedchartmp
operator|=
name|ishexdigit
argument_list|(
operator|*
name|s
argument_list|)
operator|)
operator|!=
name|NOT_HEXDIGIT
condition|)
block|{
name|tmp
operator|=
operator|*
name|s
expr_stmt|;
name|state
operator|=
name|STATE_HEXDIGIT
expr_stmt|;
block|}
else|else
block|{
name|state
operator|=
name|STATE_INITIAL
expr_stmt|;
name|OUTPUTCHAR
argument_list|(
operator|&
name|escchar
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|s
operator|--
expr_stmt|;
block|}
break|break;
case|case
name|STATE_HEXDIGIT
case|:
name|state
operator|=
name|STATE_INITIAL
expr_stmt|;
if|if
condition|(
operator|(
name|quotedchar
operator|=
name|ishexdigit
argument_list|(
operator|*
name|s
argument_list|)
operator|)
operator|!=
name|NOT_HEXDIGIT
condition|)
block|{
name|quotedchar
operator||=
operator|(
name|quotedchartmp
operator|<<
literal|4
operator|)
expr_stmt|;
name|OUTPUTCHAR
argument_list|(
operator|&
name|quotedchar
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OUTPUTCHAR
argument_list|(
operator|&
name|escchar
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|s
operator|-=
literal|2
expr_stmt|;
block|}
break|break;
block|}
block|}
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|STATE_PERCENT
case|:
name|OUTPUTCHAR
argument_list|(
operator|&
name|escchar
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|STATE_HEXDIGIT
case|:
name|OUTPUTCHAR
argument_list|(
operator|&
name|escchar
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OUTPUTCHAR
argument_list|(
operator|&
name|tmp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
name|_PyString_Resize
argument_list|(
operator|&
name|str
argument_list|,
name|output
operator|-
name|output_start
argument_list|)
expr_stmt|;
return|return
name|str
return|;
block|}
end_function
begin_decl_stmt
DECL|variable|_c_urlarg_methods
specifier|static
name|PyMethodDef
name|_c_urlarg_methods
index|[]
init|=
block|{
block|{
literal|"unquote"
block|,
operator|(
name|PyCFunction
operator|)
name|unquote
block|,
name|METH_VARARGS
operator||
name|METH_KEYWORDS
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
comment|/* sentinel */
block|}
decl_stmt|;
end_decl_stmt
begin_macro
DECL|function|init_c_urlarg
name|DL_EXPORT
argument_list|(
argument|void
argument_list|)
end_macro
begin_macro
DECL|function|init_c_urlarg
name|init_c_urlarg
argument_list|(
argument|void
argument_list|)
end_macro
begin_block
block|{
name|PyObject
modifier|*
name|m
decl_stmt|;
name|PyObject
modifier|*
name|d
decl_stmt|;
name|unsigned
name|char
name|i
decl_stmt|;
name|m
operator|=
name|Py_InitModule
argument_list|(
literal|"_c_urlarg"
argument_list|,
name|_c_urlarg_methods
argument_list|)
expr_stmt|;
name|d
operator|=
name|PyModule_GetDict
argument_list|(
name|m
argument_list|)
expr_stmt|;
comment|/* add our base exception class */
name|UrlargError
operator|=
name|PyErr_NewException
argument_list|(
literal|"urlarg.UrlargError"
argument_list|,
name|PyExc_Exception
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|PyDict_SetItemString
argument_list|(
name|d
argument_list|,
literal|"UrlargError"
argument_list|,
name|UrlargError
argument_list|)
expr_stmt|;
comment|/* initialize hexdigits */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|255
condition|;
name|i
operator|++
control|)
block|{
name|hexdigits
index|[
name|i
index|]
operator|=
name|NOT_HEXDIGIT
expr_stmt|;
block|}
name|hexdigits
index|[
literal|255
index|]
operator|=
name|NOT_HEXDIGIT
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|'0'
init|;
name|i
operator|<=
literal|'9'
condition|;
name|i
operator|++
control|)
block|{
name|hexdigits
index|[
name|i
index|]
operator|=
name|i
operator|-
literal|'0'
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|'a'
init|;
name|i
operator|<=
literal|'f'
condition|;
name|i
operator|++
control|)
block|{
name|hexdigits
index|[
name|i
index|]
operator|=
literal|10
operator|+
operator|(
name|i
operator|-
literal|'a'
operator|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|'A'
init|;
name|i
operator|<=
literal|'F'
condition|;
name|i
operator|++
control|)
block|{
name|hexdigits
index|[
name|i
index|]
operator|=
literal|10
operator|+
operator|(
name|i
operator|-
literal|'A'
operator|)
expr_stmt|;
block|}
comment|/* Check for errors */
if|if
condition|(
name|PyErr_Occurred
argument_list|()
condition|)
block|{
name|PyErr_Print
argument_list|()
expr_stmt|;
name|Py_FatalError
argument_list|(
literal|"can't initialize module _c_urlarg"
argument_list|)
expr_stmt|;
block|}
block|}
end_block
end_unit
