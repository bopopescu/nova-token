begin_unit
comment|'# Copyright (c) 2001-2004 Twisted Matrix Laboratories.'
nl|'\n'
comment|'# See LICENSE for details.'
nl|'\n'
nl|'\n'
comment|'# '
nl|'\n'
nl|'\n'
string|'"""\nTwisted inetd.\n\nMaintainer: Andrew Bennetts\n\nFuture Plans: Bugfixes.  Specifically for UDP and Sun-RPC, which don\'t work\ncorrectly yet.\n"""'
newline|'\n'
nl|'\n'
name|'import'
name|'os'
newline|'\n'
nl|'\n'
name|'from'
name|'twisted'
op|'.'
name|'internet'
name|'import'
name|'process'
op|','
name|'reactor'
op|','
name|'fdesc'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'internet'
op|'.'
name|'protocol'
name|'import'
name|'Protocol'
op|','
name|'ServerFactory'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'protocols'
name|'import'
name|'wire'
newline|'\n'
nl|'\n'
comment|"# A dict of known 'internal' services (i.e. those that don't involve spawning"
nl|'\n'
comment|'# another process.'
nl|'\n'
DECL|variable|internalProtocols
name|'internalProtocols'
op|'='
op|'{'
nl|'\n'
string|"'echo'"
op|':'
name|'wire'
op|'.'
name|'Echo'
op|','
nl|'\n'
string|"'chargen'"
op|':'
name|'wire'
op|'.'
name|'Chargen'
op|','
nl|'\n'
string|"'discard'"
op|':'
name|'wire'
op|'.'
name|'Discard'
op|','
nl|'\n'
string|"'daytime'"
op|':'
name|'wire'
op|'.'
name|'Daytime'
op|','
nl|'\n'
string|"'time'"
op|':'
name|'wire'
op|'.'
name|'Time'
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|InetdProtocol
name|'class'
name|'InetdProtocol'
op|'('
name|'Protocol'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Forks a child process on connectionMade, passing the socket as fd 0."""'
newline|'\n'
DECL|member|connectionMade
name|'def'
name|'connectionMade'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'sockFD'
op|'='
name|'self'
op|'.'
name|'transport'
op|'.'
name|'fileno'
op|'('
op|')'
newline|'\n'
name|'childFDs'
op|'='
op|'{'
number|'0'
op|':'
name|'sockFD'
op|','
number|'1'
op|':'
name|'sockFD'
op|'}'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'factory'
op|'.'
name|'stderrFile'
op|':'
newline|'\n'
indent|'            '
name|'childFDs'
op|'['
number|'2'
op|']'
op|'='
name|'self'
op|'.'
name|'factory'
op|'.'
name|'stderrFile'
op|'.'
name|'fileno'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# processes run by inetd expect blocking sockets'
nl|'\n'
comment|'# FIXME: maybe this should be done in process.py?  are other uses of'
nl|'\n'
comment|'#        Process possibly affected by this?'
nl|'\n'
dedent|''
name|'fdesc'
op|'.'
name|'setBlocking'
op|'('
name|'sockFD'
op|')'
newline|'\n'
name|'if'
name|'childFDs'
op|'.'
name|'has_key'
op|'('
number|'2'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'fdesc'
op|'.'
name|'setBlocking'
op|'('
name|'childFDs'
op|'['
number|'2'
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'service'
op|'='
name|'self'
op|'.'
name|'factory'
op|'.'
name|'service'
newline|'\n'
name|'uid'
op|'='
name|'service'
op|'.'
name|'user'
newline|'\n'
name|'gid'
op|'='
name|'service'
op|'.'
name|'group'
newline|'\n'
nl|'\n'
comment|"# don't tell Process to change our UID/GID if it's what we"
nl|'\n'
comment|'# already are'
nl|'\n'
name|'if'
name|'uid'
op|'=='
name|'os'
op|'.'
name|'getuid'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'uid'
op|'='
name|'None'
newline|'\n'
dedent|''
name|'if'
name|'gid'
op|'=='
name|'os'
op|'.'
name|'getgid'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'gid'
op|'='
name|'None'
newline|'\n'
nl|'\n'
dedent|''
name|'process'
op|'.'
name|'Process'
op|'('
name|'None'
op|','
name|'service'
op|'.'
name|'program'
op|','
name|'service'
op|'.'
name|'programArgs'
op|','
name|'os'
op|'.'
name|'environ'
op|','
nl|'\n'
name|'None'
op|','
name|'None'
op|','
name|'uid'
op|','
name|'gid'
op|','
name|'childFDs'
op|')'
newline|'\n'
nl|'\n'
name|'reactor'
op|'.'
name|'removeReader'
op|'('
name|'self'
op|'.'
name|'transport'
op|')'
newline|'\n'
name|'reactor'
op|'.'
name|'removeWriter'
op|'('
name|'self'
op|'.'
name|'transport'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|InetdFactory
dedent|''
dedent|''
name|'class'
name|'InetdFactory'
op|'('
name|'ServerFactory'
op|')'
op|':'
newline|'\n'
DECL|variable|protocol
indent|'    '
name|'protocol'
op|'='
name|'InetdProtocol'
newline|'\n'
DECL|variable|stderrFile
name|'stderrFile'
op|'='
name|'None'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'service'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'service'
op|'='
name|'service'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
