begin_unit
comment|'# Copyright (c) 2001-2004 Twisted Matrix Laboratories.'
nl|'\n'
comment|'# See LICENSE for details.'
nl|'\n'
nl|'\n'
comment|'# '
nl|'\n'
nl|'\n'
string|'"""Journal using twisted.enterprise.row RDBMS support.\n\nYou\'re going to need the following table in your database::\n\n    | CREATE TABLE journalinfo\n    | (\n    |   commandIndex int\n    | );\n    | INSERT INTO journalinfo VALUES (0);\n\n"""'
newline|'\n'
nl|'\n'
name|'from'
name|'__future__'
name|'import'
name|'nested_scopes'
newline|'\n'
nl|'\n'
comment|'# twisted imports'
nl|'\n'
name|'from'
name|'twisted'
op|'.'
name|'internet'
name|'import'
name|'defer'
newline|'\n'
nl|'\n'
comment|'# sibling imports'
nl|'\n'
name|'import'
name|'base'
newline|'\n'
nl|'\n'
nl|'\n'
comment|'# constants for command list'
nl|'\n'
name|'INSERT'
op|','
name|'DELETE'
op|','
name|'UPDATE'
op|'='
name|'range'
op|'('
number|'3'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|RowJournal
name|'class'
name|'RowJournal'
op|'('
name|'base'
op|'.'
name|'Journal'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Journal that stores data \'snapshot\' in using twisted.enterprise.row.\n\n    Use this as the reflector instead of the original reflector.\n\n    It may block on creation, if it has to run recovery.\n    """'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'log'
op|','
name|'journaledService'
op|','
name|'reflector'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'reflector'
op|'='
name|'reflector'
newline|'\n'
name|'self'
op|'.'
name|'commands'
op|'='
op|'['
op|']'
newline|'\n'
name|'self'
op|'.'
name|'syncing'
op|'='
number|'0'
newline|'\n'
name|'base'
op|'.'
name|'Journal'
op|'.'
name|'__init__'
op|'('
name|'self'
op|','
name|'log'
op|','
name|'journaledService'
op|')'
newline|'\n'
nl|'\n'
DECL|member|updateRow
dedent|''
name|'def'
name|'updateRow'
op|'('
name|'self'
op|','
name|'obj'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Mark on object for updating when sync()ing."""'
newline|'\n'
name|'self'
op|'.'
name|'commands'
op|'.'
name|'append'
op|'('
op|'('
name|'UPDATE'
op|','
name|'obj'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|insertRow
dedent|''
name|'def'
name|'insertRow'
op|'('
name|'self'
op|','
name|'obj'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Mark on object for inserting when sync()ing."""'
newline|'\n'
name|'self'
op|'.'
name|'commands'
op|'.'
name|'append'
op|'('
op|'('
name|'INSERT'
op|','
name|'obj'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|deleteRow
dedent|''
name|'def'
name|'deleteRow'
op|'('
name|'self'
op|','
name|'obj'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Mark on object for deleting when sync()ing."""'
newline|'\n'
name|'self'
op|'.'
name|'commands'
op|'.'
name|'append'
op|'('
op|'('
name|'DELETE'
op|','
name|'obj'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|loadObjectsFrom
dedent|''
name|'def'
name|'loadObjectsFrom'
op|'('
name|'self'
op|','
name|'tableName'
op|','
name|'parentRow'
op|'='
name|'None'
op|','
name|'data'
op|'='
name|'None'
op|','
name|'whereClause'
op|'='
name|'None'
op|','
name|'forceChildren'
op|'='
number|'0'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Flush all objects to the database and then load objects."""'
newline|'\n'
name|'d'
op|'='
name|'self'
op|'.'
name|'sync'
op|'('
op|')'
newline|'\n'
name|'d'
op|'.'
name|'addCallback'
op|'('
name|'lambda'
name|'result'
op|':'
name|'self'
op|'.'
name|'reflector'
op|'.'
name|'loadObjectsFrom'
op|'('
nl|'\n'
name|'tableName'
op|','
name|'parentRow'
op|'='
name|'parentRow'
op|','
name|'data'
op|'='
name|'data'
op|','
name|'whereClause'
op|'='
name|'whereClause'
op|','
nl|'\n'
name|'forceChildren'
op|'='
name|'forceChildren'
op|')'
op|')'
newline|'\n'
name|'return'
name|'d'
newline|'\n'
nl|'\n'
DECL|member|sync
dedent|''
name|'def'
name|'sync'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Commit changes to database."""'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'syncing'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'ValueError'
op|','
string|'"sync already in progress"'
newline|'\n'
dedent|''
name|'comandMap'
op|'='
op|'{'
name|'INSERT'
op|':'
name|'self'
op|'.'
name|'reflector'
op|'.'
name|'insertRowSQL'
op|','
nl|'\n'
name|'UPDATE'
op|':'
name|'self'
op|'.'
name|'reflector'
op|'.'
name|'updateRowSQL'
op|','
nl|'\n'
name|'DELETE'
op|':'
name|'self'
op|'.'
name|'reflector'
op|'.'
name|'deleteRowSQL'
op|'}'
newline|'\n'
name|'sqlCommands'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'kind'
op|','
name|'obj'
name|'in'
name|'self'
op|'.'
name|'commands'
op|':'
newline|'\n'
indent|'            '
name|'sqlCommands'
op|'.'
name|'append'
op|'('
name|'comandMap'
op|'['
name|'kind'
op|']'
op|'('
name|'obj'
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'commands'
op|'='
op|'['
op|']'
newline|'\n'
name|'if'
name|'sqlCommands'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'syncing'
op|'='
number|'1'
newline|'\n'
name|'d'
op|'='
name|'self'
op|'.'
name|'reflector'
op|'.'
name|'dbpool'
op|'.'
name|'runInteraction'
op|'('
name|'self'
op|'.'
name|'_sync'
op|','
name|'self'
op|'.'
name|'latestIndex'
op|','
name|'sqlCommands'
op|')'
newline|'\n'
name|'d'
op|'.'
name|'addCallback'
op|'('
name|'self'
op|'.'
name|'_syncDone'
op|')'
newline|'\n'
name|'return'
name|'d'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'defer'
op|'.'
name|'succeed'
op|'('
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_sync
dedent|''
dedent|''
name|'def'
name|'_sync'
op|'('
name|'self'
op|','
name|'txn'
op|','
name|'index'
op|','
name|'commands'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Do the actual database synchronization."""'
newline|'\n'
name|'for'
name|'c'
name|'in'
name|'commands'
op|':'
newline|'\n'
indent|'            '
name|'txn'
op|'.'
name|'execute'
op|'('
name|'c'
op|')'
newline|'\n'
dedent|''
name|'txn'
op|'.'
name|'update'
op|'('
string|'"UPDATE journalinfo SET commandIndex = %d"'
op|'%'
name|'index'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_syncDone
dedent|''
name|'def'
name|'_syncDone'
op|'('
name|'self'
op|','
name|'result'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'syncing'
op|'='
number|'0'
newline|'\n'
name|'return'
name|'result'
newline|'\n'
nl|'\n'
DECL|member|getLastSnapshot
dedent|''
name|'def'
name|'getLastSnapshot'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return command index of last snapshot."""'
newline|'\n'
name|'conn'
op|'='
name|'self'
op|'.'
name|'reflector'
op|'.'
name|'dbpool'
op|'.'
name|'connect'
op|'('
op|')'
newline|'\n'
name|'cursor'
op|'='
name|'conn'
op|'.'
name|'cursor'
op|'('
op|')'
newline|'\n'
name|'cursor'
op|'.'
name|'execute'
op|'('
string|'"SELECT commandIndex FROM journalinfo"'
op|')'
newline|'\n'
name|'return'
name|'cursor'
op|'.'
name|'fetchall'
op|'('
op|')'
op|'['
number|'0'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
