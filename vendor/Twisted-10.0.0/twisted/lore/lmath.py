begin_unit
comment|'# Copyright (c) 2001-2009 Twisted Matrix Laboratories.'
nl|'\n'
comment|'# See LICENSE for details.'
nl|'\n'
nl|'\n'
string|'"""\nLaTeX-defined image support for Lore documents.\n"""'
newline|'\n'
nl|'\n'
name|'import'
name|'os'
op|','
name|'tempfile'
newline|'\n'
name|'from'
name|'xml'
op|'.'
name|'dom'
name|'import'
name|'minidom'
name|'as'
name|'dom'
newline|'\n'
nl|'\n'
name|'from'
name|'twisted'
op|'.'
name|'web'
name|'import'
name|'domhelpers'
newline|'\n'
name|'import'
name|'latex'
op|','
name|'tree'
op|','
name|'lint'
op|','
name|'default'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|MathLatexSpitter
name|'class'
name|'MathLatexSpitter'
op|'('
name|'latex'
op|'.'
name|'LatexSpitter'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|variable|start_html
indent|'    '
name|'start_html'
op|'='
string|"'\\\\documentclass{amsart}\\n'"
newline|'\n'
nl|'\n'
DECL|member|visitNode_div_latexmacros
name|'def'
name|'visitNode_div_latexmacros'
op|'('
name|'self'
op|','
name|'node'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'writer'
op|'('
name|'domhelpers'
op|'.'
name|'getNodeText'
op|'('
name|'node'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|visitNode_span_latexformula
dedent|''
name|'def'
name|'visitNode_span_latexformula'
op|'('
name|'self'
op|','
name|'node'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'writer'
op|'('
string|"'\\['"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'writer'
op|'('
name|'domhelpers'
op|'.'
name|'getNodeText'
op|'('
name|'node'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'writer'
op|'('
string|"'\\]'"
op|')'
newline|'\n'
nl|'\n'
DECL|function|formulaeToImages
dedent|''
dedent|''
name|'def'
name|'formulaeToImages'
op|'('
name|'document'
op|','
name|'dir'
op|','
name|'_system'
op|'='
name|'os'
op|'.'
name|'system'
op|')'
op|':'
newline|'\n'
comment|'# gather all macros'
nl|'\n'
indent|'    '
name|'macros'
op|'='
string|"''"
newline|'\n'
name|'for'
name|'node'
name|'in'
name|'domhelpers'
op|'.'
name|'findElementsWithAttribute'
op|'('
name|'document'
op|','
string|"'class'"
op|','
nl|'\n'
string|"'latexmacros'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'macros'
op|'+='
name|'domhelpers'
op|'.'
name|'getNodeText'
op|'('
name|'node'
op|')'
newline|'\n'
name|'node'
op|'.'
name|'parentNode'
op|'.'
name|'removeChild'
op|'('
name|'node'
op|')'
newline|'\n'
dedent|''
name|'i'
op|'='
number|'0'
newline|'\n'
name|'for'
name|'node'
name|'in'
name|'domhelpers'
op|'.'
name|'findElementsWithAttribute'
op|'('
name|'document'
op|','
string|"'class'"
op|','
nl|'\n'
string|"'latexformula'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'latexText'
op|'='
string|"'''\\\\documentclass[12pt]{amsart}%s\n                     \\\\begin{document}\\[%s\\]\n                     \\\\end{document}'''"
op|'%'
op|'('
name|'macros'
op|','
name|'domhelpers'
op|'.'
name|'getNodeText'
op|'('
name|'node'
op|')'
op|')'
newline|'\n'
comment|'# This file really should be cleaned up by this function, or placed'
nl|'\n'
comment|'# somewhere such that the calling code can find it and clean it up.'
nl|'\n'
name|'file'
op|'='
name|'tempfile'
op|'.'
name|'mktemp'
op|'('
op|')'
newline|'\n'
name|'f'
op|'='
name|'open'
op|'('
name|'file'
op|'+'
string|"'.tex'"
op|','
string|"'w'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'write'
op|'('
name|'latexText'
op|')'
newline|'\n'
name|'f'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'_system'
op|'('
string|"'latex %s.tex'"
op|'%'
name|'file'
op|')'
newline|'\n'
name|'_system'
op|'('
string|"'dvips %s.dvi -o %s.ps'"
op|'%'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'basename'
op|'('
name|'file'
op|')'
op|','
name|'file'
op|')'
op|')'
newline|'\n'
name|'baseimgname'
op|'='
string|"'latexformula%d.png'"
op|'%'
name|'i'
newline|'\n'
name|'imgname'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'dir'
op|','
name|'baseimgname'
op|')'
newline|'\n'
name|'i'
op|'+='
number|'1'
newline|'\n'
name|'_system'
op|'('
string|"'pstoimg -type png -crop a -trans -interlace -out '"
nl|'\n'
string|"'%s %s.ps'"
op|'%'
op|'('
name|'imgname'
op|','
name|'file'
op|')'
op|')'
newline|'\n'
name|'newNode'
op|'='
name|'dom'
op|'.'
name|'parseString'
op|'('
nl|'\n'
string|'\'<span><br /><img src="%s" /><br /></span>\''
op|'%'
op|'('
nl|'\n'
name|'baseimgname'
op|','
op|')'
op|')'
op|'.'
name|'documentElement'
newline|'\n'
name|'node'
op|'.'
name|'parentNode'
op|'.'
name|'replaceChild'
op|'('
name|'newNode'
op|','
name|'node'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|doFile
dedent|''
dedent|''
name|'def'
name|'doFile'
op|'('
name|'fn'
op|','
name|'docsdir'
op|','
name|'ext'
op|','
name|'url'
op|','
name|'templ'
op|','
name|'linkrel'
op|'='
string|"''"
op|','
name|'d'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'d'
op|'='
name|'d'
name|'or'
op|'{'
op|'}'
newline|'\n'
name|'doc'
op|'='
name|'tree'
op|'.'
name|'parseFileAndReport'
op|'('
name|'fn'
op|')'
newline|'\n'
name|'formulaeToImages'
op|'('
name|'doc'
op|','
name|'os'
op|'.'
name|'path'
op|'.'
name|'dirname'
op|'('
name|'fn'
op|')'
op|')'
newline|'\n'
name|'cn'
op|'='
name|'templ'
op|'.'
name|'cloneNode'
op|'('
number|'1'
op|')'
newline|'\n'
name|'tree'
op|'.'
name|'munge'
op|'('
name|'doc'
op|','
name|'cn'
op|','
name|'linkrel'
op|','
name|'docsdir'
op|','
name|'fn'
op|','
name|'ext'
op|','
name|'url'
op|','
name|'d'
op|')'
newline|'\n'
name|'cn'
op|'.'
name|'writexml'
op|'('
name|'open'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'splitext'
op|'('
name|'fn'
op|')'
op|'['
number|'0'
op|']'
op|'+'
name|'ext'
op|','
string|"'wb'"
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ProcessingFunctionFactory
dedent|''
name|'class'
name|'ProcessingFunctionFactory'
op|'('
name|'default'
op|'.'
name|'ProcessingFunctionFactory'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|variable|latexSpitters
indent|'    '
name|'latexSpitters'
op|'='
op|'{'
name|'None'
op|':'
name|'MathLatexSpitter'
op|'}'
newline|'\n'
nl|'\n'
DECL|member|getDoFile
name|'def'
name|'getDoFile'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'doFile'
newline|'\n'
nl|'\n'
DECL|member|getLintChecker
dedent|''
name|'def'
name|'getLintChecker'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'checker'
op|'='
name|'lint'
op|'.'
name|'getDefaultChecker'
op|'('
op|')'
newline|'\n'
name|'checker'
op|'.'
name|'allowedClasses'
op|'='
name|'checker'
op|'.'
name|'allowedClasses'
op|'.'
name|'copy'
op|'('
op|')'
newline|'\n'
name|'oldDiv'
op|'='
name|'checker'
op|'.'
name|'allowedClasses'
op|'['
string|"'div'"
op|']'
newline|'\n'
name|'oldSpan'
op|'='
name|'checker'
op|'.'
name|'allowedClasses'
op|'['
string|"'span'"
op|']'
newline|'\n'
name|'checker'
op|'.'
name|'allowedClasses'
op|'['
string|"'div'"
op|']'
op|'='
name|'lambda'
name|'x'
op|':'
name|'oldDiv'
op|'('
name|'x'
op|')'
name|'or'
name|'x'
op|'=='
string|"'latexmacros'"
newline|'\n'
name|'checker'
op|'.'
name|'allowedClasses'
op|'['
string|"'span'"
op|']'
op|'='
op|'('
name|'lambda'
name|'x'
op|':'
name|'oldSpan'
op|'('
name|'x'
op|')'
name|'or'
nl|'\n'
name|'x'
op|'=='
string|"'latexformula'"
op|')'
newline|'\n'
name|'return'
name|'checker'
newline|'\n'
nl|'\n'
DECL|variable|factory
dedent|''
dedent|''
name|'factory'
op|'='
name|'ProcessingFunctionFactory'
op|'('
op|')'
newline|'\n'
endmarker|''
end_unit
