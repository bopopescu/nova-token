begin_unit
comment|'# Read username, output from non-empty factory, drop connections'
nl|'\n'
comment|'# Use deferreds, to minimize synchronicity assumptions'
nl|'\n'
nl|'\n'
name|'from'
name|'twisted'
op|'.'
name|'internet'
name|'import'
name|'protocol'
op|','
name|'reactor'
op|','
name|'defer'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'protocols'
name|'import'
name|'basic'
newline|'\n'
nl|'\n'
DECL|class|FingerProtocol
name|'class'
name|'FingerProtocol'
op|'('
name|'basic'
op|'.'
name|'LineReceiver'
op|')'
op|':'
newline|'\n'
DECL|member|lineReceived
indent|'    '
name|'def'
name|'lineReceived'
op|'('
name|'self'
op|','
name|'user'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'d'
op|'='
name|'self'
op|'.'
name|'factory'
op|'.'
name|'getUser'
op|'('
name|'user'
op|')'
newline|'\n'
nl|'\n'
DECL|function|onError
name|'def'
name|'onError'
op|'('
name|'err'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
string|"'Internal error in server'"
newline|'\n'
dedent|''
name|'d'
op|'.'
name|'addErrback'
op|'('
name|'onError'
op|')'
newline|'\n'
nl|'\n'
DECL|function|writeResponse
name|'def'
name|'writeResponse'
op|'('
name|'message'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'transport'
op|'.'
name|'write'
op|'('
name|'message'
op|'+'
string|"'\\r\\n'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'transport'
op|'.'
name|'loseConnection'
op|'('
op|')'
newline|'\n'
dedent|''
name|'d'
op|'.'
name|'addCallback'
op|'('
name|'writeResponse'
op|')'
newline|'\n'
nl|'\n'
DECL|class|FingerFactory
dedent|''
dedent|''
name|'class'
name|'FingerFactory'
op|'('
name|'protocol'
op|'.'
name|'ServerFactory'
op|')'
op|':'
newline|'\n'
DECL|variable|protocol
indent|'    '
name|'protocol'
op|'='
name|'FingerProtocol'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'users'
op|'='
name|'kwargs'
newline|'\n'
nl|'\n'
DECL|member|getUser
dedent|''
name|'def'
name|'getUser'
op|'('
name|'self'
op|','
name|'user'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'defer'
op|'.'
name|'succeed'
op|'('
name|'self'
op|'.'
name|'users'
op|'.'
name|'get'
op|'('
name|'user'
op|','
string|'"No such user"'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'reactor'
op|'.'
name|'listenTCP'
op|'('
number|'1079'
op|','
name|'FingerFactory'
op|'('
name|'moshez'
op|'='
string|"'Happy and well'"
op|')'
op|')'
newline|'\n'
name|'reactor'
op|'.'
name|'run'
op|'('
op|')'
newline|'\n'
endmarker|''
end_unit
