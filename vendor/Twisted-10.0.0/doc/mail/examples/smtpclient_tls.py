begin_unit
nl|'\n'
string|'"""\nDemonstrate sending mail via SMTP while employing TLS and performing\nauthentication.\n"""'
newline|'\n'
nl|'\n'
name|'import'
name|'sys'
newline|'\n'
nl|'\n'
name|'from'
name|'OpenSSL'
op|'.'
name|'SSL'
name|'import'
name|'SSLv3_METHOD'
newline|'\n'
nl|'\n'
name|'from'
name|'twisted'
op|'.'
name|'mail'
op|'.'
name|'smtp'
name|'import'
name|'ESMTPSenderFactory'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'python'
op|'.'
name|'usage'
name|'import'
name|'Options'
op|','
name|'UsageError'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'internet'
op|'.'
name|'ssl'
name|'import'
name|'ClientContextFactory'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'internet'
op|'.'
name|'defer'
name|'import'
name|'Deferred'
newline|'\n'
name|'from'
name|'twisted'
op|'.'
name|'internet'
name|'import'
name|'reactor'
newline|'\n'
nl|'\n'
DECL|function|sendmail
name|'def'
name|'sendmail'
op|'('
nl|'\n'
name|'authenticationUsername'
op|','
name|'authenticationSecret'
op|','
nl|'\n'
name|'fromAddress'
op|','
name|'toAddress'
op|','
nl|'\n'
name|'messageFile'
op|','
nl|'\n'
name|'smtpHost'
op|','
name|'smtpPort'
op|'='
number|'25'
nl|'\n'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    @param authenticationUsername: The username with which to authenticate.\n    @param authenticationSecret: The password with which to authenticate.\n    @param fromAddress: The SMTP reverse path (ie, MAIL FROM)\n    @param toAddress: The SMTP forward path (ie, RCPT TO)\n    @param messageFile: A file-like object containing the headers and body of\n    the message to send.\n    @param smtpHost: The MX host to which to connect.\n    @param smtpPort: The port number to which to connect.\n\n    @return: A Deferred which will be called back when the message has been\n    sent or which will errback if it cannot be sent.\n    """'
newline|'\n'
nl|'\n'
comment|'# Create a context factory which only allows SSLv3 and does not verify'
nl|'\n'
comment|"# the peer's certificate."
nl|'\n'
name|'contextFactory'
op|'='
name|'ClientContextFactory'
op|'('
op|')'
newline|'\n'
name|'contextFactory'
op|'.'
name|'method'
op|'='
name|'SSLv3_METHOD'
newline|'\n'
nl|'\n'
name|'resultDeferred'
op|'='
name|'Deferred'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'senderFactory'
op|'='
name|'ESMTPSenderFactory'
op|'('
nl|'\n'
name|'authenticationUsername'
op|','
nl|'\n'
name|'authenticationSecret'
op|','
nl|'\n'
name|'fromAddress'
op|','
nl|'\n'
name|'toAddress'
op|','
nl|'\n'
name|'messageFile'
op|','
nl|'\n'
name|'resultDeferred'
op|','
nl|'\n'
name|'contextFactory'
op|'='
name|'contextFactory'
op|')'
newline|'\n'
nl|'\n'
name|'reactor'
op|'.'
name|'connectTCP'
op|'('
name|'smtpHost'
op|','
name|'smtpPort'
op|','
name|'senderFactory'
op|')'
newline|'\n'
nl|'\n'
name|'return'
name|'resultDeferred'
newline|'\n'
nl|'\n'
nl|'\n'
nl|'\n'
DECL|class|SendmailOptions
dedent|''
name|'class'
name|'SendmailOptions'
op|'('
name|'Options'
op|')'
op|':'
newline|'\n'
DECL|variable|synopsis
indent|'    '
name|'synopsis'
op|'='
string|'"smtpclient_tls.py [options]"'
newline|'\n'
nl|'\n'
DECL|variable|optParameters
name|'optParameters'
op|'='
op|'['
nl|'\n'
op|'('
string|"'username'"
op|','
string|"'u'"
op|','
name|'None'
op|','
nl|'\n'
string|"'The username with which to authenticate to the SMTP server.'"
op|')'
op|','
nl|'\n'
op|'('
string|"'password'"
op|','
string|"'p'"
op|','
name|'None'
op|','
nl|'\n'
string|"'The password with which to authenticate to the SMTP server.'"
op|')'
op|','
nl|'\n'
op|'('
string|"'from-address'"
op|','
string|"'f'"
op|','
name|'None'
op|','
nl|'\n'
string|"'The address from which to send the message.'"
op|')'
op|','
nl|'\n'
op|'('
string|"'to-address'"
op|','
string|"'t'"
op|','
name|'None'
op|','
nl|'\n'
string|"'The address to which to send the message.'"
op|')'
op|','
nl|'\n'
op|'('
string|"'message'"
op|','
string|"'m'"
op|','
name|'None'
op|','
nl|'\n'
string|"'The filename which contains the message to send.'"
op|')'
op|','
nl|'\n'
op|'('
string|"'smtp-host'"
op|','
string|"'h'"
op|','
name|'None'
op|','
nl|'\n'
string|"'The host through which to send the message.'"
op|')'
op|','
nl|'\n'
op|'('
string|"'smtp-port'"
op|','
name|'None'
op|','
string|"'25'"
op|','
nl|'\n'
string|"'The port number on smtp-host to which to connect.'"
op|')'
op|']'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|member|postOptions
name|'def'
name|'postOptions'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Parse integer parameters, open the message file, and make sure all\n        required parameters have been specified.\n        """'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'['
string|"'smtp-port'"
op|']'
op|'='
name|'int'
op|'('
name|'self'
op|'['
string|"'smtp-port'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'UsageError'
op|'('
string|'"--smtp-port argument must be an integer."'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'self'
op|'['
string|"'username'"
op|']'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'UsageError'
op|'('
nl|'\n'
string|'"Must specify authentication username with --username"'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'self'
op|'['
string|"'password'"
op|']'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'UsageError'
op|'('
nl|'\n'
string|'"Must specify authentication password with --password"'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'self'
op|'['
string|"'from-address'"
op|']'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'UsageError'
op|'('
string|'"Must specify from address with --from-address"'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'self'
op|'['
string|"'to-address'"
op|']'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'UsageError'
op|'('
string|'"Must specify from address with --to-address"'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'self'
op|'['
string|"'smtp-host'"
op|']'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'UsageError'
op|'('
string|'"Must specify smtp host with --smtp-host"'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'self'
op|'['
string|"'message'"
op|']'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'UsageError'
op|'('
nl|'\n'
string|'"Must specify a message file to send with --message"'
op|')'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'['
string|"'message'"
op|']'
op|'='
name|'file'
op|'('
name|'self'
op|'['
string|"'message'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|','
name|'e'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'UsageError'
op|'('
name|'e'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
nl|'\n'
DECL|function|cbSentMessage
dedent|''
dedent|''
dedent|''
name|'def'
name|'cbSentMessage'
op|'('
name|'result'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Called when the message has been sent.\n\n    Report success to the user and then stop the reactor.\n    """'
newline|'\n'
name|'print'
string|'"Message sent"'
newline|'\n'
name|'reactor'
op|'.'
name|'stop'
op|'('
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
nl|'\n'
DECL|function|ebSentMessage
dedent|''
name|'def'
name|'ebSentMessage'
op|'('
name|'err'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Called if the message cannot be sent.\n\n    Report the failure to the user and then stop the reactor.\n    """'
newline|'\n'
name|'err'
op|'.'
name|'printTraceback'
op|'('
op|')'
newline|'\n'
name|'reactor'
op|'.'
name|'stop'
op|'('
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
nl|'\n'
DECL|function|main
dedent|''
name|'def'
name|'main'
op|'('
name|'args'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Parse arguments and send an email based on them.\n    """'
newline|'\n'
name|'o'
op|'='
name|'SendmailOptions'
op|'('
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'o'
op|'.'
name|'parseOptions'
op|'('
name|'args'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'UsageError'
op|','
name|'e'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'SystemExit'
op|'('
name|'e'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'from'
name|'twisted'
op|'.'
name|'python'
name|'import'
name|'log'
newline|'\n'
name|'log'
op|'.'
name|'startLogging'
op|'('
name|'sys'
op|'.'
name|'stdout'
op|')'
newline|'\n'
name|'result'
op|'='
name|'sendmail'
op|'('
nl|'\n'
name|'o'
op|'['
string|"'username'"
op|']'
op|','
nl|'\n'
name|'o'
op|'['
string|"'password'"
op|']'
op|','
nl|'\n'
name|'o'
op|'['
string|"'from-address'"
op|']'
op|','
nl|'\n'
name|'o'
op|'['
string|"'to-address'"
op|']'
op|','
nl|'\n'
name|'o'
op|'['
string|"'message'"
op|']'
op|','
nl|'\n'
name|'o'
op|'['
string|"'smtp-host'"
op|']'
op|','
nl|'\n'
name|'o'
op|'['
string|"'smtp-port'"
op|']'
op|')'
newline|'\n'
name|'result'
op|'.'
name|'addCallbacks'
op|'('
name|'cbSentMessage'
op|','
name|'ebSentMessage'
op|')'
newline|'\n'
name|'reactor'
op|'.'
name|'run'
op|'('
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'__name__'
op|'=='
string|"'__main__'"
op|':'
newline|'\n'
indent|'    '
name|'main'
op|'('
name|'sys'
op|'.'
name|'argv'
op|'['
number|'1'
op|':'
op|']'
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit
