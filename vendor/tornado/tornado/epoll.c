begin_unit
begin_comment
comment|/*  * Copyright 2009 Facebook  *  * Licensed under the Apache License, Version 2.0 (the "License"); you may  * not use this file except in compliance with the License. You may obtain  * a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the  * License for the specific language governing permissions and limitations  * under the License.  */
end_comment
begin_include
include|#
directive|include
file|"Python.h"
end_include
begin_include
include|#
directive|include
file|<string.h>
end_include
begin_include
include|#
directive|include
file|<sys/epoll.h>
end_include
begin_define
DECL|macro|MAX_EVENTS
define|#
directive|define
name|MAX_EVENTS
value|24
end_define
begin_comment
comment|/*  * Simple wrapper around epoll_create.  */
end_comment
begin_function
DECL|function|_epoll_create
specifier|static
name|PyObject
modifier|*
name|_epoll_create
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|fd
init|=
name|epoll_create
argument_list|(
name|MAX_EVENTS
argument_list|)
decl_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
name|PyErr_SetFromErrno
argument_list|(
name|PyExc_Exception
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|PyInt_FromLong
argument_list|(
name|fd
argument_list|)
return|;
block|}
end_function
begin_comment
comment|/*  * Simple wrapper around epoll_ctl. We throw an exception if the call fails  * rather than returning the error code since it is an infrequent (and likely  * catastrophic) event when it does happen.  */
end_comment
begin_function
DECL|function|_epoll_ctl
specifier|static
name|PyObject
modifier|*
name|_epoll_ctl
parameter_list|(
name|PyObject
modifier|*
name|self
parameter_list|,
name|PyObject
modifier|*
name|args
parameter_list|)
block|{
name|int
name|epfd
decl_stmt|,
name|op
decl_stmt|,
name|fd
decl_stmt|,
name|events
decl_stmt|;
name|struct
name|epoll_event
name|event
decl_stmt|;
if|if
condition|(
operator|!
name|PyArg_ParseTuple
argument_list|(
name|args
argument_list|,
literal|"iiiI"
argument_list|,
operator|&
name|epfd
argument_list|,
operator|&
name|op
argument_list|,
operator|&
name|fd
argument_list|,
operator|&
name|events
argument_list|)
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|events
operator|=
name|events
expr_stmt|;
name|event
operator|.
name|data
operator|.
name|fd
operator|=
name|fd
expr_stmt|;
if|if
condition|(
name|epoll_ctl
argument_list|(
name|epfd
argument_list|,
name|op
argument_list|,
name|fd
argument_list|,
operator|&
name|event
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|PyErr_SetFromErrno
argument_list|(
name|PyExc_OSError
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|Py_INCREF
argument_list|(
name|Py_None
argument_list|)
expr_stmt|;
return|return
name|Py_None
return|;
block|}
end_function
begin_comment
comment|/*  * Simple wrapper around epoll_wait. We return None if the call times out and  * throw an exception if an error occurs. Otherwise, we return a list of  * (fd, event) tuples.  */
end_comment
begin_function
DECL|function|_epoll_wait
specifier|static
name|PyObject
modifier|*
name|_epoll_wait
parameter_list|(
name|PyObject
modifier|*
name|self
parameter_list|,
name|PyObject
modifier|*
name|args
parameter_list|)
block|{
name|struct
name|epoll_event
name|events
index|[
name|MAX_EVENTS
index|]
decl_stmt|;
name|int
name|epfd
decl_stmt|,
name|timeout
decl_stmt|,
name|num_events
decl_stmt|,
name|i
decl_stmt|;
name|PyObject
modifier|*
name|list
decl_stmt|;
name|PyObject
modifier|*
name|tuple
decl_stmt|;
if|if
condition|(
operator|!
name|PyArg_ParseTuple
argument_list|(
name|args
argument_list|,
literal|"ii"
argument_list|,
operator|&
name|epfd
argument_list|,
operator|&
name|timeout
argument_list|)
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|Py_BEGIN_ALLOW_THREADS
name|num_events
init|=
name|epoll_wait
argument_list|(
name|epfd
argument_list|,
name|events
argument_list|,
name|MAX_EVENTS
argument_list|,
name|timeout
argument_list|)
decl_stmt|;
name|Py_END_ALLOW_THREADS
if|if
condition|(
name|num_events
operator|==
operator|-
literal|1
condition|)
block|{
name|PyErr_SetFromErrno
argument_list|(
name|PyExc_Exception
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|list
operator|=
name|PyList_New
argument_list|(
name|num_events
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_events
condition|;
name|i
operator|++
control|)
block|{
name|tuple
operator|=
name|PyTuple_New
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|PyTuple_SET_ITEM
argument_list|(
name|tuple
argument_list|,
literal|0
argument_list|,
name|PyInt_FromLong
argument_list|(
name|events
index|[
name|i
index|]
operator|.
name|data
operator|.
name|fd
argument_list|)
argument_list|)
expr_stmt|;
name|PyTuple_SET_ITEM
argument_list|(
name|tuple
argument_list|,
literal|1
argument_list|,
name|PyInt_FromLong
argument_list|(
name|events
index|[
name|i
index|]
operator|.
name|events
argument_list|)
argument_list|)
expr_stmt|;
name|PyList_SET_ITEM
argument_list|(
name|list
argument_list|,
name|i
argument_list|,
name|tuple
argument_list|)
expr_stmt|;
block|}
return|return
name|list
return|;
block|}
end_function
begin_comment
comment|/*  * Our method declararations  */
end_comment
begin_decl_stmt
DECL|variable|kEpollMethods
specifier|static
name|PyMethodDef
name|kEpollMethods
index|[]
init|=
block|{
block|{
literal|"epoll_create"
block|,
operator|(
name|PyCFunction
operator|)
name|_epoll_create
block|,
name|METH_NOARGS
block|,
literal|"Create an epoll file descriptor"
block|}
block|,
block|{
literal|"epoll_ctl"
block|,
name|_epoll_ctl
block|,
name|METH_VARARGS
block|,
literal|"Control an epoll file descriptor"
block|}
block|,
block|{
literal|"epoll_wait"
block|,
name|_epoll_wait
block|,
name|METH_VARARGS
block|,
literal|"Wait for events on an epoll file descriptor"
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt
begin_comment
comment|/*  * Module initialization  */
end_comment
begin_function
DECL|function|initepoll
name|PyMODINIT_FUNC
name|initepoll
parameter_list|(
name|void
parameter_list|)
block|{
name|Py_InitModule
argument_list|(
literal|"epoll"
argument_list|,
name|kEpollMethods
argument_list|)
expr_stmt|;
block|}
end_function
end_unit
