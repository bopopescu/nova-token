begin_unit
comment|'# Copyright (c) 2006,2007 Mitch Garnaat http://garnaat.org/'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Permission is hereby granted, free of charge, to any person obtaining a'
nl|'\n'
comment|'# copy of this software and associated documentation files (the'
nl|'\n'
comment|'# "Software"), to deal in the Software without restriction, including'
nl|'\n'
comment|'# without limitation the rights to use, copy, modify, merge, publish, dis-'
nl|'\n'
comment|'# tribute, sublicense, and/or sell copies of the Software, and to permit'
nl|'\n'
comment|'# persons to whom the Software is furnished to do so, subject to the fol-'
nl|'\n'
comment|'# lowing conditions:'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# The above copyright notice and this permission notice shall be included'
nl|'\n'
comment|'# in all copies or substantial portions of the Software.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS'
nl|'\n'
comment|'# OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABIL-'
nl|'\n'
comment|'# ITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT'
nl|'\n'
comment|'# SHALL THE AUTHOR BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, '
nl|'\n'
comment|'# WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,'
nl|'\n'
comment|'# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS'
nl|'\n'
comment|'# IN THE SOFTWARE.'
nl|'\n'
nl|'\n'
name|'import'
name|'boto'
newline|'\n'
name|'from'
name|'boto'
op|'.'
name|'services'
op|'.'
name|'service'
name|'import'
name|'Service'
newline|'\n'
name|'from'
name|'boto'
op|'.'
name|'services'
op|'.'
name|'message'
name|'import'
name|'ServiceMessage'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'mimetypes'
newline|'\n'
nl|'\n'
DECL|class|SonOfMMM
name|'class'
name|'SonOfMMM'
op|'('
name|'Service'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'config_file'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'Service'
op|'.'
name|'__init__'
op|'('
name|'self'
op|','
name|'config_file'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'log_file'
op|'='
string|"'%s.log'"
op|'%'
name|'self'
op|'.'
name|'instance_id'
newline|'\n'
name|'self'
op|'.'
name|'log_path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'working_dir'
op|','
name|'self'
op|'.'
name|'log_file'
op|')'
newline|'\n'
name|'boto'
op|'.'
name|'set_file_logger'
op|'('
name|'self'
op|'.'
name|'name'
op|','
name|'self'
op|'.'
name|'log_path'
op|')'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'sd'
op|'.'
name|'has_option'
op|'('
string|"'ffmpeg_args'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'command'
op|'='
string|"'/usr/local/bin/ffmpeg '"
op|'+'
name|'self'
op|'.'
name|'sd'
op|'.'
name|'get'
op|'('
string|"'ffmpeg_args'"
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'command'
op|'='
string|"'/usr/local/bin/ffmpeg -y -i %s %s'"
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'output_mimetype'
op|'='
name|'self'
op|'.'
name|'sd'
op|'.'
name|'get'
op|'('
string|"'output_mimetype'"
op|')'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'sd'
op|'.'
name|'has_option'
op|'('
string|"'output_ext'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'output_ext'
op|'='
name|'self'
op|'.'
name|'sd'
op|'.'
name|'get'
op|'('
string|"'output_ext'"
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'output_ext'
op|'='
name|'mimetypes'
op|'.'
name|'guess_extension'
op|'('
name|'self'
op|'.'
name|'output_mimetype'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'output_bucket'
op|'='
name|'self'
op|'.'
name|'sd'
op|'.'
name|'get_obj'
op|'('
string|"'output_bucket'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'input_bucket'
op|'='
name|'self'
op|'.'
name|'sd'
op|'.'
name|'get_obj'
op|'('
string|"'input_bucket'"
op|')'
newline|'\n'
comment|'# check to see if there are any messages queue'
nl|'\n'
comment|'# if not, create messages for all files in input_bucket'
nl|'\n'
name|'m'
op|'='
name|'self'
op|'.'
name|'input_queue'
op|'.'
name|'read'
op|'('
number|'1'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'m'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'queue_files'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|queue_files
dedent|''
dedent|''
name|'def'
name|'queue_files'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'boto'
op|'.'
name|'log'
op|'.'
name|'info'
op|'('
string|"'Queueing files from %s'"
op|'%'
name|'self'
op|'.'
name|'input_bucket'
op|'.'
name|'name'
op|')'
newline|'\n'
name|'for'
name|'key'
name|'in'
name|'self'
op|'.'
name|'input_bucket'
op|':'
newline|'\n'
indent|'            '
name|'boto'
op|'.'
name|'log'
op|'.'
name|'info'
op|'('
string|"'Queueing %s'"
op|'%'
name|'key'
op|'.'
name|'name'
op|')'
newline|'\n'
name|'m'
op|'='
name|'ServiceMessage'
op|'('
op|')'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'output_bucket'
op|':'
newline|'\n'
indent|'                '
name|'d'
op|'='
op|'{'
string|"'OutputBucket'"
op|':'
name|'self'
op|'.'
name|'output_bucket'
op|'.'
name|'name'
op|'}'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'d'
op|'='
name|'None'
newline|'\n'
dedent|''
name|'m'
op|'.'
name|'for_key'
op|'('
name|'key'
op|','
name|'d'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'input_queue'
op|'.'
name|'write'
op|'('
name|'m'
op|')'
newline|'\n'
nl|'\n'
DECL|member|process_file
dedent|''
dedent|''
name|'def'
name|'process_file'
op|'('
name|'self'
op|','
name|'in_file_name'
op|','
name|'msg'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'base'
op|','
name|'ext'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'splitext'
op|'('
name|'in_file_name'
op|')'
newline|'\n'
name|'out_file_name'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'working_dir'
op|','
nl|'\n'
name|'base'
op|'+'
name|'self'
op|'.'
name|'output_ext'
op|')'
newline|'\n'
name|'command'
op|'='
name|'self'
op|'.'
name|'command'
op|'%'
op|'('
name|'in_file_name'
op|','
name|'out_file_name'
op|')'
newline|'\n'
name|'boto'
op|'.'
name|'log'
op|'.'
name|'info'
op|'('
string|"'running:\\n%s'"
op|'%'
name|'command'
op|')'
newline|'\n'
name|'status'
op|'='
name|'self'
op|'.'
name|'run'
op|'('
name|'command'
op|')'
newline|'\n'
name|'if'
name|'status'
op|'=='
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'['
op|'('
name|'out_file_name'
op|','
name|'self'
op|'.'
name|'output_mimetype'
op|')'
op|']'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'['
op|']'
newline|'\n'
nl|'\n'
DECL|member|shutdown
dedent|''
dedent|''
name|'def'
name|'shutdown'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'os'
op|'.'
name|'path'
op|'.'
name|'isfile'
op|'('
name|'self'
op|'.'
name|'log_path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'self'
op|'.'
name|'output_bucket'
op|':'
newline|'\n'
indent|'                '
name|'key'
op|'='
name|'self'
op|'.'
name|'output_bucket'
op|'.'
name|'new_key'
op|'('
name|'self'
op|'.'
name|'log_file'
op|')'
newline|'\n'
name|'key'
op|'.'
name|'set_contents_from_filename'
op|'('
name|'self'
op|'.'
name|'log_path'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'Service'
op|'.'
name|'shutdown'
op|'('
name|'self'
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
