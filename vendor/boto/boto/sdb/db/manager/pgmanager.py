begin_unit
comment|'# Copyright (c) 2006,2007,2008 Mitch Garnaat http://garnaat.org/'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Permission is hereby granted, free of charge, to any person obtaining a'
nl|'\n'
comment|'# copy of this software and associated documentation files (the'
nl|'\n'
comment|'# "Software"), to deal in the Software without restriction, including'
nl|'\n'
comment|'# without limitation the rights to use, copy, modify, merge, publish, dis-'
nl|'\n'
comment|'# tribute, sublicense, and/or sell copies of the Software, and to permit'
nl|'\n'
comment|'# persons to whom the Software is furnished to do so, subject to the fol-'
nl|'\n'
comment|'# lowing conditions:'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# The above copyright notice and this permission notice shall be included'
nl|'\n'
comment|'# in all copies or substantial portions of the Software.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS'
nl|'\n'
comment|'# OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABIL-'
nl|'\n'
comment|'# ITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT'
nl|'\n'
comment|'# SHALL THE AUTHOR BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, '
nl|'\n'
comment|'# WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,'
nl|'\n'
comment|'# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS'
nl|'\n'
comment|'# IN THE SOFTWARE.'
nl|'\n'
name|'from'
name|'boto'
op|'.'
name|'sdb'
op|'.'
name|'db'
op|'.'
name|'key'
name|'import'
name|'Key'
newline|'\n'
name|'from'
name|'boto'
op|'.'
name|'sdb'
op|'.'
name|'db'
op|'.'
name|'model'
name|'import'
name|'Model'
newline|'\n'
name|'import'
name|'psycopg2'
newline|'\n'
name|'import'
name|'psycopg2'
op|'.'
name|'extensions'
newline|'\n'
name|'import'
name|'uuid'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'string'
newline|'\n'
name|'from'
name|'boto'
op|'.'
name|'exception'
name|'import'
name|'SDBPersistenceError'
newline|'\n'
nl|'\n'
name|'psycopg2'
op|'.'
name|'extensions'
op|'.'
name|'register_type'
op|'('
name|'psycopg2'
op|'.'
name|'extensions'
op|'.'
name|'UNICODE'
op|')'
newline|'\n'
nl|'\n'
DECL|class|PGConverter
name|'class'
name|'PGConverter'
op|':'
newline|'\n'
nl|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'manager'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'manager'
op|'='
name|'manager'
newline|'\n'
name|'self'
op|'.'
name|'type_map'
op|'='
op|'{'
name|'Key'
op|':'
op|'('
name|'self'
op|'.'
name|'encode_reference'
op|','
name|'self'
op|'.'
name|'decode_reference'
op|')'
op|','
nl|'\n'
name|'Model'
op|':'
op|'('
name|'self'
op|'.'
name|'encode_reference'
op|','
name|'self'
op|'.'
name|'decode_reference'
op|')'
op|'}'
newline|'\n'
nl|'\n'
DECL|member|encode
dedent|''
name|'def'
name|'encode'
op|'('
name|'self'
op|','
name|'type'
op|','
name|'value'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'type'
name|'in'
name|'self'
op|'.'
name|'type_map'
op|':'
newline|'\n'
indent|'            '
name|'encode'
op|'='
name|'self'
op|'.'
name|'type_map'
op|'['
name|'type'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
name|'return'
name|'encode'
op|'('
name|'value'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'value'
newline|'\n'
nl|'\n'
DECL|member|decode
dedent|''
name|'def'
name|'decode'
op|'('
name|'self'
op|','
name|'type'
op|','
name|'value'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'type'
name|'in'
name|'self'
op|'.'
name|'type_map'
op|':'
newline|'\n'
indent|'            '
name|'decode'
op|'='
name|'self'
op|'.'
name|'type_map'
op|'['
name|'type'
op|']'
op|'['
number|'1'
op|']'
newline|'\n'
name|'return'
name|'decode'
op|'('
name|'value'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'value'
newline|'\n'
nl|'\n'
DECL|member|encode_prop
dedent|''
name|'def'
name|'encode_prop'
op|'('
name|'self'
op|','
name|'prop'
op|','
name|'value'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'isinstance'
op|'('
name|'value'
op|','
name|'list'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'hasattr'
op|'('
name|'prop'
op|','
string|"'item_type'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'s'
op|'='
string|'"{"'
newline|'\n'
name|'new_value'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'v'
name|'in'
name|'value'
op|':'
newline|'\n'
indent|'                    '
name|'item_type'
op|'='
name|'getattr'
op|'('
name|'prop'
op|','
string|"'item_type'"
op|')'
newline|'\n'
name|'if'
name|'Model'
name|'in'
name|'item_type'
op|'.'
name|'mro'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                        '
name|'item_type'
op|'='
name|'Model'
newline|'\n'
dedent|''
name|'new_value'
op|'.'
name|'append'
op|'('
string|"'%s'"
op|'%'
name|'self'
op|'.'
name|'encode'
op|'('
name|'item_type'
op|','
name|'v'
op|')'
op|')'
newline|'\n'
dedent|''
name|'s'
op|'+='
string|"','"
op|'.'
name|'join'
op|'('
name|'new_value'
op|')'
newline|'\n'
name|'s'
op|'+='
string|'"}"'
newline|'\n'
name|'return'
name|'s'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'value'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'self'
op|'.'
name|'encode'
op|'('
name|'prop'
op|'.'
name|'data_type'
op|','
name|'value'
op|')'
newline|'\n'
nl|'\n'
DECL|member|decode_prop
dedent|''
name|'def'
name|'decode_prop'
op|'('
name|'self'
op|','
name|'prop'
op|','
name|'value'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'prop'
op|'.'
name|'data_type'
op|'=='
name|'list'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'value'
op|'!='
name|'None'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'not'
name|'isinstance'
op|'('
name|'value'
op|','
name|'list'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'value'
op|'='
op|'['
name|'value'
op|']'
newline|'\n'
dedent|''
name|'if'
name|'hasattr'
op|'('
name|'prop'
op|','
string|"'item_type'"
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'item_type'
op|'='
name|'getattr'
op|'('
name|'prop'
op|','
string|'"item_type"'
op|')'
newline|'\n'
name|'if'
name|'Model'
name|'in'
name|'item_type'
op|'.'
name|'mro'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                        '
name|'if'
name|'item_type'
op|'!='
name|'self'
op|'.'
name|'manager'
op|'.'
name|'cls'
op|':'
newline|'\n'
indent|'                            '
name|'return'
name|'item_type'
op|'.'
name|'_manager'
op|'.'
name|'decode_value'
op|'('
name|'prop'
op|','
name|'value'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                            '
name|'item_type'
op|'='
name|'Model'
newline|'\n'
dedent|''
dedent|''
name|'return'
op|'['
name|'self'
op|'.'
name|'decode'
op|'('
name|'item_type'
op|','
name|'v'
op|')'
name|'for'
name|'v'
name|'in'
name|'value'
op|']'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'value'
newline|'\n'
dedent|''
name|'elif'
name|'hasattr'
op|'('
name|'prop'
op|','
string|"'reference_class'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ref_class'
op|'='
name|'getattr'
op|'('
name|'prop'
op|','
string|"'reference_class'"
op|')'
newline|'\n'
name|'if'
name|'ref_class'
op|'!='
name|'self'
op|'.'
name|'manager'
op|'.'
name|'cls'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'ref_class'
op|'.'
name|'_manager'
op|'.'
name|'decode_value'
op|'('
name|'prop'
op|','
name|'value'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'self'
op|'.'
name|'decode'
op|'('
name|'prop'
op|'.'
name|'data_type'
op|','
name|'value'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'elif'
name|'hasattr'
op|'('
name|'prop'
op|','
string|"'calculated_type'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'calc_type'
op|'='
name|'getattr'
op|'('
name|'prop'
op|','
string|"'calculated_type'"
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'decode'
op|'('
name|'calc_type'
op|','
name|'value'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'decode'
op|'('
name|'prop'
op|'.'
name|'data_type'
op|','
name|'value'
op|')'
newline|'\n'
nl|'\n'
DECL|member|encode_reference
dedent|''
dedent|''
name|'def'
name|'encode_reference'
op|'('
name|'self'
op|','
name|'value'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'isinstance'
op|'('
name|'value'
op|','
name|'str'
op|')'
name|'or'
name|'isinstance'
op|'('
name|'value'
op|','
name|'unicode'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'value'
newline|'\n'
dedent|''
name|'if'
name|'value'
op|'=='
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'return'
string|"''"
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'value'
op|'.'
name|'id'
newline|'\n'
nl|'\n'
DECL|member|decode_reference
dedent|''
dedent|''
name|'def'
name|'decode_reference'
op|'('
name|'self'
op|','
name|'value'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'value'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'manager'
op|'.'
name|'get_object_from_id'
op|'('
name|'value'
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'ValueError'
op|','
string|"'Unable to convert %s to Object'"
op|'%'
name|'value'
newline|'\n'
nl|'\n'
DECL|class|PGManager
dedent|''
dedent|''
dedent|''
name|'class'
name|'PGManager'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'cls'
op|','
name|'db_name'
op|','
name|'db_user'
op|','
name|'db_passwd'
op|','
nl|'\n'
name|'db_host'
op|','
name|'db_port'
op|','
name|'db_table'
op|','
name|'sql_dir'
op|','
name|'enable_ssl'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'cls'
op|'='
name|'cls'
newline|'\n'
name|'self'
op|'.'
name|'db_name'
op|'='
name|'db_name'
newline|'\n'
name|'self'
op|'.'
name|'db_user'
op|'='
name|'db_user'
newline|'\n'
name|'self'
op|'.'
name|'db_passwd'
op|'='
name|'db_passwd'
newline|'\n'
name|'self'
op|'.'
name|'db_host'
op|'='
name|'db_host'
newline|'\n'
name|'self'
op|'.'
name|'db_port'
op|'='
name|'db_port'
newline|'\n'
name|'self'
op|'.'
name|'db_table'
op|'='
name|'db_table'
newline|'\n'
name|'self'
op|'.'
name|'sql_dir'
op|'='
name|'sql_dir'
newline|'\n'
name|'self'
op|'.'
name|'in_transaction'
op|'='
name|'False'
newline|'\n'
name|'self'
op|'.'
name|'converter'
op|'='
name|'PGConverter'
op|'('
name|'self'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_connect'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|_build_connect_string
dedent|''
name|'def'
name|'_build_connect_string'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cs'
op|'='
string|"'dbname=%s user=%s password=%s host=%s port=%d'"
newline|'\n'
name|'return'
name|'cs'
op|'%'
op|'('
name|'self'
op|'.'
name|'db_name'
op|','
name|'self'
op|'.'
name|'db_user'
op|','
name|'self'
op|'.'
name|'db_passwd'
op|','
nl|'\n'
name|'self'
op|'.'
name|'db_host'
op|','
name|'self'
op|'.'
name|'db_port'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_connect
dedent|''
name|'def'
name|'_connect'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'connection'
op|'='
name|'psycopg2'
op|'.'
name|'connect'
op|'('
name|'self'
op|'.'
name|'_build_connect_string'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'connection'
op|'.'
name|'set_client_encoding'
op|'('
string|"'UTF8'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'cursor'
op|'='
name|'self'
op|'.'
name|'connection'
op|'.'
name|'cursor'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|_object_lister
dedent|''
name|'def'
name|'_object_lister'
op|'('
name|'self'
op|','
name|'cursor'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'row'
name|'in'
name|'cursor'
op|':'
newline|'\n'
indent|'                '
name|'yield'
name|'self'
op|'.'
name|'_object_from_row'
op|'('
name|'row'
op|','
name|'cursor'
op|'.'
name|'description'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'StopIteration'
op|':'
newline|'\n'
indent|'            '
name|'cursor'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'raise'
name|'StopIteration'
newline|'\n'
nl|'\n'
DECL|member|_dict_from_row
dedent|''
dedent|''
name|'def'
name|'_dict_from_row'
op|'('
name|'self'
op|','
name|'row'
op|','
name|'description'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'d'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
number|'0'
op|','
name|'len'
op|'('
name|'row'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'d'
op|'['
name|'description'
op|'['
name|'i'
op|']'
op|'['
number|'0'
op|']'
op|']'
op|'='
name|'row'
op|'['
name|'i'
op|']'
newline|'\n'
dedent|''
name|'return'
name|'d'
newline|'\n'
nl|'\n'
DECL|member|_object_from_row
dedent|''
name|'def'
name|'_object_from_row'
op|'('
name|'self'
op|','
name|'row'
op|','
name|'description'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'description'
op|':'
newline|'\n'
indent|'            '
name|'description'
op|'='
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'description'
newline|'\n'
dedent|''
name|'d'
op|'='
name|'self'
op|'.'
name|'_dict_from_row'
op|'('
name|'row'
op|','
name|'description'
op|')'
newline|'\n'
name|'obj'
op|'='
name|'self'
op|'.'
name|'cls'
op|'('
name|'d'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'obj'
op|'.'
name|'_manager'
op|'='
name|'self'
newline|'\n'
name|'obj'
op|'.'
name|'_auto_update'
op|'='
name|'False'
newline|'\n'
name|'for'
name|'prop'
name|'in'
name|'obj'
op|'.'
name|'properties'
op|'('
name|'hidden'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'prop'
op|'.'
name|'data_type'
op|'!='
name|'Key'
op|':'
newline|'\n'
indent|'                '
name|'v'
op|'='
name|'self'
op|'.'
name|'decode_value'
op|'('
name|'prop'
op|','
name|'d'
op|'['
name|'prop'
op|'.'
name|'name'
op|']'
op|')'
newline|'\n'
name|'v'
op|'='
name|'prop'
op|'.'
name|'make_value_from_datastore'
op|'('
name|'v'
op|')'
newline|'\n'
name|'if'
name|'hasattr'
op|'('
name|'prop'
op|','
string|"'calculated_type'"
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'prop'
op|'.'
name|'_set_direct'
op|'('
name|'obj'
op|','
name|'v'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'not'
name|'prop'
op|'.'
name|'empty'
op|'('
name|'v'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'setattr'
op|'('
name|'obj'
op|','
name|'prop'
op|'.'
name|'name'
op|','
name|'v'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'setattr'
op|'('
name|'obj'
op|','
name|'prop'
op|'.'
name|'name'
op|','
name|'prop'
op|'.'
name|'default_value'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'return'
name|'obj'
newline|'\n'
nl|'\n'
DECL|member|_build_insert_qs
dedent|''
name|'def'
name|'_build_insert_qs'
op|'('
name|'self'
op|','
name|'obj'
op|','
name|'calculated'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'fields'
op|'='
op|'['
op|']'
newline|'\n'
name|'values'
op|'='
op|'['
op|']'
newline|'\n'
name|'templs'
op|'='
op|'['
op|']'
newline|'\n'
name|'id_calculated'
op|'='
op|'['
name|'p'
name|'for'
name|'p'
name|'in'
name|'calculated'
name|'if'
name|'p'
op|'.'
name|'name'
op|'=='
string|"'id'"
op|']'
newline|'\n'
name|'for'
name|'prop'
name|'in'
name|'obj'
op|'.'
name|'properties'
op|'('
name|'hidden'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'prop'
name|'not'
name|'in'
name|'calculated'
op|':'
newline|'\n'
indent|'                '
name|'value'
op|'='
name|'prop'
op|'.'
name|'get_value_for_datastore'
op|'('
name|'obj'
op|')'
newline|'\n'
name|'if'
name|'value'
op|'!='
name|'prop'
op|'.'
name|'default_value'
op|'('
op|')'
name|'or'
name|'prop'
op|'.'
name|'required'
op|':'
newline|'\n'
indent|'                    '
name|'value'
op|'='
name|'self'
op|'.'
name|'encode_value'
op|'('
name|'prop'
op|','
name|'value'
op|')'
newline|'\n'
name|'values'
op|'.'
name|'append'
op|'('
name|'value'
op|')'
newline|'\n'
name|'fields'
op|'.'
name|'append'
op|'('
string|'\'"%s"\''
op|'%'
name|'prop'
op|'.'
name|'name'
op|')'
newline|'\n'
name|'templs'
op|'.'
name|'append'
op|'('
string|"'%s'"
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'qs'
op|'='
string|'\'INSERT INTO "%s" (\''
op|'%'
name|'self'
op|'.'
name|'db_table'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'id_calculated'
op|')'
op|'=='
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'qs'
op|'+='
string|'\'"id",\''
newline|'\n'
dedent|''
name|'qs'
op|'+='
string|"','"
op|'.'
name|'join'
op|'('
name|'fields'
op|')'
newline|'\n'
name|'qs'
op|'+='
string|'") VALUES ("'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'id_calculated'
op|')'
op|'=='
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'qs'
op|'+='
string|'"\'%s\',"'
op|'%'
name|'obj'
op|'.'
name|'id'
newline|'\n'
dedent|''
name|'qs'
op|'+='
string|"','"
op|'.'
name|'join'
op|'('
name|'templs'
op|')'
newline|'\n'
name|'qs'
op|'+='
string|"')'"
newline|'\n'
name|'if'
name|'calculated'
op|':'
newline|'\n'
indent|'            '
name|'qs'
op|'+='
string|"' RETURNING '"
newline|'\n'
name|'calc_values'
op|'='
op|'['
string|'\'"%s"\''
op|'%'
name|'p'
op|'.'
name|'name'
name|'for'
name|'p'
name|'in'
name|'calculated'
op|']'
newline|'\n'
name|'qs'
op|'+='
string|"','"
op|'.'
name|'join'
op|'('
name|'calc_values'
op|')'
newline|'\n'
dedent|''
name|'qs'
op|'+='
string|"';'"
newline|'\n'
name|'return'
name|'qs'
op|','
name|'values'
newline|'\n'
nl|'\n'
DECL|member|_build_update_qs
dedent|''
name|'def'
name|'_build_update_qs'
op|'('
name|'self'
op|','
name|'obj'
op|','
name|'calculated'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'fields'
op|'='
op|'['
op|']'
newline|'\n'
name|'values'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'prop'
name|'in'
name|'obj'
op|'.'
name|'properties'
op|'('
name|'hidden'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'prop'
name|'not'
name|'in'
name|'calculated'
op|':'
newline|'\n'
indent|'                '
name|'value'
op|'='
name|'prop'
op|'.'
name|'get_value_for_datastore'
op|'('
name|'obj'
op|')'
newline|'\n'
name|'if'
name|'value'
op|'!='
name|'prop'
op|'.'
name|'default_value'
op|'('
op|')'
name|'or'
name|'prop'
op|'.'
name|'required'
op|':'
newline|'\n'
indent|'                    '
name|'value'
op|'='
name|'self'
op|'.'
name|'encode_value'
op|'('
name|'prop'
op|','
name|'value'
op|')'
newline|'\n'
name|'values'
op|'.'
name|'append'
op|'('
name|'value'
op|')'
newline|'\n'
name|'field'
op|'='
string|'\'"%s"=\''
op|'%'
name|'prop'
op|'.'
name|'name'
newline|'\n'
name|'field'
op|'+='
string|"'%s'"
newline|'\n'
name|'fields'
op|'.'
name|'append'
op|'('
name|'field'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'qs'
op|'='
string|'\'UPDATE "%s" SET \''
op|'%'
name|'self'
op|'.'
name|'db_table'
newline|'\n'
name|'qs'
op|'+='
string|"','"
op|'.'
name|'join'
op|'('
name|'fields'
op|')'
newline|'\n'
name|'qs'
op|'+='
string|'""" WHERE "id" = \'%s\'"""'
op|'%'
name|'obj'
op|'.'
name|'id'
newline|'\n'
name|'if'
name|'calculated'
op|':'
newline|'\n'
indent|'            '
name|'qs'
op|'+='
string|"' RETURNING '"
newline|'\n'
name|'calc_values'
op|'='
op|'['
string|'\'"%s"\''
op|'%'
name|'p'
op|'.'
name|'name'
name|'for'
name|'p'
name|'in'
name|'calculated'
op|']'
newline|'\n'
name|'qs'
op|'+='
string|"','"
op|'.'
name|'join'
op|'('
name|'calc_values'
op|')'
newline|'\n'
dedent|''
name|'qs'
op|'+='
string|"';'"
newline|'\n'
name|'return'
name|'qs'
op|','
name|'values'
newline|'\n'
nl|'\n'
DECL|member|_get_sql
dedent|''
name|'def'
name|'_get_sql'
op|'('
name|'self'
op|','
name|'mapping'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|"'_get_sql'"
newline|'\n'
name|'sql'
op|'='
name|'None'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'sql_dir'
op|':'
newline|'\n'
indent|'            '
name|'path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'sql_dir'
op|','
name|'self'
op|'.'
name|'cls'
op|'.'
name|'__name__'
op|'+'
string|"'.sql'"
op|')'
newline|'\n'
name|'print'
name|'path'
newline|'\n'
name|'if'
name|'os'
op|'.'
name|'path'
op|'.'
name|'isfile'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'fp'
op|'='
name|'open'
op|'('
name|'path'
op|')'
newline|'\n'
name|'sql'
op|'='
name|'fp'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'fp'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'t'
op|'='
name|'string'
op|'.'
name|'Template'
op|'('
name|'sql'
op|')'
newline|'\n'
name|'sql'
op|'='
name|'t'
op|'.'
name|'safe_substitute'
op|'('
name|'mapping'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'sql'
newline|'\n'
nl|'\n'
DECL|member|start_transaction
dedent|''
name|'def'
name|'start_transaction'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|"'start_transaction'"
newline|'\n'
name|'self'
op|'.'
name|'in_transaction'
op|'='
name|'True'
newline|'\n'
nl|'\n'
DECL|member|end_transaction
dedent|''
name|'def'
name|'end_transaction'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|"'end_transaction'"
newline|'\n'
name|'self'
op|'.'
name|'in_transaction'
op|'='
name|'False'
newline|'\n'
name|'self'
op|'.'
name|'commit'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|commit
dedent|''
name|'def'
name|'commit'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'self'
op|'.'
name|'in_transaction'
op|':'
newline|'\n'
indent|'            '
name|'print'
string|"'!!commit on %s'"
op|'%'
name|'self'
op|'.'
name|'db_table'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'connection'
op|'.'
name|'commit'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'except'
name|'psycopg2'
op|'.'
name|'ProgrammingError'
op|','
name|'err'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'connection'
op|'.'
name|'rollback'
op|'('
op|')'
newline|'\n'
name|'raise'
name|'err'
newline|'\n'
nl|'\n'
DECL|member|rollback
dedent|''
dedent|''
dedent|''
name|'def'
name|'rollback'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|"'!!rollback on %s'"
op|'%'
name|'self'
op|'.'
name|'db_table'
newline|'\n'
name|'self'
op|'.'
name|'connection'
op|'.'
name|'rollback'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|delete_table
dedent|''
name|'def'
name|'delete_table'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'execute'
op|'('
string|'\'DROP TABLE "%s";\''
op|'%'
name|'self'
op|'.'
name|'db_table'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'commit'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|create_table
dedent|''
name|'def'
name|'create_table'
op|'('
name|'self'
op|','
name|'mapping'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'execute'
op|'('
name|'self'
op|'.'
name|'_get_sql'
op|'('
name|'mapping'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'commit'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|encode_value
dedent|''
name|'def'
name|'encode_value'
op|'('
name|'self'
op|','
name|'prop'
op|','
name|'value'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'converter'
op|'.'
name|'encode_prop'
op|'('
name|'prop'
op|','
name|'value'
op|')'
newline|'\n'
nl|'\n'
DECL|member|decode_value
dedent|''
name|'def'
name|'decode_value'
op|'('
name|'self'
op|','
name|'prop'
op|','
name|'value'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'converter'
op|'.'
name|'decode_prop'
op|'('
name|'prop'
op|','
name|'value'
op|')'
newline|'\n'
nl|'\n'
DECL|member|execute_sql
dedent|''
name|'def'
name|'execute_sql'
op|'('
name|'self'
op|','
name|'query'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'execute'
op|'('
name|'query'
op|','
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'commit'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|query_sql
dedent|''
name|'def'
name|'query_sql'
op|'('
name|'self'
op|','
name|'query'
op|','
name|'vars'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'execute'
op|'('
name|'query'
op|','
name|'vars'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'fetchall'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|lookup
dedent|''
name|'def'
name|'lookup'
op|'('
name|'self'
op|','
name|'cls'
op|','
name|'name'
op|','
name|'value'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'values'
op|'='
op|'['
op|']'
newline|'\n'
name|'qs'
op|'='
string|'\'SELECT * FROM "%s" WHERE \''
op|'%'
name|'self'
op|'.'
name|'db_table'
newline|'\n'
name|'found'
op|'='
name|'False'
newline|'\n'
name|'for'
name|'property'
name|'in'
name|'cls'
op|'.'
name|'properties'
op|'('
name|'hidden'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'property'
op|'.'
name|'name'
op|'=='
name|'name'
op|':'
newline|'\n'
indent|'                '
name|'found'
op|'='
name|'True'
newline|'\n'
name|'value'
op|'='
name|'self'
op|'.'
name|'encode_value'
op|'('
name|'property'
op|','
name|'value'
op|')'
newline|'\n'
name|'values'
op|'.'
name|'append'
op|'('
name|'value'
op|')'
newline|'\n'
name|'qs'
op|'+='
string|'"%s="'
op|'%'
name|'name'
newline|'\n'
name|'qs'
op|'+='
string|'"%s"'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'not'
name|'found'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'SDBPersistenceError'
op|'('
string|"'%s is not a valid field'"
op|'%'
name|'name'
op|')'
newline|'\n'
dedent|''
name|'qs'
op|'+='
string|"';'"
newline|'\n'
name|'print'
name|'qs'
newline|'\n'
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'execute'
op|'('
name|'qs'
op|','
name|'values'
op|')'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'rowcount'
op|'=='
number|'1'
op|':'
newline|'\n'
indent|'            '
name|'row'
op|'='
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'fetchone'
op|'('
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'_object_from_row'
op|'('
name|'row'
op|','
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'description'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'rowcount'
op|'=='
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'KeyError'
op|','
string|"'Object not found'"
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'LookupError'
op|','
string|"'Multiple Objects Found'"
newline|'\n'
nl|'\n'
DECL|member|query
dedent|''
dedent|''
name|'def'
name|'query'
op|'('
name|'self'
op|','
name|'cls'
op|','
name|'filters'
op|','
name|'limit'
op|'='
name|'None'
op|','
name|'order_by'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'parts'
op|'='
op|'['
op|']'
newline|'\n'
name|'qs'
op|'='
string|'\'SELECT * FROM "%s"\''
op|'%'
name|'self'
op|'.'
name|'db_table'
newline|'\n'
name|'if'
name|'filters'
op|':'
newline|'\n'
indent|'            '
name|'qs'
op|'+='
string|"' WHERE '"
newline|'\n'
name|'properties'
op|'='
name|'cls'
op|'.'
name|'properties'
op|'('
name|'hidden'
op|'='
name|'False'
op|')'
newline|'\n'
name|'for'
name|'filter'
op|','
name|'value'
name|'in'
name|'filters'
op|':'
newline|'\n'
indent|'                '
name|'name'
op|','
name|'op'
op|'='
name|'filter'
op|'.'
name|'strip'
op|'('
op|')'
op|'.'
name|'split'
op|'('
op|')'
newline|'\n'
name|'found'
op|'='
name|'False'
newline|'\n'
name|'for'
name|'property'
name|'in'
name|'properties'
op|':'
newline|'\n'
indent|'                    '
name|'if'
name|'property'
op|'.'
name|'name'
op|'=='
name|'name'
op|':'
newline|'\n'
indent|'                        '
name|'found'
op|'='
name|'True'
newline|'\n'
name|'value'
op|'='
name|'self'
op|'.'
name|'encode_value'
op|'('
name|'property'
op|','
name|'value'
op|')'
newline|'\n'
name|'parts'
op|'.'
name|'append'
op|'('
string|'""""%s"%s\'%s\'"""'
op|'%'
op|'('
name|'name'
op|','
name|'op'
op|','
name|'value'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'not'
name|'found'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'SDBPersistenceError'
op|'('
string|"'%s is not a valid field'"
op|'%'
name|'name'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'qs'
op|'+='
string|"','"
op|'.'
name|'join'
op|'('
name|'parts'
op|')'
newline|'\n'
dedent|''
name|'qs'
op|'+='
string|"';'"
newline|'\n'
name|'print'
name|'qs'
newline|'\n'
name|'cursor'
op|'='
name|'self'
op|'.'
name|'connection'
op|'.'
name|'cursor'
op|'('
op|')'
newline|'\n'
name|'cursor'
op|'.'
name|'execute'
op|'('
name|'qs'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'_object_lister'
op|'('
name|'cursor'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_property
dedent|''
name|'def'
name|'get_property'
op|'('
name|'self'
op|','
name|'prop'
op|','
name|'obj'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'qs'
op|'='
string|'"""SELECT "%s" FROM "%s" WHERE id=\'%s\';"""'
op|'%'
op|'('
name|'name'
op|','
name|'self'
op|'.'
name|'db_table'
op|','
name|'obj'
op|'.'
name|'id'
op|')'
newline|'\n'
name|'print'
name|'qs'
newline|'\n'
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'execute'
op|'('
name|'qs'
op|','
name|'None'
op|')'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'rowcount'
op|'=='
number|'1'
op|':'
newline|'\n'
indent|'            '
name|'rs'
op|'='
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'fetchone'
op|'('
op|')'
newline|'\n'
name|'for'
name|'prop'
name|'in'
name|'obj'
op|'.'
name|'properties'
op|'('
name|'hidden'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'prop'
op|'.'
name|'name'
op|'=='
name|'name'
op|':'
newline|'\n'
indent|'                    '
name|'v'
op|'='
name|'self'
op|'.'
name|'decode_value'
op|'('
name|'prop'
op|','
name|'rs'
op|'['
number|'0'
op|']'
op|')'
newline|'\n'
name|'return'
name|'v'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'raise'
name|'AttributeError'
op|','
string|"'%s not found'"
op|'%'
name|'name'
newline|'\n'
nl|'\n'
DECL|member|set_property
dedent|''
name|'def'
name|'set_property'
op|'('
name|'self'
op|','
name|'prop'
op|','
name|'obj'
op|','
name|'name'
op|','
name|'value'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'pass'
newline|'\n'
name|'value'
op|'='
name|'self'
op|'.'
name|'encode_value'
op|'('
name|'prop'
op|','
name|'value'
op|')'
newline|'\n'
name|'qs'
op|'='
string|'\'UPDATE "%s" SET \''
op|'%'
name|'self'
op|'.'
name|'db_table'
newline|'\n'
name|'qs'
op|'+='
string|'"%s=\'%s\'"'
op|'%'
op|'('
name|'name'
op|','
name|'self'
op|'.'
name|'encode_value'
op|'('
name|'prop'
op|','
name|'value'
op|')'
op|')'
newline|'\n'
name|'qs'
op|'+='
string|'" WHERE id=\'%s\'"'
op|'%'
name|'obj'
op|'.'
name|'id'
newline|'\n'
name|'qs'
op|'+='
string|"';'"
newline|'\n'
name|'print'
name|'qs'
newline|'\n'
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'execute'
op|'('
name|'qs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'commit'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_object
dedent|''
name|'def'
name|'get_object'
op|'('
name|'self'
op|','
name|'cls'
op|','
name|'id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'qs'
op|'='
string|'"""SELECT * FROM "%s" WHERE id=\'%s\';"""'
op|'%'
op|'('
name|'self'
op|'.'
name|'db_table'
op|','
name|'id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'execute'
op|'('
name|'qs'
op|','
name|'None'
op|')'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'rowcount'
op|'=='
number|'1'
op|':'
newline|'\n'
indent|'            '
name|'row'
op|'='
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'fetchone'
op|'('
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'_object_from_row'
op|'('
name|'row'
op|','
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'description'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'SDBPersistenceError'
op|'('
string|"'%s object with id=%s does not exist'"
op|'%'
op|'('
name|'cls'
op|'.'
name|'__name__'
op|','
name|'id'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_object_from_id
dedent|''
dedent|''
name|'def'
name|'get_object_from_id'
op|'('
name|'self'
op|','
name|'id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'get_object'
op|'('
name|'self'
op|'.'
name|'cls'
op|','
name|'id'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_find_calculated_props
dedent|''
name|'def'
name|'_find_calculated_props'
op|'('
name|'self'
op|','
name|'obj'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
op|'['
name|'p'
name|'for'
name|'p'
name|'in'
name|'obj'
op|'.'
name|'properties'
op|'('
op|')'
name|'if'
name|'hasattr'
op|'('
name|'p'
op|','
string|"'calculated_type'"
op|')'
op|']'
newline|'\n'
nl|'\n'
DECL|member|save_object
dedent|''
name|'def'
name|'save_object'
op|'('
name|'self'
op|','
name|'obj'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'obj'
op|'.'
name|'_auto_update'
op|'='
name|'False'
newline|'\n'
name|'calculated'
op|'='
name|'self'
op|'.'
name|'_find_calculated_props'
op|'('
name|'obj'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'obj'
op|'.'
name|'id'
op|':'
newline|'\n'
indent|'            '
name|'obj'
op|'.'
name|'id'
op|'='
name|'str'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|')'
newline|'\n'
name|'qs'
op|','
name|'values'
op|'='
name|'self'
op|'.'
name|'_build_insert_qs'
op|'('
name|'obj'
op|','
name|'calculated'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'qs'
op|','
name|'values'
op|'='
name|'self'
op|'.'
name|'_build_update_qs'
op|'('
name|'obj'
op|','
name|'calculated'
op|')'
newline|'\n'
dedent|''
name|'print'
name|'qs'
newline|'\n'
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'execute'
op|'('
name|'qs'
op|','
name|'values'
op|')'
newline|'\n'
name|'if'
name|'calculated'
op|':'
newline|'\n'
indent|'            '
name|'calc_values'
op|'='
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'fetchone'
op|'('
op|')'
newline|'\n'
name|'print'
name|'calculated'
newline|'\n'
name|'print'
name|'calc_values'
newline|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
number|'0'
op|','
name|'len'
op|'('
name|'calculated'
op|')'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'prop'
op|'='
name|'calculated'
op|'['
name|'i'
op|']'
newline|'\n'
name|'prop'
op|'.'
name|'_set_direct'
op|'('
name|'obj'
op|','
name|'calc_values'
op|'['
name|'i'
op|']'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'commit'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|delete_object
dedent|''
name|'def'
name|'delete_object'
op|'('
name|'self'
op|','
name|'obj'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'qs'
op|'='
string|'"""DELETE FROM "%s" WHERE id=\'%s\';"""'
op|'%'
op|'('
name|'self'
op|'.'
name|'db_table'
op|','
name|'obj'
op|'.'
name|'id'
op|')'
newline|'\n'
name|'print'
name|'qs'
newline|'\n'
name|'self'
op|'.'
name|'cursor'
op|'.'
name|'execute'
op|'('
name|'qs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'commit'
op|'('
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
