begin_unit
comment|'#!/usr/bin/env python'
nl|'\n'
comment|'# Copyright (c) 2006,2007 Mitch Garnaat http://garnaat.org/'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Permission is hereby granted, free of charge, to any person obtaining a'
nl|'\n'
comment|'# copy of this software and associated documentation files (the'
nl|'\n'
comment|'# "Software"), to deal in the Software without restriction, including'
nl|'\n'
comment|'# without limitation the rights to use, copy, modify, merge, publish, dis-'
nl|'\n'
comment|'# tribute, sublicense, and/or sell copies of the Software, and to permit'
nl|'\n'
comment|'# persons to whom the Software is furnished to do so, subject to the fol-'
nl|'\n'
comment|'# lowing conditions:'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# The above copyright notice and this permission notice shall be included'
nl|'\n'
comment|'# in all copies or substantial portions of the Software.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS'
nl|'\n'
comment|'# OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABIL-'
nl|'\n'
comment|'# ITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT'
nl|'\n'
comment|'# SHALL THE AUTHOR BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, '
nl|'\n'
comment|'# WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,'
nl|'\n'
comment|'# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS'
nl|'\n'
comment|'# IN THE SOFTWARE.'
nl|'\n'
comment|'#'
nl|'\n'
name|'import'
name|'getopt'
newline|'\n'
name|'import'
name|'sys'
newline|'\n'
name|'import'
name|'imp'
newline|'\n'
name|'import'
name|'time'
newline|'\n'
name|'import'
name|'boto'
newline|'\n'
nl|'\n'
name|'usage_string'
op|'='
string|'"""\nSYNOPSIS\n    launch_ami.py -a ami_id [-b script_bucket] [-s script_name]\n                  [-m module] [-c class_name] [-r] \n                  [-g group] [-k key_name] [-n num_instances]\n                  [-w] [extra_data]\n    Where:\n        ami_id - the id of the AMI you wish to launch\n        module - The name of the Python module containing the class you\n                 want to run when the instance is started.  If you use this\n                 option the Python module must already be stored on the\n                 instance in a location that is on the Python path.\n        script_file - The name of a local Python module that you would like\n                      to have copied to S3 and then run on the instance\n                      when it is started.  The specified module must be\n                      import\'able (i.e. in your local Python path).  It\n                      will then be copied to the specified bucket in S3\n                      (see the -b option).  Once the new instance(s)\n                      start up the script will be copied from S3 and then\n                      run locally on the instance.\n        class_name - The name of the class to be instantiated within the\n                     module or script file specified.\n        script_bucket - the name of the bucket in which the script will be\n                        stored\n        group - the name of the security group the instance will run in\n        key_name - the name of the keypair to use when launching the AMI\n        num_instances - how many instances of the AMI to launch (default 1)\n        input_queue_name - Name of SQS to read input messages from\n        output_queue_name - Name of SQS to write output messages to\n        extra_data - additional name-value pairs that will be passed as\n                     userdata to the newly launched instance.  These should\n                     be of the form "name=value"\n        The -r option reloads the Python module to S3 without launching\n        another instance.  This can be useful during debugging to allow\n        you to test a new version of your script without shutting down\n        your instance and starting up another one.\n        The -w option tells the script to run synchronously, meaning to\n        wait until the instance is actually up and running.  It then prints\n        the IP address and internal and external DNS names before exiting.\n"""'
newline|'\n'
nl|'\n'
DECL|function|usage
name|'def'
name|'usage'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'print'
name|'usage_string'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|main
dedent|''
name|'def'
name|'main'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'opts'
op|','
name|'args'
op|'='
name|'getopt'
op|'.'
name|'getopt'
op|'('
name|'sys'
op|'.'
name|'argv'
op|'['
number|'1'
op|':'
op|']'
op|','
string|"'a:b:c:g:hi:k:m:n:o:rs:w'"
op|','
nl|'\n'
op|'['
string|"'ami'"
op|','
string|"'bucket'"
op|','
string|"'class'"
op|','
string|"'group'"
op|','
string|"'help'"
op|','
nl|'\n'
string|"'inputqueue'"
op|','
string|"'keypair'"
op|','
string|"'module'"
op|','
nl|'\n'
string|"'numinstances'"
op|','
string|"'outputqueue'"
op|','
nl|'\n'
string|"'reload'"
op|','
string|"'script_name'"
op|','
string|"'wait'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'        '
name|'usage'
op|'('
op|')'
newline|'\n'
dedent|''
name|'params'
op|'='
op|'{'
string|"'module_name'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'script_name'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'class_name'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'script_bucket'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'group'"
op|':'
string|"'default'"
op|','
nl|'\n'
string|"'keypair'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'ami'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'num_instances'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'input_queue_name'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'output_queue_name'"
op|':'
name|'None'
op|'}'
newline|'\n'
name|'reload'
op|'='
name|'None'
newline|'\n'
name|'wait'
op|'='
name|'None'
newline|'\n'
name|'for'
name|'o'
op|','
name|'a'
name|'in'
name|'opts'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'o'
name|'in'
op|'('
string|"'-a'"
op|','
string|"'--ami'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'params'
op|'['
string|"'ami'"
op|']'
op|'='
name|'a'
newline|'\n'
dedent|''
name|'if'
name|'o'
name|'in'
op|'('
string|"'-b'"
op|','
string|"'--bucket'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'params'
op|'['
string|"'script_bucket'"
op|']'
op|'='
name|'a'
newline|'\n'
dedent|''
name|'if'
name|'o'
name|'in'
op|'('
string|"'-c'"
op|','
string|"'--class'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'params'
op|'['
string|"'class_name'"
op|']'
op|'='
name|'a'
newline|'\n'
dedent|''
name|'if'
name|'o'
name|'in'
op|'('
string|"'-g'"
op|','
string|"'--group'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'params'
op|'['
string|"'group'"
op|']'
op|'='
name|'a'
newline|'\n'
dedent|''
name|'if'
name|'o'
name|'in'
op|'('
string|"'-h'"
op|','
string|"'--help'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'usage'
op|'('
op|')'
newline|'\n'
dedent|''
name|'if'
name|'o'
name|'in'
op|'('
string|"'-i'"
op|','
string|"'--inputqueue'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'params'
op|'['
string|"'input_queue_name'"
op|']'
op|'='
name|'a'
newline|'\n'
dedent|''
name|'if'
name|'o'
name|'in'
op|'('
string|"'-k'"
op|','
string|"'--keypair'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'params'
op|'['
string|"'keypair'"
op|']'
op|'='
name|'a'
newline|'\n'
dedent|''
name|'if'
name|'o'
name|'in'
op|'('
string|"'-m'"
op|','
string|"'--module'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'params'
op|'['
string|"'module_name'"
op|']'
op|'='
name|'a'
newline|'\n'
dedent|''
name|'if'
name|'o'
name|'in'
op|'('
string|"'-n'"
op|','
string|"'--num_instances'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'params'
op|'['
string|"'num_instances'"
op|']'
op|'='
name|'int'
op|'('
name|'a'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'o'
name|'in'
op|'('
string|"'-o'"
op|','
string|"'--outputqueue'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'params'
op|'['
string|"'output_queue_name'"
op|']'
op|'='
name|'a'
newline|'\n'
dedent|''
name|'if'
name|'o'
name|'in'
op|'('
string|"'-r'"
op|','
string|"'--reload'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'reload'
op|'='
name|'True'
newline|'\n'
dedent|''
name|'if'
name|'o'
name|'in'
op|'('
string|"'-s'"
op|','
string|"'--script'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'params'
op|'['
string|"'script_name'"
op|']'
op|'='
name|'a'
newline|'\n'
dedent|''
name|'if'
name|'o'
name|'in'
op|'('
string|"'-w'"
op|','
string|"'--wait'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'wait'
op|'='
name|'True'
newline|'\n'
nl|'\n'
comment|'# check required fields'
nl|'\n'
dedent|''
dedent|''
name|'required'
op|'='
op|'['
string|"'ami'"
op|']'
newline|'\n'
name|'for'
name|'pname'
name|'in'
name|'required'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'params'
op|'.'
name|'get'
op|'('
name|'pname'
op|','
name|'None'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'print'
string|"'%s is required'"
op|'%'
name|'pname'
newline|'\n'
name|'usage'
op|'('
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'params'
op|'['
string|"'script_name'"
op|']'
op|':'
newline|'\n'
comment|'# first copy the desired module file to S3 bucket'
nl|'\n'
indent|'        '
name|'if'
name|'reload'
op|':'
newline|'\n'
indent|'            '
name|'print'
string|"'Reloading module %s to S3'"
op|'%'
name|'params'
op|'['
string|"'script_name'"
op|']'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'print'
string|"'Copying module %s to S3'"
op|'%'
name|'params'
op|'['
string|"'script_name'"
op|']'
newline|'\n'
dedent|''
name|'l'
op|'='
name|'imp'
op|'.'
name|'find_module'
op|'('
name|'params'
op|'['
string|"'script_name'"
op|']'
op|')'
newline|'\n'
name|'c'
op|'='
name|'boto'
op|'.'
name|'connect_s3'
op|'('
op|')'
newline|'\n'
name|'bucket'
op|'='
name|'c'
op|'.'
name|'get_bucket'
op|'('
name|'params'
op|'['
string|"'script_bucket'"
op|']'
op|')'
newline|'\n'
name|'key'
op|'='
name|'bucket'
op|'.'
name|'new_key'
op|'('
name|'params'
op|'['
string|"'script_name'"
op|']'
op|'+'
string|"'.py'"
op|')'
newline|'\n'
name|'key'
op|'.'
name|'set_contents_from_file'
op|'('
name|'l'
op|'['
number|'0'
op|']'
op|')'
newline|'\n'
name|'params'
op|'['
string|"'script_md5'"
op|']'
op|'='
name|'key'
op|'.'
name|'md5'
newline|'\n'
comment|'# we have everything we need, now build userdata string'
nl|'\n'
dedent|''
name|'l'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'k'
op|','
name|'v'
name|'in'
name|'params'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'v'
op|':'
newline|'\n'
indent|'            '
name|'l'
op|'.'
name|'append'
op|'('
string|"'%s=%s'"
op|'%'
op|'('
name|'k'
op|','
name|'v'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'c'
op|'='
name|'boto'
op|'.'
name|'connect_ec2'
op|'('
op|')'
newline|'\n'
name|'l'
op|'.'
name|'append'
op|'('
string|"'aws_access_key_id=%s'"
op|'%'
name|'c'
op|'.'
name|'aws_access_key_id'
op|')'
newline|'\n'
name|'l'
op|'.'
name|'append'
op|'('
string|"'aws_secret_access_key=%s'"
op|'%'
name|'c'
op|'.'
name|'aws_secret_access_key'
op|')'
newline|'\n'
name|'for'
name|'kv'
name|'in'
name|'args'
op|':'
newline|'\n'
indent|'        '
name|'l'
op|'.'
name|'append'
op|'('
name|'kv'
op|')'
newline|'\n'
dedent|''
name|'s'
op|'='
string|"'|'"
op|'.'
name|'join'
op|'('
name|'l'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'reload'
op|':'
newline|'\n'
indent|'        '
name|'rs'
op|'='
name|'c'
op|'.'
name|'get_all_images'
op|'('
op|'['
name|'params'
op|'['
string|"'ami'"
op|']'
op|']'
op|')'
newline|'\n'
name|'img'
op|'='
name|'rs'
op|'['
number|'0'
op|']'
newline|'\n'
name|'r'
op|'='
name|'img'
op|'.'
name|'run'
op|'('
name|'user_data'
op|'='
name|'s'
op|','
name|'key_name'
op|'='
name|'params'
op|'['
string|"'keypair'"
op|']'
op|','
nl|'\n'
name|'security_groups'
op|'='
op|'['
name|'params'
op|'['
string|"'group'"
op|']'
op|']'
op|','
nl|'\n'
name|'max_count'
op|'='
name|'params'
op|'.'
name|'get'
op|'('
string|"'num_instances'"
op|','
number|'1'
op|')'
op|')'
newline|'\n'
name|'print'
string|"'AMI: %s - %s (Started)'"
op|'%'
op|'('
name|'params'
op|'['
string|"'ami'"
op|']'
op|','
name|'img'
op|'.'
name|'location'
op|')'
newline|'\n'
name|'print'
string|"'Reservation %s contains the following instances:'"
op|'%'
name|'r'
op|'.'
name|'id'
newline|'\n'
name|'for'
name|'i'
name|'in'
name|'r'
op|'.'
name|'instances'
op|':'
newline|'\n'
indent|'            '
name|'print'
string|"'\\t%s'"
op|'%'
name|'i'
op|'.'
name|'id'
newline|'\n'
dedent|''
name|'if'
name|'wait'
op|':'
newline|'\n'
indent|'            '
name|'running'
op|'='
name|'False'
newline|'\n'
name|'while'
name|'not'
name|'running'
op|':'
newline|'\n'
indent|'                '
name|'time'
op|'.'
name|'sleep'
op|'('
number|'30'
op|')'
newline|'\n'
op|'['
name|'i'
op|'.'
name|'update'
op|'('
op|')'
name|'for'
name|'i'
name|'in'
name|'r'
op|'.'
name|'instances'
op|']'
newline|'\n'
name|'status'
op|'='
op|'['
name|'i'
op|'.'
name|'state'
name|'for'
name|'i'
name|'in'
name|'r'
op|'.'
name|'instances'
op|']'
newline|'\n'
name|'print'
name|'status'
newline|'\n'
name|'if'
name|'status'
op|'.'
name|'count'
op|'('
string|"'running'"
op|')'
op|'=='
name|'len'
op|'('
name|'r'
op|'.'
name|'instances'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'running'
op|'='
name|'True'
newline|'\n'
dedent|''
dedent|''
name|'for'
name|'i'
name|'in'
name|'r'
op|'.'
name|'instances'
op|':'
newline|'\n'
indent|'                '
name|'print'
string|"'Instance: %s'"
op|'%'
name|'i'
op|'.'
name|'ami_launch_index'
newline|'\n'
name|'print'
string|"'Public DNS Name: %s'"
op|'%'
name|'i'
op|'.'
name|'public_dns_name'
newline|'\n'
name|'print'
string|"'Private DNS Name: %s'"
op|'%'
name|'i'
op|'.'
name|'private_dns_name'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
dedent|''
name|'if'
name|'__name__'
op|'=='
string|'"__main__"'
op|':'
newline|'\n'
indent|'    '
name|'main'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
endmarker|''
end_unit
