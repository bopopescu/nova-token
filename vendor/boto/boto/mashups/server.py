begin_unit
comment|'# Copyright (c) 2006,2007 Mitch Garnaat http://garnaat.org/'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Permission is hereby granted, free of charge, to any person obtaining a'
nl|'\n'
comment|'# copy of this software and associated documentation files (the'
nl|'\n'
comment|'# "Software"), to deal in the Software without restriction, including'
nl|'\n'
comment|'# without limitation the rights to use, copy, modify, merge, publish, dis-'
nl|'\n'
comment|'# tribute, sublicense, and/or sell copies of the Software, and to permit'
nl|'\n'
comment|'# persons to whom the Software is furnished to do so, subject to the fol-'
nl|'\n'
comment|'# lowing conditions:'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# The above copyright notice and this permission notice shall be included'
nl|'\n'
comment|'# in all copies or substantial portions of the Software.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS'
nl|'\n'
comment|'# OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABIL-'
nl|'\n'
comment|'# ITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT'
nl|'\n'
comment|'# SHALL THE AUTHOR BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, '
nl|'\n'
comment|'# WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,'
nl|'\n'
comment|'# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS'
nl|'\n'
comment|'# IN THE SOFTWARE.'
nl|'\n'
nl|'\n'
string|'"""\nHigh-level abstraction of an EC2 server\n"""'
newline|'\n'
name|'import'
name|'boto'
newline|'\n'
name|'import'
name|'boto'
op|'.'
name|'utils'
newline|'\n'
name|'from'
name|'boto'
op|'.'
name|'mashups'
op|'.'
name|'iobject'
name|'import'
name|'IObject'
newline|'\n'
name|'from'
name|'boto'
op|'.'
name|'pyami'
op|'.'
name|'config'
name|'import'
name|'Config'
op|','
name|'BotoConfigPath'
newline|'\n'
name|'from'
name|'boto'
op|'.'
name|'mashups'
op|'.'
name|'interactive'
name|'import'
name|'interactive_shell'
newline|'\n'
name|'from'
name|'boto'
op|'.'
name|'sdb'
op|'.'
name|'db'
op|'.'
name|'model'
name|'import'
name|'Model'
newline|'\n'
name|'from'
name|'boto'
op|'.'
name|'sdb'
op|'.'
name|'db'
op|'.'
name|'property'
name|'import'
name|'StringProperty'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'StringIO'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ServerSet
name|'class'
name|'ServerSet'
op|'('
name|'list'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|__getattr__
indent|'    '
name|'def'
name|'__getattr__'
op|'('
name|'self'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'results'
op|'='
op|'['
op|']'
newline|'\n'
name|'is_callable'
op|'='
name|'False'
newline|'\n'
name|'for'
name|'server'
name|'in'
name|'self'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'val'
op|'='
name|'getattr'
op|'('
name|'server'
op|','
name|'name'
op|')'
newline|'\n'
name|'if'
name|'callable'
op|'('
name|'val'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'is_callable'
op|'='
name|'True'
newline|'\n'
dedent|''
name|'results'
op|'.'
name|'append'
op|'('
name|'val'
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'                '
name|'results'
op|'.'
name|'append'
op|'('
name|'None'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'is_callable'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'map_list'
op|'='
name|'results'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'map'
newline|'\n'
dedent|''
name|'return'
name|'results'
newline|'\n'
nl|'\n'
DECL|member|map
dedent|''
name|'def'
name|'map'
op|'('
name|'self'
op|','
op|'*'
name|'args'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'results'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'fn'
name|'in'
name|'self'
op|'.'
name|'map_list'
op|':'
newline|'\n'
indent|'            '
name|'results'
op|'.'
name|'append'
op|'('
name|'fn'
op|'('
op|'*'
name|'args'
op|')'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'results'
newline|'\n'
nl|'\n'
DECL|class|Server
dedent|''
dedent|''
name|'class'
name|'Server'
op|'('
name|'Model'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'    '
op|'@'
name|'property'
newline|'\n'
DECL|member|ec2
name|'def'
name|'ec2'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'_ec2'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_ec2'
op|'='
name|'boto'
op|'.'
name|'connect_ec2'
op|'('
op|')'
newline|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'_ec2'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'classmethod'
newline|'\n'
DECL|member|Inventory
name|'def'
name|'Inventory'
op|'('
name|'cls'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Returns a list of Server instances, one for each Server object\n        persisted in the db\n        """'
newline|'\n'
name|'l'
op|'='
name|'ServerSet'
op|'('
op|')'
newline|'\n'
name|'rs'
op|'='
name|'cls'
op|'.'
name|'find'
op|'('
op|')'
newline|'\n'
name|'for'
name|'server'
name|'in'
name|'rs'
op|':'
newline|'\n'
indent|'            '
name|'l'
op|'.'
name|'append'
op|'('
name|'server'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'l'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'classmethod'
newline|'\n'
DECL|member|Register
name|'def'
name|'Register'
op|'('
name|'cls'
op|','
name|'name'
op|','
name|'instance_id'
op|','
name|'description'
op|'='
string|"''"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'s'
op|'='
name|'cls'
op|'('
op|')'
newline|'\n'
name|'s'
op|'.'
name|'name'
op|'='
name|'name'
newline|'\n'
name|'s'
op|'.'
name|'instance_id'
op|'='
name|'instance_id'
newline|'\n'
name|'s'
op|'.'
name|'description'
op|'='
name|'description'
newline|'\n'
name|'s'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'return'
name|'s'
newline|'\n'
nl|'\n'
DECL|member|__init__
dedent|''
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'id'
op|'='
name|'None'
op|','
op|'**'
name|'kw'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'Model'
op|'.'
name|'__init__'
op|'('
name|'self'
op|','
name|'id'
op|','
op|'**'
name|'kw'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_reservation'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'_instance'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'_ssh_client'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'_pkey'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'_config'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'_ec2'
op|'='
name|'None'
newline|'\n'
nl|'\n'
DECL|variable|name
dedent|''
name|'name'
op|'='
name|'StringProperty'
op|'('
name|'unique'
op|'='
name|'True'
op|','
name|'verbose_name'
op|'='
string|'"Name"'
op|')'
newline|'\n'
DECL|variable|instance_id
name|'instance_id'
op|'='
name|'StringProperty'
op|'('
name|'verbose_name'
op|'='
string|'"Instance ID"'
op|')'
newline|'\n'
DECL|variable|config_uri
name|'config_uri'
op|'='
name|'StringProperty'
op|'('
op|')'
newline|'\n'
DECL|variable|ami_id
name|'ami_id'
op|'='
name|'StringProperty'
op|'('
name|'verbose_name'
op|'='
string|'"AMI ID"'
op|')'
newline|'\n'
DECL|variable|zone
name|'zone'
op|'='
name|'StringProperty'
op|'('
name|'verbose_name'
op|'='
string|'"Availability Zone"'
op|')'
newline|'\n'
DECL|variable|security_group
name|'security_group'
op|'='
name|'StringProperty'
op|'('
name|'verbose_name'
op|'='
string|'"Security Group"'
op|','
name|'default'
op|'='
string|'"default"'
op|')'
newline|'\n'
DECL|variable|key_name
name|'key_name'
op|'='
name|'StringProperty'
op|'('
name|'verbose_name'
op|'='
string|'"Key Name"'
op|')'
newline|'\n'
DECL|variable|elastic_ip
name|'elastic_ip'
op|'='
name|'StringProperty'
op|'('
name|'verbose_name'
op|'='
string|'"Elastic IP"'
op|')'
newline|'\n'
DECL|variable|instance_type
name|'instance_type'
op|'='
name|'StringProperty'
op|'('
name|'verbose_name'
op|'='
string|'"Instance Type"'
op|')'
newline|'\n'
DECL|variable|description
name|'description'
op|'='
name|'StringProperty'
op|'('
name|'verbose_name'
op|'='
string|'"Description"'
op|')'
newline|'\n'
DECL|variable|log
name|'log'
op|'='
name|'StringProperty'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|setReadOnly
name|'def'
name|'setReadOnly'
op|'('
name|'self'
op|','
name|'value'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'AttributeError'
newline|'\n'
nl|'\n'
DECL|member|getInstance
dedent|''
name|'def'
name|'getInstance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'self'
op|'.'
name|'_instance'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'self'
op|'.'
name|'instance_id'
op|':'
newline|'\n'
indent|'                '
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'rs'
op|'='
name|'self'
op|'.'
name|'ec2'
op|'.'
name|'get_all_instances'
op|'('
op|'['
name|'self'
op|'.'
name|'instance_id'
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'                    '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'rs'
op|')'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'_reservation'
op|'='
name|'rs'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'_instance'
op|'='
name|'self'
op|'.'
name|'_reservation'
op|'.'
name|'instances'
op|'['
number|'0'
op|']'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'return'
name|'self'
op|'.'
name|'_instance'
newline|'\n'
nl|'\n'
DECL|variable|instance
dedent|''
name|'instance'
op|'='
name|'property'
op|'('
name|'getInstance'
op|','
name|'setReadOnly'
op|','
name|'None'
op|','
string|"'The Instance for the server'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|getAMI
name|'def'
name|'getAMI'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'instance'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'instance'
op|'.'
name|'image_id'
newline|'\n'
nl|'\n'
DECL|variable|ami
dedent|''
dedent|''
name|'ami'
op|'='
name|'property'
op|'('
name|'getAMI'
op|','
name|'setReadOnly'
op|','
name|'None'
op|','
string|"'The AMI for the server'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|getStatus
name|'def'
name|'getStatus'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'instance'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'instance'
op|'.'
name|'update'
op|'('
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'instance'
op|'.'
name|'state'
newline|'\n'
nl|'\n'
DECL|variable|status
dedent|''
dedent|''
name|'status'
op|'='
name|'property'
op|'('
name|'getStatus'
op|','
name|'setReadOnly'
op|','
name|'None'
op|','
nl|'\n'
string|"'The status of the server'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|getHostname
name|'def'
name|'getHostname'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'instance'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'instance'
op|'.'
name|'public_dns_name'
newline|'\n'
nl|'\n'
DECL|variable|hostname
dedent|''
dedent|''
name|'hostname'
op|'='
name|'property'
op|'('
name|'getHostname'
op|','
name|'setReadOnly'
op|','
name|'None'
op|','
nl|'\n'
string|"'The public DNS name of the server'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|getPrivateHostname
name|'def'
name|'getPrivateHostname'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'instance'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'instance'
op|'.'
name|'private_dns_name'
newline|'\n'
nl|'\n'
DECL|variable|private_hostname
dedent|''
dedent|''
name|'private_hostname'
op|'='
name|'property'
op|'('
name|'getPrivateHostname'
op|','
name|'setReadOnly'
op|','
name|'None'
op|','
nl|'\n'
string|"'The private DNS name of the server'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|getLaunchTime
name|'def'
name|'getLaunchTime'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'instance'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'instance'
op|'.'
name|'launch_time'
newline|'\n'
nl|'\n'
DECL|variable|launch_time
dedent|''
dedent|''
name|'launch_time'
op|'='
name|'property'
op|'('
name|'getLaunchTime'
op|','
name|'setReadOnly'
op|','
name|'None'
op|','
nl|'\n'
string|"'The time the Server was started'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|getConsoleOutput
name|'def'
name|'getConsoleOutput'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'instance'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'instance'
op|'.'
name|'get_console_output'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|variable|console_output
dedent|''
dedent|''
name|'console_output'
op|'='
name|'property'
op|'('
name|'getConsoleOutput'
op|','
name|'setReadOnly'
op|','
name|'None'
op|','
nl|'\n'
string|"'Retrieve the console output for server'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|getGroups
name|'def'
name|'getGroups'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'_reservation'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'_reservation'
op|'.'
name|'groups'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
nl|'\n'
DECL|variable|groups
dedent|''
dedent|''
name|'groups'
op|'='
name|'property'
op|'('
name|'getGroups'
op|','
name|'setReadOnly'
op|','
name|'None'
op|','
nl|'\n'
string|"'The Security Groups controlling access to this server'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|getConfig
name|'def'
name|'getConfig'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'self'
op|'.'
name|'_config'
op|':'
newline|'\n'
indent|'            '
name|'remote_file'
op|'='
name|'BotoConfigPath'
newline|'\n'
name|'local_file'
op|'='
string|"'%s.ini'"
op|'%'
name|'self'
op|'.'
name|'instance'
op|'.'
name|'id'
newline|'\n'
name|'self'
op|'.'
name|'get_file'
op|'('
name|'remote_file'
op|','
name|'local_file'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_config'
op|'='
name|'Config'
op|'('
name|'local_file'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'_config'
newline|'\n'
nl|'\n'
DECL|member|setConfig
dedent|''
name|'def'
name|'setConfig'
op|'('
name|'self'
op|','
name|'config'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'local_file'
op|'='
string|"'%s.ini'"
op|'%'
name|'self'
op|'.'
name|'instance'
op|'.'
name|'id'
newline|'\n'
name|'fp'
op|'='
name|'open'
op|'('
name|'local_file'
op|')'
newline|'\n'
name|'config'
op|'.'
name|'write'
op|'('
name|'fp'
op|')'
newline|'\n'
name|'fp'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'put_file'
op|'('
name|'local_file'
op|','
name|'BotoConfigPath'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_config'
op|'='
name|'config'
newline|'\n'
nl|'\n'
DECL|variable|config
dedent|''
name|'config'
op|'='
name|'property'
op|'('
name|'getConfig'
op|','
name|'setConfig'
op|','
name|'None'
op|','
nl|'\n'
string|"'The instance data for this server'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|set_config
name|'def'
name|'set_config'
op|'('
name|'self'
op|','
name|'config'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Set SDB based config\n        """'
newline|'\n'
name|'self'
op|'.'
name|'_config'
op|'='
name|'config'
newline|'\n'
name|'self'
op|'.'
name|'_config'
op|'.'
name|'dump_to_sdb'
op|'('
string|'"botoConfigs"'
op|','
name|'self'
op|'.'
name|'id'
op|')'
newline|'\n'
nl|'\n'
DECL|member|load_config
dedent|''
name|'def'
name|'load_config'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_config'
op|'='
name|'Config'
op|'('
name|'do_load'
op|'='
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_config'
op|'.'
name|'load_from_sdb'
op|'('
string|'"botoConfigs"'
op|','
name|'self'
op|'.'
name|'id'
op|')'
newline|'\n'
nl|'\n'
DECL|member|stop
dedent|''
name|'def'
name|'stop'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'instance'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'instance'
op|'.'
name|'stop'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|start
dedent|''
dedent|''
name|'def'
name|'start'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'stop'
op|'('
op|')'
newline|'\n'
name|'ec2'
op|'='
name|'boto'
op|'.'
name|'connect_ec2'
op|'('
op|')'
newline|'\n'
name|'ami'
op|'='
name|'ec2'
op|'.'
name|'get_all_images'
op|'('
name|'image_ids'
op|'='
op|'['
name|'str'
op|'('
name|'self'
op|'.'
name|'ami_id'
op|')'
op|']'
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'groups'
op|'='
name|'ec2'
op|'.'
name|'get_all_security_groups'
op|'('
name|'groupnames'
op|'='
op|'['
name|'str'
op|'('
name|'self'
op|'.'
name|'security_group'
op|')'
op|']'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'self'
op|'.'
name|'_config'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'load_config'
op|'('
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'self'
op|'.'
name|'_config'
op|'.'
name|'has_section'
op|'('
string|'"Credentials"'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_config'
op|'.'
name|'add_section'
op|'('
string|'"Credentials"'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_config'
op|'.'
name|'set'
op|'('
string|'"Credentials"'
op|','
string|'"aws_access_key_id"'
op|','
name|'ec2'
op|'.'
name|'aws_access_key_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_config'
op|'.'
name|'set'
op|'('
string|'"Credentials"'
op|','
string|'"aws_secret_access_key"'
op|','
name|'ec2'
op|'.'
name|'aws_secret_access_key'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'not'
name|'self'
op|'.'
name|'_config'
op|'.'
name|'has_section'
op|'('
string|'"Pyami"'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_config'
op|'.'
name|'add_section'
op|'('
string|'"Pyami"'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'self'
op|'.'
name|'_manager'
op|'.'
name|'domain'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_config'
op|'.'
name|'set'
op|'('
string|"'Pyami'"
op|','
string|"'server_sdb_domain'"
op|','
name|'self'
op|'.'
name|'_manager'
op|'.'
name|'domain'
op|'.'
name|'name'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_config'
op|'.'
name|'set'
op|'('
string|'"Pyami"'
op|','
string|"'server_sdb_name'"
op|','
name|'self'
op|'.'
name|'name'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'cfg'
op|'='
name|'StringIO'
op|'.'
name|'StringIO'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_config'
op|'.'
name|'write'
op|'('
name|'cfg'
op|')'
newline|'\n'
name|'cfg'
op|'='
name|'cfg'
op|'.'
name|'getvalue'
op|'('
op|')'
newline|'\n'
name|'r'
op|'='
name|'ami'
op|'.'
name|'run'
op|'('
name|'min_count'
op|'='
number|'1'
op|','
nl|'\n'
name|'max_count'
op|'='
number|'1'
op|','
nl|'\n'
name|'key_name'
op|'='
name|'self'
op|'.'
name|'key_name'
op|','
nl|'\n'
name|'security_groups'
op|'='
name|'groups'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'self'
op|'.'
name|'instance_type'
op|','
nl|'\n'
name|'placement'
op|'='
name|'self'
op|'.'
name|'zone'
op|','
nl|'\n'
name|'user_data'
op|'='
name|'cfg'
op|')'
newline|'\n'
name|'i'
op|'='
name|'r'
op|'.'
name|'instances'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'instance_id'
op|'='
name|'i'
op|'.'
name|'id'
newline|'\n'
name|'self'
op|'.'
name|'put'
op|'('
op|')'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'elastic_ip'
op|':'
newline|'\n'
indent|'            '
name|'ec2'
op|'.'
name|'associate_address'
op|'('
name|'self'
op|'.'
name|'instance_id'
op|','
name|'self'
op|'.'
name|'elastic_ip'
op|')'
newline|'\n'
nl|'\n'
DECL|member|reboot
dedent|''
dedent|''
name|'def'
name|'reboot'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'instance'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'instance'
op|'.'
name|'reboot'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_ssh_client
dedent|''
dedent|''
name|'def'
name|'get_ssh_client'
op|'('
name|'self'
op|','
name|'key_file'
op|'='
name|'None'
op|','
name|'host_key_file'
op|'='
string|"'~/.ssh/known_hosts'"
op|','
nl|'\n'
name|'uname'
op|'='
string|"'root'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'import'
name|'paramiko'
newline|'\n'
name|'if'
name|'not'
name|'self'
op|'.'
name|'instance'
op|':'
newline|'\n'
indent|'            '
name|'print'
string|"'No instance yet!'"
newline|'\n'
name|'return'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'self'
op|'.'
name|'_ssh_client'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'key_file'
op|':'
newline|'\n'
indent|'                '
name|'iobject'
op|'='
name|'IObject'
op|'('
op|')'
newline|'\n'
name|'key_file'
op|'='
name|'iobject'
op|'.'
name|'get_filename'
op|'('
string|"'Path to OpenSSH Key file'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_pkey'
op|'='
name|'paramiko'
op|'.'
name|'RSAKey'
op|'.'
name|'from_private_key_file'
op|'('
name|'key_file'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_ssh_client'
op|'='
name|'paramiko'
op|'.'
name|'SSHClient'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_ssh_client'
op|'.'
name|'load_system_host_keys'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_ssh_client'
op|'.'
name|'load_host_keys'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'expanduser'
op|'('
name|'host_key_file'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_ssh_client'
op|'.'
name|'set_missing_host_key_policy'
op|'('
name|'paramiko'
op|'.'
name|'AutoAddPolicy'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_ssh_client'
op|'.'
name|'connect'
op|'('
name|'self'
op|'.'
name|'instance'
op|'.'
name|'public_dns_name'
op|','
nl|'\n'
name|'username'
op|'='
name|'uname'
op|','
name|'pkey'
op|'='
name|'self'
op|'.'
name|'_pkey'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'_ssh_client'
newline|'\n'
nl|'\n'
DECL|member|get_file
dedent|''
name|'def'
name|'get_file'
op|'('
name|'self'
op|','
name|'remotepath'
op|','
name|'localpath'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ssh_client'
op|'='
name|'self'
op|'.'
name|'get_ssh_client'
op|'('
op|')'
newline|'\n'
name|'sftp_client'
op|'='
name|'ssh_client'
op|'.'
name|'open_sftp'
op|'('
op|')'
newline|'\n'
name|'sftp_client'
op|'.'
name|'get'
op|'('
name|'remotepath'
op|','
name|'localpath'
op|')'
newline|'\n'
nl|'\n'
DECL|member|put_file
dedent|''
name|'def'
name|'put_file'
op|'('
name|'self'
op|','
name|'localpath'
op|','
name|'remotepath'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ssh_client'
op|'='
name|'self'
op|'.'
name|'get_ssh_client'
op|'('
op|')'
newline|'\n'
name|'sftp_client'
op|'='
name|'ssh_client'
op|'.'
name|'open_sftp'
op|'('
op|')'
newline|'\n'
name|'sftp_client'
op|'.'
name|'put'
op|'('
name|'localpath'
op|','
name|'remotepath'
op|')'
newline|'\n'
nl|'\n'
DECL|member|listdir
dedent|''
name|'def'
name|'listdir'
op|'('
name|'self'
op|','
name|'remotepath'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ssh_client'
op|'='
name|'self'
op|'.'
name|'get_ssh_client'
op|'('
op|')'
newline|'\n'
name|'sftp_client'
op|'='
name|'ssh_client'
op|'.'
name|'open_sftp'
op|'('
op|')'
newline|'\n'
name|'return'
name|'sftp_client'
op|'.'
name|'listdir'
op|'('
name|'remotepath'
op|')'
newline|'\n'
nl|'\n'
DECL|member|shell
dedent|''
name|'def'
name|'shell'
op|'('
name|'self'
op|','
name|'key_file'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ssh_client'
op|'='
name|'self'
op|'.'
name|'get_ssh_client'
op|'('
name|'key_file'
op|')'
newline|'\n'
name|'channel'
op|'='
name|'ssh_client'
op|'.'
name|'invoke_shell'
op|'('
op|')'
newline|'\n'
name|'interactive_shell'
op|'('
name|'channel'
op|')'
newline|'\n'
nl|'\n'
DECL|member|bundle_image
dedent|''
name|'def'
name|'bundle_image'
op|'('
name|'self'
op|','
name|'prefix'
op|','
name|'key_file'
op|','
name|'cert_file'
op|','
name|'size'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|"'bundling image...'"
newline|'\n'
name|'print'
string|"'\\tcopying cert and pk over to /mnt directory on server'"
newline|'\n'
name|'ssh_client'
op|'='
name|'self'
op|'.'
name|'get_ssh_client'
op|'('
op|')'
newline|'\n'
name|'sftp_client'
op|'='
name|'ssh_client'
op|'.'
name|'open_sftp'
op|'('
op|')'
newline|'\n'
name|'path'
op|','
name|'name'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'split'
op|'('
name|'key_file'
op|')'
newline|'\n'
name|'remote_key_file'
op|'='
string|"'/mnt/%s'"
op|'%'
name|'name'
newline|'\n'
name|'self'
op|'.'
name|'put_file'
op|'('
name|'key_file'
op|','
name|'remote_key_file'
op|')'
newline|'\n'
name|'path'
op|','
name|'name'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'split'
op|'('
name|'cert_file'
op|')'
newline|'\n'
name|'remote_cert_file'
op|'='
string|"'/mnt/%s'"
op|'%'
name|'name'
newline|'\n'
name|'self'
op|'.'
name|'put_file'
op|'('
name|'cert_file'
op|','
name|'remote_cert_file'
op|')'
newline|'\n'
name|'print'
string|"'\\tdeleting %s'"
op|'%'
name|'BotoConfigPath'
newline|'\n'
comment|'# delete the metadata.ini file if it exists'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'sftp_client'
op|'.'
name|'remove'
op|'('
name|'BotoConfigPath'
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
name|'command'
op|'='
string|"'sudo ec2-bundle-vol '"
newline|'\n'
name|'command'
op|'+='
string|"'-c %s -k %s '"
op|'%'
op|'('
name|'remote_cert_file'
op|','
name|'remote_key_file'
op|')'
newline|'\n'
name|'command'
op|'+='
string|"'-u %s '"
op|'%'
name|'self'
op|'.'
name|'_reservation'
op|'.'
name|'owner_id'
newline|'\n'
name|'command'
op|'+='
string|"'-p %s '"
op|'%'
name|'prefix'
newline|'\n'
name|'command'
op|'+='
string|"'-s %d '"
op|'%'
name|'size'
newline|'\n'
name|'command'
op|'+='
string|"'-d /mnt '"
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'instance'
op|'.'
name|'instance_type'
op|'=='
string|"'m1.small'"
name|'or'
name|'self'
op|'.'
name|'instance_type'
op|'=='
string|"'c1.medium'"
op|':'
newline|'\n'
indent|'            '
name|'command'
op|'+='
string|"'-r i386'"
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'command'
op|'+='
string|"'-r x86_64'"
newline|'\n'
dedent|''
name|'print'
string|"'\\t%s'"
op|'%'
name|'command'
newline|'\n'
name|'t'
op|'='
name|'ssh_client'
op|'.'
name|'exec_command'
op|'('
name|'command'
op|')'
newline|'\n'
name|'response'
op|'='
name|'t'
op|'['
number|'1'
op|']'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'print'
string|"'\\t%s'"
op|'%'
name|'response'
newline|'\n'
name|'print'
string|"'\\t%s'"
op|'%'
name|'t'
op|'['
number|'2'
op|']'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'print'
string|"'...complete!'"
newline|'\n'
nl|'\n'
DECL|member|upload_bundle
dedent|''
name|'def'
name|'upload_bundle'
op|'('
name|'self'
op|','
name|'bucket'
op|','
name|'prefix'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|"'uploading bundle...'"
newline|'\n'
name|'command'
op|'='
string|"'ec2-upload-bundle '"
newline|'\n'
name|'command'
op|'+='
string|"'-m /mnt/%s.manifest.xml '"
op|'%'
name|'prefix'
newline|'\n'
name|'command'
op|'+='
string|"'-b %s '"
op|'%'
name|'bucket'
newline|'\n'
name|'command'
op|'+='
string|"'-a %s '"
op|'%'
name|'self'
op|'.'
name|'ec2'
op|'.'
name|'aws_access_key_id'
newline|'\n'
name|'command'
op|'+='
string|"'-s %s '"
op|'%'
name|'self'
op|'.'
name|'ec2'
op|'.'
name|'aws_secret_access_key'
newline|'\n'
name|'print'
string|"'\\t%s'"
op|'%'
name|'command'
newline|'\n'
name|'ssh_client'
op|'='
name|'self'
op|'.'
name|'get_ssh_client'
op|'('
op|')'
newline|'\n'
name|'t'
op|'='
name|'ssh_client'
op|'.'
name|'exec_command'
op|'('
name|'command'
op|')'
newline|'\n'
name|'response'
op|'='
name|'t'
op|'['
number|'1'
op|']'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'print'
string|"'\\t%s'"
op|'%'
name|'response'
newline|'\n'
name|'print'
string|"'\\t%s'"
op|'%'
name|'t'
op|'['
number|'2'
op|']'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'print'
string|"'...complete!'"
newline|'\n'
nl|'\n'
DECL|member|create_image
dedent|''
name|'def'
name|'create_image'
op|'('
name|'self'
op|','
name|'bucket'
op|'='
name|'None'
op|','
name|'prefix'
op|'='
name|'None'
op|','
name|'key_file'
op|'='
name|'None'
op|','
name|'cert_file'
op|'='
name|'None'
op|','
name|'size'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'iobject'
op|'='
name|'IObject'
op|'('
op|')'
newline|'\n'
name|'if'
name|'not'
name|'bucket'
op|':'
newline|'\n'
indent|'            '
name|'bucket'
op|'='
name|'iobject'
op|'.'
name|'get_string'
op|'('
string|"'Name of S3 bucket'"
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'prefix'
op|':'
newline|'\n'
indent|'            '
name|'prefix'
op|'='
name|'iobject'
op|'.'
name|'get_string'
op|'('
string|"'Prefix for AMI file'"
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'key_file'
op|':'
newline|'\n'
indent|'            '
name|'key_file'
op|'='
name|'iobject'
op|'.'
name|'get_filename'
op|'('
string|"'Path to RSA private key file'"
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'cert_file'
op|':'
newline|'\n'
indent|'            '
name|'cert_file'
op|'='
name|'iobject'
op|'.'
name|'get_filename'
op|'('
string|"'Path to RSA public cert file'"
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'size'
op|':'
newline|'\n'
indent|'            '
name|'size'
op|'='
name|'iobject'
op|'.'
name|'get_int'
op|'('
string|"'Size (in MB) of bundled image'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'bundle_image'
op|'('
name|'prefix'
op|','
name|'key_file'
op|','
name|'cert_file'
op|','
name|'size'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'upload_bundle'
op|'('
name|'bucket'
op|','
name|'prefix'
op|')'
newline|'\n'
name|'print'
string|"'registering image...'"
newline|'\n'
name|'self'
op|'.'
name|'image_id'
op|'='
name|'self'
op|'.'
name|'ec2'
op|'.'
name|'register_image'
op|'('
string|"'%s/%s.manifest.xml'"
op|'%'
op|'('
name|'bucket'
op|','
name|'prefix'
op|')'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'image_id'
newline|'\n'
nl|'\n'
DECL|member|attach_volume
dedent|''
name|'def'
name|'attach_volume'
op|'('
name|'self'
op|','
name|'volume'
op|','
name|'device'
op|'='
string|'"/dev/sdp"'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Attach an EBS volume to this server\n\n        :param volume: EBS Volume to attach\n        :type volume: boto.ec2.volume.Volume\n\n        :param device: Device to attach to (default to /dev/sdp)\n        :type device: string\n        """'
newline|'\n'
name|'if'
name|'hasattr'
op|'('
name|'volume'
op|','
string|'"id"'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'volume_id'
op|'='
name|'volume'
op|'.'
name|'id'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'volume_id'
op|'='
name|'volume'
newline|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'ec2'
op|'.'
name|'attach_volume'
op|'('
name|'volume_id'
op|'='
name|'volume_id'
op|','
name|'instance_id'
op|'='
name|'self'
op|'.'
name|'instance_id'
op|','
name|'device'
op|'='
name|'device'
op|')'
newline|'\n'
nl|'\n'
DECL|member|detach_volume
dedent|''
name|'def'
name|'detach_volume'
op|'('
name|'self'
op|','
name|'volume'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Detach an EBS volume from this server\n\n        :param volume: EBS Volume to detach\n        :type volume: boto.ec2.volume.Volume\n        """'
newline|'\n'
name|'if'
name|'hasattr'
op|'('
name|'volume'
op|','
string|'"id"'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'volume_id'
op|'='
name|'volume'
op|'.'
name|'id'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'volume_id'
op|'='
name|'volume'
newline|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'ec2'
op|'.'
name|'detach_volume'
op|'('
name|'volume_id'
op|'='
name|'volume_id'
op|','
name|'instance_id'
op|'='
name|'self'
op|'.'
name|'instance_id'
op|')'
newline|'\n'
nl|'\n'
DECL|member|install_package
dedent|''
name|'def'
name|'install_package'
op|'('
name|'self'
op|','
name|'package_name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'print'
string|"'installing %s...'"
op|'%'
name|'package_name'
newline|'\n'
name|'command'
op|'='
string|"'yum -y install %s'"
op|'%'
name|'package_name'
newline|'\n'
name|'print'
string|"'\\t%s'"
op|'%'
name|'command'
newline|'\n'
name|'ssh_client'
op|'='
name|'self'
op|'.'
name|'get_ssh_client'
op|'('
op|')'
newline|'\n'
name|'t'
op|'='
name|'ssh_client'
op|'.'
name|'exec_command'
op|'('
name|'command'
op|')'
newline|'\n'
name|'response'
op|'='
name|'t'
op|'['
number|'1'
op|']'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'print'
string|"'\\t%s'"
op|'%'
name|'response'
newline|'\n'
name|'print'
string|"'\\t%s'"
op|'%'
name|'t'
op|'['
number|'2'
op|']'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'print'
string|"'...complete!'"
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
