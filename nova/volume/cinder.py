begin_unit
comment|'# Copyright 2010 United States Government as represented by the'
nl|'\n'
comment|'# Administrator of the National Aeronautics and Space Administration.'
nl|'\n'
comment|'# All Rights Reserved.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
string|'"""\nHandles all requests relating to volumes + cinder.\n"""'
newline|'\n'
nl|'\n'
name|'import'
name|'collections'
newline|'\n'
name|'import'
name|'copy'
newline|'\n'
name|'import'
name|'functools'
newline|'\n'
name|'import'
name|'sys'
newline|'\n'
nl|'\n'
name|'from'
name|'cinderclient'
name|'import'
name|'client'
name|'as'
name|'cinder_client'
newline|'\n'
name|'from'
name|'cinderclient'
name|'import'
name|'exceptions'
name|'as'
name|'cinder_exception'
newline|'\n'
name|'from'
name|'cinderclient'
op|'.'
name|'v1'
name|'import'
name|'client'
name|'as'
name|'v1_client'
newline|'\n'
name|'from'
name|'keystoneauth1'
name|'import'
name|'exceptions'
name|'as'
name|'keystone_exception'
newline|'\n'
name|'from'
name|'keystoneauth1'
name|'import'
name|'loading'
name|'as'
name|'ks_loading'
newline|'\n'
name|'from'
name|'oslo_config'
name|'import'
name|'cfg'
newline|'\n'
name|'from'
name|'oslo_log'
name|'import'
name|'log'
name|'as'
name|'logging'
newline|'\n'
name|'from'
name|'oslo_utils'
name|'import'
name|'excutils'
newline|'\n'
name|'from'
name|'oslo_utils'
name|'import'
name|'strutils'
newline|'\n'
name|'import'
name|'six'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
name|'import'
name|'availability_zones'
name|'as'
name|'az'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'i18n'
name|'import'
name|'_'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'i18n'
name|'import'
name|'_LE'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'i18n'
name|'import'
name|'_LW'
newline|'\n'
nl|'\n'
DECL|variable|cinder_opts
name|'cinder_opts'
op|'='
op|'['
nl|'\n'
name|'cfg'
op|'.'
name|'StrOpt'
op|'('
string|"'catalog_info'"
op|','
nl|'\n'
DECL|variable|default
name|'default'
op|'='
string|"'volumev2:cinderv2:publicURL'"
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'Info to match when looking for cinder in the service '"
nl|'\n'
string|"'catalog. Format is: separated values of the form: '"
nl|'\n'
string|"'<service_type>:<service_name>:<endpoint_type>'"
op|')'
op|','
nl|'\n'
name|'cfg'
op|'.'
name|'StrOpt'
op|'('
string|"'endpoint_template'"
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'Override service catalog lookup with template for cinder '"
nl|'\n'
string|"'endpoint e.g. http://localhost:8776/v1/%(project_id)s'"
op|')'
op|','
nl|'\n'
name|'cfg'
op|'.'
name|'StrOpt'
op|'('
string|"'os_region_name'"
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'Region name of this node'"
op|')'
op|','
nl|'\n'
name|'cfg'
op|'.'
name|'IntOpt'
op|'('
string|"'http_retries'"
op|','
nl|'\n'
DECL|variable|default
name|'default'
op|'='
number|'3'
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'Number of cinderclient retries on failed http calls'"
op|')'
op|','
nl|'\n'
name|'cfg'
op|'.'
name|'BoolOpt'
op|'('
string|"'cross_az_attach'"
op|','
nl|'\n'
DECL|variable|default
name|'default'
op|'='
name|'True'
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'Allow attach between instance and volume in different '"
nl|'\n'
string|"'availability zones. If False, volumes attached to an '"
nl|'\n'
string|"'instance must be in the same availability zone in '"
nl|'\n'
string|"'Cinder as the instance availability zone in Nova. '"
nl|'\n'
string|"'This also means care should be taken when booting an '"
nl|'\n'
string|'\'instance from a volume where source is not "volume" \''
nl|'\n'
string|"'because Nova will attempt to create a volume using '"
nl|'\n'
string|"'the same availability zone as what is assigned to the '"
nl|'\n'
string|"'instance. If that AZ is not in Cinder (or '"
nl|'\n'
string|"'allow_availability_zone_fallback=False in cinder.conf), '"
nl|'\n'
string|"'the volume create request will fail and the instance '"
nl|'\n'
string|"'will fail the build request.'"
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
DECL|variable|CONF
name|'CONF'
op|'='
name|'cfg'
op|'.'
name|'CONF'
newline|'\n'
DECL|variable|CINDER_OPT_GROUP
name|'CINDER_OPT_GROUP'
op|'='
string|"'cinder'"
newline|'\n'
nl|'\n'
comment|'# cinder_opts options in the DEFAULT group were deprecated in Juno'
nl|'\n'
name|'CONF'
op|'.'
name|'register_opts'
op|'('
name|'cinder_opts'
op|','
name|'group'
op|'='
name|'CINDER_OPT_GROUP'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|deprecated
name|'deprecated'
op|'='
op|'{'
string|"'timeout'"
op|':'
op|'['
name|'cfg'
op|'.'
name|'DeprecatedOpt'
op|'('
string|"'http_timeout'"
op|','
nl|'\n'
DECL|variable|group
name|'group'
op|'='
name|'CINDER_OPT_GROUP'
op|')'
op|']'
op|','
nl|'\n'
string|"'cafile'"
op|':'
op|'['
name|'cfg'
op|'.'
name|'DeprecatedOpt'
op|'('
string|"'ca_certificates_file'"
op|','
nl|'\n'
DECL|variable|group
name|'group'
op|'='
name|'CINDER_OPT_GROUP'
op|')'
op|']'
op|','
nl|'\n'
string|"'insecure'"
op|':'
op|'['
name|'cfg'
op|'.'
name|'DeprecatedOpt'
op|'('
string|"'api_insecure'"
op|','
nl|'\n'
DECL|variable|group
name|'group'
op|'='
name|'CINDER_OPT_GROUP'
op|')'
op|']'
op|'}'
newline|'\n'
nl|'\n'
name|'ks_loading'
op|'.'
name|'register_session_conf_options'
op|'('
name|'CONF'
op|','
nl|'\n'
name|'CINDER_OPT_GROUP'
op|','
nl|'\n'
DECL|variable|deprecated_opts
name|'deprecated_opts'
op|'='
name|'deprecated'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|LOG
name|'LOG'
op|'='
name|'logging'
op|'.'
name|'getLogger'
op|'('
name|'__name__'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|_SESSION
name|'_SESSION'
op|'='
name|'None'
newline|'\n'
DECL|variable|_V1_ERROR_RAISED
name|'_V1_ERROR_RAISED'
op|'='
name|'False'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|reset_globals
name|'def'
name|'reset_globals'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Testing method to reset globals.\n    """'
newline|'\n'
name|'global'
name|'_SESSION'
newline|'\n'
name|'_SESSION'
op|'='
name|'None'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|cinderclient
dedent|''
name|'def'
name|'cinderclient'
op|'('
name|'context'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'global'
name|'_SESSION'
newline|'\n'
name|'global'
name|'_V1_ERROR_RAISED'
newline|'\n'
nl|'\n'
name|'if'
name|'not'
name|'_SESSION'
op|':'
newline|'\n'
indent|'        '
name|'_SESSION'
op|'='
name|'ks_loading'
op|'.'
name|'load_session_from_conf_options'
op|'('
name|'CONF'
op|','
nl|'\n'
name|'CINDER_OPT_GROUP'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'url'
op|'='
name|'None'
newline|'\n'
name|'endpoint_override'
op|'='
name|'None'
newline|'\n'
nl|'\n'
name|'auth'
op|'='
name|'context'
op|'.'
name|'get_auth_plugin'
op|'('
op|')'
newline|'\n'
name|'service_type'
op|','
name|'service_name'
op|','
name|'interface'
op|'='
name|'CONF'
op|'.'
name|'cinder'
op|'.'
name|'catalog_info'
op|'.'
name|'split'
op|'('
string|"':'"
op|')'
newline|'\n'
nl|'\n'
name|'service_parameters'
op|'='
op|'{'
string|"'service_type'"
op|':'
name|'service_type'
op|','
nl|'\n'
string|"'service_name'"
op|':'
name|'service_name'
op|','
nl|'\n'
string|"'interface'"
op|':'
name|'interface'
op|','
nl|'\n'
string|"'region_name'"
op|':'
name|'CONF'
op|'.'
name|'cinder'
op|'.'
name|'os_region_name'
op|'}'
newline|'\n'
nl|'\n'
name|'if'
name|'CONF'
op|'.'
name|'cinder'
op|'.'
name|'endpoint_template'
op|':'
newline|'\n'
indent|'        '
name|'url'
op|'='
name|'CONF'
op|'.'
name|'cinder'
op|'.'
name|'endpoint_template'
op|'%'
name|'context'
op|'.'
name|'to_dict'
op|'('
op|')'
newline|'\n'
name|'endpoint_override'
op|'='
name|'url'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'url'
op|'='
name|'_SESSION'
op|'.'
name|'get_endpoint'
op|'('
name|'auth'
op|','
op|'**'
name|'service_parameters'
op|')'
newline|'\n'
nl|'\n'
comment|'# TODO(jamielennox): This should be using proper version discovery from'
nl|'\n'
comment|'# the cinder service rather than just inspecting the URL for certain string'
nl|'\n'
comment|'# values.'
nl|'\n'
dedent|''
name|'version'
op|'='
name|'cinder_client'
op|'.'
name|'get_volume_api_from_url'
op|'('
name|'url'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'version'
op|'=='
string|"'1'"
name|'and'
name|'not'
name|'_V1_ERROR_RAISED'
op|':'
newline|'\n'
indent|'        '
name|'msg'
op|'='
name|'_LW'
op|'('
string|"'Cinder V1 API is deprecated as of the Juno '"
nl|'\n'
string|"'release, and Nova is still configured to use it. '"
nl|'\n'
string|"'Enable the V2 API in Cinder and set '"
nl|'\n'
string|"'cinder.catalog_info in nova.conf to use it.'"
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'warn'
op|'('
name|'msg'
op|')'
newline|'\n'
name|'_V1_ERROR_RAISED'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
name|'cinder_client'
op|'.'
name|'Client'
op|'('
name|'version'
op|','
nl|'\n'
name|'session'
op|'='
name|'_SESSION'
op|','
nl|'\n'
name|'auth'
op|'='
name|'auth'
op|','
nl|'\n'
name|'endpoint_override'
op|'='
name|'endpoint_override'
op|','
nl|'\n'
name|'connect_retries'
op|'='
name|'CONF'
op|'.'
name|'cinder'
op|'.'
name|'http_retries'
op|','
nl|'\n'
op|'**'
name|'service_parameters'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|_untranslate_volume_summary_view
dedent|''
name|'def'
name|'_untranslate_volume_summary_view'
op|'('
name|'context'
op|','
name|'vol'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Maps keys for volumes summary view."""'
newline|'\n'
name|'d'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'d'
op|'['
string|"'id'"
op|']'
op|'='
name|'vol'
op|'.'
name|'id'
newline|'\n'
name|'d'
op|'['
string|"'status'"
op|']'
op|'='
name|'vol'
op|'.'
name|'status'
newline|'\n'
name|'d'
op|'['
string|"'size'"
op|']'
op|'='
name|'vol'
op|'.'
name|'size'
newline|'\n'
name|'d'
op|'['
string|"'availability_zone'"
op|']'
op|'='
name|'vol'
op|'.'
name|'availability_zone'
newline|'\n'
name|'d'
op|'['
string|"'created_at'"
op|']'
op|'='
name|'vol'
op|'.'
name|'created_at'
newline|'\n'
nl|'\n'
comment|'# TODO(jdg): The calling code expects attach_time and'
nl|'\n'
comment|'#            mountpoint to be set. When the calling'
nl|'\n'
comment|'#            code is more defensive this can be'
nl|'\n'
comment|'#            removed.'
nl|'\n'
name|'d'
op|'['
string|"'attach_time'"
op|']'
op|'='
string|'""'
newline|'\n'
name|'d'
op|'['
string|"'mountpoint'"
op|']'
op|'='
string|'""'
newline|'\n'
name|'d'
op|'['
string|"'multiattach'"
op|']'
op|'='
name|'getattr'
op|'('
name|'vol'
op|','
string|"'multiattach'"
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'vol'
op|'.'
name|'attachments'
op|':'
newline|'\n'
indent|'        '
name|'d'
op|'['
string|"'attachments'"
op|']'
op|'='
name|'collections'
op|'.'
name|'OrderedDict'
op|'('
op|')'
newline|'\n'
name|'for'
name|'attachment'
name|'in'
name|'vol'
op|'.'
name|'attachments'
op|':'
newline|'\n'
indent|'            '
name|'a'
op|'='
op|'{'
name|'attachment'
op|'['
string|"'server_id'"
op|']'
op|':'
nl|'\n'
op|'{'
string|"'attachment_id'"
op|':'
name|'attachment'
op|'.'
name|'get'
op|'('
string|"'attachment_id'"
op|')'
op|','
nl|'\n'
string|"'mountpoint'"
op|':'
name|'attachment'
op|'.'
name|'get'
op|'('
string|"'device'"
op|')'
op|'}'
nl|'\n'
op|'}'
newline|'\n'
name|'d'
op|'['
string|"'attachments'"
op|']'
op|'.'
name|'update'
op|'('
name|'a'
op|'.'
name|'items'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'d'
op|'['
string|"'attach_status'"
op|']'
op|'='
string|"'attached'"
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'d'
op|'['
string|"'attach_status'"
op|']'
op|'='
string|"'detached'"
newline|'\n'
comment|"# NOTE(dzyu) volume(cinder) v2 API uses 'name' instead of 'display_name',"
nl|'\n'
comment|"# and use 'description' instead of 'display_description' for volume."
nl|'\n'
dedent|''
name|'if'
name|'hasattr'
op|'('
name|'vol'
op|','
string|"'display_name'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'d'
op|'['
string|"'display_name'"
op|']'
op|'='
name|'vol'
op|'.'
name|'display_name'
newline|'\n'
name|'d'
op|'['
string|"'display_description'"
op|']'
op|'='
name|'vol'
op|'.'
name|'display_description'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'d'
op|'['
string|"'display_name'"
op|']'
op|'='
name|'vol'
op|'.'
name|'name'
newline|'\n'
name|'d'
op|'['
string|"'display_description'"
op|']'
op|'='
name|'vol'
op|'.'
name|'description'
newline|'\n'
comment|'# TODO(jdg): Information may be lost in this translation'
nl|'\n'
dedent|''
name|'d'
op|'['
string|"'volume_type_id'"
op|']'
op|'='
name|'vol'
op|'.'
name|'volume_type'
newline|'\n'
name|'d'
op|'['
string|"'snapshot_id'"
op|']'
op|'='
name|'vol'
op|'.'
name|'snapshot_id'
newline|'\n'
name|'d'
op|'['
string|"'bootable'"
op|']'
op|'='
name|'strutils'
op|'.'
name|'bool_from_string'
op|'('
name|'vol'
op|'.'
name|'bootable'
op|')'
newline|'\n'
name|'d'
op|'['
string|"'volume_metadata'"
op|']'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'key'
op|','
name|'value'
name|'in'
name|'vol'
op|'.'
name|'metadata'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'        '
name|'d'
op|'['
string|"'volume_metadata'"
op|']'
op|'['
name|'key'
op|']'
op|'='
name|'value'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'hasattr'
op|'('
name|'vol'
op|','
string|"'volume_image_metadata'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'d'
op|'['
string|"'volume_image_metadata'"
op|']'
op|'='
name|'copy'
op|'.'
name|'deepcopy'
op|'('
name|'vol'
op|'.'
name|'volume_image_metadata'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
name|'d'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|_untranslate_snapshot_summary_view
dedent|''
name|'def'
name|'_untranslate_snapshot_summary_view'
op|'('
name|'context'
op|','
name|'snapshot'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Maps keys for snapshots summary view."""'
newline|'\n'
name|'d'
op|'='
op|'{'
op|'}'
newline|'\n'
nl|'\n'
name|'d'
op|'['
string|"'id'"
op|']'
op|'='
name|'snapshot'
op|'.'
name|'id'
newline|'\n'
name|'d'
op|'['
string|"'status'"
op|']'
op|'='
name|'snapshot'
op|'.'
name|'status'
newline|'\n'
name|'d'
op|'['
string|"'progress'"
op|']'
op|'='
name|'snapshot'
op|'.'
name|'progress'
newline|'\n'
name|'d'
op|'['
string|"'size'"
op|']'
op|'='
name|'snapshot'
op|'.'
name|'size'
newline|'\n'
name|'d'
op|'['
string|"'created_at'"
op|']'
op|'='
name|'snapshot'
op|'.'
name|'created_at'
newline|'\n'
nl|'\n'
comment|"# NOTE(dzyu) volume(cinder) v2 API uses 'name' instead of 'display_name',"
nl|'\n'
comment|"# 'description' instead of 'display_description' for snapshot."
nl|'\n'
name|'if'
name|'hasattr'
op|'('
name|'snapshot'
op|','
string|"'display_name'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'d'
op|'['
string|"'display_name'"
op|']'
op|'='
name|'snapshot'
op|'.'
name|'display_name'
newline|'\n'
name|'d'
op|'['
string|"'display_description'"
op|']'
op|'='
name|'snapshot'
op|'.'
name|'display_description'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'d'
op|'['
string|"'display_name'"
op|']'
op|'='
name|'snapshot'
op|'.'
name|'name'
newline|'\n'
name|'d'
op|'['
string|"'display_description'"
op|']'
op|'='
name|'snapshot'
op|'.'
name|'description'
newline|'\n'
nl|'\n'
dedent|''
name|'d'
op|'['
string|"'volume_id'"
op|']'
op|'='
name|'snapshot'
op|'.'
name|'volume_id'
newline|'\n'
name|'d'
op|'['
string|"'project_id'"
op|']'
op|'='
name|'snapshot'
op|'.'
name|'project_id'
newline|'\n'
name|'d'
op|'['
string|"'volume_size'"
op|']'
op|'='
name|'snapshot'
op|'.'
name|'size'
newline|'\n'
nl|'\n'
name|'return'
name|'d'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|translate_cinder_exception
dedent|''
name|'def'
name|'translate_cinder_exception'
op|'('
name|'method'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Transforms a cinder exception but keeps its traceback intact."""'
newline|'\n'
op|'@'
name|'functools'
op|'.'
name|'wraps'
op|'('
name|'method'
op|')'
newline|'\n'
DECL|function|wrapper
name|'def'
name|'wrapper'
op|'('
name|'self'
op|','
name|'ctx'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'res'
op|'='
name|'method'
op|'('
name|'self'
op|','
name|'ctx'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
dedent|''
name|'except'
op|'('
name|'cinder_exception'
op|'.'
name|'ConnectionError'
op|','
nl|'\n'
name|'keystone_exception'
op|'.'
name|'ConnectionError'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'exc_type'
op|','
name|'exc_value'
op|','
name|'exc_trace'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
newline|'\n'
name|'exc_value'
op|'='
name|'exception'
op|'.'
name|'CinderConnectionFailed'
op|'('
nl|'\n'
name|'reason'
op|'='
name|'six'
op|'.'
name|'text_type'
op|'('
name|'exc_value'
op|')'
op|')'
newline|'\n'
name|'six'
op|'.'
name|'reraise'
op|'('
name|'exc_value'
op|','
name|'None'
op|','
name|'exc_trace'
op|')'
newline|'\n'
dedent|''
name|'except'
op|'('
name|'keystone_exception'
op|'.'
name|'BadRequest'
op|','
nl|'\n'
name|'cinder_exception'
op|'.'
name|'BadRequest'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'exc_type'
op|','
name|'exc_value'
op|','
name|'exc_trace'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
newline|'\n'
name|'exc_value'
op|'='
name|'exception'
op|'.'
name|'InvalidInput'
op|'('
nl|'\n'
name|'reason'
op|'='
name|'six'
op|'.'
name|'text_type'
op|'('
name|'exc_value'
op|')'
op|')'
newline|'\n'
name|'six'
op|'.'
name|'reraise'
op|'('
name|'exc_value'
op|','
name|'None'
op|','
name|'exc_trace'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'res'
newline|'\n'
dedent|''
name|'return'
name|'wrapper'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|translate_volume_exception
dedent|''
name|'def'
name|'translate_volume_exception'
op|'('
name|'method'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Transforms the exception for the volume but keeps its traceback intact.\n    """'
newline|'\n'
DECL|function|wrapper
name|'def'
name|'wrapper'
op|'('
name|'self'
op|','
name|'ctx'
op|','
name|'volume_id'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'res'
op|'='
name|'method'
op|'('
name|'self'
op|','
name|'ctx'
op|','
name|'volume_id'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
dedent|''
name|'except'
op|'('
name|'cinder_exception'
op|'.'
name|'ClientException'
op|','
nl|'\n'
name|'keystone_exception'
op|'.'
name|'ClientException'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'exc_type'
op|','
name|'exc_value'
op|','
name|'exc_trace'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
newline|'\n'
name|'if'
name|'isinstance'
op|'('
name|'exc_value'
op|','
op|'('
name|'keystone_exception'
op|'.'
name|'NotFound'
op|','
nl|'\n'
name|'cinder_exception'
op|'.'
name|'NotFound'
op|')'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'exc_value'
op|'='
name|'exception'
op|'.'
name|'VolumeNotFound'
op|'('
name|'volume_id'
op|'='
name|'volume_id'
op|')'
newline|'\n'
dedent|''
name|'six'
op|'.'
name|'reraise'
op|'('
name|'exc_value'
op|','
name|'None'
op|','
name|'exc_trace'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'res'
newline|'\n'
dedent|''
name|'return'
name|'translate_cinder_exception'
op|'('
name|'wrapper'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|translate_snapshot_exception
dedent|''
name|'def'
name|'translate_snapshot_exception'
op|'('
name|'method'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Transforms the exception for the snapshot but keeps its traceback\n       intact.\n    """'
newline|'\n'
DECL|function|wrapper
name|'def'
name|'wrapper'
op|'('
name|'self'
op|','
name|'ctx'
op|','
name|'snapshot_id'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'res'
op|'='
name|'method'
op|'('
name|'self'
op|','
name|'ctx'
op|','
name|'snapshot_id'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
dedent|''
name|'except'
op|'('
name|'cinder_exception'
op|'.'
name|'ClientException'
op|','
nl|'\n'
name|'keystone_exception'
op|'.'
name|'ClientException'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'exc_type'
op|','
name|'exc_value'
op|','
name|'exc_trace'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
newline|'\n'
name|'if'
name|'isinstance'
op|'('
name|'exc_value'
op|','
op|'('
name|'keystone_exception'
op|'.'
name|'NotFound'
op|','
nl|'\n'
name|'cinder_exception'
op|'.'
name|'NotFound'
op|')'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'exc_value'
op|'='
name|'exception'
op|'.'
name|'SnapshotNotFound'
op|'('
name|'snapshot_id'
op|'='
name|'snapshot_id'
op|')'
newline|'\n'
dedent|''
name|'six'
op|'.'
name|'reraise'
op|'('
name|'exc_value'
op|','
name|'None'
op|','
name|'exc_trace'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'res'
newline|'\n'
dedent|''
name|'return'
name|'translate_cinder_exception'
op|'('
name|'wrapper'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|API
dedent|''
name|'class'
name|'API'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""API for interacting with the volume manager."""'
newline|'\n'
nl|'\n'
op|'@'
name|'translate_volume_exception'
newline|'\n'
DECL|member|get
name|'def'
name|'get'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'item'
op|'='
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volumes'
op|'.'
name|'get'
op|'('
name|'volume_id'
op|')'
newline|'\n'
name|'return'
name|'_untranslate_volume_summary_view'
op|'('
name|'context'
op|','
name|'item'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'translate_cinder_exception'
newline|'\n'
DECL|member|get_all
name|'def'
name|'get_all'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'search_opts'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'search_opts'
op|'='
name|'search_opts'
name|'or'
op|'{'
op|'}'
newline|'\n'
name|'items'
op|'='
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volumes'
op|'.'
name|'list'
op|'('
name|'detailed'
op|'='
name|'True'
op|','
nl|'\n'
name|'search_opts'
op|'='
name|'search_opts'
op|')'
newline|'\n'
nl|'\n'
name|'rval'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
name|'for'
name|'item'
name|'in'
name|'items'
op|':'
newline|'\n'
indent|'            '
name|'rval'
op|'.'
name|'append'
op|'('
name|'_untranslate_volume_summary_view'
op|'('
name|'context'
op|','
name|'item'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
name|'rval'
newline|'\n'
nl|'\n'
DECL|member|check_attached
dedent|''
name|'def'
name|'check_attached'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'volume'
op|'['
string|"'status'"
op|']'
op|'!='
string|'"in-use"'
op|':'
newline|'\n'
indent|'            '
name|'msg'
op|'='
name|'_'
op|'('
string|'"volume \'%(vol)s\' status must be \'in-use\'. Currently in "'
nl|'\n'
string|'"\'%(status)s\' status"'
op|')'
op|'%'
op|'{'
string|'"vol"'
op|':'
name|'volume'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
string|'"status"'
op|':'
name|'volume'
op|'['
string|"'status'"
op|']'
op|'}'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'InvalidVolume'
op|'('
name|'reason'
op|'='
name|'msg'
op|')'
newline|'\n'
nl|'\n'
DECL|member|check_attach
dedent|''
dedent|''
name|'def'
name|'check_attach'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume'
op|','
name|'instance'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
comment|'# TODO(vish): abstract status checking?'
nl|'\n'
indent|'        '
name|'if'
name|'volume'
op|'['
string|"'status'"
op|']'
op|'!='
string|'"available"'
op|':'
newline|'\n'
indent|'            '
name|'msg'
op|'='
name|'_'
op|'('
string|'"volume \'%(vol)s\' status must be \'available\'. Currently "'
nl|'\n'
string|'"in \'%(status)s\'"'
op|')'
op|'%'
op|'{'
string|"'vol'"
op|':'
name|'volume'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
string|"'status'"
op|':'
name|'volume'
op|'['
string|"'status'"
op|']'
op|'}'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'InvalidVolume'
op|'('
name|'reason'
op|'='
name|'msg'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'volume'
op|'['
string|"'attach_status'"
op|']'
op|'=='
string|'"attached"'
op|':'
newline|'\n'
indent|'            '
name|'msg'
op|'='
name|'_'
op|'('
string|'"volume %s already attached"'
op|')'
op|'%'
name|'volume'
op|'['
string|"'id'"
op|']'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'InvalidVolume'
op|'('
name|'reason'
op|'='
name|'msg'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'instance'
name|'and'
name|'not'
name|'CONF'
op|'.'
name|'cinder'
op|'.'
name|'cross_az_attach'
op|':'
newline|'\n'
indent|'            '
name|'instance_az'
op|'='
name|'az'
op|'.'
name|'get_instance_availability_zone'
op|'('
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'if'
name|'instance_az'
op|'!='
name|'volume'
op|'['
string|"'availability_zone'"
op|']'
op|':'
newline|'\n'
indent|'                '
name|'msg'
op|'='
name|'_'
op|'('
string|'"Instance %(instance)s and volume %(vol)s are not in "'
nl|'\n'
string|'"the same availability_zone. Instance is in "'
nl|'\n'
string|'"%(ins_zone)s. Volume is in %(vol_zone)s"'
op|')'
op|'%'
op|'{'
nl|'\n'
string|'"instance"'
op|':'
name|'instance'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
string|'"vol"'
op|':'
name|'volume'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
string|"'ins_zone'"
op|':'
name|'instance_az'
op|','
nl|'\n'
string|"'vol_zone'"
op|':'
name|'volume'
op|'['
string|"'availability_zone'"
op|']'
op|'}'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'InvalidVolume'
op|'('
name|'reason'
op|'='
name|'msg'
op|')'
newline|'\n'
nl|'\n'
DECL|member|check_detach
dedent|''
dedent|''
dedent|''
name|'def'
name|'check_detach'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume'
op|','
name|'instance'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
comment|'# TODO(vish): abstract status checking?'
nl|'\n'
indent|'        '
name|'if'
name|'volume'
op|'['
string|"'status'"
op|']'
op|'=='
string|'"available"'
op|':'
newline|'\n'
indent|'            '
name|'msg'
op|'='
name|'_'
op|'('
string|'"volume %s already detached"'
op|')'
op|'%'
name|'volume'
op|'['
string|"'id'"
op|']'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'InvalidVolume'
op|'('
name|'reason'
op|'='
name|'msg'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'volume'
op|'['
string|"'attach_status'"
op|']'
op|'=='
string|"'detached'"
op|':'
newline|'\n'
indent|'            '
name|'msg'
op|'='
name|'_'
op|'('
string|'"Volume must be attached in order to detach."'
op|')'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'InvalidVolume'
op|'('
name|'reason'
op|'='
name|'msg'
op|')'
newline|'\n'
nl|'\n'
comment|'# NOTE(ildikov):Preparation for multiattach support, when a volume'
nl|'\n'
comment|'# can be attached to multiple hosts and/or instances,'
nl|'\n'
comment|'# so just check the attachment specific to this instance'
nl|'\n'
dedent|''
name|'if'
name|'instance'
name|'is'
name|'not'
name|'None'
name|'and'
name|'instance'
op|'.'
name|'uuid'
name|'not'
name|'in'
name|'volume'
op|'['
string|"'attachments'"
op|']'
op|':'
newline|'\n'
comment|'# TODO(ildikov): change it to a better exception, when enable'
nl|'\n'
comment|'# multi-attach.'
nl|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'VolumeUnattached'
op|'('
name|'volume_id'
op|'='
name|'volume'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'translate_volume_exception'
newline|'\n'
DECL|member|reserve_volume
name|'def'
name|'reserve_volume'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volumes'
op|'.'
name|'reserve'
op|'('
name|'volume_id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'translate_volume_exception'
newline|'\n'
DECL|member|unreserve_volume
name|'def'
name|'unreserve_volume'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volumes'
op|'.'
name|'unreserve'
op|'('
name|'volume_id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'translate_volume_exception'
newline|'\n'
DECL|member|begin_detaching
name|'def'
name|'begin_detaching'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volumes'
op|'.'
name|'begin_detaching'
op|'('
name|'volume_id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'translate_volume_exception'
newline|'\n'
DECL|member|roll_detaching
name|'def'
name|'roll_detaching'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volumes'
op|'.'
name|'roll_detaching'
op|'('
name|'volume_id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'translate_volume_exception'
newline|'\n'
DECL|member|attach
name|'def'
name|'attach'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|','
name|'instance_uuid'
op|','
name|'mountpoint'
op|','
name|'mode'
op|'='
string|"'rw'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volumes'
op|'.'
name|'attach'
op|'('
name|'volume_id'
op|','
name|'instance_uuid'
op|','
nl|'\n'
name|'mountpoint'
op|','
name|'mode'
op|'='
name|'mode'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'translate_volume_exception'
newline|'\n'
DECL|member|detach
name|'def'
name|'detach'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|','
name|'instance_uuid'
op|'='
name|'None'
op|','
nl|'\n'
name|'attachment_id'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'attachment_id'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'volume'
op|'='
name|'self'
op|'.'
name|'get'
op|'('
name|'context'
op|','
name|'volume_id'
op|')'
newline|'\n'
name|'if'
name|'volume'
op|'['
string|"'multiattach'"
op|']'
op|':'
newline|'\n'
indent|'                '
name|'attachments'
op|'='
name|'volume'
op|'.'
name|'get'
op|'('
string|"'attachments'"
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
name|'if'
name|'instance_uuid'
op|':'
newline|'\n'
indent|'                    '
name|'attachment_id'
op|'='
name|'attachments'
op|'.'
name|'get'
op|'('
name|'instance_uuid'
op|','
op|'{'
op|'}'
op|')'
op|'.'
name|'get'
op|'('
string|"'attachment_id'"
op|')'
newline|'\n'
name|'if'
name|'not'
name|'attachment_id'
op|':'
newline|'\n'
indent|'                        '
name|'LOG'
op|'.'
name|'warning'
op|'('
name|'_LW'
op|'('
string|'"attachment_id couldn\'t be retrieved "'
nl|'\n'
string|'"for volume %(volume_id)s with "'
nl|'\n'
string|'"instance_uuid %(instance_id)s. The "'
nl|'\n'
string|'"volume has the \'multiattach\' flag "'
nl|'\n'
string|'"enabled, without the attachment_id "'
nl|'\n'
string|'"Cinder most probably cannot perform "'
nl|'\n'
string|'"the detach."'
op|')'
op|','
nl|'\n'
op|'{'
string|"'volume_id'"
op|':'
name|'volume_id'
op|','
nl|'\n'
string|"'instance_id'"
op|':'
name|'instance_uuid'
op|'}'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'LOG'
op|'.'
name|'warning'
op|'('
name|'_LW'
op|'('
string|'"attachment_id couldn\'t be retrieved for "'
nl|'\n'
string|'"volume %(volume_id)s. The volume has the "'
nl|'\n'
string|'"\'multiattach\' flag enabled, without the "'
nl|'\n'
string|'"attachment_id Cinder most probably "'
nl|'\n'
string|'"cannot perform the detach."'
op|')'
op|','
nl|'\n'
op|'{'
string|"'volume_id'"
op|':'
name|'volume_id'
op|'}'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volumes'
op|'.'
name|'detach'
op|'('
name|'volume_id'
op|','
name|'attachment_id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'translate_volume_exception'
newline|'\n'
DECL|member|initialize_connection
name|'def'
name|'initialize_connection'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|','
name|'connector'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'connection_info'
op|'='
name|'cinderclient'
op|'('
nl|'\n'
name|'context'
op|')'
op|'.'
name|'volumes'
op|'.'
name|'initialize_connection'
op|'('
name|'volume_id'
op|','
name|'connector'
op|')'
newline|'\n'
name|'connection_info'
op|'['
string|"'connector'"
op|']'
op|'='
name|'connector'
newline|'\n'
name|'return'
name|'connection_info'
newline|'\n'
dedent|''
name|'except'
name|'cinder_exception'
op|'.'
name|'ClientException'
name|'as'
name|'ex'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'excutils'
op|'.'
name|'save_and_reraise_exception'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'error'
op|'('
name|'_LE'
op|'('
string|"'Initialize connection failed for volume '"
nl|'\n'
string|"'%(vol)s on host %(host)s. Error: %(msg)s '"
nl|'\n'
string|"'Code: %(code)s. Attempting to terminate '"
nl|'\n'
string|"'connection.'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'vol'"
op|':'
name|'volume_id'
op|','
nl|'\n'
string|"'host'"
op|':'
name|'connector'
op|'.'
name|'get'
op|'('
string|"'host'"
op|')'
op|','
nl|'\n'
string|"'msg'"
op|':'
name|'six'
op|'.'
name|'text_type'
op|'('
name|'ex'
op|')'
op|','
nl|'\n'
string|"'code'"
op|':'
name|'ex'
op|'.'
name|'code'
op|'}'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'terminate_connection'
op|'('
name|'context'
op|','
name|'volume_id'
op|','
name|'connector'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
name|'as'
name|'exc'
op|':'
newline|'\n'
indent|'                    '
name|'LOG'
op|'.'
name|'error'
op|'('
name|'_LE'
op|'('
string|"'Connection between volume %(vol)s and host '"
nl|'\n'
string|"'%(host)s might have succeeded, but attempt '"
nl|'\n'
string|"'to terminate connection has failed. '"
nl|'\n'
string|"'Validate the connection and determine if '"
nl|'\n'
string|"'manual cleanup is needed. Error: %(msg)s '"
nl|'\n'
string|"'Code: %(code)s.'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'vol'"
op|':'
name|'volume_id'
op|','
nl|'\n'
string|"'host'"
op|':'
name|'connector'
op|'.'
name|'get'
op|'('
string|"'host'"
op|')'
op|','
nl|'\n'
string|"'msg'"
op|':'
name|'six'
op|'.'
name|'text_type'
op|'('
name|'exc'
op|')'
op|','
nl|'\n'
string|"'code'"
op|':'
name|'exc'
op|'.'
name|'code'
op|'}'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
dedent|''
op|'@'
name|'translate_volume_exception'
newline|'\n'
DECL|member|terminate_connection
name|'def'
name|'terminate_connection'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|','
name|'connector'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volumes'
op|'.'
name|'terminate_connection'
op|'('
name|'volume_id'
op|','
nl|'\n'
name|'connector'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'translate_cinder_exception'
newline|'\n'
DECL|member|migrate_volume_completion
name|'def'
name|'migrate_volume_completion'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'old_volume_id'
op|','
name|'new_volume_id'
op|','
nl|'\n'
name|'error'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volumes'
op|'.'
name|'migrate_volume_completion'
op|'('
nl|'\n'
name|'old_volume_id'
op|','
name|'new_volume_id'
op|','
name|'error'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'translate_cinder_exception'
newline|'\n'
DECL|member|create
name|'def'
name|'create'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'size'
op|','
name|'name'
op|','
name|'description'
op|','
name|'snapshot'
op|'='
name|'None'
op|','
nl|'\n'
name|'image_id'
op|'='
name|'None'
op|','
name|'volume_type'
op|'='
name|'None'
op|','
name|'metadata'
op|'='
name|'None'
op|','
nl|'\n'
name|'availability_zone'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'client'
op|'='
name|'cinderclient'
op|'('
name|'context'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'snapshot'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'snapshot_id'
op|'='
name|'snapshot'
op|'['
string|"'id'"
op|']'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'snapshot_id'
op|'='
name|'None'
newline|'\n'
nl|'\n'
dedent|''
name|'kwargs'
op|'='
name|'dict'
op|'('
name|'snapshot_id'
op|'='
name|'snapshot_id'
op|','
nl|'\n'
name|'volume_type'
op|'='
name|'volume_type'
op|','
nl|'\n'
name|'user_id'
op|'='
name|'context'
op|'.'
name|'user_id'
op|','
nl|'\n'
name|'project_id'
op|'='
name|'context'
op|'.'
name|'project_id'
op|','
nl|'\n'
name|'availability_zone'
op|'='
name|'availability_zone'
op|','
nl|'\n'
name|'metadata'
op|'='
name|'metadata'
op|','
nl|'\n'
name|'imageRef'
op|'='
name|'image_id'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'isinstance'
op|'('
name|'client'
op|','
name|'v1_client'
op|'.'
name|'Client'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'kwargs'
op|'['
string|"'display_name'"
op|']'
op|'='
name|'name'
newline|'\n'
name|'kwargs'
op|'['
string|"'display_description'"
op|']'
op|'='
name|'description'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'kwargs'
op|'['
string|"'name'"
op|']'
op|'='
name|'name'
newline|'\n'
name|'kwargs'
op|'['
string|"'description'"
op|']'
op|'='
name|'description'
newline|'\n'
nl|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'item'
op|'='
name|'client'
op|'.'
name|'volumes'
op|'.'
name|'create'
op|'('
name|'size'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
name|'return'
name|'_untranslate_volume_summary_view'
op|'('
name|'context'
op|','
name|'item'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'cinder_exception'
op|'.'
name|'OverLimit'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'OverQuota'
op|'('
name|'overs'
op|'='
string|"'volumes'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'translate_volume_exception'
newline|'\n'
DECL|member|delete
name|'def'
name|'delete'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volumes'
op|'.'
name|'delete'
op|'('
name|'volume_id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'translate_volume_exception'
newline|'\n'
DECL|member|update
name|'def'
name|'update'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|','
name|'fields'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'translate_snapshot_exception'
newline|'\n'
DECL|member|get_snapshot
name|'def'
name|'get_snapshot'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'snapshot_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'item'
op|'='
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volume_snapshots'
op|'.'
name|'get'
op|'('
name|'snapshot_id'
op|')'
newline|'\n'
name|'return'
name|'_untranslate_snapshot_summary_view'
op|'('
name|'context'
op|','
name|'item'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'translate_cinder_exception'
newline|'\n'
DECL|member|get_all_snapshots
name|'def'
name|'get_all_snapshots'
op|'('
name|'self'
op|','
name|'context'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'items'
op|'='
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volume_snapshots'
op|'.'
name|'list'
op|'('
name|'detailed'
op|'='
name|'True'
op|')'
newline|'\n'
name|'rvals'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
name|'for'
name|'item'
name|'in'
name|'items'
op|':'
newline|'\n'
indent|'            '
name|'rvals'
op|'.'
name|'append'
op|'('
name|'_untranslate_snapshot_summary_view'
op|'('
name|'context'
op|','
name|'item'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
name|'rvals'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'translate_volume_exception'
newline|'\n'
DECL|member|create_snapshot
name|'def'
name|'create_snapshot'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|','
name|'name'
op|','
name|'description'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'item'
op|'='
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volume_snapshots'
op|'.'
name|'create'
op|'('
name|'volume_id'
op|','
nl|'\n'
name|'False'
op|','
nl|'\n'
name|'name'
op|','
nl|'\n'
name|'description'
op|')'
newline|'\n'
name|'return'
name|'_untranslate_snapshot_summary_view'
op|'('
name|'context'
op|','
name|'item'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'translate_volume_exception'
newline|'\n'
DECL|member|create_snapshot_force
name|'def'
name|'create_snapshot_force'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|','
name|'name'
op|','
name|'description'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'item'
op|'='
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volume_snapshots'
op|'.'
name|'create'
op|'('
name|'volume_id'
op|','
nl|'\n'
name|'True'
op|','
nl|'\n'
name|'name'
op|','
nl|'\n'
name|'description'
op|')'
newline|'\n'
nl|'\n'
name|'return'
name|'_untranslate_snapshot_summary_view'
op|'('
name|'context'
op|','
name|'item'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'translate_snapshot_exception'
newline|'\n'
DECL|member|delete_snapshot
name|'def'
name|'delete_snapshot'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'snapshot_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volume_snapshots'
op|'.'
name|'delete'
op|'('
name|'snapshot_id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'translate_cinder_exception'
newline|'\n'
DECL|member|get_volume_encryption_metadata
name|'def'
name|'get_volume_encryption_metadata'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volumes'
op|'.'
name|'get_encryption_metadata'
op|'('
name|'volume_id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'translate_snapshot_exception'
newline|'\n'
DECL|member|update_snapshot_status
name|'def'
name|'update_snapshot_status'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'snapshot_id'
op|','
name|'status'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'vs'
op|'='
name|'cinderclient'
op|'('
name|'context'
op|')'
op|'.'
name|'volume_snapshots'
newline|'\n'
nl|'\n'
comment|"# '90%' here is used to tell Cinder that Nova is done"
nl|'\n'
comment|"# with its portion of the 'creating' state. This can"
nl|'\n'
comment|'# be removed when we are able to split the Cinder states'
nl|'\n'
comment|"# into 'creating' and a separate state of"
nl|'\n'
comment|"# 'creating_in_nova'. (Same for 'deleting' state.)"
nl|'\n'
nl|'\n'
name|'vs'
op|'.'
name|'update_snapshot_status'
op|'('
nl|'\n'
name|'snapshot_id'
op|','
nl|'\n'
op|'{'
string|"'status'"
op|':'
name|'status'
op|','
nl|'\n'
string|"'progress'"
op|':'
string|"'90%'"
op|'}'
nl|'\n'
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
