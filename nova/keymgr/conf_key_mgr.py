begin_unit
comment|'# Copyright (c) 2013 The Johns Hopkins University/Applied Physics Laboratory'
nl|'\n'
comment|'# All Rights Reserved.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
string|'"""\nAn implementation of a key manager that reads its key from the project\'s\nconfiguration options.\n\nThis key manager implementation provides limited security, assuming that the\nkey remains secret. Using the volume encryption feature as an example,\nencryption provides protection against a lost or stolen disk, assuming that\nthe configuration file that contains the key is not stored on the disk.\nEncryption also protects the confidentiality of data as it is transmitted via\niSCSI from the compute host to the storage host (again assuming that an\nattacker who intercepts the data does not know the secret key).\n\nBecause this implementation uses a single, fixed key, it proffers no\nprotection once that key is compromised. In particular, different volumes\nencrypted with a key provided by this key manager actually share the same\nencryption key so *any* volume can be decrypted once the fixed key is known.\n"""'
newline|'\n'
nl|'\n'
name|'import'
name|'binascii'
newline|'\n'
nl|'\n'
name|'from'
name|'castellan'
op|'.'
name|'common'
op|'.'
name|'objects'
name|'import'
name|'symmetric_key'
name|'as'
name|'key'
newline|'\n'
name|'from'
name|'castellan'
op|'.'
name|'key_manager'
name|'import'
name|'key_manager'
newline|'\n'
name|'from'
name|'oslo_log'
name|'import'
name|'log'
name|'as'
name|'logging'
newline|'\n'
nl|'\n'
name|'import'
name|'nova'
op|'.'
name|'conf'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'i18n'
name|'import'
name|'_'
op|','
name|'_LW'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|CONF
name|'CONF'
op|'='
name|'nova'
op|'.'
name|'conf'
op|'.'
name|'CONF'
newline|'\n'
DECL|variable|LOG
name|'LOG'
op|'='
name|'logging'
op|'.'
name|'getLogger'
op|'('
name|'__name__'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ConfKeyManager
name|'class'
name|'ConfKeyManager'
op|'('
name|'key_manager'
op|'.'
name|'KeyManager'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""This key manager implementation supports all the methods specified by\n    the key manager interface. This implementation creates a single key in\n    response to all invocations of create_key. Side effects\n    (e.g., raising exceptions) for each method are handled\n    as specified by the key manager interface.\n    """'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'configuration'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'LOG'
op|'.'
name|'warning'
op|'('
name|'_LW'
op|'('
string|"'This key manager is insecure and is not recommended '"
nl|'\n'
string|"'for production deployments'"
op|')'
op|')'
newline|'\n'
name|'super'
op|'('
name|'ConfKeyManager'
op|','
name|'self'
op|')'
op|'.'
name|'__init__'
op|'('
name|'configuration'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'key_id'
op|'='
string|"'00000000-0000-0000-0000-000000000000'"
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'conf'
op|'='
name|'CONF'
name|'if'
name|'configuration'
name|'is'
name|'None'
name|'else'
name|'configuration'
newline|'\n'
nl|'\n'
name|'if'
name|'CONF'
op|'.'
name|'key_manager'
op|'.'
name|'fixed_key'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'ValueError'
op|'('
name|'_'
op|'('
string|"'keymgr.fixed_key not defined'"
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_hex_key'
op|'='
name|'CONF'
op|'.'
name|'key_manager'
op|'.'
name|'fixed_key'
newline|'\n'
name|'super'
op|'('
name|'ConfKeyManager'
op|','
name|'self'
op|')'
op|'.'
name|'__init__'
op|'('
name|'configuration'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_key
dedent|''
name|'def'
name|'_get_key'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'key_bytes'
op|'='
name|'bytes'
op|'('
name|'binascii'
op|'.'
name|'unhexlify'
op|'('
name|'self'
op|'.'
name|'_hex_key'
op|')'
op|')'
newline|'\n'
name|'return'
name|'key'
op|'.'
name|'SymmetricKey'
op|'('
string|"'AES'"
op|','
name|'len'
op|'('
name|'key_bytes'
op|')'
op|'*'
number|'8'
op|','
name|'key_bytes'
op|')'
newline|'\n'
nl|'\n'
DECL|member|create_key
dedent|''
name|'def'
name|'create_key'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'algorithm'
op|','
name|'length'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Creates a symmetric key.\n\n        This implementation returns a UUID for the key read from the\n        configuration file. A Forbidden exception is raised if the\n        specified context is None.\n        """'
newline|'\n'
name|'if'
name|'context'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'Forbidden'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'key_id'
newline|'\n'
nl|'\n'
DECL|member|create_key_pair
dedent|''
name|'def'
name|'create_key_pair'
op|'('
name|'self'
op|','
name|'context'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'NotImplementedError'
op|'('
nl|'\n'
string|'"ConfKeyManager does not support asymmetric keys"'
op|')'
newline|'\n'
nl|'\n'
DECL|member|store
dedent|''
name|'def'
name|'store'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'managed_object'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Stores (i.e., registers) a key with the key manager."""'
newline|'\n'
name|'if'
name|'context'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'Forbidden'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'managed_object'
op|'!='
name|'self'
op|'.'
name|'_get_key'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'KeyManagerError'
op|'('
nl|'\n'
name|'reason'
op|'='
string|'"cannot store arbitrary keys"'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'key_id'
newline|'\n'
nl|'\n'
DECL|member|get
dedent|''
name|'def'
name|'get'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'managed_object_id'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Retrieves the key identified by the specified id.\n\n        This implementation returns the key that is associated with the\n        specified UUID. A Forbidden exception is raised if the specified\n        context is None; a KeyError is raised if the UUID is invalid.\n        """'
newline|'\n'
name|'if'
name|'context'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'Forbidden'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'managed_object_id'
op|'!='
name|'self'
op|'.'
name|'key_id'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'KeyError'
op|'('
name|'str'
op|'('
name|'managed_object_id'
op|')'
op|'+'
string|'" != "'
op|'+'
name|'str'
op|'('
name|'self'
op|'.'
name|'key_id'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'_get_key'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|delete
dedent|''
name|'def'
name|'delete'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'managed_object_id'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Represents deleting the key.\n\n        Because the ConfKeyManager has only one key, which is read from the\n        configuration file, the key is not actually deleted when this is\n        called.\n        """'
newline|'\n'
name|'if'
name|'context'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'Forbidden'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'managed_object_id'
op|'!='
name|'self'
op|'.'
name|'key_id'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'KeyManagerError'
op|'('
nl|'\n'
name|'reason'
op|'='
string|'"cannot delete non-existent key"'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'LOG'
op|'.'
name|'warning'
op|'('
name|'_LW'
op|'('
string|'"Not deleting key %s"'
op|')'
op|','
name|'managed_object_id'
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
