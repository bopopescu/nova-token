begin_unit
comment|'# Copyright 2011 OpenStack Foundation'
nl|'\n'
comment|'# All Rights Reserved.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
string|'"""\nTests for Crypto module.\n"""'
newline|'\n'
nl|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'uuid'
newline|'\n'
nl|'\n'
name|'from'
name|'cryptography'
op|'.'
name|'hazmat'
name|'import'
name|'backends'
newline|'\n'
name|'from'
name|'cryptography'
op|'.'
name|'hazmat'
op|'.'
name|'primitives'
name|'import'
name|'serialization'
newline|'\n'
name|'import'
name|'mock'
newline|'\n'
name|'from'
name|'oslo_concurrency'
name|'import'
name|'processutils'
newline|'\n'
name|'import'
name|'paramiko'
newline|'\n'
name|'import'
name|'six'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
name|'import'
name|'crypto'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'test'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'utils'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|X509Test
name|'class'
name|'X509Test'
op|'('
name|'test'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
DECL|member|test_can_generate_x509
indent|'    '
name|'def'
name|'test_can_generate_x509'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'flags'
op|'('
name|'ca_path'
op|'='
name|'tmpdir'
op|')'
newline|'\n'
name|'crypto'
op|'.'
name|'ensure_ca_filesystem'
op|'('
op|')'
newline|'\n'
name|'_key'
op|','
name|'cert_str'
op|'='
name|'crypto'
op|'.'
name|'generate_x509_cert'
op|'('
string|"'fake'"
op|','
string|"'fake'"
op|')'
newline|'\n'
nl|'\n'
name|'project_cert'
op|'='
name|'crypto'
op|'.'
name|'fetch_ca'
op|'('
name|'project_id'
op|'='
string|"'fake'"
op|')'
newline|'\n'
nl|'\n'
name|'signed_cert_file'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"signed"'
op|')'
newline|'\n'
name|'with'
name|'open'
op|'('
name|'signed_cert_file'
op|','
string|"'w'"
op|')'
name|'as'
name|'keyfile'
op|':'
newline|'\n'
indent|'                '
name|'keyfile'
op|'.'
name|'write'
op|'('
name|'cert_str'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'project_cert_file'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"project"'
op|')'
newline|'\n'
name|'with'
name|'open'
op|'('
name|'project_cert_file'
op|','
string|"'w'"
op|')'
name|'as'
name|'keyfile'
op|':'
newline|'\n'
indent|'                '
name|'keyfile'
op|'.'
name|'write'
op|'('
name|'project_cert'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'enc'
op|','
name|'err'
op|'='
name|'utils'
op|'.'
name|'execute'
op|'('
string|"'openssl'"
op|','
string|"'verify'"
op|','
string|"'-CAfile'"
op|','
nl|'\n'
name|'project_cert_file'
op|','
string|"'-verbose'"
op|','
name|'signed_cert_file'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'err'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_encrypt_decrypt_x509
dedent|''
dedent|''
name|'def'
name|'test_encrypt_decrypt_x509'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'flags'
op|'('
name|'ca_path'
op|'='
name|'tmpdir'
op|')'
newline|'\n'
name|'project_id'
op|'='
string|'"fake"'
newline|'\n'
name|'crypto'
op|'.'
name|'ensure_ca_filesystem'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'cert'
op|'='
name|'crypto'
op|'.'
name|'fetch_ca'
op|'('
name|'project_id'
op|')'
newline|'\n'
name|'public_key'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"public.pem"'
op|')'
newline|'\n'
name|'with'
name|'open'
op|'('
name|'public_key'
op|','
string|"'w'"
op|')'
name|'as'
name|'keyfile'
op|':'
newline|'\n'
indent|'                '
name|'keyfile'
op|'.'
name|'write'
op|'('
name|'cert'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'text'
op|'='
string|'"some @#!%^* test text"'
newline|'\n'
name|'process_input'
op|'='
name|'text'
op|'.'
name|'encode'
op|'('
string|'"ascii"'
op|')'
name|'if'
name|'six'
op|'.'
name|'PY3'
name|'else'
name|'text'
newline|'\n'
name|'enc'
op|','
name|'_err'
op|'='
name|'utils'
op|'.'
name|'execute'
op|'('
string|"'openssl'"
op|','
nl|'\n'
string|"'rsautl'"
op|','
nl|'\n'
string|"'-certin'"
op|','
nl|'\n'
string|"'-encrypt'"
op|','
nl|'\n'
string|"'-inkey'"
op|','
string|"'%s'"
op|'%'
name|'public_key'
op|','
nl|'\n'
name|'process_input'
op|'='
name|'process_input'
op|','
nl|'\n'
name|'binary'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'dec'
op|'='
name|'crypto'
op|'.'
name|'decrypt_text'
op|'('
name|'project_id'
op|','
name|'enc'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsInstance'
op|'('
name|'dec'
op|','
name|'bytes'
op|')'
newline|'\n'
name|'if'
name|'six'
op|'.'
name|'PY3'
op|':'
newline|'\n'
indent|'                '
name|'dec'
op|'='
name|'dec'
op|'.'
name|'decode'
op|'('
string|"'ascii'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'text'
op|','
name|'dec'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'utils'
op|','
string|"'execute'"
op|','
nl|'\n'
name|'side_effect'
op|'='
name|'processutils'
op|'.'
name|'ProcessExecutionError'
op|')'
newline|'\n'
DECL|member|test_ensure_ca_filesystem_chdir
name|'def'
name|'test_ensure_ca_filesystem_chdir'
op|'('
name|'self'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'flags'
op|'('
name|'ca_path'
op|'='
name|'tmpdir'
op|')'
newline|'\n'
name|'start'
op|'='
name|'os'
op|'.'
name|'getcwd'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'processutils'
op|'.'
name|'ProcessExecutionError'
op|','
nl|'\n'
name|'crypto'
op|'.'
name|'ensure_ca_filesystem'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'start'
op|','
name|'os'
op|'.'
name|'getcwd'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|RevokeCertsTest
dedent|''
dedent|''
dedent|''
name|'class'
name|'RevokeCertsTest'
op|'('
name|'test'
op|'.'
name|'NoDBTestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'    '
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'nova.crypto.revoke_cert'"
op|')'
newline|'\n'
DECL|member|test_revoke_certs_by_user_and_project
name|'def'
name|'test_revoke_certs_by_user_and_project'
op|'('
name|'self'
op|','
name|'mock_revoke'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'user_id'
op|'='
string|"'test_user'"
newline|'\n'
name|'project_id'
op|'='
number|'2'
newline|'\n'
name|'file_name'
op|'='
string|"'test_file'"
newline|'\n'
nl|'\n'
DECL|function|mock_certificate_get_all_by_user_and_project
name|'def'
name|'mock_certificate_get_all_by_user_and_project'
op|'('
name|'context'
op|','
nl|'\n'
name|'user_id'
op|','
nl|'\n'
name|'project_id'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'            '
name|'return'
op|'['
op|'{'
string|'"user_id"'
op|':'
name|'user_id'
op|','
string|'"project_id"'
op|':'
name|'project_id'
op|','
nl|'\n'
string|'"file_name"'
op|':'
name|'file_name'
op|'}'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'nova.db.certificate_get_all_by_user_and_project'"
op|','
nl|'\n'
name|'mock_certificate_get_all_by_user_and_project'
op|')'
newline|'\n'
nl|'\n'
name|'crypto'
op|'.'
name|'revoke_certs_by_user_and_project'
op|'('
name|'user_id'
op|','
name|'project_id'
op|')'
newline|'\n'
nl|'\n'
name|'mock_revoke'
op|'.'
name|'assert_called_once_with'
op|'('
name|'project_id'
op|','
name|'file_name'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'nova.crypto.revoke_cert'"
op|')'
newline|'\n'
DECL|member|test_revoke_certs_by_user
name|'def'
name|'test_revoke_certs_by_user'
op|'('
name|'self'
op|','
name|'mock_revoke'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'user_id'
op|'='
string|"'test_user'"
newline|'\n'
name|'project_id'
op|'='
number|'2'
newline|'\n'
name|'file_name'
op|'='
string|"'test_file'"
newline|'\n'
nl|'\n'
DECL|function|mock_certificate_get_all_by_user
name|'def'
name|'mock_certificate_get_all_by_user'
op|'('
name|'context'
op|','
name|'user_id'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'            '
name|'return'
op|'['
op|'{'
string|'"user_id"'
op|':'
name|'user_id'
op|','
string|'"project_id"'
op|':'
name|'project_id'
op|','
nl|'\n'
string|'"file_name"'
op|':'
name|'file_name'
op|'}'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'nova.db.certificate_get_all_by_user'"
op|','
nl|'\n'
name|'mock_certificate_get_all_by_user'
op|')'
newline|'\n'
nl|'\n'
name|'crypto'
op|'.'
name|'revoke_certs_by_user'
op|'('
name|'user_id'
op|')'
newline|'\n'
name|'mock_revoke'
op|'.'
name|'assert_called_once_with'
op|'('
name|'project_id'
op|','
name|'mock'
op|'.'
name|'ANY'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'nova.crypto.revoke_cert'"
op|')'
newline|'\n'
DECL|member|test_revoke_certs_by_project
name|'def'
name|'test_revoke_certs_by_project'
op|'('
name|'self'
op|','
name|'mock_revoke'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'user_id'
op|'='
string|"'test_user'"
newline|'\n'
name|'project_id'
op|'='
number|'2'
newline|'\n'
name|'file_name'
op|'='
string|"'test_file'"
newline|'\n'
nl|'\n'
DECL|function|mock_certificate_get_all_by_project
name|'def'
name|'mock_certificate_get_all_by_project'
op|'('
name|'context'
op|','
name|'project_id'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'            '
name|'return'
op|'['
op|'{'
string|'"user_id"'
op|':'
name|'user_id'
op|','
string|'"project_id"'
op|':'
name|'project_id'
op|','
nl|'\n'
string|'"file_name"'
op|':'
name|'file_name'
op|'}'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'nova.db.certificate_get_all_by_project'"
op|','
nl|'\n'
name|'mock_certificate_get_all_by_project'
op|')'
newline|'\n'
nl|'\n'
name|'crypto'
op|'.'
name|'revoke_certs_by_project'
op|'('
name|'project_id'
op|')'
newline|'\n'
name|'mock_revoke'
op|'.'
name|'assert_called_once_with'
op|'('
name|'project_id'
op|','
name|'mock'
op|'.'
name|'ANY'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'utils'
op|','
string|"'execute'"
op|','
nl|'\n'
name|'side_effect'
op|'='
name|'processutils'
op|'.'
name|'ProcessExecutionError'
op|')'
newline|'\n'
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'os'
op|','
string|"'chdir'"
op|','
name|'return_value'
op|'='
name|'None'
op|')'
newline|'\n'
DECL|member|test_revoke_cert_process_execution_error
name|'def'
name|'test_revoke_cert_process_execution_error'
op|'('
name|'self'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'RevokeCertFailure'
op|','
name|'crypto'
op|'.'
name|'revoke_cert'
op|','
nl|'\n'
number|'2'
op|','
string|"'test_file'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_revoke_cert_project_not_found_chdir_fails
dedent|''
name|'def'
name|'test_revoke_cert_project_not_found_chdir_fails'
op|'('
name|'self'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'use_project_ca'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'ProjectNotFound'
op|','
name|'crypto'
op|'.'
name|'revoke_cert'
op|','
nl|'\n'
name|'str'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|')'
op|','
string|"'test_file'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|CertExceptionTests
dedent|''
dedent|''
name|'class'
name|'CertExceptionTests'
op|'('
name|'test'
op|'.'
name|'NoDBTestCase'
op|')'
op|':'
newline|'\n'
DECL|member|test_fetch_ca_file_not_found
indent|'    '
name|'def'
name|'test_fetch_ca_file_not_found'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'flags'
op|'('
name|'ca_path'
op|'='
name|'tmpdir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'use_project_ca'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'CryptoCAFileNotFound'
op|','
name|'crypto'
op|'.'
name|'fetch_ca'
op|','
nl|'\n'
name|'project_id'
op|'='
string|"'fake'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_fetch_crl_file_not_found
dedent|''
dedent|''
name|'def'
name|'test_fetch_crl_file_not_found'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'flags'
op|'('
name|'ca_path'
op|'='
name|'tmpdir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'use_project_ca'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'CryptoCRLFileNotFound'
op|','
nl|'\n'
name|'crypto'
op|'.'
name|'fetch_crl'
op|','
name|'project_id'
op|'='
string|"'fake'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|EncryptionTests
dedent|''
dedent|''
dedent|''
name|'class'
name|'EncryptionTests'
op|'('
name|'test'
op|'.'
name|'NoDBTestCase'
op|')'
op|':'
newline|'\n'
DECL|variable|pubkey
indent|'    '
name|'pubkey'
op|'='
op|'('
string|'"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDArtgrfBu/g2o28o+H2ng/crv"'
nl|'\n'
string|'"zgES91i/NNPPFTOutXelrJ9QiPTPTm+B8yspLsXifmbsmXztNOlBQgQXs6usxb4"'
nl|'\n'
string|'"fnJKNUZ84Vkp5esbqK/L7eyRqwPvqo7btKBMoAMVX/kUyojMpxb7Ssh6M6Y8cpi"'
nl|'\n'
string|'"goi+MSDPD7+5yRJ9z4mH9h7MCY6Ejv8KTcNYmVHvRhsFUcVhWcIISlNWUGiG7rf"'
nl|'\n'
string|'"oki060F5myQN3AXcL8gHG5/Qb1RVkQFUKZ5geQ39/wSyYA1Q65QTba/5G2QNbl2"'
nl|'\n'
string|'"0eAIBTyKZhN6g88ak+yARa6BLLDkrlP7L4WctHQMLsuXHohQsUO9AcOlVMARgrg"'
nl|'\n'
string|'"uF test@test"'
op|')'
newline|'\n'
name|'prikey'
op|'='
string|'"""-----BEGIN RSA PRIVATE KEY-----\nMIIEpQIBAAKCAQEAwK7YK3wbv4NqNvKPh9p4P3K784BEvdYvzTTzxUzrrV3payfU\nIj0z05vgfMrKS7F4n5m7Jl87TTpQUIEF7OrrMW+H5ySjVGfOFZKeXrG6ivy+3ska\nsD76qO27SgTKADFV/5FMqIzKcW+0rIejOmPHKYoKIvjEgzw+/uckSfc+Jh/YezAm\nOhI7/Ck3DWJlR70YbBVHFYVnCCEpTVlBohu636JItOtBeZskDdwF3C/IBxuf0G9U\nVZEBVCmeYHkN/f8EsmANUOuUE22v+RtkDW5dtHgCAU8imYTeoPPGpPsgEWugSyw5\nK5T+y+FnLR0DC7Llx6IULFDvQHDpVTAEYK4LhQIDAQABAoIBAF9ibrrgHnBpItx+\nqVUMbriiGK8LUXxUmqdQTljeolDZi6KzPc2RVKWtpazBSvG7skX3+XCediHd+0JP\nDNri1HlNiA6B0aUIGjoNsf6YpwsE4YwyK9cR5k5YGX4j7se3pKX2jOdngxQyw1Mh\ndkmCeWZz4l67nbSFz32qeQlwrsB56THJjgHB7elDoGCXTX/9VJyjFlCbfxVCsIng\ninrNgT0uMSYMNpAjTNOjguJt/DtXpwzei5eVpsERe0TRRVH23ycS0fuq/ancYwI/\nMDr9KSB8r+OVGeVGj3popCxECxYLBxhqS1dAQyJjhQXKwajJdHFzidjXO09hLBBz\nFiutpYUCgYEA6OFikTrPlCMGMJjSj+R9woDAOPfvCDbVZWfNo8iupiECvei88W28\nRYFnvUQRjSC0pHe//mfUSmiEaE+SjkNCdnNR+vsq9q+htfrADm84jl1mfeWatg/g\nzuGz2hAcZnux3kQMI7ufOwZNNpM2bf5B4yKamvG8tZRRxSkkAL1NV48CgYEA08/Z\nTy9g9XPKoLnUWStDh1zwG+c0q14l2giegxzaUAG5DOgOXbXcw0VQ++uOWD5ARELG\ng9wZcbBsXxJrRpUqx+GAlv2Y1bkgiPQS1JIyhsWEUtwfAC/G+uZhCX53aI3Pbsjh\nQmkPCSp5DuOuW2PybMaw+wVe+CaI/gwAWMYDAasCgYEA4Fzkvc7PVoU33XIeywr0\nLoQkrb4QyPUrOvt7H6SkvuFm5thn0KJMlRpLfAksb69m2l2U1+HooZd4mZawN+eN\nDNmlzgxWJDypq83dYwq8jkxmBj1DhMxfZnIE+L403nelseIVYAfPLOqxUTcbZXVk\nvRQFp+nmSXqQHUe5rAy1ivkCgYEAqLu7cclchCxqDv/6mc5NTVhMLu5QlvO5U6fq\nHqitgW7d69oxF5X499YQXZ+ZFdMBf19ypTiBTIAu1M3nh6LtIa4SsjXzus5vjKpj\nFdQhTBus/hU83Pkymk1MoDOPDEtsI+UDDdSDldmv9pyKGWPVi7H86vusXCLWnwsQ\ne6fCXWECgYEAqgpGvva5kJ1ISgNwnJbwiNw0sOT9BMOsdNZBElf0kJIIy6FMPvap\n6S1ziw+XWfdQ83VIUOCL5DrwmcYzLIogS0agmnx/monfDx0Nl9+OZRxy6+AI9vkK\n86A1+DXdo+IgX3grFK1l1gPhAZPRWJZ+anrEkyR4iLq6ZoPZ3BQn97U=\n-----END RSA PRIVATE KEY-----"""'
newline|'\n'
DECL|variable|text
name|'text'
op|'='
string|'"Some text! %$*"'
newline|'\n'
nl|'\n'
DECL|function|_ssh_decrypt_text
name|'def'
name|'_ssh_decrypt_text'
op|'('
name|'self'
op|','
name|'ssh_private_key'
op|','
name|'text'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'sshkey'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'abspath'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|"'ssh.key'"
op|')'
op|')'
newline|'\n'
name|'with'
name|'open'
op|'('
name|'sshkey'
op|','
string|"'w'"
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'                '
name|'f'
op|'.'
name|'write'
op|'('
name|'ssh_private_key'
op|')'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'dec'
op|','
name|'_err'
op|'='
name|'utils'
op|'.'
name|'execute'
op|'('
string|"'openssl'"
op|','
nl|'\n'
string|"'rsautl'"
op|','
nl|'\n'
string|"'-decrypt'"
op|','
nl|'\n'
string|"'-inkey'"
op|','
name|'sshkey'
op|','
nl|'\n'
name|'process_input'
op|'='
name|'text'
op|','
nl|'\n'
name|'binary'
op|'='
name|'True'
op|')'
newline|'\n'
name|'return'
name|'dec'
newline|'\n'
dedent|''
name|'except'
name|'processutils'
op|'.'
name|'ProcessExecutionError'
name|'as'
name|'exc'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'exception'
op|'.'
name|'DecryptionFailure'
op|'('
name|'reason'
op|'='
name|'exc'
op|'.'
name|'stderr'
op|')'
newline|'\n'
nl|'\n'
DECL|function|test_ssh_encrypt_decrypt_text
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_ssh_encrypt_decrypt_text'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_ssh_encrypt_decrypt_text'
op|'('
name|'self'
op|'.'
name|'pubkey'
op|')'
newline|'\n'
name|'key_with_spaces_in_comment'
op|'='
name|'self'
op|'.'
name|'pubkey'
op|'.'
name|'replace'
op|'('
string|"'test@test'"
op|','
nl|'\n'
string|"'Generated by Nova'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_test_ssh_encrypt_decrypt_text'
op|'('
name|'key_with_spaces_in_comment'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_test_ssh_encrypt_decrypt_text
dedent|''
name|'def'
name|'_test_ssh_encrypt_decrypt_text'
op|'('
name|'self'
op|','
name|'key'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'enc'
op|'='
name|'crypto'
op|'.'
name|'ssh_encrypt_text'
op|'('
name|'self'
op|'.'
name|'pubkey'
op|','
name|'self'
op|'.'
name|'text'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsInstance'
op|'('
name|'enc'
op|','
name|'bytes'
op|')'
newline|'\n'
comment|'# Comparison between bytes and str raises a TypeError'
nl|'\n'
comment|'# when using python3 -bb'
nl|'\n'
name|'if'
name|'six'
op|'.'
name|'PY2'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'enc'
op|','
name|'self'
op|'.'
name|'text'
op|')'
newline|'\n'
dedent|''
name|'result'
op|'='
name|'self'
op|'.'
name|'_ssh_decrypt_text'
op|'('
name|'self'
op|'.'
name|'prikey'
op|','
name|'enc'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsInstance'
op|'('
name|'result'
op|','
name|'bytes'
op|')'
newline|'\n'
name|'if'
name|'six'
op|'.'
name|'PY3'
op|':'
newline|'\n'
indent|'            '
name|'result'
op|'='
name|'result'
op|'.'
name|'decode'
op|'('
string|"'utf-8'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'result'
op|','
name|'self'
op|'.'
name|'text'
op|')'
newline|'\n'
nl|'\n'
DECL|function|test_ssh_encrypt_failure
dedent|''
name|'def'
name|'test_ssh_encrypt_failure'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'EncryptionFailure'
op|','
nl|'\n'
name|'crypto'
op|'.'
name|'ssh_encrypt_text'
op|','
string|"''"
op|','
name|'self'
op|'.'
name|'text'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|KeyPairTest
dedent|''
dedent|''
name|'class'
name|'KeyPairTest'
op|'('
name|'test'
op|'.'
name|'NoDBTestCase'
op|')'
op|':'
newline|'\n'
DECL|variable|rsa_prv
indent|'    '
name|'rsa_prv'
op|'='
op|'('
nl|'\n'
string|'"-----BEGIN RSA PRIVATE KEY-----\\n"'
nl|'\n'
string|'"MIIEowIBAAKCAQEA5G44D6lEgMj6cRwCPydsMl1VRN2B9DVyV5lmwssGeJClywZM\\n"'
nl|'\n'
string|'"WcKlSZBaWPbwbt20/r74eMGZPlqtEi9Ro+EHj4/n5+3A2Mh11h0PGSt53PSPfWwo\\n"'
nl|'\n'
string|'"ZhEg9hQ1w1ZxfBMCx7eG2YdGFQocMgR0zQasJGjjt8hruCnWRB3pNH9DhEwKhgET\\n"'
nl|'\n'
string|'"H0/CFzxSh0eZWs/O4GSf4upwmRG/1Yu90vnVZq3AanwvvW5UBk6g4uWb6FTES867\\n"'
nl|'\n'
string|'"kAy4b5EcH6WR3lLE09omuG/NqtH+qkgIdQconDkmkuK3xf5go6GSwEod0erM1G1v\\n"'
nl|'\n'
string|'"e+C4w/MD98KZ4Zlon9hy7oE2rcqHXf58gZtOTQIDAQABAoIBAQCnkeM2Oemyv7xY\\n"'
nl|'\n'
string|'"dT+ArJ7GY4lFt2i5iOuUL0ge5Wid0R6OTNR9lDhEOszMLno6GhHIPrdvfjW4dDQ5\\n"'
nl|'\n'
string|'"/tRY757oRZzNmq+5V3R52V9WC3qeCBmq3EjWdwJDAphd72/YoOmNMKiPsphKntwI\\n"'
nl|'\n'
string|'"JRS5wodNPlSuYSwEMUypM3f7ttAEn5CASgYgribBDapm7EqkVa2AqSvpFzNvN3/e\\n"'
nl|'\n'
string|'"Sc36/XlxJin7AkKVOnRksuVOOj504VUQfXgVWZkfTeZqAROgA1FSnjUAffcubJmq\\n"'
nl|'\n'
string|'"pDL/JSgOqN4S+sJkkTrb19MuM9M/IdXteloynF+GUKZx6FdVQQc8xCiXgeupeeSD\\n"'
nl|'\n'
string|'"fNMAP7DRAoGBAP0JRFm3fCAavBREKVOyZm20DpeR6zMrVP7ht0SykkT/bw/kiRG+\\n"'
nl|'\n'
string|'"FH1tNioj9uyixt5SiKhH3ZVAunjsKvrwET8i3uz1M2Gk+ovWdLXurBogYNNWafjQ\\n"'
nl|'\n'
string|'"hRhFHpyExoZYRsn58bvYvjFXTO6JxuNS2b59DGBRkQ5mpsOhxarfbZnXAoGBAOcb\\n"'
nl|'\n'
string|'"K+qoPDeDicnQZ8+ygYYHxY3fy1nvm1F19jBiWd26bAUOHeZNPPKGvTSlrGWJgEyA\\n"'
nl|'\n'
string|'"FjZIlHJOY2s0dhukiytOiXzdA5iqK1NvlF+QTUI4tCeNMVejWC+n6sKR9ADZkX8D\\n"'
nl|'\n'
string|'"NOHaLkDzc/ukus59aKyjxP53I6SV6y6m5NeyvDx7AoGAaUji1MXA8wbMvU4DOB0h\\n"'
nl|'\n'
string|'"+4GRFMYVbEwaaJd4jzASJn12M9GuquBBXFMF15DxXFL6lmUXEZYdf83YCRqTY6hi\\n"'
nl|'\n'
string|'"NLgIs+XuxDFGQssv8sdletWAFE9/dpUk3A1eiFfC1wGCKuZCDBxKPvOJQjO3uryt\\n"'
nl|'\n'
string|'"d1JGxQkLZ0eVGg+E1O10iC8CgYB4w2QRfNPqllu8D6EPkVHJfeonltgmKOTajm+V\\n"'
nl|'\n'
string|'"HO+kw7OKeLP7EkVU3j+kcSZC8LUQRKZWu1qG2Jtu+7zz+OmYObPygXNNpS56rQW1\\n"'
nl|'\n'
string|'"Yixc/FB3knpEN2DvlilAfxAoGYjD/CL4GhCtdAoZZx0Opc262OEpr4v6hzSb7i4K\\n"'
nl|'\n'
string|'"4KUoXQKBgHfbiaSilxx9guUqvSaexpHmtiUwx05a05fD6tu8Cofl6AM9wGpw3xOT\\n"'
nl|'\n'
string|'"tfo4ehvS13tTz2RDE2xKuetMmkya7UgifcxUmBzqkOlgr0oOi2rp+eDKXnzUUqsH\\n"'
nl|'\n'
string|'"V7E96Dj36K8q2+gZIXcNqjN7PzfkF8pA0G+E1veTi8j5dnvIsy1x\\n"'
nl|'\n'
string|'"-----END RSA PRIVATE KEY-----\\n"'
nl|'\n'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|rsa_pub
name|'rsa_pub'
op|'='
op|'('
nl|'\n'
string|'"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDkbjgPqUSAyPpxHAI/J2wyXVVE"'
nl|'\n'
string|'"3YH0NXJXmWbCywZ4kKXLBkxZwqVJkFpY9vBu3bT+vvh4wZk+Wq0SL1Gj4QePj+fn"'
nl|'\n'
string|'"7cDYyHXWHQ8ZK3nc9I99bChmESD2FDXDVnF8EwLHt4bZh0YVChwyBHTNBqwkaOO3"'
nl|'\n'
string|'"yGu4KdZEHek0f0OETAqGARMfT8IXPFKHR5laz87gZJ/i6nCZEb/Vi73S+dVmrcBq"'
nl|'\n'
string|'"fC+9blQGTqDi5ZvoVMRLzruQDLhvkRwfpZHeUsTT2ia4b82q0f6qSAh1ByicOSaS"'
nl|'\n'
string|'"4rfF/mCjoZLASh3R6szUbW974LjD8wP3wpnhmWif2HLugTatyodd/nyBm05N Gen"'
nl|'\n'
string|'"erated-by-Nova"'
nl|'\n'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|rsa_fp
name|'rsa_fp'
op|'='
string|'"e7:66:a1:2c:4f:90:6e:11:19:da:ac:c2:69:e1:ad:89"'
newline|'\n'
nl|'\n'
DECL|variable|dss_pub
name|'dss_pub'
op|'='
op|'('
nl|'\n'
string|'"ssh-dss AAAAB3NzaC1kc3MAAACBAKWFW2++pDxJWObkADbSXw8KfZ4VupkRKEXF"'
nl|'\n'
string|'"SPN2kV0v+FgdnBEcrEJPExaOTMhmxIuc82ktTv76wHSEpbbsLuI7IDbB6KJJwHs2"'
nl|'\n'
string|'"y356yB28Q9rin7X0VMYKkPxvAcbIUSrEbQtyPMihlOaaQ2dGSsEQGQSpjm3f3RU6"'
nl|'\n'
string|'"OWux0w/NAAAAFQCgzWF2zxQmi/Obd11z9Im6gY02gwAAAIAHCDLjipVwMLXIqNKO"'
nl|'\n'
string|'"MktiPex+ewRQxBi80dzZ3mJzARqzLPYI9hJFUU0LiMtLuypV/djpUWN0cQpmgTQf"'
nl|'\n'
string|'"TfuZx9ipC6Mtiz66NQqjkQuoihzdk+9KlOTo03UsX5uBGwuZ09Dnf1VTF8ZsW5Hg"'
nl|'\n'
string|'"HyOk6qD71QBajkcFJAKOT3rFfgAAAIAy8trIzqEps9/n37Nli1TvNPLbFQAXl1LN"'
nl|'\n'
string|'"wUFmFDwBCGTLl8puVZv7VSu1FG8ko+mzqNebqcN4RMC26NxJqe+RRubn5KtmLoIa"'
nl|'\n'
string|'"7tRe74hvQ1HTLLuGxugwa4CewNbwzzEDEs8U79WDhGKzDkJR4nLPVimj5WLAWV70"'
nl|'\n'
string|'"RNnRX7zj5w== Generated-by-Nova"'
nl|'\n'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|dss_fp
name|'dss_fp'
op|'='
string|'"b9:dc:ac:57:df:2a:2b:cf:65:a8:c3:4e:9d:4a:82:3c"'
newline|'\n'
nl|'\n'
DECL|variable|ecdsa_pub
name|'ecdsa_pub'
op|'='
op|'('
nl|'\n'
string|'"ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAy"'
nl|'\n'
string|'"NTYAAABBBG1r4wzPTIjSo78POCq+u/czb8gYK0KvqlmCvcRPrnDWxgLw7y6BX51t"'
nl|'\n'
string|'"uYREz7iLRCP7BwUt8R+ZWzFZDeOLIWU= Generated-by-Nova"'
nl|'\n'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|ecdsa_pub_with_spaces
name|'ecdsa_pub_with_spaces'
op|'='
op|'('
nl|'\n'
string|'"ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAy"'
nl|'\n'
string|'"NTYAAABBBG1r4wzPTIjSo78POCq+u/czb8gYK0KvqlmCvcRPrnDWxgLw7y6BX51t"'
nl|'\n'
string|'"uYREz7iLRCP7BwUt8R+ZWzFZDeOLIWU= Generated by Nova"'
nl|'\n'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|ecdsa_fp
name|'ecdsa_fp'
op|'='
string|'"16:6a:c9:ec:80:4d:17:3e:d5:3b:6f:c0:d7:15:04:40"'
newline|'\n'
nl|'\n'
DECL|member|test_generate_fingerprint
name|'def'
name|'test_generate_fingerprint'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'fingerprint'
op|'='
name|'crypto'
op|'.'
name|'generate_fingerprint'
op|'('
name|'self'
op|'.'
name|'rsa_pub'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'rsa_fp'
op|','
name|'fingerprint'
op|')'
newline|'\n'
nl|'\n'
name|'fingerprint'
op|'='
name|'crypto'
op|'.'
name|'generate_fingerprint'
op|'('
name|'self'
op|'.'
name|'dss_pub'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'dss_fp'
op|','
name|'fingerprint'
op|')'
newline|'\n'
nl|'\n'
name|'fingerprint'
op|'='
name|'crypto'
op|'.'
name|'generate_fingerprint'
op|'('
name|'self'
op|'.'
name|'ecdsa_pub'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'ecdsa_fp'
op|','
name|'fingerprint'
op|')'
newline|'\n'
nl|'\n'
name|'fingerprint'
op|'='
name|'crypto'
op|'.'
name|'generate_fingerprint'
op|'('
name|'self'
op|'.'
name|'ecdsa_pub_with_spaces'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'ecdsa_fp'
op|','
name|'fingerprint'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_generate_key_pair_2048_bits
dedent|''
name|'def'
name|'test_generate_key_pair_2048_bits'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
op|'('
name|'private_key'
op|','
name|'public_key'
op|','
name|'fingerprint'
op|')'
op|'='
name|'crypto'
op|'.'
name|'generate_key_pair'
op|'('
op|')'
newline|'\n'
name|'pub_bytes'
op|'='
name|'public_key'
op|'.'
name|'encode'
op|'('
string|"'utf-8'"
op|')'
newline|'\n'
name|'pkey'
op|'='
name|'serialization'
op|'.'
name|'load_ssh_public_key'
op|'('
nl|'\n'
name|'pub_bytes'
op|','
name|'backends'
op|'.'
name|'default_backend'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2048'
op|','
name|'pkey'
op|'.'
name|'key_size'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_generate_key_pair_1024_bits
dedent|''
name|'def'
name|'test_generate_key_pair_1024_bits'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'bits'
op|'='
number|'1024'
newline|'\n'
op|'('
name|'private_key'
op|','
name|'public_key'
op|','
name|'fingerprint'
op|')'
op|'='
name|'crypto'
op|'.'
name|'generate_key_pair'
op|'('
name|'bits'
op|')'
newline|'\n'
name|'pub_bytes'
op|'='
name|'public_key'
op|'.'
name|'encode'
op|'('
string|"'utf-8'"
op|')'
newline|'\n'
name|'pkey'
op|'='
name|'serialization'
op|'.'
name|'load_ssh_public_key'
op|'('
nl|'\n'
name|'pub_bytes'
op|','
name|'backends'
op|'.'
name|'default_backend'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'bits'
op|','
name|'pkey'
op|'.'
name|'key_size'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_generate_key_pair_mocked_private_key
dedent|''
name|'def'
name|'test_generate_key_pair_mocked_private_key'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'keyin'
op|'='
name|'six'
op|'.'
name|'StringIO'
op|'('
op|')'
newline|'\n'
name|'keyin'
op|'.'
name|'write'
op|'('
name|'self'
op|'.'
name|'rsa_prv'
op|')'
newline|'\n'
name|'keyin'
op|'.'
name|'seek'
op|'('
number|'0'
op|')'
newline|'\n'
name|'key'
op|'='
name|'paramiko'
op|'.'
name|'RSAKey'
op|'.'
name|'from_private_key'
op|'('
name|'keyin'
op|')'
newline|'\n'
nl|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'paramiko'
op|'.'
name|'RSAKey'
op|','
string|"'generate'"
op|')'
name|'as'
name|'mock_generate'
op|':'
newline|'\n'
indent|'            '
name|'mock_generate'
op|'.'
name|'return_value'
op|'='
name|'key'
newline|'\n'
op|'('
name|'private_key'
op|','
name|'public_key'
op|','
name|'fingerprint'
op|')'
op|'='
name|'crypto'
op|'.'
name|'generate_key_pair'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'rsa_pub'
op|','
name|'public_key'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'rsa_fp'
op|','
name|'fingerprint'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
endmarker|''
end_unit
