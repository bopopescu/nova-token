begin_unit
comment|'# Copyright 2015 HPE, Inc.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'# not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'# a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'# License for the specific language governing permissions and limitations'
nl|'\n'
comment|'# under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'mock'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
op|'.'
name|'cmd'
name|'import'
name|'api'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'config'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'test'
newline|'\n'
nl|'\n'
nl|'\n'
comment|'# required because otherwise oslo early parse_args dies'
nl|'\n'
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'config'
op|','
string|"'parse_args'"
op|','
name|'new'
op|'='
name|'lambda'
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|':'
name|'None'
op|')'
newline|'\n'
DECL|class|TestNovaAPI
name|'class'
name|'TestNovaAPI'
op|'('
name|'test'
op|'.'
name|'NoDBTestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'    '
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'nova.service.process_launcher'"
op|')'
newline|'\n'
DECL|member|test_with_ec2
name|'def'
name|'test_with_ec2'
op|'('
name|'self'
op|','
name|'launcher'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Ensure that we don\'t explode if enabled_apis is wrong.\n\n        If the end user hasn\'t updated their config, an ec2 entry\n        might accidentally kill them in starting up their server. This\n        tests that our new safety filter will prevent that.\n\n        The metadata api is excluded because it loads a bunch of the\n        network stack, which requires other mocking.\n        """'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'enabled_apis'
op|'='
op|'['
string|"'ec2'"
op|','
string|"'osapi_compute'"
op|']'
op|')'
newline|'\n'
comment|'# required because of where the portbind happens, so that we'
nl|'\n'
comment|'# collide on ports.'
nl|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'osapi_compute_listen_port'
op|'='
number|'0'
op|')'
newline|'\n'
name|'api'
op|'.'
name|'main'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_continues_on_failure
dedent|''
name|'def'
name|'test_continues_on_failure'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'count'
op|'='
op|'['
number|'1'
op|','
number|'2'
op|']'
newline|'\n'
nl|'\n'
name|'fake_server'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'fake_server'
op|'.'
name|'workers'
op|'='
number|'123'
newline|'\n'
nl|'\n'
DECL|function|fake_service
name|'def'
name|'fake_service'
op|'('
name|'api'
op|','
op|'**'
name|'kw'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'while'
name|'count'
op|':'
newline|'\n'
indent|'                '
name|'count'
op|'.'
name|'pop'
op|'('
op|')'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'PasteAppNotFound'
op|'('
name|'name'
op|'='
name|'api'
op|','
name|'path'
op|'='
string|"'/'"
op|')'
newline|'\n'
dedent|''
name|'return'
name|'fake_server'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'flags'
op|'('
name|'enabled_apis'
op|'='
op|'['
string|"'foo'"
op|','
string|"'bar'"
op|','
string|"'baz'"
op|']'
op|')'
newline|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'api'
op|','
string|"'service'"
op|')'
name|'as'
name|'mock_service'
op|':'
newline|'\n'
indent|'            '
name|'mock_service'
op|'.'
name|'WSGIService'
op|'.'
name|'side_effect'
op|'='
name|'fake_service'
newline|'\n'
name|'api'
op|'.'
name|'main'
op|'('
op|')'
newline|'\n'
name|'mock_service'
op|'.'
name|'WSGIService'
op|'.'
name|'assert_has_calls'
op|'('
op|'['
nl|'\n'
name|'mock'
op|'.'
name|'call'
op|'('
string|"'foo'"
op|','
name|'use_ssl'
op|'='
name|'False'
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'call'
op|'('
string|"'bar'"
op|','
name|'use_ssl'
op|'='
name|'False'
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'call'
op|'('
string|"'baz'"
op|','
name|'use_ssl'
op|'='
name|'False'
op|')'
op|','
nl|'\n'
op|']'
op|')'
newline|'\n'
name|'launcher'
op|'='
name|'mock_service'
op|'.'
name|'process_launcher'
op|'.'
name|'return_value'
newline|'\n'
name|'launcher'
op|'.'
name|'launch_service'
op|'.'
name|'assert_called_once_with'
op|'('
nl|'\n'
name|'fake_server'
op|','
name|'workers'
op|'='
number|'123'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
endmarker|''
end_unit
