begin_unit
comment|'# Copyright 2014 Cloudbase Solutions Srl'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# All Rights Reserved.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'mock'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
name|'import'
name|'test'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'hyperv'
name|'import'
name|'basevolumeutils'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|_exception_thrower
name|'def'
name|'_exception_thrower'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'raise'
name|'Exception'
op|'('
string|'"Testing exception handling."'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|BaseVolumeUtilsTestCase
dedent|''
name|'class'
name|'BaseVolumeUtilsTestCase'
op|'('
name|'test'
op|'.'
name|'NoDBTestCase'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Unit tests for the Hyper-V BaseVolumeUtils class."""'
newline|'\n'
nl|'\n'
DECL|variable|_FAKE_COMPUTER_NAME
name|'_FAKE_COMPUTER_NAME'
op|'='
string|'"fake_computer_name"'
newline|'\n'
DECL|variable|_FAKE_DOMAIN_NAME
name|'_FAKE_DOMAIN_NAME'
op|'='
string|'"fake_domain_name"'
newline|'\n'
DECL|variable|_FAKE_INITIATOR_NAME
name|'_FAKE_INITIATOR_NAME'
op|'='
string|'"fake_initiator_name"'
newline|'\n'
DECL|variable|_FAKE_INITIATOR_IQN_NAME
name|'_FAKE_INITIATOR_IQN_NAME'
op|'='
string|'"iqn.1991-05.com.microsoft:fake_computer_name"'
newline|'\n'
name|'_FAKE_DISK_PATH'
op|'='
string|'\'fake_path DeviceID="123\\\\\\\\2"\''
newline|'\n'
DECL|variable|_FAKE_MOUNT_DEVICE
name|'_FAKE_MOUNT_DEVICE'
op|'='
string|"'/dev/fake/mount'"
newline|'\n'
DECL|variable|_FAKE_DEVICE_NAME
name|'_FAKE_DEVICE_NAME'
op|'='
string|"'/dev/fake/path'"
newline|'\n'
DECL|variable|_FAKE_SWAP
name|'_FAKE_SWAP'
op|'='
op|'{'
string|"'device_name'"
op|':'
name|'_FAKE_DISK_PATH'
op|'}'
newline|'\n'
nl|'\n'
DECL|member|setUp
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_volutils'
op|'='
name|'basevolumeutils'
op|'.'
name|'BaseVolumeUtils'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_volutils'
op|'.'
name|'_conn_wmi'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_volutils'
op|'.'
name|'_conn_cimv2'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'super'
op|'('
name|'BaseVolumeUtilsTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_iscsi_initiator_ok
dedent|''
name|'def'
name|'test_get_iscsi_initiator_ok'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_check_get_iscsi_initiator'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'return_value'
op|'='
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_KEY'
op|')'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_FAKE_INITIATOR_NAME'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_iscsi_initiator_exception
dedent|''
name|'def'
name|'test_get_iscsi_initiator_exception'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'initiator_name'
op|'='
string|'"%(iqn)s.%(domain)s"'
op|'%'
op|'{'
nl|'\n'
string|"'iqn'"
op|':'
name|'self'
op|'.'
name|'_FAKE_INITIATOR_IQN_NAME'
op|','
nl|'\n'
string|"'domain'"
op|':'
name|'self'
op|'.'
name|'_FAKE_DOMAIN_NAME'
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_check_get_iscsi_initiator'
op|'('
name|'_exception_thrower'
op|','
name|'initiator_name'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_check_get_iscsi_initiator
dedent|''
name|'def'
name|'_check_get_iscsi_initiator'
op|'('
name|'self'
op|','
name|'winreg_method'
op|','
name|'expected'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_computer'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'mock_computer'
op|'.'
name|'name'
op|'='
name|'self'
op|'.'
name|'_FAKE_COMPUTER_NAME'
newline|'\n'
name|'mock_computer'
op|'.'
name|'Domain'
op|'='
name|'self'
op|'.'
name|'_FAKE_DOMAIN_NAME'
newline|'\n'
name|'self'
op|'.'
name|'_volutils'
op|'.'
name|'_conn_cimv2'
op|'.'
name|'Win32_ComputerSystem'
op|'.'
name|'return_value'
op|'='
op|'['
nl|'\n'
name|'mock_computer'
op|']'
newline|'\n'
nl|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'basevolumeutils'
op|','
nl|'\n'
string|"'_winreg'"
op|','
name|'create'
op|'='
name|'True'
op|')'
name|'as'
name|'mock_winreg'
op|':'
newline|'\n'
indent|'            '
name|'mock_winreg'
op|'.'
name|'OpenKey'
op|'='
name|'winreg_method'
newline|'\n'
name|'mock_winreg'
op|'.'
name|'QueryValueEx'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'return_value'
op|'='
op|'['
name|'expected'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'initiator_name'
op|'='
name|'self'
op|'.'
name|'_volutils'
op|'.'
name|'get_iscsi_initiator'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
name|'initiator_name'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'basevolumeutils'
op|','
string|"'driver'"
op|')'
newline|'\n'
DECL|member|test_volume_in_mapping
name|'def'
name|'test_volume_in_mapping'
op|'('
name|'self'
op|','
name|'mock_driver'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_driver'
op|'.'
name|'block_device_info_get_mapping'
op|'.'
name|'return_value'
op|'='
op|'['
nl|'\n'
op|'{'
string|"'mount_device'"
op|':'
name|'self'
op|'.'
name|'_FAKE_MOUNT_DEVICE'
op|'}'
op|']'
newline|'\n'
name|'mock_driver'
op|'.'
name|'block_device_info_get_swap'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
nl|'\n'
name|'return_value'
op|'='
name|'self'
op|'.'
name|'_FAKE_SWAP'
op|')'
newline|'\n'
name|'mock_driver'
op|'.'
name|'block_device_info_get_ephemerals'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
nl|'\n'
name|'return_value'
op|'='
op|'['
op|'{'
string|"'device_name'"
op|':'
name|'self'
op|'.'
name|'_FAKE_DEVICE_NAME'
op|'}'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'mock_driver'
op|'.'
name|'swap_is_usable'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'return_value'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'self'
op|'.'
name|'_volutils'
op|'.'
name|'volume_in_mapping'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_FAKE_MOUNT_DEVICE'
op|','
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_BLOCK_DEVICE_INFO'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'basevolumeutils'
op|'.'
name|'BaseVolumeUtils'
op|','
nl|'\n'
string|'"_get_drive_number_from_disk_path"'
op|')'
newline|'\n'
DECL|member|test_get_session_id_from_mounted_disk
name|'def'
name|'test_get_session_id_from_mounted_disk'
op|'('
name|'self'
op|','
name|'mock_get_session_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_get_session_id'
op|'.'
name|'return_value'
op|'='
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_DEVICE_NUMBER'
newline|'\n'
name|'mock_initiator_session'
op|'='
name|'self'
op|'.'
name|'_create_initiator_session'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_volutils'
op|'.'
name|'_conn_wmi'
op|'.'
name|'query'
op|'.'
name|'return_value'
op|'='
op|'['
name|'mock_initiator_session'
op|']'
newline|'\n'
name|'session_id'
op|'='
name|'self'
op|'.'
name|'_volutils'
op|'.'
name|'get_session_id_from_mounted_disk'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_FAKE_DISK_PATH'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_SESSION_ID'
op|','
name|'session_id'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_devices_for_target
dedent|''
name|'def'
name|'test_get_devices_for_target'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'init_session'
op|'='
name|'self'
op|'.'
name|'_create_initiator_session'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_volutils'
op|'.'
name|'_conn_wmi'
op|'.'
name|'query'
op|'.'
name|'return_value'
op|'='
op|'['
name|'init_session'
op|']'
newline|'\n'
name|'devices'
op|'='
name|'self'
op|'.'
name|'_volutils'
op|'.'
name|'_get_devices_for_target'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_IQN'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'init_session'
op|'.'
name|'Devices'
op|','
name|'devices'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_devices_for_target_not_found
dedent|''
name|'def'
name|'test_get_devices_for_target_not_found'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_volutils'
op|'.'
name|'_conn_wmi'
op|'.'
name|'query'
op|'.'
name|'return_value'
op|'='
name|'None'
newline|'\n'
name|'devices'
op|'='
name|'self'
op|'.'
name|'_volutils'
op|'.'
name|'_get_devices_for_target'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_IQN'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'len'
op|'('
name|'devices'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'basevolumeutils'
op|'.'
name|'BaseVolumeUtils'
op|','
nl|'\n'
string|"'_get_devices_for_target'"
op|')'
newline|'\n'
DECL|member|test_get_device_number_for_target
name|'def'
name|'test_get_device_number_for_target'
op|'('
name|'self'
op|','
name|'fake_get_devices'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'init_session'
op|'='
name|'self'
op|'.'
name|'_create_initiator_session'
op|'('
op|')'
newline|'\n'
name|'fake_get_devices'
op|'.'
name|'return_value'
op|'='
name|'init_session'
op|'.'
name|'Devices'
newline|'\n'
name|'device_number'
op|'='
name|'self'
op|'.'
name|'_volutils'
op|'.'
name|'get_device_number_for_target'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_IQN'
op|','
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_LUN'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_DEVICE_NUMBER'
op|','
name|'device_number'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'basevolumeutils'
op|'.'
name|'BaseVolumeUtils'
op|','
nl|'\n'
string|"'_get_devices_for_target'"
op|')'
newline|'\n'
DECL|member|test_get_target_lun_count
name|'def'
name|'test_get_target_lun_count'
op|'('
name|'self'
op|','
name|'fake_get_devices'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'init_session'
op|'='
name|'self'
op|'.'
name|'_create_initiator_session'
op|'('
op|')'
newline|'\n'
comment|'# Only disk devices are being counted.'
nl|'\n'
name|'disk_device'
op|'='
name|'mock'
op|'.'
name|'Mock'
op|'('
name|'DeviceType'
op|'='
name|'self'
op|'.'
name|'_volutils'
op|'.'
name|'_FILE_DEVICE_DISK'
op|')'
newline|'\n'
name|'init_session'
op|'.'
name|'Devices'
op|'.'
name|'append'
op|'('
name|'disk_device'
op|')'
newline|'\n'
name|'fake_get_devices'
op|'.'
name|'return_value'
op|'='
name|'init_session'
op|'.'
name|'Devices'
newline|'\n'
nl|'\n'
name|'lun_count'
op|'='
name|'self'
op|'.'
name|'_volutils'
op|'.'
name|'get_target_lun_count'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_IQN'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'lun_count'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'basevolumeutils'
op|'.'
name|'BaseVolumeUtils'
op|','
nl|'\n'
string|'"_get_drive_number_from_disk_path"'
op|')'
newline|'\n'
DECL|member|test_get_target_from_disk_path
name|'def'
name|'test_get_target_from_disk_path'
op|'('
name|'self'
op|','
name|'mock_get_session_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_get_session_id'
op|'.'
name|'return_value'
op|'='
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_DEVICE_NUMBER'
newline|'\n'
name|'init_sess'
op|'='
name|'self'
op|'.'
name|'_create_initiator_session'
op|'('
op|')'
newline|'\n'
name|'mock_ses_class'
op|'='
name|'self'
op|'.'
name|'_volutils'
op|'.'
name|'_conn_wmi'
op|'.'
name|'MSiSCSIInitiator_SessionClass'
newline|'\n'
name|'mock_ses_class'
op|'.'
name|'return_value'
op|'='
op|'['
name|'init_sess'
op|']'
newline|'\n'
nl|'\n'
op|'('
name|'target_name'
op|','
name|'scsi_lun'
op|')'
op|'='
name|'self'
op|'.'
name|'_volutils'
op|'.'
name|'get_target_from_disk_path'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_FAKE_DISK_PATH'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_TARGET_NAME'
op|','
name|'target_name'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_LUN'
op|','
name|'scsi_lun'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_create_initiator_session
dedent|''
name|'def'
name|'_create_initiator_session'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'device'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'device'
op|'.'
name|'ScsiLun'
op|'='
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_LUN'
newline|'\n'
name|'device'
op|'.'
name|'DeviceNumber'
op|'='
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_DEVICE_NUMBER'
newline|'\n'
name|'device'
op|'.'
name|'TargetName'
op|'='
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_TARGET_NAME'
newline|'\n'
name|'init_session'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'init_session'
op|'.'
name|'Devices'
op|'='
op|'['
name|'device'
op|']'
newline|'\n'
name|'init_session'
op|'.'
name|'SessionId'
op|'='
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_SESSION_ID'
newline|'\n'
nl|'\n'
name|'return'
name|'init_session'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
