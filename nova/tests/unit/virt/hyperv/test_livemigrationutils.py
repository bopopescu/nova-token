begin_unit
comment|'# Copyright 2014 Cloudbase Solutions Srl'
nl|'\n'
comment|'# All Rights Reserved.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'mock'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'test'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'hyperv'
name|'import'
name|'livemigrationutils'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'hyperv'
name|'import'
name|'vmutils'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|LiveMigrationUtilsTestCase
name|'class'
name|'LiveMigrationUtilsTestCase'
op|'('
name|'test'
op|'.'
name|'NoDBTestCase'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Unit tests for the Hyper-V LiveMigrationUtils class."""'
newline|'\n'
nl|'\n'
DECL|variable|_FAKE_VM_NAME
name|'_FAKE_VM_NAME'
op|'='
string|"'fake_vm_name'"
newline|'\n'
DECL|variable|_FAKE_RET_VAL
name|'_FAKE_RET_VAL'
op|'='
number|'0'
newline|'\n'
nl|'\n'
DECL|variable|_RESOURCE_TYPE_VHD
name|'_RESOURCE_TYPE_VHD'
op|'='
number|'31'
newline|'\n'
DECL|variable|_RESOURCE_TYPE_DISK
name|'_RESOURCE_TYPE_DISK'
op|'='
number|'17'
newline|'\n'
DECL|variable|_RESOURCE_SUB_TYPE_VHD
name|'_RESOURCE_SUB_TYPE_VHD'
op|'='
string|"'Microsoft:Hyper-V:Virtual Hard Disk'"
newline|'\n'
DECL|variable|_RESOURCE_SUB_TYPE_DISK
name|'_RESOURCE_SUB_TYPE_DISK'
op|'='
string|"'Microsoft:Hyper-V:Physical Disk Drive'"
newline|'\n'
nl|'\n'
DECL|member|setUp
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'liveutils'
op|'='
name|'livemigrationutils'
op|'.'
name|'LiveMigrationUtils'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_vmutils'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_volutils'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_conn'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_get_conn_v2'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
name|'return_value'
op|'='
name|'self'
op|'.'
name|'_conn'
op|')'
newline|'\n'
nl|'\n'
name|'super'
op|'('
name|'LiveMigrationUtilsTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_check_live_migration_config
dedent|''
name|'def'
name|'test_check_live_migration_config'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_migr_svc'
op|'='
name|'self'
op|'.'
name|'_conn'
op|'.'
name|'Msvm_VirtualSystemMigrationService'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
name|'vsmssd'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'vsmssd'
op|'.'
name|'EnableVirtualSystemMigration'
op|'='
name|'True'
newline|'\n'
name|'mock_migr_svc'
op|'.'
name|'associators'
op|'.'
name|'return_value'
op|'='
op|'['
name|'vsmssd'
op|']'
newline|'\n'
name|'mock_migr_svc'
op|'.'
name|'MigrationServiceListenerIPAdressList'
op|'.'
name|'return_value'
op|'='
op|'['
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_HOST'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'check_live_migration_config'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'mock_migr_svc'
op|'.'
name|'associators'
op|'.'
name|'called'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_vm
dedent|''
name|'def'
name|'test_get_vm'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'expected_vm'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'mock_conn_v2'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'mock_conn_v2'
op|'.'
name|'Msvm_ComputerSystem'
op|'.'
name|'return_value'
op|'='
op|'['
name|'expected_vm'
op|']'
newline|'\n'
nl|'\n'
name|'found_vm'
op|'='
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_get_vm'
op|'('
name|'mock_conn_v2'
op|','
name|'self'
op|'.'
name|'_FAKE_VM_NAME'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected_vm'
op|','
name|'found_vm'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_vm_duplicate
dedent|''
name|'def'
name|'test_get_vm_duplicate'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_vm'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'mock_conn_v2'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'mock_conn_v2'
op|'.'
name|'Msvm_ComputerSystem'
op|'.'
name|'return_value'
op|'='
op|'['
name|'mock_vm'
op|','
name|'mock_vm'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'vmutils'
op|'.'
name|'HyperVException'
op|','
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_get_vm'
op|','
nl|'\n'
name|'mock_conn_v2'
op|','
name|'self'
op|'.'
name|'_FAKE_VM_NAME'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_vm_not_found
dedent|''
name|'def'
name|'test_get_vm_not_found'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_conn_v2'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'mock_conn_v2'
op|'.'
name|'Msvm_ComputerSystem'
op|'.'
name|'return_value'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceNotFound'
op|','
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_get_vm'
op|','
nl|'\n'
name|'mock_conn_v2'
op|','
name|'self'
op|'.'
name|'_FAKE_VM_NAME'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'livemigrationutils'
op|'.'
name|'LiveMigrationUtils'
op|','
nl|'\n'
string|"'_destroy_planned_vm'"
op|')'
newline|'\n'
DECL|member|test_check_existing_planned_vm_found
name|'def'
name|'test_check_existing_planned_vm_found'
op|'('
name|'self'
op|','
name|'mock_destroy_planned_vm'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_vm'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'mock_v2'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'mock_v2'
op|'.'
name|'Msvm_PlannedComputerSystem'
op|'.'
name|'return_value'
op|'='
op|'['
name|'mock_vm'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_check_existing_planned_vm'
op|'('
name|'mock_v2'
op|','
name|'mock_vm'
op|')'
newline|'\n'
nl|'\n'
name|'mock_destroy_planned_vm'
op|'.'
name|'assert_called_once_with'
op|'('
name|'mock_v2'
op|','
name|'mock_vm'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'livemigrationutils'
op|'.'
name|'LiveMigrationUtils'
op|','
nl|'\n'
string|"'_destroy_planned_vm'"
op|')'
newline|'\n'
DECL|member|test_check_existing_planned_vm_none
name|'def'
name|'test_check_existing_planned_vm_none'
op|'('
name|'self'
op|','
name|'mock_destroy_planned_vm'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_v2'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'mock_v2'
op|'.'
name|'Msvm_PlannedComputerSystem'
op|'.'
name|'return_value'
op|'='
op|'['
op|']'
newline|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_check_existing_planned_vm'
op|'('
name|'mock_v2'
op|','
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'mock_destroy_planned_vm'
op|'.'
name|'called'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_remote_planned_vm
dedent|''
name|'def'
name|'test_create_remote_planned_vm'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_vsmsd'
op|'='
name|'self'
op|'.'
name|'_conn'
op|'.'
name|'query'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'mock_vm'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'mock_v2'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'mock_v2'
op|'.'
name|'Msvm_PlannedComputerSystem'
op|'.'
name|'return_value'
op|'='
op|'['
name|'mock_vm'
op|']'
newline|'\n'
nl|'\n'
name|'migr_svc'
op|'='
name|'self'
op|'.'
name|'_conn'
op|'.'
name|'Msvm_VirtualSystemMigrationService'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'migr_svc'
op|'.'
name|'MigrateVirtualSystemToHost'
op|'.'
name|'return_value'
op|'='
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_FAKE_RET_VAL'
op|','
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_JOB_PATH'
op|')'
newline|'\n'
nl|'\n'
name|'resulted_vm'
op|'='
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_create_remote_planned_vm'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_conn'
op|','
name|'mock_v2'
op|','
name|'mock_vm'
op|','
op|'['
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_REMOTE_IP_ADDR'
op|']'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_HOST'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'mock_vm'
op|','
name|'resulted_vm'
op|')'
newline|'\n'
nl|'\n'
name|'migr_svc'
op|'.'
name|'MigrateVirtualSystemToHost'
op|'.'
name|'assert_called_once_with'
op|'('
nl|'\n'
name|'ComputerSystem'
op|'='
name|'mock_vm'
op|'.'
name|'path_'
op|'.'
name|'return_value'
op|','
nl|'\n'
name|'DestinationHost'
op|'='
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_HOST'
op|','
nl|'\n'
name|'MigrationSettingData'
op|'='
name|'mock_vsmsd'
op|'.'
name|'GetText_'
op|'.'
name|'return_value'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_physical_disk_paths
dedent|''
name|'def'
name|'test_get_physical_disk_paths'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ide_path'
op|'='
op|'{'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'IDE_PATH'
op|':'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'IDE_HOST_RESOURCE'
op|'}'
newline|'\n'
name|'scsi_path'
op|'='
op|'{'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'SCSI_PATH'
op|':'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'SCSI_HOST_RESOURCE'
op|'}'
newline|'\n'
name|'ide_ctrl'
op|'='
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_vmutils'
op|'.'
name|'get_vm_ide_controller'
op|'.'
name|'return_value'
newline|'\n'
name|'scsi_ctrl'
op|'='
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_vmutils'
op|'.'
name|'get_vm_scsi_controller'
op|'.'
name|'return_value'
newline|'\n'
name|'mock_get_controller_paths'
op|'='
op|'('
nl|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_vmutils'
op|'.'
name|'get_controller_volume_paths'
op|')'
newline|'\n'
nl|'\n'
name|'mock_get_controller_paths'
op|'.'
name|'side_effect'
op|'='
op|'['
name|'ide_path'
op|','
name|'scsi_path'
op|']'
newline|'\n'
nl|'\n'
name|'result'
op|'='
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_get_physical_disk_paths'
op|'('
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'VM_NAME'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
name|'dict'
op|'('
name|'ide_path'
op|')'
newline|'\n'
name|'expected'
op|'.'
name|'update'
op|'('
name|'scsi_path'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertDictContainsSubset'
op|'('
name|'expected'
op|','
name|'result'
op|')'
newline|'\n'
name|'calls'
op|'='
op|'['
name|'mock'
op|'.'
name|'call'
op|'('
name|'ide_ctrl'
op|')'
op|','
name|'mock'
op|'.'
name|'call'
op|'('
name|'scsi_ctrl'
op|')'
op|']'
newline|'\n'
name|'mock_get_controller_paths'
op|'.'
name|'assert_has_calls'
op|'('
name|'calls'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_physical_disk_paths_no_ide
dedent|''
name|'def'
name|'test_get_physical_disk_paths_no_ide'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'scsi_path'
op|'='
op|'{'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'SCSI_PATH'
op|':'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'SCSI_HOST_RESOURCE'
op|'}'
newline|'\n'
name|'scsi_ctrl'
op|'='
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_vmutils'
op|'.'
name|'get_vm_scsi_controller'
op|'.'
name|'return_value'
newline|'\n'
name|'mock_get_controller_paths'
op|'='
op|'('
nl|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_vmutils'
op|'.'
name|'get_controller_volume_paths'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_vmutils'
op|'.'
name|'get_vm_ide_controller'
op|'.'
name|'return_value'
op|'='
name|'None'
newline|'\n'
name|'mock_get_controller_paths'
op|'.'
name|'return_value'
op|'='
name|'scsi_path'
newline|'\n'
nl|'\n'
name|'result'
op|'='
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_get_physical_disk_paths'
op|'('
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'VM_NAME'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'scsi_path'
op|','
name|'result'
op|')'
newline|'\n'
name|'mock_get_controller_paths'
op|'.'
name|'assert_called_once_with'
op|'('
name|'scsi_ctrl'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'livemigrationutils'
op|'.'
name|'volumeutilsv2'
op|','
string|"'VolumeUtilsV2'"
op|')'
newline|'\n'
DECL|member|test_get_remote_disk_data
name|'def'
name|'test_get_remote_disk_data'
op|'('
name|'self'
op|','
name|'mock_vol_utils_class'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_vol_utils_remote'
op|'='
name|'mock_vol_utils_class'
op|'.'
name|'return_value'
newline|'\n'
name|'mock_vm_utils'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'disk_paths'
op|'='
op|'{'
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_RASD_PATH'
op|':'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_DISK_PATH'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_volutils'
op|'.'
name|'get_target_from_disk_path'
op|'.'
name|'return_value'
op|'='
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_IQN'
op|','
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_LUN'
op|')'
newline|'\n'
name|'mock_vol_utils_remote'
op|'.'
name|'get_device_number_for_target'
op|'.'
name|'return_value'
op|'='
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_DEV_NUM'
op|')'
newline|'\n'
name|'mock_vm_utils'
op|'.'
name|'get_mounted_disk_by_drive_number'
op|'.'
name|'return_value'
op|'='
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_DISK_PATH'
op|')'
newline|'\n'
nl|'\n'
name|'disk_paths'
op|'='
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_get_remote_disk_data'
op|'('
nl|'\n'
name|'mock_vm_utils'
op|','
name|'disk_paths'
op|','
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_HOST'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_volutils'
op|'.'
name|'get_target_from_disk_path'
op|'.'
name|'assert_called_with'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_DISK_PATH'
op|')'
newline|'\n'
name|'mock_vol_utils_remote'
op|'.'
name|'get_device_number_for_target'
op|'.'
name|'assert_called_with'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_IQN'
op|','
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_LUN'
op|')'
newline|'\n'
name|'mock_vm_utils'
op|'.'
name|'get_mounted_disk_by_drive_number'
op|'.'
name|'assert_called_once_with'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_DEV_NUM'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
op|'{'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_RASD_PATH'
op|':'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_DISK_PATH'
op|'}'
op|','
nl|'\n'
name|'disk_paths'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_update_planned_vm_disk_resources
dedent|''
name|'def'
name|'test_update_planned_vm_disk_resources'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_vm_utils'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_prepare_vm_mocks'
op|'('
name|'self'
op|'.'
name|'_RESOURCE_TYPE_DISK'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_RESOURCE_SUB_TYPE_DISK'
op|')'
newline|'\n'
name|'mock_vm'
op|'='
name|'self'
op|'.'
name|'_conn'
op|'.'
name|'Msvm_ComputerSystem'
op|'.'
name|'return_value'
op|'['
number|'0'
op|']'
newline|'\n'
name|'sasd'
op|'='
name|'mock_vm'
op|'.'
name|'associators'
op|'('
op|')'
op|'['
number|'0'
op|']'
op|'.'
name|'associators'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
name|'mock_vsmsvc'
op|'='
name|'self'
op|'.'
name|'_conn'
op|'.'
name|'Msvm_VirtualSystemManagementService'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_update_planned_vm_disk_resources'
op|'('
nl|'\n'
name|'mock_vm_utils'
op|','
name|'self'
op|'.'
name|'_conn'
op|','
name|'mock_vm'
op|','
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_VM_NAME'
op|','
nl|'\n'
op|'{'
name|'sasd'
op|'.'
name|'path'
op|'.'
name|'return_value'
op|'.'
name|'RelPath'
op|':'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_RASD_PATH'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'mock_vsmsvc'
op|'.'
name|'ModifyResourceSettings'
op|'.'
name|'assert_called_once_with'
op|'('
nl|'\n'
name|'ResourceSettings'
op|'='
op|'['
name|'sasd'
op|'.'
name|'GetText_'
op|'.'
name|'return_value'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_vhd_setting_data
dedent|''
name|'def'
name|'test_get_vhd_setting_data'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_prepare_vm_mocks'
op|'('
name|'self'
op|'.'
name|'_RESOURCE_TYPE_VHD'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_RESOURCE_SUB_TYPE_VHD'
op|')'
newline|'\n'
name|'mock_vm'
op|'='
name|'self'
op|'.'
name|'_conn'
op|'.'
name|'Msvm_ComputerSystem'
op|'.'
name|'return_value'
op|'['
number|'0'
op|']'
newline|'\n'
name|'mock_sasd'
op|'='
name|'mock_vm'
op|'.'
name|'associators'
op|'('
op|')'
op|'['
number|'0'
op|']'
op|'.'
name|'associators'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
name|'vhd_sds'
op|'='
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_get_vhd_setting_data'
op|'('
name|'mock_vm'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'mock_sasd'
op|'.'
name|'GetText_'
op|'.'
name|'return_value'
op|']'
op|','
name|'vhd_sds'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_live_migrate_vm_helper
dedent|''
name|'def'
name|'test_live_migrate_vm_helper'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_conn_local'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'mock_vm'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'mock_vsmsd'
op|'='
name|'mock_conn_local'
op|'.'
name|'query'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
name|'mock_vsmsvc'
op|'='
name|'mock_conn_local'
op|'.'
name|'Msvm_VirtualSystemMigrationService'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'mock_vsmsvc'
op|'.'
name|'MigrateVirtualSystemToHost'
op|'.'
name|'return_value'
op|'='
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_FAKE_RET_VAL'
op|','
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_JOB_PATH'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_live_migrate_vm'
op|'('
nl|'\n'
name|'mock_conn_local'
op|','
name|'mock_vm'
op|','
name|'None'
op|','
nl|'\n'
op|'['
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_REMOTE_IP_ADDR'
op|']'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_RASD_PATH'
op|','
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_HOST'
op|')'
newline|'\n'
nl|'\n'
name|'mock_vsmsvc'
op|'.'
name|'MigrateVirtualSystemToHost'
op|'.'
name|'assert_called_once_with'
op|'('
nl|'\n'
name|'ComputerSystem'
op|'='
name|'mock_vm'
op|'.'
name|'path_'
op|'.'
name|'return_value'
op|','
nl|'\n'
name|'DestinationHost'
op|'='
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_HOST'
op|','
nl|'\n'
name|'MigrationSettingData'
op|'='
name|'mock_vsmsd'
op|'.'
name|'GetText_'
op|'.'
name|'return_value'
op|','
nl|'\n'
name|'NewResourceSettingData'
op|'='
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_RASD_PATH'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'livemigrationutils'
op|','
string|"'vmutilsv2'"
op|')'
newline|'\n'
DECL|member|test_live_migrate_vm
name|'def'
name|'test_live_migrate_vm'
op|'('
name|'self'
op|','
name|'mock_vm_utils'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_vm_utils_remote'
op|'='
name|'mock_vm_utils'
op|'.'
name|'VMUtilsV2'
op|'.'
name|'return_value'
newline|'\n'
name|'mock_vm'
op|'='
name|'self'
op|'.'
name|'_get_vm'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'mock_migr_svc'
op|'='
name|'self'
op|'.'
name|'_conn'
op|'.'
name|'Msvm_VirtualSystemMigrationService'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'mock_migr_svc'
op|'.'
name|'MigrationServiceListenerIPAddressList'
op|'='
op|'['
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_REMOTE_IP_ADDR'
op|']'
newline|'\n'
nl|'\n'
comment|'# patches, call and assertions.'
nl|'\n'
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'multiple'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'liveutils'
op|','
nl|'\n'
name|'_destroy_planned_vm'
op|'='
name|'mock'
op|'.'
name|'DEFAULT'
op|','
nl|'\n'
name|'_get_physical_disk_paths'
op|'='
name|'mock'
op|'.'
name|'DEFAULT'
op|','
nl|'\n'
name|'_get_remote_disk_data'
op|'='
name|'mock'
op|'.'
name|'DEFAULT'
op|','
nl|'\n'
name|'_create_remote_planned_vm'
op|'='
name|'mock'
op|'.'
name|'DEFAULT'
op|','
nl|'\n'
name|'_update_planned_vm_disk_resources'
op|'='
name|'mock'
op|'.'
name|'DEFAULT'
op|','
nl|'\n'
name|'_get_vhd_setting_data'
op|'='
name|'mock'
op|'.'
name|'DEFAULT'
op|','
nl|'\n'
name|'_live_migrate_vm'
op|'='
name|'mock'
op|'.'
name|'DEFAULT'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'            '
name|'disk_paths'
op|'='
op|'{'
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_IDE_PATH'
op|':'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_SASD_RESOURCE'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_get_physical_disk_paths'
op|'.'
name|'return_value'
op|'='
name|'disk_paths'
newline|'\n'
nl|'\n'
name|'mock_disk_paths'
op|'='
op|'['
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_DISK_PATH'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_get_remote_disk_data'
op|'.'
name|'return_value'
op|'='
op|'('
nl|'\n'
name|'mock_disk_paths'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_create_remote_planned_vm'
op|'.'
name|'return_value'
op|'='
name|'mock_vm'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'live_migrate_vm'
op|'('
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_VM_NAME'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_HOST'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_get_remote_disk_data'
op|'.'
name|'assert_called_once_with'
op|'('
nl|'\n'
name|'mock_vm_utils_remote'
op|','
name|'disk_paths'
op|','
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_HOST'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_create_remote_planned_vm'
op|'.'
name|'assert_called_once_with'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_conn'
op|','
name|'self'
op|'.'
name|'_conn'
op|','
name|'mock_vm'
op|','
nl|'\n'
op|'['
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_REMOTE_IP_ADDR'
op|']'
op|','
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_HOST'
op|')'
newline|'\n'
nl|'\n'
name|'mocked_method'
op|'='
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_update_planned_vm_disk_resources'
newline|'\n'
name|'mocked_method'
op|'.'
name|'assert_called_once_with'
op|'('
nl|'\n'
name|'mock_vm_utils_remote'
op|','
name|'self'
op|'.'
name|'_conn'
op|','
name|'mock_vm'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_VM_NAME'
op|','
name|'mock_disk_paths'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_live_migrate_vm'
op|'.'
name|'assert_called_once_with'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_conn'
op|','
name|'mock_vm'
op|','
name|'mock_vm'
op|','
nl|'\n'
op|'['
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_REMOTE_IP_ADDR'
op|']'
op|','
nl|'\n'
name|'self'
op|'.'
name|'liveutils'
op|'.'
name|'_get_vhd_setting_data'
op|'.'
name|'return_value'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_HOST'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_prepare_vm_mocks
dedent|''
dedent|''
name|'def'
name|'_prepare_vm_mocks'
op|'('
name|'self'
op|','
name|'resource_type'
op|','
name|'resource_sub_type'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_vm_svc'
op|'='
name|'self'
op|'.'
name|'_conn'
op|'.'
name|'Msvm_VirtualSystemManagementService'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'vm'
op|'='
name|'self'
op|'.'
name|'_get_vm'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_conn'
op|'.'
name|'Msvm_PlannedComputerSystem'
op|'.'
name|'return_value'
op|'='
op|'['
name|'vm'
op|']'
newline|'\n'
name|'mock_vm_svc'
op|'.'
name|'DestroySystem'
op|'.'
name|'return_value'
op|'='
op|'('
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_JOB_PATH'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_FAKE_RET_VAL'
op|')'
newline|'\n'
name|'mock_vm_svc'
op|'.'
name|'ModifyResourceSettings'
op|'.'
name|'return_value'
op|'='
op|'('
nl|'\n'
name|'None'
op|','
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_JOB_PATH'
op|','
name|'self'
op|'.'
name|'_FAKE_RET_VAL'
op|')'
newline|'\n'
nl|'\n'
name|'sasd'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'other_sasd'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'sasd'
op|'.'
name|'ResourceType'
op|'='
name|'resource_type'
newline|'\n'
name|'sasd'
op|'.'
name|'ResourceSubType'
op|'='
name|'resource_sub_type'
newline|'\n'
name|'sasd'
op|'.'
name|'HostResource'
op|'='
op|'['
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_SASD_RESOURCE'
op|']'
newline|'\n'
name|'sasd'
op|'.'
name|'path'
op|'.'
name|'return_value'
op|'.'
name|'RelPath'
op|'='
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_DISK_PATH'
newline|'\n'
nl|'\n'
name|'vm_settings'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'vm'
op|'.'
name|'associators'
op|'.'
name|'return_value'
op|'='
op|'['
name|'vm_settings'
op|']'
newline|'\n'
name|'vm_settings'
op|'.'
name|'associators'
op|'.'
name|'return_value'
op|'='
op|'['
name|'sasd'
op|','
name|'other_sasd'
op|']'
newline|'\n'
nl|'\n'
DECL|member|_get_vm
dedent|''
name|'def'
name|'_get_vm'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'mock_vm'
op|'='
name|'mock'
op|'.'
name|'MagicMock'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_conn'
op|'.'
name|'Msvm_ComputerSystem'
op|'.'
name|'return_value'
op|'='
op|'['
name|'mock_vm'
op|']'
newline|'\n'
name|'mock_vm'
op|'.'
name|'path_'
op|'.'
name|'return_value'
op|'='
name|'mock'
op|'.'
name|'sentinel'
op|'.'
name|'FAKE_VM_PATH'
newline|'\n'
name|'return'
name|'mock_vm'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
