begin_unit
comment|'# Copyright 2012 Michael Still and Canonical Inc'
nl|'\n'
comment|'# All Rights Reserved.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
nl|'\n'
name|'import'
name|'contextlib'
newline|'\n'
name|'import'
name|'hashlib'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'time'
newline|'\n'
nl|'\n'
name|'import'
name|'mock'
newline|'\n'
name|'from'
name|'oslo_concurrency'
name|'import'
name|'lockutils'
newline|'\n'
name|'from'
name|'oslo_concurrency'
name|'import'
name|'processutils'
newline|'\n'
name|'from'
name|'oslo_config'
name|'import'
name|'cfg'
newline|'\n'
name|'from'
name|'oslo_log'
name|'import'
name|'formatters'
newline|'\n'
name|'from'
name|'oslo_log'
name|'import'
name|'log'
name|'as'
name|'logging'
newline|'\n'
name|'from'
name|'oslo_serialization'
name|'import'
name|'jsonutils'
newline|'\n'
name|'from'
name|'oslo_utils'
name|'import'
name|'importutils'
newline|'\n'
name|'from'
name|'six'
op|'.'
name|'moves'
name|'import'
name|'cStringIO'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
name|'import'
name|'conductor'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'context'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'objects'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'test'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'tests'
op|'.'
name|'unit'
name|'import'
name|'fake_instance'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'utils'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'libvirt'
name|'import'
name|'imagecache'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'libvirt'
name|'import'
name|'utils'
name|'as'
name|'libvirt_utils'
newline|'\n'
nl|'\n'
DECL|variable|CONF
name|'CONF'
op|'='
name|'cfg'
op|'.'
name|'CONF'
newline|'\n'
name|'CONF'
op|'.'
name|'import_opt'
op|'('
string|"'compute_manager'"
op|','
string|"'nova.service'"
op|')'
newline|'\n'
name|'CONF'
op|'.'
name|'import_opt'
op|'('
string|"'host'"
op|','
string|"'nova.netconf'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
op|'@'
name|'contextlib'
op|'.'
name|'contextmanager'
newline|'\n'
DECL|function|intercept_log_messages
name|'def'
name|'intercept_log_messages'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'mylog'
op|'='
name|'logging'
op|'.'
name|'getLogger'
op|'('
string|"'nova'"
op|')'
newline|'\n'
name|'stream'
op|'='
name|'cStringIO'
op|'('
op|')'
newline|'\n'
name|'handler'
op|'='
name|'logging'
op|'.'
name|'logging'
op|'.'
name|'StreamHandler'
op|'('
name|'stream'
op|')'
newline|'\n'
name|'handler'
op|'.'
name|'setFormatter'
op|'('
name|'formatters'
op|'.'
name|'ContextFormatter'
op|'('
op|')'
op|')'
newline|'\n'
name|'mylog'
op|'.'
name|'logger'
op|'.'
name|'addHandler'
op|'('
name|'handler'
op|')'
newline|'\n'
name|'yield'
name|'stream'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'        '
name|'mylog'
op|'.'
name|'logger'
op|'.'
name|'removeHandler'
op|'('
name|'handler'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ImageCacheManagerTestCase
dedent|''
dedent|''
name|'class'
name|'ImageCacheManagerTestCase'
op|'('
name|'test'
op|'.'
name|'NoDBTestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'ImageCacheManagerTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stock_instance_names'
op|'='
name|'set'
op|'('
op|'['
string|"'instance-00000001'"
op|','
nl|'\n'
string|"'instance-00000002'"
op|','
nl|'\n'
string|"'instance-00000003'"
op|','
nl|'\n'
string|"'banana-42-hamster'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_read_stored_checksum_missing
dedent|''
name|'def'
name|'test_read_stored_checksum_missing'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.path.exists'"
op|','
name|'lambda'
name|'x'
op|':'
name|'False'
op|')'
newline|'\n'
name|'csum'
op|'='
name|'imagecache'
op|'.'
name|'read_stored_checksum'
op|'('
string|"'/tmp/foo'"
op|','
name|'timestamped'
op|'='
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'csum'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'os'
op|'.'
name|'path'
op|','
string|"'exists'"
op|','
name|'return_value'
op|'='
name|'True'
op|')'
newline|'\n'
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'time'
op|','
string|"'time'"
op|','
name|'return_value'
op|'='
number|'2000000'
op|')'
newline|'\n'
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'os'
op|'.'
name|'path'
op|','
string|"'getmtime'"
op|','
name|'return_value'
op|'='
number|'1000000'
op|')'
newline|'\n'
DECL|member|test_get_age_of_file
name|'def'
name|'test_get_age_of_file'
op|'('
name|'self'
op|','
name|'mock_getmtime'
op|','
name|'mock_time'
op|','
name|'mock_exists'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'exists'
op|','
name|'age'
op|'='
name|'image_cache_manager'
op|'.'
name|'_get_age_of_file'
op|'('
string|"'/tmp'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'exists'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1000000'
op|','
name|'age'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'os'
op|'.'
name|'path'
op|','
string|"'exists'"
op|','
name|'return_value'
op|'='
name|'False'
op|')'
newline|'\n'
DECL|member|test_get_age_of_file_not_exists
name|'def'
name|'test_get_age_of_file_not_exists'
op|'('
name|'self'
op|','
name|'mock_exists'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'exists'
op|','
name|'age'
op|'='
name|'image_cache_manager'
op|'.'
name|'_get_age_of_file'
op|'('
string|"'/tmp'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'exists'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'age'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_read_stored_checksum
dedent|''
name|'def'
name|'test_read_stored_checksum'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'flags'
op|'('
name|'instances_path'
op|'='
name|'tmpdir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'image_info_filename_pattern'
op|'='
op|'('
string|"'$instances_path/'"
nl|'\n'
string|"'%(image)s.info'"
op|')'
op|','
nl|'\n'
name|'group'
op|'='
string|"'libvirt'"
op|')'
newline|'\n'
nl|'\n'
name|'csum_input'
op|'='
string|'\'{"sha1": "fdghkfhkgjjksfdgjksjkghsdf"}\\n\''
newline|'\n'
name|'fname'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|"'aaa'"
op|')'
newline|'\n'
name|'info_fname'
op|'='
name|'imagecache'
op|'.'
name|'get_info_filename'
op|'('
name|'fname'
op|')'
newline|'\n'
name|'f'
op|'='
name|'open'
op|'('
name|'info_fname'
op|','
string|"'w'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'write'
op|'('
name|'csum_input'
op|')'
newline|'\n'
name|'f'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'csum_output'
op|'='
name|'imagecache'
op|'.'
name|'read_stored_checksum'
op|'('
name|'fname'
op|','
nl|'\n'
name|'timestamped'
op|'='
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'csum_input'
op|'.'
name|'rstrip'
op|'('
op|')'
op|','
nl|'\n'
string|'\'{"sha1": "%s"}\''
op|'%'
name|'csum_output'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_read_stored_checksum_legacy_essex
dedent|''
dedent|''
name|'def'
name|'test_read_stored_checksum_legacy_essex'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'flags'
op|'('
name|'instances_path'
op|'='
name|'tmpdir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'image_info_filename_pattern'
op|'='
op|'('
string|"'$instances_path/'"
nl|'\n'
string|"'%(image)s.info'"
op|')'
op|','
nl|'\n'
name|'group'
op|'='
string|"'libvirt'"
op|')'
newline|'\n'
nl|'\n'
name|'fname'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|"'aaa'"
op|')'
newline|'\n'
name|'old_fname'
op|'='
name|'fname'
op|'+'
string|"'.sha1'"
newline|'\n'
name|'f'
op|'='
name|'open'
op|'('
name|'old_fname'
op|','
string|"'w'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'write'
op|'('
string|"'fdghkfhkgjjksfdgjksjkghsdf'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'csum_output'
op|'='
name|'imagecache'
op|'.'
name|'read_stored_checksum'
op|'('
name|'fname'
op|','
nl|'\n'
name|'timestamped'
op|'='
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'csum_output'
op|','
string|"'fdghkfhkgjjksfdgjksjkghsdf'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'old_fname'
op|')'
op|')'
newline|'\n'
name|'info_fname'
op|'='
name|'imagecache'
op|'.'
name|'get_info_filename'
op|'('
name|'fname'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'info_fname'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_list_base_images
dedent|''
dedent|''
name|'def'
name|'test_list_base_images'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'listing'
op|'='
op|'['
string|"'00000001'"
op|','
nl|'\n'
string|"'ephemeral_0_20_None'"
op|','
nl|'\n'
string|"'17d1b00b81642842e514494a78e804e9a511637c_5368709120.info'"
op|','
nl|'\n'
string|"'00000004'"
op|','
nl|'\n'
string|"'swap_1000'"
op|']'
newline|'\n'
name|'images'
op|'='
op|'['
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3_sm'"
op|','
nl|'\n'
string|"'e09c675c2d1cfac32dae3c2d83689c8c94bc693b_sm'"
op|','
nl|'\n'
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3'"
op|','
nl|'\n'
string|"'17d1b00b81642842e514494a78e804e9a511637c'"
op|','
nl|'\n'
string|"'17d1b00b81642842e514494a78e804e9a511637c_5368709120'"
op|','
nl|'\n'
string|"'17d1b00b81642842e514494a78e804e9a511637c_10737418240'"
op|']'
newline|'\n'
name|'listing'
op|'.'
name|'extend'
op|'('
name|'images'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.listdir'"
op|','
name|'lambda'
name|'x'
op|':'
name|'listing'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.path.isfile'"
op|','
name|'lambda'
name|'x'
op|':'
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'base_dir'
op|'='
string|"'/var/lib/nova/instances/_base'"
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'instances_path'
op|'='
string|"'/var/lib/nova/instances'"
op|')'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_list_base_images'
op|'('
name|'base_dir'
op|')'
newline|'\n'
nl|'\n'
name|'sanitized'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'ent'
name|'in'
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|':'
newline|'\n'
indent|'            '
name|'sanitized'
op|'.'
name|'append'
op|'('
name|'ent'
op|'.'
name|'replace'
op|'('
name|'base_dir'
op|'+'
string|"'/'"
op|','
string|"''"
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'sorted'
op|'('
name|'sanitized'
op|')'
op|','
name|'sorted'
op|'('
name|'images'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
nl|'\n'
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'expected'
op|','
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
nl|'\n'
string|"'17d1b00b81642842e514494a78e804e9a511637c_'"
nl|'\n'
string|"'10737418240'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'expected'
op|','
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|')'
newline|'\n'
nl|'\n'
name|'unexpected'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
string|"'00000004'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotIn'
op|'('
name|'unexpected'
op|','
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'ent'
name|'in'
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'ent'
op|'.'
name|'startswith'
op|'('
name|'base_dir'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'image_cache_manager'
op|'.'
name|'originals'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
nl|'\n'
string|"'17d1b00b81642842e514494a78e804e9a511637c'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'expected'
op|','
name|'image_cache_manager'
op|'.'
name|'originals'
op|')'
newline|'\n'
nl|'\n'
name|'unexpected'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
nl|'\n'
string|"'17d1b00b81642842e514494a78e804e9a511637c_'"
nl|'\n'
string|"'10737418240'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotIn'
op|'('
name|'unexpected'
op|','
name|'image_cache_manager'
op|'.'
name|'originals'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'len'
op|'('
name|'image_cache_manager'
op|'.'
name|'back_swap_images'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'swap_1000'"
op|','
name|'image_cache_manager'
op|'.'
name|'back_swap_images'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_list_backing_images_small
dedent|''
name|'def'
name|'test_list_backing_images_small'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.listdir'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
op|'['
string|"'_base'"
op|','
string|"'instance-00000001'"
op|','
nl|'\n'
string|"'instance-00000002'"
op|','
string|"'instance-00000003'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.path.exists'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
name|'x'
op|'.'
name|'find'
op|'('
string|"'instance-'"
op|')'
op|'!='
op|'-'
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'libvirt_utils'
op|','
string|"'get_disk_backing_file'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3_sm'"
op|')'
newline|'\n'
nl|'\n'
name|'found'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'CONF'
op|'.'
name|'instances_path'
op|','
nl|'\n'
name|'CONF'
op|'.'
name|'image_cache_subdirectory_name'
op|','
nl|'\n'
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3_sm'"
op|')'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|'='
op|'['
name|'found'
op|']'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'instance_names'
op|'='
name|'self'
op|'.'
name|'stock_instance_names'
newline|'\n'
nl|'\n'
name|'inuse_images'
op|'='
name|'image_cache_manager'
op|'.'
name|'_list_backing_images'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'inuse_images'
op|','
op|'['
name|'found'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_list_backing_images_resized
dedent|''
name|'def'
name|'test_list_backing_images_resized'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.listdir'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
op|'['
string|"'_base'"
op|','
string|"'instance-00000001'"
op|','
nl|'\n'
string|"'instance-00000002'"
op|','
string|"'instance-00000003'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.path.exists'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
name|'x'
op|'.'
name|'find'
op|'('
string|"'instance-'"
op|')'
op|'!='
op|'-'
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'libvirt_utils'
op|','
string|"'get_disk_backing_file'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
op|'('
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3_'"
nl|'\n'
string|"'10737418240'"
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'found'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'CONF'
op|'.'
name|'instances_path'
op|','
nl|'\n'
name|'CONF'
op|'.'
name|'image_cache_subdirectory_name'
op|','
nl|'\n'
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3_'"
nl|'\n'
string|"'10737418240'"
op|')'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|'='
op|'['
name|'found'
op|']'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'instance_names'
op|'='
name|'self'
op|'.'
name|'stock_instance_names'
newline|'\n'
nl|'\n'
name|'inuse_images'
op|'='
name|'image_cache_manager'
op|'.'
name|'_list_backing_images'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'inuse_images'
op|','
op|'['
name|'found'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_list_backing_images_instancename
dedent|''
name|'def'
name|'test_list_backing_images_instancename'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.listdir'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
op|'['
string|"'_base'"
op|','
string|"'banana-42-hamster'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.path.exists'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
name|'x'
op|'.'
name|'find'
op|'('
string|"'banana-42-hamster'"
op|')'
op|'!='
op|'-'
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'libvirt_utils'
op|','
string|"'get_disk_backing_file'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3_sm'"
op|')'
newline|'\n'
nl|'\n'
name|'found'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'CONF'
op|'.'
name|'instances_path'
op|','
nl|'\n'
name|'CONF'
op|'.'
name|'image_cache_subdirectory_name'
op|','
nl|'\n'
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3_sm'"
op|')'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|'='
op|'['
name|'found'
op|']'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'instance_names'
op|'='
name|'self'
op|'.'
name|'stock_instance_names'
newline|'\n'
nl|'\n'
name|'inuse_images'
op|'='
name|'image_cache_manager'
op|'.'
name|'_list_backing_images'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'inuse_images'
op|','
op|'['
name|'found'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_list_backing_images_disk_notexist
dedent|''
name|'def'
name|'test_list_backing_images_disk_notexist'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.listdir'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
op|'['
string|"'_base'"
op|','
string|"'banana-42-hamster'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.path.exists'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
name|'x'
op|'.'
name|'find'
op|'('
string|"'banana-42-hamster'"
op|')'
op|'!='
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_get_disk
name|'def'
name|'fake_get_disk'
op|'('
name|'disk_path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'processutils'
op|'.'
name|'ProcessExecutionError'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'libvirt_utils'
op|','
string|"'get_disk_backing_file'"
op|','
name|'fake_get_disk'
op|')'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|'='
op|'['
op|']'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'instance_names'
op|'='
name|'self'
op|'.'
name|'stock_instance_names'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'processutils'
op|'.'
name|'ProcessExecutionError'
op|','
nl|'\n'
name|'image_cache_manager'
op|'.'
name|'_list_backing_images'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_find_base_file_nothing
dedent|''
name|'def'
name|'test_find_base_file_nothing'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.path.exists'"
op|','
name|'lambda'
name|'x'
op|':'
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'base_dir'
op|'='
string|"'/var/lib/nova/instances/_base'"
newline|'\n'
name|'fingerprint'
op|'='
string|"'549867354867'"
newline|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'res'
op|'='
name|'list'
op|'('
name|'image_cache_manager'
op|'.'
name|'_find_base_file'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'len'
op|'('
name|'res'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_find_base_file_small
dedent|''
name|'def'
name|'test_find_base_file_small'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'fingerprint'
op|'='
string|"'968dd6cc49e01aaa044ed11c0cce733e0fa44a6a'"
newline|'\n'
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.path.exists'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
name|'x'
op|'.'
name|'endswith'
op|'('
string|"'%s_sm'"
op|'%'
name|'fingerprint'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'base_dir'
op|'='
string|"'/var/lib/nova/instances/_base'"
newline|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'res'
op|'='
name|'list'
op|'('
name|'image_cache_manager'
op|'.'
name|'_find_base_file'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'base_file'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|'+'
string|"'_sm'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
op|'('
name|'base_file'
op|','
name|'True'
op|','
name|'False'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_find_base_file_resized
dedent|''
name|'def'
name|'test_find_base_file_resized'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'fingerprint'
op|'='
string|"'968dd6cc49e01aaa044ed11c0cce733e0fa44a6a'"
newline|'\n'
name|'listing'
op|'='
op|'['
string|"'00000001'"
op|','
nl|'\n'
string|"'ephemeral_0_20_None'"
op|','
nl|'\n'
string|"'968dd6cc49e01aaa044ed11c0cce733e0fa44a6a_10737418240'"
op|','
nl|'\n'
string|"'00000004'"
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.listdir'"
op|','
name|'lambda'
name|'x'
op|':'
name|'listing'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.path.exists'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
name|'x'
op|'.'
name|'endswith'
op|'('
string|"'%s_10737418240'"
op|'%'
name|'fingerprint'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.path.isfile'"
op|','
name|'lambda'
name|'x'
op|':'
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'base_dir'
op|'='
string|"'/var/lib/nova/instances/_base'"
newline|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_list_base_images'
op|'('
name|'base_dir'
op|')'
newline|'\n'
name|'res'
op|'='
name|'list'
op|'('
name|'image_cache_manager'
op|'.'
name|'_find_base_file'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'base_file'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|'+'
string|"'_10737418240'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
op|'('
name|'base_file'
op|','
name|'False'
op|','
name|'True'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_find_base_file_all
dedent|''
name|'def'
name|'test_find_base_file_all'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'fingerprint'
op|'='
string|"'968dd6cc49e01aaa044ed11c0cce733e0fa44a6a'"
newline|'\n'
name|'listing'
op|'='
op|'['
string|"'00000001'"
op|','
nl|'\n'
string|"'ephemeral_0_20_None'"
op|','
nl|'\n'
string|"'968dd6cc49e01aaa044ed11c0cce733e0fa44a6a_sm'"
op|','
nl|'\n'
string|"'968dd6cc49e01aaa044ed11c0cce733e0fa44a6a_10737418240'"
op|','
nl|'\n'
string|"'00000004'"
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.listdir'"
op|','
name|'lambda'
name|'x'
op|':'
name|'listing'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.path.exists'"
op|','
name|'lambda'
name|'x'
op|':'
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.path.isfile'"
op|','
name|'lambda'
name|'x'
op|':'
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'base_dir'
op|'='
string|"'/var/lib/nova/instances/_base'"
newline|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_list_base_images'
op|'('
name|'base_dir'
op|')'
newline|'\n'
name|'res'
op|'='
name|'list'
op|'('
name|'image_cache_manager'
op|'.'
name|'_find_base_file'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'base_file1'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|')'
newline|'\n'
name|'base_file2'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|'+'
string|"'_sm'"
op|')'
newline|'\n'
name|'base_file3'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|'+'
string|"'_10737418240'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
op|'['
op|'('
name|'base_file1'
op|','
name|'False'
op|','
name|'False'
op|')'
op|','
nl|'\n'
op|'('
name|'base_file2'
op|','
name|'True'
op|','
name|'False'
op|')'
op|','
nl|'\n'
op|'('
name|'base_file3'
op|','
name|'False'
op|','
name|'True'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'contextlib'
op|'.'
name|'contextmanager'
newline|'\n'
DECL|member|_make_base_file
name|'def'
name|'_make_base_file'
op|'('
name|'self'
op|','
name|'checksum'
op|'='
name|'True'
op|','
name|'lock'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Make a base file for testing."""'
newline|'\n'
nl|'\n'
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'flags'
op|'('
name|'instances_path'
op|'='
name|'tmpdir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'image_info_filename_pattern'
op|'='
op|'('
string|"'$instances_path/'"
nl|'\n'
string|"'%(image)s.info'"
op|')'
op|','
nl|'\n'
name|'group'
op|'='
string|"'libvirt'"
op|')'
newline|'\n'
name|'fname'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|"'aaa'"
op|')'
newline|'\n'
nl|'\n'
name|'base_file'
op|'='
name|'open'
op|'('
name|'fname'
op|','
string|"'w'"
op|')'
newline|'\n'
name|'base_file'
op|'.'
name|'write'
op|'('
string|"'data'"
op|')'
newline|'\n'
name|'base_file'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'lock'
op|':'
newline|'\n'
indent|'                '
name|'lockdir'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|"'locks'"
op|')'
newline|'\n'
name|'lockname'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'lockdir'
op|','
string|"'nova-aaa'"
op|')'
newline|'\n'
name|'os'
op|'.'
name|'mkdir'
op|'('
name|'lockdir'
op|')'
newline|'\n'
name|'lock_file'
op|'='
name|'open'
op|'('
name|'lockname'
op|','
string|"'w'"
op|')'
newline|'\n'
name|'lock_file'
op|'.'
name|'write'
op|'('
string|"'data'"
op|')'
newline|'\n'
name|'lock_file'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'base_file'
op|'='
name|'open'
op|'('
name|'fname'
op|','
string|"'r'"
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'checksum'
op|':'
newline|'\n'
indent|'                '
name|'imagecache'
op|'.'
name|'write_stored_checksum'
op|'('
name|'fname'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'base_file'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'yield'
name|'fname'
newline|'\n'
nl|'\n'
DECL|member|test_remove_base_file
dedent|''
dedent|''
name|'def'
name|'test_remove_base_file'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'self'
op|'.'
name|'_make_base_file'
op|'('
op|')'
name|'as'
name|'fname'
op|':'
newline|'\n'
indent|'            '
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_remove_base_file'
op|'('
name|'fname'
op|')'
newline|'\n'
name|'info_fname'
op|'='
name|'imagecache'
op|'.'
name|'get_info_filename'
op|'('
name|'fname'
op|')'
newline|'\n'
nl|'\n'
name|'lock_name'
op|'='
string|"'nova-'"
op|'+'
name|'os'
op|'.'
name|'path'
op|'.'
name|'split'
op|'('
name|'fname'
op|')'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
name|'lock_dir'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'CONF'
op|'.'
name|'instances_path'
op|','
string|"'locks'"
op|')'
newline|'\n'
name|'lock_file'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'lock_dir'
op|','
name|'lock_name'
op|')'
newline|'\n'
nl|'\n'
comment|'# Files are initially too new to delete'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'fname'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'info_fname'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'lock_file'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# Old files get cleaned up though'
nl|'\n'
name|'os'
op|'.'
name|'utime'
op|'('
name|'fname'
op|','
op|'('
op|'-'
number|'1'
op|','
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'-'
number|'3601'
op|')'
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_remove_base_file'
op|'('
name|'fname'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'fname'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'info_fname'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'lock_file'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_base_file_original
dedent|''
dedent|''
name|'def'
name|'test_remove_base_file_original'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'self'
op|'.'
name|'_make_base_file'
op|'('
op|')'
name|'as'
name|'fname'
op|':'
newline|'\n'
indent|'            '
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'originals'
op|'='
op|'['
name|'fname'
op|']'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_remove_base_file'
op|'('
name|'fname'
op|')'
newline|'\n'
name|'info_fname'
op|'='
name|'imagecache'
op|'.'
name|'get_info_filename'
op|'('
name|'fname'
op|')'
newline|'\n'
nl|'\n'
comment|'# Files are initially too new to delete'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'fname'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'info_fname'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# This file should stay longer than a resized image'
nl|'\n'
name|'os'
op|'.'
name|'utime'
op|'('
name|'fname'
op|','
op|'('
op|'-'
number|'1'
op|','
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'-'
number|'3601'
op|')'
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_remove_base_file'
op|'('
name|'fname'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'fname'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'info_fname'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|"# Originals don't stay forever though"
nl|'\n'
name|'os'
op|'.'
name|'utime'
op|'('
name|'fname'
op|','
op|'('
op|'-'
number|'1'
op|','
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'-'
number|'3600'
op|'*'
number|'25'
op|')'
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_remove_base_file'
op|'('
name|'fname'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'fname'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'info_fname'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_base_file_dne
dedent|''
dedent|''
name|'def'
name|'test_remove_base_file_dne'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# This test is solely to execute the "does not exist" code path. We'
nl|'\n'
comment|"# don't expect the method being tested to do anything in this case."
nl|'\n'
indent|'        '
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'flags'
op|'('
name|'instances_path'
op|'='
name|'tmpdir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'image_info_filename_pattern'
op|'='
op|'('
string|"'$instances_path/'"
nl|'\n'
string|"'%(image)s.info'"
op|')'
op|','
nl|'\n'
name|'group'
op|'='
string|"'libvirt'"
op|')'
newline|'\n'
nl|'\n'
name|'fname'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|"'aaa'"
op|')'
newline|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_remove_base_file'
op|'('
name|'fname'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_base_file_oserror
dedent|''
dedent|''
name|'def'
name|'test_remove_base_file_oserror'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'intercept_log_messages'
op|'('
op|')'
name|'as'
name|'stream'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'flags'
op|'('
name|'instances_path'
op|'='
name|'tmpdir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'image_info_filename_pattern'
op|'='
op|'('
string|"'$instances_path/'"
nl|'\n'
string|"'%(image)s.info'"
op|')'
op|','
nl|'\n'
name|'group'
op|'='
string|"'libvirt'"
op|')'
newline|'\n'
nl|'\n'
name|'fname'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|"'aaa'"
op|')'
newline|'\n'
nl|'\n'
name|'os'
op|'.'
name|'mkdir'
op|'('
name|'fname'
op|')'
newline|'\n'
name|'os'
op|'.'
name|'utime'
op|'('
name|'fname'
op|','
op|'('
op|'-'
number|'1'
op|','
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'-'
number|'3601'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# This will raise an OSError because of file permissions'
nl|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_remove_base_file'
op|'('
name|'fname'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'fname'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'stream'
op|'.'
name|'getvalue'
op|'('
op|')'
op|'.'
name|'find'
op|'('
string|"'Failed to remove'"
op|')'
op|','
nl|'\n'
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_handle_base_image_unused
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_handle_base_image_unused'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'img'
op|'='
string|"'123'"
newline|'\n'
nl|'\n'
name|'with'
name|'self'
op|'.'
name|'_make_base_file'
op|'('
op|')'
name|'as'
name|'fname'
op|':'
newline|'\n'
indent|'            '
name|'os'
op|'.'
name|'utime'
op|'('
name|'fname'
op|','
op|'('
op|'-'
number|'1'
op|','
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'-'
number|'3601'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|'='
op|'['
name|'fname'
op|']'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_handle_base_image'
op|'('
name|'img'
op|','
name|'fname'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'removable_base_files'
op|','
nl|'\n'
op|'['
name|'fname'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'corrupt_base_files'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'libvirt_utils'
op|','
string|"'update_mtime'"
op|')'
newline|'\n'
DECL|member|test_handle_base_image_used
name|'def'
name|'test_handle_base_image_used'
op|'('
name|'self'
op|','
name|'mock_mtime'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'img'
op|'='
string|"'123'"
newline|'\n'
nl|'\n'
name|'with'
name|'self'
op|'.'
name|'_make_base_file'
op|'('
op|')'
name|'as'
name|'fname'
op|':'
newline|'\n'
indent|'            '
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|'='
op|'['
name|'fname'
op|']'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'used_images'
op|'='
op|'{'
string|"'123'"
op|':'
op|'('
number|'1'
op|','
number|'0'
op|','
op|'['
string|"'banana-42'"
op|']'
op|')'
op|'}'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_handle_base_image'
op|'('
name|'img'
op|','
name|'fname'
op|')'
newline|'\n'
nl|'\n'
name|'mock_mtime'
op|'.'
name|'assert_called_once_with'
op|'('
name|'fname'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'removable_base_files'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'corrupt_base_files'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'libvirt_utils'
op|','
string|"'update_mtime'"
op|')'
newline|'\n'
DECL|member|test_handle_base_image_used_remotely
name|'def'
name|'test_handle_base_image_used_remotely'
op|'('
name|'self'
op|','
name|'mock_mtime'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'img'
op|'='
string|"'123'"
newline|'\n'
nl|'\n'
name|'with'
name|'self'
op|'.'
name|'_make_base_file'
op|'('
op|')'
name|'as'
name|'fname'
op|':'
newline|'\n'
indent|'            '
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|'='
op|'['
name|'fname'
op|']'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'used_images'
op|'='
op|'{'
string|"'123'"
op|':'
op|'('
number|'0'
op|','
number|'1'
op|','
op|'['
string|"'banana-42'"
op|']'
op|')'
op|'}'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_handle_base_image'
op|'('
name|'img'
op|','
name|'fname'
op|')'
newline|'\n'
nl|'\n'
name|'mock_mtime'
op|'.'
name|'assert_called_once_with'
op|'('
name|'fname'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'removable_base_files'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'corrupt_base_files'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_handle_base_image_absent
dedent|''
dedent|''
name|'def'
name|'test_handle_base_image_absent'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'img'
op|'='
string|"'123'"
newline|'\n'
nl|'\n'
name|'with'
name|'intercept_log_messages'
op|'('
op|')'
name|'as'
name|'stream'
op|':'
newline|'\n'
indent|'            '
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'used_images'
op|'='
op|'{'
string|"'123'"
op|':'
op|'('
number|'1'
op|','
number|'0'
op|','
op|'['
string|"'banana-42'"
op|']'
op|')'
op|'}'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_handle_base_image'
op|'('
name|'img'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'removable_base_files'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'corrupt_base_files'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'stream'
op|'.'
name|'getvalue'
op|'('
op|')'
op|'.'
name|'find'
op|'('
string|"'an absent base file'"
op|')'
op|','
nl|'\n'
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_handle_base_image_used_missing
dedent|''
dedent|''
name|'def'
name|'test_handle_base_image_used_missing'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'img'
op|'='
string|"'123'"
newline|'\n'
nl|'\n'
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'flags'
op|'('
name|'instances_path'
op|'='
name|'tmpdir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'image_info_filename_pattern'
op|'='
op|'('
string|"'$instances_path/'"
nl|'\n'
string|"'%(image)s.info'"
op|')'
op|','
nl|'\n'
name|'group'
op|'='
string|"'libvirt'"
op|')'
newline|'\n'
nl|'\n'
name|'fname'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|"'aaa'"
op|')'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|'='
op|'['
name|'fname'
op|']'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'used_images'
op|'='
op|'{'
string|"'123'"
op|':'
op|'('
number|'1'
op|','
number|'0'
op|','
op|'['
string|"'banana-42'"
op|']'
op|')'
op|'}'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_handle_base_image'
op|'('
name|'img'
op|','
name|'fname'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'removable_base_files'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'corrupt_base_files'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'libvirt_utils'
op|','
string|"'update_mtime'"
op|')'
newline|'\n'
DECL|member|test_handle_base_image_checksum_fails
name|'def'
name|'test_handle_base_image_checksum_fails'
op|'('
name|'self'
op|','
name|'mock_mtime'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'checksum_base_images'
op|'='
name|'True'
op|','
name|'group'
op|'='
string|"'libvirt'"
op|')'
newline|'\n'
nl|'\n'
name|'img'
op|'='
string|"'123'"
newline|'\n'
nl|'\n'
name|'with'
name|'self'
op|'.'
name|'_make_base_file'
op|'('
op|')'
name|'as'
name|'fname'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'open'
op|'('
name|'fname'
op|','
string|"'w'"
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'                '
name|'f'
op|'.'
name|'write'
op|'('
string|"'banana'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'d'
op|'='
op|'{'
string|"'sha1'"
op|':'
string|"'21323454'"
op|'}'
newline|'\n'
name|'with'
name|'open'
op|'('
string|"'%s.info'"
op|'%'
name|'fname'
op|','
string|"'w'"
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'                '
name|'f'
op|'.'
name|'write'
op|'('
name|'jsonutils'
op|'.'
name|'dumps'
op|'('
name|'d'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|'='
op|'['
name|'fname'
op|']'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'used_images'
op|'='
op|'{'
string|"'123'"
op|':'
op|'('
number|'1'
op|','
number|'0'
op|','
op|'['
string|"'banana-42'"
op|']'
op|')'
op|'}'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_handle_base_image'
op|'('
name|'img'
op|','
name|'fname'
op|')'
newline|'\n'
nl|'\n'
name|'mock_mtime'
op|'.'
name|'assert_called_once_with'
op|'('
name|'fname'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'removable_base_files'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'corrupt_base_files'
op|','
nl|'\n'
op|'['
name|'fname'
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'libvirt_utils'
op|','
string|"'update_mtime'"
op|')'
newline|'\n'
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'lockutils'
op|','
string|"'external_lock'"
op|')'
newline|'\n'
DECL|member|test_verify_base_images
name|'def'
name|'test_verify_base_images'
op|'('
name|'self'
op|','
name|'mock_lock'
op|','
name|'mock_mtime'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'hashed_1'
op|'='
string|"'356a192b7913b04c54574d18c28d46e6395428ab'"
newline|'\n'
name|'hashed_21'
op|'='
string|"'472b07b9fcf2c2451e8781e944bf5f77cd8457c8'"
newline|'\n'
name|'hashed_22'
op|'='
string|"'12c6fc06c99a462375eeb3f43dfd832b08ca9e17'"
newline|'\n'
name|'hashed_42'
op|'='
string|"'92cfceb39d57d914ed8b14d0e37643de0797ae56'"
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'instances_path'
op|'='
string|"'/instance_path'"
op|','
nl|'\n'
name|'image_cache_subdirectory_name'
op|'='
string|"'_base'"
op|')'
newline|'\n'
nl|'\n'
name|'base_file_list'
op|'='
op|'['
string|"'00000001'"
op|','
nl|'\n'
string|"'ephemeral_0_20_None'"
op|','
nl|'\n'
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3_sm'"
op|','
nl|'\n'
string|"'e09c675c2d1cfac32dae3c2d83689c8c94bc693b_sm'"
op|','
nl|'\n'
name|'hashed_42'
op|','
nl|'\n'
name|'hashed_1'
op|','
nl|'\n'
name|'hashed_21'
op|','
nl|'\n'
name|'hashed_22'
op|','
nl|'\n'
string|"'%s_5368709120'"
op|'%'
name|'hashed_1'
op|','
nl|'\n'
string|"'%s_10737418240'"
op|'%'
name|'hashed_1'
op|','
nl|'\n'
string|"'00000004'"
op|']'
newline|'\n'
nl|'\n'
DECL|function|fq_path
name|'def'
name|'fq_path'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
string|"'/instance_path/_base/'"
op|','
name|'path'
op|')'
newline|'\n'
nl|'\n'
comment|'# Fake base directory existence'
nl|'\n'
dedent|''
name|'orig_exists'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
newline|'\n'
nl|'\n'
DECL|function|exists
name|'def'
name|'exists'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
comment|'# The python coverage tool got angry with my overly broad mocks'
nl|'\n'
indent|'            '
name|'if'
name|'not'
name|'path'
op|'.'
name|'startswith'
op|'('
string|"'/instance_path'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'orig_exists'
op|'('
name|'path'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'path'
name|'in'
op|'['
string|"'/instance_path'"
op|','
nl|'\n'
string|"'/instance_path/_base'"
op|','
nl|'\n'
string|"'/instance_path/instance-1/disk'"
op|','
nl|'\n'
string|"'/instance_path/instance-2/disk'"
op|','
nl|'\n'
string|"'/instance_path/instance-3/disk'"
op|','
nl|'\n'
string|"'/instance_path/_base/%s.info'"
op|'%'
name|'hashed_42'
op|']'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'for'
name|'p'
name|'in'
name|'base_file_list'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'path'
op|'=='
name|'fq_path'
op|'('
name|'p'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'return'
name|'True'
newline|'\n'
dedent|''
name|'if'
name|'path'
op|'=='
name|'fq_path'
op|'('
name|'p'
op|')'
op|'+'
string|"'.info'"
op|':'
newline|'\n'
indent|'                    '
name|'return'
name|'False'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'path'
name|'in'
op|'['
string|"'/instance_path/_base/%s_sm'"
op|'%'
name|'i'
name|'for'
name|'i'
name|'in'
op|'['
name|'hashed_1'
op|','
nl|'\n'
name|'hashed_21'
op|','
nl|'\n'
name|'hashed_22'
op|','
nl|'\n'
name|'hashed_42'
op|']'
op|']'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'False'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'fail'
op|'('
string|"'Unexpected path existence check: %s'"
op|'%'
name|'path'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.path.exists'"
op|','
name|'lambda'
name|'x'
op|':'
name|'exists'
op|'('
name|'x'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# Fake up some instances in the instances directory'
nl|'\n'
name|'orig_listdir'
op|'='
name|'os'
op|'.'
name|'listdir'
newline|'\n'
nl|'\n'
DECL|function|listdir
name|'def'
name|'listdir'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
comment|'# The python coverage tool got angry with my overly broad mocks'
nl|'\n'
indent|'            '
name|'if'
name|'not'
name|'path'
op|'.'
name|'startswith'
op|'('
string|"'/instance_path'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'orig_listdir'
op|'('
name|'path'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'path'
op|'=='
string|"'/instance_path'"
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'['
string|"'instance-1'"
op|','
string|"'instance-2'"
op|','
string|"'instance-3'"
op|','
string|"'_base'"
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'path'
op|'=='
string|"'/instance_path/_base'"
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'base_file_list'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'fail'
op|'('
string|"'Unexpected directory listed: %s'"
op|'%'
name|'path'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.listdir'"
op|','
name|'lambda'
name|'x'
op|':'
name|'listdir'
op|'('
name|'x'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# Fake isfile for these faked images in _base'
nl|'\n'
name|'orig_isfile'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'isfile'
newline|'\n'
nl|'\n'
DECL|function|isfile
name|'def'
name|'isfile'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
comment|'# The python coverage tool got angry with my overly broad mocks'
nl|'\n'
indent|'            '
name|'if'
name|'not'
name|'path'
op|'.'
name|'startswith'
op|'('
string|"'/instance_path'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'orig_isfile'
op|'('
name|'path'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'for'
name|'p'
name|'in'
name|'base_file_list'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'path'
op|'=='
name|'fq_path'
op|'('
name|'p'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'return'
name|'True'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'fail'
op|'('
string|"'Unexpected isfile call: %s'"
op|'%'
name|'path'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.path.isfile'"
op|','
name|'lambda'
name|'x'
op|':'
name|'isfile'
op|'('
name|'x'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# Fake the database call which lists running instances'
nl|'\n'
name|'instances'
op|'='
op|'['
op|'{'
string|"'image_ref'"
op|':'
string|"'1'"
op|','
nl|'\n'
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'instance-1'"
op|','
nl|'\n'
string|"'uuid'"
op|':'
string|"'123'"
op|','
nl|'\n'
string|"'vm_state'"
op|':'
string|"''"
op|','
nl|'\n'
string|"'task_state'"
op|':'
string|"''"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'image_ref'"
op|':'
string|"'1'"
op|','
nl|'\n'
string|"'kernel_id'"
op|':'
string|"'21'"
op|','
nl|'\n'
string|"'ramdisk_id'"
op|':'
string|"'22'"
op|','
nl|'\n'
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'instance-2'"
op|','
nl|'\n'
string|"'uuid'"
op|':'
string|"'456'"
op|','
nl|'\n'
string|"'vm_state'"
op|':'
string|"''"
op|','
nl|'\n'
string|"'task_state'"
op|':'
string|"''"
op|'}'
op|']'
newline|'\n'
name|'all_instances'
op|'='
op|'['
name|'fake_instance'
op|'.'
name|'fake_instance_obj'
op|'('
name|'None'
op|','
op|'**'
name|'instance'
op|')'
nl|'\n'
name|'for'
name|'instance'
name|'in'
name|'instances'
op|']'
newline|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# Fake the utils call which finds the backing image'
nl|'\n'
DECL|function|get_disk_backing_file
name|'def'
name|'get_disk_backing_file'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'path'
name|'in'
op|'['
string|"'/instance_path/instance-1/disk'"
op|','
nl|'\n'
string|"'/instance_path/instance-2/disk'"
op|']'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'fq_path'
op|'('
string|"'%s_5368709120'"
op|'%'
name|'hashed_1'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'fail'
op|'('
string|"'Unexpected backing file lookup: %s'"
op|'%'
name|'path'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'libvirt_utils'
op|','
string|"'get_disk_backing_file'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
name|'get_disk_backing_file'
op|'('
name|'x'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# Fake out verifying checksums, as that is tested elsewhere'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'image_cache_manager'
op|','
string|"'_verify_checksum'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|','
name|'y'
op|':'
name|'True'
op|')'
newline|'\n'
nl|'\n'
comment|'# Fake getmtime as well'
nl|'\n'
name|'orig_getmtime'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'getmtime'
newline|'\n'
nl|'\n'
DECL|function|getmtime
name|'def'
name|'getmtime'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'path'
op|'.'
name|'startswith'
op|'('
string|"'/instance_path'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'orig_getmtime'
op|'('
name|'path'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
number|'1000000'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.path.getmtime'"
op|','
name|'lambda'
name|'x'
op|':'
name|'getmtime'
op|'('
name|'x'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|"# Make sure we don't accidentally remove a real file"
nl|'\n'
name|'orig_remove'
op|'='
name|'os'
op|'.'
name|'remove'
newline|'\n'
nl|'\n'
DECL|function|remove
name|'def'
name|'remove'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'path'
op|'.'
name|'startswith'
op|'('
string|"'/instance_path'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'orig_remove'
op|'('
name|'path'
op|')'
newline|'\n'
nl|'\n'
comment|"# Don't try to remove fake files"
nl|'\n'
dedent|''
name|'return'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'os.remove'"
op|','
name|'lambda'
name|'x'
op|':'
name|'remove'
op|'('
name|'x'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'objects'
op|'.'
name|'block_device'
op|'.'
name|'BlockDeviceMappingList'
op|','
nl|'\n'
string|"'get_by_instance_uuid'"
op|')'
newline|'\n'
nl|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'objects'
op|'.'
name|'block_device'
op|'.'
name|'BlockDeviceMappingList'
op|'.'
name|'get_by_instance_uuid'
op|'('
nl|'\n'
name|'ctxt'
op|','
string|"'123'"
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'None'
op|')'
newline|'\n'
name|'objects'
op|'.'
name|'block_device'
op|'.'
name|'BlockDeviceMappingList'
op|'.'
name|'get_by_instance_uuid'
op|'('
nl|'\n'
name|'ctxt'
op|','
string|"'456'"
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
comment|"# And finally we can make the call we're actually testing..."
nl|'\n'
comment|'# The argument here should be a context, but it is mocked out'
nl|'\n'
name|'image_cache_manager'
op|'.'
name|'update'
op|'('
name|'ctxt'
op|','
name|'all_instances'
op|')'
newline|'\n'
nl|'\n'
comment|'# Verify'
nl|'\n'
name|'active'
op|'='
op|'['
name|'fq_path'
op|'('
name|'hashed_1'
op|')'
op|','
name|'fq_path'
op|'('
string|"'%s_5368709120'"
op|'%'
name|'hashed_1'
op|')'
op|','
nl|'\n'
name|'fq_path'
op|'('
name|'hashed_21'
op|')'
op|','
name|'fq_path'
op|'('
name|'hashed_22'
op|')'
op|']'
newline|'\n'
name|'for'
name|'act'
name|'in'
name|'active'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'act'
op|','
name|'image_cache_manager'
op|'.'
name|'active_base_files'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'image_cache_manager'
op|'.'
name|'active_base_files'
op|')'
op|','
nl|'\n'
name|'len'
op|'('
name|'active'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'rem'
name|'in'
op|'['
name|'fq_path'
op|'('
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3_sm'"
op|')'
op|','
nl|'\n'
name|'fq_path'
op|'('
string|"'e09c675c2d1cfac32dae3c2d83689c8c94bc693b_sm'"
op|')'
op|','
nl|'\n'
name|'fq_path'
op|'('
name|'hashed_42'
op|')'
op|','
nl|'\n'
name|'fq_path'
op|'('
string|"'%s_10737418240'"
op|'%'
name|'hashed_1'
op|')'
op|']'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'rem'
op|','
name|'image_cache_manager'
op|'.'
name|'removable_base_files'
op|')'
newline|'\n'
nl|'\n'
comment|'# Ensure there are no "corrupt" images as well'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'image_cache_manager'
op|'.'
name|'corrupt_base_files'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_verify_base_images_no_base
dedent|''
name|'def'
name|'test_verify_base_images_no_base'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'instances_path'
op|'='
string|"'/tmp/no/such/dir/name/please'"
op|')'
newline|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'update'
op|'('
name|'None'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_is_valid_info_file
dedent|''
name|'def'
name|'test_is_valid_info_file'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'hashed'
op|'='
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3'"
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'instances_path'
op|'='
string|"'/tmp/no/such/dir/name/please'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'image_info_filename_pattern'
op|'='
op|'('
string|"'$instances_path/_base/'"
nl|'\n'
string|"'%(image)s.info'"
op|')'
op|','
nl|'\n'
name|'group'
op|'='
string|"'libvirt'"
op|')'
newline|'\n'
name|'base_filename'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'CONF'
op|'.'
name|'instances_path'
op|','
string|"'_base'"
op|','
name|'hashed'
op|')'
newline|'\n'
nl|'\n'
name|'is_valid_info_file'
op|'='
name|'imagecache'
op|'.'
name|'is_valid_info_file'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'is_valid_info_file'
op|'('
string|"'banana'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'is_valid_info_file'
op|'('
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'CONF'
op|'.'
name|'instances_path'
op|','
string|"'_base'"
op|','
string|"'00000001'"
op|')'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'is_valid_info_file'
op|'('
name|'base_filename'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'is_valid_info_file'
op|'('
name|'base_filename'
op|'+'
string|"'.sha1'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'is_valid_info_file'
op|'('
name|'base_filename'
op|'+'
string|"'.info'"
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_configured_checksum_path
dedent|''
name|'def'
name|'test_configured_checksum_path'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'flags'
op|'('
name|'instances_path'
op|'='
name|'tmpdir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'image_info_filename_pattern'
op|'='
op|'('
string|"'$instances_path/'"
nl|'\n'
string|"'%(image)s.info'"
op|')'
op|','
nl|'\n'
name|'group'
op|'='
string|"'libvirt'"
op|')'
newline|'\n'
nl|'\n'
comment|'# Ensure there is a base directory'
nl|'\n'
name|'os'
op|'.'
name|'mkdir'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|"'_base'"
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# Fake the database call which lists running instances'
nl|'\n'
name|'instances'
op|'='
op|'['
op|'{'
string|"'image_ref'"
op|':'
string|"'1'"
op|','
nl|'\n'
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'instance-1'"
op|','
nl|'\n'
string|"'uuid'"
op|':'
string|"'123'"
op|','
nl|'\n'
string|"'vm_state'"
op|':'
string|"''"
op|','
nl|'\n'
string|"'task_state'"
op|':'
string|"''"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'image_ref'"
op|':'
string|"'1'"
op|','
nl|'\n'
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'instance-2'"
op|','
nl|'\n'
string|"'uuid'"
op|':'
string|"'456'"
op|','
nl|'\n'
string|"'vm_state'"
op|':'
string|"''"
op|','
nl|'\n'
string|"'task_state'"
op|':'
string|"''"
op|'}'
op|']'
newline|'\n'
nl|'\n'
name|'all_instances'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'instance'
name|'in'
name|'instances'
op|':'
newline|'\n'
indent|'                '
name|'all_instances'
op|'.'
name|'append'
op|'('
name|'fake_instance'
op|'.'
name|'fake_instance_obj'
op|'('
nl|'\n'
name|'None'
op|','
op|'**'
name|'instance'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|touch
dedent|''
name|'def'
name|'touch'
op|'('
name|'filename'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'f'
op|'='
name|'open'
op|'('
name|'filename'
op|','
string|"'w'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'write'
op|'('
string|"'Touched'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'old'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'-'
op|'('
number|'25'
op|'*'
number|'3600'
op|')'
newline|'\n'
name|'hashed'
op|'='
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3'"
newline|'\n'
name|'base_filename'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
name|'hashed'
op|')'
newline|'\n'
name|'touch'
op|'('
name|'base_filename'
op|')'
newline|'\n'
name|'touch'
op|'('
name|'base_filename'
op|'+'
string|"'.info'"
op|')'
newline|'\n'
name|'os'
op|'.'
name|'utime'
op|'('
name|'base_filename'
op|'+'
string|"'.info'"
op|','
op|'('
name|'old'
op|','
name|'old'
op|')'
op|')'
newline|'\n'
name|'touch'
op|'('
name|'base_filename'
op|'+'
string|"'.info'"
op|')'
newline|'\n'
name|'os'
op|'.'
name|'utime'
op|'('
name|'base_filename'
op|'+'
string|"'.info'"
op|','
op|'('
name|'old'
op|','
name|'old'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
nl|'\n'
name|'objects'
op|'.'
name|'block_device'
op|'.'
name|'BlockDeviceMappingList'
op|','
nl|'\n'
string|"'get_by_instance_uuid'"
op|')'
newline|'\n'
nl|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'objects'
op|'.'
name|'block_device'
op|'.'
name|'BlockDeviceMappingList'
op|'.'
name|'get_by_instance_uuid'
op|'('
nl|'\n'
name|'ctxt'
op|','
string|"'123'"
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'None'
op|')'
newline|'\n'
name|'objects'
op|'.'
name|'block_device'
op|'.'
name|'BlockDeviceMappingList'
op|'.'
name|'get_by_instance_uuid'
op|'('
nl|'\n'
name|'ctxt'
op|','
string|"'456'"
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'update'
op|'('
name|'ctxt'
op|','
nl|'\n'
name|'all_instances'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'base_filename'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'base_filename'
op|'+'
string|"'.info'"
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_image_cache_manager_pass
dedent|''
dedent|''
name|'def'
name|'test_run_image_cache_manager_pass'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'was'
op|'='
op|'{'
string|"'called'"
op|':'
name|'False'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_get_all_by_filters
name|'def'
name|'fake_get_all_by_filters'
op|'('
name|'context'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'was'
op|'['
string|"'called'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'instances'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'x'
name|'in'
name|'range'
op|'('
number|'2'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'instances'
op|'.'
name|'append'
op|'('
name|'fake_instance'
op|'.'
name|'fake_db_instance'
op|'('
nl|'\n'
name|'image_ref'
op|'='
string|"'1'"
op|','
nl|'\n'
name|'uuid'
op|'='
name|'x'
op|','
nl|'\n'
name|'name'
op|'='
name|'x'
op|','
nl|'\n'
name|'vm_state'
op|'='
string|"''"
op|','
nl|'\n'
name|'task_state'
op|'='
string|"''"
op|')'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'instances'
newline|'\n'
nl|'\n'
dedent|''
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'flags'
op|'('
name|'instances_path'
op|'='
name|'tmpdir'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stub_out'
op|'('
string|"'nova.db.instance_get_all_by_filters'"
op|','
nl|'\n'
name|'fake_get_all_by_filters'
op|')'
newline|'\n'
name|'compute'
op|'='
name|'importutils'
op|'.'
name|'import_object'
op|'('
name|'CONF'
op|'.'
name|'compute_manager'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'use_local'
op|'='
name|'True'
op|','
name|'group'
op|'='
string|"'conductor'"
op|')'
newline|'\n'
name|'compute'
op|'.'
name|'conductor_api'
op|'='
name|'conductor'
op|'.'
name|'API'
op|'('
op|')'
newline|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'compute'
op|'.'
name|'_run_image_cache_manager_pass'
op|'('
name|'ctxt'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'was'
op|'['
string|"'called'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_store_swap_image
dedent|''
dedent|''
name|'def'
name|'test_store_swap_image'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_store_swap_image'
op|'('
string|"'swap_'"
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_store_swap_image'
op|'('
string|"'swap_123'"
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_store_swap_image'
op|'('
string|"'swap_456'"
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_store_swap_image'
op|'('
string|"'swap_abc'"
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_store_swap_image'
op|'('
string|"'123_swap'"
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_store_swap_image'
op|'('
string|"'swap_129_'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'image_cache_manager'
op|'.'
name|'back_swap_images'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'expect_set'
op|'='
name|'set'
op|'('
op|'['
string|"'swap_123'"
op|','
string|"'swap_456'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'back_swap_images'
op|','
name|'expect_set'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'lockutils'
op|','
string|"'external_lock'"
op|')'
newline|'\n'
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'libvirt_utils'
op|','
string|"'update_mtime'"
op|')'
newline|'\n'
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.path.exists'"
op|','
name|'return_value'
op|'='
name|'True'
op|')'
newline|'\n'
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.path.getmtime'"
op|')'
newline|'\n'
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'('
string|"'os.remove'"
op|')'
newline|'\n'
DECL|member|test_age_and_verify_swap_images
name|'def'
name|'test_age_and_verify_swap_images'
op|'('
name|'self'
op|','
name|'mock_remove'
op|','
name|'mock_getmtime'
op|','
nl|'\n'
name|'mock_exist'
op|','
name|'mock_mtime'
op|','
name|'mock_lock'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'expected_remove'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'expected_exist'
op|'='
name|'set'
op|'('
op|'['
string|"'swap_128'"
op|','
string|"'swap_256'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'.'
name|'back_swap_images'
op|'.'
name|'add'
op|'('
string|"'swap_128'"
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'back_swap_images'
op|'.'
name|'add'
op|'('
string|"'swap_256'"
op|')'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'.'
name|'used_swap_images'
op|'.'
name|'add'
op|'('
string|"'swap_128'"
op|')'
newline|'\n'
nl|'\n'
DECL|function|getmtime
name|'def'
name|'getmtime'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'-'
number|'1000000'
newline|'\n'
nl|'\n'
dedent|''
name|'mock_getmtime'
op|'.'
name|'side_effect'
op|'='
name|'getmtime'
newline|'\n'
nl|'\n'
DECL|function|removefile
name|'def'
name|'removefile'
op|'('
name|'path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'path'
op|'.'
name|'startswith'
op|'('
string|"'/tmp_age_test'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'os'
op|'.'
name|'remove'
op|'('
name|'path'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'fn'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'split'
op|'('
name|'path'
op|')'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
name|'expected_remove'
op|'.'
name|'add'
op|'('
name|'fn'
op|')'
newline|'\n'
name|'expected_exist'
op|'.'
name|'remove'
op|'('
name|'fn'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'mock_remove'
op|'.'
name|'side_effect'
op|'='
name|'removefile'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'.'
name|'_age_and_verify_swap_images'
op|'('
name|'None'
op|','
string|"'/tmp_age_test'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'len'
op|'('
name|'expected_exist'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'len'
op|'('
name|'expected_remove'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'swap_128'"
op|','
name|'expected_exist'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'swap_256'"
op|','
name|'expected_remove'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'utils'
op|','
string|"'synchronized'"
op|')'
newline|'\n'
op|'@'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|','
string|"'_get_age_of_file'"
op|','
nl|'\n'
name|'return_value'
op|'='
op|'('
name|'True'
op|','
number|'100'
op|')'
op|')'
newline|'\n'
DECL|member|test_lock_acquired_on_removing_old_enough_files
name|'def'
name|'test_lock_acquired_on_removing_old_enough_files'
op|'('
name|'self'
op|','
name|'mock_get_age'
op|','
nl|'\n'
name|'mock_synchronized'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'base_file'
op|'='
string|"'/tmp_age_test'"
newline|'\n'
name|'lock_path'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'CONF'
op|'.'
name|'instances_path'
op|','
string|"'locks'"
op|')'
newline|'\n'
name|'lock_file'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'split'
op|'('
name|'base_file'
op|')'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_remove_old_enough_file'
op|'('
nl|'\n'
name|'base_file'
op|','
number|'60'
op|','
name|'remove_sig'
op|'='
name|'False'
op|','
name|'remove_lock'
op|'='
name|'False'
op|')'
newline|'\n'
name|'mock_synchronized'
op|'.'
name|'assert_called_once_with'
op|'('
name|'lock_file'
op|','
name|'external'
op|'='
name|'True'
op|','
nl|'\n'
name|'lock_path'
op|'='
name|'lock_path'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|VerifyChecksumTestCase
dedent|''
dedent|''
name|'class'
name|'VerifyChecksumTestCase'
op|'('
name|'test'
op|'.'
name|'NoDBTestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'VerifyChecksumTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'img'
op|'='
op|'{'
string|"'container_format'"
op|':'
string|"'ami'"
op|','
string|"'id'"
op|':'
string|"'42'"
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'checksum_base_images'
op|'='
name|'True'
op|','
name|'group'
op|'='
string|"'libvirt'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|_make_checksum
dedent|''
name|'def'
name|'_make_checksum'
op|'('
name|'self'
op|','
name|'tmpdir'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'testdata'
op|'='
op|'('
string|"'OpenStack Software delivers a massively scalable cloud '"
nl|'\n'
string|"'operating system.'"
op|')'
newline|'\n'
nl|'\n'
name|'fname'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|"'aaa'"
op|')'
newline|'\n'
name|'info_fname'
op|'='
name|'imagecache'
op|'.'
name|'get_info_filename'
op|'('
name|'fname'
op|')'
newline|'\n'
nl|'\n'
name|'with'
name|'open'
op|'('
name|'fname'
op|','
string|"'w'"
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'            '
name|'f'
op|'.'
name|'write'
op|'('
name|'testdata'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
name|'fname'
op|','
name|'info_fname'
op|','
name|'testdata'
newline|'\n'
nl|'\n'
DECL|member|_write_file
dedent|''
name|'def'
name|'_write_file'
op|'('
name|'self'
op|','
name|'info_fname'
op|','
name|'info_attr'
op|','
name|'testdata'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'f'
op|'='
name|'open'
op|'('
name|'info_fname'
op|','
string|"'w'"
op|')'
newline|'\n'
name|'if'
name|'info_attr'
op|'=='
string|'"csum valid"'
op|':'
newline|'\n'
indent|'            '
name|'csum'
op|'='
name|'hashlib'
op|'.'
name|'sha1'
op|'('
op|')'
newline|'\n'
name|'csum'
op|'.'
name|'update'
op|'('
name|'testdata'
op|')'
newline|'\n'
name|'f'
op|'.'
name|'write'
op|'('
string|'\'{"sha1": "%s"}\\n\''
op|'%'
name|'csum'
op|'.'
name|'hexdigest'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'info_attr'
op|'=='
string|'"csum invalid, not json"'
op|':'
newline|'\n'
indent|'            '
name|'f'
op|'.'
name|'write'
op|'('
string|"'banana'"
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'f'
op|'.'
name|'write'
op|'('
string|'\'{"sha1": "banana"}\''
op|')'
newline|'\n'
dedent|''
name|'f'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|_check_body
dedent|''
name|'def'
name|'_check_body'
op|'('
name|'self'
op|','
name|'tmpdir'
op|','
name|'info_attr'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'instances_path'
op|'='
name|'tmpdir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'image_info_filename_pattern'
op|'='
op|'('
string|"'$instances_path/'"
nl|'\n'
string|"'%(image)s.info'"
op|')'
op|','
nl|'\n'
name|'group'
op|'='
string|"'libvirt'"
op|')'
newline|'\n'
name|'fname'
op|','
name|'info_fname'
op|','
name|'testdata'
op|'='
name|'self'
op|'.'
name|'_make_checksum'
op|'('
name|'tmpdir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_write_file'
op|'('
name|'info_fname'
op|','
name|'info_attr'
op|','
name|'testdata'
op|')'
newline|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'return'
name|'image_cache_manager'
op|','
name|'fname'
newline|'\n'
nl|'\n'
DECL|member|test_verify_checksum
dedent|''
name|'def'
name|'test_verify_checksum'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'image_cache_manager'
op|','
name|'fname'
op|'='
name|'self'
op|'.'
name|'_check_body'
op|'('
name|'tmpdir'
op|','
string|'"csum valid"'
op|')'
newline|'\n'
name|'res'
op|'='
name|'image_cache_manager'
op|'.'
name|'_verify_checksum'
op|'('
name|'self'
op|'.'
name|'img'
op|','
name|'fname'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'res'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_verify_checksum_disabled
dedent|''
dedent|''
name|'def'
name|'test_verify_checksum_disabled'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'checksum_base_images'
op|'='
name|'False'
op|','
name|'group'
op|'='
string|"'libvirt'"
op|')'
newline|'\n'
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'image_cache_manager'
op|','
name|'fname'
op|'='
name|'self'
op|'.'
name|'_check_body'
op|'('
name|'tmpdir'
op|','
string|'"csum valid"'
op|')'
newline|'\n'
name|'res'
op|'='
name|'image_cache_manager'
op|'.'
name|'_verify_checksum'
op|'('
name|'self'
op|'.'
name|'img'
op|','
name|'fname'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'res'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_verify_checksum_invalid_json
dedent|''
dedent|''
name|'def'
name|'test_verify_checksum_invalid_json'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'intercept_log_messages'
op|'('
op|')'
name|'as'
name|'stream'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'                '
name|'image_cache_manager'
op|','
name|'fname'
op|'='
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_check_body'
op|'('
name|'tmpdir'
op|','
string|'"csum invalid, not json"'
op|')'
op|')'
newline|'\n'
name|'res'
op|'='
name|'image_cache_manager'
op|'.'
name|'_verify_checksum'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'img'
op|','
name|'fname'
op|','
name|'create_if_missing'
op|'='
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'res'
op|')'
newline|'\n'
name|'log'
op|'='
name|'stream'
op|'.'
name|'getvalue'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# NOTE(mikal): this is a skip not a fail because the file is'
nl|'\n'
comment|'# present, but is not in valid JSON format and therefore is'
nl|'\n'
comment|'# skipped.'
nl|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'log'
op|'.'
name|'find'
op|'('
string|"'image verification skipped'"
op|')'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_verify_checksum_invalid_repaired
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_verify_checksum_invalid_repaired'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'image_cache_manager'
op|','
name|'fname'
op|'='
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_check_body'
op|'('
name|'tmpdir'
op|','
string|'"csum invalid, not json"'
op|')'
op|')'
newline|'\n'
name|'res'
op|'='
name|'image_cache_manager'
op|'.'
name|'_verify_checksum'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'img'
op|','
name|'fname'
op|','
name|'create_if_missing'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'res'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_verify_checksum_invalid
dedent|''
dedent|''
name|'def'
name|'test_verify_checksum_invalid'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'intercept_log_messages'
op|'('
op|')'
name|'as'
name|'stream'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'                '
name|'image_cache_manager'
op|','
name|'fname'
op|'='
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_check_body'
op|'('
name|'tmpdir'
op|','
string|'"csum invalid, valid json"'
op|')'
op|')'
newline|'\n'
name|'res'
op|'='
name|'image_cache_manager'
op|'.'
name|'_verify_checksum'
op|'('
name|'self'
op|'.'
name|'img'
op|','
name|'fname'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'res'
op|')'
newline|'\n'
name|'log'
op|'='
name|'stream'
op|'.'
name|'getvalue'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'log'
op|'.'
name|'find'
op|'('
string|"'image verification failed'"
op|')'
op|','
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_verify_checksum_file_missing
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_verify_checksum_file_missing'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'utils'
op|'.'
name|'tempdir'
op|'('
op|')'
name|'as'
name|'tmpdir'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'flags'
op|'('
name|'instances_path'
op|'='
name|'tmpdir'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'image_info_filename_pattern'
op|'='
op|'('
string|"'$instances_path/'"
nl|'\n'
string|"'%(image)s.info'"
op|')'
op|','
nl|'\n'
name|'group'
op|'='
string|"'libvirt'"
op|')'
newline|'\n'
name|'fname'
op|','
name|'info_fname'
op|','
name|'testdata'
op|'='
name|'self'
op|'.'
name|'_make_checksum'
op|'('
name|'tmpdir'
op|')'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'res'
op|'='
name|'image_cache_manager'
op|'.'
name|'_verify_checksum'
op|'('
string|"'aaa'"
op|','
name|'fname'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'res'
op|')'
newline|'\n'
nl|'\n'
comment|'# Checksum requests for a file with no checksum now have the'
nl|'\n'
comment|'# side effect of creating the checksum'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'info_fname'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
endmarker|''
end_unit
