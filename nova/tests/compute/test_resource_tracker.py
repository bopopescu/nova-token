begin_unit
comment|'# vim: tabstop=4 shiftwidth=4 softtabstop=4'
nl|'\n'
nl|'\n'
comment|'# Copyright (c) 2012 OpenStack, LLC.'
nl|'\n'
comment|'# All Rights Reserved.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
string|'"""Tests for compute resource tracking"""'
newline|'\n'
nl|'\n'
name|'import'
name|'uuid'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
op|'.'
name|'compute'
name|'import'
name|'resource_tracker'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'compute'
name|'import'
name|'task_states'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'compute'
name|'import'
name|'vm_states'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'context'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'db'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'log'
name|'as'
name|'logging'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'timeutils'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'test'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
name|'import'
name|'driver'
newline|'\n'
nl|'\n'
DECL|variable|LOG
name|'LOG'
op|'='
name|'logging'
op|'.'
name|'getLogger'
op|'('
name|'__name__'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|UnsupportedVirtDriver
name|'class'
name|'UnsupportedVirtDriver'
op|'('
name|'driver'
op|'.'
name|'ComputeDriver'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Pretend version of a lame virt driver"""'
newline|'\n'
DECL|member|get_available_resource
name|'def'
name|'get_available_resource'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# no support for getting resource usage info'
nl|'\n'
indent|'        '
name|'return'
op|'{'
op|'}'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|FakeVirtDriver
dedent|''
dedent|''
name|'class'
name|'FakeVirtDriver'
op|'('
name|'driver'
op|'.'
name|'ComputeDriver'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'memory_mb'
op|'='
number|'5'
newline|'\n'
name|'self'
op|'.'
name|'local_gb'
op|'='
number|'6'
newline|'\n'
name|'self'
op|'.'
name|'vcpus'
op|'='
number|'1'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'memory_mb_used'
op|'='
number|'0'
newline|'\n'
name|'self'
op|'.'
name|'local_gb_used'
op|'='
number|'0'
newline|'\n'
nl|'\n'
DECL|member|get_available_resource
dedent|''
name|'def'
name|'get_available_resource'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'d'
op|'='
op|'{'
nl|'\n'
string|"'vcpus'"
op|':'
name|'self'
op|'.'
name|'vcpus'
op|','
nl|'\n'
string|"'memory_mb'"
op|':'
name|'self'
op|'.'
name|'memory_mb'
op|','
nl|'\n'
string|"'local_gb'"
op|':'
name|'self'
op|'.'
name|'local_gb'
op|','
nl|'\n'
string|"'vcpus_used'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'memory_mb_used'"
op|':'
name|'self'
op|'.'
name|'memory_mb_used'
op|','
nl|'\n'
string|"'local_gb_used'"
op|':'
name|'self'
op|'.'
name|'local_gb_used'
op|','
nl|'\n'
string|"'hypervisor_type'"
op|':'
string|"'fake'"
op|','
nl|'\n'
string|"'hypervisor_version'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'hypervisor_hostname'"
op|':'
string|"'fakehost'"
op|','
nl|'\n'
string|"'cpu_info'"
op|':'
string|"''"
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'return'
name|'d'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|BaseTestCase
dedent|''
dedent|''
name|'class'
name|'BaseTestCase'
op|'('
name|'test'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'BaseTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'reserved_host_disk_mb'
op|'='
number|'0'
op|','
nl|'\n'
name|'reserved_host_memory_mb'
op|'='
number|'0'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'context'
op|'='
name|'context'
op|'.'
name|'RequestContext'
op|'('
string|"'fake'"
op|','
string|"'fake'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_instances'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'instance_get_all_by_host'"
op|','
nl|'\n'
name|'lambda'
name|'c'
op|','
name|'h'
op|':'
name|'self'
op|'.'
name|'_instances'
op|'.'
name|'values'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'instance_update_and_get_original'"
op|','
nl|'\n'
name|'self'
op|'.'
name|'_fake_instance_update_and_get_original'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_create_compute_node
dedent|''
name|'def'
name|'_create_compute_node'
op|'('
name|'self'
op|','
name|'values'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'compute'
op|'='
op|'{'
nl|'\n'
string|'"id"'
op|':'
number|'1'
op|','
nl|'\n'
string|'"service_id"'
op|':'
number|'1'
op|','
nl|'\n'
string|'"vcpus"'
op|':'
number|'1'
op|','
nl|'\n'
string|'"memory_mb"'
op|':'
number|'1'
op|','
nl|'\n'
string|'"local_gb"'
op|':'
number|'1'
op|','
nl|'\n'
string|'"vcpus_used"'
op|':'
number|'1'
op|','
nl|'\n'
string|'"memory_mb_used"'
op|':'
number|'1'
op|','
nl|'\n'
string|'"local_gb_used"'
op|':'
number|'1'
op|','
nl|'\n'
string|'"free_ram_mb"'
op|':'
number|'1'
op|','
nl|'\n'
string|'"free_disk_gb"'
op|':'
number|'1'
op|','
nl|'\n'
string|'"current_workload"'
op|':'
number|'1'
op|','
nl|'\n'
string|'"running_vms"'
op|':'
number|'0'
op|','
nl|'\n'
string|'"cpu_info"'
op|':'
name|'None'
op|','
nl|'\n'
string|'"stats"'
op|':'
op|'['
op|'{'
string|'"key"'
op|':'
string|'"num_instances"'
op|','
string|'"value"'
op|':'
string|'"1"'
op|'}'
op|']'
nl|'\n'
op|'}'
newline|'\n'
name|'if'
name|'values'
op|':'
newline|'\n'
indent|'            '
name|'compute'
op|'.'
name|'update'
op|'('
name|'values'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'compute'
newline|'\n'
nl|'\n'
DECL|member|_create_service
dedent|''
name|'def'
name|'_create_service'
op|'('
name|'self'
op|','
name|'host'
op|'='
string|'"fakehost"'
op|','
name|'compute'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'compute'
op|':'
newline|'\n'
indent|'            '
name|'compute'
op|'='
op|'['
name|'compute'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'service'
op|'='
op|'{'
nl|'\n'
string|'"id"'
op|':'
number|'1'
op|','
nl|'\n'
string|'"host"'
op|':'
name|'host'
op|','
nl|'\n'
string|'"binary"'
op|':'
string|'"nova-compute"'
op|','
nl|'\n'
string|'"topic"'
op|':'
string|'"compute"'
op|','
nl|'\n'
string|'"compute_node"'
op|':'
name|'compute'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'return'
name|'service'
newline|'\n'
nl|'\n'
DECL|member|_fake_instance
dedent|''
name|'def'
name|'_fake_instance'
op|'('
name|'self'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'        '
name|'instance_uuid'
op|'='
name|'str'
op|'('
name|'uuid'
op|'.'
name|'uuid1'
op|'('
op|')'
op|')'
newline|'\n'
name|'instance'
op|'='
op|'{'
nl|'\n'
string|"'uuid'"
op|':'
name|'instance_uuid'
op|','
nl|'\n'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'BUILDING'
op|','
nl|'\n'
string|"'task_state'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'memory_mb'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'root_gb'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'ephemeral_gb'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'os_type'"
op|':'
string|"'Linux'"
op|','
nl|'\n'
string|"'project_id'"
op|':'
string|"'123456'"
op|','
nl|'\n'
string|"'vcpus'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'host'"
op|':'
name|'None'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'instance'
op|'.'
name|'update'
op|'('
name|'kwargs'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_instances'
op|'['
name|'instance_uuid'
op|']'
op|'='
name|'instance'
newline|'\n'
name|'return'
name|'instance'
newline|'\n'
nl|'\n'
DECL|member|_fake_instance_update_and_get_original
dedent|''
name|'def'
name|'_fake_instance_update_and_get_original'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance_uuid'
op|','
nl|'\n'
name|'values'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_instances'
op|'['
name|'instance_uuid'
op|']'
newline|'\n'
name|'instance'
op|'.'
name|'update'
op|'('
name|'values'
op|')'
newline|'\n'
comment|"# the test doesn't care what the original instance values are, it's"
nl|'\n'
comment|'# only used in the subsequent notification:'
nl|'\n'
name|'return'
op|'('
name|'instance'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_tracker
dedent|''
name|'def'
name|'_tracker'
op|'('
name|'self'
op|','
name|'unsupported'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'host'
op|'='
string|'"fakehost"'
newline|'\n'
nl|'\n'
name|'if'
name|'unsupported'
op|':'
newline|'\n'
indent|'            '
name|'driver'
op|'='
name|'UnsupportedVirtDriver'
op|'('
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'driver'
op|'='
name|'FakeVirtDriver'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'tracker'
op|'='
name|'resource_tracker'
op|'.'
name|'ResourceTracker'
op|'('
name|'host'
op|','
name|'driver'
op|')'
newline|'\n'
name|'return'
name|'tracker'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|UnsupportedDriverTestCase
dedent|''
dedent|''
name|'class'
name|'UnsupportedDriverTestCase'
op|'('
name|'BaseTestCase'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Resource tracking should be disabled when the virt driver doesn\'t\n    support it.\n    """'
newline|'\n'
DECL|member|setUp
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'UnsupportedDriverTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'tracker'
op|'='
name|'self'
op|'.'
name|'_tracker'
op|'('
name|'unsupported'
op|'='
name|'True'
op|')'
newline|'\n'
comment|'# seed tracker with data:'
nl|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'update_available_resource'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testDisabled
dedent|''
name|'def'
name|'testDisabled'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# disabled = no compute node stats'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'disabled'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'None'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testDisabledClaim
dedent|''
name|'def'
name|'testDisabledClaim'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# basic claim:'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
op|')'
newline|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'None'
op|','
name|'claim'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testDisabledInstanceClaim
dedent|''
name|'def'
name|'testDisabledInstanceClaim'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# instance variation:'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
op|')'
newline|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'None'
op|','
name|'claim'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testDisabledInstanceContextClaim
dedent|''
name|'def'
name|'testDisabledInstanceContextClaim'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# instance context manager variation:'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
op|')'
newline|'\n'
name|'with'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'len'
op|'('
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'claims'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testDisabledFinishClaim
dedent|''
name|'def'
name|'testDisabledFinishClaim'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'None'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'finish_resource_claim'
op|'('
name|'None'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testDisabledAbortClaim
dedent|''
name|'def'
name|'testDisabledAbortClaim'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'None'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'abort_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'None'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testDisabledUpdateUsage
dedent|''
name|'def'
name|'testDisabledUpdateUsage'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'host'
op|'='
string|"'fakehost'"
op|','
name|'memory_mb'
op|'='
number|'5'
op|','
nl|'\n'
name|'root_gb'
op|'='
number|'10'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'update_usage'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|MissingServiceTestCase
dedent|''
dedent|''
name|'class'
name|'MissingServiceTestCase'
op|'('
name|'BaseTestCase'
op|')'
op|':'
newline|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'MissingServiceTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'context'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'tracker'
op|'='
name|'self'
op|'.'
name|'_tracker'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|testMissingService
dedent|''
name|'def'
name|'testMissingService'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""No service record in DB."""'
newline|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'update_available_resource'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'disabled'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|MissingComputeNodeTestCase
dedent|''
dedent|''
name|'class'
name|'MissingComputeNodeTestCase'
op|'('
name|'BaseTestCase'
op|')'
op|':'
newline|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'MissingComputeNodeTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'tracker'
op|'='
name|'self'
op|'.'
name|'_tracker'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'service_get_all_compute_by_host'"
op|','
nl|'\n'
name|'self'
op|'.'
name|'_fake_service_get_all_compute_by_host'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'compute_node_create'"
op|','
nl|'\n'
name|'self'
op|'.'
name|'_fake_create_compute_node'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_fake_create_compute_node
dedent|''
name|'def'
name|'_fake_create_compute_node'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'values'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'created'
op|'='
name|'True'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'_create_compute_node'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|_fake_service_get_all_compute_by_host
dedent|''
name|'def'
name|'_fake_service_get_all_compute_by_host'
op|'('
name|'self'
op|','
name|'ctx'
op|','
name|'host'
op|')'
op|':'
newline|'\n'
comment|'# return a service with no joined compute'
nl|'\n'
indent|'        '
name|'service'
op|'='
name|'self'
op|'.'
name|'_create_service'
op|'('
op|')'
newline|'\n'
name|'return'
op|'['
name|'service'
op|']'
newline|'\n'
nl|'\n'
DECL|member|testCreatedComputeNode
dedent|''
name|'def'
name|'testCreatedComputeNode'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'update_available_resource'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'self'
op|'.'
name|'created'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testEnabled
dedent|''
name|'def'
name|'testEnabled'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'update_available_resource'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'disabled'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ResourceTestCase
dedent|''
dedent|''
name|'class'
name|'ResourceTestCase'
op|'('
name|'BaseTestCase'
op|')'
op|':'
newline|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'ResourceTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'tracker'
op|'='
name|'self'
op|'.'
name|'_tracker'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'service_get_all_compute_by_host'"
op|','
nl|'\n'
name|'self'
op|'.'
name|'_fake_service_get_all_compute_by_host'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'compute_node_update'"
op|','
nl|'\n'
name|'self'
op|'.'
name|'_fake_compute_node_update'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'update_available_resource'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_fake_service_get_all_compute_by_host
dedent|''
name|'def'
name|'_fake_service_get_all_compute_by_host'
op|'('
name|'self'
op|','
name|'ctx'
op|','
name|'host'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'compute'
op|'='
name|'self'
op|'.'
name|'_create_compute_node'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'service'
op|'='
name|'self'
op|'.'
name|'_create_service'
op|'('
name|'host'
op|','
name|'compute'
op|'='
name|'self'
op|'.'
name|'compute'
op|')'
newline|'\n'
name|'return'
op|'['
name|'self'
op|'.'
name|'service'
op|']'
newline|'\n'
nl|'\n'
DECL|member|_fake_compute_node_update
dedent|''
name|'def'
name|'_fake_compute_node_update'
op|'('
name|'self'
op|','
name|'ctx'
op|','
name|'compute_node_id'
op|','
name|'values'
op|','
nl|'\n'
name|'prune_stats'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'updated'
op|'='
name|'True'
newline|'\n'
name|'values'
op|'['
string|"'stats'"
op|']'
op|'='
op|'['
op|'{'
string|'"key"'
op|':'
string|'"num_instances"'
op|','
string|'"value"'
op|':'
string|'"1"'
op|'}'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'update'
op|'('
name|'values'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'compute'
newline|'\n'
nl|'\n'
DECL|member|testUpdateUseOnlyForTracked
dedent|''
name|'def'
name|'testUpdateUseOnlyForTracked'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Only update usage is a previous claim has added instance to\n        list of tracked instances.\n        """'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
number|'3'
op|','
name|'root_gb'
op|'='
number|'1'
op|','
name|'ephemeral_gb'
op|'='
number|'1'
op|','
nl|'\n'
name|'task_state'
op|'='
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'update_usage'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'current_workload'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'None'
op|','
name|'claim'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'3'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# now update should actually take effect'
nl|'\n'
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|'='
name|'task_states'
op|'.'
name|'SCHEDULING'
newline|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'update_usage'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'3'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'current_workload'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testFreeRamResourceValue
dedent|''
name|'def'
name|'testFreeRamResourceValue'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'driver'
op|'='
name|'FakeVirtDriver'
op|'('
op|')'
newline|'\n'
name|'mem_free'
op|'='
name|'driver'
op|'.'
name|'memory_mb'
op|'-'
name|'driver'
op|'.'
name|'memory_mb_used'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'mem_free'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'free_ram_mb'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testFreeDiskResourceValue
dedent|''
name|'def'
name|'testFreeDiskResourceValue'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'driver'
op|'='
name|'FakeVirtDriver'
op|'('
op|')'
newline|'\n'
name|'mem_free'
op|'='
name|'driver'
op|'.'
name|'local_gb'
op|'-'
name|'driver'
op|'.'
name|'local_gb_used'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'mem_free'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'free_disk_gb'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testUpdateComputeNode
dedent|''
name|'def'
name|'testUpdateComputeNode'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'disabled'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'self'
op|'.'
name|'updated'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testCpuUnlimited
dedent|''
name|'def'
name|'testCpuUnlimited'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Test default of unlimited CPU"""'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'vcpus_used'"
op|']'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
number|'1'
op|','
name|'root_gb'
op|'='
number|'1'
op|','
name|'ephemeral_gb'
op|'='
number|'1'
op|','
nl|'\n'
name|'vcpus'
op|'='
number|'100000'
op|')'
newline|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'None'
op|','
name|'claim'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'100000'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'vcpus_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testCpuOversubscription
dedent|''
name|'def'
name|'testCpuOversubscription'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Test client-supplied oversubscription of CPU"""'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'vcpus'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
number|'1'
op|','
name|'root_gb'
op|'='
number|'1'
op|','
name|'ephemeral_gb'
op|'='
number|'1'
op|','
nl|'\n'
name|'vcpus'
op|'='
number|'3'
op|')'
newline|'\n'
name|'limits'
op|'='
op|'{'
string|"'vcpu'"
op|':'
number|'5'
op|'}'
newline|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'limits'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'None'
op|','
name|'claim'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'3'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'vcpus_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testMemoryOversubscription
dedent|''
name|'def'
name|'testMemoryOversubscription'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Test client-supplied oversubscription of memory"""'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
number|'8'
op|','
name|'root_gb'
op|'='
number|'1'
op|','
name|'ephemeral_gb'
op|'='
number|'1'
op|')'
newline|'\n'
name|'limits'
op|'='
op|'{'
string|"'memory_mb'"
op|':'
number|'8'
op|'}'
newline|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'limits'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'None'
op|','
name|'claim'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'8'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testDiskOversubscription
dedent|''
name|'def'
name|'testDiskOversubscription'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Test client-supplied oversubscription of disk space"""'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
number|'1'
op|','
name|'root_gb'
op|'='
number|'10'
op|','
name|'ephemeral_gb'
op|'='
number|'1'
op|')'
newline|'\n'
name|'limits'
op|'='
op|'{'
string|"'disk_gb'"
op|':'
number|'12'
op|'}'
newline|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'limits'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'None'
op|','
name|'claim'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'11'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testUnlimitedMemoryClaim
dedent|''
name|'def'
name|'testUnlimitedMemoryClaim'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Test default of unlimited memory"""'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
number|'200000000000'
op|','
name|'root_gb'
op|'='
number|'1'
op|','
nl|'\n'
name|'ephemeral_gb'
op|'='
number|'1'
op|')'
newline|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'None'
op|','
name|'claim'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'200000000000'
op|','
nl|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testInsufficientMemoryClaimWithOversubscription
dedent|''
name|'def'
name|'testInsufficientMemoryClaimWithOversubscription'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Exceed oversubscribed memory limit of 10MB"""'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
number|'10'
op|','
name|'root_gb'
op|'='
number|'0'
op|','
nl|'\n'
name|'ephemeral_gb'
op|'='
number|'0'
op|')'
newline|'\n'
name|'limits'
op|'='
op|'{'
string|"'memory_mb'"
op|':'
number|'10'
op|'}'
newline|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'limits'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'None'
op|','
name|'claim'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
number|'1'
op|','
name|'root_gb'
op|'='
number|'0'
op|','
nl|'\n'
name|'ephemeral_gb'
op|'='
number|'0'
op|')'
newline|'\n'
name|'limits'
op|'='
op|'{'
string|"'memory_mb'"
op|':'
number|'10'
op|'}'
newline|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'limits'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'None'
op|','
name|'claim'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testUnlimitDiskClaim
dedent|''
name|'def'
name|'testUnlimitDiskClaim'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Test default of unlimited disk space"""'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
number|'0'
op|','
name|'root_gb'
op|'='
number|'200000000'
op|','
nl|'\n'
name|'ephemeral_gb'
op|'='
number|'0'
op|')'
newline|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'None'
op|','
name|'claim'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'200000000'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testInsufficientDiskClaimWithOversubscription
dedent|''
name|'def'
name|'testInsufficientDiskClaimWithOversubscription'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Exceed oversubscribed disk limit of 10GB"""'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
number|'1'
op|','
name|'root_gb'
op|'='
number|'4'
op|','
nl|'\n'
name|'ephemeral_gb'
op|'='
number|'5'
op|')'
comment|'# 9 GB'
newline|'\n'
name|'limits'
op|'='
op|'{'
string|"'disk_gb'"
op|':'
number|'10'
op|'}'
newline|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'limits'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'None'
op|','
name|'claim'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
number|'1'
op|','
name|'root_gb'
op|'='
number|'1'
op|','
nl|'\n'
name|'ephemeral_gb'
op|'='
number|'1'
op|')'
comment|'# 2 GB'
newline|'\n'
name|'limits'
op|'='
op|'{'
string|"'disk_gb'"
op|':'
number|'10'
op|'}'
newline|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'limits'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'None'
op|','
name|'claim'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testInsufficientCpuClaim
dedent|''
name|'def'
name|'testInsufficientCpuClaim'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
number|'0'
op|','
name|'root_gb'
op|'='
number|'0'
op|','
nl|'\n'
name|'ephemeral_gb'
op|'='
number|'0'
op|','
name|'vcpus'
op|'='
number|'1'
op|')'
newline|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'None'
op|','
name|'claim'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'vcpus_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
number|'0'
op|','
name|'root_gb'
op|'='
number|'0'
op|','
nl|'\n'
name|'ephemeral_gb'
op|'='
number|'0'
op|','
name|'vcpus'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'limits'
op|'='
op|'{'
string|"'vcpu'"
op|':'
number|'1'
op|'}'
newline|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'limits'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'None'
op|','
name|'claim'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testClaimAndFinish
dedent|''
name|'def'
name|'testClaimAndFinish'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'5'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'6'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'local_gb'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'claim_mem'
op|'='
number|'3'
newline|'\n'
name|'claim_disk'
op|'='
number|'2'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
name|'claim_mem'
op|','
name|'root_gb'
op|'='
name|'claim_disk'
op|','
nl|'\n'
name|'ephemeral_gb'
op|'='
number|'0'
op|')'
newline|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'5'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"memory_mb"'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'claim_mem'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"memory_mb_used"'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'5'
op|'-'
name|'claim_mem'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"free_ram_mb"'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'6'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"local_gb"'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'claim_disk'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"local_gb_used"'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'6'
op|'-'
name|'claim_disk'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"free_disk_gb"'
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# 1st pretend that the compute operation finished and claimed the'
nl|'\n'
comment|'# desired resources from the virt layer'
nl|'\n'
name|'driver'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'driver'
newline|'\n'
name|'driver'
op|'.'
name|'memory_mb_used'
op|'='
name|'claim_mem'
newline|'\n'
name|'driver'
op|'.'
name|'local_gb_used'
op|'='
name|'claim_disk'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'update_available_resource'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
nl|'\n'
comment|'# confirm that resource usage is derived from instance usages,'
nl|'\n'
comment|'# not virt layer:'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'claim_mem'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'5'
op|'-'
name|'claim_mem'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|"'free_ram_mb'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'claim_disk'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'6'
op|'-'
name|'claim_disk'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|"'free_disk_gb'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# Finally, finish the claimm and update from the virt layer again.'
nl|'\n'
comment|'# Resource usage will be consistent again:'
nl|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'finish_resource_claim'
op|'('
name|'claim'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'update_available_resource'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'claim_mem'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'5'
op|'-'
name|'claim_mem'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|"'free_ram_mb'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'claim_disk'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'6'
op|'-'
name|'claim_disk'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|"'free_disk_gb'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testClaimAndAbort
dedent|''
name|'def'
name|'testClaimAndAbort'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'5'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'6'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'local_gb'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'claim_mem'
op|'='
number|'3'
newline|'\n'
name|'claim_disk'
op|'='
number|'2'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
name|'claim_mem'
op|','
nl|'\n'
name|'root_gb'
op|'='
name|'claim_disk'
op|','
name|'ephemeral_gb'
op|'='
number|'0'
op|')'
newline|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'None'
op|','
name|'claim'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'5'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"memory_mb"'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'claim_mem'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"memory_mb_used"'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'5'
op|'-'
name|'claim_mem'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"free_ram_mb"'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'6'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"local_gb"'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'claim_disk'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"local_gb_used"'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'6'
op|'-'
name|'claim_disk'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"free_disk_gb"'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'abort_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'claim'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'5'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"memory_mb"'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"memory_mb_used"'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'5'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"free_ram_mb"'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'6'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"local_gb"'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"local_gb_used"'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'6'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|'"free_disk_gb"'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testClaimsPurge
dedent|''
name|'def'
name|'testClaimsPurge'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Test that claims get get purged when the audit process runs"""'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
number|'2'
op|','
name|'root_gb'
op|'='
number|'2'
op|','
name|'ephemeral_gb'
op|'='
number|'0'
op|')'
newline|'\n'
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'update_available_resource'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'{'
op|'}'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'claims'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testInstanceClaim
dedent|''
name|'def'
name|'testInstanceClaim'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
number|'1'
op|','
name|'root_gb'
op|'='
number|'0'
op|','
name|'ephemeral_gb'
op|'='
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'begin_resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testContextClaimWithException
dedent|''
name|'def'
name|'testContextClaimWithException'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
number|'1'
op|','
name|'root_gb'
op|'='
number|'1'
op|','
name|'ephemeral_gb'
op|'='
number|'1'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
comment|'# <insert exciting things that utilize resources>'
nl|'\n'
indent|'                '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'test'
op|'.'
name|'TestingException'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testInstanceContextClaim
dedent|''
name|'def'
name|'testInstanceContextClaim'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'memory_mb'
op|'='
number|'1'
op|','
name|'root_gb'
op|'='
number|'1'
op|','
name|'ephemeral_gb'
op|'='
number|'1'
op|')'
newline|'\n'
name|'with'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
comment|'# <insert exciting things that utilize resources>'
nl|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# after exiting claim context, build is marked as finished.  usage'
nl|'\n'
comment|'# totals should be same:'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'update_available_resource'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'self'
op|'.'
name|'compute'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testUpdateLoadStatsForInstance
dedent|''
name|'def'
name|'testUpdateLoadStatsForInstance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'disabled'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'current_workload'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'SCHEDULING'
op|')'
newline|'\n'
name|'with'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'current_workload'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|'='
name|'vm_states'
op|'.'
name|'ACTIVE'
newline|'\n'
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|'='
name|'None'
newline|'\n'
name|'instance'
op|'['
string|"'host'"
op|']'
op|'='
string|"'fakehost'"
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'update_usage'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'current_workload'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|testCpuStats
dedent|''
name|'def'
name|'testCpuStats'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'limits'
op|'='
op|'{'
string|"'disk_gb'"
op|':'
number|'100'
op|','
string|"'memory_mb'"
op|':'
number|'100'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'vcpus_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'vcpus'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
comment|'# should not do anything until a claim is made:'
nl|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'update_usage'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'vcpus_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'with'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
name|'limits'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'vcpus_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# instance state can change without modifying vcpus in use:'
nl|'\n'
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|'='
name|'task_states'
op|'.'
name|'SCHEDULING'
newline|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'update_usage'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'vcpus_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_fake_instance'
op|'('
name|'vcpus'
op|'='
number|'10'
op|')'
newline|'\n'
name|'with'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'resource_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
name|'limits'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'11'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'vcpus_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|'='
name|'vm_states'
op|'.'
name|'DELETED'
newline|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'update_usage'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'compute_node'
op|'['
string|"'vcpus_used'"
op|']'
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
