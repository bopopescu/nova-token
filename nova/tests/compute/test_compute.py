begin_unit
comment|'# vim: tabstop=4 shiftwidth=4 softtabstop=4'
nl|'\n'
nl|'\n'
comment|'# Copyright 2010 United States Government as represented by the'
nl|'\n'
comment|'# Administrator of the National Aeronautics and Space Administration.'
nl|'\n'
comment|'# Copyright 2011 Piston Cloud Computing, Inc.'
nl|'\n'
comment|'# All Rights Reserved.'
nl|'\n'
comment|'# Copyright 2013 Red Hat, Inc.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
string|'"""Tests for compute service."""'
newline|'\n'
nl|'\n'
name|'import'
name|'base64'
newline|'\n'
name|'import'
name|'contextlib'
newline|'\n'
name|'import'
name|'copy'
newline|'\n'
name|'import'
name|'datetime'
newline|'\n'
name|'import'
name|'operator'
newline|'\n'
name|'import'
name|'sys'
newline|'\n'
name|'import'
name|'testtools'
newline|'\n'
name|'import'
name|'time'
newline|'\n'
name|'import'
name|'traceback'
newline|'\n'
name|'import'
name|'uuid'
newline|'\n'
nl|'\n'
name|'import'
name|'mock'
newline|'\n'
name|'import'
name|'mox'
newline|'\n'
name|'from'
name|'oslo'
op|'.'
name|'config'
name|'import'
name|'cfg'
newline|'\n'
nl|'\n'
name|'import'
name|'nova'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'availability_zones'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'block_device'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'compute'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'compute'
name|'import'
name|'api'
name|'as'
name|'compute_api'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'compute'
name|'import'
name|'flavors'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'compute'
name|'import'
name|'manager'
name|'as'
name|'compute_manager'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'compute'
name|'import'
name|'power_state'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'compute'
name|'import'
name|'rpcapi'
name|'as'
name|'compute_rpcapi'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'compute'
name|'import'
name|'task_states'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'compute'
name|'import'
name|'utils'
name|'as'
name|'compute_utils'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'compute'
name|'import'
name|'vm_states'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'conductor'
name|'import'
name|'manager'
name|'as'
name|'conductor_manager'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'context'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'db'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'image'
name|'import'
name|'glance'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'network'
name|'import'
name|'api'
name|'as'
name|'network_api'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'network'
name|'import'
name|'model'
name|'as'
name|'network_model'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'network'
op|'.'
name|'security_group'
name|'import'
name|'openstack_driver'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'objects'
name|'import'
name|'base'
name|'as'
name|'obj_base'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'objects'
name|'import'
name|'instance'
name|'as'
name|'instance_obj'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'objects'
name|'import'
name|'migration'
name|'as'
name|'migration_obj'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'objects'
name|'import'
name|'quotas'
name|'as'
name|'quotas_obj'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
op|'.'
name|'gettextutils'
name|'import'
name|'_'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'importutils'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'jsonutils'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'log'
name|'as'
name|'logging'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'rpc'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
op|'.'
name|'rpc'
name|'import'
name|'common'
name|'as'
name|'rpc_common'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'timeutils'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'uuidutils'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'policy'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'quota'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'test'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'tests'
op|'.'
name|'compute'
name|'import'
name|'fake_resource_tracker'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'tests'
op|'.'
name|'db'
name|'import'
name|'fakes'
name|'as'
name|'db_fakes'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'tests'
name|'import'
name|'fake_instance'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'tests'
name|'import'
name|'fake_instance_actions'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'tests'
name|'import'
name|'fake_network'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'tests'
name|'import'
name|'fake_network_cache_model'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'tests'
name|'import'
name|'fake_notifier'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'tests'
op|'.'
name|'image'
name|'import'
name|'fake'
name|'as'
name|'fake_image'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'tests'
name|'import'
name|'matchers'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'tests'
op|'.'
name|'objects'
name|'import'
name|'test_migration'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'utils'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
name|'import'
name|'event'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
name|'import'
name|'fake'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'volume'
name|'import'
name|'cinder'
newline|'\n'
nl|'\n'
DECL|variable|QUOTAS
name|'QUOTAS'
op|'='
name|'quota'
op|'.'
name|'QUOTAS'
newline|'\n'
DECL|variable|LOG
name|'LOG'
op|'='
name|'logging'
op|'.'
name|'getLogger'
op|'('
name|'__name__'
op|')'
newline|'\n'
DECL|variable|CONF
name|'CONF'
op|'='
name|'cfg'
op|'.'
name|'CONF'
newline|'\n'
name|'CONF'
op|'.'
name|'import_opt'
op|'('
string|"'compute_manager'"
op|','
string|"'nova.service'"
op|')'
newline|'\n'
name|'CONF'
op|'.'
name|'import_opt'
op|'('
string|"'host'"
op|','
string|"'nova.netconf'"
op|')'
newline|'\n'
name|'CONF'
op|'.'
name|'import_opt'
op|'('
string|"'live_migration_retry_count'"
op|','
string|"'nova.compute.manager'"
op|')'
newline|'\n'
name|'CONF'
op|'.'
name|'import_opt'
op|'('
string|"'default_ephemeral_format'"
op|','
string|"'nova.virt.driver'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|FAKE_IMAGE_REF
name|'FAKE_IMAGE_REF'
op|'='
string|"'fake-image-ref'"
newline|'\n'
nl|'\n'
DECL|variable|NODENAME
name|'NODENAME'
op|'='
string|"'fakenode1'"
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|get_primitive_instance_by_uuid
name|'def'
name|'get_primitive_instance_by_uuid'
op|'('
name|'context'
op|','
name|'instance_uuid'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Helper method to get an instance and then convert it to\n    a primitive form using jsonutils.\n    """'
newline|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'return'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|unify_instance
dedent|''
name|'def'
name|'unify_instance'
op|'('
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Return a dict-like instance for both object-initiated and\n    model-initiated sources that can reasonably be compared.\n    """'
newline|'\n'
name|'newdict'
op|'='
name|'dict'
op|'('
op|')'
newline|'\n'
name|'for'
name|'k'
op|','
name|'v'
name|'in'
name|'instance'
op|'.'
name|'iteritems'
op|'('
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'isinstance'
op|'('
name|'v'
op|','
name|'datetime'
op|'.'
name|'datetime'
op|')'
op|':'
newline|'\n'
comment|'# NOTE(danms): DB models and Instance objects have different'
nl|'\n'
comment|'# timezone expectations'
nl|'\n'
indent|'            '
name|'v'
op|'='
name|'v'
op|'.'
name|'replace'
op|'('
name|'tzinfo'
op|'='
name|'None'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'k'
op|'=='
string|"'fault'"
op|':'
newline|'\n'
comment|"# NOTE(danms): DB models don't have 'fault'"
nl|'\n'
indent|'            '
name|'continue'
newline|'\n'
dedent|''
name|'elif'
name|'k'
op|'=='
string|"'pci_devices'"
op|':'
newline|'\n'
comment|'# NOTE(yonlig.he) pci devices need lazy loading'
nl|'\n'
comment|'# fake db does not support it yet.'
nl|'\n'
indent|'            '
name|'continue'
newline|'\n'
dedent|''
name|'newdict'
op|'['
name|'k'
op|']'
op|'='
name|'v'
newline|'\n'
dedent|''
name|'return'
name|'newdict'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|FakeSchedulerAPI
dedent|''
name|'class'
name|'FakeSchedulerAPI'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|run_instance
indent|'    '
name|'def'
name|'run_instance'
op|'('
name|'self'
op|','
name|'ctxt'
op|','
name|'request_spec'
op|','
name|'admin_password'
op|','
nl|'\n'
name|'injected_files'
op|','
name|'requested_networks'
op|','
name|'is_first_time'
op|','
nl|'\n'
name|'filter_properties'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'pass'
newline|'\n'
nl|'\n'
DECL|member|live_migration
dedent|''
name|'def'
name|'live_migration'
op|'('
name|'self'
op|','
name|'ctxt'
op|','
name|'block_migration'
op|','
name|'disk_over_commit'
op|','
nl|'\n'
name|'instance'
op|','
name|'dest'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'pass'
newline|'\n'
nl|'\n'
DECL|member|prep_resize
dedent|''
name|'def'
name|'prep_resize'
op|'('
name|'self'
op|','
name|'ctxt'
op|','
name|'instance'
op|','
name|'instance_type'
op|','
name|'image'
op|','
name|'request_spec'
op|','
nl|'\n'
name|'filter_properties'
op|','
name|'reservations'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'pass'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|BaseTestCase
dedent|''
dedent|''
name|'class'
name|'BaseTestCase'
op|'('
name|'test'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'BaseTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'compute_driver'
op|'='
string|"'nova.virt.fake.FakeDriver'"
op|','
nl|'\n'
name|'network_manager'
op|'='
string|"'nova.network.manager.FlatManager'"
op|')'
newline|'\n'
name|'fake'
op|'.'
name|'set_nodes'
op|'('
op|'['
name|'NODENAME'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'use_local'
op|'='
name|'True'
op|','
name|'group'
op|'='
string|"'conductor'"
op|')'
newline|'\n'
nl|'\n'
name|'fake_notifier'
op|'.'
name|'stub_notifier'
op|'('
name|'self'
op|'.'
name|'stubs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'addCleanup'
op|'('
name|'fake_notifier'
op|'.'
name|'reset'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'='
name|'importutils'
op|'.'
name|'import_object'
op|'('
name|'CONF'
op|'.'
name|'compute_manager'
op|')'
newline|'\n'
nl|'\n'
comment|"# override tracker with a version that doesn't need the database:"
nl|'\n'
name|'fake_rt'
op|'='
name|'fake_resource_tracker'
op|'.'
name|'FakeResourceTracker'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
name|'NODENAME'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_resource_tracker_dict'
op|'['
name|'NODENAME'
op|']'
op|'='
name|'fake_rt'
newline|'\n'
nl|'\n'
DECL|function|fake_get_compute_nodes_in_db
name|'def'
name|'fake_get_compute_nodes_in_db'
op|'('
name|'context'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'fake_compute_nodes'
op|'='
op|'['
op|'{'
string|"'local_gb'"
op|':'
number|'259'
op|','
nl|'\n'
string|"'vcpus_used'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'deleted'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'hypervisor_type'"
op|':'
string|"'powervm'"
op|','
nl|'\n'
string|"'created_at'"
op|':'
string|"'2013-04-01T00:27:06.000000'"
op|','
nl|'\n'
string|"'local_gb_used'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'updated_at'"
op|':'
string|"'2013-04-03T00:35:41.000000'"
op|','
nl|'\n'
string|"'hypervisor_hostname'"
op|':'
string|"'fake_phyp1'"
op|','
nl|'\n'
string|"'memory_mb_used'"
op|':'
number|'512'
op|','
nl|'\n'
string|"'memory_mb'"
op|':'
number|'131072'
op|','
nl|'\n'
string|"'current_workload'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'vcpus'"
op|':'
number|'16'
op|','
nl|'\n'
string|"'cpu_info'"
op|':'
string|"'ppc64,powervm,3940'"
op|','
nl|'\n'
string|"'running_vms'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'free_disk_gb'"
op|':'
number|'259'
op|','
nl|'\n'
string|"'service_id'"
op|':'
number|'7'
op|','
nl|'\n'
string|"'hypervisor_version'"
op|':'
number|'7'
op|','
nl|'\n'
string|"'disk_available_least'"
op|':'
number|'265856'
op|','
nl|'\n'
string|"'deleted_at'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'free_ram_mb'"
op|':'
number|'130560'
op|','
nl|'\n'
string|"'id'"
op|':'
number|'2'
op|'}'
op|']'
newline|'\n'
name|'return'
name|'fake_compute_nodes'
newline|'\n'
nl|'\n'
DECL|function|fake_compute_node_delete
dedent|''
name|'def'
name|'fake_compute_node_delete'
op|'('
name|'context'
op|','
name|'compute_node'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'compute_node'
op|'.'
name|'get'
op|'('
string|"'hypervisor_hostname'"
op|')'
op|','
nl|'\n'
string|"'fake_phyp1'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_compute_nodes_in_db'"
op|','
nl|'\n'
name|'fake_get_compute_nodes_in_db'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
string|"'compute_node_delete'"
op|','
nl|'\n'
name|'fake_compute_node_delete'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'update_available_resource'
op|'('
nl|'\n'
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'user_id'
op|'='
string|"'fake'"
newline|'\n'
name|'self'
op|'.'
name|'project_id'
op|'='
string|"'fake'"
newline|'\n'
name|'self'
op|'.'
name|'context'
op|'='
name|'context'
op|'.'
name|'RequestContext'
op|'('
name|'self'
op|'.'
name|'user_id'
op|','
nl|'\n'
name|'self'
op|'.'
name|'project_id'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_show
name|'def'
name|'fake_show'
op|'('
name|'meh'
op|','
name|'context'
op|','
name|'id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'id'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'{'
string|"'id'"
op|':'
name|'id'
op|','
string|"'min_disk'"
op|':'
name|'None'
op|','
string|"'min_ram'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'fake_name'"
op|','
nl|'\n'
string|"'status'"
op|':'
string|"'active'"
op|','
nl|'\n'
string|"'properties'"
op|':'
op|'{'
string|"'kernel_id'"
op|':'
string|"'fake_kernel_id'"
op|','
nl|'\n'
string|"'ramdisk_id'"
op|':'
string|"'fake_ramdisk_id'"
op|','
nl|'\n'
string|"'something_else'"
op|':'
string|"'meow'"
op|'}'
op|'}'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'exception'
op|'.'
name|'ImageNotFound'
op|'('
name|'image_id'
op|'='
name|'id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'fake_image'
op|'.'
name|'stub_out_image_service'
op|'('
name|'self'
op|'.'
name|'stubs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'fake_show'
op|')'
newline|'\n'
nl|'\n'
name|'fake_rpcapi'
op|'='
name|'FakeSchedulerAPI'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'scheduler_rpcapi'"
op|','
name|'fake_rpcapi'
op|')'
newline|'\n'
name|'fake_network'
op|'.'
name|'set_stub_network_methods'
op|'('
name|'self'
op|'.'
name|'stubs'
op|')'
newline|'\n'
name|'fake_instance_actions'
op|'.'
name|'stub_out_action_events'
op|'('
name|'self'
op|'.'
name|'stubs'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_get_nw_info
name|'def'
name|'fake_get_nw_info'
op|'('
name|'cls'
op|','
name|'ctxt'
op|','
name|'instance'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'ctxt'
op|'.'
name|'is_admin'
op|')'
newline|'\n'
name|'return'
name|'fake_network'
op|'.'
name|'fake_get_instance_nw_info'
op|'('
name|'self'
op|'.'
name|'stubs'
op|','
number|'1'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'network_api'
op|'.'
name|'API'
op|','
string|"'get_instance_nw_info'"
op|','
nl|'\n'
name|'fake_get_nw_info'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'network_api'
op|'.'
name|'API'
op|','
string|"'allocate_for_instance'"
op|','
nl|'\n'
name|'fake_get_nw_info'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'='
name|'compute'
op|'.'
name|'API'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# Just to make long lines short'
nl|'\n'
name|'self'
op|'.'
name|'rt'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_resource_tracker'
op|'('
name|'NODENAME'
op|')'
newline|'\n'
nl|'\n'
DECL|member|tearDown
dedent|''
name|'def'
name|'tearDown'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'timeutils'
op|'.'
name|'clear_time_override'
op|'('
op|')'
newline|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'fake_image'
op|'.'
name|'FakeImageService_reset'
op|'('
op|')'
newline|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'ctxt'
op|')'
newline|'\n'
name|'for'
name|'instance'
name|'in'
name|'instances'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'ctxt'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'fake'
op|'.'
name|'restore_nodes'
op|'('
op|')'
newline|'\n'
name|'super'
op|'('
name|'BaseTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'tearDown'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|_create_fake_instance
dedent|''
name|'def'
name|'_create_fake_instance'
op|'('
name|'self'
op|','
name|'params'
op|'='
name|'None'
op|','
name|'type_name'
op|'='
string|"'m1.tiny'"
op|','
nl|'\n'
name|'services'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Create a test instance."""'
newline|'\n'
name|'if'
name|'not'
name|'params'
op|':'
newline|'\n'
indent|'            '
name|'params'
op|'='
op|'{'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|make_fake_sys_meta
dedent|''
name|'def'
name|'make_fake_sys_meta'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'sys_meta'
op|'='
name|'params'
op|'.'
name|'pop'
op|'('
string|'"system_metadata"'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
name|'inst_type'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
name|'type_name'
op|')'
newline|'\n'
name|'for'
name|'key'
name|'in'
name|'flavors'
op|'.'
name|'system_metadata_flavor_props'
op|':'
newline|'\n'
indent|'                '
name|'sys_meta'
op|'['
string|"'instance_type_%s'"
op|'%'
name|'key'
op|']'
op|'='
name|'inst_type'
op|'['
name|'key'
op|']'
newline|'\n'
dedent|''
name|'return'
name|'sys_meta'
newline|'\n'
nl|'\n'
dedent|''
name|'inst'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'inst'
op|'['
string|"'vm_state'"
op|']'
op|'='
name|'vm_states'
op|'.'
name|'ACTIVE'
newline|'\n'
name|'inst'
op|'['
string|"'task_state'"
op|']'
op|'='
name|'None'
newline|'\n'
name|'inst'
op|'['
string|"'image_ref'"
op|']'
op|'='
name|'FAKE_IMAGE_REF'
newline|'\n'
name|'inst'
op|'['
string|"'reservation_id'"
op|']'
op|'='
string|"'r-fakeres'"
newline|'\n'
name|'inst'
op|'['
string|"'user_id'"
op|']'
op|'='
name|'self'
op|'.'
name|'user_id'
newline|'\n'
name|'inst'
op|'['
string|"'project_id'"
op|']'
op|'='
name|'self'
op|'.'
name|'project_id'
newline|'\n'
name|'inst'
op|'['
string|"'host'"
op|']'
op|'='
string|"'fake_host'"
newline|'\n'
name|'inst'
op|'['
string|"'node'"
op|']'
op|'='
name|'NODENAME'
newline|'\n'
name|'type_id'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
name|'type_name'
op|')'
op|'['
string|"'id'"
op|']'
newline|'\n'
name|'inst'
op|'['
string|"'instance_type_id'"
op|']'
op|'='
name|'type_id'
newline|'\n'
name|'inst'
op|'['
string|"'ami_launch_index'"
op|']'
op|'='
number|'0'
newline|'\n'
name|'inst'
op|'['
string|"'memory_mb'"
op|']'
op|'='
number|'0'
newline|'\n'
name|'inst'
op|'['
string|"'vcpus'"
op|']'
op|'='
number|'0'
newline|'\n'
name|'inst'
op|'['
string|"'root_gb'"
op|']'
op|'='
number|'0'
newline|'\n'
name|'inst'
op|'['
string|"'ephemeral_gb'"
op|']'
op|'='
number|'0'
newline|'\n'
name|'inst'
op|'['
string|"'architecture'"
op|']'
op|'='
string|"'x86_64'"
newline|'\n'
name|'inst'
op|'['
string|"'os_type'"
op|']'
op|'='
string|"'Linux'"
newline|'\n'
name|'inst'
op|'['
string|"'system_metadata'"
op|']'
op|'='
name|'make_fake_sys_meta'
op|'('
op|')'
newline|'\n'
name|'inst'
op|'['
string|"'locked'"
op|']'
op|'='
name|'False'
newline|'\n'
name|'inst'
op|'['
string|"'created_at'"
op|']'
op|'='
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
newline|'\n'
name|'inst'
op|'['
string|"'updated_at'"
op|']'
op|'='
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
newline|'\n'
name|'inst'
op|'['
string|"'launched_at'"
op|']'
op|'='
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
newline|'\n'
name|'inst'
op|'['
string|"'security_groups'"
op|']'
op|'='
op|'['
op|']'
newline|'\n'
name|'inst'
op|'.'
name|'update'
op|'('
name|'params'
op|')'
newline|'\n'
name|'if'
name|'services'
op|':'
newline|'\n'
indent|'            '
name|'_create_service_entries'
op|'('
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|','
nl|'\n'
op|'{'
string|"'fake_zone'"
op|':'
op|'['
name|'inst'
op|'['
string|"'host'"
op|']'
op|']'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'db'
op|'.'
name|'instance_create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'inst'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_objectify
dedent|''
name|'def'
name|'_objectify'
op|'('
name|'self'
op|','
name|'db_inst'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'instance_obj'
op|'.'
name|'Instance'
op|'.'
name|'_from_db_object'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance_obj'
op|'.'
name|'Instance'
op|'('
op|')'
op|','
name|'db_inst'
op|','
nl|'\n'
name|'expected_attrs'
op|'='
name|'instance_obj'
op|'.'
name|'INSTANCE_DEFAULT_FIELDS'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_create_fake_instance_obj
dedent|''
name|'def'
name|'_create_fake_instance_obj'
op|'('
name|'self'
op|','
name|'params'
op|'='
name|'None'
op|','
name|'type_name'
op|'='
string|"'m1.tiny'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'db_inst'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|','
name|'type_name'
op|'='
name|'type_name'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'db_inst'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_create_instance_type
dedent|''
name|'def'
name|'_create_instance_type'
op|'('
name|'self'
op|','
name|'params'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Create a test instance type."""'
newline|'\n'
name|'if'
name|'not'
name|'params'
op|':'
newline|'\n'
indent|'            '
name|'params'
op|'='
op|'{'
op|'}'
newline|'\n'
nl|'\n'
dedent|''
name|'context'
op|'='
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
newline|'\n'
name|'inst'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'inst'
op|'['
string|"'name'"
op|']'
op|'='
string|"'m1.small'"
newline|'\n'
name|'inst'
op|'['
string|"'memory_mb'"
op|']'
op|'='
number|'1024'
newline|'\n'
name|'inst'
op|'['
string|"'vcpus'"
op|']'
op|'='
number|'1'
newline|'\n'
name|'inst'
op|'['
string|"'root_gb'"
op|']'
op|'='
number|'20'
newline|'\n'
name|'inst'
op|'['
string|"'ephemeral_gb'"
op|']'
op|'='
number|'10'
newline|'\n'
name|'inst'
op|'['
string|"'flavorid'"
op|']'
op|'='
string|"'1'"
newline|'\n'
name|'inst'
op|'['
string|"'swap'"
op|']'
op|'='
number|'2048'
newline|'\n'
name|'inst'
op|'['
string|"'rxtx_factor'"
op|']'
op|'='
number|'1'
newline|'\n'
name|'inst'
op|'.'
name|'update'
op|'('
name|'params'
op|')'
newline|'\n'
name|'return'
name|'db'
op|'.'
name|'flavor_create'
op|'('
name|'context'
op|','
name|'inst'
op|')'
op|'['
string|"'id'"
op|']'
newline|'\n'
nl|'\n'
DECL|member|_create_group
dedent|''
name|'def'
name|'_create_group'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'values'
op|'='
op|'{'
string|"'name'"
op|':'
string|"'testgroup'"
op|','
nl|'\n'
string|"'description'"
op|':'
string|"'testgroup'"
op|','
nl|'\n'
string|"'user_id'"
op|':'
name|'self'
op|'.'
name|'user_id'
op|','
nl|'\n'
string|"'project_id'"
op|':'
name|'self'
op|'.'
name|'project_id'
op|'}'
newline|'\n'
name|'return'
name|'db'
op|'.'
name|'security_group_create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'values'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_stub_migrate_server
dedent|''
name|'def'
name|'_stub_migrate_server'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|_fake_migrate_server
indent|'        '
name|'def'
name|'_fake_migrate_server'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'conductor_manager'
op|'.'
name|'ComputeTaskManager'
op|','
nl|'\n'
string|"'migrate_server'"
op|','
name|'_fake_migrate_server'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ComputeVolumeTestCase
dedent|''
dedent|''
name|'class'
name|'ComputeVolumeTestCase'
op|'('
name|'BaseTestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'ComputeVolumeTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'volume_id'
op|'='
string|"'fake'"
newline|'\n'
name|'self'
op|'.'
name|'fetched_attempts'
op|'='
number|'0'
newline|'\n'
name|'self'
op|'.'
name|'instance'
op|'='
op|'{'
nl|'\n'
string|"'id'"
op|':'
string|"'fake'"
op|','
nl|'\n'
string|"'uuid'"
op|':'
string|"'fake'"
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'fake'"
op|','
nl|'\n'
string|"'root_device_name'"
op|':'
string|"'/dev/vda'"
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'volume_api'
op|','
string|"'get'"
op|','
name|'lambda'
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|':'
nl|'\n'
op|'{'
string|"'id'"
op|':'
name|'self'
op|'.'
name|'volume_id'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'get_volume_connector'"
op|','
nl|'\n'
name|'lambda'
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|':'
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'volume_api'
op|','
string|"'initialize_connection'"
op|','
nl|'\n'
name|'lambda'
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|':'
op|'{'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'volume_api'
op|','
string|"'terminate_connection'"
op|','
nl|'\n'
name|'lambda'
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|':'
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'volume_api'
op|','
string|"'attach'"
op|','
nl|'\n'
name|'lambda'
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|':'
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'volume_api'
op|','
string|"'detach'"
op|','
nl|'\n'
name|'lambda'
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|':'
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'volume_api'
op|','
string|"'check_attach'"
op|','
nl|'\n'
name|'lambda'
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|':'
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|function|store_cinfo
name|'def'
name|'store_cinfo'
op|'('
name|'context'
op|','
op|'*'
name|'args'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'cinfo'
op|'='
name|'jsonutils'
op|'.'
name|'loads'
op|'('
name|'args'
op|'['
op|'-'
number|'1'
op|']'
op|'.'
name|'get'
op|'('
string|"'connection_info'"
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
nl|'\n'
string|"'block_device_mapping_update'"
op|','
nl|'\n'
name|'store_cinfo'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
nl|'\n'
string|"'block_device_mapping_update_or_create'"
op|','
nl|'\n'
name|'store_cinfo'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_attach_volume_serial
dedent|''
name|'def'
name|'test_attach_volume_serial'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|fake_get_volume_encryption_metadata
indent|'        '
name|'def'
name|'fake_get_volume_encryption_metadata'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
op|'}'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'get_volume_encryption_metadata'"
op|','
nl|'\n'
name|'fake_get_volume_encryption_metadata'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'attach_volume'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'volume_id'
op|','
nl|'\n'
string|"'/dev/vdb'"
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'cinfo'
op|'.'
name|'get'
op|'('
string|"'serial'"
op|')'
op|','
name|'self'
op|'.'
name|'volume_id'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_await_block_device_created_to_slow
dedent|''
name|'def'
name|'test_await_block_device_created_to_slow'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|function|never_get
indent|'        '
name|'def'
name|'never_get'
op|'('
name|'context'
op|','
name|'vol_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
nl|'\n'
string|"'status'"
op|':'
string|"'creating'"
op|','
nl|'\n'
string|"'id'"
op|':'
string|"'blah'"
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'volume_api'
op|','
string|"'get'"
op|','
name|'never_get'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'VolumeNotCreated'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_await_block_device_map_created'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
string|"'1'"
op|','
name|'max_tries'
op|'='
number|'2'
op|','
name|'wait_between'
op|'='
number|'0.1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_await_block_device_created_slow
dedent|''
name|'def'
name|'test_await_block_device_created_slow'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'c'
op|'='
name|'self'
op|'.'
name|'compute'
newline|'\n'
nl|'\n'
DECL|function|slow_get
name|'def'
name|'slow_get'
op|'('
name|'context'
op|','
name|'vol_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'while'
name|'self'
op|'.'
name|'fetched_attempts'
op|'<'
number|'2'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'fetched_attempts'
op|'+='
number|'1'
newline|'\n'
name|'return'
op|'{'
nl|'\n'
string|"'status'"
op|':'
string|"'creating'"
op|','
nl|'\n'
string|"'id'"
op|':'
string|"'blah'"
op|','
nl|'\n'
op|'}'
newline|'\n'
dedent|''
name|'return'
op|'{'
nl|'\n'
string|"'status'"
op|':'
string|"'available'"
op|','
nl|'\n'
string|"'id'"
op|':'
string|"'blah'"
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'c'
op|'.'
name|'volume_api'
op|','
string|"'get'"
op|','
name|'slow_get'
op|')'
newline|'\n'
name|'attempts'
op|'='
name|'c'
op|'.'
name|'_await_block_device_map_created'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'1'"
op|','
nl|'\n'
name|'max_tries'
op|'='
number|'4'
op|','
nl|'\n'
name|'wait_between'
op|'='
number|'0.1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'attempts'
op|','
number|'3'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_boot_volume_serial
dedent|''
name|'def'
name|'test_boot_volume_serial'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'block_device_mapping'
op|'='
op|'['
nl|'\n'
name|'block_device'
op|'.'
name|'BlockDeviceDict'
op|'('
op|'{'
nl|'\n'
string|"'id'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'no_device'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'volume_id'"
op|':'
name|'self'
op|'.'
name|'volume_id'
op|','
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/vdb'"
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|','
nl|'\n'
op|'}'
op|')'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_prep_block_device'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'instance'
op|','
nl|'\n'
name|'block_device_mapping'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'cinfo'
op|'.'
name|'get'
op|'('
string|"'serial'"
op|')'
op|','
name|'self'
op|'.'
name|'volume_id'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_boot_volume_metadata
dedent|''
name|'def'
name|'test_boot_volume_metadata'
op|'('
name|'self'
op|','
name|'metadata'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
DECL|function|volume_api_get
indent|'        '
name|'def'
name|'volume_api_get'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'metadata'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'{'
nl|'\n'
string|"'volume_image_metadata'"
op|':'
op|'{'
string|"'vol_test_key'"
op|':'
string|"'vol_test_value'"
op|'}'
nl|'\n'
op|'}'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'{'
op|'}'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'volume_api'
op|','
string|"'get'"
op|','
name|'volume_api_get'
op|')'
newline|'\n'
nl|'\n'
name|'block_device_mapping'
op|'='
op|'['
op|'{'
nl|'\n'
string|"'id'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'device_name'"
op|':'
string|"'vda'"
op|','
nl|'\n'
string|"'no_device'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'virtual_name'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'volume_id'"
op|':'
name|'self'
op|'.'
name|'volume_id'
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|','
nl|'\n'
op|'}'
op|']'
newline|'\n'
nl|'\n'
name|'image_meta'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_get_bdm_image_metadata'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'block_device_mapping'
op|')'
newline|'\n'
name|'if'
name|'metadata'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_meta'
op|'['
string|"'vol_test_key'"
op|']'
op|','
string|"'vol_test_value'"
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_meta'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# Test it with new-style BDMs'
nl|'\n'
dedent|''
name|'block_device_mapping'
op|'='
op|'['
op|'{'
nl|'\n'
string|"'boot_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'volume_id'"
op|':'
name|'self'
op|'.'
name|'volume_id'
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|','
nl|'\n'
op|'}'
op|']'
newline|'\n'
nl|'\n'
name|'image_meta'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_get_bdm_image_metadata'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'block_device_mapping'
op|','
name|'legacy_bdm'
op|'='
name|'False'
op|')'
newline|'\n'
name|'if'
name|'metadata'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_meta'
op|'['
string|"'vol_test_key'"
op|']'
op|','
string|"'vol_test_value'"
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_meta'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_boot_volume_no_metadata
dedent|''
dedent|''
name|'def'
name|'test_boot_volume_no_metadata'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'test_boot_volume_metadata'
op|'('
name|'metadata'
op|'='
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_boot_image_metadata
dedent|''
name|'def'
name|'test_boot_image_metadata'
op|'('
name|'self'
op|','
name|'metadata'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
DECL|function|image_api_show
indent|'        '
name|'def'
name|'image_api_show'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'metadata'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'{'
nl|'\n'
string|"'properties'"
op|':'
op|'{'
string|"'img_test_key'"
op|':'
string|"'img_test_value'"
op|'}'
nl|'\n'
op|'}'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'{'
op|'}'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'image_service'
op|','
string|"'show'"
op|','
name|'image_api_show'
op|')'
newline|'\n'
nl|'\n'
name|'block_device_mapping'
op|'='
op|'['
op|'{'
nl|'\n'
string|"'boot_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'image'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'local'"
op|','
nl|'\n'
string|"'image_id'"
op|':'
string|'"fake-image"'
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'True'
op|','
nl|'\n'
op|'}'
op|']'
newline|'\n'
nl|'\n'
name|'image_meta'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_get_bdm_image_metadata'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'block_device_mapping'
op|','
name|'legacy_bdm'
op|'='
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'metadata'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_meta'
op|'['
string|"'img_test_key'"
op|']'
op|','
string|"'img_test_value'"
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_meta'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_boot_image_no_metadata
dedent|''
dedent|''
name|'def'
name|'test_boot_image_no_metadata'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'test_boot_image_metadata'
op|'('
name|'metadata'
op|'='
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_poll_volume_usage_disabled
dedent|''
name|'def'
name|'test_poll_volume_usage_disabled'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ctxt'
op|'='
string|"'MockContext'"
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_host_volume_bdms'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'utils'
op|','
string|"'last_completed_audit_period'"
op|')'
newline|'\n'
comment|'# None of the mocks should be called.'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'CONF'
op|'.'
name|'volume_usage_poll_interval'
op|'='
number|'0'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_poll_volume_usage'
op|'('
name|'ctxt'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'UnsetStubs'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_poll_volume_usage_interval_not_elapsed
dedent|''
name|'def'
name|'test_poll_volume_usage_interval_not_elapsed'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ctxt'
op|'='
string|"'MockContext'"
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_host_volume_bdms'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'utils'
op|','
string|"'last_completed_audit_period'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'get_all_volume_usage'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'time'
op|','
string|"'time'"
op|')'
newline|'\n'
comment|'# Following methods will be called.'
nl|'\n'
name|'utils'
op|'.'
name|'last_completed_audit_period'
op|'('
op|')'
op|'.'
name|'AndReturn'
op|'('
op|'('
number|'0'
op|','
number|'0'
op|')'
op|')'
newline|'\n'
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'.'
name|'AndReturn'
op|'('
number|'10'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'CONF'
op|'.'
name|'volume_usage_poll_interval'
op|'='
number|'2'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_last_vol_usage_poll'
op|'='
number|'9'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_poll_volume_usage'
op|'('
name|'ctxt'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'UnsetStubs'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_poll_volume_usage_returns_no_vols
dedent|''
name|'def'
name|'test_poll_volume_usage_returns_no_vols'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ctxt'
op|'='
string|"'MockContext'"
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|'='
string|"'MockHost'"
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_host_volume_bdms'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'utils'
op|','
string|"'last_completed_audit_period'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'get_all_volume_usage'"
op|')'
newline|'\n'
comment|'# Following methods are called.'
nl|'\n'
name|'utils'
op|'.'
name|'last_completed_audit_period'
op|'('
op|')'
op|'.'
name|'AndReturn'
op|'('
op|'('
number|'0'
op|','
number|'0'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_host_volume_bdms'
op|'('
name|'ctxt'
op|','
string|"'MockHost'"
op|')'
op|'.'
name|'AndReturn'
op|'('
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'CONF'
op|'.'
name|'volume_usage_poll_interval'
op|'='
number|'10'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_last_vol_usage_poll'
op|'='
number|'0'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_poll_volume_usage'
op|'('
name|'ctxt'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'UnsetStubs'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_poll_volume_usage_with_data
dedent|''
name|'def'
name|'test_poll_volume_usage_with_data'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ctxt'
op|'='
string|"'MockContext'"
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|'='
string|"'MockHost'"
newline|'\n'
name|'curr_time'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'utils'
op|','
string|"'last_completed_audit_period'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_host_volume_bdms'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_update_volume_usage_cache'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'get_all_volume_usage'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|','
name|'y'
op|':'
op|'['
number|'3'
op|','
number|'4'
op|']'
op|')'
newline|'\n'
comment|'# All the mocks are called'
nl|'\n'
name|'utils'
op|'.'
name|'last_completed_audit_period'
op|'('
op|')'
op|'.'
name|'AndReturn'
op|'('
op|'('
number|'10'
op|','
number|'20'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_host_volume_bdms'
op|'('
name|'ctxt'
op|','
string|"'MockHost'"
op|')'
op|'.'
name|'AndReturn'
op|'('
op|'['
number|'1'
op|','
number|'2'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_update_volume_usage_cache'
op|'('
name|'ctxt'
op|','
op|'['
number|'3'
op|','
number|'4'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'CONF'
op|'.'
name|'volume_usage_poll_interval'
op|'='
number|'10'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_last_vol_usage_poll'
op|'='
number|'0'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_poll_volume_usage'
op|'('
name|'ctxt'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
op|'('
name|'curr_time'
op|'<'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_last_vol_usage_poll'
op|')'
op|','
nl|'\n'
string|'"_last_vol_usage_poll was not properly updated <%s>"'
op|'%'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_last_vol_usage_poll'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'UnsetStubs'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_detach_volume_usage
dedent|''
name|'def'
name|'test_detach_volume_usage'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test that detach volume update the volume usage cache table correctly'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'bdm'
op|'='
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/vdb'"
op|','
nl|'\n'
string|"'connection_info'"
op|':'
string|"'{}'"
op|','
nl|'\n'
string|"'instance_uuid'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
string|"'volume_id'"
op|':'
number|'1'
op|'}'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_instance_volume_bdm'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'block_stats'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_host_volume_bdms'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'get_all_volume_usage'"
op|')'
newline|'\n'
nl|'\n'
comment|'# The following methods will be called'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instance_volume_bdm'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
number|'1'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'bdm'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'block_stats'
op|'('
name|'instance'
op|'['
string|"'name'"
op|']'
op|','
string|"'vdb'"
op|')'
op|'.'
name|'AndReturn'
op|'('
op|'['
number|'1L'
op|','
number|'30L'
op|','
number|'1L'
op|','
number|'20L'
op|','
name|'None'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_host_volume_bdms'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'fake-mini'"
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'bdm'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'get_all_volume_usage'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'bdm'
op|')'
op|'.'
name|'AndReturn'
op|'('
op|'['
op|'{'
string|"'volume'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'rd_req'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'rd_bytes'"
op|':'
number|'10'
op|','
nl|'\n'
string|"'wr_req'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'wr_bytes'"
op|':'
number|'5'
op|','
nl|'\n'
string|"'instance'"
op|':'
name|'instance'
op|'}'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_get_volume_encryption_metadata
name|'def'
name|'fake_get_volume_encryption_metadata'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
op|'}'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'get_volume_encryption_metadata'"
op|','
nl|'\n'
name|'fake_get_volume_encryption_metadata'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'attach_volume'
op|'('
name|'self'
op|'.'
name|'context'
op|','
number|'1'
op|','
string|"'/dev/vdb'"
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
comment|'# Poll volume usage & then detach the volume. This will update the'
nl|'\n'
comment|'# total fields in the volume usage cache.'
nl|'\n'
name|'CONF'
op|'.'
name|'volume_usage_poll_interval'
op|'='
number|'10'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_poll_volume_usage'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
comment|'# Check that a volume.usage and volume.attach notification was sent'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'detach_volume'
op|'('
name|'self'
op|'.'
name|'context'
op|','
number|'1'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
comment|'# Check that volume.attach, 2 volume.usage, and volume.detach'
nl|'\n'
comment|'# notifications were sent'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'4'
op|','
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'compute.instance.volume.attach'"
op|','
name|'msg'
op|'.'
name|'event_type'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'2'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'volume.usage'"
op|','
name|'msg'
op|'.'
name|'event_type'
op|')'
newline|'\n'
name|'payload'
op|'='
name|'msg'
op|'.'
name|'payload'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'payload'
op|'['
string|"'instance_id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'fake'"
op|','
name|'payload'
op|'['
string|"'user_id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'fake'"
op|','
name|'payload'
op|'['
string|"'tenant_id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'payload'
op|'['
string|"'reads'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'30'
op|','
name|'payload'
op|'['
string|"'read_bytes'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'payload'
op|'['
string|"'writes'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'20'
op|','
name|'payload'
op|'['
string|"'write_bytes'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'payload'
op|'['
string|"'availability_zone'"
op|']'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'3'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'compute.instance.volume.detach'"
op|','
name|'msg'
op|'.'
name|'event_type'
op|')'
newline|'\n'
nl|'\n'
comment|'# Check the database for the'
nl|'\n'
name|'volume_usages'
op|'='
name|'db'
op|'.'
name|'vol_get_usage_by_time'
op|'('
name|'self'
op|'.'
name|'context'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'len'
op|'('
name|'volume_usages'
op|')'
op|')'
newline|'\n'
name|'volume_usage'
op|'='
name|'volume_usages'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'volume_usage'
op|'['
string|"'curr_reads'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'volume_usage'
op|'['
string|"'curr_read_bytes'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'volume_usage'
op|'['
string|"'curr_writes'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'volume_usage'
op|'['
string|"'curr_write_bytes'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'volume_usage'
op|'['
string|"'tot_reads'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'30'
op|','
name|'volume_usage'
op|'['
string|"'tot_read_bytes'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'volume_usage'
op|'['
string|"'tot_writes'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'20'
op|','
name|'volume_usage'
op|'['
string|"'tot_write_bytes'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_prepare_image_mapping
dedent|''
name|'def'
name|'test_prepare_image_mapping'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'swap_size'
op|'='
number|'1'
newline|'\n'
name|'ephemeral_size'
op|'='
number|'1'
newline|'\n'
name|'instance_type'
op|'='
op|'{'
string|"'swap'"
op|':'
name|'swap_size'
op|','
nl|'\n'
string|"'ephemeral_gb'"
op|':'
name|'ephemeral_size'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'mappings'
op|'='
op|'['
nl|'\n'
op|'{'
string|"'virtual'"
op|':'
string|"'ami'"
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'virtual'"
op|':'
string|"'root'"
op|','
string|"'device'"
op|':'
string|"'/dev/sda1'"
op|'}'
op|','
nl|'\n'
nl|'\n'
op|'{'
string|"'virtual'"
op|':'
string|"'swap'"
op|','
string|"'device'"
op|':'
string|"'sdb4'"
op|'}'
op|','
nl|'\n'
nl|'\n'
op|'{'
string|"'virtual'"
op|':'
string|"'ephemeral0'"
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'virtual'"
op|':'
string|"'ephemeral1'"
op|','
string|"'device'"
op|':'
string|"'sdc2'"
op|'}'
op|','
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
name|'preped_bdm'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_prepare_image_mapping'
op|'('
nl|'\n'
name|'instance_type'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'mappings'
op|')'
newline|'\n'
nl|'\n'
name|'expected_result'
op|'='
op|'['
nl|'\n'
op|'{'
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/sdb4'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'blank'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'local'"
op|','
nl|'\n'
string|"'device_type'"
op|':'
string|"'disk'"
op|','
nl|'\n'
string|"'guest_format'"
op|':'
string|"'swap'"
op|','
nl|'\n'
string|"'boot_index'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'volume_size'"
op|':'
name|'swap_size'
nl|'\n'
op|'}'
op|','
nl|'\n'
op|'{'
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/sdc1'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'blank'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'local'"
op|','
nl|'\n'
string|"'device_type'"
op|':'
string|"'disk'"
op|','
nl|'\n'
string|"'guest_format'"
op|':'
name|'CONF'
op|'.'
name|'default_ephemeral_format'
op|','
nl|'\n'
string|"'boot_index'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'volume_size'"
op|':'
name|'ephemeral_size'
nl|'\n'
op|'}'
op|','
nl|'\n'
op|'{'
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/sdc2'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'blank'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'local'"
op|','
nl|'\n'
string|"'device_type'"
op|':'
string|"'disk'"
op|','
nl|'\n'
string|"'guest_format'"
op|':'
name|'CONF'
op|'.'
name|'default_ephemeral_format'
op|','
nl|'\n'
string|"'boot_index'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'volume_size'"
op|':'
name|'ephemeral_size'
nl|'\n'
op|'}'
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
name|'for'
name|'expected'
op|','
name|'got'
name|'in'
name|'zip'
op|'('
name|'expected_result'
op|','
name|'preped_bdm'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertThat'
op|'('
name|'expected'
op|','
name|'matchers'
op|'.'
name|'IsSubDictOf'
op|'('
name|'got'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_validate_bdm
dedent|''
dedent|''
name|'def'
name|'test_validate_bdm'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|fake_get
indent|'        '
name|'def'
name|'fake_get'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'res_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'id'"
op|':'
name|'res_id'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_check_attach
dedent|''
name|'def'
name|'fake_check_attach'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'get'"
op|','
name|'fake_get'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'get_snapshot'"
op|','
name|'fake_get'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'check_attach'"
op|','
nl|'\n'
name|'fake_check_attach'
op|')'
newline|'\n'
nl|'\n'
name|'volume_id'
op|'='
string|"'55555555-aaaa-bbbb-cccc-555555555555'"
newline|'\n'
name|'snapshot_id'
op|'='
string|"'66666666-aaaa-bbbb-cccc-555555555555'"
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'instance_type'
op|'='
op|'{'
string|"'swap'"
op|':'
number|'1'
op|','
string|"'ephemeral_gb'"
op|':'
number|'2'
op|'}'
newline|'\n'
name|'mappings'
op|'='
op|'['
nl|'\n'
op|'{'
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/sdb4'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'blank'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'local'"
op|','
nl|'\n'
string|"'device_type'"
op|':'
string|"'disk'"
op|','
nl|'\n'
string|"'guest_format'"
op|':'
string|"'swap'"
op|','
nl|'\n'
string|"'boot_index'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'volume_size'"
op|':'
number|'1'
nl|'\n'
op|'}'
op|','
nl|'\n'
op|'{'
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/sda1'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'device_type'"
op|':'
string|"'disk'"
op|','
nl|'\n'
string|"'volume_id'"
op|':'
name|'volume_id'
op|','
nl|'\n'
string|"'guest_format'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'boot_index'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'volume_size'"
op|':'
number|'6'
nl|'\n'
op|'}'
op|','
nl|'\n'
op|'{'
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/sda2'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
name|'snapshot_id'
op|','
nl|'\n'
string|"'device_type'"
op|':'
string|"'disk'"
op|','
nl|'\n'
string|"'guest_format'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'boot_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'volume_size'"
op|':'
number|'4'
nl|'\n'
op|'}'
op|','
nl|'\n'
op|'{'
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/sda3'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'image'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'local'"
op|','
nl|'\n'
string|"'device_type'"
op|':'
string|"'disk'"
op|','
nl|'\n'
string|"'guest_format'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'boot_index'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'volume_size'"
op|':'
number|'1'
nl|'\n'
op|'}'
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
comment|'# Make sure it passes at first'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_validate_bdm'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|','
name|'mappings'
op|')'
newline|'\n'
nl|'\n'
comment|'# Boot sequence'
nl|'\n'
name|'mappings'
op|'['
number|'2'
op|']'
op|'['
string|"'boot_index'"
op|']'
op|'='
number|'2'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InvalidBDMBootSequence'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_validate_bdm'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
name|'instance_type'
op|','
nl|'\n'
name|'mappings'
op|')'
newline|'\n'
name|'mappings'
op|'['
number|'2'
op|']'
op|'['
string|"'boot_index'"
op|']'
op|'='
number|'0'
newline|'\n'
nl|'\n'
comment|'# number of local block_devices'
nl|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'max_local_block_devices'
op|'='
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InvalidBDMLocalsLimit'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_validate_bdm'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
name|'instance_type'
op|','
nl|'\n'
name|'mappings'
op|')'
newline|'\n'
name|'ephemerals'
op|'='
op|'['
nl|'\n'
op|'{'
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/vdb'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'blank'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'local'"
op|','
nl|'\n'
string|"'device_type'"
op|':'
string|"'disk'"
op|','
nl|'\n'
string|"'volume_id'"
op|':'
name|'volume_id'
op|','
nl|'\n'
string|"'guest_format'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'boot_index'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'volume_size'"
op|':'
number|'1'
nl|'\n'
op|'}'
op|','
nl|'\n'
op|'{'
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/vdc'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'blank'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'local'"
op|','
nl|'\n'
string|"'device_type'"
op|':'
string|"'disk'"
op|','
nl|'\n'
string|"'volume_id'"
op|':'
name|'volume_id'
op|','
nl|'\n'
string|"'guest_format'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'boot_index'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'volume_size'"
op|':'
number|'1'
nl|'\n'
op|'}'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'max_local_block_devices'
op|'='
number|'4'
op|')'
newline|'\n'
comment|'# More ephemerals are OK as long as they are not over the size limit'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_validate_bdm'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|','
name|'mappings'
op|'+'
name|'ephemerals'
op|')'
newline|'\n'
nl|'\n'
comment|'# Ephemerals over the size limit'
nl|'\n'
name|'ephemerals'
op|'['
number|'0'
op|']'
op|'['
string|"'volume_size'"
op|']'
op|'='
number|'3'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InvalidBDMEphemeralSize'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_validate_bdm'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
name|'instance_type'
op|','
nl|'\n'
name|'mappings'
op|'+'
name|'ephemerals'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InvalidBDMEphemeralSize'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_validate_bdm'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
name|'instance_type'
op|','
nl|'\n'
name|'mappings'
op|'+'
op|'['
name|'ephemerals'
op|'['
number|'0'
op|']'
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# Swap over the size limit'
nl|'\n'
name|'mappings'
op|'['
number|'0'
op|']'
op|'['
string|"'volume_size'"
op|']'
op|'='
number|'3'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InvalidBDMSwapSize'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_validate_bdm'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
name|'instance_type'
op|','
nl|'\n'
name|'mappings'
op|')'
newline|'\n'
name|'mappings'
op|'['
number|'0'
op|']'
op|'['
string|"'volume_size'"
op|']'
op|'='
number|'1'
newline|'\n'
nl|'\n'
name|'additional_swap'
op|'='
op|'['
nl|'\n'
op|'{'
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/vdb'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'blank'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'local'"
op|','
nl|'\n'
string|"'device_type'"
op|':'
string|"'disk'"
op|','
nl|'\n'
string|"'guest_format'"
op|':'
string|"'swap'"
op|','
nl|'\n'
string|"'boot_index'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'volume_size'"
op|':'
number|'1'
nl|'\n'
op|'}'
op|']'
newline|'\n'
nl|'\n'
comment|'# More than one swap'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InvalidBDMFormat'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_validate_bdm'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
name|'instance_type'
op|','
nl|'\n'
name|'mappings'
op|'+'
name|'additional_swap'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_validate_bdm_media_service_exceptions
dedent|''
name|'def'
name|'test_validate_bdm_media_service_exceptions'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance_type'
op|'='
op|'{'
string|"'swap'"
op|':'
number|'1'
op|','
string|"'ephemeral_gb'"
op|':'
number|'1'
op|'}'
newline|'\n'
name|'all_mappings'
op|'='
op|'['
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'no_device'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'volume_id'"
op|':'
name|'self'
op|'.'
name|'volume_id'
op|','
nl|'\n'
string|"'device_name'"
op|':'
string|"'vda'"
op|','
nl|'\n'
string|"'boot_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|'}'
op|']'
newline|'\n'
nl|'\n'
comment|"# Check that the volume status is 'available' and reject if not"
nl|'\n'
DECL|function|fake_volume_get_1
name|'def'
name|'fake_volume_get_1'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'id'"
op|':'
name|'volume_id'
op|','
nl|'\n'
string|"'status'"
op|':'
string|"'creating'"
op|','
nl|'\n'
string|"'attach_status'"
op|':'
string|"'detached'"
op|'}'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'get'"
op|','
name|'fake_volume_get_1'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InvalidBDMVolume'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_validate_bdm'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|','
name|'all_mappings'
op|')'
newline|'\n'
nl|'\n'
comment|"# Check that the volume attach_status is 'detached' and reject if not"
nl|'\n'
DECL|function|fake_volume_get_2
name|'def'
name|'fake_volume_get_2'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'id'"
op|':'
name|'volume_id'
op|','
nl|'\n'
string|"'status'"
op|':'
string|"'available'"
op|','
nl|'\n'
string|"'attach_status'"
op|':'
string|"'attached'"
op|'}'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'get'"
op|','
name|'fake_volume_get_2'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InvalidBDMVolume'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_validate_bdm'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|','
name|'all_mappings'
op|')'
newline|'\n'
nl|'\n'
comment|"# Check that the volume status is 'available' and attach_status is"
nl|'\n'
comment|"# 'detached' and accept the request if so"
nl|'\n'
DECL|function|fake_volume_get_3
name|'def'
name|'fake_volume_get_3'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'id'"
op|':'
name|'volume_id'
op|','
nl|'\n'
string|"'status'"
op|':'
string|"'available'"
op|','
nl|'\n'
string|"'attach_status'"
op|':'
string|"'detached'"
op|'}'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'get'"
op|','
name|'fake_volume_get_3'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_validate_bdm'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|','
name|'all_mappings'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_volume_snapshot_create
dedent|''
name|'def'
name|'test_volume_snapshot_create'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'rpc_common'
op|'.'
name|'ClientException'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'volume_snapshot_create'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|','
string|"'fake_id'"
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'='
name|'utils'
op|'.'
name|'ExceptionHelper'
op|'('
name|'self'
op|'.'
name|'compute'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'NotImplementedError'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'volume_snapshot_create'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|','
string|"'fake_id'"
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_volume_snapshot_delete
dedent|''
name|'def'
name|'test_volume_snapshot_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'rpc_common'
op|'.'
name|'ClientException'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'volume_snapshot_delete'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|','
string|"'fake_id'"
op|','
string|"'fake_id2'"
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'='
name|'utils'
op|'.'
name|'ExceptionHelper'
op|'('
name|'self'
op|'.'
name|'compute'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'NotImplementedError'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'volume_snapshot_delete'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|','
string|"'fake_id'"
op|','
string|"'fake_id2'"
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ComputeTestCase
dedent|''
dedent|''
name|'class'
name|'ComputeTestCase'
op|'('
name|'BaseTestCase'
op|')'
op|':'
newline|'\n'
DECL|member|test_wrap_instance_fault
indent|'    '
name|'def'
name|'test_wrap_instance_fault'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'inst'
op|'='
op|'{'
string|'"uuid"'
op|':'
string|'"fake_uuid"'
op|'}'
newline|'\n'
nl|'\n'
name|'called'
op|'='
op|'{'
string|"'fault_added'"
op|':'
name|'False'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|did_it_add_fault
name|'def'
name|'did_it_add_fault'
op|'('
op|'*'
name|'args'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fault_added'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'compute_utils'
op|','
string|"'add_instance_fault_from_exc'"
op|','
nl|'\n'
name|'did_it_add_fault'
op|')'
newline|'\n'
nl|'\n'
op|'@'
name|'compute_manager'
op|'.'
name|'wrap_instance_fault'
newline|'\n'
DECL|function|failer
name|'def'
name|'failer'
op|'('
name|'self2'
op|','
name|'context'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'NotImplementedError'
op|','
name|'failer'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'inst'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'['
string|"'fault_added'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_wrap_instance_fault_instance_in_args
dedent|''
name|'def'
name|'test_wrap_instance_fault_instance_in_args'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'inst'
op|'='
op|'{'
string|'"uuid"'
op|':'
string|'"fake_uuid"'
op|'}'
newline|'\n'
nl|'\n'
name|'called'
op|'='
op|'{'
string|"'fault_added'"
op|':'
name|'False'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|did_it_add_fault
name|'def'
name|'did_it_add_fault'
op|'('
op|'*'
name|'args'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fault_added'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'compute_utils'
op|','
string|"'add_instance_fault_from_exc'"
op|','
nl|'\n'
name|'did_it_add_fault'
op|')'
newline|'\n'
nl|'\n'
op|'@'
name|'compute_manager'
op|'.'
name|'wrap_instance_fault'
newline|'\n'
DECL|function|failer
name|'def'
name|'failer'
op|'('
name|'self2'
op|','
name|'context'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'NotImplementedError'
op|','
name|'failer'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'inst'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'['
string|"'fault_added'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_wrap_instance_fault_no_instance
dedent|''
name|'def'
name|'test_wrap_instance_fault_no_instance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'inst_uuid'
op|'='
string|'"fake_uuid"'
newline|'\n'
nl|'\n'
name|'called'
op|'='
op|'{'
string|"'fault_added'"
op|':'
name|'False'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|did_it_add_fault
name|'def'
name|'did_it_add_fault'
op|'('
op|'*'
name|'args'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fault_added'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'compute_utils'
op|','
string|"'add_instance_fault_from_exc'"
op|','
nl|'\n'
name|'did_it_add_fault'
op|')'
newline|'\n'
nl|'\n'
op|'@'
name|'compute_manager'
op|'.'
name|'wrap_instance_fault'
newline|'\n'
DECL|function|failer
name|'def'
name|'failer'
op|'('
name|'self2'
op|','
name|'context'
op|','
name|'instance_uuid'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance_uuid'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceNotFound'
op|','
name|'failer'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'inst_uuid'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'called'
op|'['
string|"'fault_added'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_wrap_instance_event
dedent|''
name|'def'
name|'test_wrap_instance_event'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'inst'
op|'='
op|'{'
string|'"uuid"'
op|':'
string|'"fake_uuid"'
op|'}'
newline|'\n'
nl|'\n'
name|'called'
op|'='
op|'{'
string|"'started'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'finished'"
op|':'
name|'False'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|did_it_update_start
name|'def'
name|'did_it_update_start'
op|'('
name|'self2'
op|','
name|'context'
op|','
name|'values'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'started'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
DECL|function|did_it_update_finish
dedent|''
name|'def'
name|'did_it_update_finish'
op|'('
name|'self2'
op|','
name|'context'
op|','
name|'values'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'finished'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'conductor_manager'
op|'.'
name|'ConductorManager'
op|','
nl|'\n'
string|"'action_event_start'"
op|','
name|'did_it_update_start'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'conductor_manager'
op|'.'
name|'ConductorManager'
op|','
nl|'\n'
string|"'action_event_finish'"
op|','
name|'did_it_update_finish'
op|')'
newline|'\n'
nl|'\n'
op|'@'
name|'compute_manager'
op|'.'
name|'wrap_instance_event'
newline|'\n'
DECL|function|fake_event
name|'def'
name|'fake_event'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'fake_event'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'inst'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'['
string|"'started'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'['
string|"'finished'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_wrap_instance_event_log_exception
dedent|''
name|'def'
name|'test_wrap_instance_event_log_exception'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'inst'
op|'='
op|'{'
string|'"uuid"'
op|':'
string|'"fake_uuid"'
op|'}'
newline|'\n'
nl|'\n'
name|'called'
op|'='
op|'{'
string|"'started'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'finished'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'message'"
op|':'
string|"''"
op|'}'
newline|'\n'
nl|'\n'
DECL|function|did_it_update_start
name|'def'
name|'did_it_update_start'
op|'('
name|'self2'
op|','
name|'context'
op|','
name|'values'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'started'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
DECL|function|did_it_update_finish
dedent|''
name|'def'
name|'did_it_update_finish'
op|'('
name|'self2'
op|','
name|'context'
op|','
name|'values'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'finished'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'called'
op|'['
string|"'message'"
op|']'
op|'='
name|'values'
op|'['
string|"'message'"
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'conductor_manager'
op|'.'
name|'ConductorManager'
op|','
nl|'\n'
string|"'action_event_start'"
op|','
name|'did_it_update_start'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'conductor_manager'
op|'.'
name|'ConductorManager'
op|','
nl|'\n'
string|"'action_event_finish'"
op|','
name|'did_it_update_finish'
op|')'
newline|'\n'
nl|'\n'
op|'@'
name|'compute_manager'
op|'.'
name|'wrap_instance_event'
newline|'\n'
DECL|function|fake_event
name|'def'
name|'fake_event'
op|'('
name|'self2'
op|','
name|'context'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NovaException'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'NovaException'
op|','
name|'fake_event'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'inst'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'['
string|"'started'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'['
string|"'finished'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'An unknown exception occurred.'"
op|','
name|'called'
op|'['
string|"'message'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_compat
dedent|''
name|'def'
name|'test_object_compat'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'db_inst'
op|'='
name|'fake_instance'
op|'.'
name|'fake_db_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
op|'@'
name|'compute_manager'
op|'.'
name|'object_compat'
newline|'\n'
DECL|function|test_fn
name|'def'
name|'test_fn'
op|'('
name|'_self'
op|','
name|'context'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertIsInstance'
op|'('
name|'instance'
op|','
name|'instance_obj'
op|'.'
name|'Instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'.'
name|'uuid'
op|','
name|'db_inst'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'test_fn'
op|'('
name|'None'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'db_inst'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_object_compat_more_positional_args
dedent|''
name|'def'
name|'test_object_compat_more_positional_args'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'db_inst'
op|'='
name|'fake_instance'
op|'.'
name|'fake_db_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
op|'@'
name|'compute_manager'
op|'.'
name|'object_compat'
newline|'\n'
DECL|function|test_fn
name|'def'
name|'test_fn'
op|'('
name|'_self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'pos_arg_1'
op|','
name|'pos_arg_2'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertIsInstance'
op|'('
name|'instance'
op|','
name|'instance_obj'
op|'.'
name|'Instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'.'
name|'uuid'
op|','
name|'db_inst'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'pos_arg_1'
op|','
string|"'fake_pos_arg1'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'pos_arg_2'
op|','
string|"'fake_pos_arg2'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'test_fn'
op|'('
name|'None'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'db_inst'
op|','
string|"'fake_pos_arg1'"
op|','
string|"'fake_pos_arg2'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_instance_with_img_ref_associates_config_drive
dedent|''
name|'def'
name|'test_create_instance_with_img_ref_associates_config_drive'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure create associates a config drive.'
nl|'\n'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
name|'params'
op|'='
op|'{'
string|"'config_drive'"
op|':'
string|"'1234'"
op|','
op|'}'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
nl|'\n'
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'instances'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'instance'
op|'['
string|"'config_drive'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_instance_associates_config_drive
dedent|''
dedent|''
name|'def'
name|'test_create_instance_associates_config_drive'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure create associates a config drive.'
nl|'\n'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
name|'params'
op|'='
op|'{'
string|"'config_drive'"
op|':'
string|"'1234'"
op|','
op|'}'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
nl|'\n'
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'instances'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'instance'
op|'['
string|"'config_drive'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_instance_unlimited_memory
dedent|''
dedent|''
name|'def'
name|'test_create_instance_unlimited_memory'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Default of memory limit=None is unlimited.'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'reserved_host_disk_mb'
op|'='
number|'0'
op|','
name|'reserved_host_memory_mb'
op|'='
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'rt'
op|'.'
name|'update_available_resource'
op|'('
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|')'
newline|'\n'
name|'params'
op|'='
op|'{'
string|'"memory_mb"'
op|':'
number|'999999999999'
op|'}'
newline|'\n'
name|'filter_properties'
op|'='
op|'{'
string|"'limits'"
op|':'
op|'{'
string|"'memory_mb'"
op|':'
name|'None'
op|'}'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'999999999999'
op|','
name|'self'
op|'.'
name|'rt'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_instance_unlimited_disk
dedent|''
name|'def'
name|'test_create_instance_unlimited_disk'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'reserved_host_disk_mb'
op|'='
number|'0'
op|','
name|'reserved_host_memory_mb'
op|'='
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'rt'
op|'.'
name|'update_available_resource'
op|'('
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|')'
newline|'\n'
name|'params'
op|'='
op|'{'
string|'"root_gb"'
op|':'
number|'999999999999'
op|','
nl|'\n'
string|'"ephemeral_gb"'
op|':'
number|'99999999999'
op|'}'
newline|'\n'
name|'filter_properties'
op|'='
op|'{'
string|"'limits'"
op|':'
op|'{'
string|"'disk_gb'"
op|':'
name|'None'
op|'}'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_multiple_instances_then_starve
dedent|''
name|'def'
name|'test_create_multiple_instances_then_starve'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'reserved_host_disk_mb'
op|'='
number|'0'
op|','
name|'reserved_host_memory_mb'
op|'='
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'rt'
op|'.'
name|'update_available_resource'
op|'('
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|')'
newline|'\n'
name|'filter_properties'
op|'='
op|'{'
string|"'limits'"
op|':'
op|'{'
string|"'memory_mb'"
op|':'
number|'4096'
op|','
string|"'disk_gb'"
op|':'
number|'1000'
op|'}'
op|'}'
newline|'\n'
name|'params'
op|'='
op|'{'
string|'"memory_mb"'
op|':'
number|'1024'
op|','
string|'"root_gb"'
op|':'
number|'128'
op|','
string|'"ephemeral_gb"'
op|':'
number|'128'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1024'
op|','
name|'self'
op|'.'
name|'rt'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'256'
op|','
name|'self'
op|'.'
name|'rt'
op|'.'
name|'compute_node'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'params'
op|'='
op|'{'
string|'"memory_mb"'
op|':'
number|'2048'
op|','
string|'"root_gb"'
op|':'
number|'256'
op|','
string|'"ephemeral_gb"'
op|':'
number|'256'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'3072'
op|','
name|'self'
op|'.'
name|'rt'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'768'
op|','
name|'self'
op|'.'
name|'rt'
op|'.'
name|'compute_node'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'params'
op|'='
op|'{'
string|'"memory_mb"'
op|':'
number|'8192'
op|','
string|'"root_gb"'
op|':'
number|'8192'
op|','
string|'"ephemeral_gb"'
op|':'
number|'8192'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'ComputeResourcesUnavailable'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
op|'{'
op|'}'
op|','
name|'filter_properties'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_multiple_instance_with_neutron_port
dedent|''
name|'def'
name|'test_create_multiple_instance_with_neutron_port'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_is_neutron
name|'def'
name|'fake_is_neutron'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'True'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'utils'
op|','
string|"'is_neutron'"
op|','
name|'fake_is_neutron'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'MultiplePortsNotApplicable'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'instance_type'
op|','
nl|'\n'
name|'image_href'
op|'='
name|'None'
op|','
nl|'\n'
name|'max_count'
op|'='
number|'2'
op|','
nl|'\n'
name|'requested_networks'
op|'='
op|'['
op|'('
name|'None'
op|','
name|'None'
op|','
string|"'adadds'"
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_instance_with_oversubscribed_ram
dedent|''
name|'def'
name|'test_create_instance_with_oversubscribed_ram'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test passing of oversubscribed ram policy from the scheduler.'
nl|'\n'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'reserved_host_disk_mb'
op|'='
number|'0'
op|','
name|'reserved_host_memory_mb'
op|'='
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'rt'
op|'.'
name|'update_available_resource'
op|'('
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# get total memory as reported by virt driver:'
nl|'\n'
name|'resources'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'get_available_resource'
op|'('
name|'NODENAME'
op|')'
newline|'\n'
name|'total_mem_mb'
op|'='
name|'resources'
op|'['
string|"'memory_mb'"
op|']'
newline|'\n'
nl|'\n'
name|'oversub_limit_mb'
op|'='
name|'total_mem_mb'
op|'*'
number|'1.5'
newline|'\n'
name|'instance_mb'
op|'='
name|'int'
op|'('
name|'total_mem_mb'
op|'*'
number|'1.45'
op|')'
newline|'\n'
nl|'\n'
comment|'# build an instance, specifying an amount of memory that exceeds'
nl|'\n'
comment|'# total_mem_mb, but is less than the oversubscribed limit:'
nl|'\n'
name|'params'
op|'='
op|'{'
string|'"memory_mb"'
op|':'
name|'instance_mb'
op|','
string|'"root_gb"'
op|':'
number|'128'
op|','
nl|'\n'
string|'"ephemeral_gb"'
op|':'
number|'128'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|')'
newline|'\n'
nl|'\n'
name|'limits'
op|'='
op|'{'
string|"'memory_mb'"
op|':'
name|'oversub_limit_mb'
op|'}'
newline|'\n'
name|'filter_properties'
op|'='
op|'{'
string|"'limits'"
op|':'
name|'limits'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance_mb'
op|','
name|'self'
op|'.'
name|'rt'
op|'.'
name|'compute_node'
op|'['
string|"'memory_mb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_instance_with_oversubscribed_ram_fail
dedent|''
name|'def'
name|'test_create_instance_with_oversubscribed_ram_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Test passing of oversubscribed ram policy from the scheduler, but\n        with insufficient memory.\n        """'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'reserved_host_disk_mb'
op|'='
number|'0'
op|','
name|'reserved_host_memory_mb'
op|'='
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'rt'
op|'.'
name|'update_available_resource'
op|'('
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# get total memory as reported by virt driver:'
nl|'\n'
name|'resources'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'get_available_resource'
op|'('
name|'NODENAME'
op|')'
newline|'\n'
name|'total_mem_mb'
op|'='
name|'resources'
op|'['
string|"'memory_mb'"
op|']'
newline|'\n'
nl|'\n'
name|'oversub_limit_mb'
op|'='
name|'total_mem_mb'
op|'*'
number|'1.5'
newline|'\n'
name|'instance_mb'
op|'='
name|'int'
op|'('
name|'total_mem_mb'
op|'*'
number|'1.55'
op|')'
newline|'\n'
nl|'\n'
comment|'# build an instance, specifying an amount of memory that exceeds'
nl|'\n'
comment|'# total_mem_mb, but is less than the oversubscribed limit:'
nl|'\n'
name|'params'
op|'='
op|'{'
string|'"memory_mb"'
op|':'
name|'instance_mb'
op|','
string|'"root_gb"'
op|':'
number|'128'
op|','
nl|'\n'
string|'"ephemeral_gb"'
op|':'
number|'128'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|')'
newline|'\n'
nl|'\n'
name|'filter_properties'
op|'='
op|'{'
string|"'limits'"
op|':'
op|'{'
string|"'memory_mb'"
op|':'
name|'oversub_limit_mb'
op|'}'
op|'}'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'ComputeResourcesUnavailable'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_instance_with_oversubscribed_cpu
dedent|''
name|'def'
name|'test_create_instance_with_oversubscribed_cpu'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test passing of oversubscribed cpu policy from the scheduler.'
nl|'\n'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'reserved_host_disk_mb'
op|'='
number|'0'
op|','
name|'reserved_host_memory_mb'
op|'='
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'rt'
op|'.'
name|'update_available_resource'
op|'('
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|')'
newline|'\n'
name|'limits'
op|'='
op|'{'
string|"'vcpu'"
op|':'
number|'3'
op|'}'
newline|'\n'
name|'filter_properties'
op|'='
op|'{'
string|"'limits'"
op|':'
name|'limits'
op|'}'
newline|'\n'
nl|'\n'
comment|'# get total memory as reported by virt driver:'
nl|'\n'
name|'resources'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'get_available_resource'
op|'('
name|'NODENAME'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'resources'
op|'['
string|"'vcpus'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# build an instance, specifying an amount of memory that exceeds'
nl|'\n'
comment|'# total_mem_mb, but is less than the oversubscribed limit:'
nl|'\n'
name|'params'
op|'='
op|'{'
string|'"memory_mb"'
op|':'
number|'10'
op|','
string|'"root_gb"'
op|':'
number|'1'
op|','
nl|'\n'
string|'"ephemeral_gb"'
op|':'
number|'1'
op|','
string|'"vcpus"'
op|':'
number|'2'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'self'
op|'.'
name|'rt'
op|'.'
name|'compute_node'
op|'['
string|"'vcpus_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# create one more instance:'
nl|'\n'
name|'params'
op|'='
op|'{'
string|'"memory_mb"'
op|':'
number|'10'
op|','
string|'"root_gb"'
op|':'
number|'1'
op|','
nl|'\n'
string|'"ephemeral_gb"'
op|':'
number|'1'
op|','
string|'"vcpus"'
op|':'
number|'1'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'3'
op|','
name|'self'
op|'.'
name|'rt'
op|'.'
name|'compute_node'
op|'['
string|"'vcpus_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# delete the instance:'
nl|'\n'
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|'='
name|'vm_states'
op|'.'
name|'DELETED'
newline|'\n'
name|'self'
op|'.'
name|'rt'
op|'.'
name|'update_usage'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'self'
op|'.'
name|'rt'
op|'.'
name|'compute_node'
op|'['
string|"'vcpus_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# now oversubscribe vcpus and fail:'
nl|'\n'
name|'params'
op|'='
op|'{'
string|'"memory_mb"'
op|':'
number|'10'
op|','
string|'"root_gb"'
op|':'
number|'1'
op|','
nl|'\n'
string|'"ephemeral_gb"'
op|':'
number|'1'
op|','
string|'"vcpus"'
op|':'
number|'2'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|')'
newline|'\n'
nl|'\n'
name|'limits'
op|'='
op|'{'
string|"'vcpu'"
op|':'
number|'3'
op|'}'
newline|'\n'
name|'filter_properties'
op|'='
op|'{'
string|"'limits'"
op|':'
name|'limits'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'ComputeResourcesUnavailable'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_instance_with_oversubscribed_disk
dedent|''
name|'def'
name|'test_create_instance_with_oversubscribed_disk'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test passing of oversubscribed disk policy from the scheduler.'
nl|'\n'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'reserved_host_disk_mb'
op|'='
number|'0'
op|','
name|'reserved_host_memory_mb'
op|'='
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'rt'
op|'.'
name|'update_available_resource'
op|'('
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# get total memory as reported by virt driver:'
nl|'\n'
name|'resources'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'get_available_resource'
op|'('
name|'NODENAME'
op|')'
newline|'\n'
name|'total_disk_gb'
op|'='
name|'resources'
op|'['
string|"'local_gb'"
op|']'
newline|'\n'
nl|'\n'
name|'oversub_limit_gb'
op|'='
name|'total_disk_gb'
op|'*'
number|'1.5'
newline|'\n'
name|'instance_gb'
op|'='
name|'int'
op|'('
name|'total_disk_gb'
op|'*'
number|'1.45'
op|')'
newline|'\n'
nl|'\n'
comment|'# build an instance, specifying an amount of disk that exceeds'
nl|'\n'
comment|'# total_disk_gb, but is less than the oversubscribed limit:'
nl|'\n'
name|'params'
op|'='
op|'{'
string|'"root_gb"'
op|':'
name|'instance_gb'
op|','
string|'"memory_mb"'
op|':'
number|'10'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|')'
newline|'\n'
nl|'\n'
name|'limits'
op|'='
op|'{'
string|"'disk_gb'"
op|':'
name|'oversub_limit_gb'
op|'}'
newline|'\n'
name|'filter_properties'
op|'='
op|'{'
string|"'limits'"
op|':'
name|'limits'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance_gb'
op|','
name|'self'
op|'.'
name|'rt'
op|'.'
name|'compute_node'
op|'['
string|"'local_gb_used'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_instance_with_oversubscribed_disk_fail
dedent|''
name|'def'
name|'test_create_instance_with_oversubscribed_disk_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Test passing of oversubscribed disk policy from the scheduler, but\n        with insufficient disk.\n        """'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'reserved_host_disk_mb'
op|'='
number|'0'
op|','
name|'reserved_host_memory_mb'
op|'='
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'rt'
op|'.'
name|'update_available_resource'
op|'('
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# get total memory as reported by virt driver:'
nl|'\n'
name|'resources'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'get_available_resource'
op|'('
name|'NODENAME'
op|')'
newline|'\n'
name|'total_disk_gb'
op|'='
name|'resources'
op|'['
string|"'local_gb'"
op|']'
newline|'\n'
nl|'\n'
name|'oversub_limit_gb'
op|'='
name|'total_disk_gb'
op|'*'
number|'1.5'
newline|'\n'
name|'instance_gb'
op|'='
name|'int'
op|'('
name|'total_disk_gb'
op|'*'
number|'1.55'
op|')'
newline|'\n'
nl|'\n'
comment|'# build an instance, specifying an amount of disk that exceeds'
nl|'\n'
comment|'# total_disk_gb, but is less than the oversubscribed limit:'
nl|'\n'
name|'params'
op|'='
op|'{'
string|'"root_gb"'
op|':'
name|'instance_gb'
op|','
string|'"memory_mb"'
op|':'
number|'10'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|')'
newline|'\n'
nl|'\n'
name|'limits'
op|'='
op|'{'
string|"'disk_gb'"
op|':'
name|'oversub_limit_gb'
op|'}'
newline|'\n'
name|'filter_properties'
op|'='
op|'{'
string|"'limits'"
op|':'
name|'limits'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'ComputeResourcesUnavailable'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_instance_without_node_param
dedent|''
name|'def'
name|'test_create_instance_without_node_param'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'node'"
op|':'
name|'None'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'instances'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'NODENAME'
op|','
name|'instance'
op|'['
string|"'node'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_instance_no_image
dedent|''
name|'def'
name|'test_create_instance_no_image'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Create instance with no image provided.'
nl|'\n'
indent|'        '
name|'params'
op|'='
op|'{'
string|"'image_ref'"
op|':'
string|"''"
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_assert_state'
op|'('
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'ACTIVE'
op|','
nl|'\n'
string|"'task_state'"
op|':'
name|'None'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_default_access_ip
dedent|''
name|'def'
name|'test_default_access_ip'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'default_access_ip_network_name'
op|'='
string|"'test1'"
op|')'
newline|'\n'
name|'fake_network'
op|'.'
name|'unset_stub_network_methods'
op|'('
name|'self'
op|'.'
name|'stubs'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'orig_update'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_instance_update'
newline|'\n'
nl|'\n'
comment|'# Make sure the access_ip_* updates happen in the same DB'
nl|'\n'
comment|'# update as the set to ACTIVE.'
nl|'\n'
DECL|function|_instance_update
name|'def'
name|'_instance_update'
op|'('
name|'ctxt'
op|','
name|'instance_uuid'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'kwargs'
op|'.'
name|'get'
op|'('
string|"'vm_state'"
op|','
name|'None'
op|')'
op|'=='
name|'vm_states'
op|'.'
name|'ACTIVE'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'kwargs'
op|'['
string|"'access_ip_v4'"
op|']'
op|','
string|"'192.168.1.100'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'kwargs'
op|'['
string|"'access_ip_v6'"
op|']'
op|','
string|"'2001:db8:0:1::1'"
op|')'
newline|'\n'
dedent|''
name|'return'
name|'orig_update'
op|'('
name|'ctxt'
op|','
name|'instance_uuid'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_instance_update'"
op|','
name|'_instance_update'
op|')'
newline|'\n'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'instances'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'access_ip_v4'"
op|']'
op|','
string|"'192.168.1.100'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'access_ip_v6'"
op|']'
op|','
string|"'2001:db8:0:1::1'"
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_no_default_access_ip
dedent|''
dedent|''
name|'def'
name|'test_no_default_access_ip'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'instances'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'instance'
op|'['
string|"'access_ip_v4'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'instance'
op|'['
string|"'access_ip_v6'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_fail_to_schedule_persists
dedent|''
dedent|''
name|'def'
name|'test_fail_to_schedule_persists'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# check the persistence of the ERROR(scheduling) state.'
nl|'\n'
indent|'        '
name|'params'
op|'='
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'ERROR'
op|','
nl|'\n'
string|"'task_state'"
op|':'
name|'task_states'
op|'.'
name|'SCHEDULING'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
name|'params'
op|')'
newline|'\n'
comment|'#check state is failed even after the periodic poll'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'periodic_tasks'
op|'('
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_assert_state'
op|'('
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'ERROR'
op|','
nl|'\n'
string|"'task_state'"
op|':'
name|'task_states'
op|'.'
name|'SCHEDULING'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_instance_setup_block_device_mapping_fail
dedent|''
name|'def'
name|'test_run_instance_setup_block_device_mapping_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""block device mapping failure test.\n\n        Make sure that when there is a block device mapping problem,\n        the instance goes to ERROR state, keeping the task state\n        """'
newline|'\n'
DECL|function|fake
name|'def'
name|'fake'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'compute'
op|'.'
name|'manager'
op|'.'
name|'ComputeManager'
op|','
nl|'\n'
string|"'_prep_block_device'"
op|','
name|'fake'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
name|'request_spec'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|'='
op|'{'
op|'}'
op|','
name|'requested_networks'
op|'='
op|'['
op|']'
op|','
nl|'\n'
name|'injected_files'
op|'='
name|'None'
op|','
name|'admin_password'
op|'='
name|'None'
op|','
nl|'\n'
name|'is_first_time'
op|'='
name|'True'
op|','
name|'node'
op|'='
name|'None'
op|','
nl|'\n'
name|'legacy_bdm_in_spec'
op|'='
name|'False'
op|')'
newline|'\n'
comment|'#check state is failed even after the periodic poll'
nl|'\n'
name|'self'
op|'.'
name|'_assert_state'
op|'('
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'ERROR'
op|','
nl|'\n'
string|"'task_state'"
op|':'
name|'None'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'periodic_tasks'
op|'('
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_assert_state'
op|'('
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'ERROR'
op|','
nl|'\n'
string|"'task_state'"
op|':'
name|'None'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_instance_spawn_fail
dedent|''
name|'def'
name|'test_run_instance_spawn_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""spawn failure test.\n\n        Make sure that when there is a spawning problem,\n        the instance goes to ERROR state, keeping the task state.\n        """'
newline|'\n'
DECL|function|fake
name|'def'
name|'fake'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'spawn'"
op|','
name|'fake'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
name|'request_spec'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|'='
op|'{'
op|'}'
op|','
name|'requested_networks'
op|'='
op|'['
op|']'
op|','
nl|'\n'
name|'injected_files'
op|'='
name|'None'
op|','
name|'admin_password'
op|'='
name|'None'
op|','
nl|'\n'
name|'is_first_time'
op|'='
name|'True'
op|','
name|'node'
op|'='
name|'None'
op|','
nl|'\n'
name|'legacy_bdm_in_spec'
op|'='
name|'False'
op|')'
newline|'\n'
comment|'#check state is failed even after the periodic poll'
nl|'\n'
name|'self'
op|'.'
name|'_assert_state'
op|'('
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'ERROR'
op|','
nl|'\n'
string|"'task_state'"
op|':'
name|'None'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'periodic_tasks'
op|'('
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_assert_state'
op|'('
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'ERROR'
op|','
nl|'\n'
string|"'task_state'"
op|':'
name|'None'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_instance_dealloc_network_instance_not_found
dedent|''
name|'def'
name|'test_run_instance_dealloc_network_instance_not_found'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""spawn network deallocate test.\n\n        Make sure that when an instance is not found during spawn\n        that the network is deallocated\n        """'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake
name|'def'
name|'fake'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
string|'"fake"'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'spawn'"
op|','
name|'fake'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_deallocate_network'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_deallocate_network'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_instance_bails_on_missing_instance
dedent|''
name|'def'
name|'test_run_instance_bails_on_missing_instance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure that run_instance() will quickly ignore a deleted instance'
nl|'\n'
indent|'        '
name|'called'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_instance_update
name|'def'
name|'fake_instance_update'
op|'('
name|'self'
op|','
op|'*'
name|'a'
op|','
op|'**'
name|'args'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'instance_update'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
string|"'foo'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_instance_update'"
op|','
name|'fake_instance_update'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'instance_update'"
op|','
name|'called'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_instance_bails_on_deleting_instance
dedent|''
name|'def'
name|'test_run_instance_bails_on_deleting_instance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure that run_instance() will quickly ignore a deleting instance'
nl|'\n'
indent|'        '
name|'called'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_instance_update
name|'def'
name|'fake_instance_update'
op|'('
name|'self'
op|','
op|'*'
name|'a'
op|','
op|'**'
name|'args'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'instance_update'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'UnexpectedDeletingTaskStateError'
op|'('
nl|'\n'
name|'expected'
op|'='
string|"'scheduling'"
op|','
name|'actual'
op|'='
string|"'deleting'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_instance_update'"
op|','
name|'fake_instance_update'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'instance_update'"
op|','
name|'called'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_instance_bails_on_missing_instance_2
dedent|''
name|'def'
name|'test_run_instance_bails_on_missing_instance_2'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure that run_instance() will quickly ignore a deleted instance'
nl|'\n'
indent|'        '
name|'called'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_default_block_device_names
name|'def'
name|'fake_default_block_device_names'
op|'('
name|'self'
op|','
op|'*'
name|'a'
op|','
op|'**'
name|'args'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'default_block_device_names'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
string|"'foo'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_default_block_device_names'"
op|','
nl|'\n'
name|'fake_default_block_device_names'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'default_block_device_names'"
op|','
name|'called'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_can_terminate_on_error_state
dedent|''
name|'def'
name|'test_can_terminate_on_error_state'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure that the instance can be terminated in ERROR state.'
nl|'\n'
comment|'#check failed to schedule --> terminate'
nl|'\n'
indent|'        '
name|'params'
op|'='
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'ERROR'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
name|'params'
op|'='
name|'params'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceNotFound'
op|','
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
comment|"# Double check it's not there for admins, either."
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceNotFound'
op|','
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_terminate
dedent|''
name|'def'
name|'test_run_terminate'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure it is possible to  run and terminate instance.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|'"Running instances: %s"'
op|')'
op|','
name|'instances'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|'"After terminating instances: %s"'
op|')'
op|','
name|'instances'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
name|'admin_deleted_context'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
nl|'\n'
name|'read_deleted'
op|'='
string|'"only"'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'admin_deleted_context'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|','
name|'vm_states'
op|'.'
name|'DELETED'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_terminate_with_vol_attached
dedent|''
name|'def'
name|'test_run_terminate_with_vol_attached'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Make sure it is possible to  run and terminate instance with volume\n        attached\n        """'
newline|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|'"Running instances: %s"'
op|')'
op|','
name|'instances'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_check_attach
name|'def'
name|'fake_check_attach'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
DECL|function|fake_reserve_volume
dedent|''
name|'def'
name|'fake_reserve_volume'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
DECL|function|fake_volume_get
dedent|''
name|'def'
name|'fake_volume_get'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'id'"
op|':'
name|'volume_id'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_rpc_reserve_block_device_name
dedent|''
name|'def'
name|'fake_rpc_reserve_block_device_name'
op|'('
name|'self'
op|','
name|'context'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'get'"
op|','
name|'fake_volume_get'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'check_attach'"
op|','
name|'fake_check_attach'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'reserve_volume'"
op|','
nl|'\n'
name|'fake_reserve_volume'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'compute_rpcapi'
op|'.'
name|'ComputeAPI'
op|','
nl|'\n'
string|"'reserve_block_device_name'"
op|','
nl|'\n'
name|'fake_rpc_reserve_block_device_name'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'attach_volume'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
number|'1'
op|','
nl|'\n'
string|"'/dev/vdc'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|'"After terminating instances: %s"'
op|')'
op|','
name|'instances'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
name|'bdms'
op|'='
name|'db'
op|'.'
name|'block_device_mapping_get_all_by_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'bdms'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_terminate_no_image
dedent|''
name|'def'
name|'test_run_terminate_no_image'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Make sure instance started without image (from volume)\n        can be termintad without issues\n        """'
newline|'\n'
name|'params'
op|'='
op|'{'
string|"'image_ref'"
op|':'
string|"''"
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
name|'params'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_assert_state'
op|'('
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'ACTIVE'
op|','
nl|'\n'
string|"'task_state'"
op|':'
name|'None'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_terminate_no_network
dedent|''
name|'def'
name|'test_terminate_no_network'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# This is as reported in LP bug 1008875'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|'"Running instances: %s"'
op|')'
op|','
name|'instances'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
comment|'# Make it look like this is no instance'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_instance_nw_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instance_nw_info'
op|'('
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
op|'.'
name|'AndRaise'
op|'('
nl|'\n'
name|'exception'
op|'.'
name|'NetworkNotFound'
op|'('
name|'network_id'
op|'='
string|"'fake'"
op|')'
nl|'\n'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|'"After terminating instances: %s"'
op|')'
op|','
name|'instances'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_terminate_no_fixed_ips
dedent|''
name|'def'
name|'test_terminate_no_fixed_ips'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# This is as reported in LP bug 1192893'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|'"Running instances: %s"'
op|')'
op|','
name|'instances'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_instance_nw_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instance_nw_info'
op|'('
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
op|'.'
name|'AndRaise'
op|'('
nl|'\n'
name|'exception'
op|'.'
name|'NoMoreFixedIps'
op|'('
op|')'
nl|'\n'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|'"After terminating instances: %s"'
op|')'
op|','
name|'instances'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_terminate_timestamps
dedent|''
name|'def'
name|'test_run_terminate_timestamps'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure timestamps are set for launched and destroyed.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'instance'
op|'['
string|"'launched_at'"
op|']'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'instance'
op|'['
string|"'launched_at'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'instance'
op|'['
string|"'deleted_at'"
op|']'
op|')'
newline|'\n'
name|'launch'
op|'='
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'instance'
op|'['
string|"'launched_at'"
op|']'
op|'>'
name|'launch'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'instance'
op|'['
string|"'deleted_at'"
op|']'
op|')'
newline|'\n'
name|'terminate'
op|'='
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'with'
name|'utils'
op|'.'
name|'temporary_mutation'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'read_deleted'
op|'='
string|"'only'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'instance'
op|'['
string|"'launched_at'"
op|']'
op|'<'
name|'terminate'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'instance'
op|'['
string|"'deleted_at'"
op|']'
op|'>'
name|'terminate'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_terminate_deallocate_net_failure_sets_error_state
dedent|''
name|'def'
name|'test_run_terminate_deallocate_net_failure_sets_error_state'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|'"Running instances: %s"'
op|')'
op|','
name|'instances'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_fake_deallocate_network
name|'def'
name|'_fake_deallocate_network'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_deallocate_network'"
op|','
nl|'\n'
name|'_fake_deallocate_network'
op|')'
newline|'\n'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'test'
op|'.'
name|'TestingException'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|','
name|'vm_states'
op|'.'
name|'ERROR'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_stop
dedent|''
name|'def'
name|'test_stop'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance can be stopped.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|'"task_state"'
op|':'
name|'task_states'
op|'.'
name|'POWERING_OFF'
op|'}'
op|')'
newline|'\n'
name|'inst_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'extra'
op|'='
op|'['
string|"'system_metadata'"
op|','
string|"'metadata'"
op|']'
newline|'\n'
name|'inst_obj'
op|'='
name|'instance_obj'
op|'.'
name|'Instance'
op|'.'
name|'get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'inst_uuid'
op|','
nl|'\n'
name|'expected_attrs'
op|'='
name|'extra'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'stop_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'inst_obj'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_start
dedent|''
name|'def'
name|'test_start'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance can be started.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|'"task_state"'
op|':'
name|'task_states'
op|'.'
name|'POWERING_OFF'
op|'}'
op|')'
newline|'\n'
name|'extra'
op|'='
op|'['
string|"'system_metadata'"
op|','
string|"'metadata'"
op|']'
newline|'\n'
name|'inst_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'inst_obj'
op|'='
name|'instance_obj'
op|'.'
name|'Instance'
op|'.'
name|'get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'inst_uuid'
op|','
nl|'\n'
name|'expected_attrs'
op|'='
name|'extra'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'stop_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'inst_obj'
op|')'
newline|'\n'
name|'inst_obj'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'POWERING_ON'
newline|'\n'
name|'inst_obj'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'start_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'inst_obj'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_stop_start_no_image
dedent|''
name|'def'
name|'test_stop_start_no_image'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'params'
op|'='
op|'{'
string|"'image_ref'"
op|':'
string|"''"
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
name|'params'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|'"task_state"'
op|':'
name|'task_states'
op|'.'
name|'POWERING_OFF'
op|'}'
op|')'
newline|'\n'
name|'extra'
op|'='
op|'['
string|"'system_metadata'"
op|','
string|"'metadata'"
op|']'
newline|'\n'
name|'inst_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'inst_obj'
op|'='
name|'instance_obj'
op|'.'
name|'Instance'
op|'.'
name|'get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'inst_uuid'
op|','
nl|'\n'
name|'expected_attrs'
op|'='
name|'extra'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'stop_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'inst_obj'
op|')'
newline|'\n'
name|'inst_obj'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'POWERING_ON'
newline|'\n'
name|'inst_obj'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'start_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'inst_obj'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rescue
dedent|''
name|'def'
name|'test_rescue'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance can be rescued and unrescued.'
nl|'\n'
nl|'\n'
indent|'        '
name|'called'
op|'='
op|'{'
string|"'rescued'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'unrescued'"
op|':'
name|'False'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_rescue
name|'def'
name|'fake_rescue'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance_ref'
op|','
name|'network_info'
op|','
name|'image_meta'
op|','
nl|'\n'
name|'rescue_password'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'rescued'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'fake'
op|'.'
name|'FakeDriver'
op|','
string|"'rescue'"
op|','
name|'fake_rescue'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_unrescue
name|'def'
name|'fake_unrescue'
op|'('
name|'self'
op|','
name|'instance_ref'
op|','
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'unrescued'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'fake'
op|'.'
name|'FakeDriver'
op|','
string|"'unrescue'"
op|','
nl|'\n'
name|'fake_unrescue'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|','
nl|'\n'
op|'{'
string|'"task_state"'
op|':'
name|'task_states'
op|'.'
name|'RESCUING'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'rescue_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'['
string|"'rescued'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|','
nl|'\n'
op|'{'
string|'"task_state"'
op|':'
name|'task_states'
op|'.'
name|'UNRESCUING'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'unrescue_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'['
string|"'unrescued'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rescue_notifications
dedent|''
name|'def'
name|'test_rescue_notifications'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure notifications on instance rescue.'
nl|'\n'
DECL|function|fake_rescue
indent|'        '
name|'def'
name|'fake_rescue'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance_ref'
op|','
name|'network_info'
op|','
name|'image_meta'
op|','
nl|'\n'
name|'rescue_password'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'fake'
op|'.'
name|'FakeDriver'
op|','
string|"'rescue'"
op|','
name|'fake_rescue'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|','
nl|'\n'
op|'{'
string|'"task_state"'
op|':'
name|'task_states'
op|'.'
name|'RESCUING'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'rescue_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'expected_notifications'
op|'='
op|'['
string|"'compute.instance.exists'"
op|','
nl|'\n'
string|"'compute.instance.rescue.start'"
op|','
nl|'\n'
string|"'compute.instance.rescue.end'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'m'
op|'.'
name|'event_type'
name|'for'
name|'m'
name|'in'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|']'
op|','
nl|'\n'
name|'expected_notifications'
op|')'
newline|'\n'
name|'for'
name|'n'
op|','
name|'msg'
name|'in'
name|'enumerate'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
name|'expected_notifications'
op|'['
name|'n'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'priority'
op|','
string|"'INFO'"
op|')'
newline|'\n'
name|'payload'
op|'='
name|'msg'
op|'.'
name|'payload'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'tenant_id'"
op|']'
op|','
name|'self'
op|'.'
name|'project_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'user_id'"
op|']'
op|','
name|'self'
op|'.'
name|'user_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'instance_id'"
op|']'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'instance_type'"
op|']'
op|','
string|"'m1.tiny'"
op|')'
newline|'\n'
name|'type_id'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
string|"'m1.tiny'"
op|')'
op|'['
string|"'id'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'payload'
op|'['
string|"'instance_type_id'"
op|']'
op|')'
op|','
name|'str'
op|'('
name|'type_id'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'display_name'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'created_at'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'launched_at'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'image_ref_url'
op|'='
name|'glance'
op|'.'
name|'generate_image_url'
op|'('
name|'FAKE_IMAGE_REF'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'image_ref_url'"
op|']'
op|','
name|'image_ref_url'
op|')'
newline|'\n'
dedent|''
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'rescue_image_name'"
op|','
name|'msg'
op|'.'
name|'payload'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_unrescue_notifications
dedent|''
name|'def'
name|'test_unrescue_notifications'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure notifications on instance rescue.'
nl|'\n'
DECL|function|fake_unrescue
indent|'        '
name|'def'
name|'fake_unrescue'
op|'('
name|'self'
op|','
name|'instance_ref'
op|','
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'fake'
op|'.'
name|'FakeDriver'
op|','
string|"'unrescue'"
op|','
nl|'\n'
name|'fake_unrescue'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|','
nl|'\n'
op|'{'
string|'"task_state"'
op|':'
name|'task_states'
op|'.'
name|'UNRESCUING'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'unrescue_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'expected_notifications'
op|'='
op|'['
string|"'compute.instance.unrescue.start'"
op|','
nl|'\n'
string|"'compute.instance.unrescue.end'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
name|'m'
op|'.'
name|'event_type'
name|'for'
name|'m'
name|'in'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|']'
op|','
nl|'\n'
name|'expected_notifications'
op|')'
newline|'\n'
name|'for'
name|'n'
op|','
name|'msg'
name|'in'
name|'enumerate'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
name|'expected_notifications'
op|'['
name|'n'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'priority'
op|','
string|"'INFO'"
op|')'
newline|'\n'
name|'payload'
op|'='
name|'msg'
op|'.'
name|'payload'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'tenant_id'"
op|']'
op|','
name|'self'
op|'.'
name|'project_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'user_id'"
op|']'
op|','
name|'self'
op|'.'
name|'user_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'instance_id'"
op|']'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'instance_type'"
op|']'
op|','
string|"'m1.tiny'"
op|')'
newline|'\n'
name|'type_id'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
string|"'m1.tiny'"
op|')'
op|'['
string|"'id'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'payload'
op|'['
string|"'instance_type_id'"
op|']'
op|')'
op|','
name|'str'
op|'('
name|'type_id'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'display_name'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'created_at'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'launched_at'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'image_ref_url'
op|'='
name|'glance'
op|'.'
name|'generate_image_url'
op|'('
name|'FAKE_IMAGE_REF'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'image_ref_url'"
op|']'
op|','
name|'image_ref_url'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rescue_handle_err
dedent|''
name|'def'
name|'test_rescue_handle_err'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# If the driver fails to rescue, instance state should remain the same'
nl|'\n'
comment|'# and the exception should be converted to InstanceNotRescuable'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_rescue_image'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'fake'
op|'.'
name|'FakeDriver'
op|','
string|"'rescue'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_rescue_image'
op|'('
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
op|'{'
op|'}'
op|')'
newline|'\n'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'fake'
op|'.'
name|'FakeDriver'
op|'.'
name|'rescue'
op|'('
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'instance'
op|','
op|'['
op|']'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
string|"'password'"
nl|'\n'
op|')'
op|'.'
name|'AndRaise'
op|'('
name|'RuntimeError'
op|'('
string|'"Try again later"'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'expected_message'
op|'='
op|'('
string|"'Instance %s cannot be rescued: '"
nl|'\n'
string|"'Driver Error: Try again later'"
op|'%'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|'='
string|"'some_random_state'"
newline|'\n'
nl|'\n'
name|'with'
name|'testtools'
op|'.'
name|'ExpectedException'
op|'('
nl|'\n'
name|'exception'
op|'.'
name|'InstanceNotRescuable'
op|','
name|'expected_message'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'compute'
op|'.'
name|'rescue_instance'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'rescue_password'
op|'='
string|"'password'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'some_random_state'"
op|','
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_power_on
dedent|''
name|'def'
name|'test_power_on'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance can be powered on.'
nl|'\n'
nl|'\n'
indent|'        '
name|'called'
op|'='
op|'{'
string|"'power_on'"
op|':'
name|'False'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_driver_power_on
name|'def'
name|'fake_driver_power_on'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'network_info'
op|','
nl|'\n'
name|'block_device_info'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'power_on'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'fake'
op|'.'
name|'FakeDriver'
op|','
string|"'power_on'"
op|','
nl|'\n'
name|'fake_driver_power_on'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'extra'
op|'='
op|'['
string|"'system_metadata'"
op|','
string|"'metadata'"
op|']'
newline|'\n'
name|'inst_obj'
op|'='
name|'instance_obj'
op|'.'
name|'Instance'
op|'.'
name|'get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
name|'expected_attrs'
op|'='
name|'extra'
op|')'
newline|'\n'
name|'inst_obj'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'POWERING_ON'
newline|'\n'
name|'inst_obj'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'start_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'inst_obj'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'['
string|"'power_on'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'inst_obj'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_power_off
dedent|''
name|'def'
name|'test_power_off'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance can be powered off.'
nl|'\n'
nl|'\n'
indent|'        '
name|'called'
op|'='
op|'{'
string|"'power_off'"
op|':'
name|'False'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_driver_power_off
name|'def'
name|'fake_driver_power_off'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'power_off'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'fake'
op|'.'
name|'FakeDriver'
op|','
string|"'power_off'"
op|','
nl|'\n'
name|'fake_driver_power_off'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'extra'
op|'='
op|'['
string|"'system_metadata'"
op|','
string|"'metadata'"
op|']'
newline|'\n'
name|'inst_obj'
op|'='
name|'instance_obj'
op|'.'
name|'Instance'
op|'.'
name|'get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
name|'expected_attrs'
op|'='
name|'extra'
op|')'
newline|'\n'
name|'inst_obj'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'POWERING_OFF'
newline|'\n'
name|'inst_obj'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'stop_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'inst_obj'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'['
string|"'power_off'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'inst_obj'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_pause
dedent|''
name|'def'
name|'test_pause'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance can be paused and unpaused.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance'
op|')'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
nl|'\n'
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'PAUSING'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'pause_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.pause.start'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.pause.end'"
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'UNPAUSING'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'unpause_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.unpause.start'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.unpause.end'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_suspend
dedent|''
name|'def'
name|'test_suspend'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# ensure instance can be suspended and resumed.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'SUSPENDING'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'suspend_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'RESUMING'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'resume_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_suspend_error
dedent|''
name|'def'
name|'test_suspend_error'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure vm_state is ERROR when suspend error occurs.'
nl|'\n'
DECL|function|fake
indent|'        '
name|'def'
name|'fake'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'suspend'"
op|','
name|'fake'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'suspend_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|','
name|'vm_states'
op|'.'
name|'ERROR'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_suspend_not_implemented
dedent|''
name|'def'
name|'test_suspend_not_implemented'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure expected exception is raised and the vm_state of instance'
nl|'\n'
comment|'# restore to original value if suspend is not implemented by driver'
nl|'\n'
DECL|function|fake
indent|'        '
name|'def'
name|'fake'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'NotImplementedError'
op|'('
string|"'suspend test'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'suspend'"
op|','
name|'fake'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'instance_state'
op|'='
name|'instance'
op|'['
string|"'vm_state'"
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'NotImplementedError'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'suspend_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance_state'
op|','
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild
dedent|''
name|'def'
name|'test_rebuild'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance can be rebuilt.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'image_ref'
op|'='
name|'instance'
op|'['
string|"'image_ref'"
op|']'
newline|'\n'
name|'sys_metadata'
op|'='
name|'db'
op|'.'
name|'instance_system_metadata_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|'"task_state"'
op|':'
name|'task_states'
op|'.'
name|'REBUILDING'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'rebuild_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
nl|'\n'
name|'image_ref'
op|','
name|'image_ref'
op|','
nl|'\n'
name|'injected_files'
op|'='
op|'['
op|']'
op|','
nl|'\n'
name|'new_pass'
op|'='
string|'"new_password"'
op|','
nl|'\n'
name|'orig_sys_metadata'
op|'='
name|'sys_metadata'
op|','
nl|'\n'
name|'bdms'
op|'='
op|'['
op|']'
op|','
name|'recreate'
op|'='
name|'False'
op|','
nl|'\n'
name|'on_shared_storage'
op|'='
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_no_image
dedent|''
name|'def'
name|'test_rebuild_no_image'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance can be rebuilt when started with no image.'
nl|'\n'
indent|'        '
name|'params'
op|'='
op|'{'
string|"'image_ref'"
op|':'
string|"''"
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
name|'params'
op|')'
newline|'\n'
name|'sys_metadata'
op|'='
name|'db'
op|'.'
name|'instance_system_metadata_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|'"task_state"'
op|':'
name|'task_states'
op|'.'
name|'REBUILDING'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'rebuild_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
nl|'\n'
string|"''"
op|','
string|"''"
op|','
name|'injected_files'
op|'='
op|'['
op|']'
op|','
nl|'\n'
name|'new_pass'
op|'='
string|'"new_password"'
op|','
nl|'\n'
name|'orig_sys_metadata'
op|'='
name|'sys_metadata'
op|','
name|'bdms'
op|'='
op|'['
op|']'
op|','
nl|'\n'
name|'recreate'
op|'='
name|'False'
op|','
name|'on_shared_storage'
op|'='
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_launched_at_time
dedent|''
name|'def'
name|'test_rebuild_launched_at_time'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance can be rebuilt.'
nl|'\n'
indent|'        '
name|'old_time'
op|'='
name|'datetime'
op|'.'
name|'datetime'
op|'('
number|'2012'
op|','
number|'4'
op|','
number|'1'
op|')'
newline|'\n'
name|'cur_time'
op|'='
name|'datetime'
op|'.'
name|'datetime'
op|'('
number|'2012'
op|','
number|'12'
op|','
number|'21'
op|','
number|'12'
op|','
number|'21'
op|')'
newline|'\n'
name|'timeutils'
op|'.'
name|'set_time_override'
op|'('
name|'old_time'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'image_ref'
op|'='
name|'instance'
op|'['
string|"'image_ref'"
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'timeutils'
op|'.'
name|'set_time_override'
op|'('
name|'cur_time'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|'"task_state"'
op|':'
name|'task_states'
op|'.'
name|'REBUILDING'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'rebuild_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
nl|'\n'
name|'image_ref'
op|','
name|'image_ref'
op|','
nl|'\n'
name|'injected_files'
op|'='
op|'['
op|']'
op|','
nl|'\n'
name|'new_pass'
op|'='
string|'"new_password"'
op|','
nl|'\n'
name|'orig_sys_metadata'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'bdms'
op|'='
op|'['
op|']'
op|','
name|'recreate'
op|'='
name|'False'
op|','
nl|'\n'
name|'on_shared_storage'
op|'='
name|'False'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|','
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cur_time'
op|','
name|'instance'
op|'['
string|"'launched_at'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_with_injected_files
dedent|''
name|'def'
name|'test_rebuild_with_injected_files'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance can be rebuilt with injected files.'
nl|'\n'
indent|'        '
name|'injected_files'
op|'='
op|'['
nl|'\n'
op|'('
string|"'/a/b/c'"
op|','
name|'base64'
op|'.'
name|'b64encode'
op|'('
string|"'foobarbaz'"
op|')'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'decoded_files'
op|'='
op|'['
nl|'\n'
op|'('
string|"'/a/b/c'"
op|','
string|"'foobarbaz'"
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
DECL|function|_spawn
name|'def'
name|'_spawn'
op|'('
name|'context'
op|','
name|'instance'
op|','
name|'image_meta'
op|','
name|'injected_files'
op|','
nl|'\n'
name|'admin_password'
op|','
name|'network_info'
op|','
name|'block_device_info'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'decoded_files'
op|','
name|'injected_files'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'spawn'"
op|','
name|'_spawn'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'image_ref'
op|'='
name|'instance'
op|'['
string|"'image_ref'"
op|']'
newline|'\n'
name|'sys_metadata'
op|'='
name|'db'
op|'.'
name|'instance_system_metadata_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|'"task_state"'
op|':'
name|'task_states'
op|'.'
name|'REBUILDING'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'rebuild_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
nl|'\n'
name|'image_ref'
op|','
name|'image_ref'
op|','
nl|'\n'
name|'injected_files'
op|'='
name|'injected_files'
op|','
nl|'\n'
name|'new_pass'
op|'='
string|'"new_password"'
op|','
nl|'\n'
name|'orig_sys_metadata'
op|'='
name|'sys_metadata'
op|','
nl|'\n'
name|'bdms'
op|'='
op|'['
op|']'
op|','
name|'recreate'
op|'='
name|'False'
op|','
nl|'\n'
name|'on_shared_storage'
op|'='
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_reboot
dedent|''
name|'def'
name|'_test_reboot'
op|'('
name|'self'
op|','
name|'soft'
op|','
nl|'\n'
name|'test_delete'
op|'='
name|'False'
op|','
name|'test_unrescue'
op|'='
name|'False'
op|','
nl|'\n'
name|'fail_reboot'
op|'='
name|'False'
op|','
name|'fail_running'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
comment|"# This is a true unit test, so we don't need the network stubs."
nl|'\n'
indent|'        '
name|'fake_network'
op|'.'
name|'unset_stub_network_methods'
op|'('
name|'self'
op|'.'
name|'stubs'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_get_instance_volume_block_device_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_instance_nw_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_notify_about_instance_usage'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_instance_update'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'db'
op|','
string|"'instance_update_and_get_original'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_power_state'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'reboot'"
op|')'
newline|'\n'
nl|'\n'
comment|"# FIXME(comstud): I don't feel like the context needs to"
nl|'\n'
comment|'# be elevated at all.  Hopefully remove elevated from'
nl|'\n'
comment|'# reboot_instance and remove the stub here in a future patch.'
nl|'\n'
comment|'# econtext would just become self.context below then.'
nl|'\n'
name|'econtext'
op|'='
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'db_instance'
op|'='
name|'fake_instance'
op|'.'
name|'fake_db_instance'
op|'('
nl|'\n'
op|'**'
name|'dict'
op|'('
name|'uuid'
op|'='
string|"'fake-instance'"
op|','
nl|'\n'
name|'power_state'
op|'='
name|'power_state'
op|'.'
name|'NOSTATE'
op|','
nl|'\n'
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'ACTIVE'
op|','
nl|'\n'
name|'launched_at'
op|'='
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'instance_obj'
op|'.'
name|'Instance'
op|'.'
name|'_from_db_object'
op|'('
nl|'\n'
name|'econtext'
op|','
name|'instance_obj'
op|'.'
name|'Instance'
op|'('
op|')'
op|','
name|'db_instance'
op|')'
newline|'\n'
nl|'\n'
name|'updated_dbinstance1'
op|'='
name|'fake_instance'
op|'.'
name|'fake_db_instance'
op|'('
nl|'\n'
op|'**'
name|'dict'
op|'('
name|'uuid'
op|'='
string|"'updated-instance1'"
op|','
nl|'\n'
name|'power_state'
op|'='
number|'10003'
op|','
nl|'\n'
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'ACTIVE'
op|','
nl|'\n'
name|'launched_at'
op|'='
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'updated_dbinstance2'
op|'='
name|'fake_instance'
op|'.'
name|'fake_db_instance'
op|'('
nl|'\n'
op|'**'
name|'dict'
op|'('
name|'uuid'
op|'='
string|"'updated-instance2'"
op|','
nl|'\n'
name|'power_state'
op|'='
number|'10003'
op|','
nl|'\n'
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'ACTIVE'
op|','
nl|'\n'
name|'launched_at'
op|'='
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'test_unrescue'
op|':'
newline|'\n'
indent|'            '
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|'='
name|'vm_states'
op|'.'
name|'RESCUED'
newline|'\n'
dedent|''
name|'instance'
op|'.'
name|'obj_reset_changes'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'fake_nw_model'
op|'='
name|'network_model'
op|'.'
name|'NetworkInfo'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'fake_block_dev_info'
op|'='
string|"'fake_block_dev_info'"
newline|'\n'
name|'fake_power_state1'
op|'='
number|'10001'
newline|'\n'
name|'fake_power_state2'
op|'='
name|'power_state'
op|'.'
name|'RUNNING'
newline|'\n'
name|'fake_power_state3'
op|'='
number|'10002'
newline|'\n'
name|'reboot_type'
op|'='
name|'soft'
name|'and'
string|"'SOFT'"
name|'or'
string|"'HARD'"
newline|'\n'
nl|'\n'
comment|'# Beginning of calls we expect.'
nl|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'elevated'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'econtext'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instance_volume_block_device_info'
op|'('
nl|'\n'
name|'econtext'
op|','
name|'instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'fake_block_dev_info'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instance_nw_info'
op|'('
name|'econtext'
op|','
nl|'\n'
name|'instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
nl|'\n'
name|'fake_nw_model'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_notify_about_instance_usage'
op|'('
name|'econtext'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
string|"'reboot.start'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_power_state'
op|'('
name|'econtext'
op|','
nl|'\n'
name|'instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'fake_power_state1'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_update_and_get_original'
op|'('
name|'econtext'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|"'power_state'"
op|':'
name|'fake_power_state1'
op|'}'
op|','
nl|'\n'
name|'update_cells'
op|'='
name|'False'
op|','
nl|'\n'
name|'columns_to_join'
op|'='
op|'['
string|"'system_metadata'"
op|']'
nl|'\n'
op|')'
op|'.'
name|'AndReturn'
op|'('
op|'('
name|'None'
op|','
nl|'\n'
name|'updated_dbinstance1'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'expected_nw_info'
op|'='
name|'fake_nw_model'
newline|'\n'
nl|'\n'
comment|'# Annoying.  driver.reboot is wrapped in a try/except, and'
nl|'\n'
comment|"# doesn't re-raise.  It eats exception generated by mox if"
nl|'\n'
comment|'# this is called with the wrong args, so we have to hack'
nl|'\n'
comment|'# around it.'
nl|'\n'
name|'reboot_call_info'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'expected_call_info'
op|'='
op|'{'
nl|'\n'
string|"'args'"
op|':'
op|'('
name|'econtext'
op|','
name|'instance'
op|','
name|'expected_nw_info'
op|','
nl|'\n'
name|'reboot_type'
op|')'
op|','
nl|'\n'
string|"'kwargs'"
op|':'
op|'{'
string|"'block_device_info'"
op|':'
name|'fake_block_dev_info'
op|'}'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_reboot
name|'def'
name|'fake_reboot'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'reboot_call_info'
op|'['
string|"'args'"
op|']'
op|'='
name|'args'
newline|'\n'
name|'reboot_call_info'
op|'['
string|"'kwargs'"
op|']'
op|'='
name|'kwargs'
newline|'\n'
nl|'\n'
comment|'# NOTE(sirp): Since `bad_volumes_callback` is a function defined'
nl|'\n'
comment|"# within `reboot_instance`, we don't have access to its value and"
nl|'\n'
comment|"# can't stub it out, thus we skip that comparison."
nl|'\n'
name|'kwargs'
op|'.'
name|'pop'
op|'('
string|"'bad_volumes_callback'"
op|')'
newline|'\n'
name|'if'
name|'fail_reboot'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
string|"'instance-0000'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'reboot'"
op|','
name|'fake_reboot'
op|')'
newline|'\n'
nl|'\n'
comment|'# Power state should be updated again'
nl|'\n'
name|'if'
name|'not'
name|'fail_reboot'
name|'or'
name|'fail_running'
op|':'
newline|'\n'
indent|'            '
name|'new_power_state'
op|'='
name|'fake_power_state2'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_power_state'
op|'('
name|'econtext'
op|','
nl|'\n'
name|'instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'fake_power_state2'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'new_power_state'
op|'='
name|'fake_power_state3'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_power_state'
op|'('
name|'econtext'
op|','
nl|'\n'
name|'instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'fake_power_state3'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'test_delete'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'instance_update_and_get_original'
op|'('
nl|'\n'
name|'econtext'
op|','
name|'updated_dbinstance1'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|"'power_state'"
op|':'
name|'new_power_state'
op|','
nl|'\n'
string|"'task_state'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'ACTIVE'
op|'}'
op|','
nl|'\n'
name|'update_cells'
op|'='
name|'False'
op|','
nl|'\n'
name|'columns_to_join'
op|'='
op|'['
string|"'system_metadata'"
op|']'
op|','
nl|'\n'
op|')'
op|'.'
name|'AndRaise'
op|'('
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
nl|'\n'
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_notify_about_instance_usage'
op|'('
nl|'\n'
name|'econtext'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
string|"'reboot.end'"
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'fail_reboot'
name|'and'
name|'not'
name|'fail_running'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'instance_update_and_get_original'
op|'('
nl|'\n'
name|'econtext'
op|','
name|'updated_dbinstance1'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'ERROR'
op|'}'
op|','
nl|'\n'
name|'update_cells'
op|'='
name|'False'
op|','
nl|'\n'
name|'columns_to_join'
op|'='
op|'['
string|"'system_metadata'"
op|']'
op|','
nl|'\n'
op|')'
op|'.'
name|'AndRaise'
op|'('
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
nl|'\n'
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'instance_update_and_get_original'
op|'('
nl|'\n'
name|'econtext'
op|','
name|'updated_dbinstance1'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|"'power_state'"
op|':'
name|'new_power_state'
op|','
nl|'\n'
string|"'task_state'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'ACTIVE'
op|'}'
op|','
nl|'\n'
name|'update_cells'
op|'='
name|'False'
op|','
nl|'\n'
name|'columns_to_join'
op|'='
op|'['
string|"'system_metadata'"
op|']'
op|','
nl|'\n'
op|')'
op|'.'
name|'AndReturn'
op|'('
op|'('
name|'None'
op|','
name|'updated_dbinstance2'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_notify_about_instance_usage'
op|'('
nl|'\n'
name|'econtext'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
string|"'reboot.end'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'not'
name|'fail_reboot'
name|'or'
name|'fail_running'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'compute'
op|'.'
name|'reboot_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'block_device_info'
op|'='
name|'None'
op|','
nl|'\n'
name|'reboot_type'
op|'='
name|'reboot_type'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceNotFound'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'reboot_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'block_device_info'
op|'='
name|'None'
op|','
nl|'\n'
name|'reboot_type'
op|'='
name|'reboot_type'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected_call_info'
op|','
name|'reboot_call_info'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reboot_soft
dedent|''
name|'def'
name|'test_reboot_soft'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_reboot'
op|'('
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reboot_soft_and_delete
dedent|''
name|'def'
name|'test_reboot_soft_and_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_reboot'
op|'('
name|'True'
op|','
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reboot_soft_and_rescued
dedent|''
name|'def'
name|'test_reboot_soft_and_rescued'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_reboot'
op|'('
name|'True'
op|','
name|'False'
op|','
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reboot_soft_and_delete_and_rescued
dedent|''
name|'def'
name|'test_reboot_soft_and_delete_and_rescued'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_reboot'
op|'('
name|'True'
op|','
name|'True'
op|','
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reboot_hard
dedent|''
name|'def'
name|'test_reboot_hard'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_reboot'
op|'('
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reboot_hard_and_delete
dedent|''
name|'def'
name|'test_reboot_hard_and_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_reboot'
op|'('
name|'False'
op|','
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reboot_hard_and_rescued
dedent|''
name|'def'
name|'test_reboot_hard_and_rescued'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_reboot'
op|'('
name|'False'
op|','
name|'False'
op|','
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reboot_hard_and_delete_and_rescued
dedent|''
name|'def'
name|'test_reboot_hard_and_delete_and_rescued'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_reboot'
op|'('
name|'False'
op|','
name|'True'
op|','
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reboot_fail
dedent|''
name|'def'
name|'test_reboot_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_reboot'
op|'('
name|'False'
op|','
name|'fail_reboot'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reboot_fail_running
dedent|''
name|'def'
name|'test_reboot_fail_running'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_reboot'
op|'('
name|'False'
op|','
name|'fail_reboot'
op|'='
name|'True'
op|','
nl|'\n'
name|'fail_running'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_instance_volume_block_device_info_source_image
dedent|''
name|'def'
name|'test_get_instance_volume_block_device_info_source_image'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|_fake_get_instance_volume_bdms
indent|'        '
name|'def'
name|'_fake_get_instance_volume_bdms'
op|'('
name|'context'
op|','
name|'instance'
op|','
name|'legacy'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'bdms'
op|'='
op|'['
op|'{'
nl|'\n'
string|"'id'"
op|':'
number|'3'
op|','
nl|'\n'
string|"'volume_id'"
op|':'
string|"u'4cbc9e62-6ba0-45dd-b647-934942ead7d6'"
op|','
nl|'\n'
string|"'instance_uuid'"
op|':'
string|"'fake-instance'"
op|','
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/vda'"
op|','
nl|'\n'
string|"'connection_info'"
op|':'
string|'\'{"driver_volume_type": "rbd"}\''
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'image'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'image_id'"
op|':'
string|"'fake-image-id-1'"
op|','
nl|'\n'
string|"'boot_index'"
op|':'
number|'0'
nl|'\n'
op|'}'
op|']'
newline|'\n'
nl|'\n'
name|'return'
name|'bdms'
newline|'\n'
nl|'\n'
dedent|''
name|'with'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_instance_volume_bdms'"
op|','
nl|'\n'
name|'_fake_get_instance_volume_bdms'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'block_device_info'
op|'='
op|'('
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instance_volume_block_device_info'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
nl|'\n'
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'block_device_mapping'"
op|':'
op|'['
op|'{'
nl|'\n'
string|"'connection_info'"
op|':'
op|'{'
nl|'\n'
string|"'driver_volume_type'"
op|':'
string|"'rbd'"
nl|'\n'
op|'}'
op|','
nl|'\n'
string|"'mount_device'"
op|':'
string|"'/dev/vda'"
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'None'
nl|'\n'
op|'}'
op|']'
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'block_device_info'
op|','
name|'expected'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_set_admin_password
dedent|''
dedent|''
name|'def'
name|'test_set_admin_password'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance can have its admin password set.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|"'task_state'"
op|':'
name|'task_states'
op|'.'
name|'UPDATING_PASSWORD'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'inst_ref'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'inst_ref'
op|'['
string|"'vm_state'"
op|']'
op|','
name|'vm_states'
op|'.'
name|'ACTIVE'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'inst_ref'
op|'['
string|"'task_state'"
op|']'
op|','
name|'task_states'
op|'.'
name|'UPDATING_PASSWORD'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'set_admin_password'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'inst_ref'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'inst_ref'
op|'['
string|"'vm_state'"
op|']'
op|','
name|'vm_states'
op|'.'
name|'ACTIVE'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'inst_ref'
op|'['
string|"'task_state'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'inst_ref'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_set_admin_password_bad_state
dedent|''
name|'def'
name|'test_set_admin_password_bad_state'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test setting password while instance is rebuilding.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
op|'{'
nl|'\n'
string|'"power_state"'
op|':'
name|'power_state'
op|'.'
name|'NOSTATE'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'power_state'"
op|']'
op|','
name|'power_state'
op|'.'
name|'NOSTATE'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_driver_get_info
name|'def'
name|'fake_driver_get_info'
op|'('
name|'self2'
op|','
name|'_instance'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'state'"
op|':'
name|'power_state'
op|'.'
name|'NOSTATE'
op|','
nl|'\n'
string|"'max_mem'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'mem'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'num_cpu'"
op|':'
number|'2'
op|','
nl|'\n'
string|"'cpu_time'"
op|':'
number|'0'
op|'}'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'fake'
op|'.'
name|'FakeDriver'
op|','
string|"'get_info'"
op|','
nl|'\n'
name|'fake_driver_get_info'
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|'"task_state"'
op|':'
name|'task_states'
op|'.'
name|'UPDATING_PASSWORD'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstancePasswordSetFailed'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'set_admin_password'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_do_test_set_admin_password_driver_error
dedent|''
name|'def'
name|'_do_test_set_admin_password_driver_error'
op|'('
name|'self'
op|','
name|'exc'
op|','
name|'expected_vm_state'
op|','
nl|'\n'
name|'expected_task_state'
op|','
nl|'\n'
name|'expected_exception'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Ensure expected exception is raised if set_admin_password fails."""'
newline|'\n'
nl|'\n'
DECL|function|fake_sleep
name|'def'
name|'fake_sleep'
op|'('
name|'_time'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'time'
op|','
string|"'sleep'"
op|','
name|'fake_sleep'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_driver_set_pass
name|'def'
name|'fake_driver_set_pass'
op|'('
name|'self2'
op|','
name|'_instance'
op|','
name|'_pwd'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exc'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'fake'
op|'.'
name|'FakeDriver'
op|','
string|"'set_admin_password'"
op|','
nl|'\n'
name|'fake_driver_set_pass'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|"'task_state'"
op|':'
name|'task_states'
op|'.'
name|'UPDATING_PASSWORD'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'inst_ref'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'inst_ref'
op|'['
string|"'vm_state'"
op|']'
op|','
name|'vm_states'
op|'.'
name|'ACTIVE'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'inst_ref'
op|'['
string|"'task_state'"
op|']'
op|','
name|'task_states'
op|'.'
name|'UPDATING_PASSWORD'
op|')'
newline|'\n'
nl|'\n'
comment|'#error raised from the driver should not reveal internal information'
nl|'\n'
comment|'#so a new error is raised'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'expected_exception'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'set_admin_password'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'inst_ref'
op|')'
op|','
nl|'\n'
name|'new_pass'
op|'='
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'inst_ref'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'inst_ref'
op|'['
string|"'vm_state'"
op|']'
op|','
name|'expected_vm_state'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'inst_ref'
op|'['
string|"'task_state'"
op|']'
op|','
name|'expected_task_state'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'inst_ref'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_set_admin_password_driver_not_authorized
dedent|''
name|'def'
name|'test_set_admin_password_driver_not_authorized'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Ensure expected exception is raised if set_admin_password not\n        authorized.\n        """'
newline|'\n'
name|'exc'
op|'='
name|'exception'
op|'.'
name|'NotAuthorized'
op|'('
name|'_'
op|'('
string|"'Internal error'"
op|')'
op|')'
newline|'\n'
name|'expected_exception'
op|'='
name|'exception'
op|'.'
name|'InstancePasswordSetFailed'
newline|'\n'
name|'self'
op|'.'
name|'_do_test_set_admin_password_driver_error'
op|'('
name|'exc'
op|','
nl|'\n'
name|'vm_states'
op|'.'
name|'ERROR'
op|','
nl|'\n'
name|'None'
op|','
nl|'\n'
name|'expected_exception'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_set_admin_password_driver_not_implemented
dedent|''
name|'def'
name|'test_set_admin_password_driver_not_implemented'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Ensure expected exception is raised if set_admin_password not\n        implemented by driver.\n        """'
newline|'\n'
name|'exc'
op|'='
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
name|'expected_exception'
op|'='
name|'NotImplementedError'
newline|'\n'
name|'self'
op|'.'
name|'_do_test_set_admin_password_driver_error'
op|'('
name|'exc'
op|','
nl|'\n'
name|'vm_states'
op|'.'
name|'ACTIVE'
op|','
nl|'\n'
name|'None'
op|','
nl|'\n'
name|'expected_exception'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_inject_file
dedent|''
name|'def'
name|'test_inject_file'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure we can write a file to an instance.'
nl|'\n'
indent|'        '
name|'called'
op|'='
op|'{'
string|"'inject'"
op|':'
name|'False'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_driver_inject_file
name|'def'
name|'fake_driver_inject_file'
op|'('
name|'self2'
op|','
name|'instance'
op|','
name|'path'
op|','
name|'contents'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'path'
op|','
string|'"/tmp/test"'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'contents'
op|','
string|'"File Contents"'
op|')'
newline|'\n'
name|'called'
op|'['
string|"'inject'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'fake'
op|'.'
name|'FakeDriver'
op|','
string|"'inject_file'"
op|','
nl|'\n'
name|'fake_driver_inject_file'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'inject_file'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|'"/tmp/test"'
op|','
nl|'\n'
string|'"File Contents"'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'['
string|"'inject'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_inject_network_info
dedent|''
name|'def'
name|'test_inject_network_info'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure we can inject network info.'
nl|'\n'
indent|'        '
name|'called'
op|'='
op|'{'
string|"'inject'"
op|':'
name|'False'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_driver_inject_network
name|'def'
name|'fake_driver_inject_network'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'inject'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'fake'
op|'.'
name|'FakeDriver'
op|','
string|"'inject_network_info'"
op|','
nl|'\n'
name|'fake_driver_inject_network'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'inst_obj'
op|'='
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'inject_network_info'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'inst_obj'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'['
string|"'inject'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reset_network
dedent|''
name|'def'
name|'test_reset_network'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure we can reset networking on an instance.'
nl|'\n'
indent|'        '
name|'called'
op|'='
op|'{'
string|"'count'"
op|':'
number|'0'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_driver_reset_network
name|'def'
name|'fake_driver_reset_network'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'count'"
op|']'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'fake'
op|'.'
name|'FakeDriver'
op|','
string|"'reset_network'"
op|','
nl|'\n'
name|'fake_driver_reset_network'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'reset_network'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'called'
op|'['
string|"'count'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_snapshotting_instance
dedent|''
name|'def'
name|'_get_snapshotting_instance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance can be snapshotted.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_update'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|'"task_state"'
op|':'
name|'task_states'
op|'.'
name|'IMAGE_SNAPSHOT_PENDING'
op|'}'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_snapshot
dedent|''
name|'def'
name|'test_snapshot'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'inst_obj'
op|'='
name|'self'
op|'.'
name|'_get_snapshotting_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'snapshot_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'image_id'
op|'='
string|"'fakesnap'"
op|','
nl|'\n'
name|'instance'
op|'='
name|'inst_obj'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_snapshot_no_image
dedent|''
name|'def'
name|'test_snapshot_no_image'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'inst_obj'
op|'='
name|'self'
op|'.'
name|'_get_snapshotting_instance'
op|'('
op|')'
newline|'\n'
name|'inst_obj'
op|'.'
name|'image_ref'
op|'='
string|"''"
newline|'\n'
name|'inst_obj'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'snapshot_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'image_id'
op|'='
string|"'fakesnap'"
op|','
nl|'\n'
name|'instance'
op|'='
name|'inst_obj'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_snapshot_fails
dedent|''
name|'def'
name|'_test_snapshot_fails'
op|'('
name|'self'
op|','
name|'raise_during_cleanup'
op|')'
op|':'
newline|'\n'
DECL|function|fake_snapshot
indent|'        '
name|'def'
name|'fake_snapshot'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'fake_image_delete_called'
op|'='
name|'False'
newline|'\n'
nl|'\n'
DECL|function|fake_delete
name|'def'
name|'fake_delete'
op|'('
name|'self_'
op|','
name|'context'
op|','
name|'image_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'fake_image_delete_called'
op|'='
name|'True'
newline|'\n'
name|'if'
name|'raise_during_cleanup'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'Exception'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'snapshot'"
op|','
name|'fake_snapshot'
op|')'
newline|'\n'
name|'fake_image'
op|'.'
name|'stub_out_image_service'
op|'('
name|'self'
op|'.'
name|'stubs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'delete'"
op|','
name|'fake_delete'
op|')'
newline|'\n'
nl|'\n'
name|'inst_obj'
op|'='
name|'self'
op|'.'
name|'_get_snapshotting_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'snapshot_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'image_id'
op|'='
string|"'fakesnap'"
op|','
nl|'\n'
name|'instance'
op|'='
name|'inst_obj'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'self'
op|'.'
name|'fake_image_delete_called'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_assert_state'
op|'('
op|'{'
string|"'task_state'"
op|':'
name|'None'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_snapshot_fails
dedent|''
name|'def'
name|'test_snapshot_fails'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_snapshot_fails'
op|'('
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_snapshot_fails_cleanup_ignores_exception
dedent|''
name|'def'
name|'test_snapshot_fails_cleanup_ignores_exception'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_snapshot_fails'
op|'('
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_snapshot_handles_cases_when_instance_is_deleted
dedent|''
name|'def'
name|'test_snapshot_handles_cases_when_instance_is_deleted'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'inst_obj'
op|'='
name|'self'
op|'.'
name|'_get_snapshotting_instance'
op|'('
op|')'
newline|'\n'
name|'inst_obj'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'DELETING'
newline|'\n'
name|'inst_obj'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'snapshot_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'image_id'
op|'='
string|"'fakesnap'"
op|','
nl|'\n'
name|'instance'
op|'='
name|'inst_obj'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_snapshot_handles_cases_when_instance_is_not_found
dedent|''
name|'def'
name|'test_snapshot_handles_cases_when_instance_is_not_found'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'inst_obj'
op|'='
name|'self'
op|'.'
name|'_get_snapshotting_instance'
op|'('
op|')'
newline|'\n'
name|'inst_obj2'
op|'='
name|'instance_obj'
op|'.'
name|'Instance'
op|'.'
name|'get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'inst_obj'
op|'.'
name|'uuid'
op|')'
newline|'\n'
name|'inst_obj2'
op|'.'
name|'destroy'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'snapshot_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'image_id'
op|'='
string|"'fakesnap'"
op|','
nl|'\n'
name|'instance'
op|'='
name|'inst_obj'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_assert_state
dedent|''
name|'def'
name|'_assert_state'
op|'('
name|'self'
op|','
name|'state_dict'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Assert state of VM is equal to state passed as parameter."""'
newline|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'if'
string|"'vm_state'"
name|'in'
name|'state_dict'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'state_dict'
op|'['
string|"'vm_state'"
op|']'
op|','
name|'instances'
op|'['
number|'0'
op|']'
op|'['
string|"'vm_state'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'if'
string|"'task_state'"
name|'in'
name|'state_dict'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'state_dict'
op|'['
string|"'task_state'"
op|']'
op|','
nl|'\n'
name|'instances'
op|'['
number|'0'
op|']'
op|'['
string|"'task_state'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'if'
string|"'power_state'"
name|'in'
name|'state_dict'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'state_dict'
op|'['
string|"'power_state'"
op|']'
op|','
nl|'\n'
name|'instances'
op|'['
number|'0'
op|']'
op|'['
string|"'power_state'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_console_output
dedent|''
dedent|''
name|'def'
name|'test_console_output'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure we can get console output from instance.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'output'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'get_console_output'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|','
name|'tail_length'
op|'='
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'output'
op|','
string|"'FAKE CONSOLE OUTPUT\\nANOTHER\\nLAST LINE'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_console_output_tail
dedent|''
name|'def'
name|'test_console_output_tail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure we can get console output from instance.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'output'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'get_console_output'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|','
name|'tail_length'
op|'='
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'output'
op|','
string|"'ANOTHER\\nLAST LINE'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_novnc_vnc_console
dedent|''
name|'def'
name|'test_novnc_vnc_console'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure we can a vnc console for an instance.'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'vnc_enabled'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'enabled'
op|'='
name|'False'
op|','
name|'group'
op|'='
string|"'spice'"
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
comment|'# Try with the full instance'
nl|'\n'
name|'console'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'get_vnc_console'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'novnc'"
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'console'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_validate_console_port_vnc
dedent|''
name|'def'
name|'test_validate_console_port_vnc'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'vnc_enabled'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'enabled'
op|'='
name|'True'
op|','
name|'group'
op|'='
string|"'spice'"
op|')'
newline|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_driver_get_console
name|'def'
name|'fake_driver_get_console'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'host'"
op|':'
string|'"fake_host"'
op|','
string|"'port'"
op|':'
string|'"5900"'
op|','
nl|'\n'
string|"'internal_access_path'"
op|':'
name|'None'
op|'}'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|'"get_vnc_console"'
op|','
nl|'\n'
name|'fake_driver_get_console'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'validate_console_port'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
string|'"5900"'
op|','
nl|'\n'
string|'"novnc"'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_validate_console_port_spice
dedent|''
name|'def'
name|'test_validate_console_port_spice'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'vnc_enabled'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'enabled'
op|'='
name|'True'
op|','
name|'group'
op|'='
string|"'spice'"
op|')'
newline|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_driver_get_console
name|'def'
name|'fake_driver_get_console'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'host'"
op|':'
string|'"fake_host"'
op|','
string|"'port'"
op|':'
string|'"5900"'
op|','
nl|'\n'
string|"'internal_access_path'"
op|':'
name|'None'
op|'}'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|'"get_spice_console"'
op|','
nl|'\n'
name|'fake_driver_get_console'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'validate_console_port'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
string|'"5900"'
op|','
nl|'\n'
string|'"spice-html5"'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_validate_console_port_wrong_port
dedent|''
name|'def'
name|'test_validate_console_port_wrong_port'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'vnc_enabled'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'enabled'
op|'='
name|'True'
op|','
name|'group'
op|'='
string|"'spice'"
op|')'
newline|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_driver_get_console
name|'def'
name|'fake_driver_get_console'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'host'"
op|':'
string|'"fake_host"'
op|','
string|"'port'"
op|':'
string|'"5900"'
op|','
nl|'\n'
string|"'internal_access_path'"
op|':'
name|'None'
op|'}'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|'"get_vnc_console"'
op|','
nl|'\n'
name|'fake_driver_get_console'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'validate_console_port'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
string|'"wrongport"'
op|','
nl|'\n'
string|'"spice-html5"'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_xvpvnc_vnc_console
dedent|''
name|'def'
name|'test_xvpvnc_vnc_console'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure we can a vnc console for an instance.'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'vnc_enabled'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'enabled'
op|'='
name|'False'
op|','
name|'group'
op|'='
string|"'spice'"
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'console'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'get_vnc_console'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'xvpvnc'"
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'console'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_invalid_vnc_console_type
dedent|''
name|'def'
name|'test_invalid_vnc_console_type'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Raise useful error if console type is an unrecognised string.'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'vnc_enabled'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'enabled'
op|'='
name|'False'
op|','
name|'group'
op|'='
string|"'spice'"
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'rpc_common'
op|'.'
name|'ClientException'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'get_vnc_console'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
string|"'invalid'"
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'='
name|'utils'
op|'.'
name|'ExceptionHelper'
op|'('
name|'self'
op|'.'
name|'compute'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'ConsoleTypeInvalid'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'get_vnc_console'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
string|"'invalid'"
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_missing_vnc_console_type
dedent|''
name|'def'
name|'test_missing_vnc_console_type'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Raise useful error is console type is None.'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'vnc_enabled'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'enabled'
op|'='
name|'False'
op|','
name|'group'
op|'='
string|"'spice'"
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'rpc_common'
op|'.'
name|'ClientException'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'get_vnc_console'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'None'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'='
name|'utils'
op|'.'
name|'ExceptionHelper'
op|'('
name|'self'
op|'.'
name|'compute'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'ConsoleTypeInvalid'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'get_vnc_console'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'None'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_spicehtml5_spice_console
dedent|''
name|'def'
name|'test_spicehtml5_spice_console'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure we can a spice console for an instance.'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'vnc_enabled'
op|'='
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'enabled'
op|'='
name|'True'
op|','
name|'group'
op|'='
string|"'spice'"
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance'
op|')'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
comment|'# Try with the full instance'
nl|'\n'
name|'console'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'get_spice_console'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'spice-html5'"
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'console'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_invalid_spice_console_type
dedent|''
name|'def'
name|'test_invalid_spice_console_type'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Raise useful error if console type is an unrecognised string'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'vnc_enabled'
op|'='
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'enabled'
op|'='
name|'True'
op|','
name|'group'
op|'='
string|"'spice'"
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance'
op|')'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'rpc_common'
op|'.'
name|'ClientException'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'get_spice_console'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
string|"'invalid'"
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'='
name|'utils'
op|'.'
name|'ExceptionHelper'
op|'('
name|'self'
op|'.'
name|'compute'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'ConsoleTypeInvalid'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'get_spice_console'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
string|"'invalid'"
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_missing_spice_console_type
dedent|''
name|'def'
name|'test_missing_spice_console_type'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Raise useful error is console type is None'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'vnc_enabled'
op|'='
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'enabled'
op|'='
name|'True'
op|','
name|'group'
op|'='
string|"'spice'"
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance'
op|')'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'rpc_common'
op|'.'
name|'ClientException'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'get_spice_console'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'None'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'='
name|'utils'
op|'.'
name|'ExceptionHelper'
op|'('
name|'self'
op|'.'
name|'compute'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'ConsoleTypeInvalid'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'get_spice_console'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'None'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_vnc_console_instance_not_ready
dedent|''
name|'def'
name|'test_vnc_console_instance_not_ready'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'vnc_enabled'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'enabled'
op|'='
name|'False'
op|','
name|'group'
op|'='
string|"'spice'"
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
name|'params'
op|'='
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'BUILDING'
op|'}'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_driver_get_console
name|'def'
name|'fake_driver_get_console'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|'"get_vnc_console"'
op|','
nl|'\n'
name|'fake_driver_get_console'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'='
name|'utils'
op|'.'
name|'ExceptionHelper'
op|'('
name|'self'
op|'.'
name|'compute'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceNotReady'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'get_vnc_console'
op|','
name|'self'
op|'.'
name|'context'
op|','
string|"'novnc'"
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_spice_console_instance_not_ready
dedent|''
name|'def'
name|'test_spice_console_instance_not_ready'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'vnc_enabled'
op|'='
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'enabled'
op|'='
name|'True'
op|','
name|'group'
op|'='
string|"'spice'"
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
nl|'\n'
name|'params'
op|'='
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'BUILDING'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_driver_get_console
name|'def'
name|'fake_driver_get_console'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|'"get_spice_console"'
op|','
nl|'\n'
name|'fake_driver_get_console'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'='
name|'utils'
op|'.'
name|'ExceptionHelper'
op|'('
name|'self'
op|'.'
name|'compute'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceNotReady'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'get_spice_console'
op|','
name|'self'
op|'.'
name|'context'
op|','
string|"'spice-html5'"
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_diagnostics
dedent|''
name|'def'
name|'test_diagnostics'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure we can get diagnostics for an instance.'
nl|'\n'
indent|'        '
name|'expected_diagnostic'
op|'='
op|'{'
string|"'cpu0_time'"
op|':'
number|'17300000000'
op|','
nl|'\n'
string|"'memory'"
op|':'
number|'524288'
op|','
nl|'\n'
string|"'vda_errors'"
op|':'
op|'-'
number|'1'
op|','
nl|'\n'
string|"'vda_read'"
op|':'
number|'262144'
op|','
nl|'\n'
string|"'vda_read_req'"
op|':'
number|'112'
op|','
nl|'\n'
string|"'vda_write'"
op|':'
number|'5778432'
op|','
nl|'\n'
string|"'vda_write_req'"
op|':'
number|'488'
op|','
nl|'\n'
string|"'vnet1_rx'"
op|':'
number|'2070139'
op|','
nl|'\n'
string|"'vnet1_rx_drop'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'vnet1_rx_errors'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'vnet1_rx_packets'"
op|':'
number|'26701'
op|','
nl|'\n'
string|"'vnet1_tx'"
op|':'
number|'140208'
op|','
nl|'\n'
string|"'vnet1_tx_drop'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'vnet1_tx_errors'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'vnet1_tx_packets'"
op|':'
number|'662'
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'diagnostics'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'get_diagnostics'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'diagnostics'
op|','
name|'expected_diagnostic'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_fixed_ip_usage_notification
dedent|''
name|'def'
name|'test_add_fixed_ip_usage_notification'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|dummy
indent|'        '
name|'def'
name|'dummy'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'network_api'
op|'.'
name|'API'
op|','
string|"'add_fixed_ip_to_instance'"
op|','
nl|'\n'
name|'dummy'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'compute'
op|'.'
name|'manager'
op|'.'
name|'ComputeManager'
op|','
nl|'\n'
string|"'inject_network_info'"
op|','
name|'dummy'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'compute'
op|'.'
name|'manager'
op|'.'
name|'ComputeManager'
op|','
nl|'\n'
string|"'reset_network'"
op|','
name|'dummy'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'add_fixed_ip_to_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'network_id'
op|'='
number|'1'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_fixed_ip_usage_notification
dedent|''
name|'def'
name|'test_remove_fixed_ip_usage_notification'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|dummy
indent|'        '
name|'def'
name|'dummy'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'network_api'
op|'.'
name|'API'
op|','
string|"'remove_fixed_ip_from_instance'"
op|','
nl|'\n'
name|'dummy'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'compute'
op|'.'
name|'manager'
op|'.'
name|'ComputeManager'
op|','
nl|'\n'
string|"'inject_network_info'"
op|','
name|'dummy'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'compute'
op|'.'
name|'manager'
op|'.'
name|'ComputeManager'
op|','
nl|'\n'
string|"'reset_network'"
op|','
name|'dummy'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'remove_fixed_ip_from_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
number|'1'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_instance_usage_notification
dedent|''
name|'def'
name|'test_run_instance_usage_notification'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure run instance generates appropriate usage notification.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'inst_ref'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
string|"'compute.instance.create.start'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'payload'
op|'['
string|"'image_name'"
op|']'
op|','
string|"'fake_name'"
op|')'
newline|'\n'
comment|'# The last event is the one with the sugar in it.'
nl|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'priority'
op|','
string|"'INFO'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
string|"'compute.instance.create.end'"
op|')'
newline|'\n'
name|'payload'
op|'='
name|'msg'
op|'.'
name|'payload'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'tenant_id'"
op|']'
op|','
name|'self'
op|'.'
name|'project_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'image_name'"
op|']'
op|','
string|"'fake_name'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'user_id'"
op|']'
op|','
name|'self'
op|'.'
name|'user_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'instance_id'"
op|']'
op|','
name|'inst_ref'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'instance_type'"
op|']'
op|','
string|"'m1.tiny'"
op|')'
newline|'\n'
name|'type_id'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
string|"'m1.tiny'"
op|')'
op|'['
string|"'id'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'payload'
op|'['
string|"'instance_type_id'"
op|']'
op|')'
op|','
name|'str'
op|'('
name|'type_id'
op|')'
op|')'
newline|'\n'
name|'flavor_id'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
string|"'m1.tiny'"
op|')'
op|'['
string|"'flavorid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'payload'
op|'['
string|"'instance_flavor_id'"
op|']'
op|')'
op|','
name|'str'
op|'('
name|'flavor_id'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'state'"
op|']'
op|','
string|"'active'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'display_name'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'created_at'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'launched_at'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'fixed_ips'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'payload'
op|'['
string|"'launched_at'"
op|']'
op|')'
newline|'\n'
name|'image_ref_url'
op|'='
name|'glance'
op|'.'
name|'generate_image_url'
op|'('
name|'FAKE_IMAGE_REF'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'image_ref_url'"
op|']'
op|','
name|'image_ref_url'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'Success'"
op|','
name|'payload'
op|'['
string|"'message'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'inst_ref'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_instance_end_notification_on_abort
dedent|''
name|'def'
name|'test_run_instance_end_notification_on_abort'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test that an end notif is sent if the build is aborted'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
nl|'\n'
DECL|function|build_inst_abort
name|'def'
name|'build_inst_abort'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'BuildAbortException'
op|'('
name|'reason'
op|'='
string|'"already deleted"'
op|','
nl|'\n'
name|'instance_uuid'
op|'='
name|'instance_uuid'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_build_instance'"
op|','
name|'build_inst_abort'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
string|"'compute.instance.create.start'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
string|"'compute.instance.create.end'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'INFO'"
op|','
name|'msg'
op|'.'
name|'priority'
op|')'
newline|'\n'
name|'payload'
op|'='
name|'msg'
op|'.'
name|'payload'
newline|'\n'
name|'message'
op|'='
name|'payload'
op|'['
string|"'message'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'message'
op|'.'
name|'find'
op|'('
string|'"already deleted"'
op|')'
op|'!='
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_instance_error_notification_on_reschedule
dedent|''
name|'def'
name|'test_run_instance_error_notification_on_reschedule'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test that error notif is sent if the build got rescheduled'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
nl|'\n'
DECL|function|build_inst_fail
name|'def'
name|'build_inst_fail'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'RescheduledException'
op|'('
name|'instance_uuid'
op|'='
name|'instance_uuid'
op|','
nl|'\n'
name|'reason'
op|'='
string|'"something bad happened"'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_build_instance'"
op|','
name|'build_inst_fail'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|'>='
number|'2'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
string|"'compute.instance.create.start'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
string|"'compute.instance.create.error'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'ERROR'"
op|','
name|'msg'
op|'.'
name|'priority'
op|')'
newline|'\n'
name|'payload'
op|'='
name|'msg'
op|'.'
name|'payload'
newline|'\n'
name|'message'
op|'='
name|'payload'
op|'['
string|"'message'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'message'
op|'.'
name|'find'
op|'('
string|'"something bad happened"'
op|')'
op|'!='
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_instance_error_notification_on_failure
dedent|''
name|'def'
name|'test_run_instance_error_notification_on_failure'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test that error notif is sent if build fails hard'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|build_inst_fail
name|'def'
name|'build_inst_fail'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
string|'"i\'m dying"'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_build_instance'"
op|','
name|'build_inst_fail'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
nl|'\n'
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|'>='
number|'2'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
string|"'compute.instance.create.start'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
string|"'compute.instance.create.error'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'ERROR'"
op|','
name|'msg'
op|'.'
name|'priority'
op|')'
newline|'\n'
name|'payload'
op|'='
name|'msg'
op|'.'
name|'payload'
newline|'\n'
name|'message'
op|'='
name|'payload'
op|'['
string|"'message'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'message'
op|'.'
name|'find'
op|'('
string|'"i\'m dying"'
op|')'
op|'!='
op|'-'
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_terminate_usage_notification
dedent|''
name|'def'
name|'test_terminate_usage_notification'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure terminate_instance generates correct usage notification.'
nl|'\n'
indent|'        '
name|'old_time'
op|'='
name|'datetime'
op|'.'
name|'datetime'
op|'('
number|'2012'
op|','
number|'4'
op|','
number|'1'
op|')'
newline|'\n'
name|'cur_time'
op|'='
name|'datetime'
op|'.'
name|'datetime'
op|'('
number|'2012'
op|','
number|'12'
op|','
number|'21'
op|','
number|'12'
op|','
number|'21'
op|')'
newline|'\n'
name|'timeutils'
op|'.'
name|'set_time_override'
op|'('
name|'old_time'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
name|'timeutils'
op|'.'
name|'set_time_override'
op|'('
name|'cur_time'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'4'
op|')'
newline|'\n'
nl|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'priority'
op|','
string|"'INFO'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
string|"'compute.instance.delete.start'"
op|')'
newline|'\n'
name|'msg1'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg1'
op|'.'
name|'event_type'
op|','
string|"'compute.instance.shutdown.start'"
op|')'
newline|'\n'
name|'msg1'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'2'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg1'
op|'.'
name|'event_type'
op|','
string|"'compute.instance.shutdown.end'"
op|')'
newline|'\n'
name|'msg1'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'3'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg1'
op|'.'
name|'event_type'
op|','
string|"'compute.instance.delete.end'"
op|')'
newline|'\n'
name|'payload'
op|'='
name|'msg1'
op|'.'
name|'payload'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'tenant_id'"
op|']'
op|','
name|'self'
op|'.'
name|'project_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'user_id'"
op|']'
op|','
name|'self'
op|'.'
name|'user_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'instance_id'"
op|']'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'instance_type'"
op|']'
op|','
string|"'m1.tiny'"
op|')'
newline|'\n'
name|'type_id'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
string|"'m1.tiny'"
op|')'
op|'['
string|"'id'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'payload'
op|'['
string|"'instance_type_id'"
op|']'
op|')'
op|','
name|'str'
op|'('
name|'type_id'
op|')'
op|')'
newline|'\n'
name|'flavor_id'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
string|"'m1.tiny'"
op|')'
op|'['
string|"'flavorid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'payload'
op|'['
string|"'instance_flavor_id'"
op|']'
op|')'
op|','
name|'str'
op|'('
name|'flavor_id'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'display_name'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'created_at'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'launched_at'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'terminated_at'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'deleted_at'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'terminated_at'"
op|']'
op|','
name|'timeutils'
op|'.'
name|'strtime'
op|'('
name|'cur_time'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'deleted_at'"
op|']'
op|','
name|'timeutils'
op|'.'
name|'strtime'
op|'('
name|'cur_time'
op|')'
op|')'
newline|'\n'
name|'image_ref_url'
op|'='
name|'glance'
op|'.'
name|'generate_image_url'
op|'('
name|'FAKE_IMAGE_REF'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'image_ref_url'"
op|']'
op|','
name|'image_ref_url'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_instance_existing
dedent|''
name|'def'
name|'test_run_instance_existing'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure failure when running an instance that already exists.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceExists'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
nl|'\n'
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_instance_queries_macs
dedent|''
name|'def'
name|'test_run_instance_queries_macs'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# run_instance should ask the driver for node mac addresses and pass'
nl|'\n'
comment|'# that to the network_api in use.'
nl|'\n'
indent|'        '
name|'fake_network'
op|'.'
name|'unset_stub_network_methods'
op|'('
name|'self'
op|'.'
name|'stubs'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'macs'
op|'='
name|'set'
op|'('
op|'['
string|"'01:23:45:67:89:ab'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|','
nl|'\n'
string|'"allocate_for_instance"'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|'.'
name|'allocate_for_instance'
op|'('
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'requested_networks'
op|'='
name|'None'
op|','
nl|'\n'
name|'vpn'
op|'='
name|'False'
op|','
name|'macs'
op|'='
name|'macs'
op|','
nl|'\n'
name|'security_groups'
op|'='
op|'['
op|']'
op|','
name|'dhcp_options'
op|'='
name|'None'
op|')'
op|'.'
name|'AndReturn'
op|'('
nl|'\n'
name|'fake_network'
op|'.'
name|'fake_get_instance_nw_info'
op|'('
name|'self'
op|'.'
name|'stubs'
op|','
number|'1'
op|','
number|'1'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|'"macs_for_instance"'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'macs_for_instance'
op|'('
name|'instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'macs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_instance_set_to_error_on_uncaught_exception
dedent|''
name|'def'
name|'test_instance_set_to_error_on_uncaught_exception'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test that instance is set to error state when exception is raised.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|','
nl|'\n'
string|'"allocate_for_instance"'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|','
nl|'\n'
string|'"deallocate_for_instance"'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|'.'
name|'allocate_for_instance'
op|'('
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'requested_networks'
op|'='
name|'None'
op|','
nl|'\n'
name|'vpn'
op|'='
name|'False'
op|','
name|'macs'
op|'='
name|'None'
op|','
nl|'\n'
name|'security_groups'
op|'='
op|'['
op|']'
op|','
name|'dhcp_options'
op|'='
name|'None'
nl|'\n'
op|')'
op|'.'
name|'AndRaise'
op|'('
name|'rpc_common'
op|'.'
name|'RemoteError'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|'.'
name|'deallocate_for_instance'
op|'('
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'requested_networks'
op|'='
name|'None'
op|')'
op|'.'
name|'MultipleTimes'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'fake_network'
op|'.'
name|'unset_stub_network_methods'
op|'('
name|'self'
op|'.'
name|'stubs'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'rpc_common'
op|'.'
name|'RemoteError'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'vm_states'
op|'.'
name|'ERROR'
op|','
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_delete_instance_succedes_on_volume_fail
dedent|''
name|'def'
name|'test_delete_instance_succedes_on_volume_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_cleanup_volumes
name|'def'
name|'fake_cleanup_volumes'
op|'('
name|'context'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_cleanup_volumes'"
op|','
nl|'\n'
name|'fake_cleanup_volumes'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_delete_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'bdms'
op|'='
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_delete_instance_keeps_net_on_power_off_fail
dedent|''
name|'def'
name|'test_delete_instance_keeps_net_on_power_off_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'destroy'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_deallocate_network'"
op|')'
newline|'\n'
name|'exp'
op|'='
name|'exception'
op|'.'
name|'InstancePowerOffFailure'
op|'('
name|'reason'
op|'='
string|"''"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'destroy'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
op|'.'
name|'AndRaise'
op|'('
name|'exp'
op|')'
newline|'\n'
comment|'# mox will detect if _deallocate_network gets called unexpectedly'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstancePowerOffFailure'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_delete_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance'
op|')'
op|','
nl|'\n'
name|'bdms'
op|'='
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_delete_instance_loses_net_on_other_fail
dedent|''
name|'def'
name|'test_delete_instance_loses_net_on_other_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'destroy'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_deallocate_network'"
op|')'
newline|'\n'
name|'exp'
op|'='
name|'test'
op|'.'
name|'TestingException'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'destroy'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
op|'.'
name|'AndRaise'
op|'('
name|'exp'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_deallocate_network'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_delete_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance'
op|')'
op|','
nl|'\n'
name|'bdms'
op|'='
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_delete_instance_deletes_console_auth_tokens
dedent|''
name|'def'
name|'test_delete_instance_deletes_console_auth_tokens'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'vnc_enabled'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'tokens_deleted'
op|'='
name|'False'
newline|'\n'
nl|'\n'
DECL|function|fake_delete_tokens
name|'def'
name|'fake_delete_tokens'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'tokens_deleted'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'cauth_rpcapi'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'consoleauth_rpcapi'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cauth_rpcapi'
op|','
string|"'delete_tokens_for_instance'"
op|','
nl|'\n'
name|'fake_delete_tokens'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_delete_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'bdms'
op|'='
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'self'
op|'.'
name|'tokens_deleted'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_delete_instance_deletes_console_auth_tokens_cells
dedent|''
name|'def'
name|'test_delete_instance_deletes_console_auth_tokens_cells'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'vnc_enabled'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'enable'
op|'='
name|'True'
op|','
name|'group'
op|'='
string|"'cells'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'tokens_deleted'
op|'='
name|'False'
newline|'\n'
nl|'\n'
DECL|function|fake_delete_tokens
name|'def'
name|'fake_delete_tokens'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'tokens_deleted'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'cells_rpcapi'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'cells_rpcapi'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cells_rpcapi'
op|','
string|"'consoleauth_delete_tokens'"
op|','
nl|'\n'
name|'fake_delete_tokens'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_delete_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'bdms'
op|'='
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'self'
op|'.'
name|'tokens_deleted'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_instance_termination_exception_sets_error
dedent|''
name|'def'
name|'test_instance_termination_exception_sets_error'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Test that we handle InstanceTerminationFailure\n        which is propagated up from the underlying driver.\n        """'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_delete_instance
name|'def'
name|'fake_delete_instance'
op|'('
name|'context'
op|','
name|'instance'
op|','
name|'bdms'
op|','
nl|'\n'
name|'reservations'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceTerminationFailure'
op|'('
name|'reason'
op|'='
string|"''"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_delete_instance'"
op|','
nl|'\n'
name|'fake_delete_instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|','
name|'vm_states'
op|'.'
name|'ERROR'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_network_is_deallocated_on_spawn_failure
dedent|''
name|'def'
name|'test_network_is_deallocated_on_spawn_failure'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# When a spawn fails the network must be deallocated.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|'"_prep_block_device"'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_prep_block_device'
op|'('
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
op|'.'
name|'AndRaise'
op|'('
name|'rpc'
op|'.'
name|'common'
op|'.'
name|'RemoteError'
op|'('
string|"''"
op|','
string|"''"
op|','
string|"''"
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'rpc'
op|'.'
name|'common'
op|'.'
name|'RemoteError'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_lock
dedent|''
name|'def'
name|'test_lock'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# FIXME(comstud): This test is such crap.  This is testing'
nl|'\n'
comment|'# compute API lock functionality in a test class for the compute'
nl|'\n'
comment|'# manager by running an instance.  Hello?  We should just have'
nl|'\n'
comment|'# unit tests in test_compute_api that test the check_instance_lock'
nl|'\n'
comment|'# decorator and make sure that appropriate compute_api methods'
nl|'\n'
comment|'# have the decorator.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'non_admin_context'
op|'='
name|'context'
op|'.'
name|'RequestContext'
op|'('
name|'None'
op|','
nl|'\n'
name|'None'
op|','
nl|'\n'
name|'is_admin'
op|'='
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|function|check_task_state
name|'def'
name|'check_task_state'
op|'('
name|'task_state'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|','
name|'task_state'
op|')'
newline|'\n'
nl|'\n'
comment|'# should fail with locked nonadmin context'
nl|'\n'
dedent|''
name|'inst_obj'
op|'='
name|'instance_obj'
op|'.'
name|'Instance'
op|'.'
name|'get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'lock'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'inst_obj'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceIsLocked'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'reboot'
op|','
nl|'\n'
name|'non_admin_context'
op|','
name|'inst_obj'
op|','
string|"'SOFT'"
op|')'
newline|'\n'
name|'check_task_state'
op|'('
name|'None'
op|')'
newline|'\n'
nl|'\n'
comment|'# should fail with invalid task state'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'unlock'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'inst_obj'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|','
nl|'\n'
op|'{'
string|"'task_state'"
op|':'
name|'task_states'
op|'.'
name|'REBOOTING'
op|'}'
op|')'
newline|'\n'
name|'inst_obj'
op|'.'
name|'refresh'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceInvalidState'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'reboot'
op|','
nl|'\n'
name|'non_admin_context'
op|','
name|'inst_obj'
op|','
string|"'SOFT'"
op|')'
newline|'\n'
name|'check_task_state'
op|'('
name|'task_states'
op|'.'
name|'REBOOTING'
op|')'
newline|'\n'
nl|'\n'
comment|'# should succeed with admin context'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|','
nl|'\n'
op|'{'
string|"'task_state'"
op|':'
name|'None'
op|'}'
op|')'
newline|'\n'
name|'inst_obj'
op|'.'
name|'refresh'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'reboot'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'inst_obj'
op|','
string|"'SOFT'"
op|')'
newline|'\n'
name|'check_task_state'
op|'('
name|'task_states'
op|'.'
name|'REBOOTING'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_check_locked_by
dedent|''
name|'def'
name|'_check_locked_by'
op|'('
name|'self'
op|','
name|'instance_uuid'
op|','
name|'locked_by'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'locked'"
op|']'
op|','
name|'locked_by'
op|'!='
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'locked_by'"
op|']'
op|','
name|'locked_by'
op|')'
newline|'\n'
name|'return'
name|'instance'
newline|'\n'
nl|'\n'
DECL|member|test_override_owner_lock
dedent|''
name|'def'
name|'test_override_owner_lock'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# FIXME(comstud): This test is such crap.  This is testing'
nl|'\n'
comment|'# compute API lock functionality in a test class for the compute'
nl|'\n'
comment|'# manager by running an instance.  Hello?  We should just have'
nl|'\n'
comment|'# unit tests in test_compute_api that test the check_instance_lock'
nl|'\n'
comment|'# decorator and make sure that appropriate compute_api methods'
nl|'\n'
comment|'# have the decorator.'
nl|'\n'
indent|'        '
name|'admin_context'
op|'='
name|'context'
op|'.'
name|'RequestContext'
op|'('
string|"'admin-user'"
op|','
nl|'\n'
string|"'admin-project'"
op|','
nl|'\n'
name|'is_admin'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
comment|'# Ensure that an admin can override the owner lock'
nl|'\n'
name|'inst_obj'
op|'='
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'lock'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'inst_obj'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_check_locked_by'
op|'('
name|'instance_uuid'
op|','
string|"'owner'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'unlock'
op|'('
name|'admin_context'
op|','
name|'inst_obj'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_check_locked_by'
op|'('
name|'instance_uuid'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_upgrade_owner_lock
dedent|''
name|'def'
name|'test_upgrade_owner_lock'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# FIXME(comstud): This test is such crap.  This is testing'
nl|'\n'
comment|'# compute API lock functionality in a test class for the compute'
nl|'\n'
comment|'# manager by running an instance.  Hello?  We should just have'
nl|'\n'
comment|'# unit tests in test_compute_api that test the check_instance_lock'
nl|'\n'
comment|'# decorator and make sure that appropriate compute_api methods'
nl|'\n'
comment|'# have the decorator.'
nl|'\n'
indent|'        '
name|'admin_context'
op|'='
name|'context'
op|'.'
name|'RequestContext'
op|'('
string|"'admin-user'"
op|','
nl|'\n'
string|"'admin-project'"
op|','
nl|'\n'
name|'is_admin'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
comment|'# Ensure that an admin can upgrade the lock and that'
nl|'\n'
comment|'# the owner can no longer unlock'
nl|'\n'
name|'inst_obj'
op|'='
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'lock'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'inst_obj'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'lock'
op|'('
name|'admin_context'
op|','
name|'inst_obj'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_check_locked_by'
op|'('
name|'instance_uuid'
op|','
string|"'admin'"
op|')'
newline|'\n'
name|'inst_obj'
op|'.'
name|'refresh'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'PolicyNotAuthorized'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'unlock'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'inst_obj'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_check_locked_by'
op|'('
name|'instance_uuid'
op|','
string|"'admin'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'unlock'
op|'('
name|'admin_context'
op|','
name|'inst_obj'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_check_locked_by'
op|'('
name|'instance_uuid'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_state_revert
dedent|''
name|'def'
name|'_test_state_revert'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'operation'
op|','
name|'pre_task_state'
op|','
nl|'\n'
name|'kwargs'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'kwargs'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'kwargs'
op|'='
op|'{'
op|'}'
newline|'\n'
nl|'\n'
comment|'# The API would have set task_state, so do that here to test'
nl|'\n'
comment|'# that the state gets reverted on failure'
nl|'\n'
dedent|''
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|'"task_state"'
op|':'
name|'pre_task_state'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'orig_elevated'
op|'='
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
newline|'\n'
name|'orig_notify'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_notify_about_instance_usage'
newline|'\n'
nl|'\n'
DECL|function|_get_an_exception
name|'def'
name|'_get_an_exception'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'elevated'"
op|','
name|'_get_an_exception'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_notify_about_instance_usage'"
op|','
name|'_get_an_exception'
op|')'
newline|'\n'
nl|'\n'
name|'func'
op|'='
name|'getattr'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
name|'operation'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|','
nl|'\n'
name|'func'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
comment|'# self.context.elevated() is called in tearDown()'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'elevated'"
op|','
name|'orig_elevated'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_notify_about_instance_usage'"
op|','
name|'orig_notify'
op|')'
newline|'\n'
nl|'\n'
comment|"# Fetch the instance's task_state and make sure it reverted to None."
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'instance'
op|'['
string|'"task_state"'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_state_revert
dedent|''
name|'def'
name|'test_state_revert'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# ensure that task_state is reverted after a failed operation.'
nl|'\n'
indent|'        '
name|'migration'
op|'='
name|'migration_obj'
op|'.'
name|'Migration'
op|'('
op|')'
newline|'\n'
name|'migration'
op|'.'
name|'new_instance_type_id'
op|'='
string|"'1'"
newline|'\n'
nl|'\n'
name|'actions'
op|'='
op|'['
nl|'\n'
op|'('
string|'"reboot_instance"'
op|','
name|'task_states'
op|'.'
name|'REBOOTING'
op|','
nl|'\n'
op|'{'
string|"'block_device_info'"
op|':'
op|'['
op|']'
op|','
nl|'\n'
string|"'reboot_type'"
op|':'
string|"'SOFT'"
op|'}'
op|')'
op|','
nl|'\n'
op|'('
string|'"stop_instance"'
op|','
name|'task_states'
op|'.'
name|'POWERING_OFF'
op|')'
op|','
nl|'\n'
op|'('
string|'"start_instance"'
op|','
name|'task_states'
op|'.'
name|'POWERING_ON'
op|')'
op|','
nl|'\n'
op|'('
string|'"terminate_instance"'
op|','
name|'task_states'
op|'.'
name|'DELETING'
op|','
nl|'\n'
op|'{'
string|"'bdms'"
op|':'
op|'['
op|']'
op|','
nl|'\n'
string|"'reservations'"
op|':'
op|'['
op|']'
op|'}'
op|')'
op|','
nl|'\n'
op|'('
string|'"soft_delete_instance"'
op|','
name|'task_states'
op|'.'
name|'SOFT_DELETING'
op|','
nl|'\n'
op|'{'
string|"'reservations'"
op|':'
op|'['
op|']'
op|'}'
op|')'
op|','
nl|'\n'
op|'('
string|'"restore_instance"'
op|','
name|'task_states'
op|'.'
name|'RESTORING'
op|')'
op|','
nl|'\n'
op|'('
string|'"rebuild_instance"'
op|','
name|'task_states'
op|'.'
name|'REBUILDING'
op|','
nl|'\n'
op|'{'
string|"'orig_image_ref'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'image_ref'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'injected_files'"
op|':'
op|'['
op|']'
op|','
nl|'\n'
string|"'new_pass'"
op|':'
string|"''"
op|','
nl|'\n'
string|"'orig_sys_metadata'"
op|':'
op|'{'
op|'}'
op|','
nl|'\n'
string|"'bdms'"
op|':'
op|'['
op|']'
op|','
nl|'\n'
string|"'recreate'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'on_shared_storage'"
op|':'
name|'False'
op|'}'
op|')'
op|','
nl|'\n'
op|'('
string|'"set_admin_password"'
op|','
name|'task_states'
op|'.'
name|'UPDATING_PASSWORD'
op|','
nl|'\n'
op|'{'
string|"'new_pass'"
op|':'
name|'None'
op|'}'
op|')'
op|','
nl|'\n'
op|'('
string|'"rescue_instance"'
op|','
name|'task_states'
op|'.'
name|'RESCUING'
op|','
nl|'\n'
op|'{'
string|"'rescue_password'"
op|':'
name|'None'
op|'}'
op|')'
op|','
nl|'\n'
op|'('
string|'"unrescue_instance"'
op|','
name|'task_states'
op|'.'
name|'UNRESCUING'
op|')'
op|','
nl|'\n'
op|'('
string|'"revert_resize"'
op|','
name|'task_states'
op|'.'
name|'RESIZE_REVERTING'
op|','
nl|'\n'
op|'{'
string|"'migration'"
op|':'
name|'migration'
op|','
nl|'\n'
string|"'reservations'"
op|':'
op|'['
op|']'
op|'}'
op|')'
op|','
nl|'\n'
op|'('
string|'"prep_resize"'
op|','
name|'task_states'
op|'.'
name|'RESIZE_PREP'
op|','
nl|'\n'
op|'{'
string|"'image'"
op|':'
op|'{'
op|'}'
op|','
nl|'\n'
string|"'instance_type'"
op|':'
op|'{'
op|'}'
op|','
nl|'\n'
string|"'reservations'"
op|':'
op|'['
op|']'
op|','
nl|'\n'
string|"'request_spec'"
op|':'
op|'{'
op|'}'
op|','
nl|'\n'
string|"'filter_properties'"
op|':'
op|'{'
op|'}'
op|','
nl|'\n'
string|"'node'"
op|':'
name|'None'
op|'}'
op|')'
op|','
nl|'\n'
op|'('
string|'"resize_instance"'
op|','
name|'task_states'
op|'.'
name|'RESIZE_PREP'
op|','
nl|'\n'
op|'{'
string|"'migration'"
op|':'
name|'migration'
op|','
nl|'\n'
string|"'image'"
op|':'
op|'{'
op|'}'
op|','
nl|'\n'
string|"'reservations'"
op|':'
op|'['
op|']'
op|','
nl|'\n'
string|"'instance_type'"
op|':'
op|'{'
op|'}'
op|'}'
op|')'
op|','
nl|'\n'
op|'('
string|'"pause_instance"'
op|','
name|'task_states'
op|'.'
name|'PAUSING'
op|')'
op|','
nl|'\n'
op|'('
string|'"unpause_instance"'
op|','
name|'task_states'
op|'.'
name|'UNPAUSING'
op|')'
op|','
nl|'\n'
op|'('
string|'"suspend_instance"'
op|','
name|'task_states'
op|'.'
name|'SUSPENDING'
op|')'
op|','
nl|'\n'
op|'('
string|'"resume_instance"'
op|','
name|'task_states'
op|'.'
name|'RESUMING'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
name|'want_objects'
op|'='
op|'['
string|"'stop_instance'"
op|','
string|"'start_instance'"
op|','
nl|'\n'
string|"'terminate_instance'"
op|','
string|"'soft_delete_instance'"
op|','
nl|'\n'
string|"'revert_resize'"
op|','
string|"'confirm_resize'"
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_stub_out_resize_network_methods'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'inst_obj'
op|'='
name|'instance_obj'
op|'.'
name|'Instance'
op|'.'
name|'_from_db_object'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance_obj'
op|'.'
name|'Instance'
op|'('
op|')'
op|','
name|'instance'
op|','
nl|'\n'
name|'expected_attrs'
op|'='
name|'instance_obj'
op|'.'
name|'INSTANCE_DEFAULT_FIELDS'
op|')'
newline|'\n'
name|'for'
name|'operation'
name|'in'
name|'actions'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'operation'
op|'['
number|'0'
op|']'
name|'in'
name|'want_objects'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'_test_state_revert'
op|'('
name|'inst_obj'
op|','
op|'*'
name|'operation'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'_test_state_revert'
op|'('
name|'instance'
op|','
op|'*'
name|'operation'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_ensure_quota_reservations_committed
dedent|''
dedent|''
dedent|''
name|'def'
name|'_ensure_quota_reservations_committed'
op|'('
name|'self'
op|','
name|'expect_project'
op|'='
name|'False'
op|','
nl|'\n'
name|'expect_user'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Mock up commit of quota reservations."""'
newline|'\n'
name|'reservations'
op|'='
name|'list'
op|'('
string|"'fake_res'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'nova'
op|'.'
name|'quota'
op|'.'
name|'QUOTAS'
op|','
string|"'commit'"
op|')'
newline|'\n'
name|'nova'
op|'.'
name|'quota'
op|'.'
name|'QUOTAS'
op|'.'
name|'commit'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'reservations'
op|','
nl|'\n'
name|'project_id'
op|'='
op|'('
name|'expect_project'
name|'and'
nl|'\n'
name|'self'
op|'.'
name|'context'
op|'.'
name|'project_id'
name|'or'
nl|'\n'
name|'None'
op|')'
op|','
nl|'\n'
name|'user_id'
op|'='
op|'('
name|'expect_user'
name|'and'
nl|'\n'
name|'self'
op|'.'
name|'context'
op|'.'
name|'user_id'
name|'or'
nl|'\n'
name|'None'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'return'
name|'reservations'
newline|'\n'
nl|'\n'
DECL|member|_ensure_quota_reservations_rolledback
dedent|''
name|'def'
name|'_ensure_quota_reservations_rolledback'
op|'('
name|'self'
op|','
name|'expect_project'
op|'='
name|'False'
op|','
nl|'\n'
name|'expect_user'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Mock up rollback of quota reservations."""'
newline|'\n'
name|'reservations'
op|'='
name|'list'
op|'('
string|"'fake_res'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'nova'
op|'.'
name|'quota'
op|'.'
name|'QUOTAS'
op|','
string|"'rollback'"
op|')'
newline|'\n'
name|'nova'
op|'.'
name|'quota'
op|'.'
name|'QUOTAS'
op|'.'
name|'rollback'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'reservations'
op|','
nl|'\n'
name|'project_id'
op|'='
op|'('
name|'expect_project'
name|'and'
nl|'\n'
name|'self'
op|'.'
name|'context'
op|'.'
name|'project_id'
name|'or'
nl|'\n'
name|'None'
op|')'
op|','
nl|'\n'
name|'user_id'
op|'='
op|'('
name|'expect_user'
name|'and'
nl|'\n'
name|'self'
op|'.'
name|'context'
op|'.'
name|'user_id'
name|'or'
nl|'\n'
name|'None'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'return'
name|'reservations'
newline|'\n'
nl|'\n'
DECL|member|test_quotas_succesful_delete
dedent|''
name|'def'
name|'test_quotas_succesful_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'resvs'
op|'='
name|'self'
op|'.'
name|'_ensure_quota_reservations_committed'
op|'('
name|'True'
op|','
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
name|'bdms'
op|'='
op|'['
op|']'
op|','
name|'reservations'
op|'='
name|'resvs'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quotas_failed_delete
dedent|''
name|'def'
name|'test_quotas_failed_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_shutdown_instance
name|'def'
name|'fake_shutdown_instance'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_shutdown_instance'"
op|','
nl|'\n'
name|'fake_shutdown_instance'
op|')'
newline|'\n'
nl|'\n'
name|'resvs'
op|'='
name|'self'
op|'.'
name|'_ensure_quota_reservations_rolledback'
op|'('
name|'True'
op|','
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
nl|'\n'
name|'bdms'
op|'='
op|'['
op|']'
op|','
name|'reservations'
op|'='
name|'resvs'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quotas_succesful_soft_delete
dedent|''
name|'def'
name|'test_quotas_succesful_soft_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
name|'params'
op|'='
name|'dict'
op|'('
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'SOFT_DELETING'
op|')'
op|')'
op|')'
newline|'\n'
name|'resvs'
op|'='
name|'self'
op|'.'
name|'_ensure_quota_reservations_committed'
op|'('
name|'True'
op|','
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'soft_delete_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'reservations'
op|'='
name|'resvs'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quotas_failed_soft_delete
dedent|''
name|'def'
name|'test_quotas_failed_soft_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
name|'params'
op|'='
name|'dict'
op|'('
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'SOFT_DELETING'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_soft_delete
name|'def'
name|'fake_soft_delete'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'soft_delete'"
op|','
nl|'\n'
name|'fake_soft_delete'
op|')'
newline|'\n'
nl|'\n'
name|'resvs'
op|'='
name|'self'
op|'.'
name|'_ensure_quota_reservations_rolledback'
op|'('
name|'True'
op|','
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'soft_delete_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'reservations'
op|'='
name|'resvs'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_quotas_destroy_of_soft_deleted_instance
dedent|''
name|'def'
name|'test_quotas_destroy_of_soft_deleted_instance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
name|'params'
op|'='
name|'dict'
op|'('
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'SOFT_DELETED'
op|')'
op|')'
op|')'
newline|'\n'
comment|'# Termination should be successful, but quota reservations'
nl|'\n'
comment|'# rolled back because the instance was in SOFT_DELETED state.'
nl|'\n'
name|'resvs'
op|'='
name|'self'
op|'.'
name|'_ensure_quota_reservations_rolledback'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
name|'bdms'
op|'='
op|'['
op|']'
op|','
name|'reservations'
op|'='
name|'resvs'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_stub_out_resize_network_methods
dedent|''
name|'def'
name|'_stub_out_resize_network_methods'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|fake
indent|'        '
name|'def'
name|'fake'
op|'('
name|'cls'
op|','
name|'ctxt'
op|','
name|'instance'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'network_api'
op|'.'
name|'API'
op|','
string|"'setup_networks_on_host'"
op|','
name|'fake'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'network_api'
op|'.'
name|'API'
op|','
string|"'migrate_instance_start'"
op|','
name|'fake'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'network_api'
op|'.'
name|'API'
op|','
string|"'migrate_instance_finish'"
op|','
name|'fake'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_finish_resize
dedent|''
name|'def'
name|'_test_finish_resize'
op|'('
name|'self'
op|','
name|'power_on'
op|')'
op|':'
newline|'\n'
comment|"# Contrived test to ensure finish_resize doesn't raise anything and"
nl|'\n'
comment|'# also tests resize from ACTIVE or STOPPED state which determines'
nl|'\n'
comment|'# if the resized instance is powered on or not.'
nl|'\n'
indent|'        '
name|'vm_state'
op|'='
name|'None'
newline|'\n'
name|'if'
name|'power_on'
op|':'
newline|'\n'
indent|'            '
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'ACTIVE'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'STOPPED'
newline|'\n'
dedent|''
name|'params'
op|'='
op|'{'
string|"'vm_state'"
op|':'
name|'vm_state'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
name|'params'
op|')'
newline|'\n'
name|'image'
op|'='
string|"'fake-image'"
newline|'\n'
name|'disk_info'
op|'='
string|"'fake-disk-info'"
newline|'\n'
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'RESIZE_PREP'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'prep_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'instance_type'
op|','
nl|'\n'
name|'image'
op|'='
op|'{'
op|'}'
op|','
name|'reservations'
op|'='
op|'['
op|']'
op|','
name|'request_spec'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|'='
op|'{'
op|'}'
op|','
name|'node'
op|'='
name|'None'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'RESIZE_MIGRATED'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# NOTE(mriedem): make sure prep_resize set old_vm_state correctly'
nl|'\n'
name|'sys_meta'
op|'='
name|'instance'
op|'.'
name|'system_metadata'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'old_vm_state'"
op|','
name|'sys_meta'
op|')'
newline|'\n'
name|'if'
name|'power_on'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'vm_states'
op|'.'
name|'ACTIVE'
op|','
name|'sys_meta'
op|'['
string|"'old_vm_state'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'vm_states'
op|'.'
name|'STOPPED'
op|','
name|'sys_meta'
op|'['
string|"'old_vm_state'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'migration'
op|'='
name|'migration_obj'
op|'.'
name|'Migration'
op|'.'
name|'get_by_instance_and_status'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'uuid'
op|','
string|"'pre-migrating'"
op|')'
newline|'\n'
nl|'\n'
name|'orig_mig_save'
op|'='
name|'migration'
op|'.'
name|'save'
newline|'\n'
name|'orig_inst_save'
op|'='
name|'instance'
op|'.'
name|'save'
newline|'\n'
name|'network_api'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
newline|'\n'
name|'conductor_api'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'network_api'
op|','
string|"'setup_networks_on_host'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'conductor_api'
op|','
nl|'\n'
string|"'network_migrate_instance_finish'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_instance_nw_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_notify_about_instance_usage'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'finish_migration'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_get_instance_volume_block_device_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'migration'
op|','
string|"'save'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'instance'
op|','
string|"'save'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'elevated'"
op|')'
newline|'\n'
nl|'\n'
DECL|function|_mig_save
name|'def'
name|'_mig_save'
op|'('
name|'context'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'migration'
op|'.'
name|'status'
op|','
string|"'finished'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'vm_state'
op|','
name|'instance'
op|'.'
name|'vm_state'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'task_states'
op|'.'
name|'RESIZE_FINISH'
op|','
name|'instance'
op|'.'
name|'task_state'
op|')'
newline|'\n'
name|'orig_mig_save'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|_instance_save1
dedent|''
name|'def'
name|'_instance_save1'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance_type'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'instance_type_id'
op|')'
newline|'\n'
name|'orig_inst_save'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|_instance_save2
dedent|''
name|'def'
name|'_instance_save2'
op|'('
name|'expected_task_state'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'task_states'
op|'.'
name|'RESIZE_MIGRATED'
op|','
nl|'\n'
name|'expected_task_state'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'task_states'
op|'.'
name|'RESIZE_FINISH'
op|','
name|'instance'
op|'.'
name|'task_state'
op|')'
newline|'\n'
name|'orig_inst_save'
op|'('
name|'expected_task_state'
op|'='
name|'expected_task_state'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_instance_save3
dedent|''
name|'def'
name|'_instance_save3'
op|'('
name|'expected_task_state'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'task_states'
op|'.'
name|'RESIZE_FINISH'
op|','
nl|'\n'
name|'expected_task_state'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'vm_states'
op|'.'
name|'RESIZED'
op|','
name|'instance'
op|'.'
name|'vm_state'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'instance'
op|'.'
name|'task_state'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'launched_at'"
op|','
name|'instance'
op|'.'
name|'obj_what_changed'
op|'('
op|')'
op|')'
newline|'\n'
name|'orig_inst_save'
op|'('
name|'expected_task_state'
op|'='
name|'expected_task_state'
op|')'
newline|'\n'
nl|'\n'
comment|'# First save to update flavor'
nl|'\n'
dedent|''
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
op|'.'
name|'WithSideEffects'
op|'('
name|'_instance_save1'
op|')'
newline|'\n'
nl|'\n'
name|'network_api'
op|'.'
name|'setup_networks_on_host'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
string|"'fake-mini'"
op|')'
newline|'\n'
name|'conductor_api'
op|'.'
name|'network_migrate_instance_finish'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IsA'
op|'('
name|'dict'
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IsA'
op|'('
name|'dict'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instance_nw_info'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
string|"'fake-nwinfo1'"
op|')'
newline|'\n'
nl|'\n'
comment|'# 2nd save to update task state'
nl|'\n'
name|'exp_kwargs'
op|'='
name|'dict'
op|'('
name|'expected_task_state'
op|'='
name|'task_states'
op|'.'
name|'RESIZE_MIGRATED'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|'**'
name|'exp_kwargs'
op|')'
op|'.'
name|'WithSideEffects'
op|'('
name|'_instance_save2'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_notify_about_instance_usage'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
string|"'finish_resize.start'"
op|','
nl|'\n'
name|'network_info'
op|'='
string|"'fake-nwinfo1'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instance_volume_block_device_info'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'refresh_conn_info'
op|'='
name|'True'
op|')'
op|'.'
name|'AndReturn'
op|'('
string|"'fake-bdminfo'"
op|')'
newline|'\n'
comment|'# nova.conf sets the default flavor to m1.small and the test'
nl|'\n'
comment|'# sets the default flavor to m1.tiny so they should be different'
nl|'\n'
comment|'# which makes this a resize'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'finish_migration'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'migration'
op|','
nl|'\n'
name|'instance'
op|','
name|'disk_info'
op|','
nl|'\n'
string|"'fake-nwinfo1'"
op|','
nl|'\n'
name|'image'
op|','
name|'True'
op|','
nl|'\n'
string|"'fake-bdminfo'"
op|','
name|'power_on'
op|')'
newline|'\n'
comment|'# Ensure instance status updates is after the migration finish'
nl|'\n'
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'migration'
op|'.'
name|'save'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
op|'.'
name|'WithSideEffects'
op|'('
name|'_mig_save'
op|')'
newline|'\n'
name|'exp_kwargs'
op|'='
name|'dict'
op|'('
name|'expected_task_state'
op|'='
name|'task_states'
op|'.'
name|'RESIZE_FINISH'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|'**'
name|'exp_kwargs'
op|')'
op|'.'
name|'WithSideEffects'
op|'('
name|'_instance_save3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_notify_about_instance_usage'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
string|"'finish_resize.end'"
op|','
nl|'\n'
name|'network_info'
op|'='
string|"'fake-nwinfo1'"
op|')'
newline|'\n'
comment|'# NOTE(comstud): This actually does the mox.ReplayAll()'
nl|'\n'
name|'reservations'
op|'='
name|'self'
op|'.'
name|'_ensure_quota_reservations_committed'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'finish_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|','
nl|'\n'
name|'disk_info'
op|'='
name|'disk_info'
op|','
name|'image'
op|'='
name|'image'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'reservations'
op|'='
name|'reservations'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_finish_resize_from_active
dedent|''
name|'def'
name|'test_finish_resize_from_active'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_finish_resize'
op|'('
name|'power_on'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_finish_resize_from_stopped
dedent|''
name|'def'
name|'test_finish_resize_from_stopped'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_finish_resize'
op|'('
name|'power_on'
op|'='
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_finish_resize_with_volumes
dedent|''
name|'def'
name|'test_finish_resize_with_volumes'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Contrived test to ensure finish_resize doesn\'t raise anything."""'
newline|'\n'
nl|'\n'
comment|'# create instance'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# create volume'
nl|'\n'
name|'volume_id'
op|'='
string|"'fake'"
newline|'\n'
name|'volume'
op|'='
op|'{'
string|"'instance_uuid'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'device_name'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'volume_id'"
op|':'
name|'volume_id'
op|'}'
newline|'\n'
nl|'\n'
comment|'# stub out volume attach'
nl|'\n'
DECL|function|fake_volume_get
name|'def'
name|'fake_volume_get'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'volume'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|'"get"'
op|','
name|'fake_volume_get'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_get_volume_encryption_metadata
name|'def'
name|'fake_get_volume_encryption_metadata'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
op|'}'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'get_volume_encryption_metadata'"
op|','
nl|'\n'
name|'fake_get_volume_encryption_metadata'
op|')'
newline|'\n'
nl|'\n'
name|'orig_connection_data'
op|'='
op|'{'
nl|'\n'
string|"'target_discovered'"
op|':'
name|'True'
op|','
nl|'\n'
string|"'target_iqn'"
op|':'
string|"'iqn.2010-10.org.openstack:%s.1'"
op|'%'
name|'volume_id'
op|','
nl|'\n'
string|"'target_portal'"
op|':'
string|"'127.0.0.0.1:3260'"
op|','
nl|'\n'
string|"'volume_id'"
op|':'
name|'volume_id'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'connection_info'
op|'='
op|'{'
nl|'\n'
string|"'driver_volume_type'"
op|':'
string|"'iscsi'"
op|','
nl|'\n'
string|"'data'"
op|':'
name|'orig_connection_data'
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_init_conn
name|'def'
name|'fake_init_conn'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume'
op|','
name|'session'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'connection_info'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|'"initialize_connection"'
op|','
name|'fake_init_conn'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_attach
name|'def'
name|'fake_attach'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|','
name|'instance_uuid'
op|','
name|'device_name'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'volume'
op|'['
string|"'instance_uuid'"
op|']'
op|'='
name|'instance_uuid'
newline|'\n'
name|'volume'
op|'['
string|"'device_name'"
op|']'
op|'='
name|'device_name'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|'"attach"'
op|','
name|'fake_attach'
op|')'
newline|'\n'
nl|'\n'
comment|'# stub out virt driver attach'
nl|'\n'
DECL|function|fake_get_volume_connector
name|'def'
name|'fake_get_volume_connector'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
op|'}'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'get_volume_connector'"
op|','
nl|'\n'
name|'fake_get_volume_connector'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_attach_volume
name|'def'
name|'fake_attach_volume'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'attach_volume'"
op|','
nl|'\n'
name|'fake_attach_volume'
op|')'
newline|'\n'
nl|'\n'
comment|'# attach volume to instance'
nl|'\n'
name|'instance_p'
op|'='
name|'obj_base'
op|'.'
name|'obj_to_primitive'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'attach_volume'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'volume'
op|'['
string|"'volume_id'"
op|']'
op|','
nl|'\n'
string|"'/dev/vdc'"
op|','
name|'instance_p'
op|')'
newline|'\n'
nl|'\n'
comment|'# assert volume attached correctly'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'volume'
op|'['
string|"'device_name'"
op|']'
op|','
string|"'/dev/vdc'"
op|')'
newline|'\n'
name|'disk_info'
op|'='
name|'db'
op|'.'
name|'block_device_mapping_get_all_by_instance'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'.'
name|'uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'disk_info'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'for'
name|'bdm'
name|'in'
name|'disk_info'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'bdm'
op|'['
string|"'device_name'"
op|']'
op|','
name|'volume'
op|'['
string|"'device_name'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'bdm'
op|'['
string|"'connection_info'"
op|']'
op|','
nl|'\n'
name|'jsonutils'
op|'.'
name|'dumps'
op|'('
name|'connection_info'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# begin resize'
nl|'\n'
dedent|''
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'RESIZE_PREP'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'prep_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'instance_type'
op|','
nl|'\n'
name|'image'
op|'='
op|'{'
op|'}'
op|','
name|'reservations'
op|'='
op|'['
op|']'
op|','
name|'request_spec'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|'='
op|'{'
op|'}'
op|','
name|'node'
op|'='
name|'None'
op|')'
newline|'\n'
nl|'\n'
comment|'# fake out detach for prep_resize (and later terminate)'
nl|'\n'
DECL|function|fake_terminate_connection
name|'def'
name|'fake_terminate_connection'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume'
op|','
name|'connector'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'connection_info'
op|'['
string|"'data'"
op|']'
op|'='
name|'None'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|'"terminate_connection"'
op|','
nl|'\n'
name|'fake_terminate_connection'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_stub_out_resize_network_methods'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'migration'
op|'='
name|'migration_obj'
op|'.'
name|'Migration'
op|'.'
name|'get_by_instance_and_status'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'uuid'
op|','
string|"'pre-migrating'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'resize_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
name|'reservations'
op|'='
op|'['
op|']'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance_type'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# assert bdm is unchanged'
nl|'\n'
name|'disk_info'
op|'='
name|'db'
op|'.'
name|'block_device_mapping_get_all_by_instance'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'.'
name|'uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'disk_info'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'for'
name|'bdm'
name|'in'
name|'disk_info'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'bdm'
op|'['
string|"'device_name'"
op|']'
op|','
name|'volume'
op|'['
string|"'device_name'"
op|']'
op|')'
newline|'\n'
name|'cached_connection_info'
op|'='
name|'jsonutils'
op|'.'
name|'loads'
op|'('
name|'bdm'
op|'['
string|"'connection_info'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'cached_connection_info'
op|'['
string|"'data'"
op|']'
op|','
nl|'\n'
name|'orig_connection_data'
op|')'
newline|'\n'
comment|'# but connection was terminated'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'connection_info'
op|'['
string|"'data'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# stub out virt driver finish_migration'
nl|'\n'
DECL|function|fake
name|'def'
name|'fake'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'finish_migration'"
op|','
name|'fake'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'RESIZE_MIGRATED'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'reservations'
op|'='
name|'self'
op|'.'
name|'_ensure_quota_reservations_committed'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# new initialize connection'
nl|'\n'
name|'new_connection_data'
op|'='
name|'dict'
op|'('
name|'orig_connection_data'
op|')'
newline|'\n'
name|'new_iqn'
op|'='
string|"'iqn.2010-10.org.openstack:%s.2'"
op|'%'
name|'volume_id'
op|','
newline|'\n'
name|'new_connection_data'
op|'['
string|"'target_iqn'"
op|']'
op|'='
name|'new_iqn'
newline|'\n'
nl|'\n'
DECL|function|fake_init_conn_with_data
name|'def'
name|'fake_init_conn_with_data'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume'
op|','
name|'session'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'connection_info'
op|'['
string|"'data'"
op|']'
op|'='
name|'new_connection_data'
newline|'\n'
name|'return'
name|'connection_info'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|'"initialize_connection"'
op|','
nl|'\n'
name|'fake_init_conn_with_data'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'finish_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|','
nl|'\n'
name|'disk_info'
op|'='
op|'{'
op|'}'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'reservations'
op|'='
name|'reservations'
op|')'
newline|'\n'
nl|'\n'
comment|'# assert volume attached correctly'
nl|'\n'
name|'disk_info'
op|'='
name|'db'
op|'.'
name|'block_device_mapping_get_all_by_instance'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'disk_info'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'for'
name|'bdm'
name|'in'
name|'disk_info'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'bdm'
op|'['
string|"'connection_info'"
op|']'
op|','
nl|'\n'
name|'jsonutils'
op|'.'
name|'dumps'
op|'('
name|'connection_info'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# stub out detach'
nl|'\n'
DECL|function|fake_detach
dedent|''
name|'def'
name|'fake_detach'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_uuid'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'volume'
op|'['
string|"'device_path'"
op|']'
op|'='
name|'None'
newline|'\n'
name|'volume'
op|'['
string|"'instance_uuid'"
op|']'
op|'='
name|'None'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|'"detach"'
op|','
name|'fake_detach'
op|')'
newline|'\n'
nl|'\n'
comment|'# clean up'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_finish_resize_handles_error
dedent|''
name|'def'
name|'test_finish_resize_handles_error'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|"# Make sure we don't leave the instance in RESIZE on error."
nl|'\n'
nl|'\n'
DECL|function|throw_up
indent|'        '
name|'def'
name|'throw_up'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake
dedent|''
name|'def'
name|'fake'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'finish_migration'"
op|','
name|'throw_up'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_stub_out_resize_network_methods'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'reservations'
op|'='
name|'self'
op|'.'
name|'_ensure_quota_reservations_rolledback'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'prep_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'instance_type'
op|','
nl|'\n'
name|'image'
op|'='
op|'{'
op|'}'
op|','
name|'reservations'
op|'='
name|'reservations'
op|','
nl|'\n'
name|'request_spec'
op|'='
op|'{'
op|'}'
op|','
name|'filter_properties'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'node'
op|'='
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'migration'
op|'='
name|'migration_obj'
op|'.'
name|'Migration'
op|'.'
name|'get_by_instance_and_status'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'uuid'
op|','
string|"'pre-migrating'"
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'.'
name|'refresh'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'RESIZE_MIGRATED'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'finish_resize'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|','
nl|'\n'
name|'disk_info'
op|'='
op|'{'
op|'}'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'reservations'
op|'='
name|'reservations'
op|')'
newline|'\n'
comment|"# NOTE(comstud): error path doesn't use objects, so our object"
nl|'\n'
comment|'# is not updated.  Refresh and compare against the DB.'
nl|'\n'
name|'instance'
op|'.'
name|'refresh'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'vm_states'
op|'.'
name|'ERROR'
op|','
name|'instance'
op|'.'
name|'vm_state'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_instance_notification
dedent|''
name|'def'
name|'test_rebuild_instance_notification'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure notifications on instance migrate/resize.'
nl|'\n'
indent|'        '
name|'old_time'
op|'='
name|'datetime'
op|'.'
name|'datetime'
op|'('
number|'2012'
op|','
number|'4'
op|','
number|'1'
op|')'
newline|'\n'
name|'cur_time'
op|'='
name|'datetime'
op|'.'
name|'datetime'
op|'('
number|'2012'
op|','
number|'12'
op|','
number|'21'
op|','
number|'12'
op|','
number|'21'
op|')'
newline|'\n'
name|'timeutils'
op|'.'
name|'set_time_override'
op|'('
name|'old_time'
op|')'
newline|'\n'
name|'inst_ref'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'inst_ref'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'timeutils'
op|'.'
name|'set_time_override'
op|'('
name|'cur_time'
op|')'
newline|'\n'
nl|'\n'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'inst_ref'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'orig_sys_metadata'
op|'='
name|'db'
op|'.'
name|'instance_system_metadata_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'inst_ref'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'image_ref'
op|'='
name|'instance'
op|'['
string|'"image_ref"'
op|']'
newline|'\n'
name|'new_image_ref'
op|'='
name|'image_ref'
op|'+'
string|"'-new_image_ref'"
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'inst_ref'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|"'image_ref'"
op|':'
name|'new_image_ref'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'password'
op|'='
string|'"new_password"'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'inst_ref'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|'"task_state"'
op|':'
name|'task_states'
op|'.'
name|'REBUILDING'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'rebuild_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
nl|'\n'
name|'image_ref'
op|','
name|'new_image_ref'
op|','
nl|'\n'
name|'injected_files'
op|'='
op|'['
op|']'
op|','
nl|'\n'
name|'new_pass'
op|'='
name|'password'
op|','
nl|'\n'
name|'orig_sys_metadata'
op|'='
name|'orig_sys_metadata'
op|','
nl|'\n'
name|'bdms'
op|'='
op|'['
op|']'
op|','
name|'recreate'
op|'='
name|'False'
op|','
nl|'\n'
name|'on_shared_storage'
op|'='
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'inst_ref'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'image_ref_url'
op|'='
name|'glance'
op|'.'
name|'generate_image_url'
op|'('
name|'image_ref'
op|')'
newline|'\n'
name|'new_image_ref_url'
op|'='
name|'glance'
op|'.'
name|'generate_image_url'
op|'('
name|'new_image_ref'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'3'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.exists'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'payload'
op|'['
string|"'image_ref_url'"
op|']'
op|','
name|'image_ref_url'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.rebuild.start'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'payload'
op|'['
string|"'image_ref_url'"
op|']'
op|','
name|'new_image_ref_url'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'payload'
op|'['
string|"'image_name'"
op|']'
op|','
string|"'fake_name'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'2'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.rebuild.end'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'priority'
op|','
string|"'INFO'"
op|')'
newline|'\n'
name|'payload'
op|'='
name|'msg'
op|'.'
name|'payload'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'image_name'"
op|']'
op|','
string|"'fake_name'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'tenant_id'"
op|']'
op|','
name|'self'
op|'.'
name|'project_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'user_id'"
op|']'
op|','
name|'self'
op|'.'
name|'user_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'instance_id'"
op|']'
op|','
name|'inst_ref'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'instance_type'"
op|']'
op|','
string|"'m1.tiny'"
op|')'
newline|'\n'
name|'type_id'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
string|"'m1.tiny'"
op|')'
op|'['
string|"'id'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'payload'
op|'['
string|"'instance_type_id'"
op|']'
op|')'
op|','
name|'str'
op|'('
name|'type_id'
op|')'
op|')'
newline|'\n'
name|'flavor_id'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
string|"'m1.tiny'"
op|')'
op|'['
string|"'flavorid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'payload'
op|'['
string|"'instance_flavor_id'"
op|']'
op|')'
op|','
name|'str'
op|'('
name|'flavor_id'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'display_name'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'created_at'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'launched_at'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'launched_at'"
op|']'
op|','
name|'timeutils'
op|'.'
name|'strtime'
op|'('
name|'cur_time'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'image_ref_url'"
op|']'
op|','
name|'new_image_ref_url'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'inst_ref'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_finish_resize_instance_notification
dedent|''
name|'def'
name|'test_finish_resize_instance_notification'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure notifications on instance migrate/resize.'
nl|'\n'
indent|'        '
name|'old_time'
op|'='
name|'datetime'
op|'.'
name|'datetime'
op|'('
number|'2012'
op|','
number|'4'
op|','
number|'1'
op|')'
newline|'\n'
name|'cur_time'
op|'='
name|'datetime'
op|'.'
name|'datetime'
op|'('
number|'2012'
op|','
number|'12'
op|','
number|'21'
op|','
number|'12'
op|','
number|'21'
op|')'
newline|'\n'
name|'timeutils'
op|'.'
name|'set_time_override'
op|'('
name|'old_time'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'new_type'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
string|"'m1.small'"
op|')'
newline|'\n'
name|'new_type'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'new_type'
op|')'
newline|'\n'
name|'new_type_id'
op|'='
name|'new_type'
op|'['
string|"'id'"
op|']'
newline|'\n'
name|'flavor_id'
op|'='
name|'new_type'
op|'['
string|"'flavorid'"
op|']'
newline|'\n'
name|'instance_p'
op|'='
name|'obj_base'
op|'.'
name|'obj_to_primitive'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_p'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'.'
name|'host'
op|'='
string|"'foo'"
newline|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'RESIZE_PREP'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'prep_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'new_type'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
name|'reservations'
op|'='
op|'['
op|']'
op|','
nl|'\n'
name|'request_spec'
op|'='
op|'{'
op|'}'
op|','
name|'filter_properties'
op|'='
op|'{'
op|'}'
op|','
name|'node'
op|'='
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_stub_out_resize_network_methods'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'migration'
op|'='
name|'migration_obj'
op|'.'
name|'Migration'
op|'.'
name|'get_by_instance_and_status'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'uuid'
op|','
string|"'pre-migrating'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'resize_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
name|'instance_type'
op|'='
name|'new_type'
op|','
nl|'\n'
name|'reservations'
op|'='
op|'['
op|']'
op|')'
newline|'\n'
name|'timeutils'
op|'.'
name|'set_time_override'
op|'('
name|'cur_time'
op|')'
newline|'\n'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'finish_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|','
name|'reservations'
op|'='
op|'['
op|']'
op|','
nl|'\n'
name|'disk_info'
op|'='
op|'{'
op|'}'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.finish_resize.start'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.finish_resize.end'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'priority'
op|','
string|"'INFO'"
op|')'
newline|'\n'
name|'payload'
op|'='
name|'msg'
op|'.'
name|'payload'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'tenant_id'"
op|']'
op|','
name|'self'
op|'.'
name|'project_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'user_id'"
op|']'
op|','
name|'self'
op|'.'
name|'user_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'instance_id'"
op|']'
op|','
name|'instance'
op|'.'
name|'uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'instance_type'"
op|']'
op|','
string|"'m1.small'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'payload'
op|'['
string|"'instance_type_id'"
op|']'
op|')'
op|','
name|'str'
op|'('
name|'new_type_id'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'payload'
op|'['
string|"'instance_flavor_id'"
op|']'
op|')'
op|','
name|'str'
op|'('
name|'flavor_id'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'display_name'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'created_at'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'launched_at'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'launched_at'"
op|']'
op|','
name|'timeutils'
op|'.'
name|'strtime'
op|'('
name|'cur_time'
op|')'
op|')'
newline|'\n'
name|'image_ref_url'
op|'='
name|'glance'
op|'.'
name|'generate_image_url'
op|'('
name|'FAKE_IMAGE_REF'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'image_ref_url'"
op|']'
op|','
name|'image_ref_url'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_resize_instance_notification
dedent|''
name|'def'
name|'test_resize_instance_notification'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure notifications on instance migrate/resize.'
nl|'\n'
indent|'        '
name|'old_time'
op|'='
name|'datetime'
op|'.'
name|'datetime'
op|'('
number|'2012'
op|','
number|'4'
op|','
number|'1'
op|')'
newline|'\n'
name|'cur_time'
op|'='
name|'datetime'
op|'.'
name|'datetime'
op|'('
number|'2012'
op|','
number|'12'
op|','
number|'21'
op|','
number|'12'
op|','
number|'21'
op|')'
newline|'\n'
name|'timeutils'
op|'.'
name|'set_time_override'
op|'('
name|'old_time'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'timeutils'
op|'.'
name|'set_time_override'
op|'('
name|'cur_time'
op|')'
newline|'\n'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
name|'instance'
op|'.'
name|'host'
op|'='
string|"'foo'"
newline|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'RESIZE_PREP'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'prep_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'instance_type'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
name|'reservations'
op|'='
op|'['
op|']'
op|','
nl|'\n'
name|'request_spec'
op|'='
op|'{'
op|'}'
op|','
name|'filter_properties'
op|'='
op|'{'
op|'}'
op|','
name|'node'
op|'='
name|'None'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'migration_get_by_instance_and_status'
op|'('
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'uuid'
op|','
nl|'\n'
string|"'pre-migrating'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'3'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.exists'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.resize.prep.start'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'2'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.resize.prep.end'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'priority'
op|','
string|"'INFO'"
op|')'
newline|'\n'
name|'payload'
op|'='
name|'msg'
op|'.'
name|'payload'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'tenant_id'"
op|']'
op|','
name|'self'
op|'.'
name|'project_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'user_id'"
op|']'
op|','
name|'self'
op|'.'
name|'user_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'instance_id'"
op|']'
op|','
name|'instance'
op|'.'
name|'uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'instance_type'"
op|']'
op|','
string|"'m1.tiny'"
op|')'
newline|'\n'
name|'type_id'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
string|"'m1.tiny'"
op|')'
op|'['
string|"'id'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'payload'
op|'['
string|"'instance_type_id'"
op|']'
op|')'
op|','
name|'str'
op|'('
name|'type_id'
op|')'
op|')'
newline|'\n'
name|'flavor_id'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
string|"'m1.tiny'"
op|')'
op|'['
string|"'flavorid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'payload'
op|'['
string|"'instance_flavor_id'"
op|']'
op|')'
op|','
name|'str'
op|'('
name|'flavor_id'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'display_name'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'created_at'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'launched_at'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'image_ref_url'
op|'='
name|'glance'
op|'.'
name|'generate_image_url'
op|'('
name|'FAKE_IMAGE_REF'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'image_ref_url'"
op|']'
op|','
name|'image_ref_url'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_prep_resize_instance_migration_error_on_same_host
dedent|''
name|'def'
name|'test_prep_resize_instance_migration_error_on_same_host'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Ensure prep_resize raise a migration error if destination is set on\n        the same source host and allow_resize_to_same_host is false\n        """'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'host'
op|'='
string|'"foo"'
op|','
name|'allow_resize_to_same_host'
op|'='
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'reservations'
op|'='
name|'self'
op|'.'
name|'_ensure_quota_reservations_rolledback'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instance_p'
op|'='
name|'obj_base'
op|'.'
name|'obj_to_primitive'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_p'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'host'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'MigrationError'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'prep_resize'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'instance_type'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'reservations'
op|'='
name|'reservations'
op|','
name|'request_spec'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|'='
op|'{'
op|'}'
op|','
name|'node'
op|'='
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_prep_resize_instance_migration_error_on_none_host
dedent|''
name|'def'
name|'test_prep_resize_instance_migration_error_on_none_host'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Ensure prep_resize raises a migration error if destination host is\n        not defined\n        """'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'reservations'
op|'='
name|'self'
op|'.'
name|'_ensure_quota_reservations_rolledback'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instance_p'
op|'='
name|'obj_base'
op|'.'
name|'obj_to_primitive'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_p'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'host'
op|'='
name|'None'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'MigrationError'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'prep_resize'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'instance_type'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'reservations'
op|'='
name|'reservations'
op|','
name|'request_spec'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|'='
op|'{'
op|'}'
op|','
name|'node'
op|'='
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_resize_instance_driver_error
dedent|''
name|'def'
name|'test_resize_instance_driver_error'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance status set to Error on resize error.'
nl|'\n'
nl|'\n'
DECL|function|throw_up
indent|'        '
name|'def'
name|'throw_up'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'migrate_disk_and_power_off'"
op|','
nl|'\n'
name|'throw_up'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'reservations'
op|'='
name|'self'
op|'.'
name|'_ensure_quota_reservations_rolledback'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instance_p'
op|'='
name|'obj_base'
op|'.'
name|'obj_to_primitive'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_p'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'host'
op|'='
string|"'foo'"
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'prep_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'instance_type'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'reservations'
op|'='
name|'reservations'
op|','
name|'request_spec'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|'='
op|'{'
op|'}'
op|','
name|'node'
op|'='
name|'None'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'RESIZE_PREP'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'migration'
op|'='
name|'migration_obj'
op|'.'
name|'Migration'
op|'.'
name|'get_by_instance_and_status'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'uuid'
op|','
string|"'pre-migrating'"
op|')'
newline|'\n'
nl|'\n'
comment|'#verify'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'resize_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'reservations'
op|'='
name|'reservations'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance_type'
op|')'
op|')'
newline|'\n'
comment|"# NOTE(comstud): error path doesn't use objects, so our object"
nl|'\n'
comment|'# is not updated.  Refresh and compare against the DB.'
nl|'\n'
name|'instance'
op|'.'
name|'refresh'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'.'
name|'vm_state'
op|','
name|'vm_states'
op|'.'
name|'ERROR'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_resize_instance_driver_rollback
dedent|''
name|'def'
name|'test_resize_instance_driver_rollback'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance status set to Running after rollback.'
nl|'\n'
nl|'\n'
DECL|function|throw_up
indent|'        '
name|'def'
name|'throw_up'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceFaultRollback'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'migrate_disk_and_power_off'"
op|','
nl|'\n'
name|'throw_up'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
name|'reservations'
op|'='
name|'self'
op|'.'
name|'_ensure_quota_reservations_rolledback'
op|'('
op|')'
newline|'\n'
name|'instance_p'
op|'='
name|'obj_base'
op|'.'
name|'obj_to_primitive'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_p'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'host'
op|'='
string|"'foo'"
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'prep_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'instance_type'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'reservations'
op|'='
name|'reservations'
op|','
name|'request_spec'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|'='
op|'{'
op|'}'
op|','
name|'node'
op|'='
name|'None'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'RESIZE_PREP'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'migration'
op|'='
name|'migration_obj'
op|'.'
name|'Migration'
op|'.'
name|'get_by_instance_and_status'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'uuid'
op|','
string|"'pre-migrating'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'resize_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'reservations'
op|'='
name|'reservations'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance_type'
op|')'
op|')'
newline|'\n'
comment|"# NOTE(comstud): error path doesn't use objects, so our object"
nl|'\n'
comment|'# is not updated.  Refresh and compare against the DB.'
nl|'\n'
name|'instance'
op|'.'
name|'refresh'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'.'
name|'vm_state'
op|','
name|'vm_states'
op|'.'
name|'ACTIVE'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'instance'
op|'.'
name|'task_state'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_resize_instance
dedent|''
name|'def'
name|'test_resize_instance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance can be migrated/resized.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instance_p'
op|'='
name|'obj_base'
op|'.'
name|'obj_to_primitive'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_p'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'host'
op|'='
string|"'foo'"
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'prep_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'instance_type'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
name|'reservations'
op|'='
op|'['
op|']'
op|','
nl|'\n'
name|'request_spec'
op|'='
op|'{'
op|'}'
op|','
name|'filter_properties'
op|'='
op|'{'
op|'}'
op|','
name|'node'
op|'='
name|'None'
op|')'
newline|'\n'
nl|'\n'
comment|"# verify 'old_vm_state' was set on system_metadata"
nl|'\n'
name|'instance'
op|'.'
name|'refresh'
op|'('
op|')'
newline|'\n'
name|'sys_meta'
op|'='
name|'instance'
op|'.'
name|'system_metadata'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'vm_states'
op|'.'
name|'ACTIVE'
op|','
name|'sys_meta'
op|'['
string|"'old_vm_state'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_stub_out_resize_network_methods'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'RESIZE_PREP'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'migration'
op|'='
name|'migration_obj'
op|'.'
name|'Migration'
op|'.'
name|'get_by_instance_and_status'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'uuid'
op|','
string|"'pre-migrating'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'resize_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
name|'reservations'
op|'='
op|'['
op|']'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance_type'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'migration'
op|'.'
name|'dest_compute'
op|','
name|'instance'
op|'.'
name|'host'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_confirm_resize
dedent|''
name|'def'
name|'_test_confirm_resize'
op|'('
name|'self'
op|','
name|'power_on'
op|')'
op|':'
newline|'\n'
comment|'# Common test case method for confirm_resize'
nl|'\n'
DECL|function|fake
indent|'        '
name|'def'
name|'fake'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
DECL|function|fake_confirm_migration_driver
dedent|''
name|'def'
name|'fake_confirm_migration_driver'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
comment|'# Confirm the instance uses the new type in finish_resize'
nl|'\n'
indent|'            '
name|'inst'
op|'='
name|'args'
op|'['
number|'1'
op|']'
newline|'\n'
name|'sys_meta'
op|'='
name|'inst'
op|'['
string|"'system_metadata'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'sys_meta'
op|'['
string|"'instance_type_flavorid'"
op|']'
op|','
string|"'3'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'old_vm_state'
op|'='
name|'None'
newline|'\n'
name|'p_state'
op|'='
name|'None'
newline|'\n'
name|'if'
name|'power_on'
op|':'
newline|'\n'
indent|'            '
name|'old_vm_state'
op|'='
name|'vm_states'
op|'.'
name|'ACTIVE'
newline|'\n'
name|'p_state'
op|'='
name|'power_state'
op|'.'
name|'RUNNING'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'old_vm_state'
op|'='
name|'vm_states'
op|'.'
name|'STOPPED'
newline|'\n'
name|'p_state'
op|'='
name|'power_state'
op|'.'
name|'SHUTDOWN'
newline|'\n'
dedent|''
name|'params'
op|'='
op|'{'
string|"'vm_state'"
op|':'
name|'old_vm_state'
op|','
string|"'power_state'"
op|':'
name|'p_state'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
name|'params'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'allow_resize_to_same_host'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'finish_migration'"
op|','
name|'fake'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'confirm_migration'"
op|','
nl|'\n'
name|'fake_confirm_migration_driver'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_stub_out_resize_network_methods'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'reservations'
op|'='
name|'self'
op|'.'
name|'_ensure_quota_reservations_committed'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instance_p'
op|'='
name|'obj_base'
op|'.'
name|'obj_to_primitive'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_p'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
comment|'# Confirm the instance size before the resize starts'
nl|'\n'
name|'instance'
op|'.'
name|'refresh'
op|'('
op|')'
newline|'\n'
name|'instance_type_ref'
op|'='
name|'db'
op|'.'
name|'flavor_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'instance_type_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance_type_ref'
op|'['
string|"'flavorid'"
op|']'
op|','
string|"'1'"
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'.'
name|'vm_state'
op|'='
name|'old_vm_state'
newline|'\n'
name|'instance'
op|'.'
name|'power_state'
op|'='
name|'p_state'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'new_instance_type_ref'
op|'='
name|'db'
op|'.'
name|'flavor_get_by_flavor_id'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
number|'3'
op|')'
newline|'\n'
name|'new_instance_type_p'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'new_instance_type_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'prep_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'new_instance_type_p'
op|','
nl|'\n'
name|'image'
op|'='
op|'{'
op|'}'
op|','
name|'reservations'
op|'='
name|'reservations'
op|','
name|'request_spec'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|'='
op|'{'
op|'}'
op|','
name|'node'
op|'='
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'migration'
op|'='
name|'migration_obj'
op|'.'
name|'Migration'
op|'.'
name|'get_by_instance_and_status'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'uuid'
op|','
string|"'pre-migrating'"
op|')'
newline|'\n'
nl|'\n'
comment|'# NOTE(mriedem): ensure prep_resize set old_vm_state in system_metadata'
nl|'\n'
name|'sys_meta'
op|'='
name|'instance'
op|'.'
name|'system_metadata'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'old_vm_state'
op|','
name|'sys_meta'
op|'['
string|"'old_vm_state'"
op|']'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'RESIZE_PREP'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'resize_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|','
nl|'\n'
name|'image'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'reservations'
op|'='
op|'['
op|']'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'new_instance_type_p'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'finish_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|','
name|'reservations'
op|'='
op|'['
op|']'
op|','
nl|'\n'
name|'disk_info'
op|'='
op|'{'
op|'}'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
comment|'# Prove that the instance size is now the new size'
nl|'\n'
name|'instance_type_ref'
op|'='
name|'db'
op|'.'
name|'flavor_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'instance_type_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance_type_ref'
op|'['
string|"'flavorid'"
op|']'
op|','
string|"'3'"
op|')'
newline|'\n'
nl|'\n'
comment|'# Finally, confirm the resize and verify the new flavor is applied'
nl|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'None'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'confirm_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'reservations'
op|'='
name|'reservations'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'.'
name|'refresh'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instance_type_ref'
op|'='
name|'db'
op|'.'
name|'flavor_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'instance_type_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance_type_ref'
op|'['
string|"'flavorid'"
op|']'
op|','
string|"'3'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'fake-mini'"
op|','
name|'migration'
op|'.'
name|'source_compute'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'old_vm_state'
op|','
name|'instance'
op|'.'
name|'vm_state'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'instance'
op|'.'
name|'task_state'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'p_state'
op|','
name|'instance'
op|'.'
name|'power_state'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_confirm_resize_from_active
dedent|''
name|'def'
name|'test_confirm_resize_from_active'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_confirm_resize'
op|'('
name|'power_on'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_confirm_resize_from_stopped
dedent|''
name|'def'
name|'test_confirm_resize_from_stopped'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_confirm_resize'
op|'('
name|'power_on'
op|'='
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_finish_revert_resize
dedent|''
name|'def'
name|'_test_finish_revert_resize'
op|'('
name|'self'
op|','
name|'power_on'
op|','
nl|'\n'
name|'remove_old_vm_state'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Convenience method that does most of the work for the\n        test_finish_revert_resize tests.\n        :param power_on -- True if testing resize from ACTIVE state, False if\n        testing resize from STOPPED state.\n        :param remove_old_vm_state -- True if testing a case where the\n        \'old_vm_state\' system_metadata is not present when the\n        finish_revert_resize method is called.\n        """'
newline|'\n'
DECL|function|fake
name|'def'
name|'fake'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
DECL|function|fake_finish_revert_migration_driver
dedent|''
name|'def'
name|'fake_finish_revert_migration_driver'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
comment|'# Confirm the instance uses the old type in finish_revert_resize'
nl|'\n'
indent|'            '
name|'inst'
op|'='
name|'args'
op|'['
number|'1'
op|']'
newline|'\n'
name|'sys_meta'
op|'='
name|'inst'
op|'.'
name|'system_metadata'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'sys_meta'
op|'['
string|"'instance_type_flavorid'"
op|']'
op|','
string|"'1'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'old_vm_state'
op|'='
name|'None'
newline|'\n'
name|'if'
name|'power_on'
op|':'
newline|'\n'
indent|'            '
name|'old_vm_state'
op|'='
name|'vm_states'
op|'.'
name|'ACTIVE'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'old_vm_state'
op|'='
name|'vm_states'
op|'.'
name|'STOPPED'
newline|'\n'
dedent|''
name|'params'
op|'='
op|'{'
string|"'vm_state'"
op|':'
name|'old_vm_state'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
name|'params'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'finish_migration'"
op|','
name|'fake'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'finish_revert_migration'"
op|','
nl|'\n'
name|'fake_finish_revert_migration_driver'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_stub_out_resize_network_methods'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'reservations'
op|'='
name|'self'
op|'.'
name|'_ensure_quota_reservations_committed'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instance_p'
op|'='
name|'obj_base'
op|'.'
name|'obj_to_primitive'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_p'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'.'
name|'refresh'
op|'('
op|')'
newline|'\n'
name|'instance_type_ref'
op|'='
name|'db'
op|'.'
name|'flavor_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'instance_type_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance_type_ref'
op|'['
string|"'flavorid'"
op|']'
op|','
string|"'1'"
op|')'
newline|'\n'
nl|'\n'
name|'old_vm_state'
op|'='
name|'instance'
op|'['
string|"'vm_state'"
op|']'
newline|'\n'
nl|'\n'
name|'instance'
op|'.'
name|'host'
op|'='
string|"'foo'"
newline|'\n'
name|'instance'
op|'.'
name|'vm_state'
op|'='
name|'old_vm_state'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'new_instance_type_ref'
op|'='
name|'db'
op|'.'
name|'flavor_get_by_flavor_id'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
number|'3'
op|')'
newline|'\n'
name|'new_instance_type_p'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'new_instance_type_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'prep_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'new_instance_type_p'
op|','
nl|'\n'
name|'image'
op|'='
op|'{'
op|'}'
op|','
name|'reservations'
op|'='
name|'reservations'
op|','
name|'request_spec'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|'='
op|'{'
op|'}'
op|','
name|'node'
op|'='
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'migration'
op|'='
name|'migration_obj'
op|'.'
name|'Migration'
op|'.'
name|'get_by_instance_and_status'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'uuid'
op|','
string|"'pre-migrating'"
op|')'
newline|'\n'
nl|'\n'
comment|'# NOTE(mriedem): ensure prep_resize set old_vm_state in system_metadata'
nl|'\n'
name|'sys_meta'
op|'='
name|'instance'
op|'.'
name|'system_metadata'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'old_vm_state'
op|','
name|'sys_meta'
op|'['
string|"'old_vm_state'"
op|']'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'RESIZE_PREP'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'resize_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|','
nl|'\n'
name|'image'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'reservations'
op|'='
op|'['
op|']'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'new_instance_type_p'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'finish_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|','
name|'reservations'
op|'='
op|'['
op|']'
op|','
nl|'\n'
name|'disk_info'
op|'='
op|'{'
op|'}'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
comment|'# Prove that the instance size is now the new size'
nl|'\n'
name|'instance_type_ref'
op|'='
name|'db'
op|'.'
name|'flavor_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'instance_type_id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance_type_ref'
op|'['
string|"'flavorid'"
op|']'
op|','
string|"'3'"
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'RESIZE_REVERTING'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'revert_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'reservations'
op|'='
name|'reservations'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'.'
name|'refresh'
op|'('
op|')'
newline|'\n'
name|'if'
name|'remove_old_vm_state'
op|':'
newline|'\n'
comment|'# need to wipe out the old_vm_state from system_metadata'
nl|'\n'
comment|'# before calling finish_revert_resize'
nl|'\n'
indent|'            '
name|'sys_meta'
op|'='
name|'instance'
op|'.'
name|'system_metadata'
newline|'\n'
name|'sys_meta'
op|'.'
name|'pop'
op|'('
string|"'old_vm_state'"
op|')'
newline|'\n'
comment|'# Have to reset for save() to work'
nl|'\n'
name|'instance'
op|'.'
name|'system_metadata'
op|'='
name|'sys_meta'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'compute'
op|'.'
name|'finish_revert_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|','
name|'reservations'
op|'='
name|'reservations'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'instance'
op|'.'
name|'task_state'
op|')'
newline|'\n'
nl|'\n'
name|'instance_type_ref'
op|'='
name|'db'
op|'.'
name|'flavor_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'instance_type_id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance_type_ref'
op|'['
string|"'flavorid'"
op|']'
op|','
string|"'1'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'.'
name|'host'
op|','
name|'migration'
op|'.'
name|'source_compute'
op|')'
newline|'\n'
name|'if'
name|'remove_old_vm_state'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'vm_states'
op|'.'
name|'ACTIVE'
op|','
name|'instance'
op|'.'
name|'vm_state'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'old_vm_state'
op|','
name|'instance'
op|'.'
name|'vm_state'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_finish_revert_resize_from_active
dedent|''
dedent|''
name|'def'
name|'test_finish_revert_resize_from_active'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_finish_revert_resize'
op|'('
name|'power_on'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_finish_revert_resize_from_stopped
dedent|''
name|'def'
name|'test_finish_revert_resize_from_stopped'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_finish_revert_resize'
op|'('
name|'power_on'
op|'='
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_finish_revert_resize_from_stopped_remove_old_vm_state
dedent|''
name|'def'
name|'test_finish_revert_resize_from_stopped_remove_old_vm_state'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# in  this case we resize from STOPPED but end up with ACTIVE'
nl|'\n'
comment|'# because the old_vm_state value is not present in'
nl|'\n'
comment|'# finish_revert_resize'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_finish_revert_resize'
op|'('
name|'power_on'
op|'='
name|'False'
op|','
nl|'\n'
name|'remove_old_vm_state'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_cleanup_stored_instance_types
dedent|''
name|'def'
name|'_test_cleanup_stored_instance_types'
op|'('
name|'self'
op|','
name|'old'
op|','
name|'new'
op|','
name|'revert'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'migration'
op|'='
name|'dict'
op|'('
name|'old_instance_type_id'
op|'='
name|'old'
op|','
nl|'\n'
name|'new_instance_type_id'
op|'='
name|'new'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'system_metadata'
op|'='
name|'dict'
op|'('
name|'instance_type_id'
op|'='
name|'old'
op|')'
newline|'\n'
name|'sys_meta'
op|'='
name|'dict'
op|'('
name|'instance'
op|'.'
name|'system_metadata'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'flavors'
op|','
string|"'extract_flavor'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'flavors'
op|','
string|"'delete_flavor_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'flavors'
op|','
string|"'save_flavor_info'"
op|')'
newline|'\n'
name|'if'
name|'revert'
op|':'
newline|'\n'
indent|'            '
name|'flavors'
op|'.'
name|'extract_flavor'
op|'('
name|'instance'
op|','
string|"'old_'"
op|')'
op|'.'
name|'AndReturn'
op|'('
nl|'\n'
op|'{'
string|"'instance_type_id'"
op|':'
name|'old'
op|'}'
op|')'
newline|'\n'
name|'flavors'
op|'.'
name|'save_flavor_info'
op|'('
nl|'\n'
name|'sys_meta'
op|','
op|'{'
string|"'instance_type_id'"
op|':'
name|'old'
op|'}'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'sys_meta'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'flavors'
op|'.'
name|'extract_flavor'
op|'('
name|'instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
nl|'\n'
op|'{'
string|"'instance_type_id'"
op|':'
name|'new'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'flavors'
op|'.'
name|'delete_flavor_info'
op|'('
nl|'\n'
name|'sys_meta'
op|','
string|"'old_'"
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'sys_meta'
op|')'
newline|'\n'
name|'flavors'
op|'.'
name|'delete_flavor_info'
op|'('
nl|'\n'
name|'sys_meta'
op|','
string|"'new_'"
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'sys_meta'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'res'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_cleanup_stored_instance_types'
op|'('
name|'migration'
op|','
name|'instance'
op|','
nl|'\n'
name|'revert'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'res'
op|','
nl|'\n'
op|'('
name|'sys_meta'
op|','
nl|'\n'
op|'{'
string|"'instance_type_id'"
op|':'
name|'revert'
name|'and'
name|'old'
name|'or'
name|'new'
op|'}'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_cleanup_stored_instance_types_for_resize
dedent|''
name|'def'
name|'test_cleanup_stored_instance_types_for_resize'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_cleanup_stored_instance_types'
op|'('
string|"'1'"
op|','
string|"'2'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_cleanup_stored_instance_types_for_resize_with_update
dedent|''
name|'def'
name|'test_cleanup_stored_instance_types_for_resize_with_update'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_cleanup_stored_instance_types'
op|'('
string|"'1'"
op|','
string|"'2'"
op|','
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_cleanup_stored_instance_types_for_migration
dedent|''
name|'def'
name|'test_cleanup_stored_instance_types_for_migration'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_cleanup_stored_instance_types'
op|'('
string|"'1'"
op|','
string|"'1'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_cleanup_stored_instance_types_for_migration_with_update
dedent|''
name|'def'
name|'test_cleanup_stored_instance_types_for_migration_with_update'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_cleanup_stored_instance_types'
op|'('
string|"'1'"
op|','
string|"'1'"
op|','
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_by_flavor_id
dedent|''
name|'def'
name|'test_get_by_flavor_id'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'type'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_flavor_id'
op|'('
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'type'
op|'['
string|"'name'"
op|']'
op|','
string|"'m1.tiny'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_resize_same_source_fails
dedent|''
name|'def'
name|'test_resize_same_source_fails'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Ensure instance fails to migrate when source and destination are\n        the same host.\n        """'
newline|'\n'
name|'reservations'
op|'='
name|'self'
op|'.'
name|'_ensure_quota_reservations_rolledback'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'instance_p'
op|'='
name|'obj_base'
op|'.'
name|'obj_to_primitive'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_p'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'refresh'
op|'('
op|')'
newline|'\n'
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'MigrationError'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'prep_resize'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'instance_type'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'reservations'
op|'='
name|'reservations'
op|','
name|'request_spec'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|'='
op|'{'
op|'}'
op|','
name|'node'
op|'='
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_resize_instance_handles_migration_error
dedent|''
name|'def'
name|'test_resize_instance_handles_migration_error'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure vm_state is ERROR when error occurs.'
nl|'\n'
DECL|function|raise_migration_failure
indent|'        '
name|'def'
name|'raise_migration_failure'
op|'('
op|'*'
name|'args'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
nl|'\n'
string|"'migrate_disk_and_power_off'"
op|','
nl|'\n'
name|'raise_migration_failure'
op|')'
newline|'\n'
nl|'\n'
name|'reservations'
op|'='
name|'self'
op|'.'
name|'_ensure_quota_reservations_rolledback'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instance_p'
op|'='
name|'obj_base'
op|'.'
name|'obj_to_primitive'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_p'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'host'
op|'='
string|"'foo'"
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'prep_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'instance_type'
op|','
nl|'\n'
name|'image'
op|'='
op|'{'
op|'}'
op|','
name|'reservations'
op|'='
name|'reservations'
op|','
nl|'\n'
name|'request_spec'
op|'='
op|'{'
op|'}'
op|','
name|'filter_properties'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'node'
op|'='
name|'None'
op|')'
newline|'\n'
name|'migration'
op|'='
name|'migration_obj'
op|'.'
name|'Migration'
op|'.'
name|'get_by_instance_and_status'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'uuid'
op|','
string|"'pre-migrating'"
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'RESIZE_PREP'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'resize_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|','
name|'image'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'reservations'
op|'='
name|'reservations'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance_type'
op|')'
op|')'
newline|'\n'
comment|"# NOTE(comstud): error path doesn't use objects, so our object"
nl|'\n'
comment|'# is not updated.  Refresh and compare against the DB.'
nl|'\n'
name|'instance'
op|'.'
name|'refresh'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'.'
name|'vm_state'
op|','
name|'vm_states'
op|'.'
name|'ERROR'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_pre_live_migration_instance_has_no_fixed_ip
dedent|''
name|'def'
name|'test_pre_live_migration_instance_has_no_fixed_ip'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Confirm that no exception is raised if there is no fixed ip on'
nl|'\n'
comment|'# pre_live_migration'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'c'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'pre_live_migration'
op|'('
name|'mox'
op|'.'
name|'IsA'
op|'('
name|'c'
op|')'
op|','
name|'mox'
op|'.'
name|'IsA'
op|'('
name|'instance'
op|')'
op|','
nl|'\n'
op|'{'
string|"'block_device_mapping'"
op|':'
op|'['
op|']'
op|'}'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_pre_live_migration_works_correctly
dedent|''
name|'def'
name|'test_pre_live_migration_works_correctly'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Confirm setup_compute_volume is called when volume is mounted.'
nl|'\n'
DECL|function|stupid
indent|'        '
name|'def'
name|'stupid'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'fake_network'
op|'.'
name|'fake_get_instance_nw_info'
op|'('
name|'self'
op|'.'
name|'stubs'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'compute'
op|'.'
name|'manager'
op|'.'
name|'ComputeManager'
op|','
nl|'\n'
string|"'_get_instance_nw_info'"
op|','
name|'stupid'
op|')'
newline|'\n'
nl|'\n'
comment|'# creating instance testdata'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
op|'{'
string|"'host'"
op|':'
string|"'dummy'"
op|'}'
op|')'
op|')'
newline|'\n'
name|'c'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'nw_info'
op|'='
name|'fake_network'
op|'.'
name|'fake_get_instance_nw_info'
op|'('
name|'self'
op|'.'
name|'stubs'
op|')'
newline|'\n'
nl|'\n'
comment|'# creating mocks'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'pre_live_migration'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'pre_live_migration'
op|'('
name|'mox'
op|'.'
name|'IsA'
op|'('
name|'c'
op|')'
op|','
name|'mox'
op|'.'
name|'IsA'
op|'('
name|'instance'
op|')'
op|','
nl|'\n'
op|'{'
string|"'block_device_mapping'"
op|':'
op|'['
op|']'
op|'}'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
nl|'\n'
string|"'ensure_filtering_rules_for_instance'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'ensure_filtering_rules_for_instance'
op|'('
nl|'\n'
name|'mox'
op|'.'
name|'IsA'
op|'('
name|'instance'
op|')'
op|','
name|'nw_info'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|','
nl|'\n'
string|"'setup_networks_on_host'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|'.'
name|'setup_networks_on_host'
op|'('
name|'c'
op|','
name|'instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|')'
newline|'\n'
nl|'\n'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
comment|'# start test'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'migrate_data'
op|'='
op|'{'
string|"'is_shared_storage'"
op|':'
name|'False'
op|'}'
newline|'\n'
name|'ret'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'pre_live_migration'
op|'('
name|'c'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'block_migration'
op|'='
name|'False'
op|','
name|'disk'
op|'='
name|'None'
op|','
nl|'\n'
name|'migrate_data'
op|'='
name|'migrate_data'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'ret'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.live_migration.pre.start'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.live_migration.pre.end'"
op|')'
newline|'\n'
nl|'\n'
comment|'# cleanup'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_live_migration_exception_rolls_back
dedent|''
name|'def'
name|'test_live_migration_exception_rolls_back'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Confirm exception when pre_live_migration fails.'
nl|'\n'
indent|'        '
name|'c'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'src_host'
op|'='
string|"'fake-src-host'"
newline|'\n'
name|'instance'
op|'='
name|'dict'
op|'('
name|'uuid'
op|'='
string|"'fake_instance'"
op|','
name|'host'
op|'='
name|'src_host'
op|','
nl|'\n'
name|'name'
op|'='
string|"'fake-name'"
op|')'
newline|'\n'
name|'updated_instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
op|'{'
string|"'host'"
op|':'
string|"'fake-dest-host'"
op|'}'
op|')'
newline|'\n'
name|'dest_host'
op|'='
name|'updated_instance'
op|'['
string|"'host'"
op|']'
newline|'\n'
name|'fake_bdms'
op|'='
op|'['
name|'dict'
op|'('
name|'volume_id'
op|'='
string|"'vol1-id'"
op|')'
op|','
name|'dict'
op|'('
name|'volume_id'
op|'='
string|"'vol2-id'"
op|')'
op|']'
newline|'\n'
nl|'\n'
comment|'# creating mocks'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
nl|'\n'
string|"'get_instance_disk_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_rpcapi'
op|','
nl|'\n'
string|"'pre_live_migration'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_instance_update'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_instance_volume_bdms'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|','
nl|'\n'
string|"'setup_networks_on_host'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_rpcapi'
op|','
nl|'\n'
string|"'remove_volume_connection'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_rpcapi'
op|','
nl|'\n'
string|"'rollback_live_migration_at_destination'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'get_instance_disk_info'
op|'('
nl|'\n'
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
op|'.'
name|'AndReturn'
op|'('
string|"'fake_disk'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_rpcapi'
op|'.'
name|'pre_live_migration'
op|'('
name|'c'
op|','
nl|'\n'
name|'instance'
op|','
name|'True'
op|','
string|"'fake_disk'"
op|','
name|'dest_host'
op|','
nl|'\n'
op|'{'
op|'}'
op|')'
op|'.'
name|'AndRaise'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_instance_update'
op|'('
name|'c'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
name|'host'
op|'='
name|'src_host'
op|','
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'ACTIVE'
op|','
nl|'\n'
name|'task_state'
op|'='
name|'None'
op|','
nl|'\n'
name|'expected_task_state'
op|'='
name|'task_states'
op|'.'
name|'MIGRATING'
op|')'
op|'.'
name|'AndReturn'
op|'('
nl|'\n'
name|'updated_instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|'.'
name|'setup_networks_on_host'
op|'('
name|'c'
op|','
nl|'\n'
name|'updated_instance'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instance_volume_bdms'
op|'('
name|'c'
op|','
nl|'\n'
name|'updated_instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'fake_bdms'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_rpcapi'
op|'.'
name|'remove_volume_connection'
op|'('
nl|'\n'
name|'c'
op|','
name|'updated_instance'
op|','
string|"'vol1-id'"
op|','
name|'dest_host'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_rpcapi'
op|'.'
name|'remove_volume_connection'
op|'('
nl|'\n'
name|'c'
op|','
name|'updated_instance'
op|','
string|"'vol2-id'"
op|','
name|'dest_host'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_rpcapi'
op|'.'
name|'rollback_live_migration_at_destination'
op|'('
nl|'\n'
name|'c'
op|','
name|'updated_instance'
op|','
name|'dest_host'
op|')'
newline|'\n'
nl|'\n'
comment|'# start test'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'live_migration'
op|','
nl|'\n'
name|'c'
op|','
name|'dest'
op|'='
name|'dest_host'
op|','
name|'block_migration'
op|'='
name|'True'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|','
name|'migrate_data'
op|'='
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_live_migration_works_correctly
dedent|''
name|'def'
name|'test_live_migration_works_correctly'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Confirm live_migration() works as expected correctly.'
nl|'\n'
comment|'# creating instance testdata'
nl|'\n'
indent|'        '
name|'c'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'instance_ref'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'instance_ref'
op|'['
string|"'host'"
op|']'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
newline|'\n'
name|'dest'
op|'='
string|"'desthost'"
newline|'\n'
name|'inst_uuid'
op|'='
name|'instance_ref'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance_ref'
op|')'
newline|'\n'
nl|'\n'
name|'migrate_data'
op|'='
op|'{'
string|"'is_shared_storage'"
op|':'
name|'False'
op|'}'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_rpcapi'
op|','
nl|'\n'
string|"'pre_live_migration'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_rpcapi'
op|'.'
name|'pre_live_migration'
op|'('
nl|'\n'
name|'c'
op|','
name|'instance'
op|','
name|'False'
op|','
name|'None'
op|','
name|'dest'
op|','
name|'migrate_data'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
nl|'\n'
string|"'network_migrate_instance_start'"
op|')'
newline|'\n'
name|'migration'
op|'='
op|'{'
string|"'source_compute'"
op|':'
name|'instance'
op|'['
string|"'host'"
op|']'
op|','
string|"'dest_compute'"
op|':'
name|'dest'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|'.'
name|'network_migrate_instance_start'
op|'('
name|'c'
op|','
name|'instance'
op|','
nl|'\n'
name|'migration'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_rpcapi'
op|','
nl|'\n'
string|"'post_live_migration_at_destination'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_rpcapi'
op|'.'
name|'post_live_migration_at_destination'
op|'('
nl|'\n'
name|'c'
op|','
name|'instance'
op|','
name|'False'
op|','
name|'dest'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|','
nl|'\n'
string|"'setup_networks_on_host'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|'.'
name|'setup_networks_on_host'
op|'('
name|'c'
op|','
name|'instance'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'host'"
op|']'
op|','
nl|'\n'
name|'teardown'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
comment|'# start test'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'ret'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'live_migration'
op|'('
name|'c'
op|','
name|'dest'
op|'='
name|'dest'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'block_migration'
op|'='
name|'False'
op|','
nl|'\n'
name|'migrate_data'
op|'='
name|'migrate_data'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'ret'
op|')'
newline|'\n'
nl|'\n'
comment|'# cleanup'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'inst_uuid'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_post_live_migration_no_shared_storage_working_correctly
dedent|''
name|'def'
name|'test_post_live_migration_no_shared_storage_working_correctly'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Confirm post_live_migration() works correctly as expected\n           for non shared storage migration.\n        """'
newline|'\n'
comment|'# Create stubs'
nl|'\n'
name|'result'
op|'='
op|'{'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fakedestroy
name|'def'
name|'fakedestroy'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'result'
op|'['
string|"'destroyed'"
op|']'
op|'='
name|'True'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'destroy'"
op|','
name|'fakedestroy'
op|')'
newline|'\n'
name|'dest'
op|'='
string|"'desthost'"
newline|'\n'
name|'srchost'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
newline|'\n'
nl|'\n'
comment|'# creating testdata'
nl|'\n'
name|'c'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'inst_ref'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
nl|'\n'
string|"'host'"
op|':'
name|'srchost'
op|','
nl|'\n'
string|"'state_description'"
op|':'
string|"'migrating'"
op|','
nl|'\n'
string|"'state'"
op|':'
name|'power_state'
op|'.'
name|'PAUSED'
op|'}'
op|')'
op|')'
newline|'\n'
name|'inst_uuid'
op|'='
name|'inst_ref'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'c'
op|','
name|'inst_uuid'
op|','
nl|'\n'
op|'{'
string|"'task_state'"
op|':'
name|'task_states'
op|'.'
name|'MIGRATING'
op|','
nl|'\n'
string|"'power_state'"
op|':'
name|'power_state'
op|'.'
name|'PAUSED'
op|'}'
op|')'
newline|'\n'
comment|'# creating mocks'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'unfilter_instance'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'unfilter_instance'
op|'('
name|'inst_ref'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
nl|'\n'
string|"'network_migrate_instance_start'"
op|')'
newline|'\n'
name|'migration'
op|'='
op|'{'
string|"'source_compute'"
op|':'
name|'srchost'
op|','
string|"'dest_compute'"
op|':'
name|'dest'
op|','
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|'.'
name|'network_migrate_instance_start'
op|'('
name|'c'
op|','
name|'inst_ref'
op|','
nl|'\n'
name|'migration'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_rpcapi'
op|','
nl|'\n'
string|"'post_live_migration_at_destination'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_rpcapi'
op|'.'
name|'post_live_migration_at_destination'
op|'('
nl|'\n'
name|'c'
op|','
name|'inst_ref'
op|','
name|'False'
op|','
name|'dest'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|','
nl|'\n'
string|"'setup_networks_on_host'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|'.'
name|'setup_networks_on_host'
op|'('
name|'c'
op|','
name|'inst_ref'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|','
nl|'\n'
name|'teardown'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
comment|'# start test'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'migrate_data'
op|'='
op|'{'
string|"'is_shared_storage'"
op|':'
name|'False'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_post_live_migration'
op|'('
name|'c'
op|','
name|'inst_ref'
op|','
name|'dest'
op|','
nl|'\n'
name|'migrate_data'
op|'='
name|'migrate_data'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'destroyed'"
op|','
name|'result'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'result'
op|'['
string|"'destroyed'"
op|']'
op|'=='
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_post_live_migration_working_correctly
dedent|''
name|'def'
name|'test_post_live_migration_working_correctly'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Confirm post_live_migration() works as expected correctly.'
nl|'\n'
indent|'        '
name|'dest'
op|'='
string|"'desthost'"
newline|'\n'
name|'srchost'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
newline|'\n'
nl|'\n'
comment|'# creating testdata'
nl|'\n'
name|'c'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'inst_ref'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
nl|'\n'
string|"'host'"
op|':'
name|'srchost'
op|','
nl|'\n'
string|"'state_description'"
op|':'
string|"'migrating'"
op|','
nl|'\n'
string|"'state'"
op|':'
name|'power_state'
op|'.'
name|'PAUSED'
op|'}'
op|')'
op|')'
newline|'\n'
name|'inst_uuid'
op|'='
name|'inst_ref'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'c'
op|','
name|'inst_uuid'
op|','
nl|'\n'
op|'{'
string|"'task_state'"
op|':'
name|'task_states'
op|'.'
name|'MIGRATING'
op|','
nl|'\n'
string|"'power_state'"
op|':'
name|'power_state'
op|'.'
name|'PAUSED'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# creating mocks'
nl|'\n'
name|'with'
name|'contextlib'
op|'.'
name|'nested'
op|'('
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'post_live_migration'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'unfilter_instance'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
nl|'\n'
string|"'network_migrate_instance_start'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_rpcapi'
op|','
nl|'\n'
string|"'post_live_migration_at_destination'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'unplug_vifs'"
op|')'
op|','
nl|'\n'
name|'mock'
op|'.'
name|'patch'
op|'.'
name|'object'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|','
nl|'\n'
string|"'setup_networks_on_host'"
op|')'
nl|'\n'
op|')'
name|'as'
op|'('
nl|'\n'
name|'post_live_migration'
op|','
name|'unfilter_instance'
op|','
nl|'\n'
name|'network_migrate_instance_start'
op|','
name|'post_live_migration_at_destination'
op|','
nl|'\n'
name|'unplug_vifs'
op|','
name|'setup_networks_on_host'
nl|'\n'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_post_live_migration'
op|'('
name|'c'
op|','
name|'inst_ref'
op|','
name|'dest'
op|')'
newline|'\n'
nl|'\n'
name|'post_live_migration'
op|'.'
name|'assert_has_calls'
op|'('
op|'['
nl|'\n'
name|'mock'
op|'.'
name|'call'
op|'('
name|'c'
op|','
name|'inst_ref'
op|','
op|'{'
string|"'block_device_mapping'"
op|':'
op|'['
op|']'
op|'}'
op|','
name|'None'
op|')'
op|']'
op|')'
newline|'\n'
name|'unfilter_instance'
op|'.'
name|'assert_has_calls'
op|'('
op|'['
name|'mock'
op|'.'
name|'call'
op|'('
name|'inst_ref'
op|','
op|'['
op|']'
op|')'
op|']'
op|')'
newline|'\n'
name|'migration'
op|'='
op|'{'
string|"'source_compute'"
op|':'
name|'srchost'
op|','
nl|'\n'
string|"'dest_compute'"
op|':'
name|'dest'
op|','
op|'}'
newline|'\n'
name|'network_migrate_instance_start'
op|'.'
name|'assert_has_calls'
op|'('
op|'['
nl|'\n'
name|'mock'
op|'.'
name|'call'
op|'('
name|'c'
op|','
name|'inst_ref'
op|','
name|'migration'
op|')'
op|']'
op|')'
newline|'\n'
name|'post_live_migration_at_destination'
op|'.'
name|'assert_has_calls'
op|'('
op|'['
nl|'\n'
name|'mock'
op|'.'
name|'call'
op|'('
name|'c'
op|','
name|'inst_ref'
op|','
name|'False'
op|','
name|'dest'
op|')'
op|']'
op|')'
newline|'\n'
name|'unplug_vifs'
op|'.'
name|'assert_has_calls'
op|'('
op|'['
name|'mock'
op|'.'
name|'call'
op|'('
name|'inst_ref'
op|','
op|'['
op|']'
op|')'
op|']'
op|')'
newline|'\n'
name|'setup_networks_on_host'
op|'.'
name|'assert_has_calls'
op|'('
op|'['
nl|'\n'
name|'mock'
op|'.'
name|'call'
op|'('
name|'c'
op|','
name|'inst_ref'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|','
name|'teardown'
op|'='
name|'True'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_begin_post_live_migration_at_destination
dedent|''
dedent|''
name|'def'
name|'_begin_post_live_migration_at_destination'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|','
nl|'\n'
string|"'setup_networks_on_host'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
nl|'\n'
string|"'network_migrate_instance_finish'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_power_state'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_compute_info'"
op|')'
newline|'\n'
nl|'\n'
name|'params'
op|'='
op|'{'
string|"'task_state'"
op|':'
name|'task_states'
op|'.'
name|'MIGRATING'
op|','
nl|'\n'
string|"'power_state'"
op|':'
name|'power_state'
op|'.'
name|'PAUSED'
op|','
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'admin_ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'admin_ctxt'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|'.'
name|'setup_networks_on_host'
op|'('
name|'self'
op|'.'
name|'admin_ctxt'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|')'
newline|'\n'
name|'migration'
op|'='
op|'{'
string|"'source_compute'"
op|':'
name|'self'
op|'.'
name|'instance'
op|'['
string|"'host'"
op|']'
op|','
nl|'\n'
string|"'dest_compute'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|','
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|'.'
name|'network_migrate_instance_finish'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'admin_ctxt'
op|','
name|'self'
op|'.'
name|'instance'
op|','
name|'migration'
op|')'
newline|'\n'
name|'fake_net_info'
op|'='
op|'['
op|']'
newline|'\n'
name|'fake_block_dev_info'
op|'='
op|'{'
string|"'foo'"
op|':'
string|"'bar'"
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'post_live_migration_at_destination'
op|'('
name|'self'
op|'.'
name|'admin_ctxt'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|','
nl|'\n'
name|'fake_net_info'
op|','
nl|'\n'
name|'False'
op|','
nl|'\n'
name|'fake_block_dev_info'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_power_state'
op|'('
name|'self'
op|'.'
name|'admin_ctxt'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
nl|'\n'
string|"'fake_power_state'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|_finish_post_live_migration_at_destination
dedent|''
name|'def'
name|'_finish_post_live_migration_at_destination'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|'.'
name|'setup_networks_on_host'
op|'('
name|'self'
op|'.'
name|'admin_ctxt'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|')'
newline|'\n'
nl|'\n'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'post_live_migration_at_destination'
op|'('
name|'self'
op|'.'
name|'admin_ctxt'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.live_migration.post.dest.start'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.live_migration.post.dest.end'"
op|')'
newline|'\n'
nl|'\n'
name|'return'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'admin_ctxt'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_post_live_migration_at_destination_with_compute_info
dedent|''
name|'def'
name|'test_post_live_migration_at_destination_with_compute_info'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""The instance\'s node property should be updated correctly."""'
newline|'\n'
name|'self'
op|'.'
name|'_begin_post_live_migration_at_destination'
op|'('
op|')'
newline|'\n'
name|'hypervisor_hostname'
op|'='
string|"'fake_hypervisor_hostname'"
newline|'\n'
name|'fake_compute_info'
op|'='
op|'{'
string|"'hypervisor_hostname'"
op|':'
name|'hypervisor_hostname'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_compute_info'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
op|'.'
name|'AndReturn'
op|'('
nl|'\n'
name|'fake_compute_info'
op|')'
newline|'\n'
name|'updated'
op|'='
name|'self'
op|'.'
name|'_finish_post_live_migration_at_destination'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'updated'
op|'['
string|"'node'"
op|']'
op|','
name|'hypervisor_hostname'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_post_live_migration_at_destination_without_compute_info
dedent|''
name|'def'
name|'test_post_live_migration_at_destination_without_compute_info'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""The instance\'s node property should be set to None if we fail to\n           get compute_info.\n        """'
newline|'\n'
name|'self'
op|'.'
name|'_begin_post_live_migration_at_destination'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_compute_info'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
op|'.'
name|'AndRaise'
op|'('
nl|'\n'
name|'exception'
op|'.'
name|'NotFound'
op|'('
op|')'
op|')'
newline|'\n'
name|'updated'
op|'='
name|'self'
op|'.'
name|'_finish_post_live_migration_at_destination'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'updated'
op|'['
string|"'node'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rollback_live_migration_at_destination_correctly
dedent|''
name|'def'
name|'test_rollback_live_migration_at_destination_correctly'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# creating instance testdata'
nl|'\n'
indent|'        '
name|'c'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'instance_ref'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'host'"
op|':'
string|"'dummy'"
op|'}'
op|')'
newline|'\n'
name|'inst_uuid'
op|'='
name|'instance_ref'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'inst_id'
op|'='
name|'instance_ref'
op|'['
string|"'id'"
op|']'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'db'
op|'.'
name|'instance_get'
op|'('
name|'c'
op|','
name|'inst_id'
op|')'
op|')'
newline|'\n'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|','
nl|'\n'
string|"'setup_networks_on_host'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|'.'
name|'setup_networks_on_host'
op|'('
name|'c'
op|','
name|'instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|','
nl|'\n'
name|'teardown'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
comment|'# start test'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'ret'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'rollback_live_migration_at_destination'
op|'('
name|'c'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'ret'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.live_migration.rollback.dest.start'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'compute.instance.live_migration.rollback.dest.end'"
op|')'
newline|'\n'
nl|'\n'
comment|'# cleanup'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'inst_uuid'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_run_kill_vm
dedent|''
name|'def'
name|'test_run_kill_vm'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Detect when a vm is terminated behind the scenes.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|'"Running instances: %s"'
op|')'
op|','
name|'instances'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
name|'instance_name'
op|'='
name|'instances'
op|'['
number|'0'
op|']'
op|'['
string|"'name'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'test_remove_vm'
op|'('
name|'instance_name'
op|')'
newline|'\n'
nl|'\n'
comment|'# Force the compute manager to do its periodic poll'
nl|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_sync_power_states'
op|'('
name|'ctxt'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|'"After force-killing instances: %s"'
op|')'
op|','
name|'instances'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'instances'
op|'['
number|'0'
op|']'
op|'['
string|"'task_state'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_instance_fault
dedent|''
name|'def'
name|'test_add_instance_fault'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'exc_info'
op|'='
name|'None'
newline|'\n'
nl|'\n'
DECL|function|fake_db_fault_create
name|'def'
name|'fake_db_fault_create'
op|'('
name|'ctxt'
op|','
name|'values'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'raise NotImplementedError'"
op|','
name|'values'
op|'['
string|"'details'"
op|']'
op|')'
newline|'\n'
name|'del'
name|'values'
op|'['
string|"'details'"
op|']'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'code'"
op|':'
number|'500'
op|','
nl|'\n'
string|"'message'"
op|':'
string|"'test'"
op|','
nl|'\n'
string|"'instance_uuid'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
name|'values'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'NotImplementedError'
op|'('
string|"'test'"
op|')'
newline|'\n'
dedent|''
name|'except'
name|'NotImplementedError'
op|':'
newline|'\n'
indent|'            '
name|'exc_info'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'db'
op|','
string|"'instance_fault_create'"
op|','
name|'fake_db_fault_create'
op|')'
newline|'\n'
nl|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'compute_utils'
op|'.'
name|'add_instance_fault_from_exc'
op|'('
name|'ctxt'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
name|'NotImplementedError'
op|'('
string|"'test'"
op|')'
op|','
nl|'\n'
name|'exc_info'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_instance_fault_with_remote_error
dedent|''
name|'def'
name|'test_add_instance_fault_with_remote_error'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'exc_info'
op|'='
name|'None'
newline|'\n'
nl|'\n'
DECL|function|fake_db_fault_create
name|'def'
name|'fake_db_fault_create'
op|'('
name|'ctxt'
op|','
name|'values'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertTrue'
op|'('
string|"'raise rpc_common.RemoteError'"
nl|'\n'
name|'in'
name|'values'
op|'['
string|"'details'"
op|']'
op|')'
newline|'\n'
name|'del'
name|'values'
op|'['
string|"'details'"
op|']'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'code'"
op|':'
number|'500'
op|','
nl|'\n'
string|"'instance_uuid'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
string|"'message'"
op|':'
string|"'Remote error: test My Test Message\\nNone.'"
op|','
nl|'\n'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
name|'values'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'rpc_common'
op|'.'
name|'RemoteError'
op|'('
string|"'test'"
op|','
string|"'My Test Message'"
op|')'
newline|'\n'
dedent|''
name|'except'
name|'rpc_common'
op|'.'
name|'RemoteError'
name|'as'
name|'exc'
op|':'
newline|'\n'
indent|'            '
name|'exc_info'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'db'
op|','
string|"'instance_fault_create'"
op|','
name|'fake_db_fault_create'
op|')'
newline|'\n'
nl|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'compute_utils'
op|'.'
name|'add_instance_fault_from_exc'
op|'('
name|'ctxt'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
name|'instance'
op|','
name|'exc'
op|','
name|'exc_info'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_instance_fault_user_error
dedent|''
name|'def'
name|'test_add_instance_fault_user_error'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'exc_info'
op|'='
name|'None'
newline|'\n'
nl|'\n'
DECL|function|fake_db_fault_create
name|'def'
name|'fake_db_fault_create'
op|'('
name|'ctxt'
op|','
name|'values'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'            '
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'code'"
op|':'
number|'400'
op|','
nl|'\n'
string|"'message'"
op|':'
string|"'fake details'"
op|','
nl|'\n'
string|"'details'"
op|':'
string|"''"
op|','
nl|'\n'
string|"'instance_uuid'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
name|'values'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'user_exc'
op|'='
name|'exception'
op|'.'
name|'Invalid'
op|'('
string|"'fake details'"
op|','
name|'code'
op|'='
number|'400'
op|')'
newline|'\n'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'user_exc'
newline|'\n'
dedent|''
name|'except'
name|'exception'
op|'.'
name|'Invalid'
op|':'
newline|'\n'
indent|'            '
name|'exc_info'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'db'
op|','
string|"'instance_fault_create'"
op|','
name|'fake_db_fault_create'
op|')'
newline|'\n'
nl|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'compute_utils'
op|'.'
name|'add_instance_fault_from_exc'
op|'('
name|'ctxt'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
name|'instance'
op|','
name|'user_exc'
op|','
name|'exc_info'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_instance_fault_no_exc_info
dedent|''
name|'def'
name|'test_add_instance_fault_no_exc_info'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_db_fault_create
name|'def'
name|'fake_db_fault_create'
op|'('
name|'ctxt'
op|','
name|'values'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'code'"
op|':'
number|'500'
op|','
nl|'\n'
string|"'message'"
op|':'
string|"'test'"
op|','
nl|'\n'
string|"'details'"
op|':'
string|"''"
op|','
nl|'\n'
string|"'instance_uuid'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
name|'values'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'db'
op|','
string|"'instance_fault_create'"
op|','
name|'fake_db_fault_create'
op|')'
newline|'\n'
nl|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'compute_utils'
op|'.'
name|'add_instance_fault_from_exc'
op|'('
name|'ctxt'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
name|'NotImplementedError'
op|'('
string|"'test'"
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_instance_fault_long_message
dedent|''
name|'def'
name|'test_add_instance_fault_long_message'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'message'
op|'='
number|'300'
op|'*'
string|"'a'"
newline|'\n'
nl|'\n'
DECL|function|fake_db_fault_create
name|'def'
name|'fake_db_fault_create'
op|'('
name|'ctxt'
op|','
name|'values'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'expected'
op|'='
op|'{'
nl|'\n'
string|"'code'"
op|':'
number|'500'
op|','
nl|'\n'
string|"'message'"
op|':'
name|'message'
op|'['
op|':'
number|'255'
op|']'
op|','
nl|'\n'
string|"'details'"
op|':'
string|"''"
op|','
nl|'\n'
string|"'instance_uuid'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
name|'values'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'db'
op|','
string|"'instance_fault_create'"
op|','
name|'fake_db_fault_create'
op|')'
newline|'\n'
nl|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'compute_utils'
op|'.'
name|'add_instance_fault_from_exc'
op|'('
name|'ctxt'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
name|'NotImplementedError'
op|'('
name|'message'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_cleanup_running_deleted_instances
dedent|''
name|'def'
name|'test_cleanup_running_deleted_instances'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'admin_context'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'deleted_at'
op|'='
op|'('
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
op|'-'
nl|'\n'
name|'datetime'
op|'.'
name|'timedelta'
op|'('
name|'hours'
op|'='
number|'1'
op|','
name|'minutes'
op|'='
number|'5'
op|')'
op|')'
newline|'\n'
name|'instance1'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|'"deleted_at"'
op|':'
name|'deleted_at'
op|','
nl|'\n'
string|'"deleted"'
op|':'
name|'True'
op|'}'
op|')'
newline|'\n'
name|'instance2'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|'"deleted_at"'
op|':'
name|'deleted_at'
op|','
nl|'\n'
string|'"deleted"'
op|':'
name|'True'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_instances_on_driver'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instances_on_driver'
op|'('
nl|'\n'
name|'admin_context'
op|','
op|'{'
string|"'deleted'"
op|':'
name|'True'
op|','
nl|'\n'
string|"'soft_deleted'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|'}'
op|')'
op|'.'
name|'AndReturn'
op|'('
op|'['
name|'instance1'
op|','
nl|'\n'
name|'instance2'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'running_deleted_instance_timeout'
op|'='
number|'3600'
op|','
nl|'\n'
name|'running_deleted_instance_action'
op|'='
string|"'reap'"
op|')'
newline|'\n'
nl|'\n'
name|'bdms'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|'"_shutdown_instance"'
op|')'
newline|'\n'
comment|'# Simulate an error and make sure cleanup proceeds with next instance.'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_shutdown_instance'
op|'('
name|'admin_context'
op|','
nl|'\n'
name|'instance1'
op|','
nl|'\n'
name|'bdms'
op|','
nl|'\n'
name|'notify'
op|'='
name|'False'
op|')'
op|'.'
name|'AndRaise'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_shutdown_instance'
op|'('
name|'admin_context'
op|','
nl|'\n'
name|'instance2'
op|','
nl|'\n'
name|'bdms'
op|','
nl|'\n'
name|'notify'
op|'='
name|'False'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|'"_cleanup_volumes"'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_cleanup_volumes'
op|'('
name|'admin_context'
op|','
nl|'\n'
name|'instance1'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
name|'bdms'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_cleanup_running_deleted_instances'
op|'('
name|'admin_context'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_running_deleted_instances
dedent|''
name|'def'
name|'test_running_deleted_instances'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'admin_context'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|'='
string|"'host'"
newline|'\n'
nl|'\n'
name|'instance1'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'instance1'
op|'['
string|"'deleted'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'instance1'
op|'['
string|"'deleted_at'"
op|']'
op|'='
string|'"sometimeago"'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_instances_on_driver'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instances_on_driver'
op|'('
nl|'\n'
name|'admin_context'
op|','
op|'{'
string|"'deleted'"
op|':'
name|'True'
op|','
nl|'\n'
string|"'soft_deleted'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|'}'
op|')'
op|'.'
name|'AndReturn'
op|'('
op|'['
name|'instance1'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'timeutils'
op|','
string|"'is_older_than'"
op|')'
newline|'\n'
name|'timeutils'
op|'.'
name|'is_older_than'
op|'('
string|"'sometimeago'"
op|','
nl|'\n'
name|'CONF'
op|'.'
name|'running_deleted_instance_timeout'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'val'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_running_deleted_instances'
op|'('
name|'admin_context'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'val'
op|','
op|'['
name|'instance1'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_instance_nw_info
dedent|''
name|'def'
name|'test_get_instance_nw_info'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'fake_network'
op|'.'
name|'unset_stub_network_methods'
op|'('
name|'self'
op|'.'
name|'stubs'
op|')'
newline|'\n'
nl|'\n'
name|'fake_inst'
op|'='
name|'fake_instance'
op|'.'
name|'fake_db_instance'
op|'('
name|'uuid'
op|'='
string|"'fake-instance'"
op|')'
newline|'\n'
name|'fake_nw_info'
op|'='
name|'network_model'
op|'.'
name|'NetworkInfo'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|','
nl|'\n'
string|"'get_instance_nw_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'db'
op|','
string|"'instance_get_by_uuid'"
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'fake_inst'
op|'['
string|"'uuid'"
op|']'
nl|'\n'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'fake_inst'
op|')'
newline|'\n'
comment|"# NOTE(danms): compute manager will re-query since we're not giving"
nl|'\n'
comment|"# it an instance with system_metadata. We're stubbing out the"
nl|'\n'
comment|"# subsequent call so we don't need it, but keep this to make sure it"
nl|'\n'
comment|'# does the right thing.'
nl|'\n'
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'fake_inst'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
name|'columns_to_join'
op|'='
op|'['
string|"'info_cache'"
op|','
nl|'\n'
string|"'security_groups'"
op|']'
op|','
nl|'\n'
name|'use_slave'
op|'='
name|'False'
nl|'\n'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'fake_inst'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|'.'
name|'get_instance_nw_info'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IsA'
op|'('
name|'instance_obj'
op|'.'
name|'Instance'
op|')'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'fake_nw_info'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'fake_inst_obj'
op|'='
name|'instance_obj'
op|'.'
name|'Instance'
op|'.'
name|'_from_db_object'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance_obj'
op|'.'
name|'Instance'
op|'('
op|')'
op|','
name|'fake_inst'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'result'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instance_nw_info'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'fake_inst_obj'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fake_nw_info'
op|','
name|'result'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_heal_instance_info_cache
dedent|''
name|'def'
name|'test_heal_instance_info_cache'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Update on every call for the test'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'heal_instance_info_cache_interval'
op|'='
op|'-'
number|'1'
op|')'
newline|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instance_map'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'instances'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'x'
name|'in'
name|'xrange'
op|'('
number|'5'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'inst_uuid'
op|'='
string|"'fake-uuid-%s'"
op|'%'
name|'x'
newline|'\n'
name|'instance_map'
op|'['
name|'inst_uuid'
op|']'
op|'='
name|'fake_instance'
op|'.'
name|'fake_db_instance'
op|'('
nl|'\n'
name|'uuid'
op|'='
name|'inst_uuid'
op|','
name|'host'
op|'='
name|'CONF'
op|'.'
name|'host'
op|','
name|'created_at'
op|'='
name|'None'
op|')'
newline|'\n'
comment|"# These won't be in our instance since they're not requested"
nl|'\n'
name|'instances'
op|'.'
name|'append'
op|'('
name|'instance_map'
op|'['
name|'inst_uuid'
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'call_info'
op|'='
op|'{'
string|"'get_all_by_host'"
op|':'
number|'0'
op|','
string|"'get_by_uuid'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'get_nw_info'"
op|':'
number|'0'
op|','
string|"'expected_instance'"
op|':'
name|'None'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_instance_get_all_by_host
name|'def'
name|'fake_instance_get_all_by_host'
op|'('
name|'context'
op|','
name|'host'
op|','
nl|'\n'
name|'columns_to_join'
op|','
name|'use_slave'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'call_info'
op|'['
string|"'get_all_by_host'"
op|']'
op|'+='
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
op|']'
op|','
name|'columns_to_join'
op|')'
newline|'\n'
name|'return'
name|'instances'
op|'['
op|':'
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_instance_get_by_uuid
dedent|''
name|'def'
name|'fake_instance_get_by_uuid'
op|'('
name|'context'
op|','
name|'instance_uuid'
op|','
nl|'\n'
name|'columns_to_join'
op|','
name|'use_slave'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'instance_uuid'
name|'not'
name|'in'
name|'instance_map'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance_uuid'
op|')'
newline|'\n'
dedent|''
name|'call_info'
op|'['
string|"'get_by_uuid'"
op|']'
op|'+='
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
string|"'system_metadata'"
op|']'
op|','
name|'columns_to_join'
op|')'
newline|'\n'
name|'return'
name|'instance_map'
op|'['
name|'instance_uuid'
op|']'
newline|'\n'
nl|'\n'
comment|'# NOTE(comstud): Override the stub in setUp()'
nl|'\n'
DECL|function|fake_get_instance_nw_info
dedent|''
name|'def'
name|'fake_get_instance_nw_info'
op|'('
name|'context'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
comment|'# Note that this exception gets caught in compute/manager'
nl|'\n'
comment|'# and is ignored.  However, the below increment of'
nl|'\n'
comment|"# 'get_nw_info' won't happen, and you'll get an assert"
nl|'\n'
comment|'# failure checking it below.'
nl|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'call_info'
op|'['
string|"'expected_instance'"
op|']'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'call_info'
op|'['
string|"'get_nw_info'"
op|']'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'instance_get_all_by_host'"
op|','
nl|'\n'
name|'fake_instance_get_all_by_host'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'instance_get_by_uuid'"
op|','
nl|'\n'
name|'fake_instance_get_by_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_instance_nw_info'"
op|','
nl|'\n'
name|'fake_get_instance_nw_info'
op|')'
newline|'\n'
nl|'\n'
name|'call_info'
op|'['
string|"'expected_instance'"
op|']'
op|'='
name|'instances'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_heal_instance_info_cache'
op|'('
name|'ctxt'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'call_info'
op|'['
string|"'get_all_by_host'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'call_info'
op|'['
string|"'get_by_uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'call_info'
op|'['
string|"'get_nw_info'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'call_info'
op|'['
string|"'expected_instance'"
op|']'
op|'='
name|'instances'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_heal_instance_info_cache'
op|'('
name|'ctxt'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'call_info'
op|'['
string|"'get_all_by_host'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'call_info'
op|'['
string|"'get_by_uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'2'
op|','
name|'call_info'
op|'['
string|"'get_nw_info'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# Make an instance switch hosts'
nl|'\n'
name|'instances'
op|'['
number|'2'
op|']'
op|'['
string|"'host'"
op|']'
op|'='
string|"'not-me'"
newline|'\n'
comment|'# Make an instance disappear'
nl|'\n'
name|'instance_map'
op|'.'
name|'pop'
op|'('
name|'instances'
op|'['
number|'3'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
comment|"# '2' and '3' should be skipped.."
nl|'\n'
name|'call_info'
op|'['
string|"'expected_instance'"
op|']'
op|'='
name|'instances'
op|'['
number|'4'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_heal_instance_info_cache'
op|'('
name|'ctxt'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'call_info'
op|'['
string|"'get_all_by_host'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
comment|"# Incremented for '2' and '4'.. '3' caused a raise above."
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'call_info'
op|'['
string|"'get_by_uuid'"
op|']'
op|','
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'call_info'
op|'['
string|"'get_nw_info'"
op|']'
op|','
number|'3'
op|')'
newline|'\n'
comment|'# Should be no more left.'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_instance_uuids_to_heal'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# This should cause a DB query now so we get first instance'
nl|'\n'
comment|'# back again'
nl|'\n'
name|'call_info'
op|'['
string|"'expected_instance'"
op|']'
op|'='
name|'instances'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_heal_instance_info_cache'
op|'('
name|'ctxt'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'call_info'
op|'['
string|"'get_all_by_host'"
op|']'
op|','
number|'2'
op|')'
newline|'\n'
comment|'# Stays the same, because the instance came from the DB'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'call_info'
op|'['
string|"'get_by_uuid'"
op|']'
op|','
number|'3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'call_info'
op|'['
string|"'get_nw_info'"
op|']'
op|','
number|'4'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_poll_rescued_instances
dedent|''
name|'def'
name|'test_poll_rescued_instances'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'timed_out_time'
op|'='
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
op|'-'
name|'datetime'
op|'.'
name|'timedelta'
op|'('
name|'minutes'
op|'='
number|'5'
op|')'
newline|'\n'
name|'not_timed_out_time'
op|'='
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
op|'['
op|'{'
string|"'uuid'"
op|':'
string|"'fake_uuid1'"
op|','
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'RESCUED'
op|','
nl|'\n'
string|"'launched_at'"
op|':'
name|'timed_out_time'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'uuid'"
op|':'
string|"'fake_uuid2'"
op|','
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'RESCUED'
op|','
nl|'\n'
string|"'launched_at'"
op|':'
name|'timed_out_time'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'uuid'"
op|':'
string|"'fake_uuid3'"
op|','
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'RESCUED'
op|','
nl|'\n'
string|"'launched_at'"
op|':'
name|'not_timed_out_time'
op|'}'
op|']'
newline|'\n'
name|'unrescued_instances'
op|'='
op|'{'
string|"'fake_uuid1'"
op|':'
name|'False'
op|','
string|"'fake_uuid2'"
op|':'
name|'False'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_instance_get_all_by_filters
name|'def'
name|'fake_instance_get_all_by_filters'
op|'('
name|'context'
op|','
name|'filters'
op|','
nl|'\n'
name|'columns_to_join'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'columns_to_join'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'return'
name|'instances'
newline|'\n'
nl|'\n'
DECL|function|fake_unrescue
dedent|''
name|'def'
name|'fake_unrescue'
op|'('
name|'context'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'unrescued_instances'
op|'['
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
nl|'\n'
string|"'instance_get_all_by_filters'"
op|','
nl|'\n'
name|'fake_instance_get_all_by_filters'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
string|"'compute_unrescue'"
op|','
nl|'\n'
name|'fake_unrescue'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'rescue_timeout'
op|'='
number|'60'
op|')'
newline|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_poll_rescued_instances'
op|'('
name|'ctxt'
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'instance'
name|'in'
name|'unrescued_instances'
op|'.'
name|'values'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_poll_unconfirmed_resizes
dedent|''
dedent|''
name|'def'
name|'test_poll_unconfirmed_resizes'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instances'
op|'='
op|'['
nl|'\n'
name|'fake_instance'
op|'.'
name|'fake_db_instance'
op|'('
name|'uuid'
op|'='
string|"'fake_uuid1'"
op|','
nl|'\n'
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'RESIZED'
op|','
nl|'\n'
name|'task_state'
op|'='
name|'None'
op|')'
op|','
nl|'\n'
name|'fake_instance'
op|'.'
name|'fake_db_instance'
op|'('
name|'uuid'
op|'='
string|"'noexist'"
op|')'
op|','
nl|'\n'
name|'fake_instance'
op|'.'
name|'fake_db_instance'
op|'('
name|'uuid'
op|'='
string|"'fake_uuid2'"
op|','
nl|'\n'
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'ERROR'
op|','
nl|'\n'
name|'task_state'
op|'='
name|'None'
op|')'
op|','
nl|'\n'
name|'fake_instance'
op|'.'
name|'fake_db_instance'
op|'('
name|'uuid'
op|'='
string|"'fake_uuid3'"
op|','
nl|'\n'
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'ACTIVE'
op|','
nl|'\n'
name|'task_state'
op|'='
nl|'\n'
name|'task_states'
op|'.'
name|'REBOOTING'
op|')'
op|','
nl|'\n'
name|'fake_instance'
op|'.'
name|'fake_db_instance'
op|'('
name|'uuid'
op|'='
string|"'fake_uuid4'"
op|','
nl|'\n'
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'RESIZED'
op|','
nl|'\n'
name|'task_state'
op|'='
name|'None'
op|')'
op|','
nl|'\n'
name|'fake_instance'
op|'.'
name|'fake_db_instance'
op|'('
name|'uuid'
op|'='
string|"'fake_uuid5'"
op|','
nl|'\n'
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'ACTIVE'
op|','
nl|'\n'
name|'task_state'
op|'='
name|'None'
op|')'
op|','
nl|'\n'
name|'fake_instance'
op|'.'
name|'fake_db_instance'
op|'('
name|'uuid'
op|'='
string|"'fake_uuid6'"
op|','
nl|'\n'
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'RESIZED'
op|','
nl|'\n'
name|'task_state'
op|'='
string|"'deleting'"
op|')'
op|']'
newline|'\n'
name|'expected_migration_status'
op|'='
op|'{'
string|"'fake_uuid1'"
op|':'
string|"'confirmed'"
op|','
nl|'\n'
string|"'noexist'"
op|':'
string|"'error'"
op|','
nl|'\n'
string|"'fake_uuid2'"
op|':'
string|"'error'"
op|','
nl|'\n'
string|"'fake_uuid3'"
op|':'
string|"'error'"
op|','
nl|'\n'
string|"'fake_uuid4'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'fake_uuid5'"
op|':'
string|"'error'"
op|','
nl|'\n'
string|"'fake_uuid6'"
op|':'
string|"'error'"
op|'}'
newline|'\n'
name|'migrations'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'i'
op|','
name|'instance'
name|'in'
name|'enumerate'
op|'('
name|'instances'
op|','
name|'start'
op|'='
number|'1'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'fake_mig'
op|'='
name|'test_migration'
op|'.'
name|'fake_db_migration'
op|'('
op|')'
newline|'\n'
name|'fake_mig'
op|'.'
name|'update'
op|'('
op|'{'
string|"'id'"
op|':'
name|'i'
op|','
nl|'\n'
string|"'instance_uuid'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
string|"'status'"
op|':'
name|'None'
op|'}'
op|')'
newline|'\n'
name|'migrations'
op|'.'
name|'append'
op|'('
name|'fake_mig'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_instance_get_by_uuid
dedent|''
name|'def'
name|'fake_instance_get_by_uuid'
op|'('
name|'context'
op|','
name|'instance_uuid'
op|','
nl|'\n'
name|'columns_to_join'
op|'='
name|'None'
op|','
name|'use_slave'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'metadata'"
op|','
name|'columns_to_join'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'system_metadata'"
op|','
name|'columns_to_join'
op|')'
newline|'\n'
comment|"# raise InstanceNotFound exception for uuid 'noexist'"
nl|'\n'
name|'if'
name|'instance_uuid'
op|'=='
string|"'noexist'"
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance_uuid'
op|')'
newline|'\n'
dedent|''
name|'for'
name|'instance'
name|'in'
name|'instances'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|'=='
name|'instance_uuid'
op|':'
newline|'\n'
indent|'                    '
name|'return'
name|'instance'
newline|'\n'
nl|'\n'
DECL|function|fake_migration_get_unconfirmed_by_dest_compute
dedent|''
dedent|''
dedent|''
name|'def'
name|'fake_migration_get_unconfirmed_by_dest_compute'
op|'('
name|'context'
op|','
nl|'\n'
name|'resize_confirm_window'
op|','
name|'dest_compute'
op|','
name|'use_slave'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'dest_compute'
op|','
name|'CONF'
op|'.'
name|'host'
op|')'
newline|'\n'
name|'return'
name|'migrations'
newline|'\n'
nl|'\n'
DECL|function|fake_migration_update
dedent|''
name|'def'
name|'fake_migration_update'
op|'('
name|'context'
op|','
name|'mid'
op|','
name|'updates'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'migration'
name|'in'
name|'migrations'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'migration'
op|'['
string|"'id'"
op|']'
op|'=='
name|'mid'
op|':'
newline|'\n'
indent|'                    '
name|'migration'
op|'.'
name|'update'
op|'('
name|'updates'
op|')'
newline|'\n'
name|'return'
name|'migration'
newline|'\n'
nl|'\n'
DECL|function|fake_confirm_resize
dedent|''
dedent|''
dedent|''
name|'def'
name|'fake_confirm_resize'
op|'('
name|'context'
op|','
name|'instance'
op|','
name|'migration'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
comment|"# raise exception for 'fake_uuid4' to check migration status"
nl|'\n'
comment|"# does not get set to 'error' on confirm_resize failure."
nl|'\n'
indent|'            '
name|'if'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|'=='
string|"'fake_uuid4'"
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
string|"'bomb'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertIsNotNone'
op|'('
name|'migration'
op|')'
newline|'\n'
name|'for'
name|'migration2'
name|'in'
name|'migrations'
op|':'
newline|'\n'
indent|'                '
name|'if'
op|'('
name|'migration2'
op|'['
string|"'instance_uuid'"
op|']'
op|'=='
nl|'\n'
name|'migration'
op|'['
string|"'instance_uuid'"
op|']'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'migration2'
op|'['
string|"'status'"
op|']'
op|'='
string|"'confirmed'"
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'instance_get_by_uuid'"
op|','
nl|'\n'
name|'fake_instance_get_by_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'migration_get_unconfirmed_by_dest_compute'"
op|','
nl|'\n'
name|'fake_migration_get_unconfirmed_by_dest_compute'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'migration_update'"
op|','
name|'fake_migration_update'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_api'
op|','
string|"'confirm_resize'"
op|','
nl|'\n'
name|'fake_confirm_resize'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fetch_instance_migration_status
name|'def'
name|'fetch_instance_migration_status'
op|'('
name|'instance_uuid'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'migration'
name|'in'
name|'migrations'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'migration'
op|'['
string|"'instance_uuid'"
op|']'
op|'=='
name|'instance_uuid'
op|':'
newline|'\n'
indent|'                    '
name|'return'
name|'migration'
op|'['
string|"'status'"
op|']'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
name|'self'
op|'.'
name|'flags'
op|'('
name|'resize_confirm_window'
op|'='
number|'60'
op|')'
newline|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_poll_unconfirmed_resizes'
op|'('
name|'ctxt'
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'uuid'
op|','
name|'status'
name|'in'
name|'expected_migration_status'
op|'.'
name|'iteritems'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'status'
op|','
name|'fetch_instance_migration_status'
op|'('
name|'uuid'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_instance_build_timeout_disabled
dedent|''
dedent|''
name|'def'
name|'test_instance_build_timeout_disabled'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'instance_build_timeout'
op|'='
number|'0'
op|')'
newline|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'called'
op|'='
op|'{'
string|"'get_all'"
op|':'
name|'False'
op|','
string|"'set_error_state'"
op|':'
number|'0'
op|'}'
newline|'\n'
name|'created_at'
op|'='
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
op|'+'
name|'datetime'
op|'.'
name|'timedelta'
op|'('
name|'seconds'
op|'='
op|'-'
number|'60'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_instance_get_all_by_filters
name|'def'
name|'fake_instance_get_all_by_filters'
op|'('
name|'context'
op|','
name|'filters'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kw'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'get_all'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'host'"
op|','
name|'filters'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'kw'
op|'['
string|"'columns_to_join'"
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'return'
name|'instances'
op|'['
op|':'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'instance_get_all_by_filters'"
op|','
nl|'\n'
name|'fake_instance_get_all_by_filters'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_set_instance_error_state
name|'def'
name|'fake_set_instance_error_state'
op|'('
name|'_ctxt'
op|','
name|'instance_uuid'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'set_error_state'"
op|']'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_set_instance_error_state'"
op|','
nl|'\n'
name|'fake_set_instance_error_state'
op|')'
newline|'\n'
nl|'\n'
name|'instance_map'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'instances'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'x'
name|'in'
name|'xrange'
op|'('
number|'5'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'uuid'
op|'='
string|"'fake-uuid-%s'"
op|'%'
name|'x'
newline|'\n'
name|'instance_map'
op|'['
name|'uuid'
op|']'
op|'='
op|'{'
string|"'uuid'"
op|':'
name|'uuid'
op|','
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|','
nl|'\n'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'BUILDING'
op|','
nl|'\n'
string|"'created_at'"
op|':'
name|'created_at'
op|'}'
newline|'\n'
name|'instances'
op|'.'
name|'append'
op|'('
name|'instance_map'
op|'['
name|'uuid'
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_check_instance_build_time'
op|'('
name|'ctxt'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'called'
op|'['
string|"'get_all'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'called'
op|'['
string|"'set_error_state'"
op|']'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_instance_build_timeout
dedent|''
name|'def'
name|'test_instance_build_timeout'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'instance_build_timeout'
op|'='
number|'30'
op|')'
newline|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'called'
op|'='
op|'{'
string|"'get_all'"
op|':'
name|'False'
op|','
string|"'set_error_state'"
op|':'
number|'0'
op|'}'
newline|'\n'
name|'created_at'
op|'='
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
op|'+'
name|'datetime'
op|'.'
name|'timedelta'
op|'('
name|'seconds'
op|'='
op|'-'
number|'60'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_instance_get_all_by_filters
name|'def'
name|'fake_instance_get_all_by_filters'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'get_all'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'return'
name|'instances'
op|'['
op|':'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'instance_get_all_by_filters'"
op|','
nl|'\n'
name|'fake_instance_get_all_by_filters'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_set_instance_error_state
name|'def'
name|'fake_set_instance_error_state'
op|'('
name|'_ctxt'
op|','
name|'instance_uuid'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'set_error_state'"
op|']'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_set_instance_error_state'"
op|','
nl|'\n'
name|'fake_set_instance_error_state'
op|')'
newline|'\n'
nl|'\n'
name|'instance_map'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'instances'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'x'
name|'in'
name|'xrange'
op|'('
number|'5'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'uuid'
op|'='
string|"'fake-uuid-%s'"
op|'%'
name|'x'
newline|'\n'
name|'instance_map'
op|'['
name|'uuid'
op|']'
op|'='
op|'{'
string|"'uuid'"
op|':'
name|'uuid'
op|','
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|','
nl|'\n'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'BUILDING'
op|','
nl|'\n'
string|"'created_at'"
op|':'
name|'created_at'
op|'}'
newline|'\n'
name|'instances'
op|'.'
name|'append'
op|'('
name|'instance_map'
op|'['
name|'uuid'
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_check_instance_build_time'
op|'('
name|'ctxt'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'['
string|"'get_all'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'called'
op|'['
string|"'set_error_state'"
op|']'
op|','
number|'5'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_instance_build_timeout_mixed_instances
dedent|''
name|'def'
name|'test_instance_build_timeout_mixed_instances'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'instance_build_timeout'
op|'='
number|'30'
op|')'
newline|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'called'
op|'='
op|'{'
string|"'get_all'"
op|':'
name|'False'
op|','
string|"'set_error_state'"
op|':'
number|'0'
op|'}'
newline|'\n'
name|'created_at'
op|'='
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
op|'+'
name|'datetime'
op|'.'
name|'timedelta'
op|'('
name|'seconds'
op|'='
op|'-'
number|'60'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_instance_get_all_by_filters
name|'def'
name|'fake_instance_get_all_by_filters'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'get_all'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'return'
name|'instances'
op|'['
op|':'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'instance_get_all_by_filters'"
op|','
nl|'\n'
name|'fake_instance_get_all_by_filters'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_set_instance_error_state
name|'def'
name|'fake_set_instance_error_state'
op|'('
name|'_ctxt'
op|','
name|'instance_uuid'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'set_error_state'"
op|']'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_set_instance_error_state'"
op|','
nl|'\n'
name|'fake_set_instance_error_state'
op|')'
newline|'\n'
nl|'\n'
name|'instance_map'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'instances'
op|'='
op|'['
op|']'
newline|'\n'
comment|'#expired instances'
nl|'\n'
name|'for'
name|'x'
name|'in'
name|'xrange'
op|'('
number|'4'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'uuid'
op|'='
string|"'fake-uuid-%s'"
op|'%'
name|'x'
newline|'\n'
name|'instance_map'
op|'['
name|'uuid'
op|']'
op|'='
op|'{'
string|"'uuid'"
op|':'
name|'uuid'
op|','
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|','
nl|'\n'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'BUILDING'
op|','
nl|'\n'
string|"'created_at'"
op|':'
name|'created_at'
op|'}'
newline|'\n'
name|'instances'
op|'.'
name|'append'
op|'('
name|'instance_map'
op|'['
name|'uuid'
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'#not expired'
nl|'\n'
dedent|''
name|'uuid'
op|'='
string|"'fake-uuid-5'"
newline|'\n'
name|'instance_map'
op|'['
name|'uuid'
op|']'
op|'='
op|'{'
nl|'\n'
string|"'uuid'"
op|':'
name|'uuid'
op|','
nl|'\n'
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|','
nl|'\n'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'BUILDING'
op|','
nl|'\n'
string|"'created_at'"
op|':'
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'instances'
op|'.'
name|'append'
op|'('
name|'instance_map'
op|'['
name|'uuid'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_check_instance_build_time'
op|'('
name|'ctxt'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'['
string|"'get_all'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'called'
op|'['
string|"'set_error_state'"
op|']'
op|','
number|'4'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_resource_tracker_fail
dedent|''
name|'def'
name|'test_get_resource_tracker_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'NovaException'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_resource_tracker'
op|','
nl|'\n'
string|"'invalidnodename'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_instance_update_host_check
dedent|''
name|'def'
name|'test_instance_update_host_check'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|"# make sure rt usage doesn't happen if the host or node is different"
nl|'\n'
DECL|function|fail_get
indent|'        '
name|'def'
name|'fail_get'
op|'('
name|'nodename'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
name|'_'
op|'('
string|'"wrong host/node"'
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_resource_tracker'"
op|','
name|'fail_get'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'host'"
op|':'
string|"'someotherhost'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'node'"
op|':'
string|"'someothernode'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'params'
op|'='
op|'{'
string|"'host'"
op|':'
string|"'someotherhost'"
op|','
string|"'node'"
op|':'
string|"'someothernode'"
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_destroy_evacuated_instance_on_shared_storage
dedent|''
name|'def'
name|'test_destroy_evacuated_instance_on_shared_storage'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'fake_context'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# instances in central db'
nl|'\n'
name|'instances'
op|'='
op|'['
nl|'\n'
comment|'# those are still related to this host'
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
nl|'\n'
op|'{'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|'}'
op|')'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
nl|'\n'
op|'{'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|'}'
op|')'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
nl|'\n'
op|'{'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|'}'
op|')'
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
comment|'# those are already been evacuated to other host'
nl|'\n'
name|'evacuated_instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
nl|'\n'
op|'{'
string|"'host'"
op|':'
string|"'otherhost'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'.'
name|'append'
op|'('
name|'evacuated_instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_get_instances_on_driver'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_get_instance_nw_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_get_instance_volume_block_device_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_is_instance_storage_shared'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'destroy'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instances_on_driver'
op|'('
nl|'\n'
name|'fake_context'
op|','
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|'}'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'instances'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instance_nw_info'
op|'('
name|'fake_context'
op|','
nl|'\n'
name|'evacuated_instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
nl|'\n'
string|"'fake_network_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instance_volume_block_device_info'
op|'('
nl|'\n'
name|'fake_context'
op|','
name|'evacuated_instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
string|"'fake_bdi'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_is_instance_storage_shared'
op|'('
name|'fake_context'
op|','
nl|'\n'
name|'evacuated_instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'destroy'
op|'('
name|'fake_context'
op|','
name|'evacuated_instance'
op|','
nl|'\n'
string|"'fake_network_info'"
op|','
nl|'\n'
string|"'fake_bdi'"
op|','
nl|'\n'
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_destroy_evacuated_instances'
op|'('
name|'fake_context'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_destroy_evacuated_instance_with_disks
dedent|''
name|'def'
name|'test_destroy_evacuated_instance_with_disks'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'fake_context'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# instances in central db'
nl|'\n'
name|'instances'
op|'='
op|'['
nl|'\n'
comment|'# those are still related to this host'
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
nl|'\n'
op|'{'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|'}'
op|')'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
op|'{'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|'}'
op|')'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
op|'{'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|'}'
op|')'
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
comment|'# those are already been evacuated to other host'
nl|'\n'
name|'evacuated_instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
nl|'\n'
op|'{'
string|"'host'"
op|':'
string|"'otherhost'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'.'
name|'append'
op|'('
name|'evacuated_instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_get_instances_on_driver'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_get_instance_nw_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_get_instance_volume_block_device_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
nl|'\n'
string|"'check_instance_shared_storage_local'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_rpcapi'
op|','
nl|'\n'
string|"'check_instance_shared_storage'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
nl|'\n'
string|"'check_instance_shared_storage_cleanup'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'destroy'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instances_on_driver'
op|'('
nl|'\n'
name|'fake_context'
op|','
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|'}'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'instances'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instance_nw_info'
op|'('
name|'fake_context'
op|','
nl|'\n'
name|'evacuated_instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
nl|'\n'
string|"'fake_network_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instance_volume_block_device_info'
op|'('
nl|'\n'
name|'fake_context'
op|','
name|'evacuated_instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
string|"'fake_bdi'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'check_instance_shared_storage_local'
op|'('
name|'fake_context'
op|','
nl|'\n'
name|'evacuated_instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
op|'{'
string|"'filename'"
op|':'
string|"'tmpfilename'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_rpcapi'
op|'.'
name|'check_instance_shared_storage'
op|'('
name|'fake_context'
op|','
nl|'\n'
name|'obj_base'
op|'.'
name|'obj_to_primitive'
op|'('
name|'evacuated_instance'
op|')'
op|','
nl|'\n'
op|'{'
string|"'filename'"
op|':'
string|"'tmpfilename'"
op|'}'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'check_instance_shared_storage_cleanup'
op|'('
name|'fake_context'
op|','
nl|'\n'
op|'{'
string|"'filename'"
op|':'
string|"'tmpfilename'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'destroy'
op|'('
name|'fake_context'
op|','
name|'evacuated_instance'
op|','
nl|'\n'
string|"'fake_network_info'"
op|','
nl|'\n'
string|"'fake_bdi'"
op|','
nl|'\n'
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_destroy_evacuated_instances'
op|'('
name|'fake_context'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_destroy_evacuated_instance_not_implemented
dedent|''
name|'def'
name|'test_destroy_evacuated_instance_not_implemented'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'fake_context'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# instances in central db'
nl|'\n'
name|'instances'
op|'='
op|'['
nl|'\n'
comment|'# those are still related to this host'
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
nl|'\n'
op|'{'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|'}'
op|')'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
nl|'\n'
op|'{'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|'}'
op|')'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
nl|'\n'
op|'{'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|'}'
op|')'
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
comment|'# those are already been evacuated to other host'
nl|'\n'
name|'evacuated_instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
nl|'\n'
op|'{'
string|"'host'"
op|':'
string|"'otherhost'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'.'
name|'append'
op|'('
name|'evacuated_instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_get_instances_on_driver'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_get_instance_nw_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_get_instance_volume_block_device_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
nl|'\n'
string|"'check_instance_shared_storage_local'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'compute_rpcapi'
op|','
nl|'\n'
string|"'check_instance_shared_storage'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
nl|'\n'
string|"'check_instance_shared_storage_cleanup'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'destroy'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instances_on_driver'
op|'('
nl|'\n'
name|'fake_context'
op|','
op|'{'
string|"'deleted'"
op|':'
name|'False'
op|'}'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'instances'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instance_nw_info'
op|'('
name|'fake_context'
op|','
nl|'\n'
name|'evacuated_instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
nl|'\n'
string|"'fake_network_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_get_instance_volume_block_device_info'
op|'('
nl|'\n'
name|'fake_context'
op|','
name|'evacuated_instance'
op|')'
op|'.'
name|'AndReturn'
op|'('
string|"'fake_bdi'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'check_instance_shared_storage_local'
op|'('
name|'fake_context'
op|','
nl|'\n'
name|'evacuated_instance'
op|')'
op|'.'
name|'AndRaise'
op|'('
name|'NotImplementedError'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'destroy'
op|'('
name|'fake_context'
op|','
name|'evacuated_instance'
op|','
nl|'\n'
string|"'fake_network_info'"
op|','
nl|'\n'
string|"'fake_bdi'"
op|','
nl|'\n'
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_destroy_evacuated_instances'
op|'('
name|'fake_context'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_complete_partial_deletion
dedent|''
name|'def'
name|'test_complete_partial_deletion'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'admin_context'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'='
name|'instance_obj'
op|'.'
name|'Instance'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'id'
op|'='
number|'1'
newline|'\n'
name|'instance'
op|'.'
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'DELETED'
newline|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'None'
newline|'\n'
name|'instance'
op|'.'
name|'system_metadata'
op|'='
op|'{'
string|"'fake_key'"
op|':'
string|"'fake_value'"
op|'}'
newline|'\n'
name|'instance'
op|'.'
name|'vcpus'
op|'='
number|'1'
newline|'\n'
name|'instance'
op|'.'
name|'memory_mb'
op|'='
number|'1'
newline|'\n'
name|'instance'
op|'.'
name|'project_id'
op|'='
string|"'fake-prj'"
newline|'\n'
name|'instance'
op|'.'
name|'user_id'
op|'='
string|"'fake-user'"
newline|'\n'
name|'instance'
op|'.'
name|'deleted'
op|'='
name|'False'
newline|'\n'
nl|'\n'
DECL|function|fake_destroy
name|'def'
name|'fake_destroy'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'instance'
op|'.'
name|'deleted'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'instance'
op|','
string|"'destroy'"
op|','
name|'fake_destroy'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_get_instance_volume_bdms'"
op|','
nl|'\n'
name|'lambda'
op|'*'
name|'a'
op|','
op|'**'
name|'k'
op|':'
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_complete_deletion'"
op|','
nl|'\n'
name|'lambda'
op|'*'
name|'a'
op|','
op|'**'
name|'k'
op|':'
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'quotas_obj'
op|'.'
name|'Quotas'
op|','
string|"'reserve'"
op|','
name|'lambda'
op|'*'
name|'a'
op|','
op|'**'
name|'k'
op|':'
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_complete_partial_deletion'
op|'('
name|'admin_context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'instance'
op|'.'
name|'deleted'
op|'=='
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_init_instance_for_partial_deletion
dedent|''
name|'def'
name|'test_init_instance_for_partial_deletion'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'admin_context'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'='
name|'instance_obj'
op|'.'
name|'Instance'
op|'('
name|'admin_context'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'id'
op|'='
number|'1'
newline|'\n'
name|'instance'
op|'.'
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'DELETED'
newline|'\n'
name|'instance'
op|'.'
name|'deleted'
op|'='
name|'False'
newline|'\n'
nl|'\n'
DECL|function|fake_partial_deletion
name|'def'
name|'fake_partial_deletion'
op|'('
name|'context'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'instance'
op|'['
string|"'deleted'"
op|']'
op|'='
name|'instance'
op|'['
string|"'id'"
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_complete_partial_deletion'"
op|','
nl|'\n'
name|'fake_partial_deletion'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_init_instance'
op|'('
name|'admin_context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'instance'
op|'['
string|"'deleted'"
op|']'
op|'=='
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_partial_deletion_raise_exception
dedent|''
name|'def'
name|'test_partial_deletion_raise_exception'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'admin_context'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'='
name|'instance_obj'
op|'.'
name|'Instance'
op|'('
name|'admin_context'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'id'
op|'='
number|'1'
newline|'\n'
name|'instance'
op|'.'
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'DELETED'
newline|'\n'
name|'instance'
op|'.'
name|'deleted'
op|'='
name|'False'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_complete_partial_deletion'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_complete_partial_deletion'
op|'('
nl|'\n'
name|'admin_context'
op|','
name|'instance'
op|')'
op|'.'
name|'AndRaise'
op|'('
name|'ValueError'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_init_instance'
op|'('
name|'admin_context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_remove_fixed_ip_updates_instance_updated_at
dedent|''
name|'def'
name|'test_add_remove_fixed_ip_updates_instance_updated_at'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|_noop
indent|'        '
name|'def'
name|'_noop'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|','
nl|'\n'
string|"'add_fixed_ip_to_instance'"
op|','
name|'_noop'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|','
nl|'\n'
string|"'remove_fixed_ip_from_instance'"
op|','
name|'_noop'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'updated_at_1'
op|'='
name|'instance'
op|'['
string|"'updated_at'"
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'add_fixed_ip_to_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'fake'"
op|','
name|'instance'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'updated_at_2'
op|'='
name|'instance'
op|'['
string|"'updated_at'"
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'remove_fixed_ip_from_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'fake'"
op|','
nl|'\n'
name|'instance'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'updated_at_3'
op|'='
name|'instance'
op|'['
string|"'updated_at'"
op|']'
newline|'\n'
nl|'\n'
name|'updated_ats'
op|'='
op|'('
name|'updated_at_1'
op|','
name|'updated_at_2'
op|','
name|'updated_at_3'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'updated_ats'
op|')'
op|','
name|'len'
op|'('
name|'set'
op|'('
name|'updated_ats'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_no_pending_deletes_for_soft_deleted_instances
dedent|''
name|'def'
name|'test_no_pending_deletes_for_soft_deleted_instances'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'reclaim_instance_interval'
op|'='
number|'0'
op|')'
newline|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
name|'params'
op|'='
op|'{'
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|','
nl|'\n'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'SOFT_DELETED'
op|','
nl|'\n'
string|"'deleted_at'"
op|':'
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_run_pending_deletes'
op|'('
name|'ctxt'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'instance'
op|'['
string|"'cleaned'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reclaim_queued_deletes
dedent|''
name|'def'
name|'test_reclaim_queued_deletes'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'reclaim_instance_interval'
op|'='
number|'3600'
op|')'
newline|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# Active'
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
op|'{'
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# Deleted not old enough'
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
op|'{'
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|','
nl|'\n'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'SOFT_DELETED'
op|','
nl|'\n'
string|"'deleted_at'"
op|':'
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# Deleted old enough (only this one should be reclaimed)'
nl|'\n'
name|'deleted_at'
op|'='
op|'('
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
op|'-'
nl|'\n'
name|'datetime'
op|'.'
name|'timedelta'
op|'('
name|'hours'
op|'='
number|'1'
op|','
name|'minutes'
op|'='
number|'5'
op|')'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
name|'params'
op|'='
op|'{'
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|','
nl|'\n'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'SOFT_DELETED'
op|','
nl|'\n'
string|"'deleted_at'"
op|':'
name|'deleted_at'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# Restoring'
nl|'\n'
comment|'# NOTE(hanlind): This specifically tests for a race condition'
nl|'\n'
comment|'# where restoring a previously soft deleted instance sets'
nl|'\n'
comment|'# deleted_at back to None, causing reclaim to think it can be'
nl|'\n'
comment|'# deleted, see LP #1186243.'
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
name|'params'
op|'='
op|'{'
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|','
nl|'\n'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'SOFT_DELETED'
op|','
nl|'\n'
string|"'task_state'"
op|':'
name|'task_states'
op|'.'
name|'RESTORING'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_delete_instance'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_delete_instance'
op|'('
name|'ctxt'
op|','
name|'mox'
op|'.'
name|'IsA'
op|'('
name|'instance_obj'
op|'.'
name|'Instance'
op|')'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reclaim_queued_deletes'
op|'('
name|'ctxt'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reclaim_queued_deletes_continue_on_error
dedent|''
name|'def'
name|'test_reclaim_queued_deletes_continue_on_error'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Verify that reclaim continues on error.'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'reclaim_instance_interval'
op|'='
number|'3600'
op|')'
newline|'\n'
name|'ctxt'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'deleted_at'
op|'='
op|'('
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
op|'-'
nl|'\n'
name|'datetime'
op|'.'
name|'timedelta'
op|'('
name|'hours'
op|'='
number|'1'
op|','
name|'minutes'
op|'='
number|'5'
op|')'
op|')'
newline|'\n'
name|'instance1'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
nl|'\n'
name|'params'
op|'='
op|'{'
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|','
nl|'\n'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'SOFT_DELETED'
op|','
nl|'\n'
string|"'deleted_at'"
op|':'
name|'deleted_at'
op|'}'
op|')'
newline|'\n'
name|'instance2'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
nl|'\n'
name|'params'
op|'='
op|'{'
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|','
nl|'\n'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'SOFT_DELETED'
op|','
nl|'\n'
string|"'deleted_at'"
op|':'
name|'deleted_at'
op|'}'
op|')'
newline|'\n'
name|'instances'
op|'='
op|'['
op|']'
newline|'\n'
name|'instances'
op|'.'
name|'append'
op|'('
name|'instance1'
op|')'
newline|'\n'
name|'instances'
op|'.'
name|'append'
op|'('
name|'instance2'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'instance_obj'
op|'.'
name|'InstanceList'
op|','
nl|'\n'
string|"'get_by_filters'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_deleted_old_enough'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
nl|'\n'
string|"'block_device_mapping_get_all_by_instance'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_delete_instance'"
op|')'
newline|'\n'
nl|'\n'
name|'instance_obj'
op|'.'
name|'InstanceList'
op|'.'
name|'get_by_filters'
op|'('
nl|'\n'
name|'ctxt'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'expected_attrs'
op|'='
name|'instance_obj'
op|'.'
name|'INSTANCE_DEFAULT_FIELDS'
nl|'\n'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'instances'
op|')'
newline|'\n'
nl|'\n'
comment|'# The first instance delete fails.'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_deleted_old_enough'
op|'('
name|'instance1'
op|','
number|'3600'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|'.'
name|'block_device_mapping_get_all_by_instance'
op|'('
nl|'\n'
name|'ctxt'
op|','
name|'instance1'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_delete_instance'
op|'('
name|'ctxt'
op|','
name|'instance1'
op|','
nl|'\n'
name|'None'
op|')'
op|'.'
name|'AndRaise'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|')'
newline|'\n'
nl|'\n'
comment|'# The second instance delete that follows.'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_deleted_old_enough'
op|'('
name|'instance2'
op|','
number|'3600'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|'.'
name|'block_device_mapping_get_all_by_instance'
op|'('
nl|'\n'
name|'ctxt'
op|','
name|'instance2'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_delete_instance'
op|'('
name|'ctxt'
op|','
name|'instance2'
op|','
nl|'\n'
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reclaim_queued_deletes'
op|'('
name|'ctxt'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_sync_power_states
dedent|''
name|'def'
name|'test_sync_power_states'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ctxt'
op|'='
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'host'"
op|':'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'get_info'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_sync_instance_power_state'"
op|')'
newline|'\n'
nl|'\n'
comment|'# Check to make sure task continues on error.'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'get_info'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
op|'.'
name|'AndRaise'
op|'('
nl|'\n'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
string|"'fake-uuid'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_sync_instance_power_state'
op|'('
name|'ctxt'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'power_state'
op|'.'
name|'NOSTATE'
op|')'
op|'.'
name|'AndRaise'
op|'('
nl|'\n'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
string|"'fake-uuid'"
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'get_info'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
op|'.'
name|'AndReturn'
op|'('
nl|'\n'
op|'{'
string|"'state'"
op|':'
name|'power_state'
op|'.'
name|'RUNNING'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_sync_instance_power_state'
op|'('
name|'ctxt'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'power_state'
op|'.'
name|'RUNNING'
op|','
nl|'\n'
name|'use_slave'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'get_info'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
op|'.'
name|'AndReturn'
op|'('
nl|'\n'
op|'{'
string|"'state'"
op|':'
name|'power_state'
op|'.'
name|'SHUTDOWN'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_sync_instance_power_state'
op|'('
name|'ctxt'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'power_state'
op|'.'
name|'SHUTDOWN'
op|','
nl|'\n'
name|'use_slave'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_sync_power_states'
op|'('
name|'ctxt'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_lifecycle_event
dedent|''
name|'def'
name|'_test_lifecycle_event'
op|'('
name|'self'
op|','
name|'lifecycle_event'
op|','
name|'power_state'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_sync_instance_power_state'"
op|')'
newline|'\n'
name|'if'
name|'power_state'
op|'!='
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_sync_instance_power_state'
op|'('
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'ContainsKeyValue'
op|'('
string|"'uuid'"
op|','
name|'uuid'
op|')'
op|','
nl|'\n'
name|'power_state'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'handle_events'
op|'('
name|'event'
op|'.'
name|'LifecycleEvent'
op|'('
name|'uuid'
op|','
name|'lifecycle_event'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'VerifyAll'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'UnsetStubs'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_lifecycle_events
dedent|''
name|'def'
name|'test_lifecycle_events'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_lifecycle_event'
op|'('
name|'event'
op|'.'
name|'EVENT_LIFECYCLE_STOPPED'
op|','
nl|'\n'
name|'power_state'
op|'.'
name|'SHUTDOWN'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_test_lifecycle_event'
op|'('
name|'event'
op|'.'
name|'EVENT_LIFECYCLE_STARTED'
op|','
nl|'\n'
name|'power_state'
op|'.'
name|'RUNNING'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_test_lifecycle_event'
op|'('
name|'event'
op|'.'
name|'EVENT_LIFECYCLE_PAUSED'
op|','
nl|'\n'
name|'power_state'
op|'.'
name|'PAUSED'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_test_lifecycle_event'
op|'('
name|'event'
op|'.'
name|'EVENT_LIFECYCLE_RESUMED'
op|','
nl|'\n'
name|'power_state'
op|'.'
name|'RUNNING'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_test_lifecycle_event'
op|'('
op|'-'
number|'1'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_lifecycle_event_non_existent_instance
dedent|''
name|'def'
name|'test_lifecycle_event_non_existent_instance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# No error raised for non-existent instance because of inherent race'
nl|'\n'
comment|'# between database updates and hypervisor events. See bug #1180501.'
nl|'\n'
indent|'        '
name|'event_instance'
op|'='
name|'event'
op|'.'
name|'LifecycleEvent'
op|'('
string|"'does-not-exist'"
op|','
nl|'\n'
name|'event'
op|'.'
name|'EVENT_LIFECYCLE_STOPPED'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'handle_events'
op|'('
name|'event_instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_allow_confirm_resize_on_instance_in_deleting_task_state
dedent|''
name|'def'
name|'test_allow_confirm_resize_on_instance_in_deleting_task_state'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'old_type'
op|'='
name|'flavors'
op|'.'
name|'extract_flavor'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'new_type'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_flavor_id'
op|'('
string|"'4'"
op|')'
newline|'\n'
name|'sys_meta'
op|'='
name|'instance'
op|'.'
name|'system_metadata'
newline|'\n'
name|'sys_meta'
op|'='
name|'flavors'
op|'.'
name|'save_flavor_info'
op|'('
name|'sys_meta'
op|','
nl|'\n'
name|'old_type'
op|','
string|"'old_'"
op|')'
newline|'\n'
name|'sys_meta'
op|'='
name|'flavors'
op|'.'
name|'save_flavor_info'
op|'('
name|'sys_meta'
op|','
nl|'\n'
name|'new_type'
op|','
string|"'new_'"
op|')'
newline|'\n'
name|'sys_meta'
op|'='
name|'flavors'
op|'.'
name|'save_flavor_info'
op|'('
name|'sys_meta'
op|','
nl|'\n'
name|'new_type'
op|')'
newline|'\n'
nl|'\n'
name|'fake_rt'
op|'='
name|'self'
op|'.'
name|'mox'
op|'.'
name|'CreateMockAnything'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_drop_resize_claim
name|'def'
name|'fake_drop_resize_claim'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
DECL|function|fake_get_resource_tracker
dedent|''
name|'def'
name|'fake_get_resource_tracker'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'fake_rt'
newline|'\n'
nl|'\n'
DECL|function|fake_setup_networks_on_host
dedent|''
name|'def'
name|'fake_setup_networks_on_host'
op|'('
name|'self'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_rt'
op|','
string|"'drop_resize_claim'"
op|','
name|'fake_drop_resize_claim'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_resource_tracker'"
op|','
nl|'\n'
name|'fake_get_resource_tracker'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|','
string|"'setup_networks_on_host'"
op|','
nl|'\n'
name|'fake_setup_networks_on_host'
op|')'
newline|'\n'
nl|'\n'
name|'migration'
op|'='
name|'migration_obj'
op|'.'
name|'Migration'
op|'('
op|')'
newline|'\n'
name|'migration'
op|'.'
name|'instance_uuid'
op|'='
name|'instance'
op|'.'
name|'uuid'
newline|'\n'
name|'migration'
op|'.'
name|'status'
op|'='
string|"'finished'"
newline|'\n'
name|'migration'
op|'.'
name|'create'
op|'('
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'DELETING'
newline|'\n'
name|'instance'
op|'.'
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'RESIZED'
newline|'\n'
name|'instance'
op|'.'
name|'system_metadata'
op|'='
name|'sys_meta'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'confirm_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|','
nl|'\n'
name|'migration'
op|'='
name|'migration'
op|','
name|'reservations'
op|'='
op|'['
op|']'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'refresh'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'vm_states'
op|'.'
name|'ACTIVE'
op|','
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_instance_and_bdm_for_dev_defaults_tests
dedent|''
name|'def'
name|'_get_instance_and_bdm_for_dev_defaults_tests'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
name|'params'
op|'='
op|'{'
string|"'root_device_name'"
op|':'
string|"'/dev/vda'"
op|'}'
op|')'
newline|'\n'
name|'block_device_mapping'
op|'='
op|'['
nl|'\n'
op|'{'
string|"'id'"
op|':'
number|'3'
op|','
string|"'instance_uuid'"
op|':'
string|"'fake-instance'"
op|','
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/vda'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'image_id'"
op|':'
string|"'fake-image-id-1'"
op|','
nl|'\n'
string|"'boot_index'"
op|':'
number|'0'
op|'}'
op|']'
newline|'\n'
nl|'\n'
name|'return'
name|'instance'
op|','
name|'block_device_mapping'
newline|'\n'
nl|'\n'
DECL|member|test_default_block_device_names_empty_instance_root_dev
dedent|''
name|'def'
name|'test_default_block_device_names_empty_instance_root_dev'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|','
name|'bdms'
op|'='
name|'self'
op|'.'
name|'_get_instance_and_bdm_for_dev_defaults_tests'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'['
string|"'root_device_name'"
op|']'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_instance_update'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_default_device_names_for_instance'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
name|'root_device_name'
op|'='
string|"'/dev/vda'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_default_device_names_for_instance'
op|'('
name|'instance'
op|','
nl|'\n'
string|"'/dev/vda'"
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
op|'['
op|']'
op|','
op|'['
op|']'
op|','
name|'bdms'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_default_block_device_names'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
op|'{'
op|'}'
op|','
name|'bdms'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_default_block_device_names_empty_root_device
dedent|''
name|'def'
name|'test_default_block_device_names_empty_root_device'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|','
name|'bdms'
op|'='
name|'self'
op|'.'
name|'_get_instance_and_bdm_for_dev_defaults_tests'
op|'('
op|')'
newline|'\n'
name|'bdms'
op|'['
number|'0'
op|']'
op|'['
string|"'device_name'"
op|']'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
nl|'\n'
string|"'block_device_mapping_update'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_default_device_names_for_instance'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|'.'
name|'block_device_mapping_update'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'bdms'
op|'['
number|'0'
op|']'
op|'['
string|"'id'"
op|']'
op|','
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/vda'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_default_device_names_for_instance'
op|'('
name|'instance'
op|','
nl|'\n'
string|"'/dev/vda'"
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
op|'['
op|']'
op|','
op|'['
op|']'
op|','
name|'bdms'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_default_block_device_names'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
op|'{'
op|'}'
op|','
name|'bdms'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_default_block_device_names_no_root_device
dedent|''
name|'def'
name|'test_default_block_device_names_no_root_device'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|','
name|'bdms'
op|'='
name|'self'
op|'.'
name|'_get_instance_and_bdm_for_dev_defaults_tests'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'['
string|"'root_device_name'"
op|']'
op|'='
name|'None'
newline|'\n'
name|'bdms'
op|'['
number|'0'
op|']'
op|'['
string|"'device_name'"
op|']'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_instance_update'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
nl|'\n'
string|"'block_device_mapping_update'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_default_root_device_name'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
nl|'\n'
string|"'_default_device_names_for_instance'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_default_root_device_name'
op|'('
name|'instance'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'bdms'
op|'['
number|'0'
op|']'
op|')'
op|'.'
name|'AndReturn'
op|'('
string|"'/dev/vda'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
name|'root_device_name'
op|'='
string|"'/dev/vda'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|'.'
name|'block_device_mapping_update'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'bdms'
op|'['
number|'0'
op|']'
op|'['
string|"'id'"
op|']'
op|','
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/vda'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_default_device_names_for_instance'
op|'('
name|'instance'
op|','
nl|'\n'
string|"'/dev/vda'"
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
op|'['
op|']'
op|','
op|'['
op|']'
op|','
name|'bdms'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_default_block_device_names'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
op|'{'
op|'}'
op|','
name|'bdms'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ComputeAPITestCase
dedent|''
dedent|''
name|'class'
name|'ComputeAPITestCase'
op|'('
name|'BaseTestCase'
op|')'
op|':'
newline|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|fake_get_nw_info
indent|'        '
name|'def'
name|'fake_get_nw_info'
op|'('
name|'cls'
op|','
name|'ctxt'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'ctxt'
op|'.'
name|'is_admin'
op|')'
newline|'\n'
name|'return'
name|'fake_network'
op|'.'
name|'fake_get_instance_nw_info'
op|'('
name|'self'
op|'.'
name|'stubs'
op|','
number|'1'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'super'
op|'('
name|'ComputeAPITestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'network_api'
op|'.'
name|'API'
op|','
string|"'get_instance_nw_info'"
op|','
nl|'\n'
name|'fake_get_nw_info'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'security_group_api'
op|'='
op|'('
nl|'\n'
name|'openstack_driver'
op|'.'
name|'get_openstack_security_group_driver'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'='
name|'compute'
op|'.'
name|'API'
op|'('
nl|'\n'
name|'security_group_api'
op|'='
name|'self'
op|'.'
name|'security_group_api'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'='
op|'{'
nl|'\n'
string|"'id'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'fake_name'"
op|','
nl|'\n'
string|"'status'"
op|':'
string|"'active'"
op|','
nl|'\n'
string|"'properties'"
op|':'
op|'{'
string|"'kernel_id'"
op|':'
string|"'fake_kernel_id'"
op|','
nl|'\n'
string|"'ramdisk_id'"
op|':'
string|"'fake_ramdisk_id'"
op|'}'
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_show
name|'def'
name|'fake_show'
op|'('
name|'obj'
op|','
name|'context'
op|','
name|'image_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'image_id'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'self'
op|'.'
name|'fake_image'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'exception'
op|'.'
name|'ImageNotFound'
op|'('
name|'image_id'
op|'='
name|'image_id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'fake_show'
op|'='
name|'fake_show'
newline|'\n'
nl|'\n'
DECL|member|_run_instance
dedent|''
name|'def'
name|'_run_instance'
op|'('
name|'self'
op|','
name|'params'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|','
nl|'\n'
name|'services'
op|'='
name|'True'
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|')'
newline|'\n'
name|'return'
name|'instance'
op|','
name|'instance_uuid'
newline|'\n'
nl|'\n'
DECL|member|test_create_with_too_little_ram
dedent|''
name|'def'
name|'test_create_with_too_little_ram'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test an instance type with too little memory.'
nl|'\n'
nl|'\n'
indent|'        '
name|'inst_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
name|'inst_type'
op|'['
string|"'memory_mb'"
op|']'
op|'='
number|'1'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'min_ram'"
op|']'
op|'='
number|'2'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'self'
op|'.'
name|'fake_show'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'FlavorMemoryTooSmall'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'inst_type'
op|','
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# Now increase the inst_type memory and make sure all is fine.'
nl|'\n'
name|'inst_type'
op|'['
string|"'memory_mb'"
op|']'
op|'='
number|'2'
newline|'\n'
op|'('
name|'refs'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'inst_type'
op|','
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'refs'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_with_too_little_disk
dedent|''
name|'def'
name|'test_create_with_too_little_disk'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test an instance type with too little disk space.'
nl|'\n'
nl|'\n'
indent|'        '
name|'inst_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
name|'inst_type'
op|'['
string|"'root_gb'"
op|']'
op|'='
number|'1'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'min_disk'"
op|']'
op|'='
number|'2'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'self'
op|'.'
name|'fake_show'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'FlavorDiskTooSmall'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'inst_type'
op|','
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# Now increase the inst_type disk space and make sure all is fine.'
nl|'\n'
name|'inst_type'
op|'['
string|"'root_gb'"
op|']'
op|'='
number|'2'
newline|'\n'
op|'('
name|'refs'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'inst_type'
op|','
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'refs'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_with_too_large_image
dedent|''
name|'def'
name|'test_create_with_too_large_image'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test an instance type with too little disk space.'
nl|'\n'
nl|'\n'
indent|'        '
name|'inst_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
name|'inst_type'
op|'['
string|"'root_gb'"
op|']'
op|'='
number|'1'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'size'"
op|']'
op|'='
string|"'1073741825'"
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'self'
op|'.'
name|'fake_show'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'FlavorDiskTooSmall'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'inst_type'
op|','
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# Reduce image to 1 GB limit and ensure it works'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'size'"
op|']'
op|'='
string|"'1073741824'"
newline|'\n'
op|'('
name|'refs'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'inst_type'
op|','
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'refs'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_just_enough_ram_and_disk
dedent|''
name|'def'
name|'test_create_just_enough_ram_and_disk'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test an instance type with just enough ram and disk space.'
nl|'\n'
nl|'\n'
indent|'        '
name|'inst_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
name|'inst_type'
op|'['
string|"'root_gb'"
op|']'
op|'='
number|'2'
newline|'\n'
name|'inst_type'
op|'['
string|"'memory_mb'"
op|']'
op|'='
number|'2'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'min_ram'"
op|']'
op|'='
number|'2'
newline|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'min_disk'"
op|']'
op|'='
number|'2'
newline|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'name'"
op|']'
op|'='
string|"'fake_name'"
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'self'
op|'.'
name|'fake_show'
op|')'
newline|'\n'
nl|'\n'
op|'('
name|'refs'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'inst_type'
op|','
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'refs'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_with_no_ram_and_disk_reqs
dedent|''
name|'def'
name|'test_create_with_no_ram_and_disk_reqs'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test an instance type with no min_ram or min_disk.'
nl|'\n'
nl|'\n'
indent|'        '
name|'inst_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
name|'inst_type'
op|'['
string|"'root_gb'"
op|']'
op|'='
number|'1'
newline|'\n'
name|'inst_type'
op|'['
string|"'memory_mb'"
op|']'
op|'='
number|'1'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'self'
op|'.'
name|'fake_show'
op|')'
newline|'\n'
nl|'\n'
op|'('
name|'refs'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'inst_type'
op|','
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'refs'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_with_deleted_image
dedent|''
name|'def'
name|'test_create_with_deleted_image'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|"# If we're given a deleted image by glance, we should not be able to"
nl|'\n'
comment|'# build from it'
nl|'\n'
indent|'        '
name|'inst_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'name'"
op|']'
op|'='
string|"'fake_name'"
newline|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'status'"
op|']'
op|'='
string|"'DELETED'"
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'self'
op|'.'
name|'fake_show'
op|')'
newline|'\n'
nl|'\n'
name|'expected_message'
op|'='
op|'('
nl|'\n'
name|'exception'
op|'.'
name|'ImageNotActive'
op|'.'
name|'msg_fmt'
op|'%'
op|'{'
string|"'image_id'"
op|':'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|'}'
op|')'
newline|'\n'
name|'with'
name|'testtools'
op|'.'
name|'ExpectedException'
op|'('
name|'exception'
op|'.'
name|'ImageNotActive'
op|','
nl|'\n'
name|'expected_message'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'inst_type'
op|','
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_instance_defaults_display_name
dedent|''
dedent|''
name|'def'
name|'test_create_instance_defaults_display_name'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Verify that an instance cannot be created without a display_name.'
nl|'\n'
indent|'        '
name|'cases'
op|'='
op|'['
name|'dict'
op|'('
op|')'
op|','
name|'dict'
op|'('
name|'display_name'
op|'='
name|'None'
op|')'
op|']'
newline|'\n'
name|'for'
name|'instance'
name|'in'
name|'cases'
op|':'
newline|'\n'
indent|'            '
op|'('
name|'ref'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
op|','
nl|'\n'
string|"'fake-image-uuid'"
op|','
op|'**'
name|'instance'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertIsNotNone'
op|'('
name|'ref'
op|'['
number|'0'
op|']'
op|'['
string|"'display_name'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'                '
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'ref'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_instance_sets_system_metadata
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_create_instance_sets_system_metadata'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure image properties are copied into system metadata.'
nl|'\n'
indent|'        '
op|'('
name|'ref'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
op|','
nl|'\n'
name|'image_href'
op|'='
string|"'fake-image-uuid'"
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'sys_metadata'
op|'='
name|'db'
op|'.'
name|'instance_system_metadata_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'ref'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'image_props'
op|'='
op|'{'
string|"'image_kernel_id'"
op|':'
string|"'fake_kernel_id'"
op|','
nl|'\n'
string|"'image_ramdisk_id'"
op|':'
string|"'fake_ramdisk_id'"
op|','
nl|'\n'
string|"'image_something_else'"
op|':'
string|"'meow'"
op|','
op|'}'
newline|'\n'
name|'for'
name|'key'
op|','
name|'value'
name|'in'
name|'image_props'
op|'.'
name|'iteritems'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'key'
op|','
name|'sys_metadata'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'value'
op|','
name|'sys_metadata'
op|'['
name|'key'
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'ref'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_saves_type_in_system_metadata
dedent|''
dedent|''
name|'def'
name|'test_create_saves_type_in_system_metadata'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
op|'('
name|'ref'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'instance_type'
op|','
nl|'\n'
name|'image_href'
op|'='
string|"'some-fake-image'"
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'sys_metadata'
op|'='
name|'db'
op|'.'
name|'instance_system_metadata_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'ref'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'instance_type_props'
op|'='
op|'['
string|"'name'"
op|','
string|"'memory_mb'"
op|','
string|"'vcpus'"
op|','
string|"'root_gb'"
op|','
nl|'\n'
string|"'ephemeral_gb'"
op|','
string|"'flavorid'"
op|','
string|"'swap'"
op|','
nl|'\n'
string|"'rxtx_factor'"
op|','
string|"'vcpu_weight'"
op|']'
newline|'\n'
name|'for'
name|'key'
name|'in'
name|'instance_type_props'
op|':'
newline|'\n'
indent|'                '
name|'sys_meta_key'
op|'='
string|'"instance_type_%s"'
op|'%'
name|'key'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'sys_meta_key'
op|','
name|'sys_metadata'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'instance_type'
op|'['
name|'key'
op|']'
op|')'
op|','
nl|'\n'
name|'str'
op|'('
name|'sys_metadata'
op|'['
name|'sys_meta_key'
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'ref'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_instance_associates_security_groups
dedent|''
dedent|''
name|'def'
name|'test_create_instance_associates_security_groups'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure create associates security groups.'
nl|'\n'
indent|'        '
name|'group'
op|'='
name|'self'
op|'.'
name|'_create_group'
op|'('
op|')'
newline|'\n'
op|'('
name|'ref'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
op|','
nl|'\n'
name|'image_href'
op|'='
string|"'some-fake-image'"
op|','
nl|'\n'
name|'security_group'
op|'='
op|'['
string|"'testgroup'"
op|']'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'db'
op|'.'
name|'security_group_get_by_instance'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'ref'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'group'
op|'='
name|'db'
op|'.'
name|'security_group_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'group'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'len'
op|'('
name|'group'
op|'['
string|"'instances'"
op|']'
op|')'
op|'=='
number|'1'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'security_group_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'group'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'ref'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_instance_with_invalid_security_group_raises
dedent|''
dedent|''
name|'def'
name|'test_create_instance_with_invalid_security_group_raises'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'pre_build_len'
op|'='
name|'len'
op|'('
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'SecurityGroupNotFoundForProject'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'instance_type'
op|','
nl|'\n'
name|'image_href'
op|'='
name|'None'
op|','
nl|'\n'
name|'security_group'
op|'='
op|'['
string|"'this_is_a_fake_sec_group'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'pre_build_len'
op|','
nl|'\n'
name|'len'
op|'('
name|'db'
op|'.'
name|'instance_get_all'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_with_large_user_data
dedent|''
name|'def'
name|'test_create_with_large_user_data'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test an instance type with too much user data.'
nl|'\n'
nl|'\n'
indent|'        '
name|'inst_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'min_ram'"
op|']'
op|'='
number|'2'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'self'
op|'.'
name|'fake_show'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceUserDataTooLarge'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'inst_type'
op|','
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|','
name|'user_data'
op|'='
op|'('
string|"'1'"
op|'*'
number|'65536'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_with_malformed_user_data
dedent|''
name|'def'
name|'test_create_with_malformed_user_data'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test an instance type with malformed user data.'
nl|'\n'
nl|'\n'
indent|'        '
name|'inst_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'min_ram'"
op|']'
op|'='
number|'2'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'self'
op|'.'
name|'fake_show'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceUserDataMalformed'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'inst_type'
op|','
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|','
name|'user_data'
op|'='
string|"'banana'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_with_base64_user_data
dedent|''
name|'def'
name|'test_create_with_base64_user_data'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test an instance type with ok much user data.'
nl|'\n'
nl|'\n'
indent|'        '
name|'inst_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'min_ram'"
op|']'
op|'='
number|'2'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'self'
op|'.'
name|'fake_show'
op|')'
newline|'\n'
nl|'\n'
comment|'# NOTE(mikal): a string of length 48510 encodes to 65532 characters of'
nl|'\n'
comment|'# base64'
nl|'\n'
op|'('
name|'refs'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'inst_type'
op|','
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'user_data'
op|'='
name|'base64'
op|'.'
name|'encodestring'
op|'('
string|"'1'"
op|'*'
number|'48510'
op|')'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'refs'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_populate_instance_for_create
dedent|''
name|'def'
name|'test_populate_instance_for_create'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'base_options'
op|'='
op|'{'
string|"'image_ref'"
op|':'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
string|"'system_metadata'"
op|':'
op|'{'
string|"'fake'"
op|':'
string|"'value'"
op|'}'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'instance_obj'
op|'.'
name|'Instance'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'update'
op|'('
name|'base_options'
op|')'
newline|'\n'
name|'inst_type'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
string|'"m1.tiny"'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_populate_instance_for_create'
op|'('
nl|'\n'
name|'instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|','
nl|'\n'
number|'1'
op|','
nl|'\n'
name|'security_groups'
op|'='
name|'None'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'inst_type'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'str'
op|'('
name|'base_options'
op|'['
string|"'image_ref'"
op|']'
op|')'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'system_metadata'"
op|']'
op|'['
string|"'image_base_image_ref'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'vm_states'
op|'.'
name|'BUILDING'
op|','
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'task_states'
op|'.'
name|'SCHEDULING'
op|','
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'instance'
op|'['
string|"'launch_index'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNotNone'
op|'('
name|'instance'
op|'.'
name|'get'
op|'('
string|"'uuid'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
op|'['
op|']'
op|','
name|'instance'
op|'.'
name|'security_groups'
op|'.'
name|'objects'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_default_hostname_generator
dedent|''
name|'def'
name|'test_default_hostname_generator'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'fake_uuids'
op|'='
op|'['
name|'str'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|')'
name|'for'
name|'x'
name|'in'
name|'xrange'
op|'('
number|'4'
op|')'
op|']'
newline|'\n'
nl|'\n'
name|'orig_populate'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_populate_instance_for_create'
newline|'\n'
nl|'\n'
DECL|function|_fake_populate
name|'def'
name|'_fake_populate'
op|'('
name|'base_options'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'base_options'
op|'['
string|"'uuid'"
op|']'
op|'='
name|'fake_uuids'
op|'.'
name|'pop'
op|'('
number|'0'
op|')'
newline|'\n'
name|'return'
name|'orig_populate'
op|'('
name|'base_options'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|','
nl|'\n'
string|"'_populate_instance_for_create'"
op|','
nl|'\n'
name|'_fake_populate'
op|')'
newline|'\n'
nl|'\n'
name|'cases'
op|'='
op|'['
op|'('
name|'None'
op|','
string|"'server-%s'"
op|'%'
name|'fake_uuids'
op|'['
number|'0'
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'Hello, Server!'"
op|','
string|"'hello-server'"
op|')'
op|','
nl|'\n'
op|'('
string|"'<}\\x1fh\\x10e\\x08l\\x02l\\x05o\\x12!{>'"
op|','
string|"'hello'"
op|')'
op|','
nl|'\n'
op|'('
string|"'hello_server'"
op|','
string|"'hello-server'"
op|')'
op|']'
newline|'\n'
name|'for'
name|'display_name'
op|','
name|'hostname'
name|'in'
name|'cases'
op|':'
newline|'\n'
indent|'            '
op|'('
name|'ref'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
op|','
name|'image_href'
op|'='
string|"'some-fake-image'"
op|','
nl|'\n'
name|'display_name'
op|'='
name|'display_name'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'ref'
op|'['
number|'0'
op|']'
op|'['
string|"'hostname'"
op|']'
op|','
name|'hostname'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'                '
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'ref'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_destroy_instance_disassociates_security_groups
dedent|''
dedent|''
dedent|''
name|'def'
name|'test_destroy_instance_disassociates_security_groups'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure destroying disassociates security groups.'
nl|'\n'
indent|'        '
name|'group'
op|'='
name|'self'
op|'.'
name|'_create_group'
op|'('
op|')'
newline|'\n'
nl|'\n'
op|'('
name|'ref'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
op|','
nl|'\n'
name|'image_href'
op|'='
string|"'some-fake-image'"
op|','
nl|'\n'
name|'security_group'
op|'='
op|'['
string|"'testgroup'"
op|']'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'ref'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'group'
op|'='
name|'db'
op|'.'
name|'security_group_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'group'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'len'
op|'('
name|'group'
op|'['
string|"'instances'"
op|']'
op|')'
op|'=='
number|'0'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'security_group_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'group'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_destroy_security_group_disassociates_instances
dedent|''
dedent|''
name|'def'
name|'test_destroy_security_group_disassociates_instances'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure destroying security groups disassociates instances.'
nl|'\n'
indent|'        '
name|'group'
op|'='
name|'self'
op|'.'
name|'_create_group'
op|'('
op|')'
newline|'\n'
nl|'\n'
op|'('
name|'ref'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
op|','
nl|'\n'
name|'image_href'
op|'='
string|"'some-fake-image'"
op|','
nl|'\n'
name|'security_group'
op|'='
op|'['
string|"'testgroup'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'security_group_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'group'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'admin_deleted_context'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
nl|'\n'
name|'read_deleted'
op|'='
string|'"only"'
op|')'
newline|'\n'
name|'group'
op|'='
name|'db'
op|'.'
name|'security_group_get'
op|'('
name|'admin_deleted_context'
op|','
name|'group'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'len'
op|'('
name|'group'
op|'['
string|"'instances'"
op|']'
op|')'
op|'=='
number|'0'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'ref'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_restore
dedent|''
dedent|''
name|'def'
name|'test_restore'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance can be restored from a soft delete.'
nl|'\n'
indent|'        '
name|'instance'
op|','
name|'instance_uuid'
op|'='
name|'self'
op|'.'
name|'_run_instance'
op|'('
name|'params'
op|'='
op|'{'
nl|'\n'
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|','
nl|'\n'
string|"'cell_name'"
op|':'
string|"'foo'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'instance_obj'
op|'.'
name|'Instance'
op|'.'
name|'get_by_uuid'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|','
nl|'\n'
name|'expected_attrs'
op|'='
name|'instance_obj'
op|'.'
name|'INSTANCE_DEFAULT_FIELDS'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'soft_delete'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'.'
name|'refresh'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'.'
name|'task_state'
op|','
name|'task_states'
op|'.'
name|'SOFT_DELETING'
op|')'
newline|'\n'
nl|'\n'
comment|'# set the state that the instance gets when soft_delete finishes'
nl|'\n'
name|'instance'
op|'.'
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'SOFT_DELETED'
newline|'\n'
name|'instance'
op|'.'
name|'task_state'
op|'='
name|'None'
newline|'\n'
name|'instance'
op|'.'
name|'save'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# Ensure quotas are committed'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'nova'
op|'.'
name|'quota'
op|'.'
name|'QUOTAS'
op|','
string|"'commit'"
op|')'
newline|'\n'
name|'nova'
op|'.'
name|'quota'
op|'.'
name|'QUOTAS'
op|'.'
name|'commit'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'restore'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|','
name|'task_states'
op|'.'
name|'RESTORING'
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_rebuild
dedent|''
name|'def'
name|'_test_rebuild'
op|'('
name|'self'
op|','
name|'vm_state'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|')'
newline|'\n'
comment|'# Set some image metadata that should get wiped out and reset'
nl|'\n'
comment|'# as well as some other metadata that should be preserved.'
nl|'\n'
name|'db'
op|'.'
name|'instance_system_metadata_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|','
nl|'\n'
op|'{'
string|"'image_kernel_id'"
op|':'
string|"'old-data'"
op|','
nl|'\n'
string|"'image_ramdisk_id'"
op|':'
string|"'old_data'"
op|','
nl|'\n'
string|"'image_something_else'"
op|':'
string|"'old-data'"
op|','
nl|'\n'
string|"'image_should_remove'"
op|':'
string|"'bye-bye'"
op|','
nl|'\n'
string|"'preserved'"
op|':'
string|"'preserve this!'"
op|'}'
op|','
nl|'\n'
name|'True'
op|')'
newline|'\n'
nl|'\n'
comment|'# Make sure Compute API updates the image_ref before casting to'
nl|'\n'
comment|'# compute manager.'
nl|'\n'
name|'orig_update'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'update'
newline|'\n'
name|'info'
op|'='
op|'{'
string|"'image_ref'"
op|':'
name|'None'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|update_wrapper
name|'def'
name|'update_wrapper'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
string|"'image_ref'"
name|'in'
name|'kwargs'
op|':'
newline|'\n'
indent|'                '
name|'info'
op|'['
string|"'image_ref'"
op|']'
op|'='
name|'kwargs'
op|'['
string|"'image_ref'"
op|']'
newline|'\n'
dedent|''
name|'return'
name|'orig_update'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|','
string|"'update'"
op|','
name|'update_wrapper'
op|')'
newline|'\n'
nl|'\n'
name|'image_ref'
op|'='
name|'instance'
op|'['
string|'"image_ref"'
op|']'
op|'+'
string|"'-new_image_ref'"
newline|'\n'
name|'password'
op|'='
string|'"new_password"'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|'"vm_state"'
op|':'
name|'vm_state'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'rebuild'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
name|'image_ref'
op|','
name|'password'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'info'
op|'['
string|"'image_ref'"
op|']'
op|','
name|'image_ref'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|','
name|'task_states'
op|'.'
name|'REBUILDING'
op|')'
newline|'\n'
name|'sys_metadata'
op|'='
name|'db'
op|'.'
name|'instance_system_metadata_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'sys_metadata'
op|','
nl|'\n'
op|'{'
string|"'image_kernel_id'"
op|':'
string|"'fake_kernel_id'"
op|','
nl|'\n'
string|"'image_min_disk'"
op|':'
string|"'1'"
op|','
nl|'\n'
string|"'image_ramdisk_id'"
op|':'
string|"'fake_ramdisk_id'"
op|','
nl|'\n'
string|"'image_something_else'"
op|':'
string|"'meow'"
op|','
nl|'\n'
string|"'preserved'"
op|':'
string|"'preserve this!'"
op|'}'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild
dedent|''
name|'def'
name|'test_rebuild'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_rebuild'
op|'('
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'ACTIVE'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_in_error_state
dedent|''
name|'def'
name|'test_rebuild_in_error_state'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test_rebuild'
op|'('
name|'vm_state'
op|'='
name|'vm_states'
op|'.'
name|'ERROR'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_in_error_not_launched
dedent|''
name|'def'
name|'test_rebuild_in_error_not_launched'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
op|'{'
string|"'image_ref'"
op|':'
string|"''"
op|'}'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'self'
op|'.'
name|'fake_show'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|'"vm_state"'
op|':'
name|'vm_states'
op|'.'
name|'ERROR'
op|','
nl|'\n'
string|'"launched_at"'
op|':'
name|'None'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceInvalidState'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'rebuild'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'image_ref'"
op|']'
op|','
nl|'\n'
string|'"new password"'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_no_image
dedent|''
name|'def'
name|'test_rebuild_no_image'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
op|'{'
string|"'image_ref'"
op|':'
string|"''"
op|'}'
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'self'
op|'.'
name|'fake_show'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'rebuild'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
string|"''"
op|','
string|"'new_password'"
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|','
name|'task_states'
op|'.'
name|'REBUILDING'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_with_deleted_image
dedent|''
name|'def'
name|'test_rebuild_with_deleted_image'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|"# If we're given a deleted image by glance, we should not be able to"
nl|'\n'
comment|'# rebuild from it'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
op|'{'
string|"'image_ref'"
op|':'
string|"'1'"
op|'}'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'name'"
op|']'
op|'='
string|"'fake_name'"
newline|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'status'"
op|']'
op|'='
string|"'DELETED'"
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'self'
op|'.'
name|'fake_show'
op|')'
newline|'\n'
nl|'\n'
name|'expected_message'
op|'='
op|'('
nl|'\n'
name|'exception'
op|'.'
name|'ImageNotActive'
op|'.'
name|'msg_fmt'
op|'%'
op|'{'
string|"'image_id'"
op|':'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|'}'
op|')'
newline|'\n'
name|'with'
name|'testtools'
op|'.'
name|'ExpectedException'
op|'('
name|'exception'
op|'.'
name|'ImageNotActive'
op|','
nl|'\n'
name|'expected_message'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'rebuild'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|','
string|"'new_password'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_with_too_little_ram
dedent|''
dedent|''
name|'def'
name|'test_rebuild_with_too_little_ram'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
op|'{'
string|"'image_ref'"
op|':'
string|"'1'"
op|'}'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_extract_flavor
name|'def'
name|'fake_extract_flavor'
op|'('
name|'_inst'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'dict'
op|'('
name|'memory_mb'
op|'='
number|'64'
op|','
name|'root_gb'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'flavors'
op|','
string|"'extract_flavor'"
op|','
nl|'\n'
name|'fake_extract_flavor'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'min_ram'"
op|']'
op|'='
number|'128'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'self'
op|'.'
name|'fake_show'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'FlavorMemoryTooSmall'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'rebuild'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|','
string|"'new_password'"
op|')'
newline|'\n'
nl|'\n'
comment|'# Reduce image memory requirements and make sure it works'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'min_ram'"
op|']'
op|'='
number|'64'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'rebuild'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|','
string|"'new_password'"
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_with_too_little_disk
dedent|''
name|'def'
name|'test_rebuild_with_too_little_disk'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
op|'{'
string|"'image_ref'"
op|':'
string|"'1'"
op|'}'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_extract_flavor
name|'def'
name|'fake_extract_flavor'
op|'('
name|'_inst'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'dict'
op|'('
name|'memory_mb'
op|'='
number|'64'
op|','
name|'root_gb'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'flavors'
op|','
string|"'extract_flavor'"
op|','
nl|'\n'
name|'fake_extract_flavor'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'min_disk'"
op|']'
op|'='
number|'2'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'self'
op|'.'
name|'fake_show'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'FlavorDiskTooSmall'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'rebuild'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|','
string|"'new_password'"
op|')'
newline|'\n'
nl|'\n'
comment|'# Reduce image disk requirements and make sure it works'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'min_disk'"
op|']'
op|'='
number|'1'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'rebuild'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|','
string|"'new_password'"
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_with_just_enough_ram_and_disk
dedent|''
name|'def'
name|'test_rebuild_with_just_enough_ram_and_disk'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
op|'{'
string|"'image_ref'"
op|':'
string|"'1'"
op|'}'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_extract_flavor
name|'def'
name|'fake_extract_flavor'
op|'('
name|'_inst'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'dict'
op|'('
name|'memory_mb'
op|'='
number|'64'
op|','
name|'root_gb'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'flavors'
op|','
string|"'extract_flavor'"
op|','
nl|'\n'
name|'fake_extract_flavor'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'min_ram'"
op|']'
op|'='
number|'64'
newline|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'min_disk'"
op|']'
op|'='
number|'1'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'self'
op|'.'
name|'fake_show'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'rebuild'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|','
string|"'new_password'"
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_with_no_ram_and_disk_reqs
dedent|''
name|'def'
name|'test_rebuild_with_no_ram_and_disk_reqs'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
op|'{'
string|"'image_ref'"
op|':'
string|"'1'"
op|'}'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_extract_flavor
name|'def'
name|'fake_extract_flavor'
op|'('
name|'_inst'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'dict'
op|'('
name|'memory_mb'
op|'='
number|'64'
op|','
name|'root_gb'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'flavors'
op|','
string|"'extract_flavor'"
op|','
nl|'\n'
name|'fake_extract_flavor'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'self'
op|'.'
name|'fake_show'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'rebuild'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|','
string|"'new_password'"
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_with_too_large_image
dedent|''
name|'def'
name|'test_rebuild_with_too_large_image'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
op|'{'
string|"'image_ref'"
op|':'
string|"'1'"
op|'}'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_extract_flavor
name|'def'
name|'fake_extract_flavor'
op|'('
name|'_inst'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'dict'
op|'('
name|'memory_mb'
op|'='
number|'64'
op|','
name|'root_gb'
op|'='
number|'1'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'flavors'
op|','
string|"'extract_flavor'"
op|','
nl|'\n'
name|'fake_extract_flavor'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'size'"
op|']'
op|'='
string|"'1073741825'"
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'self'
op|'.'
name|'fake_show'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'FlavorDiskTooSmall'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'rebuild'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|','
string|"'new_password'"
op|')'
newline|'\n'
nl|'\n'
comment|'# Reduce image to 1 GB limit and ensure it works'
nl|'\n'
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'size'"
op|']'
op|'='
string|"'1073741824'"
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'rebuild'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
name|'self'
op|'.'
name|'fake_image'
op|'['
string|"'id'"
op|']'
op|','
string|"'new_password'"
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_hostname_create
dedent|''
name|'def'
name|'test_hostname_create'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance hostname is set during creation.'
nl|'\n'
indent|'        '
name|'inst_type'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
string|"'m1.tiny'"
op|')'
newline|'\n'
op|'('
name|'instances'
op|','
name|'_'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'inst_type'
op|','
nl|'\n'
name|'image_href'
op|'='
string|"'some-fake-image'"
op|','
nl|'\n'
name|'display_name'
op|'='
string|"'test host'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'test-host'"
op|','
name|'instances'
op|'['
number|'0'
op|']'
op|'['
string|"'hostname'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_set_admin_password
dedent|''
name|'def'
name|'test_set_admin_password'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance can have its admin password set.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'inst_ref'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'inst_ref'
op|'['
string|"'vm_state'"
op|']'
op|','
name|'vm_states'
op|'.'
name|'ACTIVE'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'inst_ref'
op|'['
string|"'task_state'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_rpc_method
name|'def'
name|'fake_rpc_method'
op|'('
name|'context'
op|','
name|'topic'
op|','
name|'msg'
op|','
name|'do_cast'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'do_cast'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'rpc'
op|','
string|"'call'"
op|','
name|'fake_rpc_method'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'set_admin_password'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'inst_ref'
op|')'
newline|'\n'
nl|'\n'
name|'inst_ref'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'inst_ref'
op|'['
string|"'vm_state'"
op|']'
op|','
name|'vm_states'
op|'.'
name|'ACTIVE'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'inst_ref'
op|'['
string|"'task_state'"
op|']'
op|','
nl|'\n'
name|'task_states'
op|'.'
name|'UPDATING_PASSWORD'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'inst_ref'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rescue_unrescue
dedent|''
name|'def'
name|'test_rescue_unrescue'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|','
name|'vm_states'
op|'.'
name|'ACTIVE'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'rescue'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|','
name|'vm_states'
op|'.'
name|'ACTIVE'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|','
name|'task_states'
op|'.'
name|'RESCUING'
op|')'
newline|'\n'
nl|'\n'
name|'params'
op|'='
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'RESCUED'
op|','
string|"'task_state'"
op|':'
name|'None'
op|'}'
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|','
name|'params'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'unrescue'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|','
name|'vm_states'
op|'.'
name|'RESCUED'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|','
name|'task_states'
op|'.'
name|'UNRESCUING'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rescue_volume_backed
dedent|''
name|'def'
name|'test_rescue_volume_backed'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Instance started without an image'
nl|'\n'
indent|'        '
name|'volume_backed_inst_1'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'image_ref'"
op|':'
string|"''"
op|'}'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# Instance started with a placeholder image (for metadata)'
nl|'\n'
name|'volume_backed_inst_2'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
op|'{'
string|"'image_ref'"
op|':'
string|"'my_placeholder_img'"
op|','
nl|'\n'
string|"'root_device_name'"
op|':'
string|"'/dev/vda'"
op|'}'
op|')'
nl|'\n'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_get_instance_bdms
name|'def'
name|'fake_get_instance_bdms'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'['
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/vda'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'boot_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'volume_id'"
op|':'
string|"'bf0b6b00-a20c-11e2-9e96-0800200c9a66'"
op|'}'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|','
string|"'get_instance_bdms'"
op|','
nl|'\n'
name|'fake_get_instance_bdms'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_volume_get
name|'def'
name|'fake_volume_get'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'id'"
op|':'
name|'volume_id'
op|','
string|"'status'"
op|':'
string|"'in-use'"
op|'}'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'get'"
op|','
name|'fake_volume_get'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'volume_backed_inst_1'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'volume_backed_inst_2'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceNotRescuable'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'rescue'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'volume_backed_inst_1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceNotRescuable'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'rescue'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'volume_backed_inst_2'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'volume_backed_inst_1'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'volume_backed_inst_2'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get
dedent|''
name|'def'
name|'test_get'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test get instance.'
nl|'\n'
indent|'        '
name|'exp_instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
comment|'# NOTE(danms): Transform the db object in a similar way as'
nl|'\n'
comment|'# the API method will do.'
nl|'\n'
name|'expected'
op|'='
name|'obj_base'
op|'.'
name|'obj_to_primitive'
op|'('
nl|'\n'
name|'instance_obj'
op|'.'
name|'Instance'
op|'.'
name|'_from_db_object'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance_obj'
op|'.'
name|'Instance'
op|'('
op|')'
op|','
name|'exp_instance'
op|','
nl|'\n'
name|'instance_obj'
op|'.'
name|'INSTANCE_DEFAULT_FIELDS'
op|'+'
op|'['
string|"'fault'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_db_get
name|'def'
name|'fake_db_get'
op|'('
name|'_context'
op|','
name|'_instance_uuid'
op|','
nl|'\n'
name|'columns_to_join'
op|'='
name|'None'
op|','
name|'use_slave'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'exp_instance'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'instance_get_by_uuid'"
op|','
name|'fake_db_get'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'exp_instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'unify_instance'
op|'('
name|'expected'
op|')'
op|','
nl|'\n'
name|'unify_instance'
op|'('
name|'instance'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_with_admin_context
dedent|''
name|'def'
name|'test_get_with_admin_context'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test get instance.'
nl|'\n'
indent|'        '
name|'c'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'exp_instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
comment|'# NOTE(danms): Transform the db object in a similar way as'
nl|'\n'
comment|'# the API method will do.'
nl|'\n'
name|'expected'
op|'='
name|'obj_base'
op|'.'
name|'obj_to_primitive'
op|'('
nl|'\n'
name|'instance_obj'
op|'.'
name|'Instance'
op|'.'
name|'_from_db_object'
op|'('
nl|'\n'
name|'c'
op|','
name|'instance_obj'
op|'.'
name|'Instance'
op|'('
op|')'
op|','
name|'exp_instance'
op|','
nl|'\n'
name|'instance_obj'
op|'.'
name|'INSTANCE_DEFAULT_FIELDS'
op|'+'
op|'['
string|"'fault'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_db_get
name|'def'
name|'fake_db_get'
op|'('
name|'context'
op|','
name|'instance_uuid'
op|','
nl|'\n'
name|'columns_to_join'
op|'='
name|'None'
op|','
name|'use_slave'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'exp_instance'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'instance_get_by_uuid'"
op|','
name|'fake_db_get'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get'
op|'('
name|'c'
op|','
name|'exp_instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'unify_instance'
op|'('
name|'expected'
op|')'
op|','
nl|'\n'
name|'unify_instance'
op|'('
name|'instance'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_with_integer_id
dedent|''
name|'def'
name|'test_get_with_integer_id'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test get instance with an integer id.'
nl|'\n'
indent|'        '
name|'exp_instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
comment|'# NOTE(danms): Transform the db object in a similar way as'
nl|'\n'
comment|'# the API method will do.'
nl|'\n'
name|'expected'
op|'='
name|'obj_base'
op|'.'
name|'obj_to_primitive'
op|'('
nl|'\n'
name|'instance_obj'
op|'.'
name|'Instance'
op|'.'
name|'_from_db_object'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance_obj'
op|'.'
name|'Instance'
op|'('
op|')'
op|','
name|'exp_instance'
op|','
nl|'\n'
name|'instance_obj'
op|'.'
name|'INSTANCE_DEFAULT_FIELDS'
op|'+'
op|'['
string|"'fault'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_db_get
name|'def'
name|'fake_db_get'
op|'('
name|'_context'
op|','
name|'_instance_id'
op|','
name|'columns_to_join'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'exp_instance'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'instance_get'"
op|','
name|'fake_db_get'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'exp_instance'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'unify_instance'
op|'('
name|'expected'
op|')'
op|','
nl|'\n'
name|'unify_instance'
op|'('
name|'instance'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_all_by_name_regexp
dedent|''
name|'def'
name|'test_get_all_by_name_regexp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test searching instances by name (display_name).'
nl|'\n'
indent|'        '
name|'c'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'instance1'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'display_name'"
op|':'
string|"'woot'"
op|'}'
op|')'
newline|'\n'
name|'instance2'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
nl|'\n'
string|"'display_name'"
op|':'
string|"'woo'"
op|'}'
op|')'
newline|'\n'
name|'instance3'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
nl|'\n'
string|"'display_name'"
op|':'
string|"'not-woot'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'name'"
op|':'
string|"'^woo.*'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'instance_uuids'
op|'='
op|'['
name|'instance'
op|'['
string|"'uuid'"
op|']'
name|'for'
name|'instance'
name|'in'
name|'instances'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'instance1'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance_uuids'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'instance2'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance_uuids'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'name'"
op|':'
string|"'^woot.*'"
op|'}'
op|')'
newline|'\n'
name|'instance_uuids'
op|'='
op|'['
name|'instance'
op|'['
string|"'uuid'"
op|']'
name|'for'
name|'instance'
name|'in'
name|'instances'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'instance1'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance_uuids'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'name'"
op|':'
string|"'.*oot.*'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'instance_uuids'
op|'='
op|'['
name|'instance'
op|'['
string|"'uuid'"
op|']'
name|'for'
name|'instance'
name|'in'
name|'instances'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'instance1'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance_uuids'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'instance3'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance_uuids'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'name'"
op|':'
string|"'^n.*'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'instance_uuids'
op|'='
op|'['
name|'instance'
op|'['
string|"'uuid'"
op|']'
name|'for'
name|'instance'
name|'in'
name|'instances'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'instance3'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance_uuids'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'name'"
op|':'
string|"'noth.*'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance1'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance2'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance3'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_all_by_multiple_options_at_once
dedent|''
name|'def'
name|'test_get_all_by_multiple_options_at_once'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test searching by multiple options at once.'
nl|'\n'
indent|'        '
name|'c'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'network_manager'
op|'='
name|'fake_network'
op|'.'
name|'FakeNetworkManager'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'network_api'
op|','
nl|'\n'
string|"'get_instance_uuids_by_ip_filter'"
op|','
nl|'\n'
name|'network_manager'
op|'.'
name|'get_instance_uuids_by_ip_filter'
op|')'
newline|'\n'
nl|'\n'
name|'instance1'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
nl|'\n'
string|"'display_name'"
op|':'
string|"'woot'"
op|','
nl|'\n'
string|"'id'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'uuid'"
op|':'
string|"'00000000-0000-0000-0000-000000000010'"
op|'}'
op|')'
newline|'\n'
name|'instance2'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
nl|'\n'
string|"'display_name'"
op|':'
string|"'woo'"
op|','
nl|'\n'
string|"'id'"
op|':'
number|'20'
op|','
nl|'\n'
string|"'uuid'"
op|':'
string|"'00000000-0000-0000-0000-000000000020'"
op|'}'
op|')'
newline|'\n'
name|'instance3'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
nl|'\n'
string|"'display_name'"
op|':'
string|"'not-woot'"
op|','
nl|'\n'
string|"'id'"
op|':'
number|'30'
op|','
nl|'\n'
string|"'uuid'"
op|':'
string|"'00000000-0000-0000-0000-000000000030'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# ip ends up matching 2nd octet here.. so all 3 match ip'
nl|'\n'
comment|"# but 'name' only matches one"
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'ip'"
op|':'
string|"'.*\\.1'"
op|','
string|"'name'"
op|':'
string|"'not.*'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instances'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance3'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|"# ip ends up matching any ip with a '1' in the last octet.."
nl|'\n'
comment|'# so instance 1 and 3.. but name should only match #1'
nl|'\n'
comment|"# but 'name' only matches one"
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'ip'"
op|':'
string|"'.*\\.1$'"
op|','
string|"'name'"
op|':'
string|"'^woo.*'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instances'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance1'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# same as above but no match on name (name matches instance1'
nl|'\n'
comment|"# but the ip query doesn't"
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'ip'"
op|':'
string|"'.*\\.2$'"
op|','
string|"'name'"
op|':'
string|"'^woot.*'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# ip matches all 3... ipv6 matches #2+#3...name matches #3'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'ip'"
op|':'
string|"'.*\\.1'"
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'not.*'"
op|','
nl|'\n'
string|"'ip6'"
op|':'
string|"'^.*12.*34.*'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instances'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance3'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance1'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance2'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance3'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_all_by_image
dedent|''
name|'def'
name|'test_get_all_by_image'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test searching instances by image.'
nl|'\n'
nl|'\n'
indent|'        '
name|'c'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'instance1'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'image_ref'"
op|':'
string|"'1234'"
op|'}'
op|')'
newline|'\n'
name|'instance2'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'image_ref'"
op|':'
string|"'4567'"
op|'}'
op|')'
newline|'\n'
name|'instance3'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'image_ref'"
op|':'
string|"'4567'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
name|'search_opts'
op|'='
op|'{'
string|"'image'"
op|':'
string|"'123'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
name|'search_opts'
op|'='
op|'{'
string|"'image'"
op|':'
string|"'1234'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instances'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance1'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
name|'search_opts'
op|'='
op|'{'
string|"'image'"
op|':'
string|"'4567'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'instance_uuids'
op|'='
op|'['
name|'instance'
op|'['
string|"'uuid'"
op|']'
name|'for'
name|'instance'
name|'in'
name|'instances'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'instance2'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance_uuids'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'instance3'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance_uuids'
op|')'
newline|'\n'
nl|'\n'
comment|'# Test passing a list as search arg'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'image'"
op|':'
op|'['
string|"'1234'"
op|','
string|"'4567'"
op|']'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'3'
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance1'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance2'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance3'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_all_by_flavor
dedent|''
name|'def'
name|'test_get_all_by_flavor'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test searching instances by image.'
nl|'\n'
nl|'\n'
indent|'        '
name|'c'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'instance1'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'instance_type_id'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'instance2'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'instance_type_id'"
op|':'
number|'2'
op|'}'
op|')'
newline|'\n'
name|'instance3'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'instance_type_id'"
op|':'
number|'2'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# NOTE(comstud): Migrations set up the instance_types table'
nl|'\n'
comment|'# for us.  Therefore, we assume the following is true for'
nl|'\n'
comment|'# these tests:'
nl|'\n'
comment|'# instance_type_id 1 == flavor 3'
nl|'\n'
comment|'# instance_type_id 2 == flavor 1'
nl|'\n'
comment|'# instance_type_id 3 == flavor 4'
nl|'\n'
comment|'# instance_type_id 4 == flavor 5'
nl|'\n'
comment|'# instance_type_id 5 == flavor 2'
nl|'\n'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'flavor'"
op|':'
number|'5'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# ensure unknown filter maps to an exception'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'FlavorNotFound'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|','
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'flavor'"
op|':'
number|'99'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
name|'search_opts'
op|'='
op|'{'
string|"'flavor'"
op|':'
number|'3'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instances'
op|'['
number|'0'
op|']'
op|'['
string|"'id'"
op|']'
op|','
name|'instance1'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
name|'search_opts'
op|'='
op|'{'
string|"'flavor'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'instance_uuids'
op|'='
op|'['
name|'instance'
op|'['
string|"'uuid'"
op|']'
name|'for'
name|'instance'
name|'in'
name|'instances'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'instance2'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance_uuids'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'instance3'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance_uuids'
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance1'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance2'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance3'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_all_by_state
dedent|''
name|'def'
name|'test_get_all_by_state'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test searching instances by state.'
nl|'\n'
nl|'\n'
indent|'        '
name|'c'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'instance1'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
nl|'\n'
string|"'power_state'"
op|':'
name|'power_state'
op|'.'
name|'SHUTDOWN'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'instance2'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
nl|'\n'
string|"'power_state'"
op|':'
name|'power_state'
op|'.'
name|'RUNNING'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
name|'instance3'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
nl|'\n'
string|"'power_state'"
op|':'
name|'power_state'
op|'.'
name|'RUNNING'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'power_state'"
op|':'
name|'power_state'
op|'.'
name|'SUSPENDED'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'power_state'"
op|':'
name|'power_state'
op|'.'
name|'SHUTDOWN'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instances'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance1'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'power_state'"
op|':'
name|'power_state'
op|'.'
name|'RUNNING'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'instance_uuids'
op|'='
op|'['
name|'instance'
op|'['
string|"'uuid'"
op|']'
name|'for'
name|'instance'
name|'in'
name|'instances'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'instance2'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance_uuids'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'instance3'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance_uuids'
op|')'
newline|'\n'
nl|'\n'
comment|'# Test passing a list as search arg'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'power_state'"
op|':'
op|'['
name|'power_state'
op|'.'
name|'SHUTDOWN'
op|','
nl|'\n'
name|'power_state'
op|'.'
name|'RUNNING'
op|']'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'3'
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance1'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance2'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance3'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_all_by_metadata
dedent|''
name|'def'
name|'test_get_all_by_metadata'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test searching instances by metadata.'
nl|'\n'
nl|'\n'
indent|'        '
name|'c'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'instance0'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'instance1'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
nl|'\n'
string|"'metadata'"
op|':'
op|'{'
string|"'key1'"
op|':'
string|"'value1'"
op|'}'
op|'}'
op|')'
newline|'\n'
name|'instance2'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
nl|'\n'
string|"'metadata'"
op|':'
op|'{'
string|"'key2'"
op|':'
string|"'value2'"
op|'}'
op|'}'
op|')'
newline|'\n'
name|'instance3'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
nl|'\n'
string|"'metadata'"
op|':'
op|'{'
string|"'key3'"
op|':'
string|"'value3'"
op|'}'
op|'}'
op|')'
newline|'\n'
name|'instance4'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
nl|'\n'
string|"'metadata'"
op|':'
op|'{'
string|"'key3'"
op|':'
string|"'value3'"
op|','
nl|'\n'
string|"'key4'"
op|':'
string|"'value4'"
op|'}'
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# get all instances'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'metadata'"
op|':'
op|'{'
op|'}'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'5'
op|')'
newline|'\n'
nl|'\n'
comment|'# wrong key/value combination'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'metadata'"
op|':'
op|'{'
string|"'key1'"
op|':'
string|"'value3'"
op|'}'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# non-existing keys'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'metadata'"
op|':'
op|'{'
string|"'key5'"
op|':'
string|"'value1'"
op|'}'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
comment|'# find existing instance'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'metadata'"
op|':'
op|'{'
string|"'key2'"
op|':'
string|"'value2'"
op|'}'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instances'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance2'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'metadata'"
op|':'
op|'{'
string|"'key3'"
op|':'
string|"'value3'"
op|'}'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'instance_uuids'
op|'='
op|'['
name|'instance'
op|'['
string|"'uuid'"
op|']'
name|'for'
name|'instance'
name|'in'
name|'instances'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'instance3'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance_uuids'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'instance4'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance_uuids'
op|')'
newline|'\n'
nl|'\n'
comment|'# multiple criteria as a dict'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'metadata'"
op|':'
op|'{'
string|"'key3'"
op|':'
string|"'value3'"
op|','
nl|'\n'
string|"'key4'"
op|':'
string|"'value4'"
op|'}'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instances'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance4'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# multiple criteria as a list'
nl|'\n'
name|'instances'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|'('
name|'c'
op|','
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'metadata'"
op|':'
op|'['
op|'{'
string|"'key4'"
op|':'
string|"'value4'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'key3'"
op|':'
string|"'value3'"
op|'}'
op|']'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'instances'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instances'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|','
name|'instance4'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance0'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance1'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance2'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance3'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'c'
op|','
name|'instance4'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_all_instance_metadata
dedent|''
name|'def'
name|'test_all_instance_metadata'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance1'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'metadata'"
op|':'
op|'{'
string|"'key1'"
op|':'
string|"'value1'"
op|'}'
op|','
nl|'\n'
string|"'user_id'"
op|':'
string|"'user1'"
op|','
nl|'\n'
string|"'project_id'"
op|':'
string|"'project1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'instance2'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'metadata'"
op|':'
op|'{'
string|"'key2'"
op|':'
string|"'value2'"
op|'}'
op|','
nl|'\n'
string|"'user_id'"
op|':'
string|"'user2'"
op|','
nl|'\n'
string|"'project_id'"
op|':'
string|"'project2'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'_context'
op|'='
name|'self'
op|'.'
name|'context'
newline|'\n'
name|'_context'
op|'.'
name|'user_id'
op|'='
string|"'user1'"
newline|'\n'
name|'_context'
op|'.'
name|'project_id'
op|'='
string|"'project1'"
newline|'\n'
name|'metadata'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all_instance_metadata'
op|'('
name|'_context'
op|','
nl|'\n'
name|'search_filts'
op|'='
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'len'
op|'('
name|'metadata'
op|')'
op|'=='
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'metadata'
op|'['
number|'0'
op|']'
op|'['
string|"'key'"
op|']'
op|','
string|"'key1'"
op|')'
newline|'\n'
nl|'\n'
name|'_context'
op|'.'
name|'user_id'
op|'='
string|"'user2'"
newline|'\n'
name|'_context'
op|'.'
name|'project_id'
op|'='
string|"'project2'"
newline|'\n'
name|'metadata'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all_instance_metadata'
op|'('
name|'_context'
op|','
nl|'\n'
name|'search_filts'
op|'='
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'len'
op|'('
name|'metadata'
op|')'
op|'=='
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'metadata'
op|'['
number|'0'
op|']'
op|'['
string|"'key'"
op|']'
op|','
string|"'key2'"
op|')'
newline|'\n'
nl|'\n'
name|'_context'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'metadata'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all_instance_metadata'
op|'('
name|'_context'
op|','
nl|'\n'
name|'search_filts'
op|'='
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'len'
op|'('
name|'metadata'
op|')'
op|'=='
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_instance_metadata
dedent|''
name|'def'
name|'test_instance_metadata'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'meta_changes'
op|'='
op|'['
name|'None'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'notify_on_state_change'
op|'='
string|"'vm_state'"
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_change_instance_metadata
name|'def'
name|'fake_change_instance_metadata'
op|'('
name|'inst'
op|','
name|'ctxt'
op|','
name|'diff'
op|','
name|'instance'
op|'='
name|'None'
op|','
nl|'\n'
name|'instance_uuid'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'meta_changes'
op|'['
number|'0'
op|']'
op|'='
name|'diff'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'compute_rpcapi'
op|'.'
name|'ComputeAPI'
op|','
string|"'change_instance_metadata'"
op|','
nl|'\n'
name|'fake_change_instance_metadata'
op|')'
newline|'\n'
nl|'\n'
name|'_context'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'metadata'"
op|':'
op|'{'
string|"'key1'"
op|':'
string|"'value1'"
op|'}'
op|'}'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'dict'
op|'('
name|'instance'
op|'.'
name|'iteritems'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'metadata'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_instance_metadata'
op|'('
name|'_context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'metadata'
op|','
op|'{'
string|"'key1'"
op|':'
string|"'value1'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'update_instance_metadata'
op|'('
name|'_context'
op|','
name|'instance'
op|','
nl|'\n'
op|'{'
string|"'key2'"
op|':'
string|"'value2'"
op|'}'
op|')'
newline|'\n'
name|'metadata'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_instance_metadata'
op|'('
name|'_context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'metadata'
op|','
op|'{'
string|"'key1'"
op|':'
string|"'value1'"
op|','
string|"'key2'"
op|':'
string|"'value2'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'meta_changes'
op|','
op|'['
op|'{'
string|"'key2'"
op|':'
op|'['
string|"'+'"
op|','
string|"'value2'"
op|']'
op|'}'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'payload'
op|'='
name|'msg'
op|'.'
name|'payload'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'metadata'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'metadata'"
op|']'
op|','
name|'metadata'
op|')'
newline|'\n'
nl|'\n'
name|'new_metadata'
op|'='
op|'{'
string|"'key2'"
op|':'
string|"'bah'"
op|','
string|"'key3'"
op|':'
string|"'value3'"
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'update_instance_metadata'
op|'('
name|'_context'
op|','
name|'instance'
op|','
nl|'\n'
name|'new_metadata'
op|','
name|'delete'
op|'='
name|'True'
op|')'
newline|'\n'
name|'metadata'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_instance_metadata'
op|'('
name|'_context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'metadata'
op|','
name|'new_metadata'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'meta_changes'
op|','
op|'['
op|'{'
nl|'\n'
string|"'key1'"
op|':'
op|'['
string|"'-'"
op|']'
op|','
nl|'\n'
string|"'key2'"
op|':'
op|'['
string|"'+'"
op|','
string|"'bah'"
op|']'
op|','
nl|'\n'
string|"'key3'"
op|':'
op|'['
string|"'+'"
op|','
string|"'value3'"
op|']'
op|','
nl|'\n'
op|'}'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'payload'
op|'='
name|'msg'
op|'.'
name|'payload'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'metadata'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'metadata'"
op|']'
op|','
name|'metadata'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'delete_instance_metadata'
op|'('
name|'_context'
op|','
name|'instance'
op|','
string|"'key2'"
op|')'
newline|'\n'
name|'metadata'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_instance_metadata'
op|'('
name|'_context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'metadata'
op|','
op|'{'
string|"'key3'"
op|':'
string|"'value3'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'meta_changes'
op|','
op|'['
op|'{'
string|"'key2'"
op|':'
op|'['
string|"'-'"
op|']'
op|'}'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'3'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'2'
op|']'
newline|'\n'
name|'payload'
op|'='
name|'msg'
op|'.'
name|'payload'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'metadata'"
op|','
name|'payload'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'payload'
op|'['
string|"'metadata'"
op|']'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'_context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_disallow_metadata_changes_during_building
dedent|''
name|'def'
name|'test_disallow_metadata_changes_during_building'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|fake_change_instance_metadata
indent|'        '
name|'def'
name|'fake_change_instance_metadata'
op|'('
name|'inst'
op|','
name|'ctxt'
op|','
name|'diff'
op|','
name|'instance'
op|'='
name|'None'
op|','
nl|'\n'
name|'instance_uuid'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'compute_rpcapi'
op|'.'
name|'ComputeAPI'
op|','
string|"'change_instance_metadata'"
op|','
nl|'\n'
name|'fake_change_instance_metadata'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'BUILDING'
op|'}'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'dict'
op|'('
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceInvalidState'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'delete_instance_metadata'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
string|'"key"'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceInvalidState'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'update_instance_metadata'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
string|'"key"'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_instance_faults
dedent|''
name|'def'
name|'test_get_instance_faults'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Get an instances latest fault.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'fault_fixture'
op|'='
op|'{'
nl|'\n'
string|"'code'"
op|':'
number|'404'
op|','
nl|'\n'
string|"'instance_uuid'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
string|"'message'"
op|':'
string|'"HTTPNotFound"'
op|','
nl|'\n'
string|"'details'"
op|':'
string|'"Stock details for test"'
op|','
nl|'\n'
string|"'created_at'"
op|':'
name|'datetime'
op|'.'
name|'datetime'
op|'('
number|'2010'
op|','
number|'10'
op|','
number|'10'
op|','
number|'12'
op|','
number|'0'
op|','
number|'0'
op|')'
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|return_fault
name|'def'
name|'return_fault'
op|'('
name|'_ctxt'
op|','
name|'instance_uuids'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'dict'
op|'.'
name|'fromkeys'
op|'('
name|'instance_uuids'
op|','
op|'['
name|'fault_fixture'
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'nova'
op|'.'
name|'db'
op|','
nl|'\n'
string|"'instance_fault_get_by_instance_uuids'"
op|','
nl|'\n'
name|'return_fault'
op|')'
newline|'\n'
nl|'\n'
name|'_context'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'output'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_instance_faults'
op|'('
name|'_context'
op|','
op|'['
name|'instance'
op|']'
op|')'
newline|'\n'
name|'expected'
op|'='
op|'{'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|':'
op|'['
name|'fault_fixture'
op|']'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'output'
op|','
name|'expected'
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'_context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'staticmethod'
newline|'\n'
DECL|member|_parse_db_block_device_mapping
name|'def'
name|'_parse_db_block_device_mapping'
op|'('
name|'bdm_ref'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'attr_list'
op|'='
op|'('
string|"'delete_on_termination'"
op|','
string|"'device_name'"
op|','
string|"'no_device'"
op|','
nl|'\n'
string|"'virtual_name'"
op|','
string|"'volume_id'"
op|','
string|"'volume_size'"
op|','
string|"'snapshot_id'"
op|')'
newline|'\n'
name|'bdm'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'attr'
name|'in'
name|'attr_list'
op|':'
newline|'\n'
indent|'            '
name|'val'
op|'='
name|'bdm_ref'
op|'.'
name|'get'
op|'('
name|'attr'
op|','
name|'None'
op|')'
newline|'\n'
name|'if'
name|'val'
op|':'
newline|'\n'
indent|'                '
name|'bdm'
op|'['
name|'attr'
op|']'
op|'='
name|'val'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'return'
name|'bdm'
newline|'\n'
nl|'\n'
DECL|member|test_update_block_device_mapping
dedent|''
name|'def'
name|'test_update_block_device_mapping'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'swap_size'
op|'='
name|'ephemeral_size'
op|'='
number|'1'
newline|'\n'
name|'instance_type'
op|'='
op|'{'
string|"'swap'"
op|':'
name|'swap_size'
op|','
string|"'ephemeral_gb'"
op|':'
name|'ephemeral_size'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'mappings'
op|'='
op|'['
nl|'\n'
op|'{'
string|"'virtual'"
op|':'
string|"'ami'"
op|','
string|"'device'"
op|':'
string|"'sda1'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'virtual'"
op|':'
string|"'root'"
op|','
string|"'device'"
op|':'
string|"'/dev/sda1'"
op|'}'
op|','
nl|'\n'
nl|'\n'
op|'{'
string|"'virtual'"
op|':'
string|"'swap'"
op|','
string|"'device'"
op|':'
string|"'sdb4'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'virtual'"
op|':'
string|"'swap'"
op|','
string|"'device'"
op|':'
string|"'sdb3'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'virtual'"
op|':'
string|"'swap'"
op|','
string|"'device'"
op|':'
string|"'sdb2'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'virtual'"
op|':'
string|"'swap'"
op|','
string|"'device'"
op|':'
string|"'sdb1'"
op|'}'
op|','
nl|'\n'
nl|'\n'
op|'{'
string|"'virtual'"
op|':'
string|"'ephemeral0'"
op|','
string|"'device'"
op|':'
string|"'sdc1'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'virtual'"
op|':'
string|"'ephemeral1'"
op|','
string|"'device'"
op|':'
string|"'sdc2'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'virtual'"
op|':'
string|"'ephemeral2'"
op|','
string|"'device'"
op|':'
string|"'sdc3'"
op|'}'
op|']'
newline|'\n'
name|'block_device_mapping'
op|'='
op|'['
nl|'\n'
comment|'# root'
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sda1'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'00000000-aaaa-bbbb-cccc-000000000000'"
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|'}'
op|','
nl|'\n'
nl|'\n'
comment|'# overwrite swap'
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdb2'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'11111111-aaaa-bbbb-cccc-111111111111'"
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdb3'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'22222222-aaaa-bbbb-cccc-222222222222'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdb4'"
op|','
nl|'\n'
string|"'no_device'"
op|':'
name|'True'
op|'}'
op|','
nl|'\n'
nl|'\n'
comment|'# overwrite ephemeral'
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdc1'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'33333333-aaaa-bbbb-cccc-333333333333'"
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdc2'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'33333333-aaaa-bbbb-cccc-444444444444'"
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdc3'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'44444444-aaaa-bbbb-cccc-555555555555'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdc4'"
op|','
nl|'\n'
string|"'no_device'"
op|':'
name|'True'
op|'}'
op|','
nl|'\n'
nl|'\n'
comment|'# volume'
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdd1'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'55555555-aaaa-bbbb-cccc-666666666666'"
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdd2'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'66666666-aaaa-bbbb-cccc-777777777777'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdd3'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'77777777-aaaa-bbbb-cccc-888888888888'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdd4'"
op|','
nl|'\n'
string|"'no_device'"
op|':'
name|'True'
op|'}'
op|']'
newline|'\n'
nl|'\n'
name|'image_mapping'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_prepare_image_mapping'
op|'('
nl|'\n'
name|'instance_type'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'mappings'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_update_block_device_mapping'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance_type'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'image_mapping'
op|')'
newline|'\n'
nl|'\n'
name|'bdms'
op|'='
op|'['
name|'block_device'
op|'.'
name|'BlockDeviceDict'
op|'('
name|'bdm'
op|')'
name|'for'
name|'bdm'
name|'in'
nl|'\n'
name|'db'
op|'.'
name|'block_device_mapping_get_all_by_instance'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
op|']'
newline|'\n'
name|'expected_result'
op|'='
op|'['
nl|'\n'
op|'{'
string|"'source_type'"
op|':'
string|"'blank'"
op|','
string|"'destination_type'"
op|':'
string|"'local'"
op|','
nl|'\n'
string|"'guest_format'"
op|':'
string|"'swap'"
op|','
string|"'device_name'"
op|':'
string|"'/dev/sdb1'"
op|','
nl|'\n'
string|"'volume_size'"
op|':'
name|'swap_size'
op|','
string|"'delete_on_termination'"
op|':'
name|'True'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'source_type'"
op|':'
string|"'blank'"
op|','
string|"'destination_type'"
op|':'
string|"'local'"
op|','
nl|'\n'
string|"'guest_format'"
op|':'
name|'CONF'
op|'.'
name|'default_ephemeral_format'
op|','
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/sdc3'"
op|','
string|"'delete_on_termination'"
op|':'
name|'True'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'source_type'"
op|':'
string|"'blank'"
op|','
string|"'destination_type'"
op|':'
string|"'local'"
op|','
nl|'\n'
string|"'guest_format'"
op|':'
name|'CONF'
op|'.'
name|'default_ephemeral_format'
op|','
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/sdc1'"
op|','
string|"'delete_on_termination'"
op|':'
name|'True'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'source_type'"
op|':'
string|"'blank'"
op|','
string|"'destination_type'"
op|':'
string|"'local'"
op|','
nl|'\n'
string|"'guest_format'"
op|':'
name|'CONF'
op|'.'
name|'default_ephemeral_format'
op|','
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/sdc2'"
op|','
string|"'delete_on_termination'"
op|':'
name|'True'
op|'}'
op|','
nl|'\n'
op|']'
newline|'\n'
name|'bdms'
op|'.'
name|'sort'
op|'('
name|'key'
op|'='
name|'operator'
op|'.'
name|'itemgetter'
op|'('
string|"'device_name'"
op|')'
op|')'
newline|'\n'
name|'expected_result'
op|'.'
name|'sort'
op|'('
name|'key'
op|'='
name|'operator'
op|'.'
name|'itemgetter'
op|'('
string|"'device_name'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'bdms'
op|')'
op|','
name|'len'
op|'('
name|'expected_result'
op|')'
op|')'
newline|'\n'
name|'for'
name|'expected'
op|','
name|'got'
name|'in'
name|'zip'
op|'('
name|'expected_result'
op|','
name|'bdms'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertThat'
op|'('
name|'expected'
op|','
name|'matchers'
op|'.'
name|'IsSubDictOf'
op|'('
name|'got'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_update_block_device_mapping'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'block_device_mapping'
op|')'
newline|'\n'
name|'bdms'
op|'='
op|'['
name|'block_device'
op|'.'
name|'BlockDeviceDict'
op|'('
name|'bdm'
op|')'
name|'for'
name|'bdm'
name|'in'
nl|'\n'
name|'db'
op|'.'
name|'block_device_mapping_get_all_by_instance'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
op|']'
newline|'\n'
name|'expected_result'
op|'='
op|'['
nl|'\n'
op|'{'
string|"'snapshot_id'"
op|':'
string|"'00000000-aaaa-bbbb-cccc-000000000000'"
op|','
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/sda1'"
op|'}'
op|','
nl|'\n'
nl|'\n'
op|'{'
string|"'source_type'"
op|':'
string|"'blank'"
op|','
string|"'destination_type'"
op|':'
string|"'local'"
op|','
nl|'\n'
string|"'guest_format'"
op|':'
string|"'swap'"
op|','
string|"'device_name'"
op|':'
string|"'/dev/sdb1'"
op|','
nl|'\n'
string|"'volume_size'"
op|':'
name|'swap_size'
op|','
string|"'delete_on_termination'"
op|':'
name|'True'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdb2'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'11111111-aaaa-bbbb-cccc-111111111111'"
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdb3'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'22222222-aaaa-bbbb-cccc-222222222222'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdb4'"
op|','
string|"'no_device'"
op|':'
name|'True'
op|'}'
op|','
nl|'\n'
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdc1'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'33333333-aaaa-bbbb-cccc-333333333333'"
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdc2'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'33333333-aaaa-bbbb-cccc-444444444444'"
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdc3'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'44444444-aaaa-bbbb-cccc-555555555555'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'no_device'"
op|':'
name|'True'
op|','
string|"'device_name'"
op|':'
string|"'/dev/sdc4'"
op|'}'
op|','
nl|'\n'
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdd1'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'55555555-aaaa-bbbb-cccc-666666666666'"
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdd2'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'66666666-aaaa-bbbb-cccc-777777777777'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/sdd3'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'snapshot'"
op|','
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'77777777-aaaa-bbbb-cccc-888888888888'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'no_device'"
op|':'
name|'True'
op|','
string|"'device_name'"
op|':'
string|"'/dev/sdd4'"
op|'}'
op|']'
newline|'\n'
name|'bdms'
op|'.'
name|'sort'
op|'('
name|'key'
op|'='
name|'operator'
op|'.'
name|'itemgetter'
op|'('
string|"'device_name'"
op|')'
op|')'
newline|'\n'
name|'expected_result'
op|'.'
name|'sort'
op|'('
name|'key'
op|'='
name|'operator'
op|'.'
name|'itemgetter'
op|'('
string|"'device_name'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'bdms'
op|')'
op|','
name|'len'
op|'('
name|'expected_result'
op|')'
op|')'
newline|'\n'
name|'for'
name|'expected'
op|','
name|'got'
name|'in'
name|'zip'
op|'('
name|'expected_result'
op|','
name|'bdms'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertThat'
op|'('
name|'expected'
op|','
name|'matchers'
op|'.'
name|'IsSubDictOf'
op|'('
name|'got'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'for'
name|'bdm'
name|'in'
name|'db'
op|'.'
name|'block_device_mapping_get_all_by_instance'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'block_device_mapping_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'bdm'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_check_and_transform_bdm
dedent|''
name|'def'
name|'test_check_and_transform_bdm'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'base_options'
op|'='
op|'{'
string|"'root_device_name'"
op|':'
string|"'vdb'"
op|','
nl|'\n'
string|"'image_ref'"
op|':'
name|'FAKE_IMAGE_REF'
op|'}'
newline|'\n'
name|'fake_legacy_bdms'
op|'='
op|'['
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/vda'"
op|','
nl|'\n'
string|"'volume_id'"
op|':'
string|"'33333333-aaaa-bbbb-cccc-333333333333'"
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|'}'
op|']'
newline|'\n'
nl|'\n'
name|'image_meta'
op|'='
op|'{'
string|"'properties'"
op|':'
op|'{'
string|"'block_device_mapping'"
op|':'
op|'['
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/vda'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'33333333-aaaa-bbbb-cccc-333333333333'"
op|'}'
op|']'
op|'}'
op|'}'
newline|'\n'
nl|'\n'
comment|'# We get an image BDM'
nl|'\n'
name|'transformed_bdm'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_and_transform_bdm'
op|'('
nl|'\n'
name|'base_options'
op|','
op|'{'
op|'}'
op|','
number|'1'
op|','
number|'1'
op|','
name|'fake_legacy_bdms'
op|','
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'transformed_bdm'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
comment|'# No image BDM created if image already defines a root BDM'
nl|'\n'
name|'base_options'
op|'['
string|"'root_device_name'"
op|']'
op|'='
string|"'vda'"
newline|'\n'
name|'transformed_bdm'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_and_transform_bdm'
op|'('
nl|'\n'
name|'base_options'
op|','
name|'image_meta'
op|','
number|'1'
op|','
number|'1'
op|','
op|'['
op|']'
op|','
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'transformed_bdm'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
comment|'# No image BDM created'
nl|'\n'
name|'transformed_bdm'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_and_transform_bdm'
op|'('
nl|'\n'
name|'base_options'
op|','
op|'{'
op|'}'
op|','
number|'1'
op|','
number|'1'
op|','
name|'fake_legacy_bdms'
op|','
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'transformed_bdm'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
comment|'# Volumes with multiple instances fails'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InvalidRequest'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_and_transform_bdm'
op|','
nl|'\n'
name|'base_options'
op|','
op|'{'
op|'}'
op|','
number|'1'
op|','
number|'2'
op|','
name|'fake_legacy_bdms'
op|','
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'checked_bdm'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_and_transform_bdm'
op|'('
nl|'\n'
name|'base_options'
op|','
op|'{'
op|'}'
op|','
number|'1'
op|','
number|'1'
op|','
name|'transformed_bdm'
op|','
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'checked_bdm'
op|','
name|'transformed_bdm'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_volume_size
dedent|''
name|'def'
name|'test_volume_size'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ephemeral_size'
op|'='
number|'2'
newline|'\n'
name|'swap_size'
op|'='
number|'3'
newline|'\n'
name|'volume_size'
op|'='
number|'5'
newline|'\n'
nl|'\n'
name|'swap_bdm'
op|'='
op|'{'
string|"'source_type'"
op|':'
string|"'blank'"
op|','
string|"'guest_format'"
op|':'
string|"'swap'"
op|'}'
newline|'\n'
name|'ephemeral_bdm'
op|'='
op|'{'
string|"'source_type'"
op|':'
string|"'blank'"
op|','
string|"'guest_format'"
op|':'
name|'None'
op|'}'
newline|'\n'
name|'volume_bdm'
op|'='
op|'{'
string|"'source_type'"
op|':'
string|"'volume'"
op|','
string|"'volume_size'"
op|':'
name|'volume_size'
op|'}'
newline|'\n'
nl|'\n'
name|'inst_type'
op|'='
op|'{'
string|"'ephemeral_gb'"
op|':'
name|'ephemeral_size'
op|','
string|"'swap'"
op|':'
name|'swap_size'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_volume_size'
op|'('
name|'inst_type'
op|','
name|'ephemeral_bdm'
op|')'
op|','
nl|'\n'
name|'ephemeral_size'
op|')'
newline|'\n'
name|'ephemeral_bdm'
op|'['
string|"'volume_size'"
op|']'
op|'='
number|'42'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_volume_size'
op|'('
name|'inst_type'
op|','
name|'ephemeral_bdm'
op|')'
op|','
number|'42'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_volume_size'
op|'('
name|'inst_type'
op|','
name|'swap_bdm'
op|')'
op|','
nl|'\n'
name|'swap_size'
op|')'
newline|'\n'
name|'swap_bdm'
op|'['
string|"'volume_size'"
op|']'
op|'='
number|'42'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_volume_size'
op|'('
name|'inst_type'
op|','
name|'swap_bdm'
op|')'
op|','
number|'42'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_volume_size'
op|'('
name|'inst_type'
op|','
name|'volume_bdm'
op|')'
op|','
nl|'\n'
name|'volume_size'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_is_volume_backed_instance
dedent|''
name|'def'
name|'test_is_volume_backed_instance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ctxt'
op|'='
name|'self'
op|'.'
name|'context'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'image_ref'"
op|':'
string|"''"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'is_volume_backed_instance'
op|'('
name|'ctxt'
op|','
name|'instance'
op|','
name|'None'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|'{'
string|"'root_device_name'"
op|':'
string|"'vda'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'is_volume_backed_instance'
op|'('
name|'ctxt'
op|','
name|'instance'
op|','
op|'['
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'bdms'
op|'='
op|'['
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/vda'"
op|','
nl|'\n'
string|"'volume_id'"
op|':'
string|"'fake_volume_id'"
op|','
nl|'\n'
string|"'boot_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'volume'"
op|'}'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'is_volume_backed_instance'
op|'('
name|'ctxt'
op|','
name|'instance'
op|','
name|'bdms'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'bdms'
op|'='
op|'['
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/vda'"
op|','
nl|'\n'
string|"'volume_id'"
op|':'
string|"'fake_volume_id'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'local'"
op|','
nl|'\n'
string|"'boot_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
name|'None'
op|'}'
op|','
nl|'\n'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/vdb'"
op|','
nl|'\n'
string|"'boot_index'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'volume_id'"
op|':'
string|"'c2ec2156-d75e-11e2-985b-5254009297d6'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
name|'None'
op|'}'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'is_volume_backed_instance'
op|'('
name|'ctxt'
op|','
name|'instance'
op|','
name|'bdms'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'bdms'
op|'='
op|'['
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/vda'"
op|','
nl|'\n'
string|"'snapshot_id'"
op|':'
string|"'de8836ac-d75e-11e2-8271-5254009297d6'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'boot_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'volume_id'"
op|':'
name|'None'
op|'}'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'is_volume_backed_instance'
op|'('
name|'ctxt'
op|','
name|'instance'
op|','
name|'bdms'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_is_volume_backed_instance_no_bdms
dedent|''
name|'def'
name|'test_is_volume_backed_instance_no_bdms'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ctxt'
op|'='
name|'self'
op|'.'
name|'context'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|','
string|"'get_instance_bdms'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_instance_bdms'
op|'('
name|'ctxt'
op|','
name|'instance'
op|','
nl|'\n'
name|'legacy'
op|'='
name|'False'
op|')'
op|'.'
name|'AndReturn'
op|'('
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'is_volume_backed_instance'
op|'('
name|'ctxt'
op|','
name|'instance'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reservation_id_one_instance
dedent|''
name|'def'
name|'test_reservation_id_one_instance'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Verify building an instance has a reservation_id that\n        matches return value from create.\n        """'
newline|'\n'
op|'('
name|'refs'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
op|','
name|'image_href'
op|'='
string|"'some-fake-image'"
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'refs'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'refs'
op|'['
number|'0'
op|']'
op|'['
string|"'reservation_id'"
op|']'
op|','
name|'resv_id'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'refs'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reservation_ids_two_instances
dedent|''
dedent|''
name|'def'
name|'test_reservation_ids_two_instances'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Verify building 2 instances at once results in a\n        reservation_id being returned equal to reservation id set\n        in both instances.\n        """'
newline|'\n'
op|'('
name|'refs'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
op|','
name|'image_href'
op|'='
string|"'some-fake-image'"
op|','
nl|'\n'
name|'min_count'
op|'='
number|'2'
op|','
name|'max_count'
op|'='
number|'2'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'refs'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNotNone'
op|'('
name|'resv_id'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'instance'
name|'in'
name|'refs'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'reservation_id'"
op|']'
op|','
name|'resv_id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'refs'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_multi_instance_display_name_template
dedent|''
name|'def'
name|'test_multi_instance_display_name_template'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'multi_instance_display_name_template'
op|'='
string|"'%(name)s'"
op|')'
newline|'\n'
op|'('
name|'refs'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
op|','
name|'image_href'
op|'='
string|"'some-fake-image'"
op|','
nl|'\n'
name|'min_count'
op|'='
number|'2'
op|','
name|'max_count'
op|'='
number|'2'
op|','
name|'display_name'
op|'='
string|"'x'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'refs'
op|'['
number|'0'
op|']'
op|'['
string|"'display_name'"
op|']'
op|','
string|"'x'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'refs'
op|'['
number|'0'
op|']'
op|'['
string|"'hostname'"
op|']'
op|','
string|"'x'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'refs'
op|'['
number|'1'
op|']'
op|'['
string|"'display_name'"
op|']'
op|','
string|"'x'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'refs'
op|'['
number|'1'
op|']'
op|'['
string|"'hostname'"
op|']'
op|','
string|"'x'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'multi_instance_display_name_template'
op|'='
string|"'%(name)s-%(count)s'"
op|')'
newline|'\n'
op|'('
name|'refs'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
op|','
name|'image_href'
op|'='
string|"'some-fake-image'"
op|','
nl|'\n'
name|'min_count'
op|'='
number|'2'
op|','
name|'max_count'
op|'='
number|'2'
op|','
name|'display_name'
op|'='
string|"'x'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'refs'
op|'['
number|'0'
op|']'
op|'['
string|"'display_name'"
op|']'
op|','
string|"'x-1'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'refs'
op|'['
number|'0'
op|']'
op|'['
string|"'hostname'"
op|']'
op|','
string|"'x-1'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'refs'
op|'['
number|'1'
op|']'
op|'['
string|"'display_name'"
op|']'
op|','
string|"'x-2'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'refs'
op|'['
number|'1'
op|']'
op|'['
string|"'hostname'"
op|']'
op|','
string|"'x-2'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'multi_instance_display_name_template'
op|'='
string|"'%(name)s-%(uuid)s'"
op|')'
newline|'\n'
op|'('
name|'refs'
op|','
name|'resv_id'
op|')'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
op|','
name|'image_href'
op|'='
string|"'some-fake-image'"
op|','
nl|'\n'
name|'min_count'
op|'='
number|'2'
op|','
name|'max_count'
op|'='
number|'2'
op|','
name|'display_name'
op|'='
string|"'x'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'refs'
op|'['
number|'0'
op|']'
op|'['
string|"'display_name'"
op|']'
op|','
string|"'x-%s'"
op|'%'
name|'refs'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'refs'
op|'['
number|'0'
op|']'
op|'['
string|"'hostname'"
op|']'
op|','
string|"'x-%s'"
op|'%'
name|'refs'
op|'['
number|'0'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'refs'
op|'['
number|'1'
op|']'
op|'['
string|"'display_name'"
op|']'
op|','
string|"'x-%s'"
op|'%'
name|'refs'
op|'['
number|'1'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'refs'
op|'['
number|'1'
op|']'
op|'['
string|"'hostname'"
op|']'
op|','
string|"'x-%s'"
op|'%'
name|'refs'
op|'['
number|'1'
op|']'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_instance_architecture
dedent|''
name|'def'
name|'test_instance_architecture'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test the instance architecture.'
nl|'\n'
indent|'        '
name|'i_ref'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'i_ref'
op|'['
string|"'architecture'"
op|']'
op|','
string|"'x86_64'"
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'i_ref'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_instance_unknown_architecture
dedent|''
name|'def'
name|'test_instance_unknown_architecture'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test if the architecture is unknown.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
name|'params'
op|'='
op|'{'
string|"'architecture'"
op|':'
string|"''"
op|'}'
op|')'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertNotEqual'
op|'('
name|'instance'
op|'['
string|"'architecture'"
op|']'
op|','
string|"'Unknown'"
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_instance_name_template
dedent|''
dedent|''
name|'def'
name|'test_instance_name_template'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test the instance_name template.'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'flags'
op|'('
name|'instance_name_template'
op|'='
string|"'instance-%d'"
op|')'
newline|'\n'
name|'i_ref'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'i_ref'
op|'['
string|"'name'"
op|']'
op|','
string|"'instance-%d'"
op|'%'
name|'i_ref'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'i_ref'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'instance_name_template'
op|'='
string|"'instance-%(uuid)s'"
op|')'
newline|'\n'
name|'i_ref'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'i_ref'
op|'['
string|"'name'"
op|']'
op|','
string|"'instance-%s'"
op|'%'
name|'i_ref'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'i_ref'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'instance_name_template'
op|'='
string|"'%(id)d-%(uuid)s'"
op|')'
newline|'\n'
name|'i_ref'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'i_ref'
op|'['
string|"'name'"
op|']'
op|','
string|"'%d-%s'"
op|'%'
nl|'\n'
op|'('
name|'i_ref'
op|'['
string|"'id'"
op|']'
op|','
name|'i_ref'
op|'['
string|"'uuid'"
op|']'
op|')'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'i_ref'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# not allowed.. default is uuid'
nl|'\n'
name|'self'
op|'.'
name|'flags'
op|'('
name|'instance_name_template'
op|'='
string|"'%(name)s'"
op|')'
newline|'\n'
name|'i_ref'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'i_ref'
op|'['
string|"'name'"
op|']'
op|','
name|'i_ref'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'i_ref'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_remove_fixed_ip
dedent|''
name|'def'
name|'test_add_remove_fixed_ip'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
op|'{'
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'network_api'
op|','
string|"'deallocate_for_instance'"
op|','
nl|'\n'
name|'lambda'
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|':'
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'add_fixed_ip'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
string|"'1'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'remove_fixed_ip'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
string|"'192.168.1.1'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'delete'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_attach_volume_invalid
dedent|''
name|'def'
name|'test_attach_volume_invalid'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InvalidDevicePath'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'attach_volume'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
op|'{'
string|"'locked'"
op|':'
name|'False'
op|','
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'ACTIVE'
op|','
nl|'\n'
string|"'launched_at'"
op|':'
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
op|'}'
op|','
nl|'\n'
name|'None'
op|','
nl|'\n'
string|"'/invalid'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_no_attach_volume_in_rescue_state
dedent|''
name|'def'
name|'test_no_attach_volume_in_rescue_state'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|fake
indent|'        '
name|'def'
name|'fake'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
DECL|function|fake_volume_get
dedent|''
name|'def'
name|'fake_volume_get'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'id'"
op|':'
name|'volume_id'
op|'}'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'get'"
op|','
name|'fake_volume_get'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'check_attach'"
op|','
name|'fake'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'reserve_volume'"
op|','
name|'fake'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceInvalidState'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'attach_volume'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
op|'{'
string|"'uuid'"
op|':'
string|"'fake_uuid'"
op|','
string|"'locked'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'RESCUED'
op|'}'
op|','
nl|'\n'
name|'None'
op|','
nl|'\n'
string|"'/dev/vdb'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_no_detach_volume_in_rescue_state
dedent|''
name|'def'
name|'test_no_detach_volume_in_rescue_state'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure volume can be detached from instance'
nl|'\n'
nl|'\n'
indent|'        '
name|'params'
op|'='
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'RESCUED'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
name|'params'
op|')'
newline|'\n'
nl|'\n'
name|'volume'
op|'='
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'attach_status'"
op|':'
string|"'in-use'"
op|','
nl|'\n'
string|"'instance_uuid'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|'}'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceInvalidState'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'detach_volume'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
name|'volume'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_no_rescue_in_volume_state_attaching
dedent|''
name|'def'
name|'test_no_rescue_in_volume_state_attaching'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure a VM cannot be rescued while volume is being attached'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_get_instance_bdms
name|'def'
name|'fake_get_instance_bdms'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'['
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/vda'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'volume_id'"
op|':'
string|"'bf0b6b00-a20c-11e2-9e96-0800200c9a66'"
op|'}'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|','
string|"'get_instance_bdms'"
op|','
nl|'\n'
name|'fake_get_instance_bdms'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_volume_get
name|'def'
name|'fake_volume_get'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'id'"
op|':'
name|'volume_id'
op|','
string|"'status'"
op|':'
string|"'attaching'"
op|'}'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'get'"
op|','
name|'fake_volume_get'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InvalidVolume'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'rescue'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_vnc_console
dedent|''
name|'def'
name|'test_vnc_console'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure we can a vnc console for an instance.'
nl|'\n'
nl|'\n'
indent|'        '
name|'fake_instance'
op|'='
op|'{'
string|"'uuid'"
op|':'
string|"'fake_uuid'"
op|','
nl|'\n'
string|"'host'"
op|':'
string|"'fake_compute_host'"
op|'}'
newline|'\n'
name|'fake_console_type'
op|'='
string|'"novnc"'
newline|'\n'
name|'fake_connect_info'
op|'='
op|'{'
string|"'token'"
op|':'
string|"'fake_token'"
op|','
nl|'\n'
string|"'console_type'"
op|':'
name|'fake_console_type'
op|','
nl|'\n'
string|"'host'"
op|':'
string|"'fake_console_host'"
op|','
nl|'\n'
string|"'port'"
op|':'
string|"'fake_console_port'"
op|','
nl|'\n'
string|"'internal_access_path'"
op|':'
string|"'fake_access_path'"
op|','
nl|'\n'
string|"'instance_uuid'"
op|':'
name|'fake_instance'
op|'['
string|"'uuid'"
op|']'
op|'}'
newline|'\n'
name|'fake_connect_info2'
op|'='
name|'copy'
op|'.'
name|'deepcopy'
op|'('
name|'fake_connect_info'
op|')'
newline|'\n'
name|'fake_connect_info2'
op|'['
string|"'access_url'"
op|']'
op|'='
string|"'fake_console_url'"
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'rpc'
op|','
string|"'call'"
op|')'
newline|'\n'
nl|'\n'
name|'rpc_msg1'
op|'='
op|'{'
string|"'method'"
op|':'
string|"'get_vnc_console'"
op|','
nl|'\n'
string|"'namespace'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'args'"
op|':'
op|'{'
string|"'instance'"
op|':'
name|'fake_instance'
op|','
nl|'\n'
string|"'console_type'"
op|':'
name|'fake_console_type'
op|'}'
op|','
nl|'\n'
string|"'version'"
op|':'
name|'compute_rpcapi'
op|'.'
name|'ComputeAPI'
op|'.'
name|'BASE_RPC_API_VERSION'
op|'}'
newline|'\n'
name|'rpc_msg2'
op|'='
op|'{'
string|"'method'"
op|':'
string|"'authorize_console'"
op|','
nl|'\n'
string|"'namespace'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'args'"
op|':'
name|'fake_connect_info'
op|','
nl|'\n'
string|"'version'"
op|':'
string|"'2.0'"
op|'}'
newline|'\n'
nl|'\n'
name|'rpc'
op|'.'
name|'call'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'compute.%s'"
op|'%'
name|'fake_instance'
op|'['
string|"'host'"
op|']'
op|','
nl|'\n'
name|'rpc_msg1'
op|','
name|'None'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'fake_connect_info2'
op|')'
newline|'\n'
name|'rpc'
op|'.'
name|'call'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'CONF'
op|'.'
name|'consoleauth_topic'
op|','
nl|'\n'
name|'rpc_msg2'
op|','
name|'None'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'console'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_vnc_console'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'fake_instance'
op|','
name|'fake_console_type'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'console'
op|','
op|'{'
string|"'url'"
op|':'
string|"'fake_console_url'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_vnc_console_no_host
dedent|''
name|'def'
name|'test_get_vnc_console_no_host'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
op|'{'
string|"'host'"
op|':'
string|"''"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceNotReady'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_vnc_console'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
string|"'novnc'"
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_spice_console
dedent|''
name|'def'
name|'test_spice_console'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure we can a spice console for an instance.'
nl|'\n'
nl|'\n'
indent|'        '
name|'fake_instance'
op|'='
op|'{'
string|"'uuid'"
op|':'
string|"'fake_uuid'"
op|','
nl|'\n'
string|"'host'"
op|':'
string|"'fake_compute_host'"
op|'}'
newline|'\n'
name|'fake_console_type'
op|'='
string|'"spice-html5"'
newline|'\n'
name|'fake_connect_info'
op|'='
op|'{'
string|"'token'"
op|':'
string|"'fake_token'"
op|','
nl|'\n'
string|"'console_type'"
op|':'
name|'fake_console_type'
op|','
nl|'\n'
string|"'host'"
op|':'
string|"'fake_console_host'"
op|','
nl|'\n'
string|"'port'"
op|':'
string|"'fake_console_port'"
op|','
nl|'\n'
string|"'internal_access_path'"
op|':'
string|"'fake_access_path'"
op|','
nl|'\n'
string|"'instance_uuid'"
op|':'
name|'fake_instance'
op|'['
string|"'uuid'"
op|']'
op|'}'
newline|'\n'
name|'fake_connect_info2'
op|'='
name|'copy'
op|'.'
name|'deepcopy'
op|'('
name|'fake_connect_info'
op|')'
newline|'\n'
name|'fake_connect_info2'
op|'['
string|"'access_url'"
op|']'
op|'='
string|"'fake_console_url'"
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'rpc'
op|','
string|"'call'"
op|')'
newline|'\n'
nl|'\n'
name|'rpc_msg1'
op|'='
op|'{'
string|"'method'"
op|':'
string|"'get_spice_console'"
op|','
nl|'\n'
string|"'namespace'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'args'"
op|':'
op|'{'
string|"'instance'"
op|':'
name|'fake_instance'
op|','
nl|'\n'
string|"'console_type'"
op|':'
name|'fake_console_type'
op|'}'
op|','
nl|'\n'
string|"'version'"
op|':'
string|"'3.1'"
op|'}'
newline|'\n'
name|'rpc_msg2'
op|'='
op|'{'
string|"'method'"
op|':'
string|"'authorize_console'"
op|','
nl|'\n'
string|"'namespace'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'args'"
op|':'
name|'fake_connect_info'
op|','
nl|'\n'
string|"'version'"
op|':'
string|"'2.0'"
op|'}'
newline|'\n'
nl|'\n'
name|'rpc'
op|'.'
name|'call'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'compute.%s'"
op|'%'
name|'fake_instance'
op|'['
string|"'host'"
op|']'
op|','
nl|'\n'
name|'rpc_msg1'
op|','
name|'None'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'fake_connect_info2'
op|')'
newline|'\n'
name|'rpc'
op|'.'
name|'call'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'CONF'
op|'.'
name|'consoleauth_topic'
op|','
nl|'\n'
name|'rpc_msg2'
op|','
name|'None'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'console'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_spice_console'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'fake_instance'
op|','
name|'fake_console_type'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'console'
op|','
op|'{'
string|"'url'"
op|':'
string|"'fake_console_url'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_spice_console_no_host
dedent|''
name|'def'
name|'test_get_spice_console_no_host'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
op|'{'
string|"'host'"
op|':'
string|"''"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceNotReady'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_spice_console'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
string|"'spice'"
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_console_output
dedent|''
name|'def'
name|'test_console_output'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'fake_instance'
op|'='
op|'{'
string|"'uuid'"
op|':'
string|"'fake_uuid'"
op|','
nl|'\n'
string|"'host'"
op|':'
string|"'fake_compute_host'"
op|'}'
newline|'\n'
name|'fake_tail_length'
op|'='
number|'699'
newline|'\n'
name|'fake_console_output'
op|'='
string|"'fake console output'"
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'rpc'
op|','
string|"'call'"
op|')'
newline|'\n'
nl|'\n'
name|'rpc_msg'
op|'='
op|'{'
string|"'method'"
op|':'
string|"'get_console_output'"
op|','
nl|'\n'
string|"'namespace'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'args'"
op|':'
op|'{'
string|"'instance'"
op|':'
name|'fake_instance'
op|','
nl|'\n'
string|"'tail_length'"
op|':'
name|'fake_tail_length'
op|'}'
op|','
nl|'\n'
string|"'version'"
op|':'
name|'compute_rpcapi'
op|'.'
name|'ComputeAPI'
op|'.'
name|'BASE_RPC_API_VERSION'
op|'}'
newline|'\n'
name|'rpc'
op|'.'
name|'call'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'compute.%s'"
op|'%'
name|'fake_instance'
op|'['
string|"'host'"
op|']'
op|','
nl|'\n'
name|'rpc_msg'
op|','
name|'None'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'fake_console_output'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'output'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_console_output'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'fake_instance'
op|','
name|'tail_length'
op|'='
name|'fake_tail_length'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'output'
op|','
name|'fake_console_output'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_console_output_no_host
dedent|''
name|'def'
name|'test_console_output_no_host'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
op|'{'
string|"'host'"
op|':'
string|"''"
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceNotReady'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_console_output'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_attach_interface
dedent|''
name|'def'
name|'test_attach_interface'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'new_type'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_flavor_id'
op|'('
string|"'4'"
op|')'
newline|'\n'
name|'sys_meta'
op|'='
name|'flavors'
op|'.'
name|'save_flavor_info'
op|'('
op|'{'
op|'}'
op|','
name|'new_type'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
op|'{'
nl|'\n'
string|"'image_ref'"
op|':'
string|"'foo'"
op|','
nl|'\n'
string|"'system_metadata'"
op|':'
name|'sys_meta'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|','
nl|'\n'
string|"'allocate_port_for_instance'"
op|')'
newline|'\n'
name|'nwinfo'
op|'='
op|'['
name|'fake_network_cache_model'
op|'.'
name|'new_vif'
op|'('
op|')'
op|']'
newline|'\n'
name|'network_id'
op|'='
name|'nwinfo'
op|'['
number|'0'
op|']'
op|'['
string|"'network'"
op|']'
op|'['
string|"'id'"
op|']'
newline|'\n'
name|'port_id'
op|'='
name|'nwinfo'
op|'['
number|'0'
op|']'
op|'['
string|"'id'"
op|']'
newline|'\n'
name|'req_ip'
op|'='
string|"'1.2.3.4'"
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|'.'
name|'allocate_port_for_instance'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
name|'port_id'
op|','
name|'network_id'
op|','
name|'req_ip'
nl|'\n'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'nwinfo'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'vif'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'attach_interface'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
name|'network_id'
op|','
nl|'\n'
name|'port_id'
op|','
nl|'\n'
name|'req_ip'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'vif'
op|'['
string|"'id'"
op|']'
op|','
name|'network_id'
op|')'
newline|'\n'
name|'return'
name|'nwinfo'
op|','
name|'port_id'
newline|'\n'
nl|'\n'
DECL|member|test_detach_interface
dedent|''
name|'def'
name|'test_detach_interface'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'nwinfo'
op|','
name|'port_id'
op|'='
name|'self'
op|'.'
name|'test_attach_interface'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_instance_nw_info'"
op|','
nl|'\n'
name|'lambda'
op|'*'
name|'a'
op|','
op|'**'
name|'k'
op|':'
name|'nwinfo'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'network_api'
op|','
nl|'\n'
string|"'deallocate_port_for_instance'"
op|','
nl|'\n'
name|'lambda'
name|'a'
op|','
name|'b'
op|','
name|'c'
op|':'
op|'['
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'detach_interface'
op|'('
name|'self'
op|'.'
name|'context'
op|','
op|'{'
op|'}'
op|','
name|'port_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'_interfaces'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_attach_volume
dedent|''
name|'def'
name|'test_attach_volume'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure instance can be soft rebooted.'
nl|'\n'
nl|'\n'
indent|'        '
name|'called'
op|'='
op|'{'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_check_attach
name|'def'
name|'fake_check_attach'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fake_check_attach'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
DECL|function|fake_reserve_volume
dedent|''
name|'def'
name|'fake_reserve_volume'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fake_reserve_volume'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
DECL|function|fake_volume_get
dedent|''
name|'def'
name|'fake_volume_get'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fake_volume_get'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'return'
op|'{'
string|"'id'"
op|':'
name|'volume_id'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_rpc_attach_volume
dedent|''
name|'def'
name|'fake_rpc_attach_volume'
op|'('
name|'self'
op|','
name|'context'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fake_rpc_attach_volume'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
DECL|function|fake_rpc_reserve_block_device_name
dedent|''
name|'def'
name|'fake_rpc_reserve_block_device_name'
op|'('
name|'self'
op|','
name|'context'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fake_rpc_reserve_block_device_name'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'get'"
op|','
name|'fake_volume_get'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'check_attach'"
op|','
name|'fake_check_attach'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'reserve_volume'"
op|','
nl|'\n'
name|'fake_reserve_volume'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'compute_rpcapi'
op|'.'
name|'ComputeAPI'
op|','
nl|'\n'
string|"'reserve_block_device_name'"
op|','
nl|'\n'
name|'fake_rpc_reserve_block_device_name'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'compute_rpcapi'
op|'.'
name|'ComputeAPI'
op|','
string|"'attach_volume'"
op|','
nl|'\n'
name|'fake_rpc_attach_volume'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'attach_volume'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
number|'1'
op|','
string|"'/dev/vdb'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'.'
name|'get'
op|'('
string|"'fake_check_attach'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'.'
name|'get'
op|'('
string|"'fake_reserve_volume'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'.'
name|'get'
op|'('
string|"'fake_reserve_volume'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'.'
name|'get'
op|'('
string|"'fake_rpc_reserve_block_device_name'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'.'
name|'get'
op|'('
string|"'fake_rpc_attach_volume'"
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_attach_volume_no_device
dedent|''
name|'def'
name|'test_attach_volume_no_device'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'        '
name|'called'
op|'='
op|'{'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_check_attach
name|'def'
name|'fake_check_attach'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fake_check_attach'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
DECL|function|fake_reserve_volume
dedent|''
name|'def'
name|'fake_reserve_volume'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fake_reserve_volume'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
DECL|function|fake_volume_get
dedent|''
name|'def'
name|'fake_volume_get'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fake_volume_get'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'return'
op|'{'
string|"'id'"
op|':'
name|'volume_id'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_rpc_attach_volume
dedent|''
name|'def'
name|'fake_rpc_attach_volume'
op|'('
name|'self'
op|','
name|'context'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fake_rpc_attach_volume'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'get'"
op|','
name|'fake_volume_get'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'check_attach'"
op|','
name|'fake_check_attach'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'reserve_volume'"
op|','
nl|'\n'
name|'fake_reserve_volume'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'compute_rpcapi'
op|'.'
name|'ComputeAPI'
op|','
string|"'attach_volume'"
op|','
nl|'\n'
name|'fake_rpc_attach_volume'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_detach_volume
dedent|''
name|'def'
name|'test_detach_volume'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure volume can be detached from instance'
nl|'\n'
indent|'        '
name|'called'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'volume'
op|'='
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'attach_status'"
op|':'
string|"'in-use'"
op|','
nl|'\n'
string|"'instance_uuid'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_check_detach
name|'def'
name|'fake_check_detach'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fake_check_detach'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
DECL|function|fake_begin_detaching
dedent|''
name|'def'
name|'fake_begin_detaching'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fake_begin_detaching'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
DECL|function|fake_rpc_detach_volume
dedent|''
name|'def'
name|'fake_rpc_detach_volume'
op|'('
name|'self'
op|','
name|'context'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fake_rpc_detach_volume'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'check_detach'"
op|','
name|'fake_check_detach'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'begin_detaching'"
op|','
name|'fake_begin_detaching'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'compute_rpcapi'
op|'.'
name|'ComputeAPI'
op|','
string|"'detach_volume'"
op|','
nl|'\n'
name|'fake_rpc_detach_volume'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'detach_volume'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
name|'volume'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'.'
name|'get'
op|'('
string|"'fake_check_detach'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'.'
name|'get'
op|'('
string|"'fake_begin_detaching'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'.'
name|'get'
op|'('
string|"'fake_rpc_detach_volume'"
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_detach_invalid_volume
dedent|''
name|'def'
name|'test_detach_invalid_volume'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure exception is raised while detaching an un-attached volume'
nl|'\n'
indent|'        '
name|'instance'
op|'='
op|'{'
string|"'uuid'"
op|':'
string|"'uuid1'"
op|','
nl|'\n'
string|"'locked'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'launched_at'"
op|':'
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
op|','
nl|'\n'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'ACTIVE'
op|'}'
newline|'\n'
name|'volume'
op|'='
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'attach_status'"
op|':'
string|"'detached'"
op|'}'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InvalidVolume'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'detach_volume'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
name|'volume'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_detach_unattached_volume
dedent|''
name|'def'
name|'test_detach_unattached_volume'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|"# Ensure exception is raised when volume's idea of attached"
nl|'\n'
comment|"# instance doesn't match."
nl|'\n'
indent|'        '
name|'instance'
op|'='
op|'{'
string|"'uuid'"
op|':'
string|"'uuid1'"
op|','
nl|'\n'
string|"'locked'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'launched_at'"
op|':'
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
op|','
nl|'\n'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'ACTIVE'
op|'}'
newline|'\n'
name|'volume'
op|'='
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
string|"'attach_status'"
op|':'
string|"'in-use'"
op|','
nl|'\n'
string|"'instance_uuid'"
op|':'
string|"'uuid2'"
op|'}'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'VolumeUnattached'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'detach_volume'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
name|'volume'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_detach_volume_libvirt_is_down
dedent|''
name|'def'
name|'test_detach_volume_libvirt_is_down'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure rollback during detach if libvirt goes down'
nl|'\n'
nl|'\n'
indent|'        '
name|'called'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_get_instance_volume_bdm
name|'def'
name|'fake_get_instance_volume_bdm'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'device_name'"
op|':'
string|"'/dev/vdb'"
op|','
string|"'volume_id'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'connection_info'"
op|':'
string|'\'{"test": "test"}\''
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_libvirt_driver_instance_exists
dedent|''
name|'def'
name|'fake_libvirt_driver_instance_exists'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fake_libvirt_driver_instance_exists'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'return'
name|'False'
newline|'\n'
nl|'\n'
DECL|function|fake_libvirt_driver_detach_volume_fails
dedent|''
name|'def'
name|'fake_libvirt_driver_detach_volume_fails'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fake_libvirt_driver_detach_volume_fails'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'raise'
name|'AttributeError'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_roll_detaching
dedent|''
name|'def'
name|'fake_roll_detaching'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'called'
op|'['
string|"'fake_roll_detaching'"
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|"'roll_detaching'"
op|','
name|'fake_roll_detaching'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|'"_get_instance_volume_bdm"'
op|','
nl|'\n'
name|'fake_get_instance_volume_bdm'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|'"instance_exists"'
op|','
nl|'\n'
name|'fake_libvirt_driver_instance_exists'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|'"detach_volume"'
op|','
nl|'\n'
name|'fake_libvirt_driver_detach_volume_fails'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'AttributeError'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'detach_volume'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
number|'1'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'.'
name|'get'
op|'('
string|"'fake_libvirt_driver_instance_exists'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'called'
op|'.'
name|'get'
op|'('
string|"'fake_roll_detaching'"
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_terminate_with_volumes
dedent|''
name|'def'
name|'test_terminate_with_volumes'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Make sure that volumes get detached during instance termination.'
nl|'\n'
indent|'        '
name|'admin'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'volume_id'
op|'='
string|"'fake'"
newline|'\n'
name|'values'
op|'='
op|'{'
string|"'instance_uuid'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/vdc'"
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'volume_id'"
op|':'
name|'volume_id'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'db'
op|'.'
name|'block_device_mapping_create'
op|'('
name|'admin'
op|','
name|'values'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_volume_get
name|'def'
name|'fake_volume_get'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'id'"
op|':'
name|'volume_id'
op|'}'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|'"get"'
op|','
name|'fake_volume_get'
op|')'
newline|'\n'
nl|'\n'
comment|'# Stub out and record whether it gets detached'
nl|'\n'
name|'result'
op|'='
op|'{'
string|'"detached"'
op|':'
name|'False'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_detach
name|'def'
name|'fake_detach'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id_param'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'result'
op|'['
string|'"detached"'
op|']'
op|'='
name|'volume_id_param'
op|'=='
name|'volume_id'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|'"detach"'
op|','
name|'fake_detach'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_terminate_connection
name|'def'
name|'fake_terminate_connection'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume_id'
op|','
name|'connector'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
op|'}'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|'"terminate_connection"'
op|','
nl|'\n'
name|'fake_terminate_connection'
op|')'
newline|'\n'
nl|'\n'
comment|'# Kill the instance and check that it was detached'
nl|'\n'
name|'bdms'
op|'='
name|'db'
op|'.'
name|'block_device_mapping_get_all_by_instance'
op|'('
name|'admin'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'admin'
op|','
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
name|'bdms'
op|','
nl|'\n'
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'result'
op|'['
string|'"detached"'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_terminate_deletes_all_bdms
dedent|''
name|'def'
name|'test_terminate_deletes_all_bdms'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'admin'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'img_bdm'
op|'='
op|'{'
string|"'instance_uuid'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/vda'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'image'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'local'"
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'boot_index'"
op|':'
number|'0'
op|','
nl|'\n'
string|"'image_id'"
op|':'
string|"'fake_image'"
op|'}'
newline|'\n'
name|'vol_bdm'
op|'='
op|'{'
string|"'instance_uuid'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/vdc'"
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'destination_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'volume_id'"
op|':'
string|"'fake_vol'"
op|'}'
newline|'\n'
name|'for'
name|'bdm'
name|'in'
name|'img_bdm'
op|','
name|'vol_bdm'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'block_device_mapping_create'
op|'('
name|'admin'
op|','
name|'bdm'
op|','
name|'legacy'
op|'='
name|'False'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'volume_api'"
op|','
name|'mox'
op|'.'
name|'MockAnything'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_prep_block_device'"
op|','
name|'mox'
op|'.'
name|'MockAnything'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'terminate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|','
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'bdms'
op|'='
name|'db'
op|'.'
name|'block_device_mapping_get_all_by_instance'
op|'('
name|'admin'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'bdms'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_inject_network_info
dedent|''
name|'def'
name|'test_inject_network_info'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
op|'{'
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'host'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance'
op|')'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
name|'want_objects'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'inject_network_info'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'network_api'
op|','
nl|'\n'
string|"'deallocate_for_instance'"
op|','
nl|'\n'
name|'lambda'
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|':'
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'delete'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reset_network
dedent|''
name|'def'
name|'test_reset_network'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance'
op|')'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
name|'want_objects'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'reset_network'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_lock
dedent|''
name|'def'
name|'test_lock'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'network_api'
op|','
string|"'deallocate_for_instance'"
op|','
nl|'\n'
name|'lambda'
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|':'
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'lock'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_unlock
dedent|''
name|'def'
name|'test_unlock'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'network_api'
op|','
string|"'deallocate_for_instance'"
op|','
nl|'\n'
name|'lambda'
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|':'
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'unlock'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_lock
dedent|''
name|'def'
name|'test_get_lock'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_lock'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
op|'{'
string|"'locked'"
op|':'
name|'True'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_lock'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_remove_security_group
dedent|''
name|'def'
name|'test_add_remove_security_group'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance'
op|')'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'security_group_name'
op|'='
name|'self'
op|'.'
name|'_create_group'
op|'('
op|')'
op|'['
string|"'name'"
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'security_group_api'
op|'.'
name|'add_to_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
name|'security_group_name'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'security_group_api'
op|'.'
name|'remove_from_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
name|'security_group_name'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_diagnostics
dedent|''
name|'def'
name|'test_get_diagnostics'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'rpcapi'
op|'='
name|'compute_rpcapi'
op|'.'
name|'ComputeAPI'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'rpcapi'
op|','
string|"'get_diagnostics'"
op|')'
newline|'\n'
name|'rpcapi'
op|'.'
name|'get_diagnostics'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_diagnostics'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'network_api'
op|','
string|"'deallocate_for_instance'"
op|','
nl|'\n'
name|'lambda'
op|'*'
name|'a'
op|','
op|'**'
name|'kw'
op|':'
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'delete'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_inject_file
dedent|''
name|'def'
name|'test_inject_file'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure we can write a file to an instance.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'inject_file'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
string|'"/tmp/test"'
op|','
string|'"File Contents"'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_secgroup_refresh
dedent|''
name|'def'
name|'test_secgroup_refresh'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|rule_get
name|'def'
name|'rule_get'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'mock_rule'
op|'='
name|'db_fakes'
op|'.'
name|'FakeModel'
op|'('
op|'{'
string|"'parent_group_id'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'return'
op|'['
name|'mock_rule'
op|']'
newline|'\n'
nl|'\n'
DECL|function|group_get
dedent|''
name|'def'
name|'group_get'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'mock_group'
op|'='
name|'db_fakes'
op|'.'
name|'FakeModel'
op|'('
op|'{'
string|"'instances'"
op|':'
op|'['
name|'instance'
op|']'
op|'}'
op|')'
newline|'\n'
name|'return'
name|'mock_group'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'db'
op|','
nl|'\n'
string|"'security_group_rule_get_by_security_group_grantee'"
op|','
nl|'\n'
name|'rule_get'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'db'
op|','
string|"'security_group_get'"
op|','
name|'group_get'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'rpc'
op|','
string|"'cast'"
op|')'
newline|'\n'
name|'topic'
op|'='
name|'rpc'
op|'.'
name|'queue_get_for'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'CONF'
op|'.'
name|'compute_topic'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'host'"
op|']'
op|')'
newline|'\n'
name|'rpc'
op|'.'
name|'cast'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'topic'
op|','
nl|'\n'
op|'{'
string|'"method"'
op|':'
string|'"refresh_instance_security_rules"'
op|','
nl|'\n'
string|'"namespace"'
op|':'
name|'None'
op|','
nl|'\n'
string|'"args"'
op|':'
op|'{'
string|"'instance'"
op|':'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance'
op|')'
op|'}'
op|','
nl|'\n'
string|'"version"'
op|':'
nl|'\n'
name|'compute_rpcapi'
op|'.'
name|'SecurityGroupAPI'
op|'.'
name|'BASE_RPC_API_VERSION'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'security_group_api'
op|'.'
name|'trigger_members_refresh'
op|'('
name|'self'
op|'.'
name|'context'
op|','
op|'['
number|'1'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_secgroup_refresh_once
dedent|''
name|'def'
name|'test_secgroup_refresh_once'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|rule_get
name|'def'
name|'rule_get'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'mock_rule'
op|'='
name|'db_fakes'
op|'.'
name|'FakeModel'
op|'('
op|'{'
string|"'parent_group_id'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'return'
op|'['
name|'mock_rule'
op|']'
newline|'\n'
nl|'\n'
DECL|function|group_get
dedent|''
name|'def'
name|'group_get'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'mock_group'
op|'='
name|'db_fakes'
op|'.'
name|'FakeModel'
op|'('
op|'{'
string|"'instances'"
op|':'
op|'['
name|'instance'
op|']'
op|'}'
op|')'
newline|'\n'
name|'return'
name|'mock_group'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'db'
op|','
nl|'\n'
string|"'security_group_rule_get_by_security_group_grantee'"
op|','
nl|'\n'
name|'rule_get'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'db'
op|','
string|"'security_group_get'"
op|','
name|'group_get'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'rpc'
op|','
string|"'cast'"
op|')'
newline|'\n'
name|'topic'
op|'='
name|'rpc'
op|'.'
name|'queue_get_for'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'CONF'
op|'.'
name|'compute_topic'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'host'"
op|']'
op|')'
newline|'\n'
name|'rpc'
op|'.'
name|'cast'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'topic'
op|','
nl|'\n'
op|'{'
string|'"method"'
op|':'
string|'"refresh_instance_security_rules"'
op|','
nl|'\n'
string|'"namespace"'
op|':'
name|'None'
op|','
nl|'\n'
string|'"args"'
op|':'
op|'{'
string|"'instance'"
op|':'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance'
op|')'
op|'}'
op|','
nl|'\n'
string|'"version"'
op|':'
nl|'\n'
name|'compute_rpcapi'
op|'.'
name|'SecurityGroupAPI'
op|'.'
name|'BASE_RPC_API_VERSION'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'security_group_api'
op|'.'
name|'trigger_members_refresh'
op|'('
name|'self'
op|'.'
name|'context'
op|','
op|'['
number|'1'
op|','
number|'2'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_secgroup_refresh_none
dedent|''
name|'def'
name|'test_secgroup_refresh_none'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|rule_get
indent|'        '
name|'def'
name|'rule_get'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'mock_rule'
op|'='
name|'db_fakes'
op|'.'
name|'FakeModel'
op|'('
op|'{'
string|"'parent_group_id'"
op|':'
number|'1'
op|'}'
op|')'
newline|'\n'
name|'return'
op|'['
name|'mock_rule'
op|']'
newline|'\n'
nl|'\n'
DECL|function|group_get
dedent|''
name|'def'
name|'group_get'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'mock_group'
op|'='
name|'db_fakes'
op|'.'
name|'FakeModel'
op|'('
op|'{'
string|"'instances'"
op|':'
op|'['
op|']'
op|'}'
op|')'
newline|'\n'
name|'return'
name|'mock_group'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'db'
op|','
nl|'\n'
string|"'security_group_rule_get_by_security_group_grantee'"
op|','
nl|'\n'
name|'rule_get'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'db'
op|','
string|"'security_group_get'"
op|','
name|'group_get'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'rpc'
op|','
string|"'cast'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'security_group_api'
op|'.'
name|'trigger_members_refresh'
op|'('
name|'self'
op|'.'
name|'context'
op|','
op|'['
number|'1'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_secrule_refresh
dedent|''
name|'def'
name|'test_secrule_refresh'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|group_get
name|'def'
name|'group_get'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'mock_group'
op|'='
name|'db_fakes'
op|'.'
name|'FakeModel'
op|'('
op|'{'
string|"'instances'"
op|':'
op|'['
name|'instance'
op|']'
op|'}'
op|')'
newline|'\n'
name|'return'
name|'mock_group'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'db'
op|','
string|"'security_group_get'"
op|','
name|'group_get'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'rpc'
op|','
string|"'cast'"
op|')'
newline|'\n'
name|'topic'
op|'='
name|'rpc'
op|'.'
name|'queue_get_for'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'CONF'
op|'.'
name|'compute_topic'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'host'"
op|']'
op|')'
newline|'\n'
name|'rpc'
op|'.'
name|'cast'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'topic'
op|','
nl|'\n'
op|'{'
string|'"method"'
op|':'
string|'"refresh_instance_security_rules"'
op|','
nl|'\n'
string|'"namespace"'
op|':'
name|'None'
op|','
nl|'\n'
string|'"args"'
op|':'
op|'{'
string|"'instance'"
op|':'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance'
op|')'
op|'}'
op|','
nl|'\n'
string|'"version"'
op|':'
nl|'\n'
name|'compute_rpcapi'
op|'.'
name|'SecurityGroupAPI'
op|'.'
name|'BASE_RPC_API_VERSION'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'security_group_api'
op|'.'
name|'trigger_rules_refresh'
op|'('
name|'self'
op|'.'
name|'context'
op|','
op|'['
number|'1'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_secrule_refresh_once
dedent|''
name|'def'
name|'test_secrule_refresh_once'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|group_get
name|'def'
name|'group_get'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'mock_group'
op|'='
name|'db_fakes'
op|'.'
name|'FakeModel'
op|'('
op|'{'
string|"'instances'"
op|':'
op|'['
name|'instance'
op|']'
op|'}'
op|')'
newline|'\n'
name|'return'
name|'mock_group'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'db'
op|','
string|"'security_group_get'"
op|','
name|'group_get'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'rpc'
op|','
string|"'cast'"
op|')'
newline|'\n'
name|'topic'
op|'='
name|'rpc'
op|'.'
name|'queue_get_for'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'CONF'
op|'.'
name|'compute_topic'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'host'"
op|']'
op|')'
newline|'\n'
name|'rpc'
op|'.'
name|'cast'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'topic'
op|','
nl|'\n'
op|'{'
string|'"method"'
op|':'
string|'"refresh_instance_security_rules"'
op|','
nl|'\n'
string|'"namespace"'
op|':'
name|'None'
op|','
nl|'\n'
string|'"args"'
op|':'
op|'{'
string|"'instance'"
op|':'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'instance'
op|')'
op|'}'
op|','
nl|'\n'
string|'"version"'
op|':'
nl|'\n'
name|'compute_rpcapi'
op|'.'
name|'SecurityGroupAPI'
op|'.'
name|'BASE_RPC_API_VERSION'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'security_group_api'
op|'.'
name|'trigger_rules_refresh'
op|'('
name|'self'
op|'.'
name|'context'
op|','
op|'['
number|'1'
op|','
number|'2'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_secrule_refresh_none
dedent|''
name|'def'
name|'test_secrule_refresh_none'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|group_get
indent|'        '
name|'def'
name|'group_get'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'mock_group'
op|'='
name|'db_fakes'
op|'.'
name|'FakeModel'
op|'('
op|'{'
string|"'instances'"
op|':'
op|'['
op|']'
op|'}'
op|')'
newline|'\n'
name|'return'
name|'mock_group'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'db'
op|','
string|"'security_group_get'"
op|','
name|'group_get'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'rpc'
op|','
string|"'cast'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'security_group_api'
op|'.'
name|'trigger_rules_refresh'
op|'('
name|'self'
op|'.'
name|'context'
op|','
op|'['
number|'1'
op|','
number|'2'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_live_migrate
dedent|''
name|'def'
name|'test_live_migrate'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|','
name|'instance_uuid'
op|'='
name|'self'
op|'.'
name|'_run_instance'
op|'('
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'rpcapi'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'compute_task_api'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'rpcapi'
op|','
string|"'live_migrate_instance'"
op|')'
newline|'\n'
name|'rpcapi'
op|'.'
name|'live_migrate_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
string|"'fake_dest_host'"
op|','
nl|'\n'
name|'block_migration'
op|'='
name|'True'
op|','
nl|'\n'
name|'disk_over_commit'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'live_migrate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'block_migration'
op|'='
name|'True'
op|','
nl|'\n'
name|'disk_over_commit'
op|'='
name|'True'
op|','
nl|'\n'
name|'host_name'
op|'='
string|"'fake_dest_host'"
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'.'
name|'refresh'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|','
name|'task_states'
op|'.'
name|'MIGRATING'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_evacuate
dedent|''
name|'def'
name|'test_evacuate'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
name|'services'
op|'='
name|'True'
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_service_is_up
name|'def'
name|'fake_service_is_up'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'False'
newline|'\n'
nl|'\n'
DECL|function|fake_rebuild_instance
dedent|''
name|'def'
name|'fake_rebuild_instance'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|','
nl|'\n'
op|'{'
string|"'host'"
op|':'
name|'kwargs'
op|'['
string|"'host'"
op|']'
op|'}'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'servicegroup_api'
op|','
string|"'service_is_up'"
op|','
nl|'\n'
name|'fake_service_is_up'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'compute_rpcapi'
op|','
string|"'rebuild_instance'"
op|','
nl|'\n'
name|'fake_rebuild_instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'evacuate'
op|'('
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
name|'host'
op|'='
string|"'fake_dest_host'"
op|','
nl|'\n'
name|'on_shared_storage'
op|'='
name|'True'
op|','
nl|'\n'
name|'admin_password'
op|'='
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|','
name|'task_states'
op|'.'
name|'REBUILDING'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'host'"
op|']'
op|','
string|"'fake_dest_host'"
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_fail_evacuate_from_non_existing_host
dedent|''
name|'def'
name|'test_fail_evacuate_from_non_existing_host'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'inst'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'inst'
op|'['
string|"'vm_state'"
op|']'
op|'='
name|'vm_states'
op|'.'
name|'ACTIVE'
newline|'\n'
name|'inst'
op|'['
string|"'launched_at'"
op|']'
op|'='
name|'timeutils'
op|'.'
name|'utcnow'
op|'('
op|')'
newline|'\n'
name|'inst'
op|'['
string|"'image_ref'"
op|']'
op|'='
name|'FAKE_IMAGE_REF'
newline|'\n'
name|'inst'
op|'['
string|"'reservation_id'"
op|']'
op|'='
string|"'r-fakeres'"
newline|'\n'
name|'inst'
op|'['
string|"'user_id'"
op|']'
op|'='
name|'self'
op|'.'
name|'user_id'
newline|'\n'
name|'inst'
op|'['
string|"'project_id'"
op|']'
op|'='
name|'self'
op|'.'
name|'project_id'
newline|'\n'
name|'inst'
op|'['
string|"'host'"
op|']'
op|'='
string|"'fake_host'"
newline|'\n'
name|'inst'
op|'['
string|"'node'"
op|']'
op|'='
name|'NODENAME'
newline|'\n'
name|'type_id'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
string|"'m1.tiny'"
op|')'
op|'['
string|"'id'"
op|']'
newline|'\n'
name|'inst'
op|'['
string|"'instance_type_id'"
op|']'
op|'='
name|'type_id'
newline|'\n'
name|'inst'
op|'['
string|"'ami_launch_index'"
op|']'
op|'='
number|'0'
newline|'\n'
name|'inst'
op|'['
string|"'memory_mb'"
op|']'
op|'='
number|'0'
newline|'\n'
name|'inst'
op|'['
string|"'vcpus'"
op|']'
op|'='
number|'0'
newline|'\n'
name|'inst'
op|'['
string|"'root_gb'"
op|']'
op|'='
number|'0'
newline|'\n'
name|'inst'
op|'['
string|"'ephemeral_gb'"
op|']'
op|'='
number|'0'
newline|'\n'
name|'inst'
op|'['
string|"'architecture'"
op|']'
op|'='
string|"'x86_64'"
newline|'\n'
name|'inst'
op|'['
string|"'os_type'"
op|']'
op|'='
string|"'Linux'"
newline|'\n'
nl|'\n'
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'db'
op|'.'
name|'instance_create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'inst'
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'ComputeHostNotFound'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'evacuate'
op|','
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|','
name|'instance'
op|','
nl|'\n'
name|'host'
op|'='
string|"'fake_dest_host'"
op|','
name|'on_shared_storage'
op|'='
name|'True'
op|','
nl|'\n'
name|'admin_password'
op|'='
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_fail_evacuate_from_running_host
dedent|''
name|'def'
name|'test_fail_evacuate_from_running_host'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
name|'services'
op|'='
name|'True'
op|')'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get_by_uuid'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'instance'
op|'['
string|"'task_state'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_service_is_up
name|'def'
name|'fake_service_is_up'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'servicegroup_api'
op|','
string|"'service_is_up'"
op|','
nl|'\n'
name|'fake_service_is_up'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'ComputeServiceInUse'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'evacuate'
op|','
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
op|')'
op|','
name|'instance'
op|','
nl|'\n'
name|'host'
op|'='
string|"'fake_dest_host'"
op|','
name|'on_shared_storage'
op|'='
name|'True'
op|','
nl|'\n'
name|'admin_password'
op|'='
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_fail_evacuate_instance_in_wrong_state
dedent|''
name|'def'
name|'test_fail_evacuate_instance_in_wrong_state'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instances'
op|'='
op|'['
nl|'\n'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'BUILDING'
op|'}'
op|')'
op|')'
op|','
nl|'\n'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'PAUSED'
op|'}'
op|')'
op|')'
op|','
nl|'\n'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'SUSPENDED'
op|'}'
op|')'
op|')'
op|','
nl|'\n'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'RESCUED'
op|'}'
op|')'
op|')'
op|','
nl|'\n'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'RESIZED'
op|'}'
op|')'
op|')'
op|','
nl|'\n'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'SOFT_DELETED'
op|'}'
op|')'
op|')'
op|','
nl|'\n'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'DELETED'
op|'}'
op|')'
op|')'
op|','
nl|'\n'
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
nl|'\n'
op|'{'
string|"'vm_state'"
op|':'
name|'vm_states'
op|'.'
name|'ERROR'
op|'}'
op|')'
op|')'
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
name|'for'
name|'instance'
name|'in'
name|'instances'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceInvalidState'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'evacuate'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'host'
op|'='
string|"'fake_dest_host'"
op|','
name|'on_shared_storage'
op|'='
name|'True'
op|','
nl|'\n'
name|'admin_password'
op|'='
name|'None'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_migrations
dedent|''
dedent|''
name|'def'
name|'test_get_migrations'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'migration'
op|'='
name|'test_migration'
op|'.'
name|'fake_db_migration'
op|'('
name|'uuid'
op|'='
string|'"1234"'
op|')'
newline|'\n'
name|'filters'
op|'='
op|'{'
string|"'host'"
op|':'
string|"'host1'"
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'db'
op|','
string|'"migration_get_all_by_filters"'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'migration_get_all_by_filters'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'filters'
op|')'
op|'.'
name|'AndReturn'
op|'('
op|'['
name|'migration'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'migrations'
op|'='
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_migrations'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'filters'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'len'
op|'('
name|'migrations'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'migrations'
op|'['
number|'0'
op|']'
op|'.'
name|'id'
op|','
name|'migration'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_setup_get_instance_bdm_mox
dedent|''
name|'def'
name|'_setup_get_instance_bdm_mox'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'new_bdm'
op|'='
name|'object'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'db'
op|','
nl|'\n'
string|"'block_device_mapping_get_all_by_instance'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'db'
op|'.'
name|'block_device_mapping_get_all_by_instance'
op|'('
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'new_bdm'
op|')'
newline|'\n'
name|'return'
name|'new_bdm'
newline|'\n'
nl|'\n'
DECL|member|test_get_instance_bdms_legacy
dedent|''
name|'def'
name|'test_get_instance_bdms_legacy'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'expected'
op|'='
name|'self'
op|'.'
name|'_setup_get_instance_bdm_mox'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
op|'{'
string|"'uuid'"
op|':'
string|"'fake-instance'"
op|'}'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_instance_bdms'
op|'('
op|'{'
op|'}'
op|','
nl|'\n'
name|'instance'
op|','
name|'legacy'
op|'='
name|'False'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_instance_bdms_default
dedent|''
name|'def'
name|'test_get_instance_bdms_default'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'new_bdm'
op|'='
name|'self'
op|'.'
name|'_setup_get_instance_bdm_mox'
op|'('
op|')'
newline|'\n'
name|'expected'
op|'='
name|'legacy_bdm'
op|'='
name|'object'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'block_device'
op|','
string|"'legacy_mapping'"
op|')'
newline|'\n'
name|'block_device'
op|'.'
name|'legacy_mapping'
op|'('
name|'new_bdm'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'legacy_bdm'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instance'
op|'='
op|'{'
string|"'uuid'"
op|':'
string|"'fake-instance'"
op|'}'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_instance_bdms'
op|'('
op|'{'
op|'}'
op|','
name|'instance'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|fake_rpc_method
dedent|''
dedent|''
name|'def'
name|'fake_rpc_method'
op|'('
name|'context'
op|','
name|'topic'
op|','
name|'msg'
op|','
name|'do_cast'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'pass'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|_create_service_entries
dedent|''
name|'def'
name|'_create_service_entries'
op|'('
name|'context'
op|','
name|'values'
op|'='
op|'{'
string|"'avail_zone1'"
op|':'
op|'['
string|"'fake_host1'"
op|','
nl|'\n'
string|"'fake_host2'"
op|']'
op|','
nl|'\n'
string|"'avail_zone2'"
op|':'
op|'['
string|"'fake_host3'"
op|']'
op|','
op|'}'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'for'
name|'avail_zone'
op|','
name|'hosts'
name|'in'
name|'values'
op|'.'
name|'iteritems'
op|'('
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'host'
name|'in'
name|'hosts'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'service_create'
op|'('
name|'context'
op|','
nl|'\n'
op|'{'
string|"'host'"
op|':'
name|'host'
op|','
nl|'\n'
string|"'binary'"
op|':'
string|"'nova-compute'"
op|','
nl|'\n'
string|"'topic'"
op|':'
string|"'compute'"
op|','
nl|'\n'
string|"'report_count'"
op|':'
number|'0'
op|'}'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'values'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ComputeAPIAggrTestCase
dedent|''
name|'class'
name|'ComputeAPIAggrTestCase'
op|'('
name|'BaseTestCase'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""This is for unit coverage of aggregate-related methods\n    defined in nova.compute.api.\n    """'
newline|'\n'
nl|'\n'
DECL|member|setUp
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'ComputeAPIAggrTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'api'
op|'='
name|'compute_api'
op|'.'
name|'AggregateAPI'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'context'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'rpc'
op|','
string|"'call'"
op|','
name|'fake_rpc_method'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'rpc'
op|','
string|"'cast'"
op|','
name|'fake_rpc_method'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_aggregate_no_zone
dedent|''
name|'def'
name|'test_aggregate_no_zone'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure we can create an aggregate without an availability  zone'
nl|'\n'
indent|'        '
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'fake_aggregate'"
op|','
nl|'\n'
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'api'
op|'.'
name|'delete_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'aggr'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'aggregate_get'
op|'('
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
name|'read_deleted'
op|'='
string|"'yes'"
op|')'
op|','
nl|'\n'
name|'aggr'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'AggregateNotFound'
op|','
nl|'\n'
name|'self'
op|'.'
name|'api'
op|'.'
name|'delete_aggregate'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'aggr'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_update_aggregate
dedent|''
name|'def'
name|'test_update_aggregate'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure metadata can be updated.'
nl|'\n'
indent|'        '
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'fake_aggregate'"
op|','
nl|'\n'
string|"'fake_zone'"
op|')'
newline|'\n'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'update_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'aggr'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
op|'{'
string|"'name'"
op|':'
string|"'new_fake_aggregate'"
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'availability_zones'
op|'.'
name|'_get_cache'
op|'('
op|')'
op|'.'
name|'get'
op|'('
string|"'cache'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'aggregate.updateprop.start'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'aggregate.updateprop.end'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_update_aggregate_metadata
dedent|''
name|'def'
name|'test_update_aggregate_metadata'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure metadata can be updated.'
nl|'\n'
indent|'        '
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'fake_aggregate'"
op|','
nl|'\n'
string|"'fake_zone'"
op|')'
newline|'\n'
name|'metadata'
op|'='
op|'{'
string|"'foo_key1'"
op|':'
string|"'foo_value1'"
op|','
nl|'\n'
string|"'foo_key2'"
op|':'
string|"'foo_value2'"
op|','
op|'}'
newline|'\n'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'update_aggregate_metadata'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'aggr'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'metadata'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'aggregate.updatemetadata.start'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'aggregate.updatemetadata.end'"
op|')'
newline|'\n'
name|'metadata'
op|'['
string|"'foo_key1'"
op|']'
op|'='
name|'None'
newline|'\n'
name|'expected'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'update_aggregate_metadata'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'aggr'
op|'['
string|"'id'"
op|']'
op|','
name|'metadata'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertThat'
op|'('
name|'expected'
op|'['
string|"'metadata'"
op|']'
op|','
nl|'\n'
name|'matchers'
op|'.'
name|'DictMatches'
op|'('
op|'{'
string|"'availability_zone'"
op|':'
string|"'fake_zone'"
op|','
nl|'\n'
string|"'foo_key2'"
op|':'
string|"'foo_value2'"
op|'}'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_delete_aggregate
dedent|''
name|'def'
name|'test_delete_aggregate'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure we can delete an aggregate.'
nl|'\n'
indent|'        '
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'fake_aggregate'"
op|','
nl|'\n'
string|"'fake_zone'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'aggregate.create.start'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'aggregate.create.end'"
op|')'
newline|'\n'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
name|'self'
op|'.'
name|'api'
op|'.'
name|'delete_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'aggr'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'aggregate.delete.start'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'aggregate.delete.end'"
op|')'
newline|'\n'
name|'db'
op|'.'
name|'aggregate_get'
op|'('
name|'self'
op|'.'
name|'context'
op|'.'
name|'elevated'
op|'('
name|'read_deleted'
op|'='
string|"'yes'"
op|')'
op|','
nl|'\n'
name|'aggr'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'AggregateNotFound'
op|','
nl|'\n'
name|'self'
op|'.'
name|'api'
op|'.'
name|'delete_aggregate'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'aggr'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_delete_non_empty_aggregate
dedent|''
name|'def'
name|'test_delete_non_empty_aggregate'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure InvalidAggregateAction is raised when non empty aggregate.'
nl|'\n'
indent|'        '
name|'_create_service_entries'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
op|'{'
string|"'fake_availability_zone'"
op|':'
op|'['
string|"'fake_host'"
op|']'
op|'}'
op|')'
newline|'\n'
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'fake_aggregate'"
op|','
nl|'\n'
string|"'fake_availability_zone'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'api'
op|'.'
name|'add_host_to_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'aggr'
op|'['
string|"'id'"
op|']'
op|','
string|"'fake_host'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InvalidAggregateAction'
op|','
nl|'\n'
name|'self'
op|'.'
name|'api'
op|'.'
name|'delete_aggregate'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'aggr'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_host_to_aggregate
dedent|''
name|'def'
name|'test_add_host_to_aggregate'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure we can add a host to an aggregate.'
nl|'\n'
indent|'        '
name|'values'
op|'='
name|'_create_service_entries'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'fake_zone'
op|'='
name|'values'
op|'.'
name|'keys'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'fake_host'
op|'='
name|'values'
op|'['
name|'fake_zone'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
string|"'fake_aggregate'"
op|','
name|'fake_zone'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_add_aggregate_host
name|'def'
name|'fake_add_aggregate_host'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'hosts'
op|'='
name|'kwargs'
op|'['
string|'"aggregate"'
op|']'
op|'['
string|'"hosts"'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'fake_host'
op|','
name|'hosts'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'api'
op|'.'
name|'compute_rpcapi'
op|','
string|"'add_aggregate_host'"
op|','
nl|'\n'
name|'fake_add_aggregate_host'
op|')'
newline|'\n'
nl|'\n'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'add_host_to_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'aggr'
op|'['
string|"'id'"
op|']'
op|','
name|'fake_host'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'aggregate.addhost.start'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'aggregate.addhost.end'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'aggr'
op|'['
string|"'hosts'"
op|']'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_host_to_aggr_with_no_az
dedent|''
name|'def'
name|'test_add_host_to_aggr_with_no_az'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'values'
op|'='
name|'_create_service_entries'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'fake_zone'
op|'='
name|'values'
op|'.'
name|'keys'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'fake_host'
op|'='
name|'values'
op|'['
name|'fake_zone'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
string|"'fake_aggregate'"
op|','
name|'fake_zone'
op|')'
newline|'\n'
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'add_host_to_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'aggr'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'fake_host'
op|')'
newline|'\n'
name|'aggr_no_az'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'fake_aggregate2'"
op|','
nl|'\n'
name|'None'
op|')'
newline|'\n'
name|'aggr_no_az'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'add_host_to_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'aggr_no_az'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'fake_host'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'fake_host'
op|','
name|'aggr'
op|'['
string|"'hosts'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'fake_host'
op|','
name|'aggr_no_az'
op|'['
string|"'hosts'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_host_no_az_metadata
dedent|''
name|'def'
name|'test_add_host_no_az_metadata'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# NOTE(mtreinish) based on how create works this is not how the'
nl|'\n'
comment|'# the metadata is supposed to end up in the database but it has'
nl|'\n'
comment|'# been seen. See lp bug #1209007. This test just confirms that'
nl|'\n'
comment|'# the host is still added to the aggregate if there is no'
nl|'\n'
comment|'# availability zone metadata.'
nl|'\n'
DECL|function|fake_aggregate_metadata_get_by_metadata_key
indent|'        '
name|'def'
name|'fake_aggregate_metadata_get_by_metadata_key'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'meta_key'"
op|':'
string|"'fake_value'"
op|'}'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'db'
op|','
nl|'\n'
string|"'aggregate_metadata_get_by_metadata_key'"
op|','
nl|'\n'
name|'fake_aggregate_metadata_get_by_metadata_key'
op|')'
newline|'\n'
name|'values'
op|'='
name|'_create_service_entries'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'fake_zone'
op|'='
name|'values'
op|'.'
name|'keys'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'fake_host'
op|'='
name|'values'
op|'['
name|'fake_zone'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'fake_aggregate'"
op|','
nl|'\n'
name|'fake_zone'
op|')'
newline|'\n'
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'add_host_to_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'aggr'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'fake_host'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'fake_host'
op|','
name|'aggr'
op|'['
string|"'hosts'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_host_to_multi_az
dedent|''
name|'def'
name|'test_add_host_to_multi_az'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|"# Ensure we can't add a host to different availability zone"
nl|'\n'
indent|'        '
name|'values'
op|'='
name|'_create_service_entries'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'fake_zone'
op|'='
name|'values'
op|'.'
name|'keys'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'fake_host'
op|'='
name|'values'
op|'['
name|'fake_zone'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
string|"'fake_aggregate'"
op|','
name|'fake_zone'
op|')'
newline|'\n'
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'add_host_to_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'aggr'
op|'['
string|"'id'"
op|']'
op|','
name|'fake_host'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'aggr'
op|'['
string|"'hosts'"
op|']'
op|')'
op|','
number|'1'
op|')'
newline|'\n'
name|'fake_zone2'
op|'='
string|'"another_zone"'
newline|'\n'
name|'aggr2'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
string|"'fake_aggregate2'"
op|','
name|'fake_zone2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InvalidAggregateAction'
op|','
nl|'\n'
name|'self'
op|'.'
name|'api'
op|'.'
name|'add_host_to_aggregate'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'aggr2'
op|'['
string|"'id'"
op|']'
op|','
name|'fake_host'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_host_to_aggregate_multiple
dedent|''
name|'def'
name|'test_add_host_to_aggregate_multiple'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure we can add multiple hosts to an aggregate.'
nl|'\n'
indent|'        '
name|'values'
op|'='
name|'_create_service_entries'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'fake_zone'
op|'='
name|'values'
op|'.'
name|'keys'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
string|"'fake_aggregate'"
op|','
name|'fake_zone'
op|')'
newline|'\n'
name|'for'
name|'host'
name|'in'
name|'values'
op|'['
name|'fake_zone'
op|']'
op|':'
newline|'\n'
indent|'            '
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'add_host_to_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'aggr'
op|'['
string|"'id'"
op|']'
op|','
name|'host'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'aggr'
op|'['
string|"'hosts'"
op|']'
op|')'
op|','
name|'len'
op|'('
name|'values'
op|'['
name|'fake_zone'
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_host_to_aggregate_raise_not_found
dedent|''
name|'def'
name|'test_add_host_to_aggregate_raise_not_found'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure ComputeHostNotFound is raised when adding invalid host.'
nl|'\n'
indent|'        '
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'fake_aggregate'"
op|','
nl|'\n'
string|"'fake_zone'"
op|')'
newline|'\n'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'ComputeHostNotFound'
op|','
nl|'\n'
name|'self'
op|'.'
name|'api'
op|'.'
name|'add_host_to_aggregate'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'aggr'
op|'['
string|"'id'"
op|']'
op|','
string|"'invalid_host'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
op|'.'
name|'publisher_id'
op|','
nl|'\n'
string|"'compute.fake-mini'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_host_from_aggregate_active
dedent|''
name|'def'
name|'test_remove_host_from_aggregate_active'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure we can remove a host from an aggregate.'
nl|'\n'
indent|'        '
name|'values'
op|'='
name|'_create_service_entries'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'fake_zone'
op|'='
name|'values'
op|'.'
name|'keys'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
string|"'fake_aggregate'"
op|','
name|'fake_zone'
op|')'
newline|'\n'
name|'for'
name|'host'
name|'in'
name|'values'
op|'['
name|'fake_zone'
op|']'
op|':'
newline|'\n'
indent|'            '
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'add_host_to_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'aggr'
op|'['
string|"'id'"
op|']'
op|','
name|'host'
op|')'
newline|'\n'
dedent|''
name|'host_to_remove'
op|'='
name|'values'
op|'['
name|'fake_zone'
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
DECL|function|fake_remove_aggregate_host
name|'def'
name|'fake_remove_aggregate_host'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'hosts'
op|'='
name|'kwargs'
op|'['
string|'"aggregate"'
op|']'
op|'['
string|'"hosts"'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertNotIn'
op|'('
name|'host_to_remove'
op|','
name|'hosts'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'api'
op|'.'
name|'compute_rpcapi'
op|','
string|"'remove_aggregate_host'"
op|','
nl|'\n'
name|'fake_remove_aggregate_host'
op|')'
newline|'\n'
nl|'\n'
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'='
op|'['
op|']'
newline|'\n'
name|'expected'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'remove_host_from_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'aggr'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'host_to_remove'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'aggregate.removehost.start'"
op|')'
newline|'\n'
name|'msg'
op|'='
name|'fake_notifier'
op|'.'
name|'NOTIFICATIONS'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'msg'
op|'.'
name|'event_type'
op|','
nl|'\n'
string|"'aggregate.removehost.end'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'aggr'
op|'['
string|"'hosts'"
op|']'
op|')'
op|'-'
number|'1'
op|','
name|'len'
op|'('
name|'expected'
op|'['
string|"'hosts'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_host_from_aggregate_raise_not_found
dedent|''
name|'def'
name|'test_remove_host_from_aggregate_raise_not_found'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Ensure ComputeHostNotFound is raised when removing invalid host.'
nl|'\n'
indent|'        '
name|'_create_service_entries'
op|'('
name|'self'
op|'.'
name|'context'
op|','
op|'{'
string|"'fake_zone'"
op|':'
op|'['
string|"'fake_host'"
op|']'
op|'}'
op|')'
newline|'\n'
name|'aggr'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'fake_aggregate'"
op|','
nl|'\n'
string|"'fake_zone'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'ComputeHostNotFound'
op|','
nl|'\n'
name|'self'
op|'.'
name|'api'
op|'.'
name|'remove_host_from_aggregate'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'aggr'
op|'['
string|"'id'"
op|']'
op|','
string|"'invalid_host'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_aggregate_list
dedent|''
name|'def'
name|'test_aggregate_list'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'aggregate'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
string|"'fake_aggregate'"
op|','
nl|'\n'
string|"'fake_zone'"
op|')'
newline|'\n'
name|'metadata'
op|'='
op|'{'
string|"'foo_key1'"
op|':'
string|"'foo_value1'"
op|','
nl|'\n'
string|"'foo_key2'"
op|':'
string|"'foo_value2'"
op|'}'
newline|'\n'
name|'meta_aggregate'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
string|"'fake_aggregate2'"
op|','
nl|'\n'
string|"'fake_zone2'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'api'
op|'.'
name|'update_aggregate_metadata'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'meta_aggregate'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'metadata'
op|')'
newline|'\n'
name|'aggregate_list'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'get_aggregate_list'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'aggregate'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'map'
op|'('
name|'lambda'
name|'x'
op|':'
name|'x'
op|'['
string|"'id'"
op|']'
op|','
name|'aggregate_list'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'meta_aggregate'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'map'
op|'('
name|'lambda'
name|'x'
op|':'
name|'x'
op|'['
string|"'id'"
op|']'
op|','
name|'aggregate_list'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'fake_aggregate'"
op|','
nl|'\n'
name|'map'
op|'('
name|'lambda'
name|'x'
op|':'
name|'x'
op|'['
string|"'name'"
op|']'
op|','
name|'aggregate_list'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'fake_aggregate2'"
op|','
nl|'\n'
name|'map'
op|'('
name|'lambda'
name|'x'
op|':'
name|'x'
op|'['
string|"'name'"
op|']'
op|','
name|'aggregate_list'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'fake_zone'"
op|','
nl|'\n'
name|'map'
op|'('
name|'lambda'
name|'x'
op|':'
name|'x'
op|'['
string|"'availability_zone'"
op|']'
op|','
name|'aggregate_list'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'fake_zone2'"
op|','
nl|'\n'
name|'map'
op|'('
name|'lambda'
name|'x'
op|':'
name|'x'
op|'['
string|"'availability_zone'"
op|']'
op|','
name|'aggregate_list'
op|')'
op|')'
newline|'\n'
name|'test_meta_aggregate'
op|'='
name|'aggregate_list'
op|'['
number|'1'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'foo_key1'"
op|','
name|'test_meta_aggregate'
op|'.'
name|'get'
op|'('
string|"'metadata'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
string|"'foo_key2'"
op|','
name|'test_meta_aggregate'
op|'.'
name|'get'
op|'('
string|"'metadata'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'foo_value1'"
op|','
nl|'\n'
name|'test_meta_aggregate'
op|'.'
name|'get'
op|'('
string|"'metadata'"
op|')'
op|'['
string|"'foo_key1'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'foo_value2'"
op|','
nl|'\n'
name|'test_meta_aggregate'
op|'.'
name|'get'
op|'('
string|"'metadata'"
op|')'
op|'['
string|"'foo_key2'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_aggregate_list_with_hosts
dedent|''
name|'def'
name|'test_aggregate_list_with_hosts'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'values'
op|'='
name|'_create_service_entries'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'fake_zone'
op|'='
name|'values'
op|'.'
name|'keys'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'host_aggregate'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'create_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
string|"'fake_aggregate'"
op|','
nl|'\n'
name|'fake_zone'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'api'
op|'.'
name|'add_host_to_aggregate'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'host_aggregate'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'values'
op|'['
name|'fake_zone'
op|']'
op|'['
number|'0'
op|']'
op|')'
newline|'\n'
name|'aggregate_list'
op|'='
name|'self'
op|'.'
name|'api'
op|'.'
name|'get_aggregate_list'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
name|'aggregate'
op|'='
name|'aggregate_list'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'assertIn'
op|'('
name|'values'
op|'['
name|'fake_zone'
op|']'
op|'['
number|'0'
op|']'
op|','
name|'aggregate'
op|'.'
name|'get'
op|'('
string|"'hosts'"
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ComputeAggrTestCase
dedent|''
dedent|''
name|'class'
name|'ComputeAggrTestCase'
op|'('
name|'BaseTestCase'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""This is for unit coverage of aggregate-related methods\n    defined in nova.compute.manager.\n    """'
newline|'\n'
nl|'\n'
DECL|member|setUp
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'ComputeAggrTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'context'
op|'='
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'values'
op|'='
op|'{'
string|"'name'"
op|':'
string|"'test_aggr'"
op|'}'
newline|'\n'
name|'az'
op|'='
op|'{'
string|"'availability_zone'"
op|':'
string|"'test_zone'"
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'aggr'
op|'='
name|'db'
op|'.'
name|'aggregate_create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'values'
op|','
name|'metadata'
op|'='
name|'az'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_aggregate_host
dedent|''
name|'def'
name|'test_add_aggregate_host'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|fake_driver_add_to_aggregate
indent|'        '
name|'def'
name|'fake_driver_add_to_aggregate'
op|'('
name|'context'
op|','
name|'aggregate'
op|','
name|'host'
op|','
op|'**'
name|'_ignore'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'fake_driver_add_to_aggregate'
op|'.'
name|'called'
op|'='
name|'True'
newline|'\n'
name|'return'
op|'{'
string|'"foo"'
op|':'
string|'"bar"'
op|'}'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|'"add_to_aggregate"'
op|','
nl|'\n'
name|'fake_driver_add_to_aggregate'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'add_aggregate_host'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'host'
op|'='
string|'"host"'
op|','
nl|'\n'
name|'aggregate'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'aggr'
op|')'
op|','
name|'slave_info'
op|'='
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'fake_driver_add_to_aggregate'
op|'.'
name|'called'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_aggregate_host
dedent|''
name|'def'
name|'test_remove_aggregate_host'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|fake_driver_remove_from_aggregate
indent|'        '
name|'def'
name|'fake_driver_remove_from_aggregate'
op|'('
name|'context'
op|','
name|'aggregate'
op|','
name|'host'
op|','
nl|'\n'
op|'**'
name|'_ignore'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'fake_driver_remove_from_aggregate'
op|'.'
name|'called'
op|'='
name|'True'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|'"host"'
op|','
name|'host'
op|','
string|'"host"'
op|')'
newline|'\n'
name|'return'
op|'{'
string|'"foo"'
op|':'
string|'"bar"'
op|'}'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|'"remove_from_aggregate"'
op|','
nl|'\n'
name|'fake_driver_remove_from_aggregate'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'remove_aggregate_host'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'aggregate'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'aggr'
op|')'
op|','
name|'host'
op|'='
string|'"host"'
op|','
nl|'\n'
name|'slave_info'
op|'='
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'fake_driver_remove_from_aggregate'
op|'.'
name|'called'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_add_aggregate_host_passes_slave_info_to_driver
dedent|''
name|'def'
name|'test_add_aggregate_host_passes_slave_info_to_driver'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|driver_add_to_aggregate
indent|'        '
name|'def'
name|'driver_add_to_aggregate'
op|'('
name|'context'
op|','
name|'aggregate'
op|','
name|'host'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'context'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'aggregate'
op|'['
string|"'id'"
op|']'
op|','
name|'self'
op|'.'
name|'aggr'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'host'
op|','
string|'"the_host"'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|'"SLAVE_INFO"'
op|','
name|'kwargs'
op|'.'
name|'get'
op|'('
string|'"slave_info"'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|'"add_to_aggregate"'
op|','
nl|'\n'
name|'driver_add_to_aggregate'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'add_aggregate_host'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'host'
op|'='
string|'"the_host"'
op|','
nl|'\n'
name|'slave_info'
op|'='
string|'"SLAVE_INFO"'
op|','
nl|'\n'
name|'aggregate'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'aggr'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_from_aggregate_passes_slave_info_to_driver
dedent|''
name|'def'
name|'test_remove_from_aggregate_passes_slave_info_to_driver'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|driver_remove_from_aggregate
indent|'        '
name|'def'
name|'driver_remove_from_aggregate'
op|'('
name|'context'
op|','
name|'aggregate'
op|','
name|'host'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'context'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'aggregate'
op|'['
string|"'id'"
op|']'
op|','
name|'self'
op|'.'
name|'aggr'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'host'
op|','
string|'"the_host"'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|'"SLAVE_INFO"'
op|','
name|'kwargs'
op|'.'
name|'get'
op|'('
string|'"slave_info"'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|'"remove_from_aggregate"'
op|','
nl|'\n'
name|'driver_remove_from_aggregate'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'remove_aggregate_host'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'aggregate'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'aggr'
op|')'
op|','
name|'host'
op|'='
string|'"the_host"'
op|','
nl|'\n'
name|'slave_info'
op|'='
string|'"SLAVE_INFO"'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ComputePolicyTestCase
dedent|''
dedent|''
name|'class'
name|'ComputePolicyTestCase'
op|'('
name|'BaseTestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'ComputePolicyTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'='
name|'compute'
op|'.'
name|'API'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_actions_are_prefixed
dedent|''
name|'def'
name|'test_actions_are_prefixed'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'policy'
op|','
string|"'enforce'"
op|')'
newline|'\n'
name|'nova'
op|'.'
name|'policy'
op|'.'
name|'enforce'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'compute:reboot'"
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'compute_api'
op|'.'
name|'check_policy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
string|"'reboot'"
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_wrapped_method
dedent|''
name|'def'
name|'test_wrapped_method'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
name|'params'
op|'='
op|'{'
string|"'host'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'cell_name'"
op|':'
string|"'foo'"
op|'}'
op|')'
newline|'\n'
nl|'\n'
comment|'# force delete to fail'
nl|'\n'
name|'rules'
op|'='
op|'{'
string|'"compute:delete"'
op|':'
op|'['
op|'['
string|'"false:false"'
op|']'
op|']'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'policy'
op|'.'
name|'set_rules'
op|'('
name|'rules'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'PolicyNotAuthorized'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'delete'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
comment|'# reset rules to allow deletion'
nl|'\n'
name|'rules'
op|'='
op|'{'
string|'"compute:delete"'
op|':'
op|'['
op|']'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'policy'
op|'.'
name|'set_rules'
op|'('
name|'rules'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'delete'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_fail
dedent|''
name|'def'
name|'test_create_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rules'
op|'='
op|'{'
string|'"compute:create"'
op|':'
op|'['
op|'['
string|'"false:false"'
op|']'
op|']'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'policy'
op|'.'
name|'set_rules'
op|'('
name|'rules'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'PolicyNotAuthorized'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|','
name|'self'
op|'.'
name|'context'
op|','
string|"'1'"
op|','
string|"'1'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_attach_volume_fail
dedent|''
name|'def'
name|'test_create_attach_volume_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rules'
op|'='
op|'{'
nl|'\n'
string|'"compute:create"'
op|':'
op|'['
op|']'
op|','
nl|'\n'
string|'"compute:create:attach_network"'
op|':'
op|'['
op|'['
string|'"false:false"'
op|']'
op|']'
op|','
nl|'\n'
string|'"compute:create:attach_volume"'
op|':'
op|'['
op|']'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'policy'
op|'.'
name|'set_rules'
op|'('
name|'rules'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'PolicyNotAuthorized'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|','
name|'self'
op|'.'
name|'context'
op|','
string|"'1'"
op|','
string|"'1'"
op|','
nl|'\n'
name|'requested_networks'
op|'='
string|"'blah'"
op|','
nl|'\n'
name|'block_device_mapping'
op|'='
string|"'blah'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_attach_network_fail
dedent|''
name|'def'
name|'test_create_attach_network_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rules'
op|'='
op|'{'
nl|'\n'
string|'"compute:create"'
op|':'
op|'['
op|']'
op|','
nl|'\n'
string|'"compute:create:attach_network"'
op|':'
op|'['
op|']'
op|','
nl|'\n'
string|'"compute:create:attach_volume"'
op|':'
op|'['
op|'['
string|'"false:false"'
op|']'
op|']'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'policy'
op|'.'
name|'set_rules'
op|'('
name|'rules'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'PolicyNotAuthorized'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|','
name|'self'
op|'.'
name|'context'
op|','
string|"'1'"
op|','
string|"'1'"
op|','
nl|'\n'
name|'requested_networks'
op|'='
string|"'blah'"
op|','
nl|'\n'
name|'block_device_mapping'
op|'='
string|"'blah'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_fail
dedent|''
name|'def'
name|'test_get_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'rules'
op|'='
op|'{'
nl|'\n'
string|'"compute:get"'
op|':'
op|'['
op|'['
string|'"false:false"'
op|']'
op|']'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'policy'
op|'.'
name|'set_rules'
op|'('
name|'rules'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'PolicyNotAuthorized'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_all_fail
dedent|''
name|'def'
name|'test_get_all_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rules'
op|'='
op|'{'
nl|'\n'
string|'"compute:get_all"'
op|':'
op|'['
op|'['
string|'"false:false"'
op|']'
op|']'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'policy'
op|'.'
name|'set_rules'
op|'('
name|'rules'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'PolicyNotAuthorized'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_all'
op|','
name|'self'
op|'.'
name|'context'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_get_instance_faults
dedent|''
name|'def'
name|'test_get_instance_faults'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance1'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'instance2'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'instances'
op|'='
op|'['
name|'instance1'
op|','
name|'instance2'
op|']'
newline|'\n'
nl|'\n'
name|'rules'
op|'='
op|'{'
nl|'\n'
string|'"compute:get_instance_faults"'
op|':'
op|'['
op|'['
string|'"false:false"'
op|']'
op|']'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'policy'
op|'.'
name|'set_rules'
op|'('
name|'rules'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'PolicyNotAuthorized'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'get_instance_faults'
op|','
nl|'\n'
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
op|','
name|'instances'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_force_host_fail
dedent|''
name|'def'
name|'test_force_host_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rules'
op|'='
op|'{'
string|'"compute:create"'
op|':'
op|'['
op|']'
op|','
nl|'\n'
string|'"compute:create:forced_host"'
op|':'
op|'['
op|'['
string|'"role:fake"'
op|']'
op|']'
op|','
nl|'\n'
string|'"network:validate_networks"'
op|':'
op|'['
op|']'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'policy'
op|'.'
name|'set_rules'
op|'('
name|'rules'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'PolicyNotAuthorized'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'None'
op|','
string|"'1'"
op|','
nl|'\n'
name|'availability_zone'
op|'='
string|"'1:1'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_force_host_pass
dedent|''
name|'def'
name|'test_force_host_pass'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'rules'
op|'='
op|'{'
string|'"compute:create"'
op|':'
op|'['
op|']'
op|','
nl|'\n'
string|'"compute:create:forced_host"'
op|':'
op|'['
op|']'
op|','
nl|'\n'
string|'"network:validate_networks"'
op|':'
op|'['
op|']'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'policy'
op|'.'
name|'set_rules'
op|'('
name|'rules'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'None'
op|','
string|"'1'"
op|','
nl|'\n'
name|'availability_zone'
op|'='
string|"'1:1'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|DisabledInstanceTypesTestCase
dedent|''
dedent|''
name|'class'
name|'DisabledInstanceTypesTestCase'
op|'('
name|'BaseTestCase'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Some instance-types are marked \'disabled\' which means that they will not\n    show up in customer-facing listings. We do, however, want those\n    instance-types to be available for emergency migrations and for rebuilding\n    of existing instances.\n\n    One legitimate use of the \'disabled\' field would be when phasing out a\n    particular instance-type. We still want customers to be able to use an\n    instance that of the old type, and we want Ops to be able perform\n    migrations against it, but we *don\'t* want customers building new slices\n    with ths phased-out instance-type.\n    """'
newline|'\n'
DECL|member|setUp
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'DisabledInstanceTypesTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'='
name|'compute'
op|'.'
name|'API'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'inst_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_can_build_instance_from_visible_instance_type
dedent|''
name|'def'
name|'test_can_build_instance_from_visible_instance_type'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'inst_type'
op|'['
string|"'disabled'"
op|']'
op|'='
name|'False'
newline|'\n'
comment|'# Assert that exception.FlavorNotFound is not raised'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'inst_type'
op|','
nl|'\n'
name|'image_href'
op|'='
string|"'some-fake-image'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_cannot_build_instance_from_disabled_instance_type
dedent|''
name|'def'
name|'test_cannot_build_instance_from_disabled_instance_type'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'inst_type'
op|'['
string|"'disabled'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'FlavorNotFound'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'inst_type'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_can_resize_to_visible_instance_type
dedent|''
name|'def'
name|'test_can_resize_to_visible_instance_type'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'orig_get_flavor_by_flavor_id'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_flavor_id'
newline|'\n'
nl|'\n'
DECL|function|fake_get_flavor_by_flavor_id
name|'def'
name|'fake_get_flavor_by_flavor_id'
op|'('
name|'flavor_id'
op|','
name|'ctxt'
op|'='
name|'None'
op|','
nl|'\n'
name|'read_deleted'
op|'='
string|'"yes"'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'instance_type'
op|'='
name|'orig_get_flavor_by_flavor_id'
op|'('
name|'flavor_id'
op|','
nl|'\n'
name|'ctxt'
op|','
nl|'\n'
name|'read_deleted'
op|')'
newline|'\n'
name|'instance_type'
op|'['
string|"'disabled'"
op|']'
op|'='
name|'False'
newline|'\n'
name|'return'
name|'instance_type'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'flavors'
op|','
string|"'get_flavor_by_flavor_id'"
op|','
nl|'\n'
name|'fake_get_flavor_by_flavor_id'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_stub_migrate_server'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
string|"'4'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_cannot_resize_to_disabled_instance_type
dedent|''
name|'def'
name|'test_cannot_resize_to_disabled_instance_type'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'orig_get_flavor_by_flavor_id'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_flavor_id'
newline|'\n'
nl|'\n'
DECL|function|fake_get_flavor_by_flavor_id
name|'def'
name|'fake_get_flavor_by_flavor_id'
op|'('
name|'flavor_id'
op|','
name|'ctxt'
op|'='
name|'None'
op|','
nl|'\n'
name|'read_deleted'
op|'='
string|'"yes"'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'instance_type'
op|'='
name|'orig_get_flavor_by_flavor_id'
op|'('
name|'flavor_id'
op|','
nl|'\n'
name|'ctxt'
op|','
nl|'\n'
name|'read_deleted'
op|')'
newline|'\n'
name|'instance_type'
op|'['
string|"'disabled'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'return'
name|'instance_type'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'flavors'
op|','
string|"'get_flavor_by_flavor_id'"
op|','
nl|'\n'
name|'fake_get_flavor_by_flavor_id'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'FlavorNotFound'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'resize'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'instance'
op|','
string|"'4'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ComputeReschedulingTestCase
dedent|''
dedent|''
name|'class'
name|'ComputeReschedulingTestCase'
op|'('
name|'BaseTestCase'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Tests re-scheduling logic for new build requests."""'
newline|'\n'
nl|'\n'
DECL|member|setUp
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'ComputeReschedulingTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'expected_task_state'
op|'='
name|'task_states'
op|'.'
name|'SCHEDULING'
newline|'\n'
nl|'\n'
DECL|function|fake_update
name|'def'
name|'fake_update'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'updated_task_state'
op|'='
name|'kwargs'
op|'.'
name|'get'
op|'('
string|"'task_state'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_instance_update'"
op|','
name|'fake_update'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_reschedule
dedent|''
name|'def'
name|'_reschedule'
op|'('
name|'self'
op|','
name|'request_spec'
op|'='
name|'None'
op|','
name|'filter_properties'
op|'='
name|'None'
op|','
nl|'\n'
name|'exc_info'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'filter_properties'
op|':'
newline|'\n'
indent|'            '
name|'filter_properties'
op|'='
op|'{'
op|'}'
newline|'\n'
nl|'\n'
dedent|''
name|'instance_uuid'
op|'='
string|'"12-34-56-78-90"'
newline|'\n'
nl|'\n'
name|'admin_password'
op|'='
name|'None'
newline|'\n'
name|'injected_files'
op|'='
name|'None'
newline|'\n'
name|'requested_networks'
op|'='
name|'None'
newline|'\n'
name|'is_first_time'
op|'='
name|'False'
newline|'\n'
nl|'\n'
name|'scheduler_method'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'scheduler_rpcapi'
op|'.'
name|'run_instance'
newline|'\n'
name|'method_args'
op|'='
op|'('
name|'request_spec'
op|','
name|'admin_password'
op|','
name|'injected_files'
op|','
nl|'\n'
name|'requested_networks'
op|','
name|'is_first_time'
op|','
name|'filter_properties'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reschedule'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'request_spec'
op|','
nl|'\n'
name|'filter_properties'
op|','
name|'instance_uuid'
op|','
name|'scheduler_method'
op|','
nl|'\n'
name|'method_args'
op|','
name|'self'
op|'.'
name|'expected_task_state'
op|','
name|'exc_info'
op|'='
name|'exc_info'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reschedule_no_filter_properties
dedent|''
name|'def'
name|'test_reschedule_no_filter_properties'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# no filter_properties will disable re-scheduling.'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'self'
op|'.'
name|'_reschedule'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reschedule_no_retry_info
dedent|''
name|'def'
name|'test_reschedule_no_retry_info'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# no retry info will also disable re-scheduling.'
nl|'\n'
indent|'        '
name|'filter_properties'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'self'
op|'.'
name|'_reschedule'
op|'('
name|'filter_properties'
op|'='
name|'filter_properties'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reschedule_no_request_spec
dedent|''
name|'def'
name|'test_reschedule_no_request_spec'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# no request spec will also disable re-scheduling.'
nl|'\n'
indent|'        '
name|'retry'
op|'='
name|'dict'
op|'('
name|'num_attempts'
op|'='
number|'1'
op|')'
newline|'\n'
name|'filter_properties'
op|'='
name|'dict'
op|'('
name|'retry'
op|'='
name|'retry'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'self'
op|'.'
name|'_reschedule'
op|'('
name|'filter_properties'
op|'='
name|'filter_properties'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reschedule_success
dedent|''
name|'def'
name|'test_reschedule_success'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'retry'
op|'='
name|'dict'
op|'('
name|'num_attempts'
op|'='
number|'1'
op|')'
newline|'\n'
name|'filter_properties'
op|'='
name|'dict'
op|'('
name|'retry'
op|'='
name|'retry'
op|')'
newline|'\n'
name|'request_spec'
op|'='
op|'{'
string|"'instance_uuids'"
op|':'
op|'['
string|"'foo'"
op|','
string|"'bar'"
op|']'
op|'}'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
string|'"just need an exception"'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'test'
op|'.'
name|'TestingException'
op|':'
newline|'\n'
indent|'            '
name|'exc_info'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
newline|'\n'
name|'exc_str'
op|'='
name|'traceback'
op|'.'
name|'format_exception'
op|'('
op|'*'
name|'exc_info'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'self'
op|'.'
name|'_reschedule'
op|'('
name|'filter_properties'
op|'='
name|'filter_properties'
op|','
nl|'\n'
name|'request_spec'
op|'='
name|'request_spec'
op|','
name|'exc_info'
op|'='
name|'exc_info'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'1'
op|','
name|'len'
op|'('
name|'request_spec'
op|'['
string|"'instance_uuids'"
op|']'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'updated_task_state'
op|','
name|'self'
op|'.'
name|'expected_task_state'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'exc_str'
op|','
name|'filter_properties'
op|'['
string|"'retry'"
op|']'
op|'['
string|"'exc'"
op|']'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ComputeReschedulingResizeTestCase
dedent|''
dedent|''
name|'class'
name|'ComputeReschedulingResizeTestCase'
op|'('
name|'ComputeReschedulingTestCase'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Test re-scheduling logic for prep_resize requests."""'
newline|'\n'
nl|'\n'
DECL|member|setUp
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'ComputeReschedulingResizeTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'expected_task_state'
op|'='
name|'task_states'
op|'.'
name|'RESIZE_PREP'
newline|'\n'
nl|'\n'
DECL|member|_reschedule
dedent|''
name|'def'
name|'_reschedule'
op|'('
name|'self'
op|','
name|'request_spec'
op|'='
name|'None'
op|','
name|'filter_properties'
op|'='
name|'None'
op|','
nl|'\n'
name|'exc_info'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'filter_properties'
op|':'
newline|'\n'
indent|'            '
name|'filter_properties'
op|'='
op|'{'
op|'}'
newline|'\n'
nl|'\n'
dedent|''
name|'instance_uuid'
op|'='
string|'"12-34-56-78-90"'
newline|'\n'
name|'instance'
op|'='
name|'fake_instance'
op|'.'
name|'fake_db_instance'
op|'('
name|'uuid'
op|'='
name|'instance_uuid'
op|')'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'instance_type'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'image'
op|'='
name|'None'
newline|'\n'
name|'reservations'
op|'='
name|'None'
newline|'\n'
nl|'\n'
name|'scheduler_method'
op|'='
name|'self'
op|'.'
name|'compute'
op|'.'
name|'scheduler_rpcapi'
op|'.'
name|'prep_resize'
newline|'\n'
name|'method_args'
op|'='
op|'('
name|'instance'
op|','
name|'instance_type'
op|','
name|'image'
op|','
name|'request_spec'
op|','
nl|'\n'
name|'filter_properties'
op|','
name|'reservations'
op|')'
newline|'\n'
nl|'\n'
name|'return'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reschedule'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'request_spec'
op|','
nl|'\n'
name|'filter_properties'
op|','
name|'instance_uuid'
op|','
name|'scheduler_method'
op|','
nl|'\n'
name|'method_args'
op|','
name|'self'
op|'.'
name|'expected_task_state'
op|','
name|'exc_info'
op|'='
name|'exc_info'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|InnerTestingException
dedent|''
dedent|''
name|'class'
name|'InnerTestingException'
op|'('
name|'Exception'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'pass'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ComputeRescheduleOrErrorTestCase
dedent|''
name|'class'
name|'ComputeRescheduleOrErrorTestCase'
op|'('
name|'BaseTestCase'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Test logic and exception handling around rescheduling or re-raising\n    original exceptions when builds fail.\n    """'
newline|'\n'
nl|'\n'
DECL|member|setUp
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'ComputeRescheduleOrErrorTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reschedule_or_error_called
dedent|''
name|'def'
name|'test_reschedule_or_error_called'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Basic sanity check to make sure _reschedule_or_error is called\n        when a build fails.\n        """'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_spawn'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_reschedule_or_error'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_spawn'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'self'
op|'.'
name|'instance'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
op|'['
op|']'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
op|'['
op|']'
op|','
name|'None'
op|','
name|'set_access_ip'
op|'='
name|'False'
op|')'
op|'.'
name|'AndRaise'
op|'('
nl|'\n'
name|'test'
op|'.'
name|'TestingException'
op|'('
string|'"BuildError"'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reschedule_or_error'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'self'
op|'.'
name|'instance'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'None'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'False'
op|','
name|'None'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'False'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'None'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'False'
op|','
name|'None'
op|','
name|'self'
op|'.'
name|'instance'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_shutdown_instance_fail
dedent|''
name|'def'
name|'test_shutdown_instance_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Test shutdown instance failing before re-scheduling logic can even\n        run.\n        """'
newline|'\n'
name|'instance_uuid'
op|'='
name|'self'
op|'.'
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_shutdown_instance'"
op|')'
newline|'\n'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
string|'"Original"'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
indent|'            '
name|'exc_info'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'compute_utils'
op|'.'
name|'add_instance_fault_from_exc'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|','
name|'exc_info'
op|'['
number|'0'
op|']'
op|','
name|'exc_info'
op|'='
name|'exc_info'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_shutdown_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'instance'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
op|'.'
name|'AndRaise'
op|'('
name|'InnerTestingException'
op|'('
string|'"Error"'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_log_original_error'
op|'('
name|'exc_info'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# should raise the deallocation exception, not the original build'
nl|'\n'
comment|'# error:'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'InnerTestingException'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reschedule_or_error'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|','
name|'exc_info'
op|','
name|'None'
op|','
name|'None'
op|','
name|'None'
op|','
name|'False'
op|','
name|'None'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reschedule_fail
dedent|''
dedent|''
name|'def'
name|'test_reschedule_fail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test handling of exception from _reschedule.'
nl|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
string|'"Original"'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
indent|'            '
name|'exc_info'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'instance_uuid'
op|'='
name|'self'
op|'.'
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'method_args'
op|'='
op|'('
name|'None'
op|','
name|'None'
op|','
name|'None'
op|','
name|'None'
op|','
name|'False'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_shutdown_instance'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_cleanup_volumes'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_reschedule'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_shutdown_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'instance'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_cleanup_volumes'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reschedule'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'None'
op|','
name|'instance_uuid'
op|','
nl|'\n'
op|'{'
op|'}'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'scheduler_rpcapi'
op|'.'
name|'run_instance'
op|','
nl|'\n'
name|'method_args'
op|','
name|'task_states'
op|'.'
name|'SCHEDULING'
op|','
name|'exc_info'
op|')'
op|'.'
name|'AndRaise'
op|'('
nl|'\n'
name|'InnerTestingException'
op|'('
string|'"Inner"'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reschedule_or_error'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|','
name|'exc_info'
op|','
name|'None'
op|','
name|'None'
op|','
name|'None'
op|','
name|'False'
op|','
name|'None'
op|','
op|'{'
op|'}'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reschedule_false
dedent|''
name|'def'
name|'test_reschedule_false'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test not-rescheduling, but no nested exception.'
nl|'\n'
indent|'        '
name|'instance_uuid'
op|'='
name|'self'
op|'.'
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'method_args'
op|'='
op|'('
name|'None'
op|','
name|'None'
op|','
name|'None'
op|','
name|'None'
op|','
name|'False'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_shutdown_instance'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_cleanup_volumes'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_reschedule'"
op|')'
newline|'\n'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
string|'"Original"'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
indent|'            '
name|'exc_info'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
newline|'\n'
name|'compute_utils'
op|'.'
name|'add_instance_fault_from_exc'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|','
name|'exc_info'
op|'['
number|'0'
op|']'
op|','
name|'exc_info'
op|'='
name|'exc_info'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_shutdown_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'instance'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_cleanup_volumes'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reschedule'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'None'
op|','
op|'{'
op|'}'
op|','
name|'instance_uuid'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'scheduler_rpcapi'
op|'.'
name|'run_instance'
op|','
name|'method_args'
op|','
nl|'\n'
name|'task_states'
op|'.'
name|'SCHEDULING'
op|','
name|'exc_info'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# re-scheduling is False, the original build error should be'
nl|'\n'
comment|'# raised here:'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reschedule_or_error'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|','
name|'exc_info'
op|','
name|'None'
op|','
name|'None'
op|','
name|'None'
op|','
name|'False'
op|','
name|'None'
op|','
op|'{'
op|'}'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reschedule_true
dedent|''
dedent|''
name|'def'
name|'test_reschedule_true'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Test behavior when re-scheduling happens.'
nl|'\n'
indent|'        '
name|'instance_uuid'
op|'='
name|'self'
op|'.'
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'method_args'
op|'='
op|'('
name|'None'
op|','
name|'None'
op|','
name|'None'
op|','
name|'None'
op|','
name|'False'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_shutdown_instance'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_cleanup_volumes'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_reschedule'"
op|')'
newline|'\n'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
string|'"Original"'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
indent|'            '
name|'exc_info'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'compute_utils'
op|'.'
name|'add_instance_fault_from_exc'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'conductor_api'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|','
name|'exc_info'
op|'['
number|'0'
op|']'
op|','
name|'exc_info'
op|'='
name|'exc_info'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_shutdown_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'instance'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_cleanup_volumes'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reschedule'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'None'
op|','
op|'{'
op|'}'
op|','
name|'instance_uuid'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'scheduler_rpcapi'
op|'.'
name|'run_instance'
op|','
nl|'\n'
name|'method_args'
op|','
name|'task_states'
op|'.'
name|'SCHEDULING'
op|','
name|'exc_info'
op|')'
op|'.'
name|'AndReturn'
op|'('
nl|'\n'
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_log_original_error'
op|'('
name|'exc_info'
op|','
name|'instance_uuid'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# re-scheduling is True, original error is logged, but nothing'
nl|'\n'
comment|'# is raised:'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reschedule_or_error'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'instance'
op|','
nl|'\n'
name|'exc_info'
op|','
name|'None'
op|','
name|'None'
op|','
name|'None'
op|','
name|'False'
op|','
name|'None'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_no_reschedule_on_delete_during_spawn
dedent|''
dedent|''
name|'def'
name|'test_no_reschedule_on_delete_during_spawn'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# instance should not be rescheduled if instance is deleted'
nl|'\n'
comment|'# during the build'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_spawn'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_reschedule_or_error'"
op|')'
newline|'\n'
nl|'\n'
name|'exc'
op|'='
name|'exception'
op|'.'
name|'UnexpectedDeletingTaskStateError'
op|'('
nl|'\n'
name|'expected'
op|'='
name|'task_states'
op|'.'
name|'SPAWNING'
op|','
name|'actual'
op|'='
name|'task_states'
op|'.'
name|'DELETING'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_spawn'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'self'
op|'.'
name|'instance'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'set_access_ip'
op|'='
name|'False'
op|')'
op|'.'
name|'AndRaise'
op|'('
name|'exc'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
comment|"# test succeeds if mocked method '_reschedule_or_error' is not"
nl|'\n'
comment|'# called.'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'None'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'False'
op|','
name|'None'
op|','
name|'self'
op|'.'
name|'instance'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_no_reschedule_on_unexpected_task_state
dedent|''
name|'def'
name|'test_no_reschedule_on_unexpected_task_state'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|"# instance shouldn't be rescheduled if unexpected task state arises."
nl|'\n'
comment|'# the exception should get reraised.'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_spawn'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_reschedule_or_error'"
op|')'
newline|'\n'
nl|'\n'
name|'exc'
op|'='
name|'exception'
op|'.'
name|'UnexpectedTaskStateError'
op|'('
name|'expected'
op|'='
name|'task_states'
op|'.'
name|'SPAWNING'
op|','
nl|'\n'
name|'actual'
op|'='
name|'task_states'
op|'.'
name|'SCHEDULING'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_spawn'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'self'
op|'.'
name|'instance'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'set_access_ip'
op|'='
name|'False'
op|')'
op|'.'
name|'AndRaise'
op|'('
name|'exc'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'UnexpectedTaskStateError'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_run_instance'
op|','
name|'self'
op|'.'
name|'context'
op|','
name|'None'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|','
name|'False'
op|','
name|'None'
op|','
name|'self'
op|'.'
name|'instance'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ComputeRescheduleResizeOrReraiseTestCase
dedent|''
dedent|''
name|'class'
name|'ComputeRescheduleResizeOrReraiseTestCase'
op|'('
name|'BaseTestCase'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Test logic and exception handling around rescheduling prep resize\n    requests\n    """'
newline|'\n'
DECL|member|setUp
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'ComputeRescheduleResizeOrReraiseTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'instance_uuid'
op|'='
name|'self'
op|'.'
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
nl|'\n'
string|'"m1.tiny"'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reschedule_resize_or_reraise_called
dedent|''
name|'def'
name|'test_reschedule_resize_or_reraise_called'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Verify the rescheduling logic gets called when there is an error\n        during prep_resize.\n        """'
newline|'\n'
name|'inst_obj'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'db'
op|','
string|"'migration_create'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_reschedule_resize_or_reraise'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'db'
op|'.'
name|'migration_create'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
op|'.'
name|'AndRaise'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|'('
string|'"Original"'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reschedule_resize_or_reraise'
op|'('
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'None'
op|','
nl|'\n'
name|'inst_obj'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
name|'self'
op|'.'
name|'instance_type'
op|','
op|'['
op|']'
op|','
op|'{'
op|'}'
op|','
nl|'\n'
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'prep_resize'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'image'
op|'='
name|'None'
op|','
nl|'\n'
name|'instance'
op|'='
name|'inst_obj'
op|','
nl|'\n'
name|'instance_type'
op|'='
name|'self'
op|'.'
name|'instance_type'
op|','
nl|'\n'
name|'reservations'
op|'='
op|'['
op|']'
op|','
name|'request_spec'
op|'='
op|'{'
op|'}'
op|','
nl|'\n'
name|'filter_properties'
op|'='
op|'{'
op|'}'
op|','
name|'node'
op|'='
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reschedule_fails_with_exception
dedent|''
name|'def'
name|'test_reschedule_fails_with_exception'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Original exception should be raised if the _reschedule method\n        raises another exception\n        """'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'method_args'
op|'='
op|'('
name|'None'
op|','
name|'instance'
op|','
name|'self'
op|'.'
name|'instance_type'
op|','
name|'None'
op|','
name|'None'
op|','
nl|'\n'
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|'"_reschedule"'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reschedule'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'None'
op|','
name|'None'
op|','
name|'instance'
op|'.'
name|'uuid'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'scheduler_rpcapi'
op|'.'
name|'prep_resize'
op|','
name|'method_args'
op|','
nl|'\n'
name|'task_states'
op|'.'
name|'RESIZE_PREP'
op|')'
op|'.'
name|'AndRaise'
op|'('
nl|'\n'
name|'InnerTestingException'
op|'('
string|'"Inner"'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
string|'"Original"'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
indent|'            '
name|'exc_info'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reschedule_resize_or_reraise'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'None'
op|','
name|'instance'
op|','
name|'exc_info'
op|','
name|'self'
op|'.'
name|'instance_type'
op|','
name|'None'
op|','
nl|'\n'
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reschedule_false
dedent|''
dedent|''
name|'def'
name|'test_reschedule_false'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Original exception should be raised if the resize is not\n        rescheduled.\n        """'
newline|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'method_args'
op|'='
op|'('
name|'None'
op|','
name|'instance'
op|','
name|'self'
op|'.'
name|'instance_type'
op|','
name|'None'
op|','
name|'None'
op|','
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|'"_reschedule"'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reschedule'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'None'
op|','
name|'None'
op|','
name|'instance'
op|'.'
name|'uuid'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'scheduler_rpcapi'
op|'.'
name|'prep_resize'
op|','
name|'method_args'
op|','
nl|'\n'
name|'task_states'
op|'.'
name|'RESIZE_PREP'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
string|'"Original"'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
indent|'            '
name|'exc_info'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'test'
op|'.'
name|'TestingException'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reschedule_resize_or_reraise'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'None'
op|','
name|'instance'
op|','
name|'exc_info'
op|','
name|'self'
op|'.'
name|'instance_type'
op|','
name|'None'
op|','
nl|'\n'
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reschedule_true
dedent|''
dedent|''
name|'def'
name|'test_reschedule_true'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# If rescheduled, the original resize exception should be logged.'
nl|'\n'
indent|'        '
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance_obj'
op|'('
op|')'
newline|'\n'
name|'instance_p'
op|'='
name|'obj_base'
op|'.'
name|'obj_to_primitive'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'method_args'
op|'='
op|'('
name|'instance_p'
op|','
name|'self'
op|'.'
name|'instance_type'
op|','
name|'None'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
name|'None'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
string|'"Original"'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
indent|'            '
name|'exc_info'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|'"_reschedule"'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|'"_log_original_error"'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reschedule'
op|'('
name|'self'
op|'.'
name|'context'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'uuid'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'scheduler_rpcapi'
op|'.'
name|'prep_resize'
op|','
name|'method_args'
op|','
nl|'\n'
name|'task_states'
op|'.'
name|'RESIZE_PREP'
op|','
name|'exc_info'
op|')'
op|'.'
name|'AndReturn'
op|'('
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_log_original_error'
op|'('
name|'exc_info'
op|','
name|'instance'
op|'.'
name|'uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_reschedule_resize_or_reraise'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'None'
op|','
nl|'\n'
name|'instance'
op|','
name|'exc_info'
op|','
name|'self'
op|'.'
name|'instance_type'
op|','
name|'None'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ComputeInactiveImageTestCase
dedent|''
dedent|''
dedent|''
name|'class'
name|'ComputeInactiveImageTestCase'
op|'('
name|'BaseTestCase'
op|')'
op|':'
newline|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'ComputeInactiveImageTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_show
name|'def'
name|'fake_show'
op|'('
name|'meh'
op|','
name|'context'
op|','
name|'id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'id'"
op|':'
name|'id'
op|','
string|"'min_disk'"
op|':'
name|'None'
op|','
string|"'min_ram'"
op|':'
name|'None'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'fake_name'"
op|','
nl|'\n'
string|"'status'"
op|':'
string|"'deleted'"
op|','
nl|'\n'
string|"'properties'"
op|':'
op|'{'
string|"'kernel_id'"
op|':'
string|"'fake_kernel_id'"
op|','
nl|'\n'
string|"'ramdisk_id'"
op|':'
string|"'fake_ramdisk_id'"
op|','
nl|'\n'
string|"'something_else'"
op|':'
string|"'meow'"
op|'}'
op|'}'
newline|'\n'
nl|'\n'
dedent|''
name|'fake_image'
op|'.'
name|'stub_out_image_service'
op|'('
name|'self'
op|'.'
name|'stubs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'fake_image'
op|'.'
name|'_FakeImageService'
op|','
string|"'show'"
op|','
name|'fake_show'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'='
name|'compute'
op|'.'
name|'API'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_create_instance_with_deleted_image
dedent|''
name|'def'
name|'test_create_instance_with_deleted_image'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|"# Make sure we can't start an instance with a deleted image."
nl|'\n'
indent|'        '
name|'inst_type'
op|'='
name|'flavors'
op|'.'
name|'get_flavor_by_name'
op|'('
string|"'m1.tiny'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'ImageNotActive'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'create'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'inst_type'
op|','
string|"'fake-image-uuid'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|EvacuateHostTestCase
dedent|''
dedent|''
name|'class'
name|'EvacuateHostTestCase'
op|'('
name|'BaseTestCase'
op|')'
op|':'
newline|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'EvacuateHostTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'inst_ref'
op|'='
name|'jsonutils'
op|'.'
name|'to_primitive'
op|'('
name|'self'
op|'.'
name|'_create_fake_instance'
nl|'\n'
op|'('
op|'{'
string|"'host'"
op|':'
string|"'fake_host_2'"
op|','
nl|'\n'
string|"'node'"
op|':'
string|"'fakenode2'"
op|'}'
op|')'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'inst_ref'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|'"task_state"'
op|':'
name|'task_states'
op|'.'
name|'REBUILDING'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|tearDown
dedent|''
name|'def'
name|'tearDown'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'db'
op|'.'
name|'instance_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'inst_ref'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'super'
op|'('
name|'EvacuateHostTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'tearDown'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|_rebuild
dedent|''
name|'def'
name|'_rebuild'
op|'('
name|'self'
op|','
name|'on_shared_storage'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
DECL|function|fake
indent|'        '
name|'def'
name|'fake'
op|'('
name|'cls'
op|','
name|'ctxt'
op|','
name|'instance'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'network_api'
op|'.'
name|'API'
op|','
string|"'setup_networks_on_host'"
op|','
name|'fake'
op|')'
newline|'\n'
nl|'\n'
name|'orig_image_ref'
op|'='
name|'None'
newline|'\n'
name|'image_ref'
op|'='
name|'None'
newline|'\n'
name|'injected_files'
op|'='
name|'None'
newline|'\n'
name|'bdms'
op|'='
name|'db'
op|'.'
name|'block_device_mapping_get_all_by_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'inst_ref'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'rebuild_instance'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'_objectify'
op|'('
name|'self'
op|'.'
name|'inst_ref'
op|')'
op|','
name|'orig_image_ref'
op|','
nl|'\n'
name|'image_ref'
op|','
name|'injected_files'
op|','
string|"'newpass'"
op|','
op|'{'
op|'}'
op|','
name|'bdms'
op|','
name|'recreate'
op|'='
name|'True'
op|','
nl|'\n'
name|'on_shared_storage'
op|'='
name|'on_shared_storage'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_on_host_updated_target
dedent|''
name|'def'
name|'test_rebuild_on_host_updated_target'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Confirm evacuate scenario updates host and node."""'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'instance_on_disk'"
op|','
name|'lambda'
name|'x'
op|':'
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_get_compute_info
name|'def'
name|'fake_get_compute_info'
op|'('
name|'context'
op|','
name|'host'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'context'
op|'.'
name|'is_admin'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
string|"'fake-mini'"
op|','
name|'host'
op|')'
newline|'\n'
name|'return'
op|'{'
string|"'hypervisor_hostname'"
op|':'
name|'self'
op|'.'
name|'rt'
op|'.'
name|'nodename'
op|'}'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_compute_info'"
op|','
nl|'\n'
name|'fake_get_compute_info'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_rebuild'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# Should be on destination host'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'inst_ref'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'host'"
op|']'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'NODENAME'
op|','
name|'instance'
op|'['
string|"'node'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_on_host_updated_target_node_not_found
dedent|''
name|'def'
name|'test_rebuild_on_host_updated_target_node_not_found'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Confirm evacuate scenario where compute_node isn\'t found."""'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'instance_on_disk'"
op|','
name|'lambda'
name|'x'
op|':'
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_get_compute_info
name|'def'
name|'fake_get_compute_info'
op|'('
name|'context'
op|','
name|'host'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
name|'_'
op|'('
string|'"Host %s not found"'
op|')'
op|'%'
name|'host'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_get_compute_info'"
op|','
nl|'\n'
name|'fake_get_compute_info'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_rebuild'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# Should be on destination host'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'inst_ref'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'host'"
op|']'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'host'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertIsNone'
op|'('
name|'instance'
op|'['
string|"'node'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_with_instance_in_stopped_state
dedent|''
name|'def'
name|'test_rebuild_with_instance_in_stopped_state'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Confirm evacuate scenario updates vm_state to stopped\n        if instance is in stopped state\n        """'
newline|'\n'
comment|'#Initialize the VM to stopped state'
nl|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'inst_ref'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|'"vm_state"'
op|':'
name|'vm_states'
op|'.'
name|'STOPPED'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'inst_ref'
op|'['
string|"'vm_state'"
op|']'
op|'='
name|'vm_states'
op|'.'
name|'STOPPED'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'instance_on_disk'"
op|','
name|'lambda'
name|'x'
op|':'
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_rebuild'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'#Check the vm state is reset to stopped'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'inst_ref'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'vm_state'"
op|']'
op|','
name|'vm_states'
op|'.'
name|'STOPPED'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_with_wrong_shared_storage
dedent|''
name|'def'
name|'test_rebuild_with_wrong_shared_storage'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Confirm evacuate scenario does not update host."""'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'instance_on_disk'"
op|','
name|'lambda'
name|'x'
op|':'
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InvalidSharedStorage'
op|','
nl|'\n'
name|'lambda'
op|':'
name|'self'
op|'.'
name|'_rebuild'
op|'('
name|'on_shared_storage'
op|'='
name|'False'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# Should remain on original host'
nl|'\n'
name|'instance'
op|'='
name|'db'
op|'.'
name|'instance_get'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'inst_ref'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'instance'
op|'['
string|"'host'"
op|']'
op|','
string|"'fake_host_2'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_on_host_with_volumes
dedent|''
name|'def'
name|'test_rebuild_on_host_with_volumes'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Confirm evacuate scenario reconnects volumes."""'
newline|'\n'
name|'values'
op|'='
op|'{'
string|"'instance_uuid'"
op|':'
name|'self'
op|'.'
name|'inst_ref'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
string|"'source_type'"
op|':'
string|"'volume'"
op|','
nl|'\n'
string|"'device_name'"
op|':'
string|"'/dev/vdc'"
op|','
nl|'\n'
string|"'delete_on_termination'"
op|':'
name|'False'
op|','
nl|'\n'
string|"'volume_id'"
op|':'
string|"'fake_volume_id'"
op|'}'
newline|'\n'
nl|'\n'
name|'db'
op|'.'
name|'block_device_mapping_create'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'values'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_volume_get
name|'def'
name|'fake_volume_get'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
string|"'id'"
op|':'
string|"'fake_volume_id'"
op|'}'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|'"get"'
op|','
name|'fake_volume_get'
op|')'
newline|'\n'
nl|'\n'
comment|'# Stub out and record whether it gets detached'
nl|'\n'
name|'result'
op|'='
op|'{'
string|'"detached"'
op|':'
name|'False'
op|'}'
newline|'\n'
nl|'\n'
DECL|function|fake_detach
name|'def'
name|'fake_detach'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'result'
op|'['
string|'"detached"'
op|']'
op|'='
name|'volume'
op|'['
string|'"id"'
op|']'
op|'=='
string|"'fake_volume_id'"
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|'"detach"'
op|','
name|'fake_detach'
op|')'
newline|'\n'
nl|'\n'
DECL|function|fake_terminate_connection
name|'def'
name|'fake_terminate_connection'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'volume'
op|','
name|'connector'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
op|'}'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'cinder'
op|'.'
name|'API'
op|','
string|'"terminate_connection"'
op|','
nl|'\n'
name|'fake_terminate_connection'
op|')'
newline|'\n'
nl|'\n'
comment|'# make sure volumes attach, detach are called'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'volume_api'
op|','
string|"'detach'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'volume_api'
op|'.'
name|'detach'
op|'('
name|'mox'
op|'.'
name|'IsA'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_prep_block_device'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'_prep_block_device'
op|'('
name|'mox'
op|'.'
name|'IsA'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IsA'
op|'('
name|'self'
op|'.'
name|'inst_ref'
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'instance_on_disk'"
op|','
name|'lambda'
name|'x'
op|':'
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_rebuild'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# cleanup'
nl|'\n'
name|'for'
name|'bdms'
name|'in'
name|'db'
op|'.'
name|'block_device_mapping_get_all_by_instance'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'inst_ref'
op|'['
string|"'uuid'"
op|']'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'block_device_mapping_destroy'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'bdms'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_on_host_with_shared_storage
dedent|''
dedent|''
name|'def'
name|'test_rebuild_on_host_with_shared_storage'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Confirm evacuate scenario on shared storage."""'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'spawn'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'spawn'
op|'('
name|'mox'
op|'.'
name|'IsA'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IsA'
op|'('
name|'self'
op|'.'
name|'inst_ref'
op|')'
op|','
op|'{'
op|'}'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
string|"'newpass'"
op|','
nl|'\n'
name|'network_info'
op|'='
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'block_device_info'
op|'='
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'instance_on_disk'"
op|','
name|'lambda'
name|'x'
op|':'
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_rebuild'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_on_host_without_shared_storage
dedent|''
name|'def'
name|'test_rebuild_on_host_without_shared_storage'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Confirm evacuate scenario without shared storage\n        (rebuild from image)\n        """'
newline|'\n'
name|'fake_image'
op|'='
op|'{'
string|"'id'"
op|':'
number|'1'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'fake_name'"
op|','
nl|'\n'
string|"'properties'"
op|':'
op|'{'
string|"'kernel_id'"
op|':'
string|"'fake_kernel_id'"
op|','
nl|'\n'
string|"'ramdisk_id'"
op|':'
string|"'fake_ramdisk_id'"
op|'}'
op|'}'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'StubOutWithMock'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'spawn'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'spawn'
op|'('
name|'mox'
op|'.'
name|'IsA'
op|'('
name|'self'
op|'.'
name|'context'
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IsA'
op|'('
name|'self'
op|'.'
name|'inst_ref'
op|')'
op|','
name|'mox'
op|'.'
name|'IsA'
op|'('
name|'fake_image'
op|')'
op|','
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'mox'
op|'.'
name|'IsA'
op|'('
string|"'newpass'"
op|')'
op|','
name|'network_info'
op|'='
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|','
nl|'\n'
name|'block_device_info'
op|'='
name|'mox'
op|'.'
name|'IgnoreArg'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'instance_on_disk'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'mox'
op|'.'
name|'ReplayAll'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_rebuild'
op|'('
name|'on_shared_storage'
op|'='
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_rebuild_on_host_instance_exists
dedent|''
name|'def'
name|'test_rebuild_on_host_instance_exists'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Rebuild if instance exists raises an exception."""'
newline|'\n'
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'inst_ref'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
op|'{'
string|'"task_state"'
op|':'
name|'task_states'
op|'.'
name|'SCHEDULING'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'inst_ref'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
nl|'\n'
op|'['
op|']'
op|','
name|'None'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'instance_on_disk'"
op|','
name|'lambda'
name|'x'
op|':'
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceExists'
op|','
nl|'\n'
name|'lambda'
op|':'
name|'self'
op|'.'
name|'_rebuild'
op|'('
name|'on_shared_storage'
op|'='
name|'True'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_driver_doesnt_support_recreate
dedent|''
name|'def'
name|'test_driver_doesnt_support_recreate'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'utils'
op|'.'
name|'temporary_mutation'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|'.'
name|'capabilities'
op|','
nl|'\n'
name|'supports_recreate'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'instance_on_disk'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'InstanceRecreateNotSupported'
op|','
nl|'\n'
name|'lambda'
op|':'
name|'self'
op|'.'
name|'_rebuild'
op|'('
name|'on_shared_storage'
op|'='
name|'True'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ComputeInjectedFilesTestCase
dedent|''
dedent|''
dedent|''
name|'class'
name|'ComputeInjectedFilesTestCase'
op|'('
name|'BaseTestCase'
op|')'
op|':'
newline|'\n'
comment|'# Test that running instances with injected_files decodes files correctly'
nl|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'ComputeInjectedFilesTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'instance'
op|'='
name|'self'
op|'.'
name|'_create_fake_instance'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'spawn'"
op|','
name|'self'
op|'.'
name|'_spawn'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_spawn
dedent|''
name|'def'
name|'_spawn'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'image_meta'
op|','
name|'injected_files'
op|','
nl|'\n'
name|'admin_password'
op|','
name|'nw_info'
op|','
name|'block_device_info'
op|','
name|'db_api'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'self'
op|'.'
name|'expected'
op|','
name|'injected_files'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test
dedent|''
name|'def'
name|'_test'
op|'('
name|'self'
op|','
name|'injected_files'
op|','
name|'decoded_files'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'expected'
op|'='
name|'decoded_files'
newline|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
nl|'\n'
name|'injected_files'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_injected_none
dedent|''
name|'def'
name|'test_injected_none'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# test an input of None for injected_files'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test'
op|'('
name|'None'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_injected_empty
dedent|''
name|'def'
name|'test_injected_empty'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# test an input of [] for injected_files'
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'_test'
op|'('
op|'['
op|']'
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_injected_success
dedent|''
name|'def'
name|'test_injected_success'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# test with valid b64 encoded content.'
nl|'\n'
indent|'        '
name|'injected_files'
op|'='
op|'['
nl|'\n'
op|'('
string|"'/a/b/c'"
op|','
name|'base64'
op|'.'
name|'b64encode'
op|'('
string|"'foobarbaz'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'/d/e/f'"
op|','
name|'base64'
op|'.'
name|'b64encode'
op|'('
string|"'seespotrun'"
op|')'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
name|'decoded_files'
op|'='
op|'['
nl|'\n'
op|'('
string|"'/a/b/c'"
op|','
string|"'foobarbaz'"
op|')'
op|','
nl|'\n'
op|'('
string|"'/d/e/f'"
op|','
string|"'seespotrun'"
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'_test'
op|'('
name|'injected_files'
op|','
name|'decoded_files'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_injected_invalid
dedent|''
name|'def'
name|'test_injected_invalid'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# test with invalid b64 encoded content'
nl|'\n'
indent|'        '
name|'injected_files'
op|'='
op|'['
nl|'\n'
op|'('
string|"'/a/b/c'"
op|','
name|'base64'
op|'.'
name|'b64encode'
op|'('
string|"'foobarbaz'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'/d/e/f'"
op|','
string|"'seespotrun'"
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'Base64Exception'
op|','
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|','
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
name|'injected_files'
op|','
name|'None'
op|','
nl|'\n'
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reschedule
dedent|''
name|'def'
name|'test_reschedule'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# test that rescheduling is done with original encoded files'
nl|'\n'
indent|'        '
name|'expected'
op|'='
op|'['
nl|'\n'
op|'('
string|"'/a/b/c'"
op|','
name|'base64'
op|'.'
name|'b64encode'
op|'('
string|"'foobarbaz'"
op|')'
op|')'
op|','
nl|'\n'
op|'('
string|"'/d/e/f'"
op|','
name|'base64'
op|'.'
name|'b64encode'
op|'('
string|"'seespotrun'"
op|')'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
DECL|function|_roe
name|'def'
name|'_roe'
op|'('
name|'context'
op|','
name|'instance'
op|','
name|'exc_info'
op|','
name|'requested_networks'
op|','
nl|'\n'
name|'admin_password'
op|','
name|'injected_files'
op|','
name|'is_first_time'
op|','
name|'request_spec'
op|','
nl|'\n'
name|'filter_properties'
op|','
name|'bdms'
op|'='
name|'None'
op|','
name|'legacy_bdm_in_spec'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
name|'injected_files'
op|')'
newline|'\n'
name|'return'
name|'True'
newline|'\n'
nl|'\n'
DECL|function|spawn_explode
dedent|''
name|'def'
name|'spawn_explode'
op|'('
name|'context'
op|','
name|'instance'
op|','
name|'image_meta'
op|','
name|'injected_files'
op|','
nl|'\n'
name|'admin_password'
op|','
name|'nw_info'
op|','
name|'block_device_info'
op|')'
op|':'
newline|'\n'
comment|'# force reschedule logic to execute'
nl|'\n'
indent|'            '
name|'raise'
name|'test'
op|'.'
name|'TestingException'
op|'('
name|'_'
op|'('
string|'"spawn error"'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|'.'
name|'driver'
op|','
string|"'spawn'"
op|','
name|'spawn_explode'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'self'
op|'.'
name|'compute'
op|','
string|"'_reschedule_or_error'"
op|','
name|'_roe'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute'
op|'.'
name|'run_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'instance'
op|','
op|'{'
op|'}'
op|','
op|'{'
op|'}'
op|','
op|'['
op|']'
op|','
nl|'\n'
name|'expected'
op|','
name|'None'
op|','
name|'True'
op|','
name|'None'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|CheckConfigDriveTestCase
dedent|''
dedent|''
name|'class'
name|'CheckConfigDriveTestCase'
op|'('
name|'test'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
comment|'# NOTE(sirp): `TestCase` is far too heavyweight for this test, this should'
nl|'\n'
comment|'# probably derive from a `test.FastTestCase` that omits DB and env'
nl|'\n'
comment|'# handling'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'CheckConfigDriveTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'='
name|'compute'
op|'.'
name|'API'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|_assertCheck
dedent|''
name|'def'
name|'_assertCheck'
op|'('
name|'self'
op|','
name|'expected'
op|','
name|'config_drive'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'expected'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_config_drive'
op|'('
name|'config_drive'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_assertInvalid
dedent|''
name|'def'
name|'_assertInvalid'
op|'('
name|'self'
op|','
name|'config_drive'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'ConfigDriveInvalidValue'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_config_drive'
op|','
nl|'\n'
name|'config_drive'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_config_drive_false_values
dedent|''
name|'def'
name|'test_config_drive_false_values'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_assertCheck'
op|'('
string|"''"
op|','
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_assertCheck'
op|'('
string|"''"
op|','
string|"''"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_assertCheck'
op|'('
string|"''"
op|','
string|"'False'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_assertCheck'
op|'('
string|"''"
op|','
string|"'f'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_assertCheck'
op|'('
string|"''"
op|','
string|"'0'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_config_drive_true_values
dedent|''
name|'def'
name|'test_config_drive_true_values'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_assertCheck'
op|'('
name|'True'
op|','
string|"'True'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_assertCheck'
op|'('
name|'True'
op|','
string|"'t'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_assertCheck'
op|'('
name|'True'
op|','
string|"'1'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_config_drive_bogus_values_raise
dedent|''
name|'def'
name|'test_config_drive_bogus_values_raise'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_assertInvalid'
op|'('
string|"'asd'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_assertInvalid'
op|'('
name|'uuidutils'
op|'.'
name|'generate_uuid'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|CheckRequestedImageTestCase
dedent|''
dedent|''
name|'class'
name|'CheckRequestedImageTestCase'
op|'('
name|'test'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'CheckRequestedImageTestCase'
op|','
name|'self'
op|')'
op|'.'
name|'setUp'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'='
name|'compute'
op|'.'
name|'API'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'context'
op|'='
name|'context'
op|'.'
name|'RequestContext'
op|'('
nl|'\n'
string|"'fake_user_id'"
op|','
string|"'fake_project_id'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'get_default_flavor'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'instance_type'
op|'['
string|"'memory_mb'"
op|']'
op|'='
number|'64'
newline|'\n'
name|'self'
op|'.'
name|'instance_type'
op|'['
string|"'root_gb'"
op|']'
op|'='
number|'1'
newline|'\n'
nl|'\n'
DECL|member|test_no_image_specified
dedent|''
name|'def'
name|'test_no_image_specified'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_requested_image'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'None'
op|','
op|'{'
op|'}'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance_type'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_image_status_must_be_active
dedent|''
name|'def'
name|'test_image_status_must_be_active'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'image'
op|'='
name|'dict'
op|'('
name|'id'
op|'='
string|"'123'"
op|','
name|'status'
op|'='
string|"'foo'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'ImageNotActive'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_requested_image'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'image'
op|'['
string|"'id'"
op|']'
op|','
name|'image'
op|','
name|'self'
op|'.'
name|'instance_type'
op|')'
newline|'\n'
nl|'\n'
name|'image'
op|'['
string|"'status'"
op|']'
op|'='
string|"'active'"
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_requested_image'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'image'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'image'
op|','
name|'self'
op|'.'
name|'instance_type'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_image_min_ram_check
dedent|''
name|'def'
name|'test_image_min_ram_check'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'image'
op|'='
name|'dict'
op|'('
name|'id'
op|'='
string|"'123'"
op|','
name|'status'
op|'='
string|"'active'"
op|','
name|'min_ram'
op|'='
string|"'65'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'FlavorMemoryTooSmall'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_requested_image'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'image'
op|'['
string|"'id'"
op|']'
op|','
name|'image'
op|','
name|'self'
op|'.'
name|'instance_type'
op|')'
newline|'\n'
nl|'\n'
name|'image'
op|'['
string|"'min_ram'"
op|']'
op|'='
string|"'64'"
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_requested_image'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'image'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'image'
op|','
name|'self'
op|'.'
name|'instance_type'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_image_min_disk_check
dedent|''
name|'def'
name|'test_image_min_disk_check'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'image'
op|'='
name|'dict'
op|'('
name|'id'
op|'='
string|"'123'"
op|','
name|'status'
op|'='
string|"'active'"
op|','
name|'min_disk'
op|'='
string|"'2'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'FlavorDiskTooSmall'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_requested_image'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'image'
op|'['
string|"'id'"
op|']'
op|','
name|'image'
op|','
name|'self'
op|'.'
name|'instance_type'
op|')'
newline|'\n'
nl|'\n'
name|'image'
op|'['
string|"'min_disk'"
op|']'
op|'='
string|"'1'"
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_requested_image'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'image'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'image'
op|','
name|'self'
op|'.'
name|'instance_type'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_image_too_large
dedent|''
name|'def'
name|'test_image_too_large'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'image'
op|'='
name|'dict'
op|'('
name|'id'
op|'='
string|"'123'"
op|','
name|'status'
op|'='
string|"'active'"
op|','
name|'size'
op|'='
string|"'1073741825'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'FlavorDiskTooSmall'
op|','
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_requested_image'
op|','
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'image'
op|'['
string|"'id'"
op|']'
op|','
name|'image'
op|','
name|'self'
op|'.'
name|'instance_type'
op|')'
newline|'\n'
nl|'\n'
name|'image'
op|'['
string|"'size'"
op|']'
op|'='
string|"'1073741824'"
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_requested_image'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'image'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'image'
op|','
name|'self'
op|'.'
name|'instance_type'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_root_gb_zero_disables_size_check
dedent|''
name|'def'
name|'test_root_gb_zero_disables_size_check'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'instance_type'
op|'['
string|"'root_gb'"
op|']'
op|'='
number|'0'
newline|'\n'
name|'image'
op|'='
name|'dict'
op|'('
name|'id'
op|'='
string|"'123'"
op|','
name|'status'
op|'='
string|"'active'"
op|','
name|'size'
op|'='
string|"'1073741825'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_requested_image'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'image'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'image'
op|','
name|'self'
op|'.'
name|'instance_type'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_root_gb_zero_disables_min_disk
dedent|''
name|'def'
name|'test_root_gb_zero_disables_min_disk'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'instance_type'
op|'['
string|"'root_gb'"
op|']'
op|'='
number|'0'
newline|'\n'
name|'image'
op|'='
name|'dict'
op|'('
name|'id'
op|'='
string|"'123'"
op|','
name|'status'
op|'='
string|"'active'"
op|','
name|'min_disk'
op|'='
string|"'2'"
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'_check_requested_image'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'image'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'image'
op|','
name|'self'
op|'.'
name|'instance_type'
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
