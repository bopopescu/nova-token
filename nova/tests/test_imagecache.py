begin_unit
comment|'#!/usr/bin/python'
nl|'\n'
comment|'# vim: tabstop=4 shiftwidth=4 softtabstop=4'
nl|'\n'
nl|'\n'
comment|'# Copyright 2012 Michael Still and Canonical Inc'
nl|'\n'
comment|'# All Rights Reserved.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
nl|'\n'
name|'import'
name|'hashlib'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'shutil'
newline|'\n'
name|'import'
name|'tempfile'
newline|'\n'
name|'import'
name|'time'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
name|'import'
name|'test'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
name|'import'
name|'db'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'flags'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'log'
name|'as'
name|'logging'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'libvirt'
name|'import'
name|'imagecache'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'libvirt'
name|'import'
name|'utils'
name|'as'
name|'virtutils'
newline|'\n'
nl|'\n'
nl|'\n'
name|'flags'
op|'.'
name|'DECLARE'
op|'('
string|"'instances_path'"
op|','
string|"'nova.compute.manager'"
op|')'
newline|'\n'
DECL|variable|FLAGS
name|'FLAGS'
op|'='
name|'flags'
op|'.'
name|'FLAGS'
newline|'\n'
nl|'\n'
DECL|variable|LOG
name|'LOG'
op|'='
name|'logging'
op|'.'
name|'getLogger'
op|'('
string|"'nova.tests.test_imagecache'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ImageCacheManagerTestCase
name|'class'
name|'ImageCacheManagerTestCase'
op|'('
name|'test'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|test_read_stored_checksum_missing
indent|'    '
name|'def'
name|'test_read_stored_checksum_missing'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'os'
op|'.'
name|'path'
op|','
string|"'exists'"
op|','
name|'lambda'
name|'x'
op|':'
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'csum'
op|'='
name|'imagecache'
op|'.'
name|'read_stored_checksum'
op|'('
string|"'/tmp/foo'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'csum'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_read_stored_checksum
dedent|''
name|'def'
name|'test_read_stored_checksum'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'dirname'
op|'='
name|'tempfile'
op|'.'
name|'mkdtemp'
op|'('
op|')'
newline|'\n'
name|'fname'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'dirname'
op|','
string|"'aaa'"
op|')'
newline|'\n'
nl|'\n'
name|'csum_input'
op|'='
string|"'fdghkfhkgjjksfdgjksjkghsdf'"
newline|'\n'
name|'f'
op|'='
name|'open'
op|'('
string|"'%s.sha1'"
op|'%'
name|'fname'
op|','
string|"'w'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'write'
op|'('
string|"'%s\\n'"
op|'%'
name|'csum_input'
op|')'
newline|'\n'
name|'f'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'csum_output'
op|'='
name|'imagecache'
op|'.'
name|'read_stored_checksum'
op|'('
name|'fname'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'csum_input'
op|','
name|'csum_output'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'shutil'
op|'.'
name|'rmtree'
op|'('
name|'dirname'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_list_base_images
dedent|''
dedent|''
name|'def'
name|'test_list_base_images'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'listing'
op|'='
op|'['
string|"'00000001'"
op|','
nl|'\n'
string|"'ephemeral_0_20_None'"
op|','
nl|'\n'
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3_sm'"
op|','
nl|'\n'
string|"'e09c675c2d1cfac32dae3c2d83689c8c94bc693b_sm'"
op|','
nl|'\n'
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3'"
op|','
nl|'\n'
string|"'17d1b00b81642842e514494a78e804e9a511637c'"
op|','
nl|'\n'
string|"'17d1b00b81642842e514494a78e804e9a511637c_5368709120'"
op|','
nl|'\n'
string|"'17d1b00b81642842e514494a78e804e9a511637c_10737418240'"
op|','
nl|'\n'
string|"'00000004'"
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'os'
op|','
string|"'listdir'"
op|','
name|'lambda'
name|'x'
op|':'
name|'listing'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'os'
op|'.'
name|'path'
op|','
string|"'isfile'"
op|','
name|'lambda'
name|'x'
op|':'
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'base_dir'
op|'='
string|"'/var/lib/nova/instances/_base'"
newline|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_list_base_images'
op|'('
name|'base_dir'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|')'
op|','
number|'6'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
nl|'\n'
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'expected'
name|'in'
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
nl|'\n'
string|"'17d1b00b81642842e514494a78e804e9a511637c_'"
nl|'\n'
string|"'10737418240'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'expected'
name|'in'
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|')'
newline|'\n'
nl|'\n'
name|'unexpected'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
string|"'00000004'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'unexpected'
name|'in'
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'ent'
name|'in'
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'ent'
op|'.'
name|'startswith'
op|'('
name|'base_dir'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'image_cache_manager'
op|'.'
name|'originals'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
name|'expected'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
nl|'\n'
string|"'17d1b00b81642842e514494a78e804e9a511637c'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'expected'
name|'in'
name|'image_cache_manager'
op|'.'
name|'originals'
op|')'
newline|'\n'
nl|'\n'
name|'unexpected'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
nl|'\n'
string|"'17d1b00b81642842e514494a78e804e9a511637c_'"
nl|'\n'
string|"'10737418240'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'unexpected'
name|'in'
name|'image_cache_manager'
op|'.'
name|'originals'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_list_running_instances
dedent|''
name|'def'
name|'test_list_running_instances'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'db'
op|','
string|"'instance_get_all'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
op|'['
op|'{'
string|"'image_ref'"
op|':'
string|"'image-1'"
op|','
nl|'\n'
string|"'host'"
op|':'
name|'FLAGS'
op|'.'
name|'host'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'inst-1'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'image_ref'"
op|':'
string|"'image-2'"
op|','
nl|'\n'
string|"'host'"
op|':'
name|'FLAGS'
op|'.'
name|'host'
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'inst-2'"
op|'}'
op|','
nl|'\n'
op|'{'
string|"'image_ref'"
op|':'
string|"'image-2'"
op|','
nl|'\n'
string|"'host'"
op|':'
string|"'remotehost'"
op|','
nl|'\n'
string|"'name'"
op|':'
string|"'inst-3'"
op|'}'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# The argument here should be a context, but its mocked out'
nl|'\n'
name|'image_cache_manager'
op|'.'
name|'_list_running_instances'
op|'('
name|'None'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'image_cache_manager'
op|'.'
name|'used_images'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'image_cache_manager'
op|'.'
name|'used_images'
op|'['
string|"'image-1'"
op|']'
op|'=='
nl|'\n'
op|'('
number|'1'
op|','
number|'0'
op|','
op|'['
string|"'inst-1'"
op|']'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'image_cache_manager'
op|'.'
name|'used_images'
op|'['
string|"'image-2'"
op|']'
op|'=='
nl|'\n'
op|'('
number|'1'
op|','
number|'1'
op|','
op|'['
string|"'inst-2'"
op|','
string|"'inst-3'"
op|']'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'len'
op|'('
name|'image_cache_manager'
op|'.'
name|'image_popularity'
op|')'
op|','
number|'2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'image_popularity'
op|'['
string|"'image-1'"
op|']'
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'image_cache_manager'
op|'.'
name|'image_popularity'
op|'['
string|"'image-2'"
op|']'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_list_backing_images_small
dedent|''
name|'def'
name|'test_list_backing_images_small'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'os'
op|','
string|"'listdir'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
op|'['
string|"'_base'"
op|','
string|"'instance-00000001'"
op|','
nl|'\n'
string|"'instance-00000002'"
op|','
string|"'instance-00000003'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'os'
op|'.'
name|'path'
op|','
string|"'exists'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
name|'x'
op|'.'
name|'find'
op|'('
string|"'instance-'"
op|')'
op|'!='
op|'-'
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'virtutils'
op|','
string|"'get_disk_backing_file'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3_sm'"
op|')'
newline|'\n'
nl|'\n'
name|'found'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'FLAGS'
op|'.'
name|'instances_path'
op|','
string|"'_base'"
op|','
nl|'\n'
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3_sm'"
op|')'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|'='
op|'['
name|'found'
op|']'
newline|'\n'
nl|'\n'
name|'inuse_images'
op|'='
name|'image_cache_manager'
op|'.'
name|'_list_backing_images'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'inuse_images'
op|','
op|'['
name|'found'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_list_backing_images_resized
dedent|''
name|'def'
name|'test_list_backing_images_resized'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'os'
op|','
string|"'listdir'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
op|'['
string|"'_base'"
op|','
string|"'instance-00000001'"
op|','
nl|'\n'
string|"'instance-00000002'"
op|','
string|"'instance-00000003'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'os'
op|'.'
name|'path'
op|','
string|"'exists'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
name|'x'
op|'.'
name|'find'
op|'('
string|"'instance-'"
op|')'
op|'!='
op|'-'
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'virtutils'
op|','
string|"'get_disk_backing_file'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
op|'('
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3_'"
nl|'\n'
string|"'10737418240'"
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'found'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'FLAGS'
op|'.'
name|'instances_path'
op|','
string|"'_base'"
op|','
nl|'\n'
string|"'e97222e91fc4241f49a7f520d1dcf446751129b3_'"
nl|'\n'
string|"'10737418240'"
op|')'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|'='
op|'['
name|'found'
op|']'
newline|'\n'
nl|'\n'
name|'inuse_images'
op|'='
name|'image_cache_manager'
op|'.'
name|'_list_backing_images'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'inuse_images'
op|','
op|'['
name|'found'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'len'
op|'('
name|'image_cache_manager'
op|'.'
name|'unexplained_images'
op|')'
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_find_base_file_nothing
dedent|''
name|'def'
name|'test_find_base_file_nothing'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'os'
op|'.'
name|'path'
op|','
string|"'exists'"
op|','
name|'lambda'
name|'x'
op|':'
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'base_dir'
op|'='
string|"'/var/lib/nova/instances/_base'"
newline|'\n'
name|'fingerprint'
op|'='
string|"'549867354867'"
newline|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'res'
op|'='
name|'list'
op|'('
name|'image_cache_manager'
op|'.'
name|'_find_base_file'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
number|'0'
op|','
name|'len'
op|'('
name|'res'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_find_base_file_small
dedent|''
name|'def'
name|'test_find_base_file_small'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'fingerprint'
op|'='
string|"'968dd6cc49e01aaa044ed11c0cce733e0fa44a6a'"
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'os'
op|'.'
name|'path'
op|','
string|"'exists'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
name|'x'
op|'.'
name|'endswith'
op|'('
string|"'%s_sm'"
op|'%'
name|'fingerprint'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'base_dir'
op|'='
string|"'/var/lib/nova/instances/_base'"
newline|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'res'
op|'='
name|'list'
op|'('
name|'image_cache_manager'
op|'.'
name|'_find_base_file'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'base_file'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|'+'
string|"'_sm'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'res'
op|'=='
op|'['
op|'('
name|'base_file'
op|','
name|'True'
op|','
name|'False'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_find_base_file_resized
dedent|''
name|'def'
name|'test_find_base_file_resized'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'fingerprint'
op|'='
string|"'968dd6cc49e01aaa044ed11c0cce733e0fa44a6a'"
newline|'\n'
name|'listing'
op|'='
op|'['
string|"'00000001'"
op|','
nl|'\n'
string|"'ephemeral_0_20_None'"
op|','
nl|'\n'
string|"'968dd6cc49e01aaa044ed11c0cce733e0fa44a6a_10737418240'"
op|','
nl|'\n'
string|"'00000004'"
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'os'
op|','
string|"'listdir'"
op|','
name|'lambda'
name|'x'
op|':'
name|'listing'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'os'
op|'.'
name|'path'
op|','
string|"'exists'"
op|','
nl|'\n'
name|'lambda'
name|'x'
op|':'
name|'x'
op|'.'
name|'endswith'
op|'('
string|"'%s_10737418240'"
op|'%'
name|'fingerprint'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'os'
op|'.'
name|'path'
op|','
string|"'isfile'"
op|','
name|'lambda'
name|'x'
op|':'
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'base_dir'
op|'='
string|"'/var/lib/nova/instances/_base'"
newline|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_list_base_images'
op|'('
name|'base_dir'
op|')'
newline|'\n'
name|'res'
op|'='
name|'list'
op|'('
name|'image_cache_manager'
op|'.'
name|'_find_base_file'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'base_file'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|'+'
string|"'_10737418240'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'res'
op|'=='
op|'['
op|'('
name|'base_file'
op|','
name|'False'
op|','
name|'True'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_find_base_file_all
dedent|''
name|'def'
name|'test_find_base_file_all'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'fingerprint'
op|'='
string|"'968dd6cc49e01aaa044ed11c0cce733e0fa44a6a'"
newline|'\n'
name|'listing'
op|'='
op|'['
string|"'00000001'"
op|','
nl|'\n'
string|"'ephemeral_0_20_None'"
op|','
nl|'\n'
string|"'968dd6cc49e01aaa044ed11c0cce733e0fa44a6a_sm'"
op|','
nl|'\n'
string|"'968dd6cc49e01aaa044ed11c0cce733e0fa44a6a_10737418240'"
op|','
nl|'\n'
string|"'00000004'"
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'os'
op|','
string|"'listdir'"
op|','
name|'lambda'
name|'x'
op|':'
name|'listing'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'os'
op|'.'
name|'path'
op|','
string|"'exists'"
op|','
name|'lambda'
name|'x'
op|':'
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'stubs'
op|'.'
name|'Set'
op|'('
name|'os'
op|'.'
name|'path'
op|','
string|"'isfile'"
op|','
name|'lambda'
name|'x'
op|':'
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'base_dir'
op|'='
string|"'/var/lib/nova/instances/_base'"
newline|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_list_base_images'
op|'('
name|'base_dir'
op|')'
newline|'\n'
name|'res'
op|'='
name|'list'
op|'('
name|'image_cache_manager'
op|'.'
name|'_find_base_file'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'base_file1'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|')'
newline|'\n'
name|'base_file2'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|'+'
string|"'_sm'"
op|')'
newline|'\n'
name|'base_file3'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base_dir'
op|','
name|'fingerprint'
op|'+'
string|"'_10737418240'"
op|')'
newline|'\n'
name|'print'
name|'res'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'res'
op|'=='
op|'['
op|'('
name|'base_file1'
op|','
name|'False'
op|','
name|'False'
op|')'
op|','
nl|'\n'
op|'('
name|'base_file2'
op|','
name|'True'
op|','
name|'False'
op|')'
op|','
nl|'\n'
op|'('
name|'base_file3'
op|','
name|'False'
op|','
name|'True'
op|')'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_verify_checksum
dedent|''
name|'def'
name|'test_verify_checksum'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'testdata'
op|'='
op|'('
string|"'OpenStack Software delivers a massively scalable cloud '"
nl|'\n'
string|"'operating system.'"
op|')'
newline|'\n'
name|'img'
op|'='
op|'{'
string|"'container_format'"
op|':'
string|"'ami'"
op|','
string|"'id'"
op|':'
string|"'42'"
op|'}'
newline|'\n'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'dirname'
op|'='
name|'tempfile'
op|'.'
name|'mkdtemp'
op|'('
op|')'
newline|'\n'
name|'fname'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'dirname'
op|','
string|"'aaa'"
op|')'
newline|'\n'
nl|'\n'
name|'f'
op|'='
name|'open'
op|'('
name|'fname'
op|','
string|"'w'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'write'
op|'('
name|'testdata'
op|')'
newline|'\n'
name|'f'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# Checksum is valid'
nl|'\n'
name|'f'
op|'='
name|'open'
op|'('
string|"'%s.sha1'"
op|'%'
name|'fname'
op|','
string|"'w'"
op|')'
newline|'\n'
name|'csum'
op|'='
name|'hashlib'
op|'.'
name|'sha1'
op|'('
op|')'
newline|'\n'
name|'csum'
op|'.'
name|'update'
op|'('
name|'testdata'
op|')'
newline|'\n'
name|'f'
op|'.'
name|'write'
op|'('
name|'csum'
op|'.'
name|'hexdigest'
op|'('
op|')'
op|')'
newline|'\n'
name|'f'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'res'
op|'='
name|'image_cache_manager'
op|'.'
name|'_verify_checksum'
op|'('
name|'img'
op|','
name|'fname'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'res'
op|')'
newline|'\n'
nl|'\n'
comment|'# Checksum is invalid'
nl|'\n'
name|'f'
op|'='
name|'open'
op|'('
string|"'%s.sha1'"
op|'%'
name|'fname'
op|','
string|"'w'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'write'
op|'('
string|"'banana'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'res'
op|'='
name|'image_cache_manager'
op|'.'
name|'_verify_checksum'
op|'('
name|'img'
op|','
name|'fname'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'res'
op|')'
newline|'\n'
nl|'\n'
comment|'# Checksum file missing'
nl|'\n'
name|'os'
op|'.'
name|'remove'
op|'('
string|"'%s.sha1'"
op|'%'
name|'fname'
op|')'
newline|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'res'
op|'='
name|'image_cache_manager'
op|'.'
name|'_verify_checksum'
op|'('
name|'img'
op|','
name|'fname'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'res'
op|','
name|'None'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'shutil'
op|'.'
name|'rmtree'
op|'('
name|'dirname'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_remove_base_file
dedent|''
dedent|''
name|'def'
name|'test_remove_base_file'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'dirname'
op|'='
name|'tempfile'
op|'.'
name|'mkdtemp'
op|'('
op|')'
newline|'\n'
name|'fname'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'dirname'
op|','
string|"'aaa'"
op|')'
newline|'\n'
nl|'\n'
name|'f'
op|'='
name|'open'
op|'('
name|'fname'
op|','
string|"'w'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'write'
op|'('
string|"'data'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'f'
op|'='
name|'open'
op|'('
string|"'%s.sha1'"
op|'%'
name|'fname'
op|','
string|"'w'"
op|')'
newline|'\n'
name|'f'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'image_cache_manager'
op|'='
name|'imagecache'
op|'.'
name|'ImageCacheManager'
op|'('
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_remove_base_file'
op|'('
name|'fname'
op|')'
newline|'\n'
nl|'\n'
comment|'# Files are initially too new to delete'
nl|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'fname'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertTrue'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
string|"'%s.sha1'"
op|'%'
name|'fname'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# Old files get cleaned up though'
nl|'\n'
name|'os'
op|'.'
name|'utime'
op|'('
name|'fname'
op|','
op|'('
op|'-'
number|'1'
op|','
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'-'
number|'100000'
op|')'
op|')'
newline|'\n'
name|'image_cache_manager'
op|'.'
name|'_remove_base_file'
op|'('
name|'fname'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'fname'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertFalse'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
string|"'%s.sha1'"
op|'%'
name|'fname'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'shutil'
op|'.'
name|'rmtree'
op|'('
name|'dirname'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
endmarker|''
end_unit
