begin_unit
name|'import'
name|'webob'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
name|'import'
name|'context'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'db'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'jsonutils'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'test'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'tests'
op|'.'
name|'api'
op|'.'
name|'openstack'
name|'import'
name|'fakes'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|app
name|'def'
name|'app'
op|'('
op|')'
op|':'
newline|'\n'
comment|"# no auth, just let environ['nova.context'] pass through"
nl|'\n'
indent|'    '
name|'api'
op|'='
name|'fakes'
op|'.'
name|'volume'
op|'.'
name|'APIRouter'
op|'('
op|')'
newline|'\n'
name|'mapper'
op|'='
name|'fakes'
op|'.'
name|'urlmap'
op|'.'
name|'URLMap'
op|'('
op|')'
newline|'\n'
name|'mapper'
op|'['
string|"'/v1'"
op|']'
op|'='
name|'api'
newline|'\n'
name|'return'
name|'mapper'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|AdminActionsTest
dedent|''
name|'class'
name|'AdminActionsTest'
op|'('
name|'test'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|test_reset_status_as_admin
indent|'    '
name|'def'
name|'test_reset_status_as_admin'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# admin context'
nl|'\n'
indent|'        '
name|'ctx'
op|'='
name|'context'
op|'.'
name|'RequestContext'
op|'('
string|"'admin'"
op|','
string|"'fake'"
op|','
name|'is_admin'
op|'='
name|'True'
op|')'
newline|'\n'
name|'ctx'
op|'.'
name|'elevated'
op|'('
op|')'
comment|'# add roles'
newline|'\n'
comment|'# current status is available'
nl|'\n'
name|'volume'
op|'='
name|'db'
op|'.'
name|'volume_create'
op|'('
name|'ctx'
op|','
op|'{'
string|"'status'"
op|':'
string|"'available'"
op|'}'
op|')'
newline|'\n'
name|'req'
op|'='
name|'webob'
op|'.'
name|'Request'
op|'.'
name|'blank'
op|'('
string|"'/v1/fake/volumes/%s/action'"
op|'%'
name|'volume'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'req'
op|'.'
name|'method'
op|'='
string|"'POST'"
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'content-type'"
op|']'
op|'='
string|"'application/json'"
newline|'\n'
comment|"# request status of 'error'"
nl|'\n'
name|'req'
op|'.'
name|'body'
op|'='
name|'jsonutils'
op|'.'
name|'dumps'
op|'('
op|'{'
string|"'os-reset_status'"
op|':'
op|'{'
string|"'status'"
op|':'
string|"'error'"
op|'}'
op|'}'
op|')'
newline|'\n'
comment|'# attach admin context to request'
nl|'\n'
name|'req'
op|'.'
name|'environ'
op|'['
string|"'nova.context'"
op|']'
op|'='
name|'ctx'
newline|'\n'
name|'resp'
op|'='
name|'req'
op|'.'
name|'get_response'
op|'('
name|'app'
op|'('
op|')'
op|')'
newline|'\n'
comment|'# request is accepted'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'resp'
op|'.'
name|'status_int'
op|','
number|'202'
op|')'
newline|'\n'
name|'volume'
op|'='
name|'db'
op|'.'
name|'volume_get'
op|'('
name|'ctx'
op|','
name|'volume'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
comment|"# status changed to 'error'"
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'volume'
op|'['
string|"'status'"
op|']'
op|','
string|"'error'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reset_status_as_non_admin
dedent|''
name|'def'
name|'test_reset_status_as_non_admin'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|"# current status is 'error'"
nl|'\n'
indent|'        '
name|'volume'
op|'='
name|'db'
op|'.'
name|'volume_create'
op|'('
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
op|','
nl|'\n'
op|'{'
string|"'status'"
op|':'
string|"'error'"
op|'}'
op|')'
newline|'\n'
name|'req'
op|'='
name|'webob'
op|'.'
name|'Request'
op|'.'
name|'blank'
op|'('
string|"'/v1/fake/volumes/%s/action'"
op|'%'
name|'volume'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'req'
op|'.'
name|'method'
op|'='
string|"'POST'"
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'content-type'"
op|']'
op|'='
string|"'application/json'"
newline|'\n'
comment|'# request changing status to available'
nl|'\n'
name|'req'
op|'.'
name|'body'
op|'='
name|'jsonutils'
op|'.'
name|'dumps'
op|'('
op|'{'
string|"'os-reset_status'"
op|':'
op|'{'
string|"'status'"
op|':'
nl|'\n'
string|"'available'"
op|'}'
op|'}'
op|')'
newline|'\n'
comment|'# non-admin context'
nl|'\n'
name|'req'
op|'.'
name|'environ'
op|'['
string|"'nova.context'"
op|']'
op|'='
name|'context'
op|'.'
name|'RequestContext'
op|'('
string|"'fake'"
op|','
string|"'fake'"
op|')'
newline|'\n'
name|'resp'
op|'='
name|'req'
op|'.'
name|'get_response'
op|'('
name|'app'
op|'('
op|')'
op|')'
newline|'\n'
comment|'# request is not authorized'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'resp'
op|'.'
name|'status_int'
op|','
number|'403'
op|')'
newline|'\n'
name|'volume'
op|'='
name|'db'
op|'.'
name|'volume_get'
op|'('
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
op|','
name|'volume'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
comment|"# status is still 'error'"
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'volume'
op|'['
string|"'status'"
op|']'
op|','
string|"'error'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_malformed_reset_status_body
dedent|''
name|'def'
name|'test_malformed_reset_status_body'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# admin context'
nl|'\n'
indent|'        '
name|'ctx'
op|'='
name|'context'
op|'.'
name|'RequestContext'
op|'('
string|"'admin'"
op|','
string|"'fake'"
op|','
name|'is_admin'
op|'='
name|'True'
op|')'
newline|'\n'
name|'ctx'
op|'.'
name|'elevated'
op|'('
op|')'
comment|'# add roles'
newline|'\n'
comment|'# current status is available'
nl|'\n'
name|'volume'
op|'='
name|'db'
op|'.'
name|'volume_create'
op|'('
name|'ctx'
op|','
op|'{'
string|"'status'"
op|':'
string|"'available'"
op|'}'
op|')'
newline|'\n'
name|'req'
op|'='
name|'webob'
op|'.'
name|'Request'
op|'.'
name|'blank'
op|'('
string|"'/v1/fake/volumes/%s/action'"
op|'%'
name|'volume'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'req'
op|'.'
name|'method'
op|'='
string|"'POST'"
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'content-type'"
op|']'
op|'='
string|"'application/json'"
newline|'\n'
comment|'# malformed request body'
nl|'\n'
name|'req'
op|'.'
name|'body'
op|'='
name|'jsonutils'
op|'.'
name|'dumps'
op|'('
op|'{'
string|"'os-reset_status'"
op|':'
op|'{'
string|"'x-status'"
op|':'
string|"'bad'"
op|'}'
op|'}'
op|')'
newline|'\n'
comment|'# attach admin context to request'
nl|'\n'
name|'req'
op|'.'
name|'environ'
op|'['
string|"'nova.context'"
op|']'
op|'='
name|'ctx'
newline|'\n'
name|'resp'
op|'='
name|'req'
op|'.'
name|'get_response'
op|'('
name|'app'
op|'('
op|')'
op|')'
newline|'\n'
comment|'# bad request'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'resp'
op|'.'
name|'status_int'
op|','
number|'400'
op|')'
newline|'\n'
name|'volume'
op|'='
name|'db'
op|'.'
name|'volume_get'
op|'('
name|'ctx'
op|','
name|'volume'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
comment|"# status is still 'available'"
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'volume'
op|'['
string|"'status'"
op|']'
op|','
string|"'available'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_invalid_status_for_volume
dedent|''
name|'def'
name|'test_invalid_status_for_volume'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# admin context'
nl|'\n'
indent|'        '
name|'ctx'
op|'='
name|'context'
op|'.'
name|'RequestContext'
op|'('
string|"'admin'"
op|','
string|"'fake'"
op|','
name|'is_admin'
op|'='
name|'True'
op|')'
newline|'\n'
name|'ctx'
op|'.'
name|'elevated'
op|'('
op|')'
comment|'# add roles'
newline|'\n'
comment|'# current status is available'
nl|'\n'
name|'volume'
op|'='
name|'db'
op|'.'
name|'volume_create'
op|'('
name|'ctx'
op|','
op|'{'
string|"'status'"
op|':'
string|"'available'"
op|'}'
op|')'
newline|'\n'
name|'req'
op|'='
name|'webob'
op|'.'
name|'Request'
op|'.'
name|'blank'
op|'('
string|"'/v1/fake/volumes/%s/action'"
op|'%'
name|'volume'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'req'
op|'.'
name|'method'
op|'='
string|"'POST'"
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'content-type'"
op|']'
op|'='
string|"'application/json'"
newline|'\n'
comment|"# 'invalid' is not a valid status"
nl|'\n'
name|'req'
op|'.'
name|'body'
op|'='
name|'jsonutils'
op|'.'
name|'dumps'
op|'('
op|'{'
string|"'os-reset_status'"
op|':'
op|'{'
string|"'status'"
op|':'
string|"'invalid'"
op|'}'
op|'}'
op|')'
newline|'\n'
comment|'# attach admin context to request'
nl|'\n'
name|'req'
op|'.'
name|'environ'
op|'['
string|"'nova.context'"
op|']'
op|'='
name|'ctx'
newline|'\n'
name|'resp'
op|'='
name|'req'
op|'.'
name|'get_response'
op|'('
name|'app'
op|'('
op|')'
op|')'
newline|'\n'
comment|'# bad request'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'resp'
op|'.'
name|'status_int'
op|','
number|'400'
op|')'
newline|'\n'
name|'volume'
op|'='
name|'db'
op|'.'
name|'volume_get'
op|'('
name|'ctx'
op|','
name|'volume'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
comment|"# status is still 'available'"
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'volume'
op|'['
string|"'status'"
op|']'
op|','
string|"'available'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_reset_status_for_missing_volume
dedent|''
name|'def'
name|'test_reset_status_for_missing_volume'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# admin context'
nl|'\n'
indent|'        '
name|'ctx'
op|'='
name|'context'
op|'.'
name|'RequestContext'
op|'('
string|"'admin'"
op|','
string|"'fake'"
op|','
name|'is_admin'
op|'='
name|'True'
op|')'
newline|'\n'
name|'ctx'
op|'.'
name|'elevated'
op|'('
op|')'
comment|'# add roles'
newline|'\n'
comment|'# missing-volume-id'
nl|'\n'
name|'req'
op|'='
name|'webob'
op|'.'
name|'Request'
op|'.'
name|'blank'
op|'('
string|"'/v1/fake/volumes/%s/action'"
op|'%'
nl|'\n'
string|"'missing-volume-id'"
op|')'
newline|'\n'
name|'req'
op|'.'
name|'method'
op|'='
string|"'POST'"
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'content-type'"
op|']'
op|'='
string|"'application/json'"
newline|'\n'
comment|'# malformed request body'
nl|'\n'
name|'req'
op|'.'
name|'body'
op|'='
name|'jsonutils'
op|'.'
name|'dumps'
op|'('
op|'{'
string|"'os-reset_status'"
op|':'
op|'{'
string|"'status'"
op|':'
nl|'\n'
string|"'available'"
op|'}'
op|'}'
op|')'
newline|'\n'
comment|'# attach admin context to request'
nl|'\n'
name|'req'
op|'.'
name|'environ'
op|'['
string|"'nova.context'"
op|']'
op|'='
name|'ctx'
newline|'\n'
name|'resp'
op|'='
name|'req'
op|'.'
name|'get_response'
op|'('
name|'app'
op|'('
op|')'
op|')'
newline|'\n'
comment|'# not found'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'resp'
op|'.'
name|'status_int'
op|','
number|'404'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'NotFound'
op|','
name|'db'
op|'.'
name|'volume_get'
op|','
name|'ctx'
op|','
nl|'\n'
string|"'missing-volume-id'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_snapshot_reset_status
dedent|''
name|'def'
name|'test_snapshot_reset_status'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# admin context'
nl|'\n'
indent|'        '
name|'ctx'
op|'='
name|'context'
op|'.'
name|'RequestContext'
op|'('
string|"'admin'"
op|','
string|"'fake'"
op|','
name|'is_admin'
op|'='
name|'True'
op|')'
newline|'\n'
name|'ctx'
op|'.'
name|'elevated'
op|'('
op|')'
comment|'# add roles'
newline|'\n'
comment|"# snapshot in 'error_deleting'"
nl|'\n'
name|'volume'
op|'='
name|'db'
op|'.'
name|'volume_create'
op|'('
name|'ctx'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
name|'snapshot'
op|'='
name|'db'
op|'.'
name|'snapshot_create'
op|'('
name|'ctx'
op|','
op|'{'
string|"'status'"
op|':'
string|"'error_deleting'"
op|','
nl|'\n'
string|"'volume_id'"
op|':'
name|'volume'
op|'['
string|"'id'"
op|']'
op|'}'
op|')'
newline|'\n'
name|'req'
op|'='
name|'webob'
op|'.'
name|'Request'
op|'.'
name|'blank'
op|'('
string|"'/v1/fake/snapshots/%s/action'"
op|'%'
nl|'\n'
name|'snapshot'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'req'
op|'.'
name|'method'
op|'='
string|"'POST'"
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'content-type'"
op|']'
op|'='
string|"'application/json'"
newline|'\n'
comment|"# request status of 'error'"
nl|'\n'
name|'req'
op|'.'
name|'body'
op|'='
name|'jsonutils'
op|'.'
name|'dumps'
op|'('
op|'{'
string|"'os-reset_status'"
op|':'
op|'{'
string|"'status'"
op|':'
string|"'error'"
op|'}'
op|'}'
op|')'
newline|'\n'
comment|'# attach admin context to request'
nl|'\n'
name|'req'
op|'.'
name|'environ'
op|'['
string|"'nova.context'"
op|']'
op|'='
name|'ctx'
newline|'\n'
name|'resp'
op|'='
name|'req'
op|'.'
name|'get_response'
op|'('
name|'app'
op|'('
op|')'
op|')'
newline|'\n'
comment|'# request is accepted'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'resp'
op|'.'
name|'status_int'
op|','
number|'202'
op|')'
newline|'\n'
name|'snapshot'
op|'='
name|'db'
op|'.'
name|'snapshot_get'
op|'('
name|'ctx'
op|','
name|'snapshot'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
comment|"# status changed to 'error'"
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'snapshot'
op|'['
string|"'status'"
op|']'
op|','
string|"'error'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_invalid_status_for_snapshot
dedent|''
name|'def'
name|'test_invalid_status_for_snapshot'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# admin context'
nl|'\n'
indent|'        '
name|'ctx'
op|'='
name|'context'
op|'.'
name|'RequestContext'
op|'('
string|"'admin'"
op|','
string|"'fake'"
op|','
name|'is_admin'
op|'='
name|'True'
op|')'
newline|'\n'
name|'ctx'
op|'.'
name|'elevated'
op|'('
op|')'
comment|'# add roles'
newline|'\n'
comment|"# snapshot in 'available'"
nl|'\n'
name|'volume'
op|'='
name|'db'
op|'.'
name|'volume_create'
op|'('
name|'ctx'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
name|'snapshot'
op|'='
name|'db'
op|'.'
name|'snapshot_create'
op|'('
name|'ctx'
op|','
op|'{'
string|"'status'"
op|':'
string|"'available'"
op|','
nl|'\n'
string|"'volume_id'"
op|':'
name|'volume'
op|'['
string|"'id'"
op|']'
op|'}'
op|')'
newline|'\n'
name|'req'
op|'='
name|'webob'
op|'.'
name|'Request'
op|'.'
name|'blank'
op|'('
string|"'/v1/fake/snapshots/%s/action'"
op|'%'
nl|'\n'
name|'snapshot'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'req'
op|'.'
name|'method'
op|'='
string|"'POST'"
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'content-type'"
op|']'
op|'='
string|"'application/json'"
newline|'\n'
comment|"# 'attaching' is not a valid status for snapshots"
nl|'\n'
name|'req'
op|'.'
name|'body'
op|'='
name|'jsonutils'
op|'.'
name|'dumps'
op|'('
op|'{'
string|"'os-reset_status'"
op|':'
op|'{'
string|"'status'"
op|':'
nl|'\n'
string|"'attaching'"
op|'}'
op|'}'
op|')'
newline|'\n'
comment|'# attach admin context to request'
nl|'\n'
name|'req'
op|'.'
name|'environ'
op|'['
string|"'nova.context'"
op|']'
op|'='
name|'ctx'
newline|'\n'
name|'resp'
op|'='
name|'req'
op|'.'
name|'get_response'
op|'('
name|'app'
op|'('
op|')'
op|')'
newline|'\n'
comment|'# request is accepted'
nl|'\n'
name|'print'
name|'resp'
newline|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'resp'
op|'.'
name|'status_int'
op|','
number|'400'
op|')'
newline|'\n'
name|'snapshot'
op|'='
name|'db'
op|'.'
name|'snapshot_get'
op|'('
name|'ctx'
op|','
name|'snapshot'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
comment|"# status is still 'available'"
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'snapshot'
op|'['
string|"'status'"
op|']'
op|','
string|"'available'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_force_delete
dedent|''
name|'def'
name|'test_force_delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# admin context'
nl|'\n'
indent|'        '
name|'ctx'
op|'='
name|'context'
op|'.'
name|'RequestContext'
op|'('
string|"'admin'"
op|','
string|"'fake'"
op|','
name|'is_admin'
op|'='
name|'True'
op|')'
newline|'\n'
name|'ctx'
op|'.'
name|'elevated'
op|'('
op|')'
comment|'# add roles'
newline|'\n'
comment|'# current status is creating'
nl|'\n'
name|'volume'
op|'='
name|'db'
op|'.'
name|'volume_create'
op|'('
name|'ctx'
op|','
op|'{'
string|"'status'"
op|':'
string|"'creating'"
op|'}'
op|')'
newline|'\n'
name|'req'
op|'='
name|'webob'
op|'.'
name|'Request'
op|'.'
name|'blank'
op|'('
string|"'/v1/fake/volumes/%s/action'"
op|'%'
name|'volume'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'req'
op|'.'
name|'method'
op|'='
string|"'POST'"
newline|'\n'
name|'req'
op|'.'
name|'headers'
op|'['
string|"'content-type'"
op|']'
op|'='
string|"'application/json'"
newline|'\n'
name|'req'
op|'.'
name|'body'
op|'='
name|'jsonutils'
op|'.'
name|'dumps'
op|'('
op|'{'
string|"'os-force_delete'"
op|':'
op|'{'
op|'}'
op|'}'
op|')'
newline|'\n'
comment|'# attach admin context to request'
nl|'\n'
name|'req'
op|'.'
name|'environ'
op|'['
string|"'nova.context'"
op|']'
op|'='
name|'ctx'
newline|'\n'
name|'resp'
op|'='
name|'req'
op|'.'
name|'get_response'
op|'('
name|'app'
op|'('
op|')'
op|')'
newline|'\n'
comment|'# request is accepted'
nl|'\n'
name|'self'
op|'.'
name|'assertEquals'
op|'('
name|'resp'
op|'.'
name|'status_int'
op|','
number|'202'
op|')'
newline|'\n'
comment|'# volume is deleted'
nl|'\n'
name|'self'
op|'.'
name|'assertRaises'
op|'('
name|'exception'
op|'.'
name|'NotFound'
op|','
name|'db'
op|'.'
name|'volume_get'
op|','
name|'ctx'
op|','
name|'volume'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
