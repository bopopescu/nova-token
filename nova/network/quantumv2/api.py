begin_unit
comment|'# Copyright 2012 OpenStack Foundation'
nl|'\n'
comment|'# All Rights Reserved'
nl|'\n'
comment|'# Copyright (c) 2012 NEC Corporation'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# vim: tabstop=4 shiftwidth=4 softtabstop=4'
nl|'\n'
nl|'\n'
name|'import'
name|'time'
newline|'\n'
nl|'\n'
name|'from'
name|'oslo'
op|'.'
name|'config'
name|'import'
name|'cfg'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
op|'.'
name|'compute'
name|'import'
name|'flavors'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'conductor'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'context'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'db'
name|'import'
name|'base'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'network'
name|'import'
name|'api'
name|'as'
name|'network_api'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'network'
name|'import'
name|'model'
name|'as'
name|'network_model'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'network'
name|'import'
name|'quantumv2'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'network'
op|'.'
name|'security_group'
name|'import'
name|'openstack_driver'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'excutils'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'log'
name|'as'
name|'logging'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'uuidutils'
newline|'\n'
nl|'\n'
name|'import'
name|'quantumclient'
op|'.'
name|'common'
op|'.'
name|'exceptions'
newline|'\n'
nl|'\n'
DECL|variable|quantum_opts
name|'quantum_opts'
op|'='
op|'['
nl|'\n'
name|'cfg'
op|'.'
name|'StrOpt'
op|'('
string|"'quantum_url'"
op|','
nl|'\n'
DECL|variable|default
name|'default'
op|'='
string|"'http://127.0.0.1:9696'"
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'URL for connecting to quantum'"
op|')'
op|','
nl|'\n'
name|'cfg'
op|'.'
name|'IntOpt'
op|'('
string|"'quantum_url_timeout'"
op|','
nl|'\n'
DECL|variable|default
name|'default'
op|'='
number|'30'
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'timeout value for connecting to quantum in seconds'"
op|')'
op|','
nl|'\n'
name|'cfg'
op|'.'
name|'StrOpt'
op|'('
string|"'quantum_admin_username'"
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'username for connecting to quantum in admin context'"
op|')'
op|','
nl|'\n'
name|'cfg'
op|'.'
name|'StrOpt'
op|'('
string|"'quantum_admin_password'"
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'password for connecting to quantum in admin context'"
op|','
nl|'\n'
DECL|variable|secret
name|'secret'
op|'='
name|'True'
op|')'
op|','
nl|'\n'
name|'cfg'
op|'.'
name|'StrOpt'
op|'('
string|"'quantum_admin_tenant_name'"
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'tenant name for connecting to quantum in admin context'"
op|')'
op|','
nl|'\n'
name|'cfg'
op|'.'
name|'StrOpt'
op|'('
string|"'quantum_region_name'"
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'region name for connecting to quantum in admin context'"
op|')'
op|','
nl|'\n'
name|'cfg'
op|'.'
name|'StrOpt'
op|'('
string|"'quantum_admin_auth_url'"
op|','
nl|'\n'
DECL|variable|default
name|'default'
op|'='
string|"'http://localhost:5000/v2.0'"
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'auth url for connecting to quantum in admin context'"
op|')'
op|','
nl|'\n'
name|'cfg'
op|'.'
name|'BoolOpt'
op|'('
string|"'quantum_api_insecure'"
op|','
nl|'\n'
DECL|variable|default
name|'default'
op|'='
name|'False'
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'if set, ignore any SSL validation issues'"
op|')'
op|','
nl|'\n'
name|'cfg'
op|'.'
name|'StrOpt'
op|'('
string|"'quantum_auth_strategy'"
op|','
nl|'\n'
DECL|variable|default
name|'default'
op|'='
string|"'keystone'"
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'auth strategy for connecting to '"
nl|'\n'
string|"'quantum in admin context'"
op|')'
op|','
nl|'\n'
comment|'# TODO(berrange) temporary hack until Quantum can pass over the'
nl|'\n'
comment|'# name of the OVS bridge it is configured with'
nl|'\n'
name|'cfg'
op|'.'
name|'StrOpt'
op|'('
string|"'quantum_ovs_bridge'"
op|','
nl|'\n'
DECL|variable|default
name|'default'
op|'='
string|"'br-int'"
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'Name of Integration Bridge used by Open vSwitch'"
op|')'
op|','
nl|'\n'
name|'cfg'
op|'.'
name|'IntOpt'
op|'('
string|"'quantum_extension_sync_interval'"
op|','
nl|'\n'
DECL|variable|default
name|'default'
op|'='
number|'600'
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'Number of seconds before querying quantum for'"
nl|'\n'
string|"' extensions'"
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
DECL|variable|CONF
name|'CONF'
op|'='
name|'cfg'
op|'.'
name|'CONF'
newline|'\n'
name|'CONF'
op|'.'
name|'register_opts'
op|'('
name|'quantum_opts'
op|')'
newline|'\n'
name|'CONF'
op|'.'
name|'import_opt'
op|'('
string|"'default_floating_pool'"
op|','
string|"'nova.network.floating_ips'"
op|')'
newline|'\n'
name|'CONF'
op|'.'
name|'import_opt'
op|'('
string|"'flat_injected'"
op|','
string|"'nova.network.manager'"
op|')'
newline|'\n'
DECL|variable|LOG
name|'LOG'
op|'='
name|'logging'
op|'.'
name|'getLogger'
op|'('
name|'__name__'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|NET_EXTERNAL
name|'NET_EXTERNAL'
op|'='
string|"'router:external'"
newline|'\n'
nl|'\n'
DECL|variable|refresh_cache
name|'refresh_cache'
op|'='
name|'network_api'
op|'.'
name|'refresh_cache'
newline|'\n'
DECL|variable|update_instance_info_cache
name|'update_instance_info_cache'
op|'='
name|'network_api'
op|'.'
name|'update_instance_cache_with_nw_info'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|API
name|'class'
name|'API'
op|'('
name|'base'
op|'.'
name|'Base'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""API for interacting with the quantum 2.x API."""'
newline|'\n'
nl|'\n'
DECL|variable|conductor_api
name|'conductor_api'
op|'='
name|'conductor'
op|'.'
name|'API'
op|'('
op|')'
newline|'\n'
DECL|variable|security_group_api
name|'security_group_api'
op|'='
name|'openstack_driver'
op|'.'
name|'get_openstack_security_group_driver'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'API'
op|','
name|'self'
op|')'
op|'.'
name|'__init__'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'last_quantum_extension_sync'
op|'='
name|'None'
newline|'\n'
name|'self'
op|'.'
name|'extensions'
op|'='
op|'{'
op|'}'
newline|'\n'
nl|'\n'
DECL|member|setup_networks_on_host
dedent|''
name|'def'
name|'setup_networks_on_host'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'host'
op|'='
name|'None'
op|','
nl|'\n'
name|'teardown'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Setup or teardown the network structures."""'
newline|'\n'
nl|'\n'
DECL|member|_get_available_networks
dedent|''
name|'def'
name|'_get_available_networks'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'project_id'
op|','
nl|'\n'
name|'net_ids'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return a network list available for the tenant.\n        The list contains networks owned by the tenant and public networks.\n        If net_ids specified, it searches networks with requested IDs only.\n        """'
newline|'\n'
name|'quantum'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
newline|'\n'
nl|'\n'
comment|'# If user has specified to attach instance only to specific'
nl|'\n'
comment|'# networks, add them to **search_opts'
nl|'\n'
comment|'# (1) Retrieve non-public network list owned by the tenant.'
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|'"tenant_id"'
op|':'
name|'project_id'
op|','
string|"'shared'"
op|':'
name|'False'
op|'}'
newline|'\n'
name|'if'
name|'net_ids'
op|':'
newline|'\n'
indent|'            '
name|'search_opts'
op|'['
string|"'id'"
op|']'
op|'='
name|'net_ids'
newline|'\n'
dedent|''
name|'nets'
op|'='
name|'quantum'
op|'.'
name|'list_networks'
op|'('
op|'**'
name|'search_opts'
op|')'
op|'.'
name|'get'
op|'('
string|"'networks'"
op|','
op|'['
op|']'
op|')'
newline|'\n'
comment|'# (2) Retrieve public network list.'
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'shared'"
op|':'
name|'True'
op|'}'
newline|'\n'
name|'if'
name|'net_ids'
op|':'
newline|'\n'
indent|'            '
name|'search_opts'
op|'['
string|"'id'"
op|']'
op|'='
name|'net_ids'
newline|'\n'
dedent|''
name|'nets'
op|'+='
name|'quantum'
op|'.'
name|'list_networks'
op|'('
op|'**'
name|'search_opts'
op|')'
op|'.'
name|'get'
op|'('
string|"'networks'"
op|','
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'_ensure_requested_network_ordering'
op|'('
nl|'\n'
name|'lambda'
name|'x'
op|':'
name|'x'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'nets'
op|','
nl|'\n'
name|'net_ids'
op|')'
newline|'\n'
nl|'\n'
name|'return'
name|'nets'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'refresh_cache'
newline|'\n'
DECL|member|allocate_for_instance
name|'def'
name|'allocate_for_instance'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Allocate network resources for the instance.\n\n        :param requested_networks: optional value containing\n            network_id, fixed_ip, and port_id\n        :param security_groups: security groups to allocate for instance\n        :param macs: None or a set of MAC addresses that the instance\n            should use. macs is supplied by the hypervisor driver (contrast\n            with requested_networks which is user supplied).\n            NB: QuantumV2 currently assigns hypervisor supplied MAC addresses\n            to arbitrary networks, which requires openflow switches to\n            function correctly if more than one network is being used with\n            the bare metal hypervisor (which is the only one known to limit\n            MAC addresses).\n        """'
newline|'\n'
name|'hypervisor_macs'
op|'='
name|'kwargs'
op|'.'
name|'get'
op|'('
string|"'macs'"
op|','
name|'None'
op|')'
newline|'\n'
name|'available_macs'
op|'='
name|'None'
newline|'\n'
name|'if'
name|'hypervisor_macs'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
comment|'# Make a copy we can mutate: records macs that have not been used'
nl|'\n'
comment|'# to create a port on a network. If we find a mac with a'
nl|'\n'
comment|'# pre-allocated port we also remove it from this set.'
nl|'\n'
indent|'            '
name|'available_macs'
op|'='
name|'set'
op|'('
name|'hypervisor_macs'
op|')'
newline|'\n'
dedent|''
name|'quantum'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|"'allocate_for_instance() for %s'"
op|')'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'display_name'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'instance'
op|'['
string|"'project_id'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'msg'
op|'='
name|'_'
op|'('
string|"'empty project id for instance %s'"
op|')'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'InvalidInput'
op|'('
nl|'\n'
name|'reason'
op|'='
name|'msg'
op|'%'
name|'instance'
op|'['
string|"'display_name'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'requested_networks'
op|'='
name|'kwargs'
op|'.'
name|'get'
op|'('
string|"'requested_networks'"
op|')'
newline|'\n'
name|'ports'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'fixed_ips'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'net_ids'
op|'='
op|'['
op|']'
newline|'\n'
name|'if'
name|'requested_networks'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'network_id'
op|','
name|'fixed_ip'
op|','
name|'port_id'
name|'in'
name|'requested_networks'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'port_id'
op|':'
newline|'\n'
indent|'                    '
name|'port'
op|'='
name|'quantum'
op|'.'
name|'show_port'
op|'('
name|'port_id'
op|')'
op|'['
string|"'port'"
op|']'
newline|'\n'
name|'if'
name|'hypervisor_macs'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'                        '
name|'if'
name|'port'
op|'['
string|"'mac_address'"
op|']'
name|'not'
name|'in'
name|'hypervisor_macs'
op|':'
newline|'\n'
indent|'                            '
name|'raise'
name|'exception'
op|'.'
name|'PortNotUsable'
op|'('
name|'port_id'
op|'='
name|'port_id'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|'['
string|"'display_name'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
comment|"# Don't try to use this MAC if we need to create a"
nl|'\n'
comment|'# port on the fly later. Identical MACs may be'
nl|'\n'
comment|'# configured by users into multiple ports so we'
nl|'\n'
comment|'# discard rather than popping.'
nl|'\n'
indent|'                            '
name|'available_macs'
op|'.'
name|'discard'
op|'('
name|'port'
op|'['
string|"'mac_address'"
op|']'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'network_id'
op|'='
name|'port'
op|'['
string|"'network_id'"
op|']'
newline|'\n'
name|'ports'
op|'['
name|'network_id'
op|']'
op|'='
name|'port'
newline|'\n'
dedent|''
name|'elif'
name|'fixed_ip'
name|'and'
name|'network_id'
op|':'
newline|'\n'
indent|'                    '
name|'fixed_ips'
op|'['
name|'network_id'
op|']'
op|'='
name|'fixed_ip'
newline|'\n'
dedent|''
name|'if'
name|'network_id'
op|':'
newline|'\n'
indent|'                    '
name|'net_ids'
op|'.'
name|'append'
op|'('
name|'network_id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
name|'nets'
op|'='
name|'self'
op|'.'
name|'_get_available_networks'
op|'('
name|'context'
op|','
name|'instance'
op|'['
string|"'project_id'"
op|']'
op|','
nl|'\n'
name|'net_ids'
op|')'
newline|'\n'
name|'security_groups'
op|'='
name|'kwargs'
op|'.'
name|'get'
op|'('
string|"'security_groups'"
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'security_group_ids'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
comment|'# TODO(arosen) Should optimize more to do direct query for security'
nl|'\n'
comment|'# group if len(security_groups) == 1'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'security_groups'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'search_opts'
op|'='
op|'{'
string|"'tenant_id'"
op|':'
name|'instance'
op|'['
string|"'project_id'"
op|']'
op|'}'
newline|'\n'
name|'user_security_groups'
op|'='
name|'quantum'
op|'.'
name|'list_security_groups'
op|'('
nl|'\n'
op|'**'
name|'search_opts'
op|')'
op|'.'
name|'get'
op|'('
string|"'security_groups'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'for'
name|'security_group'
name|'in'
name|'security_groups'
op|':'
newline|'\n'
indent|'            '
name|'name_match'
op|'='
name|'None'
newline|'\n'
name|'uuid_match'
op|'='
name|'None'
newline|'\n'
name|'for'
name|'user_security_group'
name|'in'
name|'user_security_groups'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'user_security_group'
op|'['
string|"'name'"
op|']'
op|'=='
name|'security_group'
op|':'
newline|'\n'
indent|'                    '
name|'if'
name|'name_match'
op|':'
newline|'\n'
indent|'                        '
name|'msg'
op|'='
op|'('
name|'_'
op|'('
string|'"Multiple security groups found matching"'
nl|'\n'
string|'" \'%s\'. Use an ID to be more specific."'
op|')'
op|','
nl|'\n'
name|'security_group'
op|')'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'NoUniqueMatch'
op|'('
name|'msg'
op|')'
newline|'\n'
dedent|''
name|'name_match'
op|'='
name|'user_security_group'
op|'['
string|"'id'"
op|']'
newline|'\n'
dedent|''
name|'if'
name|'user_security_group'
op|'['
string|"'id'"
op|']'
op|'=='
name|'security_group'
op|':'
newline|'\n'
indent|'                    '
name|'uuid_match'
op|'='
name|'user_security_group'
op|'['
string|"'id'"
op|']'
newline|'\n'
nl|'\n'
comment|'# If a user names the security group the same as'
nl|'\n'
comment|"# another's security groups uuid, the name takes priority."
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'not'
name|'name_match'
name|'and'
name|'not'
name|'uuid_match'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'exception'
op|'.'
name|'SecurityGroupNotFound'
op|'('
nl|'\n'
name|'security_group_id'
op|'='
name|'security_group'
op|')'
newline|'\n'
name|'security_group_ids'
op|'.'
name|'append'
op|'('
name|'name_match'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'name_match'
op|':'
newline|'\n'
indent|'                '
name|'security_group_ids'
op|'.'
name|'append'
op|'('
name|'name_match'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'uuid_match'
op|':'
newline|'\n'
indent|'                '
name|'security_group_ids'
op|'.'
name|'append'
op|'('
name|'uuid_match'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'touched_port_ids'
op|'='
op|'['
op|']'
newline|'\n'
name|'created_port_ids'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'network'
name|'in'
name|'nets'
op|':'
newline|'\n'
comment|'# If security groups are requested on an instance then the'
nl|'\n'
comment|'# network must has a subnet associated with it. Some plugins'
nl|'\n'
comment|'# implement the port-security extension which requires'
nl|'\n'
comment|"# 'port_security_enabled' to be True for security groups."
nl|'\n'
comment|"# That is why True is returned if 'port_security_enabled'"
nl|'\n'
comment|'# is not found.'
nl|'\n'
indent|'            '
name|'if'
op|'('
name|'security_groups'
name|'and'
name|'not'
op|'('
nl|'\n'
name|'network'
op|'['
string|"'subnets'"
op|']'
nl|'\n'
name|'and'
name|'network'
op|'.'
name|'get'
op|'('
string|"'port_security_enabled'"
op|','
name|'True'
op|')'
op|')'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'                '
name|'raise'
name|'exception'
op|'.'
name|'SecurityGroupCannotBeApplied'
op|'('
op|')'
newline|'\n'
dedent|''
name|'network_id'
op|'='
name|'network'
op|'['
string|"'id'"
op|']'
newline|'\n'
name|'zone'
op|'='
string|"'compute:%s'"
op|'%'
name|'instance'
op|'['
string|"'availability_zone'"
op|']'
newline|'\n'
name|'port_req_body'
op|'='
op|'{'
string|"'port'"
op|':'
op|'{'
string|"'device_id'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
string|"'device_owner'"
op|':'
name|'zone'
op|'}'
op|'}'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'port'
op|'='
name|'ports'
op|'.'
name|'get'
op|'('
name|'network_id'
op|')'
newline|'\n'
name|'if'
name|'port'
op|':'
newline|'\n'
indent|'                    '
name|'quantum'
op|'.'
name|'update_port'
op|'('
name|'port'
op|'['
string|"'id'"
op|']'
op|','
name|'port_req_body'
op|')'
newline|'\n'
name|'touched_port_ids'
op|'.'
name|'append'
op|'('
name|'port'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'fixed_ip'
op|'='
name|'fixed_ips'
op|'.'
name|'get'
op|'('
name|'network_id'
op|')'
newline|'\n'
name|'if'
name|'fixed_ip'
op|':'
newline|'\n'
indent|'                        '
name|'port_req_body'
op|'['
string|"'port'"
op|']'
op|'['
string|"'fixed_ips'"
op|']'
op|'='
op|'['
op|'{'
string|"'ip_address'"
op|':'
nl|'\n'
name|'fixed_ip'
op|'}'
op|']'
newline|'\n'
dedent|''
name|'port_req_body'
op|'['
string|"'port'"
op|']'
op|'['
string|"'network_id'"
op|']'
op|'='
name|'network_id'
newline|'\n'
name|'port_req_body'
op|'['
string|"'port'"
op|']'
op|'['
string|"'admin_state_up'"
op|']'
op|'='
name|'True'
newline|'\n'
name|'port_req_body'
op|'['
string|"'port'"
op|']'
op|'['
string|"'tenant_id'"
op|']'
op|'='
name|'instance'
op|'['
string|"'project_id'"
op|']'
newline|'\n'
name|'if'
name|'security_group_ids'
op|':'
newline|'\n'
indent|'                        '
name|'port_req_body'
op|'['
string|"'port'"
op|']'
op|'['
string|"'security_groups'"
op|']'
op|'='
op|'('
nl|'\n'
name|'security_group_ids'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'available_macs'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'                        '
name|'if'
name|'not'
name|'available_macs'
op|':'
newline|'\n'
indent|'                            '
name|'raise'
name|'exception'
op|'.'
name|'PortNotFree'
op|'('
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|'['
string|"'display_name'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'mac_address'
op|'='
name|'available_macs'
op|'.'
name|'pop'
op|'('
op|')'
newline|'\n'
name|'port_req_body'
op|'['
string|"'port'"
op|']'
op|'['
string|"'mac_address'"
op|']'
op|'='
name|'mac_address'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'_populate_quantum_extension_values'
op|'('
name|'instance'
op|','
nl|'\n'
name|'port_req_body'
op|')'
newline|'\n'
name|'created_port_ids'
op|'.'
name|'append'
op|'('
nl|'\n'
name|'quantum'
op|'.'
name|'create_port'
op|'('
name|'port_req_body'
op|')'
op|'['
string|"'port'"
op|']'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
indent|'                '
name|'with'
name|'excutils'
op|'.'
name|'save_and_reraise_exception'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'for'
name|'port_id'
name|'in'
name|'touched_port_ids'
op|':'
newline|'\n'
indent|'                        '
name|'port_in_server'
op|'='
name|'quantum'
op|'.'
name|'show_port'
op|'('
name|'port_id'
op|')'
op|'.'
name|'get'
op|'('
string|"'port'"
op|')'
newline|'\n'
name|'if'
name|'not'
name|'port_in_server'
op|':'
newline|'\n'
indent|'                            '
name|'raise'
name|'Exception'
op|'('
name|'_'
op|'('
string|"'Port not found'"
op|')'
op|')'
newline|'\n'
dedent|''
name|'port_req_body'
op|'='
op|'{'
string|"'port'"
op|':'
op|'{'
string|"'device_id'"
op|':'
name|'None'
op|'}'
op|'}'
newline|'\n'
name|'quantum'
op|'.'
name|'update_port'
op|'('
name|'port_id'
op|','
name|'port_req_body'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'for'
name|'port_id'
name|'in'
name|'created_port_ids'
op|':'
newline|'\n'
indent|'                        '
name|'try'
op|':'
newline|'\n'
indent|'                            '
name|'quantum'
op|'.'
name|'delete_port'
op|'('
name|'port_id'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
name|'as'
name|'ex'
op|':'
newline|'\n'
indent|'                            '
name|'msg'
op|'='
name|'_'
op|'('
string|'"Fail to delete port %(portid)s with"'
nl|'\n'
string|'" failure: %(exception)s"'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'msg'
op|','
op|'{'
string|"'portid'"
op|':'
name|'port_id'
op|','
nl|'\n'
string|"'exception'"
op|':'
name|'ex'
op|'}'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
dedent|''
dedent|''
name|'nw_info'
op|'='
name|'self'
op|'.'
name|'_get_instance_nw_info'
op|'('
name|'context'
op|','
name|'instance'
op|','
name|'networks'
op|'='
name|'nets'
op|')'
newline|'\n'
comment|'# NOTE(danms): Only return info about ports we created in this run.'
nl|'\n'
comment|'# In the initial allocation case, this will be everything we created,'
nl|'\n'
comment|'# and in later runs will only be what was created that time. Thus,'
nl|'\n'
comment|'# this only affects the attach case, not the original use for this'
nl|'\n'
comment|'# method.'
nl|'\n'
name|'return'
name|'network_model'
op|'.'
name|'NetworkInfo'
op|'('
op|'['
name|'port'
name|'for'
name|'port'
name|'in'
name|'nw_info'
nl|'\n'
name|'if'
name|'port'
op|'['
string|"'id'"
op|']'
name|'in'
name|'created_port_ids'
op|'+'
nl|'\n'
name|'touched_port_ids'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_refresh_quantum_extensions_cache
dedent|''
name|'def'
name|'_refresh_quantum_extensions_cache'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Refresh the quantum extensions cache when necessary."""'
newline|'\n'
name|'if'
op|'('
name|'not'
name|'self'
op|'.'
name|'last_quantum_extension_sync'
name|'or'
nl|'\n'
op|'('
op|'('
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'-'
name|'self'
op|'.'
name|'last_quantum_extension_sync'
op|')'
nl|'\n'
op|'>='
name|'CONF'
op|'.'
name|'quantum_extension_sync_interval'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'quantum'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
op|')'
newline|'\n'
name|'extensions_list'
op|'='
name|'quantum'
op|'.'
name|'list_extensions'
op|'('
op|')'
op|'['
string|"'extensions'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'last_quantum_extension_sync'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'extensions'
op|'.'
name|'clear'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'extensions'
op|'='
name|'dict'
op|'('
op|'('
name|'ext'
op|'['
string|"'name'"
op|']'
op|','
name|'ext'
op|')'
nl|'\n'
name|'for'
name|'ext'
name|'in'
name|'extensions_list'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_populate_quantum_extension_values
dedent|''
dedent|''
name|'def'
name|'_populate_quantum_extension_values'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'port_req_body'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Populate quantum extension values for the instance.\n\n        If the extension contains nvp-qos then get the rxtx_factor.\n        """'
newline|'\n'
name|'self'
op|'.'
name|'_refresh_quantum_extensions_cache'
op|'('
op|')'
newline|'\n'
name|'if'
string|"'nvp-qos'"
name|'in'
name|'self'
op|'.'
name|'extensions'
op|':'
newline|'\n'
indent|'            '
name|'instance_type'
op|'='
name|'flavors'
op|'.'
name|'extract_flavor'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'rxtx_factor'
op|'='
name|'instance_type'
op|'.'
name|'get'
op|'('
string|"'rxtx_factor'"
op|')'
newline|'\n'
name|'port_req_body'
op|'['
string|"'port'"
op|']'
op|'['
string|"'rxtx_factor'"
op|']'
op|'='
name|'rxtx_factor'
newline|'\n'
nl|'\n'
DECL|member|deallocate_for_instance
dedent|''
dedent|''
name|'def'
name|'deallocate_for_instance'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Deallocate all network resources related to the instance."""'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|"'deallocate_for_instance() for %s'"
op|')'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'display_name'"
op|']'
op|')'
newline|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'device_id'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|'}'
newline|'\n'
name|'data'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
op|'.'
name|'list_ports'
op|'('
op|'**'
name|'search_opts'
op|')'
newline|'\n'
name|'ports'
op|'='
name|'data'
op|'.'
name|'get'
op|'('
string|"'ports'"
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'for'
name|'port'
name|'in'
name|'ports'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
op|'.'
name|'delete_port'
op|'('
name|'port'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'exception'
op|'('
name|'_'
op|'('
string|'"Failed to delete quantum port %(portid)s "'
op|')'
nl|'\n'
op|'%'
op|'{'
string|"'portid'"
op|':'
name|'port'
op|'['
string|"'id'"
op|']'
op|'}'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
op|'@'
name|'refresh_cache'
newline|'\n'
DECL|member|allocate_port_for_instance
name|'def'
name|'allocate_port_for_instance'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'port_id'
op|','
nl|'\n'
name|'network_id'
op|'='
name|'None'
op|','
name|'requested_ip'
op|'='
name|'None'
op|','
nl|'\n'
name|'conductor_api'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Allocate a port for the instance."""'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'allocate_for_instance'
op|'('
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'requested_networks'
op|'='
op|'['
op|'('
name|'network_id'
op|','
name|'requested_ip'
op|','
name|'port_id'
op|')'
op|']'
op|','
nl|'\n'
name|'conductor_api'
op|'='
name|'conductor_api'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'refresh_cache'
newline|'\n'
DECL|member|deallocate_port_for_instance
name|'def'
name|'deallocate_port_for_instance'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'port_id'
op|','
nl|'\n'
name|'conductor_api'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Remove a specified port from the instance.\n\n        Return network information for the instance\n        """'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
op|'.'
name|'delete_port'
op|'('
name|'port_id'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
name|'as'
name|'ex'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'exception'
op|'('
name|'_'
op|'('
string|'"Failed to delete quantum port %(port_id)s "'
op|')'
op|'%'
nl|'\n'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'_get_instance_nw_info'
op|'('
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|list_ports
dedent|''
name|'def'
name|'list_ports'
op|'('
name|'self'
op|','
name|'context'
op|','
op|'**'
name|'search_opts'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""List ports for the client based on search options."""'
newline|'\n'
name|'return'
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
op|'.'
name|'list_ports'
op|'('
op|'**'
name|'search_opts'
op|')'
newline|'\n'
nl|'\n'
DECL|member|show_port
dedent|''
name|'def'
name|'show_port'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'port_id'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return the port for the client given the port id."""'
newline|'\n'
name|'return'
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
op|'.'
name|'show_port'
op|'('
name|'port_id'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_instance_nw_info
dedent|''
name|'def'
name|'get_instance_nw_info'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'conductor_api'
op|'='
name|'None'
op|','
nl|'\n'
name|'networks'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return network information for specified instance\n           and update cache.\n        """'
newline|'\n'
name|'result'
op|'='
name|'self'
op|'.'
name|'_get_instance_nw_info'
op|'('
name|'context'
op|','
name|'instance'
op|','
name|'networks'
op|')'
newline|'\n'
name|'update_instance_info_cache'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'result'
op|','
nl|'\n'
name|'conductor_api'
op|')'
newline|'\n'
name|'return'
name|'result'
newline|'\n'
nl|'\n'
DECL|member|_get_instance_nw_info
dedent|''
name|'def'
name|'_get_instance_nw_info'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'networks'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|"'get_instance_nw_info() for %s'"
op|')'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'display_name'"
op|']'
op|')'
newline|'\n'
name|'nw_info'
op|'='
name|'self'
op|'.'
name|'_build_network_info_model'
op|'('
name|'context'
op|','
name|'instance'
op|','
name|'networks'
op|')'
newline|'\n'
name|'return'
name|'network_model'
op|'.'
name|'NetworkInfo'
op|'.'
name|'hydrate'
op|'('
name|'nw_info'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'refresh_cache'
newline|'\n'
DECL|member|add_fixed_ip_to_instance
name|'def'
name|'add_fixed_ip_to_instance'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'network_id'
op|','
nl|'\n'
name|'conductor_api'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Add a fixed ip to the instance from specified network."""'
newline|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'network_id'"
op|':'
name|'network_id'
op|'}'
newline|'\n'
name|'data'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
op|'.'
name|'list_subnets'
op|'('
op|'**'
name|'search_opts'
op|')'
newline|'\n'
name|'ipam_subnets'
op|'='
name|'data'
op|'.'
name|'get'
op|'('
string|"'subnets'"
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'ipam_subnets'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NetworkNotFoundForInstance'
op|'('
nl|'\n'
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'zone'
op|'='
string|"'compute:%s'"
op|'%'
name|'instance'
op|'['
string|"'availability_zone'"
op|']'
newline|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'device_id'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
string|"'device_owner'"
op|':'
name|'zone'
op|','
nl|'\n'
string|"'network_id'"
op|':'
name|'network_id'
op|'}'
newline|'\n'
name|'data'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
op|'.'
name|'list_ports'
op|'('
op|'**'
name|'search_opts'
op|')'
newline|'\n'
name|'ports'
op|'='
name|'data'
op|'['
string|"'ports'"
op|']'
newline|'\n'
name|'for'
name|'p'
name|'in'
name|'ports'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'subnet'
name|'in'
name|'ipam_subnets'
op|':'
newline|'\n'
indent|'                '
name|'fixed_ips'
op|'='
name|'p'
op|'['
string|"'fixed_ips'"
op|']'
newline|'\n'
name|'fixed_ips'
op|'.'
name|'append'
op|'('
op|'{'
string|"'subnet_id'"
op|':'
name|'subnet'
op|'['
string|"'id'"
op|']'
op|'}'
op|')'
newline|'\n'
name|'port_req_body'
op|'='
op|'{'
string|"'port'"
op|':'
op|'{'
string|"'fixed_ips'"
op|':'
name|'fixed_ips'
op|'}'
op|'}'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
op|'.'
name|'update_port'
op|'('
name|'p'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'port_req_body'
op|')'
newline|'\n'
name|'return'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
name|'as'
name|'ex'
op|':'
newline|'\n'
indent|'                    '
name|'msg'
op|'='
name|'_'
op|'('
string|'"Unable to update port %(portid)s on subnet "'
nl|'\n'
string|'"%(subnet_id)s with failure: %(exception)s"'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'msg'
op|','
op|'{'
string|"'portid'"
op|':'
name|'p'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
string|"'subnet_id'"
op|':'
name|'subnet'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
string|"'exception'"
op|':'
name|'ex'
op|'}'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
name|'raise'
name|'exception'
op|'.'
name|'NetworkNotFoundForInstance'
op|'('
nl|'\n'
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'refresh_cache'
newline|'\n'
DECL|member|remove_fixed_ip_from_instance
name|'def'
name|'remove_fixed_ip_from_instance'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'address'
op|','
nl|'\n'
name|'conductor_api'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Remove a fixed ip from the instance."""'
newline|'\n'
name|'zone'
op|'='
string|"'compute:%s'"
op|'%'
name|'instance'
op|'['
string|"'availability_zone'"
op|']'
newline|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'device_id'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
string|"'device_owner'"
op|':'
name|'zone'
op|','
nl|'\n'
string|"'fixed_ips'"
op|':'
string|"'ip_address=%s'"
op|'%'
name|'address'
op|'}'
newline|'\n'
name|'data'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
op|'.'
name|'list_ports'
op|'('
op|'**'
name|'search_opts'
op|')'
newline|'\n'
name|'ports'
op|'='
name|'data'
op|'['
string|"'ports'"
op|']'
newline|'\n'
name|'for'
name|'p'
name|'in'
name|'ports'
op|':'
newline|'\n'
indent|'            '
name|'fixed_ips'
op|'='
name|'p'
op|'['
string|"'fixed_ips'"
op|']'
newline|'\n'
name|'new_fixed_ips'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'fixed_ip'
name|'in'
name|'fixed_ips'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'fixed_ip'
op|'['
string|"'ip_address'"
op|']'
op|'!='
name|'address'
op|':'
newline|'\n'
indent|'                    '
name|'new_fixed_ips'
op|'.'
name|'append'
op|'('
name|'fixed_ip'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'port_req_body'
op|'='
op|'{'
string|"'port'"
op|':'
op|'{'
string|"'fixed_ips'"
op|':'
name|'new_fixed_ips'
op|'}'
op|'}'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
op|'.'
name|'update_port'
op|'('
name|'p'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'port_req_body'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
name|'as'
name|'ex'
op|':'
newline|'\n'
indent|'                '
name|'msg'
op|'='
name|'_'
op|'('
string|'"Unable to update port %(portid)s with"'
nl|'\n'
string|'" failure: %(exception)s"'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'msg'
op|','
op|'{'
string|"'portid'"
op|':'
name|'p'
op|'['
string|"'id'"
op|']'
op|','
string|"'exception'"
op|':'
name|'ex'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'return'
newline|'\n'
nl|'\n'
dedent|''
name|'raise'
name|'exception'
op|'.'
name|'FixedIpNotFoundForSpecificInstance'
op|'('
nl|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'ip'
op|'='
name|'address'
op|')'
newline|'\n'
nl|'\n'
DECL|member|validate_networks
dedent|''
name|'def'
name|'validate_networks'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'requested_networks'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Validate that the tenant can use the requested networks."""'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|"'validate_networks() for %s'"
op|')'
op|','
nl|'\n'
name|'requested_networks'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'requested_networks'
op|':'
newline|'\n'
indent|'            '
name|'return'
newline|'\n'
dedent|''
name|'net_ids'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
name|'for'
op|'('
name|'net_id'
op|','
name|'_i'
op|','
name|'port_id'
op|')'
name|'in'
name|'requested_networks'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'port_id'
op|':'
newline|'\n'
indent|'                '
name|'port'
op|'='
op|'('
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
nl|'\n'
op|'.'
name|'show_port'
op|'('
name|'port_id'
op|')'
nl|'\n'
op|'.'
name|'get'
op|'('
string|"'port'"
op|')'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'port'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'exception'
op|'.'
name|'PortNotFound'
op|'('
name|'port_id'
op|'='
name|'port_id'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'port'
op|'.'
name|'get'
op|'('
string|"'device_id'"
op|','
name|'None'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'exception'
op|'.'
name|'PortInUse'
op|'('
name|'port_id'
op|'='
name|'port_id'
op|')'
newline|'\n'
dedent|''
name|'net_id'
op|'='
name|'port'
op|'['
string|"'network_id'"
op|']'
newline|'\n'
dedent|''
name|'if'
name|'net_id'
name|'in'
name|'net_ids'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'exception'
op|'.'
name|'NetworkDuplicated'
op|'('
name|'network_id'
op|'='
name|'net_id'
op|')'
newline|'\n'
dedent|''
name|'net_ids'
op|'.'
name|'append'
op|'('
name|'net_id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'nets'
op|'='
name|'self'
op|'.'
name|'_get_available_networks'
op|'('
name|'context'
op|','
name|'context'
op|'.'
name|'project_id'
op|','
nl|'\n'
name|'net_ids'
op|')'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'nets'
op|')'
op|'!='
name|'len'
op|'('
name|'net_ids'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'requsted_netid_set'
op|'='
name|'set'
op|'('
name|'net_ids'
op|')'
newline|'\n'
name|'returned_netid_set'
op|'='
name|'set'
op|'('
op|'['
name|'net'
op|'['
string|"'id'"
op|']'
name|'for'
name|'net'
name|'in'
name|'nets'
op|']'
op|')'
newline|'\n'
name|'lostid_set'
op|'='
name|'requsted_netid_set'
op|'-'
name|'returned_netid_set'
newline|'\n'
name|'id_str'
op|'='
string|"''"
newline|'\n'
name|'for'
name|'_id'
name|'in'
name|'lostid_set'
op|':'
newline|'\n'
indent|'                '
name|'id_str'
op|'='
name|'id_str'
name|'and'
name|'id_str'
op|'+'
string|"', '"
op|'+'
name|'_id'
name|'or'
name|'_id'
newline|'\n'
dedent|''
name|'raise'
name|'exception'
op|'.'
name|'NetworkNotFound'
op|'('
name|'network_id'
op|'='
name|'id_str'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_instance_uuids_by_ip
dedent|''
dedent|''
name|'def'
name|'_get_instance_uuids_by_ip'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'address'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Retrieve instance uuids associated with the given ip address.\n\n        :returns: A list of dicts containing the uuids keyed by \'instance_uuid\'\n                  e.g. [{\'instance_uuid\': uuid}, ...]\n        """'
newline|'\n'
name|'search_opts'
op|'='
op|'{'
string|'"fixed_ips"'
op|':'
string|"'ip_address=%s'"
op|'%'
name|'address'
op|'}'
newline|'\n'
name|'data'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
op|'.'
name|'list_ports'
op|'('
op|'**'
name|'search_opts'
op|')'
newline|'\n'
name|'ports'
op|'='
name|'data'
op|'.'
name|'get'
op|'('
string|"'ports'"
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'return'
op|'['
op|'{'
string|"'instance_uuid'"
op|':'
name|'port'
op|'['
string|"'device_id'"
op|']'
op|'}'
name|'for'
name|'port'
name|'in'
name|'ports'
nl|'\n'
name|'if'
name|'port'
op|'['
string|"'device_id'"
op|']'
op|']'
newline|'\n'
nl|'\n'
DECL|member|get_instance_uuids_by_ip_filter
dedent|''
name|'def'
name|'get_instance_uuids_by_ip_filter'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'filters'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return a list of dicts in the form of\n        [{\'instance_uuid\': uuid}] that matched the ip filter.\n        """'
newline|'\n'
comment|"# filters['ip'] is composed as '^%s$' % fixed_ip.replace('.', '\\\\.')"
nl|'\n'
name|'ip'
op|'='
name|'filters'
op|'.'
name|'get'
op|'('
string|"'ip'"
op|')'
newline|'\n'
comment|'# we remove ^$\\ in the ip filer'
nl|'\n'
name|'if'
name|'ip'
op|'['
number|'0'
op|']'
op|'=='
string|"'^'"
op|':'
newline|'\n'
indent|'            '
name|'ip'
op|'='
name|'ip'
op|'['
number|'1'
op|':'
op|']'
newline|'\n'
dedent|''
name|'if'
name|'ip'
op|'['
op|'-'
number|'1'
op|']'
op|'=='
string|"'$'"
op|':'
newline|'\n'
indent|'            '
name|'ip'
op|'='
name|'ip'
op|'['
op|':'
op|'-'
number|'1'
op|']'
newline|'\n'
dedent|''
name|'ip'
op|'='
name|'ip'
op|'.'
name|'replace'
op|'('
string|"'\\\\.'"
op|','
string|"'.'"
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'_get_instance_uuids_by_ip'
op|'('
name|'context'
op|','
name|'ip'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_port_id_by_fixed_address
dedent|''
name|'def'
name|'_get_port_id_by_fixed_address'
op|'('
name|'self'
op|','
name|'client'
op|','
nl|'\n'
name|'instance'
op|','
name|'address'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return port_id from a fixed address."""'
newline|'\n'
name|'zone'
op|'='
string|"'compute:%s'"
op|'%'
name|'instance'
op|'['
string|"'availability_zone'"
op|']'
newline|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'device_id'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
nl|'\n'
string|"'device_owner'"
op|':'
name|'zone'
op|'}'
newline|'\n'
name|'data'
op|'='
name|'client'
op|'.'
name|'list_ports'
op|'('
op|'**'
name|'search_opts'
op|')'
newline|'\n'
name|'ports'
op|'='
name|'data'
op|'['
string|"'ports'"
op|']'
newline|'\n'
name|'port_id'
op|'='
name|'None'
newline|'\n'
name|'for'
name|'p'
name|'in'
name|'ports'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'ip'
name|'in'
name|'p'
op|'['
string|"'fixed_ips'"
op|']'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'ip'
op|'['
string|"'ip_address'"
op|']'
op|'=='
name|'address'
op|':'
newline|'\n'
indent|'                    '
name|'port_id'
op|'='
name|'p'
op|'['
string|"'id'"
op|']'
newline|'\n'
name|'break'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'if'
name|'not'
name|'port_id'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'FixedIpNotFoundForAddress'
op|'('
name|'address'
op|'='
name|'address'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'port_id'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'refresh_cache'
newline|'\n'
DECL|member|associate_floating_ip
name|'def'
name|'associate_floating_ip'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'floating_address'
op|','
name|'fixed_address'
op|','
nl|'\n'
name|'affect_auto_assigned'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Associate a floating ip with a fixed ip."""'
newline|'\n'
nl|'\n'
comment|"# Note(amotoki): 'affect_auto_assigned' is not respected"
nl|'\n'
comment|'# since it is not used anywhere in nova code and I could'
nl|'\n'
comment|'# find why this parameter exists.'
nl|'\n'
nl|'\n'
name|'client'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
newline|'\n'
name|'port_id'
op|'='
name|'self'
op|'.'
name|'_get_port_id_by_fixed_address'
op|'('
name|'client'
op|','
name|'instance'
op|','
nl|'\n'
name|'fixed_address'
op|')'
newline|'\n'
name|'fip'
op|'='
name|'self'
op|'.'
name|'_get_floating_ip_by_address'
op|'('
name|'client'
op|','
name|'floating_address'
op|')'
newline|'\n'
name|'param'
op|'='
op|'{'
string|"'port_id'"
op|':'
name|'port_id'
op|','
nl|'\n'
string|"'fixed_ip_address'"
op|':'
name|'fixed_address'
op|'}'
newline|'\n'
name|'client'
op|'.'
name|'update_floatingip'
op|'('
name|'fip'
op|'['
string|"'id'"
op|']'
op|','
op|'{'
string|"'floatingip'"
op|':'
name|'param'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_all
dedent|''
name|'def'
name|'get_all'
op|'('
name|'self'
op|','
name|'context'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Get all networks for client."""'
newline|'\n'
name|'client'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
newline|'\n'
name|'networks'
op|'='
name|'client'
op|'.'
name|'list_networks'
op|'('
op|')'
op|'.'
name|'get'
op|'('
string|"'networks'"
op|')'
name|'or'
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'network'
name|'in'
name|'networks'
op|':'
newline|'\n'
indent|'            '
name|'network'
op|'['
string|"'label'"
op|']'
op|'='
name|'network'
op|'['
string|"'name'"
op|']'
newline|'\n'
dedent|''
name|'return'
name|'networks'
newline|'\n'
nl|'\n'
DECL|member|get
dedent|''
name|'def'
name|'get'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'network_uuid'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Get specific network for client."""'
newline|'\n'
name|'client'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
newline|'\n'
name|'network'
op|'='
name|'client'
op|'.'
name|'show_network'
op|'('
name|'network_uuid'
op|')'
op|'.'
name|'get'
op|'('
string|"'network'"
op|')'
name|'or'
op|'{'
op|'}'
newline|'\n'
name|'network'
op|'['
string|"'label'"
op|']'
op|'='
name|'network'
op|'['
string|"'name'"
op|']'
newline|'\n'
name|'return'
name|'network'
newline|'\n'
nl|'\n'
DECL|member|delete
dedent|''
name|'def'
name|'delete'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'network_uuid'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Delete a network for client."""'
newline|'\n'
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|disassociate
dedent|''
name|'def'
name|'disassociate'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'network_uuid'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Disassociate a network for client."""'
newline|'\n'
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_fixed_ip
dedent|''
name|'def'
name|'get_fixed_ip'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'id'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Get a fixed ip from the id."""'
newline|'\n'
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_fixed_ip_by_address
dedent|''
name|'def'
name|'get_fixed_ip_by_address'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'address'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return instance uuids given an address."""'
newline|'\n'
name|'uuid_maps'
op|'='
name|'self'
op|'.'
name|'_get_instance_uuids_by_ip'
op|'('
name|'context'
op|','
name|'address'
op|')'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'uuid_maps'
op|')'
op|'=='
number|'1'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'uuid_maps'
op|'['
number|'0'
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'not'
name|'uuid_maps'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'FixedIpNotFoundForAddress'
op|'('
name|'address'
op|'='
name|'address'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'FixedIpAssociatedWithMultipleInstances'
op|'('
nl|'\n'
name|'address'
op|'='
name|'address'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_setup_net_dict
dedent|''
dedent|''
name|'def'
name|'_setup_net_dict'
op|'('
name|'self'
op|','
name|'client'
op|','
name|'network_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'network_id'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
op|'}'
newline|'\n'
dedent|''
name|'pool'
op|'='
name|'client'
op|'.'
name|'show_network'
op|'('
name|'network_id'
op|')'
op|'['
string|"'network'"
op|']'
newline|'\n'
name|'return'
op|'{'
name|'pool'
op|'['
string|"'id'"
op|']'
op|':'
name|'pool'
op|'}'
newline|'\n'
nl|'\n'
DECL|member|_setup_port_dict
dedent|''
name|'def'
name|'_setup_port_dict'
op|'('
name|'self'
op|','
name|'client'
op|','
name|'port_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'port_id'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'{'
op|'}'
newline|'\n'
dedent|''
name|'port'
op|'='
name|'client'
op|'.'
name|'show_port'
op|'('
name|'port_id'
op|')'
op|'['
string|"'port'"
op|']'
newline|'\n'
name|'return'
op|'{'
name|'port'
op|'['
string|"'id'"
op|']'
op|':'
name|'port'
op|'}'
newline|'\n'
nl|'\n'
DECL|member|_setup_pools_dict
dedent|''
name|'def'
name|'_setup_pools_dict'
op|'('
name|'self'
op|','
name|'client'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'pools'
op|'='
name|'self'
op|'.'
name|'_get_floating_ip_pools'
op|'('
name|'client'
op|')'
newline|'\n'
name|'return'
name|'dict'
op|'('
op|'['
op|'('
name|'i'
op|'['
string|"'id'"
op|']'
op|','
name|'i'
op|')'
name|'for'
name|'i'
name|'in'
name|'pools'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_setup_ports_dict
dedent|''
name|'def'
name|'_setup_ports_dict'
op|'('
name|'self'
op|','
name|'client'
op|','
name|'project_id'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'search_opts'
op|'='
op|'{'
string|"'tenant_id'"
op|':'
name|'project_id'
op|'}'
name|'if'
name|'project_id'
name|'else'
op|'{'
op|'}'
newline|'\n'
name|'ports'
op|'='
name|'client'
op|'.'
name|'list_ports'
op|'('
op|'**'
name|'search_opts'
op|')'
op|'['
string|"'ports'"
op|']'
newline|'\n'
name|'return'
name|'dict'
op|'('
op|'['
op|'('
name|'p'
op|'['
string|"'id'"
op|']'
op|','
name|'p'
op|')'
name|'for'
name|'p'
name|'in'
name|'ports'
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_floating_ip
dedent|''
name|'def'
name|'get_floating_ip'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'id'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return floating ip object given the floating ip id."""'
newline|'\n'
name|'client'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
newline|'\n'
name|'fip'
op|'='
name|'client'
op|'.'
name|'show_floatingip'
op|'('
name|'id'
op|')'
op|'['
string|"'floatingip'"
op|']'
newline|'\n'
name|'pool_dict'
op|'='
name|'self'
op|'.'
name|'_setup_net_dict'
op|'('
name|'client'
op|','
nl|'\n'
name|'fip'
op|'['
string|"'floating_network_id'"
op|']'
op|')'
newline|'\n'
name|'port_dict'
op|'='
name|'self'
op|'.'
name|'_setup_port_dict'
op|'('
name|'client'
op|','
name|'fip'
op|'['
string|"'port_id'"
op|']'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'_format_floating_ip_model'
op|'('
name|'fip'
op|','
name|'pool_dict'
op|','
name|'port_dict'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_floating_ip_pools
dedent|''
name|'def'
name|'_get_floating_ip_pools'
op|'('
name|'self'
op|','
name|'client'
op|','
name|'project_id'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'search_opts'
op|'='
op|'{'
name|'NET_EXTERNAL'
op|':'
name|'True'
op|'}'
newline|'\n'
name|'if'
name|'project_id'
op|':'
newline|'\n'
indent|'            '
name|'search_opts'
op|'.'
name|'update'
op|'('
op|'{'
string|"'tenant_id'"
op|':'
name|'project_id'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'data'
op|'='
name|'client'
op|'.'
name|'list_networks'
op|'('
op|'**'
name|'search_opts'
op|')'
newline|'\n'
name|'return'
name|'data'
op|'['
string|"'networks'"
op|']'
newline|'\n'
nl|'\n'
DECL|member|get_floating_ip_pools
dedent|''
name|'def'
name|'get_floating_ip_pools'
op|'('
name|'self'
op|','
name|'context'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return floating ip pools."""'
newline|'\n'
name|'client'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
newline|'\n'
name|'pools'
op|'='
name|'self'
op|'.'
name|'_get_floating_ip_pools'
op|'('
name|'client'
op|')'
newline|'\n'
name|'return'
op|'['
op|'{'
string|"'name'"
op|':'
name|'n'
op|'['
string|"'name'"
op|']'
name|'or'
name|'n'
op|'['
string|"'id'"
op|']'
op|'}'
name|'for'
name|'n'
name|'in'
name|'pools'
op|']'
newline|'\n'
nl|'\n'
DECL|member|_format_floating_ip_model
dedent|''
name|'def'
name|'_format_floating_ip_model'
op|'('
name|'self'
op|','
name|'fip'
op|','
name|'pool_dict'
op|','
name|'port_dict'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'pool'
op|'='
name|'pool_dict'
op|'['
name|'fip'
op|'['
string|"'floating_network_id'"
op|']'
op|']'
newline|'\n'
name|'result'
op|'='
op|'{'
string|"'id'"
op|':'
name|'fip'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
string|"'address'"
op|':'
name|'fip'
op|'['
string|"'floating_ip_address'"
op|']'
op|','
nl|'\n'
string|"'pool'"
op|':'
name|'pool'
op|'['
string|"'name'"
op|']'
name|'or'
name|'pool'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
string|"'project_id'"
op|':'
name|'fip'
op|'['
string|"'tenant_id'"
op|']'
op|','
nl|'\n'
comment|'# In Quantum v2, an exact fixed_ip_id does not exist.'
nl|'\n'
string|"'fixed_ip_id'"
op|':'
name|'fip'
op|'['
string|"'port_id'"
op|']'
op|','
nl|'\n'
op|'}'
newline|'\n'
comment|'# In Quantum v2 API fixed_ip_address and instance uuid'
nl|'\n'
comment|'# (= device_id) are known here, so pass it as a result.'
nl|'\n'
name|'result'
op|'['
string|"'fixed_ip'"
op|']'
op|'='
op|'{'
string|"'address'"
op|':'
name|'fip'
op|'['
string|"'fixed_ip_address'"
op|']'
op|'}'
newline|'\n'
name|'if'
name|'fip'
op|'['
string|"'port_id'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'instance_uuid'
op|'='
name|'port_dict'
op|'['
name|'fip'
op|'['
string|"'port_id'"
op|']'
op|']'
op|'['
string|"'device_id'"
op|']'
newline|'\n'
name|'result'
op|'['
string|"'instance'"
op|']'
op|'='
op|'{'
string|"'uuid'"
op|':'
name|'instance_uuid'
op|'}'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'result'
op|'['
string|"'instance'"
op|']'
op|'='
name|'None'
newline|'\n'
dedent|''
name|'return'
name|'result'
newline|'\n'
nl|'\n'
DECL|member|get_floating_ip_by_address
dedent|''
name|'def'
name|'get_floating_ip_by_address'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'address'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return a floating ip given an address."""'
newline|'\n'
name|'client'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
newline|'\n'
name|'fip'
op|'='
name|'self'
op|'.'
name|'_get_floating_ip_by_address'
op|'('
name|'client'
op|','
name|'address'
op|')'
newline|'\n'
name|'pool_dict'
op|'='
name|'self'
op|'.'
name|'_setup_net_dict'
op|'('
name|'client'
op|','
nl|'\n'
name|'fip'
op|'['
string|"'floating_network_id'"
op|']'
op|')'
newline|'\n'
name|'port_dict'
op|'='
name|'self'
op|'.'
name|'_setup_port_dict'
op|'('
name|'client'
op|','
name|'fip'
op|'['
string|"'port_id'"
op|']'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'_format_floating_ip_model'
op|'('
name|'fip'
op|','
name|'pool_dict'
op|','
name|'port_dict'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_floating_ips_by_project
dedent|''
name|'def'
name|'get_floating_ips_by_project'
op|'('
name|'self'
op|','
name|'context'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'client'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
newline|'\n'
name|'project_id'
op|'='
name|'context'
op|'.'
name|'project_id'
newline|'\n'
name|'fips'
op|'='
name|'client'
op|'.'
name|'list_floatingips'
op|'('
name|'tenant_id'
op|'='
name|'project_id'
op|')'
op|'['
string|"'floatingips'"
op|']'
newline|'\n'
name|'pool_dict'
op|'='
name|'self'
op|'.'
name|'_setup_pools_dict'
op|'('
name|'client'
op|')'
newline|'\n'
name|'port_dict'
op|'='
name|'self'
op|'.'
name|'_setup_ports_dict'
op|'('
name|'client'
op|','
name|'project_id'
op|')'
newline|'\n'
name|'return'
op|'['
name|'self'
op|'.'
name|'_format_floating_ip_model'
op|'('
name|'fip'
op|','
name|'pool_dict'
op|','
name|'port_dict'
op|')'
nl|'\n'
name|'for'
name|'fip'
name|'in'
name|'fips'
op|']'
newline|'\n'
nl|'\n'
DECL|member|get_floating_ips_by_fixed_address
dedent|''
name|'def'
name|'get_floating_ips_by_fixed_address'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'fixed_address'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
op|'['
op|']'
newline|'\n'
nl|'\n'
DECL|member|get_instance_id_by_floating_address
dedent|''
name|'def'
name|'get_instance_id_by_floating_address'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'address'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return the instance id a floating ip\'s fixed ip is allocated to."""'
newline|'\n'
name|'client'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
newline|'\n'
name|'fip'
op|'='
name|'self'
op|'.'
name|'_get_floating_ip_by_address'
op|'('
name|'client'
op|','
name|'address'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'fip'
op|'['
string|"'port_id'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'port'
op|'='
name|'client'
op|'.'
name|'show_port'
op|'('
name|'fip'
op|'['
string|"'port_id'"
op|']'
op|')'
op|'['
string|"'port'"
op|']'
newline|'\n'
name|'return'
name|'port'
op|'['
string|"'device_id'"
op|']'
newline|'\n'
nl|'\n'
DECL|member|get_vifs_by_instance
dedent|''
name|'def'
name|'get_vifs_by_instance'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_vif_by_mac_address
dedent|''
name|'def'
name|'get_vif_by_mac_address'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'mac_address'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_floating_ip_pool_id_by_name_or_id
dedent|''
name|'def'
name|'_get_floating_ip_pool_id_by_name_or_id'
op|'('
name|'self'
op|','
name|'client'
op|','
name|'name_or_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'search_opts'
op|'='
op|'{'
name|'NET_EXTERNAL'
op|':'
name|'True'
op|','
string|"'fields'"
op|':'
string|"'id'"
op|'}'
newline|'\n'
name|'if'
name|'uuidutils'
op|'.'
name|'is_uuid_like'
op|'('
name|'name_or_id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'search_opts'
op|'.'
name|'update'
op|'('
op|'{'
string|"'id'"
op|':'
name|'name_or_id'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'search_opts'
op|'.'
name|'update'
op|'('
op|'{'
string|"'name'"
op|':'
name|'name_or_id'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'data'
op|'='
name|'client'
op|'.'
name|'list_networks'
op|'('
op|'**'
name|'search_opts'
op|')'
newline|'\n'
name|'nets'
op|'='
name|'data'
op|'['
string|"'networks'"
op|']'
newline|'\n'
nl|'\n'
name|'if'
name|'len'
op|'('
name|'nets'
op|')'
op|'=='
number|'1'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'nets'
op|'['
number|'0'
op|']'
op|'['
string|"'id'"
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'len'
op|'('
name|'nets'
op|')'
op|'=='
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'FloatingIpPoolNotFound'
op|'('
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'msg'
op|'='
op|'('
name|'_'
op|'('
string|'"Multiple floating IP pools matches found for name \'%s\'"'
op|')'
nl|'\n'
op|'%'
name|'name_or_id'
op|')'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'NovaException'
op|'('
name|'message'
op|'='
name|'msg'
op|')'
newline|'\n'
nl|'\n'
DECL|member|allocate_floating_ip
dedent|''
dedent|''
name|'def'
name|'allocate_floating_ip'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'pool'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Add a floating ip to a project from a pool."""'
newline|'\n'
name|'client'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
newline|'\n'
name|'pool'
op|'='
name|'pool'
name|'or'
name|'CONF'
op|'.'
name|'default_floating_pool'
newline|'\n'
name|'pool_id'
op|'='
name|'self'
op|'.'
name|'_get_floating_ip_pool_id_by_name_or_id'
op|'('
name|'client'
op|','
name|'pool'
op|')'
newline|'\n'
nl|'\n'
comment|'# TODO(amotoki): handle exception during create_floatingip()'
nl|'\n'
comment|'# At this timing it is ensured that a network for pool exists.'
nl|'\n'
comment|'# quota error may be returned.'
nl|'\n'
name|'param'
op|'='
op|'{'
string|"'floatingip'"
op|':'
op|'{'
string|"'floating_network_id'"
op|':'
name|'pool_id'
op|'}'
op|'}'
newline|'\n'
name|'fip'
op|'='
name|'client'
op|'.'
name|'create_floatingip'
op|'('
name|'param'
op|')'
newline|'\n'
name|'return'
name|'fip'
op|'['
string|"'floatingip'"
op|']'
op|'['
string|"'floating_ip_address'"
op|']'
newline|'\n'
nl|'\n'
DECL|member|_get_floating_ip_by_address
dedent|''
name|'def'
name|'_get_floating_ip_by_address'
op|'('
name|'self'
op|','
name|'client'
op|','
name|'address'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Get floatingip from floating ip address."""'
newline|'\n'
name|'data'
op|'='
name|'client'
op|'.'
name|'list_floatingips'
op|'('
name|'floating_ip_address'
op|'='
name|'address'
op|')'
newline|'\n'
name|'fips'
op|'='
name|'data'
op|'['
string|"'floatingips'"
op|']'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'fips'
op|')'
op|'=='
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'FloatingIpNotFoundForAddress'
op|'('
name|'address'
op|'='
name|'address'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'len'
op|'('
name|'fips'
op|')'
op|'>'
number|'1'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'FloatingIpMultipleFoundForAddress'
op|'('
name|'address'
op|'='
name|'address'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'fips'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
DECL|member|_get_floating_ips_by_fixed_and_port
dedent|''
name|'def'
name|'_get_floating_ips_by_fixed_and_port'
op|'('
name|'self'
op|','
name|'client'
op|','
name|'fixed_ip'
op|','
name|'port'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Get floatingips from fixed ip and port."""'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'data'
op|'='
name|'client'
op|'.'
name|'list_floatingips'
op|'('
name|'fixed_ip_address'
op|'='
name|'fixed_ip'
op|','
nl|'\n'
name|'port_id'
op|'='
name|'port'
op|')'
newline|'\n'
comment|'# If a quantum plugin does not implement the L3 API a 404 from'
nl|'\n'
comment|'# list_floatingips will be raised.'
nl|'\n'
dedent|''
name|'except'
name|'quantumclient'
op|'.'
name|'common'
op|'.'
name|'exceptions'
op|'.'
name|'QuantumClientException'
name|'as'
name|'e'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'e'
op|'.'
name|'status_code'
op|'=='
number|'404'
op|':'
newline|'\n'
indent|'                '
name|'return'
op|'['
op|']'
newline|'\n'
dedent|''
name|'raise'
newline|'\n'
dedent|''
name|'return'
name|'data'
op|'['
string|"'floatingips'"
op|']'
newline|'\n'
nl|'\n'
DECL|member|release_floating_ip
dedent|''
name|'def'
name|'release_floating_ip'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'address'
op|','
nl|'\n'
name|'affect_auto_assigned'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Remove a floating ip with the given address from a project."""'
newline|'\n'
nl|'\n'
comment|'# Note(amotoki): We cannot handle a case where multiple pools'
nl|'\n'
comment|'# have overlapping IP address range. In this case we cannot use'
nl|'\n'
comment|"# 'address' as a unique key."
nl|'\n'
comment|'# This is a limitation of the current nova.'
nl|'\n'
nl|'\n'
comment|"# Note(amotoki): 'affect_auto_assigned' is not respected"
nl|'\n'
comment|'# since it is not used anywhere in nova code and I could'
nl|'\n'
comment|'# find why this parameter exists.'
nl|'\n'
nl|'\n'
name|'client'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
newline|'\n'
name|'fip'
op|'='
name|'self'
op|'.'
name|'_get_floating_ip_by_address'
op|'('
name|'client'
op|','
name|'address'
op|')'
newline|'\n'
name|'if'
name|'fip'
op|'['
string|"'port_id'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'FloatingIpAssociated'
op|'('
name|'address'
op|'='
name|'address'
op|')'
newline|'\n'
dedent|''
name|'client'
op|'.'
name|'delete_floatingip'
op|'('
name|'fip'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'refresh_cache'
newline|'\n'
DECL|member|disassociate_floating_ip
name|'def'
name|'disassociate_floating_ip'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'address'
op|','
nl|'\n'
name|'affect_auto_assigned'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Disassociate a floating ip from the instance."""'
newline|'\n'
nl|'\n'
comment|"# Note(amotoki): 'affect_auto_assigned' is not respected"
nl|'\n'
comment|'# since it is not used anywhere in nova code and I could'
nl|'\n'
comment|'# find why this parameter exists.'
nl|'\n'
nl|'\n'
name|'client'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
newline|'\n'
name|'fip'
op|'='
name|'self'
op|'.'
name|'_get_floating_ip_by_address'
op|'('
name|'client'
op|','
name|'address'
op|')'
newline|'\n'
name|'client'
op|'.'
name|'update_floatingip'
op|'('
name|'fip'
op|'['
string|"'id'"
op|']'
op|','
op|'{'
string|"'floatingip'"
op|':'
op|'{'
string|"'port_id'"
op|':'
name|'None'
op|'}'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|migrate_instance_start
dedent|''
name|'def'
name|'migrate_instance_start'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'migration'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Start to migrate the network of an instance."""'
newline|'\n'
comment|"# NOTE(wenjianhn): just pass to make migrate instance doesn't"
nl|'\n'
comment|'# raise for now.'
nl|'\n'
name|'pass'
newline|'\n'
nl|'\n'
DECL|member|migrate_instance_finish
dedent|''
name|'def'
name|'migrate_instance_finish'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'migration'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Finish migrating the network of an instance."""'
newline|'\n'
comment|"# NOTE(wenjianhn): just pass to make migrate instance doesn't"
nl|'\n'
comment|'# raise for now.'
nl|'\n'
name|'pass'
newline|'\n'
nl|'\n'
DECL|member|add_network_to_project
dedent|''
name|'def'
name|'add_network_to_project'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'project_id'
op|','
name|'network_uuid'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Force add a network to the project."""'
newline|'\n'
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|_nw_info_get_ips
dedent|''
name|'def'
name|'_nw_info_get_ips'
op|'('
name|'self'
op|','
name|'client'
op|','
name|'port'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'network_IPs'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'fixed_ip'
name|'in'
name|'port'
op|'['
string|"'fixed_ips'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'fixed'
op|'='
name|'network_model'
op|'.'
name|'FixedIP'
op|'('
name|'address'
op|'='
name|'fixed_ip'
op|'['
string|"'ip_address'"
op|']'
op|')'
newline|'\n'
name|'floats'
op|'='
name|'self'
op|'.'
name|'_get_floating_ips_by_fixed_and_port'
op|'('
nl|'\n'
name|'client'
op|','
name|'fixed_ip'
op|'['
string|"'ip_address'"
op|']'
op|','
name|'port'
op|'['
string|"'id'"
op|']'
op|')'
newline|'\n'
name|'for'
name|'ip'
name|'in'
name|'floats'
op|':'
newline|'\n'
indent|'                '
name|'fip'
op|'='
name|'network_model'
op|'.'
name|'IP'
op|'('
name|'address'
op|'='
name|'ip'
op|'['
string|"'floating_ip_address'"
op|']'
op|','
nl|'\n'
name|'type'
op|'='
string|"'floating'"
op|')'
newline|'\n'
name|'fixed'
op|'.'
name|'add_floating_ip'
op|'('
name|'fip'
op|')'
newline|'\n'
dedent|''
name|'network_IPs'
op|'.'
name|'append'
op|'('
name|'fixed'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'network_IPs'
newline|'\n'
nl|'\n'
DECL|member|_nw_info_get_subnets
dedent|''
name|'def'
name|'_nw_info_get_subnets'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'port'
op|','
name|'network_IPs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'subnets'
op|'='
name|'self'
op|'.'
name|'_get_subnets_from_port'
op|'('
name|'context'
op|','
name|'port'
op|')'
newline|'\n'
name|'for'
name|'subnet'
name|'in'
name|'subnets'
op|':'
newline|'\n'
indent|'            '
name|'subnet'
op|'['
string|"'ips'"
op|']'
op|'='
op|'['
name|'fixed_ip'
name|'for'
name|'fixed_ip'
name|'in'
name|'network_IPs'
nl|'\n'
name|'if'
name|'fixed_ip'
op|'.'
name|'is_in_subnet'
op|'('
name|'subnet'
op|')'
op|']'
newline|'\n'
dedent|''
name|'return'
name|'subnets'
newline|'\n'
nl|'\n'
DECL|member|_nw_info_build_network
dedent|''
name|'def'
name|'_nw_info_build_network'
op|'('
name|'self'
op|','
name|'port'
op|','
name|'networks'
op|','
name|'subnets'
op|')'
op|':'
newline|'\n'
comment|"# NOTE(danms): This loop can't fail to find a network since we"
nl|'\n'
comment|'# filtered ports to only the ones matching networks in our parent'
nl|'\n'
indent|'        '
name|'for'
name|'net'
name|'in'
name|'networks'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'port'
op|'['
string|"'network_id'"
op|']'
op|'=='
name|'net'
op|'['
string|"'id'"
op|']'
op|':'
newline|'\n'
indent|'                '
name|'network_name'
op|'='
name|'net'
op|'['
string|"'name'"
op|']'
newline|'\n'
name|'break'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'bridge'
op|'='
name|'None'
newline|'\n'
name|'ovs_interfaceid'
op|'='
name|'None'
newline|'\n'
comment|'# Network model metadata'
nl|'\n'
name|'should_create_bridge'
op|'='
name|'None'
newline|'\n'
name|'vif_type'
op|'='
name|'port'
op|'.'
name|'get'
op|'('
string|"'binding:vif_type'"
op|')'
newline|'\n'
comment|'# TODO(berrange) Quantum should pass the bridge name'
nl|'\n'
comment|'# in another binding metadata field'
nl|'\n'
name|'if'
name|'vif_type'
op|'=='
name|'network_model'
op|'.'
name|'VIF_TYPE_OVS'
op|':'
newline|'\n'
indent|'            '
name|'bridge'
op|'='
name|'CONF'
op|'.'
name|'quantum_ovs_bridge'
newline|'\n'
name|'ovs_interfaceid'
op|'='
name|'port'
op|'['
string|"'id'"
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'vif_type'
op|'=='
name|'network_model'
op|'.'
name|'VIF_TYPE_BRIDGE'
op|':'
newline|'\n'
indent|'            '
name|'bridge'
op|'='
string|'"brq"'
op|'+'
name|'port'
op|'['
string|"'network_id'"
op|']'
newline|'\n'
name|'should_create_bridge'
op|'='
name|'True'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'bridge'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'bridge'
op|'='
name|'bridge'
op|'['
op|':'
name|'network_model'
op|'.'
name|'NIC_NAME_LEN'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'network'
op|'='
name|'network_model'
op|'.'
name|'Network'
op|'('
nl|'\n'
name|'id'
op|'='
name|'port'
op|'['
string|"'network_id'"
op|']'
op|','
nl|'\n'
name|'bridge'
op|'='
name|'bridge'
op|','
nl|'\n'
name|'injected'
op|'='
name|'CONF'
op|'.'
name|'flat_injected'
op|','
nl|'\n'
name|'label'
op|'='
name|'network_name'
op|','
nl|'\n'
name|'tenant_id'
op|'='
name|'net'
op|'['
string|"'tenant_id'"
op|']'
nl|'\n'
op|')'
newline|'\n'
name|'network'
op|'['
string|"'subnets'"
op|']'
op|'='
name|'subnets'
newline|'\n'
name|'if'
name|'should_create_bridge'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'network'
op|'['
string|"'should_create_bridge'"
op|']'
op|'='
name|'should_create_bridge'
newline|'\n'
dedent|''
name|'return'
name|'network'
op|','
name|'ovs_interfaceid'
newline|'\n'
nl|'\n'
DECL|member|_build_network_info_model
dedent|''
name|'def'
name|'_build_network_info_model'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'networks'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'search_opts'
op|'='
op|'{'
string|"'tenant_id'"
op|':'
name|'instance'
op|'['
string|"'project_id'"
op|']'
op|','
nl|'\n'
string|"'device_id'"
op|':'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
op|'}'
newline|'\n'
name|'client'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|','
name|'admin'
op|'='
name|'True'
op|')'
newline|'\n'
name|'data'
op|'='
name|'client'
op|'.'
name|'list_ports'
op|'('
op|'**'
name|'search_opts'
op|')'
newline|'\n'
name|'ports'
op|'='
name|'data'
op|'.'
name|'get'
op|'('
string|"'ports'"
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'if'
name|'networks'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'networks'
op|'='
name|'self'
op|'.'
name|'_get_available_networks'
op|'('
name|'context'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'project_id'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# ensure ports are in preferred network order, and filter out'
nl|'\n'
comment|'# those not attached to one of the provided list of networks'
nl|'\n'
dedent|''
name|'net_ids'
op|'='
op|'['
name|'n'
op|'['
string|"'id'"
op|']'
name|'for'
name|'n'
name|'in'
name|'networks'
op|']'
newline|'\n'
name|'ports'
op|'='
op|'['
name|'port'
name|'for'
name|'port'
name|'in'
name|'ports'
name|'if'
name|'port'
op|'['
string|"'network_id'"
op|']'
name|'in'
name|'net_ids'
op|']'
newline|'\n'
name|'_ensure_requested_network_ordering'
op|'('
name|'lambda'
name|'x'
op|':'
name|'x'
op|'['
string|"'network_id'"
op|']'
op|','
nl|'\n'
name|'ports'
op|','
name|'net_ids'
op|')'
newline|'\n'
nl|'\n'
name|'nw_info'
op|'='
name|'network_model'
op|'.'
name|'NetworkInfo'
op|'('
op|')'
newline|'\n'
name|'for'
name|'port'
name|'in'
name|'ports'
op|':'
newline|'\n'
indent|'            '
name|'network_IPs'
op|'='
name|'self'
op|'.'
name|'_nw_info_get_ips'
op|'('
name|'client'
op|','
name|'port'
op|')'
newline|'\n'
name|'subnets'
op|'='
name|'self'
op|'.'
name|'_nw_info_get_subnets'
op|'('
name|'context'
op|','
name|'port'
op|','
name|'network_IPs'
op|')'
newline|'\n'
nl|'\n'
name|'devname'
op|'='
string|'"tap"'
op|'+'
name|'port'
op|'['
string|"'id'"
op|']'
newline|'\n'
name|'devname'
op|'='
name|'devname'
op|'['
op|':'
name|'network_model'
op|'.'
name|'NIC_NAME_LEN'
op|']'
newline|'\n'
nl|'\n'
name|'network'
op|','
name|'ovs_interfaceid'
op|'='
name|'self'
op|'.'
name|'_nw_info_build_network'
op|'('
name|'port'
op|','
nl|'\n'
name|'networks'
op|','
nl|'\n'
name|'subnets'
op|')'
newline|'\n'
nl|'\n'
name|'nw_info'
op|'.'
name|'append'
op|'('
name|'network_model'
op|'.'
name|'VIF'
op|'('
nl|'\n'
name|'id'
op|'='
name|'port'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'address'
op|'='
name|'port'
op|'['
string|"'mac_address'"
op|']'
op|','
nl|'\n'
name|'network'
op|'='
name|'network'
op|','
nl|'\n'
name|'type'
op|'='
name|'port'
op|'.'
name|'get'
op|'('
string|"'binding:vif_type'"
op|')'
op|','
nl|'\n'
name|'ovs_interfaceid'
op|'='
name|'ovs_interfaceid'
op|','
nl|'\n'
name|'devname'
op|'='
name|'devname'
op|')'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'nw_info'
newline|'\n'
nl|'\n'
DECL|member|_get_subnets_from_port
dedent|''
name|'def'
name|'_get_subnets_from_port'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'port'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return the subnets for a given port."""'
newline|'\n'
nl|'\n'
name|'fixed_ips'
op|'='
name|'port'
op|'['
string|"'fixed_ips'"
op|']'
newline|'\n'
comment|'# No fixed_ips for the port means there is no subnet associated'
nl|'\n'
comment|'# with the network the port is created on.'
nl|'\n'
comment|'# Since list_subnets(id=[]) returns all subnets visible for the'
nl|'\n'
comment|'# current tenant, returned subnets may contain subnets which is not'
nl|'\n'
comment|'# related to the port. To avoid this, the method returns here.'
nl|'\n'
name|'if'
name|'not'
name|'fixed_ips'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'['
op|']'
newline|'\n'
dedent|''
name|'search_opts'
op|'='
op|'{'
string|"'id'"
op|':'
op|'['
name|'ip'
op|'['
string|"'subnet_id'"
op|']'
name|'for'
name|'ip'
name|'in'
name|'fixed_ips'
op|']'
op|'}'
newline|'\n'
name|'data'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
op|'.'
name|'list_subnets'
op|'('
op|'**'
name|'search_opts'
op|')'
newline|'\n'
name|'ipam_subnets'
op|'='
name|'data'
op|'.'
name|'get'
op|'('
string|"'subnets'"
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'subnets'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
name|'for'
name|'subnet'
name|'in'
name|'ipam_subnets'
op|':'
newline|'\n'
indent|'            '
name|'subnet_dict'
op|'='
op|'{'
string|"'cidr'"
op|':'
name|'subnet'
op|'['
string|"'cidr'"
op|']'
op|','
nl|'\n'
string|"'gateway'"
op|':'
name|'network_model'
op|'.'
name|'IP'
op|'('
nl|'\n'
name|'address'
op|'='
name|'subnet'
op|'['
string|"'gateway_ip'"
op|']'
op|','
nl|'\n'
name|'type'
op|'='
string|"'gateway'"
op|')'
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
comment|'# attempt to populate DHCP server field'
nl|'\n'
name|'search_opts'
op|'='
op|'{'
string|"'network_id'"
op|':'
name|'subnet'
op|'['
string|"'network_id'"
op|']'
op|','
nl|'\n'
string|"'device_owner'"
op|':'
string|"'network:dhcp'"
op|'}'
newline|'\n'
name|'data'
op|'='
name|'quantumv2'
op|'.'
name|'get_client'
op|'('
name|'context'
op|')'
op|'.'
name|'list_ports'
op|'('
op|'**'
name|'search_opts'
op|')'
newline|'\n'
name|'dhcp_ports'
op|'='
name|'data'
op|'.'
name|'get'
op|'('
string|"'ports'"
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'for'
name|'p'
name|'in'
name|'dhcp_ports'
op|':'
newline|'\n'
indent|'                '
name|'for'
name|'ip_pair'
name|'in'
name|'p'
op|'['
string|"'fixed_ips'"
op|']'
op|':'
newline|'\n'
indent|'                    '
name|'if'
name|'ip_pair'
op|'['
string|"'subnet_id'"
op|']'
op|'=='
name|'subnet'
op|'['
string|"'id'"
op|']'
op|':'
newline|'\n'
indent|'                        '
name|'subnet_dict'
op|'['
string|"'dhcp_server'"
op|']'
op|'='
name|'ip_pair'
op|'['
string|"'ip_address'"
op|']'
newline|'\n'
name|'break'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
name|'subnet_object'
op|'='
name|'network_model'
op|'.'
name|'Subnet'
op|'('
op|'**'
name|'subnet_dict'
op|')'
newline|'\n'
name|'for'
name|'dns'
name|'in'
name|'subnet'
op|'.'
name|'get'
op|'('
string|"'dns_nameservers'"
op|','
op|'['
op|']'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'subnet_object'
op|'.'
name|'add_dns'
op|'('
nl|'\n'
name|'network_model'
op|'.'
name|'IP'
op|'('
name|'address'
op|'='
name|'dns'
op|','
name|'type'
op|'='
string|"'dns'"
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# TODO(gongysh) get the routes for this subnet'
nl|'\n'
dedent|''
name|'subnets'
op|'.'
name|'append'
op|'('
name|'subnet_object'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'subnets'
newline|'\n'
nl|'\n'
DECL|member|get_dns_domains
dedent|''
name|'def'
name|'get_dns_domains'
op|'('
name|'self'
op|','
name|'context'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return a list of available dns domains.\n\n        These can be used to create DNS entries for floating ips.\n        """'
newline|'\n'
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|add_dns_entry
dedent|''
name|'def'
name|'add_dns_entry'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'address'
op|','
name|'name'
op|','
name|'dns_type'
op|','
name|'domain'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Create specified DNS entry for address."""'
newline|'\n'
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|modify_dns_entry
dedent|''
name|'def'
name|'modify_dns_entry'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'name'
op|','
name|'address'
op|','
name|'domain'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Create specified DNS entry for address."""'
newline|'\n'
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|delete_dns_entry
dedent|''
name|'def'
name|'delete_dns_entry'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'name'
op|','
name|'domain'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Delete the specified dns entry."""'
newline|'\n'
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|delete_dns_domain
dedent|''
name|'def'
name|'delete_dns_domain'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'domain'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Delete the specified dns domain."""'
newline|'\n'
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_dns_entries_by_address
dedent|''
name|'def'
name|'get_dns_entries_by_address'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'address'
op|','
name|'domain'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Get entries for address and domain."""'
newline|'\n'
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_dns_entries_by_name
dedent|''
name|'def'
name|'get_dns_entries_by_name'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'name'
op|','
name|'domain'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Get entries for name and domain."""'
newline|'\n'
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|create_private_dns_domain
dedent|''
name|'def'
name|'create_private_dns_domain'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'domain'
op|','
name|'availability_zone'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Create a private DNS domain with nova availability zone."""'
newline|'\n'
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|create_public_dns_domain
dedent|''
name|'def'
name|'create_public_dns_domain'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'domain'
op|','
name|'project'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Create a private DNS domain with optional nova project."""'
newline|'\n'
name|'raise'
name|'NotImplementedError'
op|'('
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|_ensure_requested_network_ordering
dedent|''
dedent|''
name|'def'
name|'_ensure_requested_network_ordering'
op|'('
name|'accessor'
op|','
name|'unordered'
op|','
name|'preferred'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Sort a list with respect to the preferred network ordering."""'
newline|'\n'
name|'if'
name|'preferred'
op|':'
newline|'\n'
indent|'        '
name|'unordered'
op|'.'
name|'sort'
op|'('
name|'key'
op|'='
name|'lambda'
name|'i'
op|':'
name|'preferred'
op|'.'
name|'index'
op|'('
name|'accessor'
op|'('
name|'i'
op|')'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
