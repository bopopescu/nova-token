begin_unit
name|'import'
name|'json'
newline|'\n'
name|'from'
name|'hashlib'
name|'import'
name|'sha1'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'datastore'
newline|'\n'
nl|'\n'
DECL|class|FakeAuth
name|'class'
name|'FakeAuth'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'store'
op|'='
name|'datastore'
op|'.'
name|'Redis'
op|'.'
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_store'
op|'='
name|'store'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'auth_hash'
op|'='
string|"'rs_fake_auth'"
newline|'\n'
name|'self'
op|'.'
name|'_store'
op|'.'
name|'hsetnx'
op|'('
name|'self'
op|'.'
name|'auth_hash'
op|','
string|"'rs_last_id'"
op|','
number|'0'
op|')'
newline|'\n'
nl|'\n'
DECL|member|authorize_token
dedent|''
name|'def'
name|'authorize_token'
op|'('
name|'self'
op|','
name|'token'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'user'
op|'='
name|'self'
op|'.'
name|'_store'
op|'.'
name|'hget'
op|'('
name|'self'
op|'.'
name|'auth_hash'
op|','
name|'token'
op|')'
newline|'\n'
name|'if'
name|'user'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'json'
op|'.'
name|'loads'
op|'('
name|'user'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'None'
newline|'\n'
nl|'\n'
DECL|member|authorize_user
dedent|''
name|'def'
name|'authorize_user'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'key'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'token'
op|'='
name|'sha1'
op|'('
string|'"%s_%s"'
op|'%'
op|'('
name|'user'
op|','
name|'key'
op|')'
op|')'
op|'.'
name|'hexdigest'
op|'('
op|')'
newline|'\n'
name|'user'
op|'='
name|'self'
op|'.'
name|'_store'
op|'.'
name|'hget'
op|'('
name|'self'
op|'.'
name|'auth_hash'
op|','
name|'token'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'user'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
op|','
name|'None'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'token'
op|','
name|'json'
op|'.'
name|'loads'
op|'('
name|'user'
op|')'
newline|'\n'
nl|'\n'
DECL|member|add_user
dedent|''
dedent|''
name|'def'
name|'add_user'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'key'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'last_id'
op|'='
name|'self'
op|'.'
name|'_store'
op|'.'
name|'hget'
op|'('
name|'self'
op|'.'
name|'auth_hash'
op|','
string|"'rs_last_id'"
op|')'
newline|'\n'
name|'token'
op|'='
name|'sha1'
op|'('
string|'"%s_%s"'
op|'%'
op|'('
name|'user'
op|','
name|'key'
op|')'
op|')'
op|'.'
name|'hexdigest'
op|'('
op|')'
newline|'\n'
name|'user'
op|'='
op|'{'
nl|'\n'
string|"'id'"
op|':'
name|'last_id'
op|','
nl|'\n'
string|"'cdn_management_url'"
op|':'
string|"'cdn_management_url'"
op|','
nl|'\n'
string|"'storage_url'"
op|':'
string|"'storage_url'"
op|','
nl|'\n'
string|"'server_management_url'"
op|':'
string|"'server_management_url'"
nl|'\n'
op|'}'
newline|'\n'
name|'new_user'
op|'='
name|'self'
op|'.'
name|'_store'
op|'.'
name|'hsetnx'
op|'('
name|'self'
op|'.'
name|'auth_hash'
op|','
name|'token'
op|','
name|'json'
op|'.'
name|'dumps'
op|'('
name|'user'
op|')'
op|')'
newline|'\n'
name|'if'
name|'new_user'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_store'
op|'.'
name|'hincrby'
op|'('
name|'self'
op|'.'
name|'auth_hash'
op|','
string|"'rs_last_id'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
endmarker|''
end_unit
