begin_unit
name|'import'
name|'time'
newline|'\n'
name|'import'
name|'unittest'
newline|'\n'
name|'import'
name|'webob'
newline|'\n'
nl|'\n'
name|'import'
name|'nova'
op|'.'
name|'api'
op|'.'
name|'rackspace'
op|'.'
name|'ratelimiting'
name|'as'
name|'ratelimiting'
newline|'\n'
nl|'\n'
DECL|class|LimiterTest
name|'class'
name|'LimiterTest'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'limits'
op|'='
op|'{'
nl|'\n'
string|"'a'"
op|':'
op|'('
number|'5'
op|','
name|'ratelimiting'
op|'.'
name|'PER_SECOND'
op|')'
op|','
nl|'\n'
string|"'b'"
op|':'
op|'('
number|'5'
op|','
name|'ratelimiting'
op|'.'
name|'PER_MINUTE'
op|')'
op|','
nl|'\n'
string|"'c'"
op|':'
op|'('
number|'5'
op|','
name|'ratelimiting'
op|'.'
name|'PER_HOUR'
op|')'
op|','
nl|'\n'
string|"'d'"
op|':'
op|'('
number|'1'
op|','
name|'ratelimiting'
op|'.'
name|'PER_SECOND'
op|')'
op|','
nl|'\n'
string|"'e'"
op|':'
op|'('
number|'100'
op|','
name|'ratelimiting'
op|'.'
name|'PER_SECOND'
op|')'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'rl'
op|'='
name|'ratelimiting'
op|'.'
name|'Limiter'
op|'('
name|'self'
op|'.'
name|'limits'
op|')'
newline|'\n'
nl|'\n'
DECL|member|exhaust
dedent|''
name|'def'
name|'exhaust'
op|'('
name|'self'
op|','
name|'action'
op|','
name|'times_until_exhausted'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
name|'times_until_exhausted'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'when'
op|'='
name|'self'
op|'.'
name|'rl'
op|'.'
name|'perform'
op|'('
name|'action'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'when'
op|','
name|'None'
op|')'
newline|'\n'
dedent|''
name|'num'
op|','
name|'period'
op|'='
name|'self'
op|'.'
name|'limits'
op|'['
name|'action'
op|']'
newline|'\n'
name|'delay'
op|'='
name|'period'
op|'*'
number|'1.0'
op|'/'
name|'num'
newline|'\n'
comment|'# Verify that we are now thoroughly delayed'
nl|'\n'
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
number|'10'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'when'
op|'='
name|'self'
op|'.'
name|'rl'
op|'.'
name|'perform'
op|'('
name|'action'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
name|'when'
op|','
name|'delay'
op|','
number|'2'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_second
dedent|''
dedent|''
name|'def'
name|'test_second'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'exhaust'
op|'('
string|"'a'"
op|','
number|'5'
op|')'
newline|'\n'
name|'time'
op|'.'
name|'sleep'
op|'('
number|'0.2'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'exhaust'
op|'('
string|"'a'"
op|','
number|'1'
op|')'
newline|'\n'
name|'time'
op|'.'
name|'sleep'
op|'('
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'exhaust'
op|'('
string|"'a'"
op|','
number|'5'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_minute
dedent|''
name|'def'
name|'test_minute'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'exhaust'
op|'('
string|"'b'"
op|','
number|'5'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_one_per_period
dedent|''
name|'def'
name|'test_one_per_period'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
DECL|function|allow_once_and_deny_once
indent|'        '
name|'def'
name|'allow_once_and_deny_once'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'when'
op|'='
name|'self'
op|'.'
name|'rl'
op|'.'
name|'perform'
op|'('
string|"'d'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'when'
op|','
name|'None'
op|')'
newline|'\n'
name|'when'
op|'='
name|'self'
op|'.'
name|'rl'
op|'.'
name|'perform'
op|'('
string|"'d'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertAlmostEqual'
op|'('
name|'when'
op|','
number|'1'
op|','
number|'2'
op|')'
newline|'\n'
name|'return'
name|'when'
newline|'\n'
dedent|''
name|'time'
op|'.'
name|'sleep'
op|'('
name|'allow_once_and_deny_once'
op|'('
op|')'
op|')'
newline|'\n'
name|'time'
op|'.'
name|'sleep'
op|'('
name|'allow_once_and_deny_once'
op|'('
op|')'
op|')'
newline|'\n'
name|'allow_once_and_deny_once'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_we_can_go_indefinitely_if_we_spread_out_requests
dedent|''
name|'def'
name|'test_we_can_go_indefinitely_if_we_spread_out_requests'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'i'
name|'in'
name|'range'
op|'('
number|'200'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'when'
op|'='
name|'self'
op|'.'
name|'rl'
op|'.'
name|'perform'
op|'('
string|"'e'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'when'
op|','
name|'None'
op|')'
newline|'\n'
name|'time'
op|'.'
name|'sleep'
op|'('
number|'0.01'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_users_get_separate_buckets
dedent|''
dedent|''
name|'def'
name|'test_users_get_separate_buckets'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'exhaust'
op|'('
string|"'c'"
op|','
number|'5'
op|','
name|'username'
op|'='
string|"'alice'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'exhaust'
op|'('
string|"'c'"
op|','
number|'5'
op|','
name|'username'
op|'='
string|"'bob'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'exhaust'
op|'('
string|"'c'"
op|','
number|'5'
op|','
name|'username'
op|'='
string|"'chuck'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'exhaust'
op|'('
string|"'c'"
op|','
number|'0'
op|','
name|'username'
op|'='
string|"'chuck'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'exhaust'
op|'('
string|"'c'"
op|','
number|'0'
op|','
name|'username'
op|'='
string|"'bob'"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'exhaust'
op|'('
string|"'c'"
op|','
number|'0'
op|','
name|'username'
op|'='
string|"'alice'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|WSGIAppTest
dedent|''
dedent|''
name|'class'
name|'WSGIAppTest'
op|'('
name|'unittest'
op|'.'
name|'TestCase'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|setUp
indent|'    '
name|'def'
name|'setUp'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'test'
op|'='
name|'self'
newline|'\n'
DECL|class|FakeLimiter
name|'class'
name|'FakeLimiter'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
DECL|member|__init__
indent|'            '
name|'def'
name|'__init__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'_action'
op|'='
name|'self'
op|'.'
name|'_username'
op|'='
name|'self'
op|'.'
name|'_delay'
op|'='
name|'None'
newline|'\n'
DECL|member|mock
dedent|''
name|'def'
name|'mock'
op|'('
name|'self'
op|','
name|'action'
op|','
name|'username'
op|','
name|'delay'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'_action'
op|'='
name|'action'
newline|'\n'
name|'self'
op|'.'
name|'_username'
op|'='
name|'username'
newline|'\n'
name|'self'
op|'.'
name|'_delay'
op|'='
name|'delay'
newline|'\n'
DECL|member|perform
dedent|''
name|'def'
name|'perform'
op|'('
name|'self'
op|','
name|'action'
op|','
name|'username'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'test'
op|'.'
name|'assertEqual'
op|'('
name|'action'
op|','
name|'self'
op|'.'
name|'_action'
op|')'
newline|'\n'
name|'test'
op|'.'
name|'assertEqual'
op|'('
name|'username'
op|','
name|'self'
op|'.'
name|'_username'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'_delay'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'limiter'
op|'='
name|'FakeLimiter'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'app'
op|'='
name|'ratelimiting'
op|'.'
name|'WSGIApp'
op|'('
name|'self'
op|'.'
name|'limiter'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_invalid_methods
dedent|''
name|'def'
name|'test_invalid_methods'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'requests'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'method'
name|'in'
op|'['
string|"'GET'"
op|','
string|"'PUT'"
op|','
string|"'DELETE'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'req'
op|'='
name|'webob'
op|'.'
name|'Request'
op|'.'
name|'blank'
op|'('
string|"'/limits/michael/breakdance'"
op|','
nl|'\n'
name|'dict'
op|'('
name|'REQUEST_METHOD'
op|'='
name|'method'
op|')'
op|')'
newline|'\n'
name|'requests'
op|'.'
name|'append'
op|'('
name|'req'
op|')'
newline|'\n'
dedent|''
name|'for'
name|'req'
name|'in'
name|'requests'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'req'
op|'.'
name|'get_response'
op|'('
name|'self'
op|'.'
name|'app'
op|')'
op|'.'
name|'status_int'
op|','
number|'405'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_invalid_urls
dedent|''
dedent|''
name|'def'
name|'test_invalid_urls'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'requests'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'prefix'
name|'in'
op|'['
string|"'limit'"
op|','
string|"''"
op|','
string|"'limiter2'"
op|','
string|"'limiter/limits'"
op|','
string|"'limiter/1'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'req'
op|'='
name|'webob'
op|'.'
name|'Request'
op|'.'
name|'blank'
op|'('
string|"'/%s/michael/breakdance'"
op|'%'
name|'prefix'
op|','
nl|'\n'
name|'dict'
op|'('
name|'REQUEST_METHOD'
op|'='
string|"'POST'"
op|')'
op|')'
newline|'\n'
dedent|''
name|'requests'
op|'.'
name|'append'
op|'('
name|'req'
op|')'
newline|'\n'
name|'for'
name|'req'
name|'in'
name|'requests'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'req'
op|'.'
name|'get_response'
op|'('
name|'self'
op|'.'
name|'app'
op|')'
op|'.'
name|'status_int'
op|','
number|'404'
op|')'
newline|'\n'
nl|'\n'
DECL|member|verify
dedent|''
dedent|''
name|'def'
name|'verify'
op|'('
name|'self'
op|','
name|'url'
op|','
name|'username'
op|','
name|'action'
op|','
name|'delay'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Make sure that POSTing to the given url causes the given username\n        to perform the given action.  Make the internal rate limiter return\n        delay and make sure that the WSGI app returns the correct response.\n        """'
newline|'\n'
name|'req'
op|'='
name|'webob'
op|'.'
name|'Request'
op|'.'
name|'blank'
op|'('
name|'url'
op|','
name|'dict'
op|'('
name|'REQUEST_METHOD'
op|'='
string|"'POST'"
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'limiter'
op|'.'
name|'mock'
op|'('
name|'action'
op|','
name|'username'
op|','
name|'delay'
op|')'
newline|'\n'
name|'resp'
op|'='
name|'req'
op|'.'
name|'get_response'
op|'('
name|'self'
op|'.'
name|'app'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'delay'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'resp'
op|'.'
name|'status_int'
op|','
number|'200'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'resp'
op|'.'
name|'status_int'
op|','
number|'403'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'assertEqual'
op|'('
name|'resp'
op|'.'
name|'headers'
op|'['
string|"'X-Wait-Seconds'"
op|']'
op|','
name|'delay'
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_good_urls
dedent|''
dedent|''
name|'def'
name|'test_good_urls'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'verify'
op|'('
string|"'/limiter/michael/hoot'"
op|','
string|"'michael'"
op|','
string|"'hoot'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_escaping
dedent|''
name|'def'
name|'test_escaping'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'verify'
op|'('
string|"'/limiter/michael/jump%20up'"
op|','
string|"'michael'"
op|','
string|"'jump up'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|test_response_to_delays
dedent|''
name|'def'
name|'test_response_to_delays'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'verify'
op|'('
string|"'/limiter/michael/hoot'"
op|','
string|"'michael'"
op|','
string|"'hoot'"
op|','
number|'1'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'verify'
op|'('
string|"'/limiter/michael/hoot'"
op|','
string|"'michael'"
op|','
string|"'hoot'"
op|','
number|'1.56'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'verify'
op|'('
string|"'/limiter/michael/hoot'"
op|','
string|"'michael'"
op|','
string|"'hoot'"
op|','
number|'1000'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'__name__'
op|'=='
string|"'__main__'"
op|':'
newline|'\n'
indent|'    '
name|'unittest'
op|'.'
name|'main'
op|'('
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit
