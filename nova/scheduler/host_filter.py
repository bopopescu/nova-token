begin_unit
comment|'# Copyright (c) 2011 Openstack, LLC.'
nl|'\n'
comment|'# All Rights Reserved.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
string|'"""\nThe Host Filter classes are a way to ensure that only hosts that are\nappropriate are considered when creating a new instance. Hosts that are\neither incompatible or insufficient to accept a newly-requested instance\nare removed by Host Filter classes from consideration. Those that pass\nthe filter are then passed on for weighting or other process for ordering.\n\nFilters are in the \'filters\' directory that is off the \'scheduler\'\ndirectory of nova. Additional filters can be created and added to that\ndirectory; be sure to add them to the filters/__init__.py file so that\nthey are part of the nova.schedulers.filters namespace.\n"""'
newline|'\n'
nl|'\n'
name|'import'
name|'types'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'flags'
newline|'\n'
name|'import'
name|'nova'
op|'.'
name|'scheduler'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
op|'.'
name|'scheduler'
name|'import'
name|'filters'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|FLAGS
name|'FLAGS'
op|'='
name|'flags'
op|'.'
name|'FLAGS'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_list'
op|'('
string|"'default_host_filters'"
op|','
op|'['
string|"'AllHostsFilter'"
op|']'
op|','
nl|'\n'
string|"'Which filters to use for filtering hosts when not specified '"
nl|'\n'
string|"'in the request.'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|_get_filter_classes
name|'def'
name|'_get_filter_classes'
op|'('
op|')'
op|':'
newline|'\n'
comment|'# Imported here to avoid circular imports'
nl|'\n'
indent|'    '
name|'from'
name|'nova'
op|'.'
name|'scheduler'
name|'import'
name|'filters'
newline|'\n'
nl|'\n'
DECL|function|get_itm
name|'def'
name|'get_itm'
op|'('
name|'nm'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'getattr'
op|'('
name|'filters'
op|','
name|'nm'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
op|'['
name|'get_itm'
op|'('
name|'itm'
op|')'
name|'for'
name|'itm'
name|'in'
name|'dir'
op|'('
name|'filters'
op|')'
nl|'\n'
name|'if'
op|'('
name|'type'
op|'('
name|'get_itm'
op|'('
name|'itm'
op|')'
op|')'
name|'is'
name|'types'
op|'.'
name|'TypeType'
op|')'
nl|'\n'
name|'and'
name|'issubclass'
op|'('
name|'get_itm'
op|'('
name|'itm'
op|')'
op|','
name|'filters'
op|'.'
name|'AbstractHostFilter'
op|')'
nl|'\n'
name|'and'
name|'get_itm'
op|'('
name|'itm'
op|')'
name|'is'
name|'not'
name|'filters'
op|'.'
name|'AbstractHostFilter'
op|']'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|choose_host_filters
dedent|''
name|'def'
name|'choose_host_filters'
op|'('
name|'filters'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Since the caller may specify which filters to use we need\n    to have an authoritative list of what is permissible. This\n    function checks the filter names against a predefined set\n    of acceptable filters.\n    """'
newline|'\n'
name|'if'
name|'not'
name|'filters'
op|':'
newline|'\n'
indent|'        '
name|'filters'
op|'='
name|'FLAGS'
op|'.'
name|'default_host_filters'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'isinstance'
op|'('
name|'filters'
op|','
op|'('
name|'list'
op|','
name|'tuple'
op|')'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'filters'
op|'='
op|'['
name|'filters'
op|']'
newline|'\n'
dedent|''
name|'good_filters'
op|'='
op|'['
op|']'
newline|'\n'
name|'bad_filters'
op|'='
op|'['
op|']'
newline|'\n'
name|'filter_classes'
op|'='
name|'_get_filter_classes'
op|'('
op|')'
newline|'\n'
name|'for'
name|'filter_name'
name|'in'
name|'filters'
op|':'
newline|'\n'
indent|'        '
name|'found_class'
op|'='
name|'False'
newline|'\n'
name|'for'
name|'cls'
name|'in'
name|'filter_classes'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'cls'
op|'.'
name|'__name__'
op|'=='
name|'filter_name'
op|':'
newline|'\n'
indent|'                '
name|'good_filters'
op|'.'
name|'append'
op|'('
name|'cls'
op|'('
op|')'
op|')'
newline|'\n'
name|'found_class'
op|'='
name|'True'
newline|'\n'
name|'break'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'not'
name|'found_class'
op|':'
newline|'\n'
indent|'            '
name|'bad_filters'
op|'.'
name|'append'
op|'('
name|'filter_name'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'bad_filters'
op|':'
newline|'\n'
indent|'        '
name|'msg'
op|'='
string|'", "'
op|'.'
name|'join'
op|'('
name|'bad_filters'
op|')'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'SchedulerHostFilterNotFound'
op|'('
name|'filter_name'
op|'='
name|'msg'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'good_filters'
newline|'\n'
dedent|''
endmarker|''
end_unit
