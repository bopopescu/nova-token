begin_unit
comment|'#!/usr/bin/env python'
nl|'\n'
comment|'# vim: tabstop=4 shiftwidth=4 softtabstop=4'
nl|'\n'
nl|'\n'
comment|'# Copyright (c) 2010 Openstack, LLC.'
nl|'\n'
comment|'# All Rights Reserved.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'#    you may not use this file except in compliance with the License.'
nl|'\n'
comment|'#    You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#        http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.'
nl|'\n'
comment|'#    See the License for the specific language governing permissions and'
nl|'\n'
comment|'#    limitations under the License.'
nl|'\n'
nl|'\n'
string|'"""Eventlet WSGI Services to proxy VNC.  No nova deps."""'
newline|'\n'
nl|'\n'
name|'import'
name|'base64'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
nl|'\n'
name|'import'
name|'eventlet'
newline|'\n'
name|'from'
name|'eventlet'
name|'import'
name|'websocket'
newline|'\n'
nl|'\n'
name|'import'
name|'webob'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|WS_ENDPOINT
name|'WS_ENDPOINT'
op|'='
string|"'/data'"
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|WebsocketVNCProxy
name|'class'
name|'WebsocketVNCProxy'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Class to proxy from websocket to vnc server."""'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'wwwroot'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'wwwroot'
op|'='
name|'wwwroot'
newline|'\n'
name|'self'
op|'.'
name|'whitelist'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'for'
name|'root'
op|','
name|'dirs'
op|','
name|'files'
name|'in'
name|'os'
op|'.'
name|'walk'
op|'('
name|'wwwroot'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'hidden_dirs'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'d'
name|'in'
name|'dirs'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'d'
op|'.'
name|'startswith'
op|'('
string|"'.'"
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'hidden_dirs'
op|'.'
name|'append'
op|'('
name|'d'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'for'
name|'d'
name|'in'
name|'hidden_dirs'
op|':'
newline|'\n'
indent|'                '
name|'dirs'
op|'.'
name|'remove'
op|'('
name|'d'
op|')'
newline|'\n'
dedent|''
name|'for'
name|'name'
name|'in'
name|'files'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'not'
name|'str'
op|'('
name|'name'
op|')'
op|'.'
name|'startswith'
op|'('
string|"'.'"
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'filename'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'root'
op|','
name|'name'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'whitelist'
op|'['
name|'filename'
op|']'
op|'='
name|'True'
newline|'\n'
nl|'\n'
DECL|member|get_whitelist
dedent|''
dedent|''
dedent|''
dedent|''
name|'def'
name|'get_whitelist'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'whitelist'
op|'.'
name|'keys'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|sock2ws
dedent|''
name|'def'
name|'sock2ws'
op|'('
name|'self'
op|','
name|'source'
op|','
name|'dest'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'while'
name|'True'
op|':'
newline|'\n'
indent|'                '
name|'d'
op|'='
name|'source'
op|'.'
name|'recv'
op|'('
number|'32384'
op|')'
newline|'\n'
name|'if'
name|'d'
op|'=='
string|"''"
op|':'
newline|'\n'
indent|'                    '
name|'break'
newline|'\n'
dedent|''
name|'d'
op|'='
name|'base64'
op|'.'
name|'b64encode'
op|'('
name|'d'
op|')'
newline|'\n'
name|'dest'
op|'.'
name|'send'
op|'('
name|'d'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
indent|'            '
name|'source'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'dest'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|ws2sock
dedent|''
dedent|''
name|'def'
name|'ws2sock'
op|'('
name|'self'
op|','
name|'source'
op|','
name|'dest'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'while'
name|'True'
op|':'
newline|'\n'
indent|'                '
name|'d'
op|'='
name|'source'
op|'.'
name|'wait'
op|'('
op|')'
newline|'\n'
name|'if'
name|'d'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'                    '
name|'break'
newline|'\n'
dedent|''
name|'d'
op|'='
name|'base64'
op|'.'
name|'b64decode'
op|'('
name|'d'
op|')'
newline|'\n'
name|'dest'
op|'.'
name|'sendall'
op|'('
name|'d'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
indent|'            '
name|'source'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'dest'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|proxy_connection
dedent|''
dedent|''
name|'def'
name|'proxy_connection'
op|'('
name|'self'
op|','
name|'environ'
op|','
name|'start_response'
op|')'
op|':'
newline|'\n'
indent|'        '
op|'@'
name|'websocket'
op|'.'
name|'WebSocketWSGI'
newline|'\n'
DECL|function|_handle
name|'def'
name|'_handle'
op|'('
name|'client'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'server'
op|'='
name|'eventlet'
op|'.'
name|'connect'
op|'('
op|'('
name|'client'
op|'.'
name|'environ'
op|'['
string|"'vnc_host'"
op|']'
op|','
nl|'\n'
name|'client'
op|'.'
name|'environ'
op|'['
string|"'vnc_port'"
op|']'
op|')'
op|')'
newline|'\n'
name|'t1'
op|'='
name|'eventlet'
op|'.'
name|'spawn'
op|'('
name|'self'
op|'.'
name|'ws2sock'
op|','
name|'client'
op|','
name|'server'
op|')'
newline|'\n'
name|'t2'
op|'='
name|'eventlet'
op|'.'
name|'spawn'
op|'('
name|'self'
op|'.'
name|'sock2ws'
op|','
name|'server'
op|','
name|'client'
op|')'
newline|'\n'
name|'t1'
op|'.'
name|'wait'
op|'('
op|')'
newline|'\n'
name|'t2'
op|'.'
name|'wait'
op|'('
op|')'
newline|'\n'
dedent|''
name|'_handle'
op|'('
name|'environ'
op|','
name|'start_response'
op|')'
newline|'\n'
nl|'\n'
DECL|member|__call__
dedent|''
name|'def'
name|'__call__'
op|'('
name|'self'
op|','
name|'environ'
op|','
name|'start_response'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'req'
op|'='
name|'webob'
op|'.'
name|'Request'
op|'('
name|'environ'
op|')'
newline|'\n'
name|'if'
name|'req'
op|'.'
name|'path'
op|'=='
name|'WS_ENDPOINT'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'proxy_connection'
op|'('
name|'environ'
op|','
name|'start_response'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'req'
op|'.'
name|'path'
op|'=='
string|"'/'"
op|':'
newline|'\n'
indent|'                '
name|'fname'
op|'='
string|"'/vnc_auto.html'"
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'fname'
op|'='
name|'req'
op|'.'
name|'path'
newline|'\n'
nl|'\n'
dedent|''
name|'fname'
op|'='
op|'('
name|'self'
op|'.'
name|'wwwroot'
op|'+'
name|'fname'
op|')'
op|'.'
name|'replace'
op|'('
string|"'//'"
op|','
string|"'/'"
op|')'
newline|'\n'
name|'if'
name|'not'
name|'fname'
name|'in'
name|'self'
op|'.'
name|'whitelist'
op|':'
newline|'\n'
indent|'                '
name|'start_response'
op|'('
string|"'404 Not Found'"
op|','
nl|'\n'
op|'['
op|'('
string|"'content-type'"
op|','
string|"'text/html'"
op|')'
op|']'
op|')'
newline|'\n'
name|'return'
string|'"Not Found"'
newline|'\n'
nl|'\n'
dedent|''
name|'base'
op|','
name|'ext'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'splitext'
op|'('
name|'fname'
op|')'
newline|'\n'
name|'if'
name|'ext'
op|'=='
string|"'.js'"
op|':'
newline|'\n'
indent|'                '
name|'mimetype'
op|'='
string|"'application/javascript'"
newline|'\n'
dedent|''
name|'elif'
name|'ext'
op|'=='
string|"'.css'"
op|':'
newline|'\n'
indent|'                '
name|'mimetype'
op|'='
string|"'text/css'"
newline|'\n'
dedent|''
name|'elif'
name|'ext'
name|'in'
op|'['
string|"'.svg'"
op|','
string|"'.jpg'"
op|','
string|"'.png'"
op|','
string|"'.gif'"
op|']'
op|':'
newline|'\n'
indent|'                '
name|'mimetype'
op|'='
string|"'image'"
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'mimetype'
op|'='
string|"'text/html'"
newline|'\n'
nl|'\n'
dedent|''
name|'start_response'
op|'('
string|"'200 OK'"
op|','
op|'['
op|'('
string|"'content-type'"
op|','
name|'mimetype'
op|')'
op|']'
op|')'
newline|'\n'
name|'return'
name|'open'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'fname'
op|')'
op|')'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|DebugMiddleware
dedent|''
dedent|''
dedent|''
name|'class'
name|'DebugMiddleware'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Debug middleware.  Skip auth, get vnc connect info from query string."""'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'app'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'app'
op|'='
name|'app'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'webob'
op|'.'
name|'dec'
op|'.'
name|'wsgify'
newline|'\n'
DECL|member|__call__
name|'def'
name|'__call__'
op|'('
name|'self'
op|','
name|'req'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'req'
op|'.'
name|'path'
op|'=='
name|'WS_ENDPOINT'
op|':'
newline|'\n'
indent|'            '
name|'req'
op|'.'
name|'environ'
op|'['
string|"'vnc_host'"
op|']'
op|'='
name|'req'
op|'.'
name|'params'
op|'.'
name|'get'
op|'('
string|"'host'"
op|')'
newline|'\n'
name|'req'
op|'.'
name|'environ'
op|'['
string|"'vnc_port'"
op|']'
op|'='
name|'int'
op|'('
name|'req'
op|'.'
name|'params'
op|'.'
name|'get'
op|'('
string|"'port'"
op|')'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'req'
op|'.'
name|'get_response'
op|'('
name|'self'
op|'.'
name|'app'
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
