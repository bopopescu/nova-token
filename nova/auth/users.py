begin_unit
comment|'#!/usr/bin/env python'
nl|'\n'
comment|'# vim: tabstop=4 shiftwidth=4 softtabstop=4'
nl|'\n'
nl|'\n'
comment|'# Copyright 2010 United States Government as represented by the'
nl|'\n'
comment|'# Administrator of the National Aeronautics and Space Administration.'
nl|'\n'
comment|'# All Rights Reserved.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Copyright 2010 Anso Labs, LLC'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
string|'"""\nNova users and user management, including RBAC hooks.\n"""'
newline|'\n'
nl|'\n'
name|'import'
name|'datetime'
newline|'\n'
name|'import'
name|'logging'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'shutil'
newline|'\n'
name|'import'
name|'string'
newline|'\n'
name|'from'
name|'string'
name|'import'
name|'Template'
newline|'\n'
name|'import'
name|'tempfile'
newline|'\n'
name|'import'
name|'uuid'
newline|'\n'
name|'import'
name|'zipfile'
newline|'\n'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'    '
name|'import'
name|'ldap'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|','
name|'e'
op|':'
newline|'\n'
indent|'    '
name|'import'
name|'fakeldap'
name|'as'
name|'ldap'
newline|'\n'
nl|'\n'
dedent|''
name|'import'
name|'fakeldap'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'datastore'
newline|'\n'
nl|'\n'
comment|'# TODO(termie): clean up these imports'
nl|'\n'
name|'import'
name|'signer'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'flags'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'crypto'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'utils'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
name|'import'
name|'objectstore'
comment|'# for flags'
newline|'\n'
nl|'\n'
DECL|variable|FLAGS
name|'FLAGS'
op|'='
name|'flags'
op|'.'
name|'FLAGS'
newline|'\n'
nl|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'ldap_url'"
op|','
string|"'ldap://localhost'"
op|','
string|"'Point this at your ldap server'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'ldap_password'"
op|','
string|"'changeme'"
op|','
string|"'LDAP password'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'user_dn'"
op|','
string|"'cn=Manager,dc=example,dc=com'"
op|','
string|"'DN of admin user'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'user_unit'"
op|','
string|"'Users'"
op|','
string|"'OID for Users'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'user_ldap_subtree'"
op|','
string|"'ou=Users,dc=example,dc=com'"
op|','
string|"'OU for Users'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'project_ldap_subtree'"
op|','
string|"'ou=Groups,dc=example,dc=com'"
op|','
string|"'OU for Projects'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'role_ldap_subtree'"
op|','
string|"'ou=Groups,dc=example,dc=com'"
op|','
string|"'OU for Roles'"
op|')'
newline|'\n'
nl|'\n'
comment|"# mapping with these flags is necessary because we're going to tie in to an existing ldap schema"
nl|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'ldap_cloudadmin'"
op|','
nl|'\n'
string|"'cn=cloudadmins,ou=Groups,dc=example,dc=com'"
op|','
string|"'cn for Cloud Admins'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'ldap_itsec'"
op|','
nl|'\n'
string|"'cn=itsec,ou=Groups,dc=example,dc=com'"
op|','
string|"'cn for ItSec'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'ldap_sysadmin'"
op|','
nl|'\n'
string|"'cn=sysadmins,ou=Groups,dc=example,dc=com'"
op|','
string|"'cn for Sysadmins'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'ldap_netadmin'"
op|','
nl|'\n'
string|"'cn=netadmins,ou=Groups,dc=example,dc=com'"
op|','
string|"'cn for NetAdmins'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'ldap_developer'"
op|','
nl|'\n'
string|"'cn=developers,ou=Groups,dc=example,dc=com'"
op|','
string|"'cn for Developers'"
op|')'
newline|'\n'
nl|'\n'
comment|'# a user with one of these roles will be a superuser and have access to all api commands'
nl|'\n'
name|'flags'
op|'.'
name|'DEFINE_list'
op|'('
string|"'superuser_roles'"
op|','
op|'['
string|"'cloudadmin'"
op|']'
op|','
string|"'roles that ignore rbac checking completely'"
op|')'
newline|'\n'
nl|'\n'
comment|'# a user with one of these roles will have it for every project, even if he or she is not a member of the project'
nl|'\n'
name|'flags'
op|'.'
name|'DEFINE_list'
op|'('
string|"'global_roles'"
op|','
op|'['
string|"'cloudadmin'"
op|','
string|"'itsec'"
op|']'
op|','
string|"'roles that apply to all projects'"
op|')'
newline|'\n'
nl|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'credentials_template'"
op|','
nl|'\n'
name|'utils'
op|'.'
name|'abspath'
op|'('
string|"'auth/novarc.template'"
op|')'
op|','
nl|'\n'
string|"'Template for creating users rc file'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'vpn_client_template'"
op|','
nl|'\n'
name|'utils'
op|'.'
name|'abspath'
op|'('
string|"'cloudpipe/client.ovpn.template'"
op|')'
op|','
nl|'\n'
string|"'Template for creating users vpn file'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'credential_key_file'"
op|','
string|"'pk.pem'"
op|','
nl|'\n'
string|"'Filename of private key in credentials zip'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'credential_cert_file'"
op|','
string|"'cert.pem'"
op|','
nl|'\n'
string|"'Filename of certificate in credentials zip'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'credential_rc_file'"
op|','
string|"'novarc'"
op|','
nl|'\n'
string|"'Filename of rc in credentials zip'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'vpn_ip'"
op|','
string|"'127.0.0.1'"
op|','
string|"'Public IP for the cloudpipe VPN servers'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|AuthBase
name|'class'
name|'AuthBase'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
op|'@'
name|'classmethod'
newline|'\n'
DECL|member|safe_id
name|'def'
name|'safe_id'
op|'('
name|'cls'
op|','
name|'obj'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""this method will return the id of the object if the object is of this class, otherwise\n        it will return the original object.  This allows methods to accept objects or\n        ids as paramaters"""'
newline|'\n'
name|'if'
name|'isinstance'
op|'('
name|'obj'
op|','
name|'cls'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'obj'
op|'.'
name|'id'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'obj'
newline|'\n'
nl|'\n'
DECL|class|User
dedent|''
dedent|''
dedent|''
name|'class'
name|'User'
op|'('
name|'AuthBase'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""id and name are currently the same"""'
newline|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'id'
op|','
name|'name'
op|','
name|'access'
op|','
name|'secret'
op|','
name|'admin'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'id'
op|'='
name|'id'
newline|'\n'
name|'self'
op|'.'
name|'name'
op|'='
name|'name'
newline|'\n'
name|'self'
op|'.'
name|'access'
op|'='
name|'access'
newline|'\n'
name|'self'
op|'.'
name|'secret'
op|'='
name|'secret'
newline|'\n'
name|'self'
op|'.'
name|'admin'
op|'='
name|'admin'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|vpn_port
name|'def'
name|'vpn_port'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'port_map'
op|'='
name|'self'
op|'.'
name|'keeper'
op|'['
string|"'vpn_ports'"
op|']'
newline|'\n'
name|'if'
name|'not'
name|'port_map'
op|':'
name|'port_map'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'if'
name|'not'
name|'port_map'
op|'.'
name|'has_key'
op|'('
name|'self'
op|'.'
name|'id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ports'
op|'='
name|'port_map'
op|'.'
name|'values'
op|'('
op|')'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'ports'
op|')'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'                '
name|'port_map'
op|'['
name|'self'
op|'.'
name|'id'
op|']'
op|'='
name|'max'
op|'('
name|'ports'
op|')'
op|'+'
number|'1'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'port_map'
op|'['
name|'self'
op|'.'
name|'id'
op|']'
op|'='
number|'8000'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'keeper'
op|'['
string|"'vpn_ports'"
op|']'
op|'='
name|'port_map'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'keeper'
op|'['
string|"'vpn_ports'"
op|']'
op|'['
name|'self'
op|'.'
name|'id'
op|']'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|vpn_ip
name|'def'
name|'vpn_ip'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'FLAGS'
op|'.'
name|'vpn_ip'
newline|'\n'
nl|'\n'
DECL|member|is_superuser
dedent|''
name|'def'
name|'is_superuser'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""allows user to bypass rbac completely"""'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'admin'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'True'
newline|'\n'
dedent|''
name|'for'
name|'role'
name|'in'
name|'FLAGS'
op|'.'
name|'superuser_roles'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'self'
op|'.'
name|'has_role'
op|'('
name|'role'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'True'
newline|'\n'
nl|'\n'
DECL|member|is_admin
dedent|''
dedent|''
dedent|''
name|'def'
name|'is_admin'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""allows user to see objects from all projects"""'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'is_superuser'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'True'
newline|'\n'
dedent|''
name|'for'
name|'role'
name|'in'
name|'FLAGS'
op|'.'
name|'global_roles'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'self'
op|'.'
name|'has_role'
op|'('
name|'role'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'True'
newline|'\n'
nl|'\n'
DECL|member|has_role
dedent|''
dedent|''
dedent|''
name|'def'
name|'has_role'
op|'('
name|'self'
op|','
name|'role'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'UserManager'
op|'.'
name|'instance'
op|'('
op|')'
op|'.'
name|'has_role'
op|'('
name|'self'
op|','
name|'role'
op|')'
newline|'\n'
nl|'\n'
DECL|member|add_role
dedent|''
name|'def'
name|'add_role'
op|'('
name|'self'
op|','
name|'role'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'UserManager'
op|'.'
name|'instance'
op|'('
op|')'
op|'.'
name|'add_role'
op|'('
name|'self'
op|','
name|'role'
op|')'
newline|'\n'
nl|'\n'
DECL|member|remove_role
dedent|''
name|'def'
name|'remove_role'
op|'('
name|'self'
op|','
name|'role'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'UserManager'
op|'.'
name|'instance'
op|'('
op|')'
op|'.'
name|'remove_role'
op|'('
name|'self'
op|','
name|'role'
op|')'
newline|'\n'
nl|'\n'
DECL|member|is_project_member
dedent|''
name|'def'
name|'is_project_member'
op|'('
name|'self'
op|','
name|'project'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'UserManager'
op|'.'
name|'instance'
op|'('
op|')'
op|'.'
name|'is_project_member'
op|'('
name|'self'
op|','
name|'project'
op|')'
newline|'\n'
nl|'\n'
DECL|member|is_project_manager
dedent|''
name|'def'
name|'is_project_manager'
op|'('
name|'self'
op|','
name|'project'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'UserManager'
op|'.'
name|'instance'
op|'('
op|')'
op|'.'
name|'is_project_manager'
op|'('
name|'self'
op|','
name|'project'
op|')'
newline|'\n'
nl|'\n'
DECL|member|generate_rc
dedent|''
name|'def'
name|'generate_rc'
op|'('
name|'self'
op|','
name|'project'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'project'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'project'
op|'='
name|'self'
op|'.'
name|'id'
newline|'\n'
dedent|''
name|'rc'
op|'='
name|'open'
op|'('
name|'FLAGS'
op|'.'
name|'credentials_template'
op|')'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
name|'rc'
op|'='
name|'rc'
op|'%'
op|'{'
string|"'access'"
op|':'
name|'self'
op|'.'
name|'access'
op|','
nl|'\n'
string|"'project'"
op|':'
name|'project'
op|','
nl|'\n'
string|"'secret'"
op|':'
name|'self'
op|'.'
name|'secret'
op|','
nl|'\n'
string|"'ec2'"
op|':'
name|'FLAGS'
op|'.'
name|'ec2_url'
op|','
nl|'\n'
string|"'s3'"
op|':'
string|"'http://%s:%s'"
op|'%'
op|'('
name|'FLAGS'
op|'.'
name|'s3_host'
op|','
name|'FLAGS'
op|'.'
name|'s3_port'
op|')'
op|','
nl|'\n'
string|"'nova'"
op|':'
name|'FLAGS'
op|'.'
name|'ca_file'
op|','
nl|'\n'
string|"'cert'"
op|':'
name|'FLAGS'
op|'.'
name|'credential_cert_file'
op|','
nl|'\n'
string|"'key'"
op|':'
name|'FLAGS'
op|'.'
name|'credential_key_file'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'return'
name|'rc'
newline|'\n'
nl|'\n'
DECL|member|generate_key_pair
dedent|''
name|'def'
name|'generate_key_pair'
op|'('
name|'self'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'UserManager'
op|'.'
name|'instance'
op|'('
op|')'
op|'.'
name|'generate_key_pair'
op|'('
name|'self'
op|'.'
name|'id'
op|','
name|'name'
op|')'
newline|'\n'
nl|'\n'
DECL|member|create_key_pair
dedent|''
name|'def'
name|'create_key_pair'
op|'('
name|'self'
op|','
name|'name'
op|','
name|'public_key'
op|','
name|'fingerprint'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'UserManager'
op|'.'
name|'instance'
op|'('
op|')'
op|'.'
name|'create_key_pair'
op|'('
name|'self'
op|'.'
name|'id'
op|','
nl|'\n'
name|'name'
op|','
nl|'\n'
name|'public_key'
op|','
nl|'\n'
name|'fingerprint'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_key_pair
dedent|''
name|'def'
name|'get_key_pair'
op|'('
name|'self'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'UserManager'
op|'.'
name|'instance'
op|'('
op|')'
op|'.'
name|'get_key_pair'
op|'('
name|'self'
op|'.'
name|'id'
op|','
name|'name'
op|')'
newline|'\n'
nl|'\n'
DECL|member|delete_key_pair
dedent|''
name|'def'
name|'delete_key_pair'
op|'('
name|'self'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'UserManager'
op|'.'
name|'instance'
op|'('
op|')'
op|'.'
name|'delete_key_pair'
op|'('
name|'self'
op|'.'
name|'id'
op|','
name|'name'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_key_pairs
dedent|''
name|'def'
name|'get_key_pairs'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'UserManager'
op|'.'
name|'instance'
op|'('
op|')'
op|'.'
name|'get_key_pairs'
op|'('
name|'self'
op|'.'
name|'id'
op|')'
newline|'\n'
nl|'\n'
DECL|member|__repr__
dedent|''
name|'def'
name|'__repr__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
string|'"User(\'%s\', \'%s\', \'%s\', \'%s\', %s)"'
op|'%'
op|'('
name|'self'
op|'.'
name|'id'
op|','
name|'self'
op|'.'
name|'name'
op|','
name|'self'
op|'.'
name|'access'
op|','
name|'self'
op|'.'
name|'secret'
op|','
name|'self'
op|'.'
name|'admin'
op|')'
newline|'\n'
nl|'\n'
DECL|class|KeyPair
dedent|''
dedent|''
name|'class'
name|'KeyPair'
op|'('
name|'AuthBase'
op|')'
op|':'
newline|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'id'
op|','
name|'owner_id'
op|','
name|'public_key'
op|','
name|'fingerprint'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'id'
op|'='
name|'id'
newline|'\n'
name|'self'
op|'.'
name|'name'
op|'='
name|'id'
newline|'\n'
name|'self'
op|'.'
name|'owner_id'
op|'='
name|'owner_id'
newline|'\n'
name|'self'
op|'.'
name|'public_key'
op|'='
name|'public_key'
newline|'\n'
name|'self'
op|'.'
name|'fingerprint'
op|'='
name|'fingerprint'
newline|'\n'
nl|'\n'
DECL|member|delete
dedent|''
name|'def'
name|'delete'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'UserManager'
op|'.'
name|'instance'
op|'('
op|')'
op|'.'
name|'delete_key_pair'
op|'('
name|'self'
op|'.'
name|'owner'
op|','
name|'self'
op|'.'
name|'name'
op|')'
newline|'\n'
nl|'\n'
DECL|member|__repr__
dedent|''
name|'def'
name|'__repr__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
string|'"KeyPair(\'%s\', \'%s\', \'%s\', \'%s\')"'
op|'%'
op|'('
name|'self'
op|'.'
name|'id'
op|','
name|'self'
op|'.'
name|'owner_id'
op|','
name|'self'
op|'.'
name|'public_key'
op|','
name|'self'
op|'.'
name|'fingerprint'
op|')'
newline|'\n'
nl|'\n'
DECL|class|Group
dedent|''
dedent|''
name|'class'
name|'Group'
op|'('
name|'AuthBase'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""id and name are currently the same"""'
newline|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'id'
op|','
name|'description'
op|'='
name|'None'
op|','
name|'member_ids'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'id'
op|'='
name|'id'
newline|'\n'
name|'self'
op|'.'
name|'name'
op|'='
name|'id'
newline|'\n'
name|'self'
op|'.'
name|'description'
op|'='
name|'description'
newline|'\n'
name|'self'
op|'.'
name|'member_ids'
op|'='
name|'member_ids'
newline|'\n'
nl|'\n'
DECL|member|has_member
dedent|''
name|'def'
name|'has_member'
op|'('
name|'self'
op|','
name|'user'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
name|'in'
name|'self'
op|'.'
name|'member_ids'
newline|'\n'
nl|'\n'
DECL|member|__repr__
dedent|''
name|'def'
name|'__repr__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
string|'"Group(\'%s\', \'%s\', %s)"'
op|'%'
op|'('
name|'self'
op|'.'
name|'id'
op|','
name|'self'
op|'.'
name|'description'
op|','
name|'self'
op|'.'
name|'member_ids'
op|')'
newline|'\n'
nl|'\n'
DECL|class|Project
dedent|''
dedent|''
name|'class'
name|'Project'
op|'('
name|'Group'
op|')'
op|':'
newline|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'id'
op|','
name|'project_manager_id'
op|','
name|'description'
op|','
name|'member_ids'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'project_manager_id'
op|'='
name|'project_manager_id'
newline|'\n'
name|'super'
op|'('
name|'Project'
op|','
name|'self'
op|')'
op|'.'
name|'__init__'
op|'('
name|'id'
op|','
name|'description'
op|','
name|'member_ids'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'keeper'
op|'='
name|'datastore'
op|'.'
name|'Keeper'
op|'('
name|'prefix'
op|'='
string|'"project-"'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|project_manager
name|'def'
name|'project_manager'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'UserManager'
op|'.'
name|'instance'
op|'('
op|')'
op|'.'
name|'get_user'
op|'('
name|'self'
op|'.'
name|'project_manager_id'
op|')'
newline|'\n'
nl|'\n'
DECL|member|has_manager
dedent|''
name|'def'
name|'has_manager'
op|'('
name|'self'
op|','
name|'user'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
op|'=='
name|'self'
op|'.'
name|'project_manager_id'
newline|'\n'
nl|'\n'
DECL|member|add_role
dedent|''
name|'def'
name|'add_role'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'role'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'UserManager'
op|'.'
name|'instance'
op|'('
op|')'
op|'.'
name|'add_role'
op|'('
name|'user'
op|','
name|'role'
op|','
name|'self'
op|')'
newline|'\n'
nl|'\n'
DECL|member|remove_role
dedent|''
name|'def'
name|'remove_role'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'role'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'UserManager'
op|'.'
name|'instance'
op|'('
op|')'
op|'.'
name|'remove_role'
op|'('
name|'user'
op|','
name|'role'
op|','
name|'self'
op|')'
newline|'\n'
nl|'\n'
DECL|member|has_role
dedent|''
name|'def'
name|'has_role'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'role'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'UserManager'
op|'.'
name|'instance'
op|'('
op|')'
op|'.'
name|'has_role'
op|'('
name|'user'
op|','
name|'role'
op|','
name|'self'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|vpn_port
name|'def'
name|'vpn_port'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'port_map'
op|'='
name|'self'
op|'.'
name|'keeper'
op|'['
string|"'vpn_ports'"
op|']'
newline|'\n'
name|'if'
name|'not'
name|'port_map'
op|':'
name|'port_map'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'if'
name|'not'
name|'port_map'
op|'.'
name|'has_key'
op|'('
name|'self'
op|'.'
name|'id'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ports'
op|'='
name|'port_map'
op|'.'
name|'values'
op|'('
op|')'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'ports'
op|')'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'                '
name|'port_map'
op|'['
name|'self'
op|'.'
name|'id'
op|']'
op|'='
name|'max'
op|'('
name|'ports'
op|')'
op|'+'
number|'1'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'port_map'
op|'['
name|'self'
op|'.'
name|'id'
op|']'
op|'='
number|'8000'
newline|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'keeper'
op|'['
string|"'vpn_ports'"
op|']'
op|'='
name|'port_map'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'keeper'
op|'['
string|"'vpn_ports'"
op|']'
op|'['
name|'self'
op|'.'
name|'id'
op|']'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|vpn_ip
name|'def'
name|'vpn_ip'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'FLAGS'
op|'.'
name|'vpn_ip'
newline|'\n'
nl|'\n'
DECL|member|get_credentials
dedent|''
name|'def'
name|'get_credentials'
op|'('
name|'self'
op|','
name|'user'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'isinstance'
op|'('
name|'user'
op|','
name|'User'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'user'
op|'='
name|'UserManager'
op|'.'
name|'instance'
op|'('
op|')'
op|'.'
name|'get_user'
op|'('
name|'user'
op|')'
newline|'\n'
dedent|''
name|'rc'
op|'='
name|'user'
op|'.'
name|'generate_rc'
op|'('
name|'self'
op|'.'
name|'id'
op|')'
newline|'\n'
name|'private_key'
op|','
name|'signed_cert'
op|'='
name|'self'
op|'.'
name|'generate_x509_cert'
op|'('
name|'user'
op|')'
newline|'\n'
nl|'\n'
name|'configfile'
op|'='
name|'open'
op|'('
name|'FLAGS'
op|'.'
name|'vpn_client_template'
op|','
string|'"r"'
op|')'
newline|'\n'
name|'s'
op|'='
name|'string'
op|'.'
name|'Template'
op|'('
name|'configfile'
op|'.'
name|'read'
op|'('
op|')'
op|')'
newline|'\n'
name|'configfile'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'config'
op|'='
name|'s'
op|'.'
name|'substitute'
op|'('
name|'keyfile'
op|'='
name|'FLAGS'
op|'.'
name|'credential_key_file'
op|','
nl|'\n'
name|'certfile'
op|'='
name|'FLAGS'
op|'.'
name|'credential_cert_file'
op|','
nl|'\n'
name|'ip'
op|'='
name|'self'
op|'.'
name|'vpn_ip'
op|','
nl|'\n'
name|'port'
op|'='
name|'self'
op|'.'
name|'vpn_port'
op|')'
newline|'\n'
nl|'\n'
name|'tmpdir'
op|'='
name|'tempfile'
op|'.'
name|'mkdtemp'
op|'('
op|')'
newline|'\n'
name|'zf'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'tmpdir'
op|','
string|'"temp.zip"'
op|')'
newline|'\n'
name|'zippy'
op|'='
name|'zipfile'
op|'.'
name|'ZipFile'
op|'('
name|'zf'
op|','
string|"'w'"
op|')'
newline|'\n'
name|'zippy'
op|'.'
name|'writestr'
op|'('
name|'FLAGS'
op|'.'
name|'credential_rc_file'
op|','
name|'rc'
op|')'
newline|'\n'
name|'zippy'
op|'.'
name|'writestr'
op|'('
name|'FLAGS'
op|'.'
name|'credential_key_file'
op|','
name|'private_key'
op|')'
newline|'\n'
name|'zippy'
op|'.'
name|'writestr'
op|'('
name|'FLAGS'
op|'.'
name|'credential_cert_file'
op|','
name|'signed_cert'
op|')'
newline|'\n'
name|'zippy'
op|'.'
name|'writestr'
op|'('
string|'"nebula-client.conf"'
op|','
name|'config'
op|')'
newline|'\n'
name|'zippy'
op|'.'
name|'writestr'
op|'('
name|'FLAGS'
op|'.'
name|'ca_file'
op|','
name|'crypto'
op|'.'
name|'fetch_ca'
op|'('
name|'self'
op|'.'
name|'id'
op|')'
op|')'
newline|'\n'
name|'zippy'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
name|'with'
name|'open'
op|'('
name|'zf'
op|','
string|"'rb'"
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'            '
name|'buffer'
op|'='
name|'f'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'shutil'
op|'.'
name|'rmtree'
op|'('
name|'tmpdir'
op|')'
newline|'\n'
name|'return'
name|'buffer'
newline|'\n'
nl|'\n'
DECL|member|generate_x509_cert
dedent|''
name|'def'
name|'generate_x509_cert'
op|'('
name|'self'
op|','
name|'user'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'UserManager'
op|'.'
name|'instance'
op|'('
op|')'
op|'.'
name|'generate_x509_cert'
op|'('
name|'user'
op|','
name|'self'
op|')'
newline|'\n'
nl|'\n'
DECL|member|__repr__
dedent|''
name|'def'
name|'__repr__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
string|'"Project(\'%s\', \'%s\', \'%s\', %s)"'
op|'%'
op|'('
name|'self'
op|'.'
name|'id'
op|','
name|'self'
op|'.'
name|'project_manager_id'
op|','
name|'self'
op|'.'
name|'description'
op|','
name|'self'
op|'.'
name|'member_ids'
op|')'
newline|'\n'
nl|'\n'
DECL|class|UserManager
dedent|''
dedent|''
name|'class'
name|'UserManager'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'hasattr'
op|'('
name|'self'
op|'.'
name|'__class__'
op|','
string|"'_instance'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'Exception'
op|'('
string|"'Attempted to instantiate singleton'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'classmethod'
newline|'\n'
DECL|member|instance
name|'def'
name|'instance'
op|'('
name|'cls'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'hasattr'
op|'('
name|'cls'
op|','
string|"'_instance'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'inst'
op|'='
name|'UserManager'
op|'('
op|')'
newline|'\n'
name|'cls'
op|'.'
name|'_instance'
op|'='
name|'inst'
newline|'\n'
name|'if'
name|'FLAGS'
op|'.'
name|'fake_users'
op|':'
newline|'\n'
indent|'                '
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'inst'
op|'.'
name|'create_user'
op|'('
string|"'fake'"
op|','
string|"'fake'"
op|','
string|"'fake'"
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
name|'pass'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'inst'
op|'.'
name|'create_user'
op|'('
string|"'user'"
op|','
string|"'user'"
op|','
string|"'user'"
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
name|'pass'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'inst'
op|'.'
name|'create_user'
op|'('
string|"'admin'"
op|','
string|"'admin'"
op|','
string|"'admin'"
op|','
name|'True'
op|')'
newline|'\n'
dedent|''
name|'except'
op|':'
name|'pass'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'cls'
op|'.'
name|'_instance'
newline|'\n'
nl|'\n'
DECL|member|authenticate
dedent|''
name|'def'
name|'authenticate'
op|'('
name|'self'
op|','
name|'access'
op|','
name|'signature'
op|','
name|'params'
op|','
name|'verb'
op|'='
string|"'GET'"
op|','
name|'server_string'
op|'='
string|"'127.0.0.1:8773'"
op|','
name|'path'
op|'='
string|"'/'"
op|','
name|'verify_signature'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
comment|'# TODO: Check for valid timestamp'
nl|'\n'
indent|'        '
op|'('
name|'access_key'
op|','
name|'sep'
op|','
name|'project_name'
op|')'
op|'='
name|'access'
op|'.'
name|'partition'
op|'('
string|"':'"
op|')'
newline|'\n'
nl|'\n'
name|'user'
op|'='
name|'self'
op|'.'
name|'get_user_from_access_key'
op|'('
name|'access_key'
op|')'
newline|'\n'
name|'if'
name|'user'
op|'=='
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
string|"'No user found for access key'"
op|')'
newline|'\n'
dedent|''
name|'if'
name|'project_name'
name|'is'
string|"''"
op|':'
newline|'\n'
indent|'            '
name|'project_name'
op|'='
name|'user'
op|'.'
name|'name'
newline|'\n'
nl|'\n'
dedent|''
name|'project'
op|'='
name|'self'
op|'.'
name|'get_project'
op|'('
name|'project_name'
op|')'
newline|'\n'
name|'if'
name|'project'
op|'=='
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
string|"'No project called %s could be found'"
op|'%'
name|'project_name'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'user'
op|'.'
name|'is_admin'
op|'('
op|')'
name|'and'
name|'not'
name|'project'
op|'.'
name|'has_member'
op|'('
name|'user'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
string|"'User %s is not a member of project %s'"
op|'%'
op|'('
name|'user'
op|'.'
name|'id'
op|','
name|'project'
op|'.'
name|'id'
op|')'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'verify_signature'
op|':'
newline|'\n'
comment|"# hmac can't handle unicode, so encode ensures that secret isn't unicode"
nl|'\n'
indent|'            '
name|'expected_signature'
op|'='
name|'signer'
op|'.'
name|'Signer'
op|'('
name|'user'
op|'.'
name|'secret'
op|'.'
name|'encode'
op|'('
op|')'
op|')'
op|'.'
name|'generate'
op|'('
name|'params'
op|','
name|'verb'
op|','
name|'server_string'
op|','
name|'path'
op|')'
newline|'\n'
name|'logging'
op|'.'
name|'debug'
op|'('
string|"'user.secret: %s'"
op|','
name|'user'
op|'.'
name|'secret'
op|')'
newline|'\n'
name|'logging'
op|'.'
name|'debug'
op|'('
string|"'expected_signature: %s'"
op|','
name|'expected_signature'
op|')'
newline|'\n'
name|'logging'
op|'.'
name|'debug'
op|'('
string|"'signature: %s'"
op|','
name|'signature'
op|')'
newline|'\n'
name|'if'
name|'signature'
op|'!='
name|'expected_signature'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'exception'
op|'.'
name|'NotAuthorized'
op|'('
string|"'Signature does not match'"
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
op|'('
name|'user'
op|','
name|'project'
op|')'
newline|'\n'
nl|'\n'
DECL|member|has_role
dedent|''
name|'def'
name|'has_role'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'role'
op|','
name|'project'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'role'
op|'=='
string|"'projectmanager'"
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'not'
name|'project'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'exception'
op|'.'
name|'Error'
op|'('
string|'"Must specify project"'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'is_project_manager'
op|'('
name|'user'
op|','
name|'project'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'global_role'
op|'='
name|'conn'
op|'.'
name|'has_role'
op|'('
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
op|','
nl|'\n'
name|'role'
op|','
nl|'\n'
name|'None'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'global_role'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'global_role'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'not'
name|'project'
name|'or'
name|'role'
name|'in'
name|'FLAGS'
op|'.'
name|'global_roles'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'global_role'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
name|'conn'
op|'.'
name|'has_role'
op|'('
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
op|','
nl|'\n'
name|'role'
op|','
nl|'\n'
name|'Project'
op|'.'
name|'safe_id'
op|'('
name|'project'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|add_role
dedent|''
dedent|''
name|'def'
name|'add_role'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'role'
op|','
name|'project'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'conn'
op|'.'
name|'add_role'
op|'('
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
op|','
name|'role'
op|','
name|'Project'
op|'.'
name|'safe_id'
op|'('
name|'project'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|remove_role
dedent|''
dedent|''
name|'def'
name|'remove_role'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'role'
op|','
name|'project'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'conn'
op|'.'
name|'remove_role'
op|'('
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
op|','
name|'role'
op|','
name|'Project'
op|'.'
name|'safe_id'
op|'('
name|'project'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|create_project
dedent|''
dedent|''
name|'def'
name|'create_project'
op|'('
name|'self'
op|','
name|'name'
op|','
name|'manager_user'
op|','
name|'description'
op|'='
name|'None'
op|','
name|'member_users'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'member_users'
op|':'
newline|'\n'
indent|'            '
name|'member_users'
op|'='
op|'['
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'u'
op|')'
name|'for'
name|'u'
name|'in'
name|'member_users'
op|']'
newline|'\n'
dedent|''
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'conn'
op|'.'
name|'create_project'
op|'('
name|'name'
op|','
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'manager_user'
op|')'
op|','
name|'description'
op|','
name|'member_users'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_projects
dedent|''
dedent|''
name|'def'
name|'get_projects'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'conn'
op|'.'
name|'find_projects'
op|'('
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|member|get_project
dedent|''
dedent|''
name|'def'
name|'get_project'
op|'('
name|'self'
op|','
name|'project'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'conn'
op|'.'
name|'find_project'
op|'('
name|'Project'
op|'.'
name|'safe_id'
op|'('
name|'project'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|add_to_project
dedent|''
dedent|''
name|'def'
name|'add_to_project'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'project'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'conn'
op|'.'
name|'add_to_project'
op|'('
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
op|','
name|'Project'
op|'.'
name|'safe_id'
op|'('
name|'project'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|is_project_manager
dedent|''
dedent|''
name|'def'
name|'is_project_manager'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'project'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'isinstance'
op|'('
name|'project'
op|','
name|'Project'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'project'
op|'='
name|'self'
op|'.'
name|'get_project'
op|'('
name|'project'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'project'
op|'.'
name|'has_manager'
op|'('
name|'user'
op|')'
newline|'\n'
nl|'\n'
DECL|member|is_project_member
dedent|''
name|'def'
name|'is_project_member'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'project'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'isinstance'
op|'('
name|'project'
op|','
name|'Project'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'project'
op|'.'
name|'has_member'
op|'('
name|'user'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'conn'
op|'.'
name|'is_in_project'
op|'('
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
op|','
name|'project'
op|')'
newline|'\n'
nl|'\n'
DECL|member|remove_from_project
dedent|''
dedent|''
dedent|''
name|'def'
name|'remove_from_project'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'project'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'conn'
op|'.'
name|'remove_from_project'
op|'('
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
op|','
name|'Project'
op|'.'
name|'safe_id'
op|'('
name|'project'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|delete_project
dedent|''
dedent|''
name|'def'
name|'delete_project'
op|'('
name|'self'
op|','
name|'project'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'conn'
op|'.'
name|'delete_project'
op|'('
name|'Project'
op|'.'
name|'safe_id'
op|'('
name|'project'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_user
dedent|''
dedent|''
name|'def'
name|'get_user'
op|'('
name|'self'
op|','
name|'uid'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'conn'
op|'.'
name|'find_user'
op|'('
name|'uid'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_user_from_access_key
dedent|''
dedent|''
name|'def'
name|'get_user_from_access_key'
op|'('
name|'self'
op|','
name|'access_key'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'conn'
op|'.'
name|'find_user_by_access_key'
op|'('
name|'access_key'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_users
dedent|''
dedent|''
name|'def'
name|'get_users'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'conn'
op|'.'
name|'find_users'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|create_user
dedent|''
dedent|''
name|'def'
name|'create_user'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'access'
op|'='
name|'None'
op|','
name|'secret'
op|'='
name|'None'
op|','
name|'admin'
op|'='
name|'False'
op|','
name|'create_project'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'access'
op|'=='
name|'None'
op|':'
name|'access'
op|'='
name|'str'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|')'
newline|'\n'
name|'if'
name|'secret'
op|'=='
name|'None'
op|':'
name|'secret'
op|'='
name|'str'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|')'
newline|'\n'
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'user'
op|'='
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
newline|'\n'
name|'result'
op|'='
name|'conn'
op|'.'
name|'create_user'
op|'('
name|'user'
op|','
name|'access'
op|','
name|'secret'
op|','
name|'admin'
op|')'
newline|'\n'
name|'if'
name|'create_project'
op|':'
newline|'\n'
indent|'                '
name|'conn'
op|'.'
name|'create_project'
op|'('
name|'user'
op|','
name|'user'
op|','
name|'user'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'result'
newline|'\n'
nl|'\n'
DECL|member|delete_user
dedent|''
dedent|''
name|'def'
name|'delete_user'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'delete_project'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'user'
op|'='
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
newline|'\n'
name|'if'
name|'delete_project'
op|':'
newline|'\n'
indent|'                '
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'conn'
op|'.'
name|'delete_project'
op|'('
name|'user'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'exception'
op|'.'
name|'NotFound'
op|':'
newline|'\n'
indent|'                    '
name|'pass'
newline|'\n'
dedent|''
dedent|''
name|'conn'
op|'.'
name|'delete_user'
op|'('
name|'user'
op|')'
newline|'\n'
nl|'\n'
DECL|member|generate_key_pair
dedent|''
dedent|''
name|'def'
name|'generate_key_pair'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'key_name'
op|')'
op|':'
newline|'\n'
comment|'# generating key pair is slow so delay generation'
nl|'\n'
comment|'# until after check'
nl|'\n'
indent|'        '
name|'user'
op|'='
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
newline|'\n'
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'not'
name|'conn'
op|'.'
name|'user_exists'
op|'('
name|'user'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
string|'"User %s doesn\'t exist"'
op|'%'
name|'user'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'conn'
op|'.'
name|'key_pair_exists'
op|'('
name|'user'
op|','
name|'key_name'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'exception'
op|'.'
name|'Duplicate'
op|'('
string|'"The keypair %s already exists"'
op|'%'
name|'key_name'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'private_key'
op|','
name|'public_key'
op|','
name|'fingerprint'
op|'='
name|'crypto'
op|'.'
name|'generate_key_pair'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'create_key_pair'
op|'('
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
op|','
name|'key_name'
op|','
name|'public_key'
op|','
name|'fingerprint'
op|')'
newline|'\n'
name|'return'
name|'private_key'
op|','
name|'fingerprint'
newline|'\n'
nl|'\n'
DECL|member|create_key_pair
dedent|''
name|'def'
name|'create_key_pair'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'key_name'
op|','
name|'public_key'
op|','
name|'fingerprint'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'conn'
op|'.'
name|'create_key_pair'
op|'('
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
op|','
name|'key_name'
op|','
name|'public_key'
op|','
name|'fingerprint'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_key_pair
dedent|''
dedent|''
name|'def'
name|'get_key_pair'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'key_name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'conn'
op|'.'
name|'find_key_pair'
op|'('
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
op|','
name|'key_name'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_key_pairs
dedent|''
dedent|''
name|'def'
name|'get_key_pairs'
op|'('
name|'self'
op|','
name|'user'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'conn'
op|'.'
name|'find_key_pairs'
op|'('
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|delete_key_pair
dedent|''
dedent|''
name|'def'
name|'delete_key_pair'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'key_name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'LDAPWrapper'
op|'('
op|')'
name|'as'
name|'conn'
op|':'
newline|'\n'
indent|'            '
name|'conn'
op|'.'
name|'delete_key_pair'
op|'('
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
op|','
name|'key_name'
op|')'
newline|'\n'
nl|'\n'
DECL|member|generate_x509_cert
dedent|''
dedent|''
name|'def'
name|'generate_x509_cert'
op|'('
name|'self'
op|','
name|'user'
op|','
name|'project'
op|')'
op|':'
newline|'\n'
indent|'        '
op|'('
name|'private_key'
op|','
name|'csr'
op|')'
op|'='
name|'crypto'
op|'.'
name|'generate_x509_cert'
op|'('
name|'self'
op|'.'
name|'__cert_subject'
op|'('
name|'User'
op|'.'
name|'safe_id'
op|'('
name|'user'
op|')'
op|')'
op|')'
newline|'\n'
comment|'# TODO - This should be async call back to the cloud controller'
nl|'\n'
name|'signed_cert'
op|'='
name|'crypto'
op|'.'
name|'sign_csr'
op|'('
name|'csr'
op|','
name|'Project'
op|'.'
name|'safe_id'
op|'('
name|'project'
op|')'
op|')'
newline|'\n'
name|'return'
op|'('
name|'private_key'
op|','
name|'signed_cert'
op|')'
newline|'\n'
nl|'\n'
DECL|member|__cert_subject
dedent|''
name|'def'
name|'__cert_subject'
op|'('
name|'self'
op|','
name|'uid'
op|')'
op|':'
newline|'\n'
comment|'# FIXME(ja) - this should be pulled from a global configuration'
nl|'\n'
indent|'        '
name|'return'
string|'"/C=US/ST=California/L=MountainView/O=AnsoLabs/OU=NovaDev/CN=%s-%s"'
op|'%'
op|'('
name|'uid'
op|','
name|'str'
op|'('
name|'datetime'
op|'.'
name|'datetime'
op|'.'
name|'utcnow'
op|'('
op|')'
op|'.'
name|'isoformat'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|LDAPWrapper
dedent|''
dedent|''
name|'class'
name|'LDAPWrapper'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'user'
op|'='
name|'FLAGS'
op|'.'
name|'user_dn'
newline|'\n'
name|'self'
op|'.'
name|'passwd'
op|'='
name|'FLAGS'
op|'.'
name|'ldap_password'
newline|'\n'
nl|'\n'
DECL|member|__enter__
dedent|''
name|'def'
name|'__enter__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'connect'
op|'('
op|')'
newline|'\n'
name|'return'
name|'self'
newline|'\n'
nl|'\n'
DECL|member|__exit__
dedent|''
name|'def'
name|'__exit__'
op|'('
name|'self'
op|','
name|'type'
op|','
name|'value'
op|','
name|'traceback'
op|')'
op|':'
newline|'\n'
comment|"#logging.info('type, value, traceback: %s, %s, %s', type, value, traceback)"
nl|'\n'
indent|'        '
name|'self'
op|'.'
name|'conn'
op|'.'
name|'unbind_s'
op|'('
op|')'
newline|'\n'
name|'return'
name|'False'
newline|'\n'
nl|'\n'
DECL|member|connect
dedent|''
name|'def'
name|'connect'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'""" connect to ldap as admin user """'
newline|'\n'
name|'if'
name|'FLAGS'
op|'.'
name|'fake_users'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'NO_SUCH_OBJECT'
op|'='
name|'fakeldap'
op|'.'
name|'NO_SUCH_OBJECT'
newline|'\n'
name|'self'
op|'.'
name|'OBJECT_CLASS_VIOLATION'
op|'='
name|'fakeldap'
op|'.'
name|'OBJECT_CLASS_VIOLATION'
newline|'\n'
name|'self'
op|'.'
name|'conn'
op|'='
name|'fakeldap'
op|'.'
name|'initialize'
op|'('
name|'FLAGS'
op|'.'
name|'ldap_url'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'NO_SUCH_OBJECT'
op|'='
name|'ldap'
op|'.'
name|'NO_SUCH_OBJECT'
newline|'\n'
name|'self'
op|'.'
name|'OBJECT_CLASS_VIOLATION'
op|'='
name|'ldap'
op|'.'
name|'OBJECT_CLASS_VIOLATION'
newline|'\n'
name|'self'
op|'.'
name|'conn'
op|'='
name|'ldap'
op|'.'
name|'initialize'
op|'('
name|'FLAGS'
op|'.'
name|'ldap_url'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'conn'
op|'.'
name|'simple_bind_s'
op|'('
name|'self'
op|'.'
name|'user'
op|','
name|'self'
op|'.'
name|'passwd'
op|')'
newline|'\n'
nl|'\n'
DECL|member|find_object
dedent|''
name|'def'
name|'find_object'
op|'('
name|'self'
op|','
name|'dn'
op|','
name|'query'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'objects'
op|'='
name|'self'
op|'.'
name|'find_objects'
op|'('
name|'dn'
op|','
name|'query'
op|')'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'objects'
op|')'
op|'=='
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'return'
name|'objects'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
DECL|member|find_dns
dedent|''
name|'def'
name|'find_dns'
op|'('
name|'self'
op|','
name|'dn'
op|','
name|'query'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'res'
op|'='
name|'self'
op|'.'
name|'conn'
op|'.'
name|'search_s'
op|'('
name|'dn'
op|','
name|'ldap'
op|'.'
name|'SCOPE_SUBTREE'
op|','
name|'query'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'NO_SUCH_OBJECT'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'['
op|']'
newline|'\n'
comment|'# just return the DNs'
nl|'\n'
dedent|''
name|'return'
op|'['
name|'dn'
name|'for'
name|'dn'
op|','
name|'attributes'
name|'in'
name|'res'
op|']'
newline|'\n'
nl|'\n'
DECL|member|find_objects
dedent|''
name|'def'
name|'find_objects'
op|'('
name|'self'
op|','
name|'dn'
op|','
name|'query'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'res'
op|'='
name|'self'
op|'.'
name|'conn'
op|'.'
name|'search_s'
op|'('
name|'dn'
op|','
name|'ldap'
op|'.'
name|'SCOPE_SUBTREE'
op|','
name|'query'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'NO_SUCH_OBJECT'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'['
op|']'
newline|'\n'
comment|'# just return the attributes'
nl|'\n'
dedent|''
name|'return'
op|'['
name|'attributes'
name|'for'
name|'dn'
op|','
name|'attributes'
name|'in'
name|'res'
op|']'
newline|'\n'
nl|'\n'
DECL|member|find_users
dedent|''
name|'def'
name|'find_users'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'attrs'
op|'='
name|'self'
op|'.'
name|'find_objects'
op|'('
name|'FLAGS'
op|'.'
name|'user_ldap_subtree'
op|','
string|"'(objectclass=novaUser)'"
op|')'
newline|'\n'
name|'return'
op|'['
name|'self'
op|'.'
name|'__to_user'
op|'('
name|'attr'
op|')'
name|'for'
name|'attr'
name|'in'
name|'attrs'
op|']'
newline|'\n'
nl|'\n'
DECL|member|find_key_pairs
dedent|''
name|'def'
name|'find_key_pairs'
op|'('
name|'self'
op|','
name|'uid'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'attrs'
op|'='
name|'self'
op|'.'
name|'find_objects'
op|'('
name|'self'
op|'.'
name|'__uid_to_dn'
op|'('
name|'uid'
op|')'
op|','
string|"'(objectclass=novaKeyPair)'"
op|')'
newline|'\n'
name|'return'
op|'['
name|'self'
op|'.'
name|'__to_key_pair'
op|'('
name|'uid'
op|','
name|'attr'
op|')'
name|'for'
name|'attr'
name|'in'
name|'attrs'
op|']'
newline|'\n'
nl|'\n'
DECL|member|find_projects
dedent|''
name|'def'
name|'find_projects'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'attrs'
op|'='
name|'self'
op|'.'
name|'find_objects'
op|'('
name|'FLAGS'
op|'.'
name|'project_ldap_subtree'
op|','
string|"'(objectclass=novaProject)'"
op|')'
newline|'\n'
name|'return'
op|'['
name|'self'
op|'.'
name|'__to_project'
op|'('
name|'attr'
op|')'
name|'for'
name|'attr'
name|'in'
name|'attrs'
op|']'
newline|'\n'
nl|'\n'
DECL|member|find_roles
dedent|''
name|'def'
name|'find_roles'
op|'('
name|'self'
op|','
name|'tree'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'attrs'
op|'='
name|'self'
op|'.'
name|'find_objects'
op|'('
name|'tree'
op|','
string|"'(&(objectclass=groupOfNames)(!(objectclass=novaProject)))'"
op|')'
newline|'\n'
name|'return'
op|'['
name|'self'
op|'.'
name|'__to_group'
op|'('
name|'attr'
op|')'
name|'for'
name|'attr'
name|'in'
name|'attrs'
op|']'
newline|'\n'
nl|'\n'
DECL|member|find_group_dns_with_member
dedent|''
name|'def'
name|'find_group_dns_with_member'
op|'('
name|'self'
op|','
name|'tree'
op|','
name|'uid'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'dns'
op|'='
name|'self'
op|'.'
name|'find_dns'
op|'('
name|'tree'
op|','
nl|'\n'
string|"'(&(objectclass=groupOfNames)(member=%s))'"
op|'%'
nl|'\n'
name|'self'
op|'.'
name|'__uid_to_dn'
op|'('
name|'uid'
op|')'
op|')'
newline|'\n'
name|'return'
name|'dns'
newline|'\n'
nl|'\n'
DECL|member|find_user
dedent|''
name|'def'
name|'find_user'
op|'('
name|'self'
op|','
name|'uid'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'attr'
op|'='
name|'self'
op|'.'
name|'find_object'
op|'('
name|'self'
op|'.'
name|'__uid_to_dn'
op|'('
name|'uid'
op|')'
op|','
string|"'(objectclass=novaUser)'"
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'__to_user'
op|'('
name|'attr'
op|')'
newline|'\n'
nl|'\n'
DECL|member|find_key_pair
dedent|''
name|'def'
name|'find_key_pair'
op|'('
name|'self'
op|','
name|'uid'
op|','
name|'key_name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'dn'
op|'='
string|"'cn=%s,%s'"
op|'%'
op|'('
name|'key_name'
op|','
nl|'\n'
name|'self'
op|'.'
name|'__uid_to_dn'
op|'('
name|'uid'
op|')'
op|')'
newline|'\n'
name|'attr'
op|'='
name|'self'
op|'.'
name|'find_object'
op|'('
name|'dn'
op|','
string|"'(objectclass=novaKeyPair)'"
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'__to_key_pair'
op|'('
name|'uid'
op|','
name|'attr'
op|')'
newline|'\n'
nl|'\n'
DECL|member|find_group
dedent|''
name|'def'
name|'find_group'
op|'('
name|'self'
op|','
name|'dn'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""uses dn directly instead of custructing it from name"""'
newline|'\n'
name|'attr'
op|'='
name|'self'
op|'.'
name|'find_object'
op|'('
name|'dn'
op|','
string|"'(objectclass=groupOfNames)'"
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'__to_group'
op|'('
name|'attr'
op|')'
newline|'\n'
nl|'\n'
DECL|member|find_project
dedent|''
name|'def'
name|'find_project'
op|'('
name|'self'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'dn'
op|'='
string|"'cn=%s,%s'"
op|'%'
op|'('
name|'name'
op|','
nl|'\n'
name|'FLAGS'
op|'.'
name|'project_ldap_subtree'
op|')'
newline|'\n'
name|'attr'
op|'='
name|'self'
op|'.'
name|'find_object'
op|'('
name|'dn'
op|','
string|"'(objectclass=novaProject)'"
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'__to_project'
op|'('
name|'attr'
op|')'
newline|'\n'
nl|'\n'
DECL|member|user_exists
dedent|''
name|'def'
name|'user_exists'
op|'('
name|'self'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'find_user'
op|'('
name|'name'
op|')'
op|'!='
name|'None'
newline|'\n'
nl|'\n'
DECL|member|key_pair_exists
dedent|''
name|'def'
name|'key_pair_exists'
op|'('
name|'self'
op|','
name|'uid'
op|','
name|'key_name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'find_key_pair'
op|'('
name|'uid'
op|','
name|'key_name'
op|')'
op|'!='
name|'None'
newline|'\n'
nl|'\n'
DECL|member|project_exists
dedent|''
name|'def'
name|'project_exists'
op|'('
name|'self'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'find_project'
op|'('
name|'name'
op|')'
op|'!='
name|'None'
newline|'\n'
nl|'\n'
DECL|member|group_exists
dedent|''
name|'def'
name|'group_exists'
op|'('
name|'self'
op|','
name|'dn'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'find_group'
op|'('
name|'dn'
op|')'
op|'!='
name|'None'
newline|'\n'
nl|'\n'
DECL|member|delete_key_pairs
dedent|''
name|'def'
name|'delete_key_pairs'
op|'('
name|'self'
op|','
name|'uid'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'keys'
op|'='
name|'self'
op|'.'
name|'find_key_pairs'
op|'('
name|'uid'
op|')'
newline|'\n'
name|'if'
name|'keys'
op|'!='
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'key'
name|'in'
name|'keys'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'delete_key_pair'
op|'('
name|'uid'
op|','
name|'key'
op|'.'
name|'name'
op|')'
newline|'\n'
nl|'\n'
DECL|member|create_user
dedent|''
dedent|''
dedent|''
name|'def'
name|'create_user'
op|'('
name|'self'
op|','
name|'name'
op|','
name|'access_key'
op|','
name|'secret_key'
op|','
name|'is_admin'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'user_exists'
op|'('
name|'name'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'Duplicate'
op|'('
string|'"LDAP user %s already exists"'
op|'%'
name|'name'
op|')'
newline|'\n'
dedent|''
name|'attr'
op|'='
op|'['
nl|'\n'
op|'('
string|"'objectclass'"
op|','
op|'['
string|"'person'"
op|','
nl|'\n'
string|"'organizationalPerson'"
op|','
nl|'\n'
string|"'inetOrgPerson'"
op|','
nl|'\n'
string|"'novaUser'"
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'ou'"
op|','
op|'['
name|'FLAGS'
op|'.'
name|'user_unit'
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'uid'"
op|','
op|'['
name|'name'
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'sn'"
op|','
op|'['
name|'name'
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'cn'"
op|','
op|'['
name|'name'
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'secretKey'"
op|','
op|'['
name|'secret_key'
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'accessKey'"
op|','
op|'['
name|'access_key'
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'isAdmin'"
op|','
op|'['
name|'str'
op|'('
name|'is_admin'
op|')'
op|'.'
name|'upper'
op|'('
op|')'
op|']'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'conn'
op|'.'
name|'add_s'
op|'('
name|'self'
op|'.'
name|'__uid_to_dn'
op|'('
name|'name'
op|')'
op|','
name|'attr'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'__to_user'
op|'('
name|'dict'
op|'('
name|'attr'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|create_project
dedent|''
name|'def'
name|'create_project'
op|'('
name|'self'
op|','
name|'name'
op|','
name|'manager_uid'
op|','
name|'description'
op|'='
name|'None'
op|','
name|'member_uids'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'project_exists'
op|'('
name|'name'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'Duplicate'
op|'('
string|'"Project can\'t be created because project %s already exists"'
op|'%'
name|'name'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'self'
op|'.'
name|'user_exists'
op|'('
name|'manager_uid'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
string|'"Project can\'t be created because manager %s doesn\'t exist"'
op|'%'
name|'manager_uid'
op|')'
newline|'\n'
dedent|''
name|'manager_dn'
op|'='
name|'self'
op|'.'
name|'__uid_to_dn'
op|'('
name|'manager_uid'
op|')'
newline|'\n'
comment|'# description is a required attribute'
nl|'\n'
name|'if'
name|'description'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'description'
op|'='
name|'name'
newline|'\n'
dedent|''
name|'members'
op|'='
op|'['
op|']'
newline|'\n'
name|'if'
name|'member_uids'
op|'!='
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'member_uid'
name|'in'
name|'member_uids'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'not'
name|'self'
op|'.'
name|'user_exists'
op|'('
name|'member_uid'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
string|'"Project can\'t be created because user %s doesn\'t exist"'
op|'%'
name|'member_uid'
op|')'
newline|'\n'
dedent|''
name|'members'
op|'.'
name|'append'
op|'('
name|'self'
op|'.'
name|'__uid_to_dn'
op|'('
name|'member_uid'
op|')'
op|')'
newline|'\n'
comment|'# always add the manager as a member because members is required'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'not'
name|'manager_dn'
name|'in'
name|'members'
op|':'
newline|'\n'
indent|'            '
name|'members'
op|'.'
name|'append'
op|'('
name|'manager_dn'
op|')'
newline|'\n'
dedent|''
name|'attr'
op|'='
op|'['
nl|'\n'
op|'('
string|"'objectclass'"
op|','
op|'['
string|"'novaProject'"
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'cn'"
op|','
op|'['
name|'name'
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'description'"
op|','
op|'['
name|'description'
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'projectManager'"
op|','
op|'['
name|'manager_dn'
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'member'"
op|','
name|'members'
op|')'
nl|'\n'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'conn'
op|'.'
name|'add_s'
op|'('
string|"'cn=%s,%s'"
op|'%'
op|'('
name|'name'
op|','
name|'FLAGS'
op|'.'
name|'project_ldap_subtree'
op|')'
op|','
name|'attr'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'__to_project'
op|'('
name|'dict'
op|'('
name|'attr'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|add_to_project
dedent|''
name|'def'
name|'add_to_project'
op|'('
name|'self'
op|','
name|'uid'
op|','
name|'project_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'dn'
op|'='
string|"'cn=%s,%s'"
op|'%'
op|'('
name|'project_id'
op|','
name|'FLAGS'
op|'.'
name|'project_ldap_subtree'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'add_to_group'
op|'('
name|'uid'
op|','
name|'dn'
op|')'
newline|'\n'
nl|'\n'
DECL|member|remove_from_project
dedent|''
name|'def'
name|'remove_from_project'
op|'('
name|'self'
op|','
name|'uid'
op|','
name|'project_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'dn'
op|'='
string|"'cn=%s,%s'"
op|'%'
op|'('
name|'project_id'
op|','
name|'FLAGS'
op|'.'
name|'project_ldap_subtree'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'remove_from_group'
op|'('
name|'uid'
op|','
name|'dn'
op|')'
newline|'\n'
nl|'\n'
DECL|member|is_in_project
dedent|''
name|'def'
name|'is_in_project'
op|'('
name|'self'
op|','
name|'uid'
op|','
name|'project_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'dn'
op|'='
string|"'cn=%s,%s'"
op|'%'
op|'('
name|'project_id'
op|','
name|'FLAGS'
op|'.'
name|'project_ldap_subtree'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'is_in_group'
op|'('
name|'uid'
op|','
name|'dn'
op|')'
newline|'\n'
nl|'\n'
DECL|member|__role_to_dn
dedent|''
name|'def'
name|'__role_to_dn'
op|'('
name|'self'
op|','
name|'role'
op|','
name|'project_id'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'project_id'
op|'=='
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'FLAGS'
op|'.'
name|'__getitem__'
op|'('
string|'"ldap_%s"'
op|'%'
name|'role'
op|')'
op|'.'
name|'value'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
string|"'cn=%s,cn=%s,%s'"
op|'%'
op|'('
name|'role'
op|','
name|'project_id'
op|','
name|'FLAGS'
op|'.'
name|'project_ldap_subtree'
op|')'
newline|'\n'
nl|'\n'
DECL|member|__create_group
dedent|''
dedent|''
name|'def'
name|'__create_group'
op|'('
name|'self'
op|','
name|'group_dn'
op|','
name|'name'
op|','
name|'uid'
op|','
name|'description'
op|','
name|'member_uids'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'group_exists'
op|'('
name|'name'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'Duplicate'
op|'('
string|'"Group can\'t be created because group %s already exists"'
op|'%'
name|'name'
op|')'
newline|'\n'
dedent|''
name|'members'
op|'='
op|'['
op|']'
newline|'\n'
name|'if'
name|'member_uids'
op|'!='
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'member_uid'
name|'in'
name|'member_uids'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'not'
name|'self'
op|'.'
name|'user_exists'
op|'('
name|'member_uid'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
string|'"Group can\'t be created because user %s doesn\'t exist"'
op|'%'
name|'member_uid'
op|')'
newline|'\n'
dedent|''
name|'members'
op|'.'
name|'append'
op|'('
name|'self'
op|'.'
name|'__uid_to_dn'
op|'('
name|'member_uid'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'dn'
op|'='
name|'self'
op|'.'
name|'__uid_to_dn'
op|'('
name|'uid'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'dn'
name|'in'
name|'members'
op|':'
newline|'\n'
indent|'            '
name|'members'
op|'.'
name|'append'
op|'('
name|'dn'
op|')'
newline|'\n'
dedent|''
name|'attr'
op|'='
op|'['
nl|'\n'
op|'('
string|"'objectclass'"
op|','
op|'['
string|"'groupOfNames'"
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'cn'"
op|','
op|'['
name|'name'
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'description'"
op|','
op|'['
name|'description'
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'member'"
op|','
name|'members'
op|')'
nl|'\n'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'conn'
op|'.'
name|'add_s'
op|'('
name|'group_dn'
op|','
name|'attr'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'__to_group'
op|'('
name|'dict'
op|'('
name|'attr'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|has_role
dedent|''
name|'def'
name|'has_role'
op|'('
name|'self'
op|','
name|'uid'
op|','
name|'role'
op|','
name|'project_id'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'role_dn'
op|'='
name|'self'
op|'.'
name|'__role_to_dn'
op|'('
name|'role'
op|','
name|'project_id'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'is_in_group'
op|'('
name|'uid'
op|','
name|'role_dn'
op|')'
newline|'\n'
nl|'\n'
DECL|member|add_role
dedent|''
name|'def'
name|'add_role'
op|'('
name|'self'
op|','
name|'uid'
op|','
name|'role'
op|','
name|'project_id'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'role_dn'
op|'='
name|'self'
op|'.'
name|'__role_to_dn'
op|'('
name|'role'
op|','
name|'project_id'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'self'
op|'.'
name|'group_exists'
op|'('
name|'role_dn'
op|')'
op|':'
newline|'\n'
comment|"# create the role if it doesn't exist"
nl|'\n'
indent|'            '
name|'description'
op|'='
string|"'%s role for %s'"
op|'%'
op|'('
name|'role'
op|','
name|'project_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'__create_group'
op|'('
name|'role_dn'
op|','
name|'role'
op|','
name|'uid'
op|','
name|'description'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'add_to_group'
op|'('
name|'uid'
op|','
name|'role_dn'
op|')'
newline|'\n'
nl|'\n'
DECL|member|remove_role
dedent|''
dedent|''
name|'def'
name|'remove_role'
op|'('
name|'self'
op|','
name|'uid'
op|','
name|'role'
op|','
name|'project_id'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'role_dn'
op|'='
name|'self'
op|'.'
name|'__role_to_dn'
op|'('
name|'role'
op|','
name|'project_id'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'remove_from_group'
op|'('
name|'uid'
op|','
name|'role_dn'
op|')'
newline|'\n'
nl|'\n'
DECL|member|is_in_group
dedent|''
name|'def'
name|'is_in_group'
op|'('
name|'self'
op|','
name|'uid'
op|','
name|'group_dn'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'self'
op|'.'
name|'user_exists'
op|'('
name|'uid'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
string|'"User %s can\'t be searched in group becuase the user doesn\'t exist"'
op|'%'
op|'('
name|'uid'
op|','
op|')'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'self'
op|'.'
name|'group_exists'
op|'('
name|'group_dn'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'False'
newline|'\n'
dedent|''
name|'res'
op|'='
name|'self'
op|'.'
name|'find_object'
op|'('
name|'group_dn'
op|','
nl|'\n'
string|"'(member=%s)'"
op|'%'
name|'self'
op|'.'
name|'__uid_to_dn'
op|'('
name|'uid'
op|')'
op|')'
newline|'\n'
name|'return'
name|'res'
op|'!='
name|'None'
newline|'\n'
nl|'\n'
DECL|member|add_to_group
dedent|''
name|'def'
name|'add_to_group'
op|'('
name|'self'
op|','
name|'uid'
op|','
name|'group_dn'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'self'
op|'.'
name|'user_exists'
op|'('
name|'uid'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
string|'"User %s can\'t be added to the group becuase the user doesn\'t exist"'
op|'%'
op|'('
name|'uid'
op|','
op|')'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'self'
op|'.'
name|'group_exists'
op|'('
name|'group_dn'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
string|'"The group at dn %s doesn\'t exist"'
op|'%'
op|'('
name|'group_dn'
op|','
op|')'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'self'
op|'.'
name|'is_in_group'
op|'('
name|'uid'
op|','
name|'group_dn'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'Duplicate'
op|'('
string|'"User %s is already a member of the group %s"'
op|'%'
op|'('
name|'uid'
op|','
name|'group_dn'
op|')'
op|')'
newline|'\n'
dedent|''
name|'attr'
op|'='
op|'['
nl|'\n'
op|'('
name|'ldap'
op|'.'
name|'MOD_ADD'
op|','
string|"'member'"
op|','
name|'self'
op|'.'
name|'__uid_to_dn'
op|'('
name|'uid'
op|')'
op|')'
nl|'\n'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'conn'
op|'.'
name|'modify_s'
op|'('
name|'group_dn'
op|','
name|'attr'
op|')'
newline|'\n'
nl|'\n'
DECL|member|remove_from_group
dedent|''
name|'def'
name|'remove_from_group'
op|'('
name|'self'
op|','
name|'uid'
op|','
name|'group_dn'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'self'
op|'.'
name|'group_exists'
op|'('
name|'group_dn'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
string|'"The group at dn %s doesn\'t exist"'
op|'%'
op|'('
name|'group_dn'
op|','
op|')'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'self'
op|'.'
name|'user_exists'
op|'('
name|'uid'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
string|'"User %s can\'t be removed from the group because the user doesn\'t exist"'
op|'%'
op|'('
name|'uid'
op|','
op|')'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'self'
op|'.'
name|'is_in_group'
op|'('
name|'uid'
op|','
name|'group_dn'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
string|'"User %s is not a member of the group"'
op|'%'
op|'('
name|'uid'
op|','
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_safe_remove_from_group'
op|'('
name|'group_dn'
op|','
name|'uid'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_safe_remove_from_group
dedent|''
name|'def'
name|'_safe_remove_from_group'
op|'('
name|'self'
op|','
name|'group_dn'
op|','
name|'uid'
op|')'
op|':'
newline|'\n'
comment|'# FIXME(vish): what if deleted user is a project manager?'
nl|'\n'
indent|'        '
name|'attr'
op|'='
op|'['
op|'('
name|'ldap'
op|'.'
name|'MOD_DELETE'
op|','
string|"'member'"
op|','
name|'self'
op|'.'
name|'__uid_to_dn'
op|'('
name|'uid'
op|')'
op|')'
op|']'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'conn'
op|'.'
name|'modify_s'
op|'('
name|'group_dn'
op|','
name|'attr'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'OBJECT_CLASS_VIOLATION'
op|':'
newline|'\n'
indent|'            '
name|'logging'
op|'.'
name|'debug'
op|'('
string|'"Attempted to remove the last member of a group. "'
nl|'\n'
string|'"Deleting the group at %s instead."'
op|'%'
name|'group_dn'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'delete_group'
op|'('
name|'group_dn'
op|')'
newline|'\n'
nl|'\n'
DECL|member|remove_from_all
dedent|''
dedent|''
name|'def'
name|'remove_from_all'
op|'('
name|'self'
op|','
name|'uid'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'self'
op|'.'
name|'user_exists'
op|'('
name|'uid'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
string|'"User %s can\'t be removed from all because the user doesn\'t exist"'
op|'%'
op|'('
name|'uid'
op|','
op|')'
op|')'
newline|'\n'
dedent|''
name|'dn'
op|'='
name|'self'
op|'.'
name|'__uid_to_dn'
op|'('
name|'uid'
op|')'
newline|'\n'
name|'role_dns'
op|'='
name|'self'
op|'.'
name|'find_group_dns_with_member'
op|'('
nl|'\n'
name|'FLAGS'
op|'.'
name|'role_ldap_subtree'
op|','
name|'uid'
op|')'
newline|'\n'
name|'for'
name|'role_dn'
name|'in'
name|'role_dns'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_safe_remove_from_group'
op|'('
name|'role_dn'
op|','
name|'uid'
op|')'
newline|'\n'
dedent|''
name|'project_dns'
op|'='
name|'self'
op|'.'
name|'find_group_dns_with_member'
op|'('
nl|'\n'
name|'FLAGS'
op|'.'
name|'project_ldap_subtree'
op|','
name|'uid'
op|')'
newline|'\n'
name|'for'
name|'project_dn'
name|'in'
name|'project_dns'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_safe_remove_from_group'
op|'('
name|'project_dn'
op|','
name|'uid'
op|')'
newline|'\n'
nl|'\n'
DECL|member|create_key_pair
dedent|''
dedent|''
name|'def'
name|'create_key_pair'
op|'('
name|'self'
op|','
name|'uid'
op|','
name|'key_name'
op|','
name|'public_key'
op|','
name|'fingerprint'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""create\'s a public key in the directory underneath the user"""'
newline|'\n'
comment|'# TODO(vish): possibly refactor this to store keys in their own ou'
nl|'\n'
comment|'#   and put dn reference in the user object'
nl|'\n'
name|'attr'
op|'='
op|'['
nl|'\n'
op|'('
string|"'objectclass'"
op|','
op|'['
string|"'novaKeyPair'"
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'cn'"
op|','
op|'['
name|'key_name'
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'sshPublicKey'"
op|','
op|'['
name|'public_key'
op|']'
op|')'
op|','
nl|'\n'
op|'('
string|"'keyFingerprint'"
op|','
op|'['
name|'fingerprint'
op|']'
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'conn'
op|'.'
name|'add_s'
op|'('
string|"'cn=%s,%s'"
op|'%'
op|'('
name|'key_name'
op|','
nl|'\n'
name|'self'
op|'.'
name|'__uid_to_dn'
op|'('
name|'uid'
op|')'
op|')'
op|','
nl|'\n'
name|'attr'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'__to_key_pair'
op|'('
name|'uid'
op|','
name|'dict'
op|'('
name|'attr'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|find_user_by_access_key
dedent|''
name|'def'
name|'find_user_by_access_key'
op|'('
name|'self'
op|','
name|'access'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'query'
op|'='
string|"'(accessKey=%s)'"
op|'%'
name|'access'
newline|'\n'
name|'dn'
op|'='
name|'FLAGS'
op|'.'
name|'user_ldap_subtree'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'__to_user'
op|'('
name|'self'
op|'.'
name|'find_object'
op|'('
name|'dn'
op|','
name|'query'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|delete_user
dedent|''
name|'def'
name|'delete_user'
op|'('
name|'self'
op|','
name|'uid'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'self'
op|'.'
name|'user_exists'
op|'('
name|'uid'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
string|'"User %s doesn\'t exist"'
op|'%'
name|'uid'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'delete_key_pairs'
op|'('
name|'uid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'remove_from_all'
op|'('
name|'uid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'conn'
op|'.'
name|'delete_s'
op|'('
string|"'uid=%s,%s'"
op|'%'
op|'('
name|'uid'
op|','
nl|'\n'
name|'FLAGS'
op|'.'
name|'user_ldap_subtree'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|delete_key_pair
dedent|''
name|'def'
name|'delete_key_pair'
op|'('
name|'self'
op|','
name|'uid'
op|','
name|'key_name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'self'
op|'.'
name|'key_pair_exists'
op|'('
name|'uid'
op|','
name|'key_name'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
string|'"Key Pair %s doesn\'t exist for user %s"'
op|'%'
nl|'\n'
op|'('
name|'key_name'
op|','
name|'uid'
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'conn'
op|'.'
name|'delete_s'
op|'('
string|"'cn=%s,uid=%s,%s'"
op|'%'
op|'('
name|'key_name'
op|','
name|'uid'
op|','
nl|'\n'
name|'FLAGS'
op|'.'
name|'user_ldap_subtree'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|delete_group
dedent|''
name|'def'
name|'delete_group'
op|'('
name|'self'
op|','
name|'group_dn'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'self'
op|'.'
name|'group_exists'
op|'('
name|'group_dn'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
string|'"Group at dn %s doesn\'t exist"'
op|'%'
name|'group_dn'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'conn'
op|'.'
name|'delete_s'
op|'('
name|'group_dn'
op|')'
newline|'\n'
nl|'\n'
DECL|member|delete_roles
dedent|''
name|'def'
name|'delete_roles'
op|'('
name|'self'
op|','
name|'project_dn'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'roles'
op|'='
name|'self'
op|'.'
name|'find_roles'
op|'('
name|'project_dn'
op|')'
newline|'\n'
name|'for'
name|'role'
name|'in'
name|'roles'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'delete_group'
op|'('
string|"'cn=%s,%s'"
op|'%'
op|'('
name|'role'
op|'.'
name|'id'
op|','
name|'project_dn'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|delete_project
dedent|''
dedent|''
name|'def'
name|'delete_project'
op|'('
name|'self'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'project_dn'
op|'='
string|"'cn=%s,%s'"
op|'%'
op|'('
name|'name'
op|','
name|'FLAGS'
op|'.'
name|'project_ldap_subtree'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'delete_roles'
op|'('
name|'project_dn'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'delete_group'
op|'('
name|'project_dn'
op|')'
newline|'\n'
nl|'\n'
DECL|member|__to_user
dedent|''
name|'def'
name|'__to_user'
op|'('
name|'self'
op|','
name|'attr'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'attr'
op|'=='
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'return'
name|'User'
op|'('
nl|'\n'
name|'id'
op|'='
name|'attr'
op|'['
string|"'uid'"
op|']'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'name'
op|'='
name|'attr'
op|'['
string|"'cn'"
op|']'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'access'
op|'='
name|'attr'
op|'['
string|"'accessKey'"
op|']'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'secret'
op|'='
name|'attr'
op|'['
string|"'secretKey'"
op|']'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'admin'
op|'='
op|'('
name|'attr'
op|'['
string|"'isAdmin'"
op|']'
op|'['
number|'0'
op|']'
op|'=='
string|"'TRUE'"
op|')'
nl|'\n'
op|')'
newline|'\n'
nl|'\n'
DECL|member|__to_key_pair
dedent|''
name|'def'
name|'__to_key_pair'
op|'('
name|'self'
op|','
name|'owner'
op|','
name|'attr'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'attr'
op|'=='
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'return'
name|'KeyPair'
op|'('
nl|'\n'
name|'id'
op|'='
name|'attr'
op|'['
string|"'cn'"
op|']'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'owner_id'
op|'='
name|'owner'
op|','
nl|'\n'
name|'public_key'
op|'='
name|'attr'
op|'['
string|"'sshPublicKey'"
op|']'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'fingerprint'
op|'='
name|'attr'
op|'['
string|"'keyFingerprint'"
op|']'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
op|')'
newline|'\n'
nl|'\n'
DECL|member|__to_group
dedent|''
name|'def'
name|'__to_group'
op|'('
name|'self'
op|','
name|'attr'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'attr'
op|'=='
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'member_dns'
op|'='
name|'attr'
op|'.'
name|'get'
op|'('
string|"'member'"
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'return'
name|'Group'
op|'('
nl|'\n'
name|'id'
op|'='
name|'attr'
op|'['
string|"'cn'"
op|']'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'description'
op|'='
name|'attr'
op|'.'
name|'get'
op|'('
string|"'description'"
op|','
op|'['
name|'None'
op|']'
op|')'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'member_ids'
op|'='
op|'['
name|'self'
op|'.'
name|'__dn_to_uid'
op|'('
name|'x'
op|')'
name|'for'
name|'x'
name|'in'
name|'member_dns'
op|']'
nl|'\n'
op|')'
newline|'\n'
nl|'\n'
DECL|member|__to_project
dedent|''
name|'def'
name|'__to_project'
op|'('
name|'self'
op|','
name|'attr'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'attr'
op|'=='
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'member_dns'
op|'='
name|'attr'
op|'.'
name|'get'
op|'('
string|"'member'"
op|','
op|'['
op|']'
op|')'
newline|'\n'
name|'return'
name|'Project'
op|'('
nl|'\n'
name|'id'
op|'='
name|'attr'
op|'['
string|"'cn'"
op|']'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'project_manager_id'
op|'='
name|'self'
op|'.'
name|'__dn_to_uid'
op|'('
name|'attr'
op|'['
string|"'projectManager'"
op|']'
op|'['
number|'0'
op|']'
op|')'
op|','
nl|'\n'
name|'description'
op|'='
name|'attr'
op|'.'
name|'get'
op|'('
string|"'description'"
op|','
op|'['
name|'None'
op|']'
op|')'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'member_ids'
op|'='
op|'['
name|'self'
op|'.'
name|'__dn_to_uid'
op|'('
name|'x'
op|')'
name|'for'
name|'x'
name|'in'
name|'member_dns'
op|']'
nl|'\n'
op|')'
newline|'\n'
nl|'\n'
DECL|member|__dn_to_uid
dedent|''
name|'def'
name|'__dn_to_uid'
op|'('
name|'self'
op|','
name|'dn'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'dn'
op|'.'
name|'split'
op|'('
string|"','"
op|')'
op|'['
number|'0'
op|']'
op|'.'
name|'split'
op|'('
string|"'='"
op|')'
op|'['
number|'1'
op|']'
newline|'\n'
nl|'\n'
DECL|member|__uid_to_dn
dedent|''
name|'def'
name|'__uid_to_dn'
op|'('
name|'self'
op|','
name|'dn'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
string|"'uid=%s,%s'"
op|'%'
op|'('
name|'dn'
op|','
name|'FLAGS'
op|'.'
name|'user_ldap_subtree'
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
