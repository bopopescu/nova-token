begin_unit
comment|'# Copyright 2013 Mirantis Inc.'
nl|'\n'
comment|'# All Rights Reserved'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# @author: Victor Sergeyev, Mirantis Inc.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# vim: tabstop=4 shiftwidth=4 softtabstop=4'
nl|'\n'
nl|'\n'
name|'from'
name|'migrate'
op|'.'
name|'changeset'
name|'import'
name|'UniqueConstraint'
newline|'\n'
name|'from'
name|'migrate'
name|'import'
name|'ForeignKeyConstraint'
newline|'\n'
name|'from'
name|'sqlalchemy'
name|'import'
name|'MetaData'
op|','
name|'Table'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
op|'.'
name|'db'
op|'.'
name|'sqlalchemy'
name|'import'
name|'utils'
newline|'\n'
nl|'\n'
DECL|variable|UC_DATA
name|'UC_DATA'
op|'='
op|'{'
nl|'\n'
comment|'# (table_name: ((columns,), old_uc_name_1), (columns,), old_uc_name_2)'
nl|'\n'
string|'"floating_ips"'
op|':'
op|'('
nl|'\n'
op|'('
op|'('
string|'"address"'
op|','
string|'"deleted"'
op|','
op|')'
op|','
string|'"uniq_address_x_deleted"'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
string|'"instance_type_projects"'
op|':'
op|'('
nl|'\n'
op|'('
op|'('
string|'"instance_type_id"'
op|','
string|'"project_id"'
op|','
string|'"deleted"'
op|')'
op|','
nl|'\n'
string|'"uniq_instance_type_id_x_project_id_x_deleted"'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
string|'"instance_types"'
op|':'
op|'('
nl|'\n'
op|'('
op|'('
string|'"name"'
op|','
string|'"deleted"'
op|')'
op|','
string|'"uniq_name_x_deleted"'
op|')'
op|','
nl|'\n'
op|'('
op|'('
string|'"flavorid"'
op|','
string|'"deleted"'
op|','
op|')'
op|','
string|'"uniq_flavorid_x_deleted"'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
string|'"key_pairs"'
op|':'
op|'('
nl|'\n'
op|'('
op|'('
string|'"user_id"'
op|','
string|'"name"'
op|','
string|'"deleted"'
op|')'
op|','
string|'"key_pairs_uniq_name_and_user_id"'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
string|'"networks"'
op|':'
op|'('
nl|'\n'
op|'('
op|'('
string|'"vlan"'
op|','
string|'"deleted"'
op|','
op|')'
op|','
string|'"uniq_vlan_x_deleted"'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
string|'"task_log"'
op|':'
op|'('
nl|'\n'
op|'('
op|'('
string|'"task_name"'
op|','
string|'"host"'
op|','
string|'"period_beginning"'
op|','
string|'"period_ending"'
op|')'
op|','
nl|'\n'
string|'"uniq_task_name_x_host_x_period_beginning_x_period_ending"'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|'}'
newline|'\n'
comment|'# some UC names are different for mysql and postgresql'
nl|'\n'
DECL|variable|UC_SPEC_DB_DATA
name|'UC_SPEC_DB_DATA'
op|'='
op|'{'
nl|'\n'
comment|'# {engine: {table_name: (((columns,), old_uc_name), (...))}}'
nl|'\n'
string|'"sqlite"'
op|':'
op|'{'
nl|'\n'
string|'"instance_info_caches"'
op|':'
op|'('
nl|'\n'
op|'('
op|'('
string|'"instance_uuid"'
op|','
op|')'
op|','
string|'"instance_uuid"'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
string|'"virtual_interfaces"'
op|':'
op|'('
nl|'\n'
op|'('
op|'('
string|'"address"'
op|','
op|')'
op|','
string|'"virtual_interfaces_instance_uuid_fkey"'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|'}'
op|','
nl|'\n'
string|'"mysql"'
op|':'
op|'{'
nl|'\n'
string|'"instance_info_caches"'
op|':'
op|'('
nl|'\n'
op|'('
op|'('
string|'"instance_uuid"'
op|','
op|')'
op|','
string|'"instance_uuid"'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
string|'"virtual_interfaces"'
op|':'
op|'('
nl|'\n'
op|'('
op|'('
string|'"address"'
op|','
op|')'
op|','
string|'"virtual_interfaces_instance_uuid_fkey"'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|'}'
op|','
nl|'\n'
string|'"postgresql"'
op|':'
op|'{'
nl|'\n'
string|'"instance_info_caches"'
op|':'
op|'('
nl|'\n'
op|'('
op|'('
string|'"instance_uuid"'
op|','
op|')'
op|','
string|'"instance_info_caches_instance_uuid_key"'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
string|'"virtual_interfaces"'
op|':'
op|'('
nl|'\n'
op|'('
op|'('
string|'"address"'
op|','
op|')'
op|','
string|'"virtual_interfaces_address_key"'
op|')'
op|','
nl|'\n'
op|')'
op|','
nl|'\n'
op|'}'
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|constraint_names
name|'constraint_names'
op|'='
op|'{'
nl|'\n'
string|'"instance_info_caches"'
op|':'
string|'"instance_info_caches_instance_uuid_fkey"'
op|','
nl|'\n'
string|'"virtual_interfaces"'
op|':'
string|'"virtual_interfaces_instance_uuid_fkey"'
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|_uc_rename
name|'def'
name|'_uc_rename'
op|'('
name|'migrate_engine'
op|','
name|'upgrade'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'UC_DATA'
op|'.'
name|'update'
op|'('
name|'UC_SPEC_DB_DATA'
op|'['
name|'migrate_engine'
op|'.'
name|'name'
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'meta'
op|'='
name|'MetaData'
op|'('
name|'bind'
op|'='
name|'migrate_engine'
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'table'
name|'in'
name|'UC_DATA'
op|':'
newline|'\n'
indent|'        '
name|'t'
op|'='
name|'Table'
op|'('
name|'table'
op|','
name|'meta'
op|','
name|'autoload'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'columns'
op|','
name|'old_uc_name'
name|'in'
name|'UC_DATA'
op|'['
name|'table'
op|']'
op|':'
newline|'\n'
indent|'            '
name|'new_uc_name'
op|'='
string|'"uniq_{0}0{1}"'
op|'.'
name|'format'
op|'('
name|'table'
op|','
string|'"0"'
op|'.'
name|'join'
op|'('
name|'columns'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'table'
name|'in'
name|'constraint_names'
name|'and'
name|'migrate_engine'
op|'.'
name|'name'
op|'=='
string|'"mysql"'
op|':'
newline|'\n'
indent|'                '
name|'instances'
op|'='
name|'Table'
op|'('
string|'"instances"'
op|','
name|'meta'
op|','
name|'autoload'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'upgrade'
name|'and'
op|'('
name|'table'
op|'=='
string|"'instance_info_caches'"
name|'or'
nl|'\n'
name|'table'
op|'=='
string|"'virtual_interfaces'"
op|')'
op|':'
newline|'\n'
comment|'# NOTE(jhesketh): migration 133_folsom.py accidentally'
nl|'\n'
comment|'#                 changed the name of the FK constraint'
nl|'\n'
comment|'#                 from instance_info_caches_ibfk_1 to'
nl|'\n'
comment|'#                 instance_info_caches_instance_uuid_fkey'
nl|'\n'
comment|'#                 meaning databases who have upgraded from'
nl|'\n'
comment|'#                 before folsom have the old fkey.'
nl|'\n'
comment|'#                 We need to make sure all of the fkeys are'
nl|'\n'
comment|'#                 dropped and then add in the correct fkey'
nl|'\n'
comment|'#                 regardless. (This also means when 185 is'
nl|'\n'
comment|'#                 downgraded the user will keep the correct'
nl|'\n'
comment|'#                 fkey as defined in 133).'
nl|'\n'
comment|'#                 There also seems to be a case where both'
nl|'\n'
comment|'#                 versions of the fkey are present in a'
nl|'\n'
comment|'#                 database so we check for each.'
nl|'\n'
comment|'#                 Similarly on table virtual_interfaces it'
nl|'\n'
comment|'#                 is possible to get into a state of having'
nl|'\n'
comment|'#                 both virtual_interfaces_ibfk_1 and'
nl|'\n'
comment|'#                 virtual_interfaces_instance_uuid_fkey'
nl|'\n'
comment|'#                 present in the virtual_interfaces table.'
nl|'\n'
indent|'                    '
name|'for'
name|'index_name'
name|'in'
op|'['
string|"'instance_info_caches_ibfk_1'"
op|','
nl|'\n'
string|"'instance_info_caches_instance_uuid_fkey'"
op|','
nl|'\n'
string|"'virtual_interfaces_ibfk_1'"
op|','
nl|'\n'
string|"'virtual_interfaces_instance_uuid_fkey'"
op|']'
op|':'
newline|'\n'
indent|'                        '
name|'if'
name|'index_name'
name|'in'
op|'['
name|'fk'
op|'.'
name|'name'
name|'for'
name|'fk'
name|'in'
name|'t'
op|'.'
name|'foreign_keys'
op|']'
op|':'
newline|'\n'
indent|'                            '
name|'ForeignKeyConstraint'
op|'('
nl|'\n'
name|'columns'
op|'='
op|'['
name|'t'
op|'.'
name|'c'
op|'.'
name|'instance_uuid'
op|']'
op|','
nl|'\n'
name|'refcolumns'
op|'='
op|'['
name|'instances'
op|'.'
name|'c'
op|'.'
name|'uuid'
op|']'
op|','
nl|'\n'
name|'name'
op|'='
name|'index_name'
nl|'\n'
op|')'
op|'.'
name|'drop'
op|'('
name|'engine'
op|'='
name|'migrate_engine'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'ForeignKeyConstraint'
op|'('
nl|'\n'
name|'columns'
op|'='
op|'['
name|'t'
op|'.'
name|'c'
op|'.'
name|'instance_uuid'
op|']'
op|','
nl|'\n'
name|'refcolumns'
op|'='
op|'['
name|'instances'
op|'.'
name|'c'
op|'.'
name|'uuid'
op|']'
op|','
nl|'\n'
name|'name'
op|'='
name|'constraint_names'
op|'['
name|'table'
op|']'
nl|'\n'
op|')'
op|'.'
name|'drop'
op|'('
name|'engine'
op|'='
name|'migrate_engine'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'upgrade'
op|':'
newline|'\n'
indent|'                '
name|'old_name'
op|','
name|'new_name'
op|'='
name|'old_uc_name'
op|','
name|'new_uc_name'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'old_name'
op|','
name|'new_name'
op|'='
name|'new_uc_name'
op|','
name|'old_uc_name'
newline|'\n'
nl|'\n'
dedent|''
name|'utils'
op|'.'
name|'drop_unique_constraint'
op|'('
name|'migrate_engine'
op|','
name|'table'
op|','
nl|'\n'
name|'old_name'
op|','
op|'*'
op|'('
name|'columns'
op|')'
op|')'
newline|'\n'
name|'if'
op|'('
name|'new_name'
op|'!='
string|"'virtual_interfaces_instance_uuid_fkey'"
name|'or'
nl|'\n'
name|'migrate_engine'
op|'.'
name|'name'
op|'!='
string|'"mysql"'
op|')'
op|':'
newline|'\n'
comment|'# NOTE(jhesketh): The virtual_interfaces_instance_uuid_fkey'
nl|'\n'
comment|"# key always existed in the table, we don't need to create"
nl|'\n'
comment|'# a unique constraint. See bug/1207344'
nl|'\n'
indent|'                '
name|'UniqueConstraint'
op|'('
op|'*'
name|'columns'
op|','
name|'table'
op|'='
name|'t'
op|','
name|'name'
op|'='
name|'new_name'
op|')'
op|'.'
name|'create'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'table'
name|'in'
name|'constraint_names'
name|'and'
name|'migrate_engine'
op|'.'
name|'name'
op|'=='
string|'"mysql"'
op|':'
newline|'\n'
indent|'                '
name|'ForeignKeyConstraint'
op|'('
nl|'\n'
name|'columns'
op|'='
op|'['
name|'t'
op|'.'
name|'c'
op|'.'
name|'instance_uuid'
op|']'
op|','
nl|'\n'
name|'refcolumns'
op|'='
op|'['
name|'instances'
op|'.'
name|'c'
op|'.'
name|'uuid'
op|']'
op|','
nl|'\n'
name|'name'
op|'='
name|'constraint_names'
op|'['
name|'table'
op|']'
nl|'\n'
op|')'
op|'.'
name|'create'
op|'('
name|'engine'
op|'='
name|'migrate_engine'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|upgrade
dedent|''
dedent|''
dedent|''
dedent|''
name|'def'
name|'upgrade'
op|'('
name|'migrate_engine'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'return'
name|'_uc_rename'
op|'('
name|'migrate_engine'
op|','
name|'upgrade'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|downgrade
dedent|''
name|'def'
name|'downgrade'
op|'('
name|'migrate_engine'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'return'
name|'_uc_rename'
op|'('
name|'migrate_engine'
op|','
name|'upgrade'
op|'='
name|'False'
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit
