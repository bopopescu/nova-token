begin_unit
name|'from'
name|'sqlalchemy'
op|'.'
name|'orm'
name|'import'
name|'relationship'
op|','
name|'backref'
op|','
name|'validates'
newline|'\n'
name|'from'
name|'sqlalchemy'
name|'import'
name|'Table'
op|','
name|'Column'
op|','
name|'Integer'
op|','
name|'String'
op|','
name|'MetaData'
op|','
name|'ForeignKey'
op|','
name|'DateTime'
op|','
name|'Boolean'
op|','
name|'Text'
newline|'\n'
name|'from'
name|'sqlalchemy'
op|'.'
name|'ext'
op|'.'
name|'declarative'
name|'import'
name|'declarative_base'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'auth'
newline|'\n'
nl|'\n'
DECL|variable|Base
name|'Base'
op|'='
name|'declarative_base'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|class|Image
name|'class'
name|'Image'
op|'('
name|'Base'
op|')'
op|':'
newline|'\n'
DECL|variable|__tablename__
indent|'    '
name|'__tablename__'
op|'='
string|"'images'"
newline|'\n'
DECL|variable|user_id
name|'user_id'
op|'='
name|'Column'
op|'('
name|'String'
op|')'
comment|"#, ForeignKey('users.id'), nullable=False)"
newline|'\n'
DECL|variable|project_id
name|'project_id'
op|'='
name|'Column'
op|'('
name|'String'
op|')'
comment|"#, ForeignKey('projects.id'), nullable=False)"
newline|'\n'
nl|'\n'
DECL|variable|id
name|'id'
op|'='
name|'Column'
op|'('
name|'String'
op|','
name|'primary_key'
op|'='
name|'True'
op|')'
newline|'\n'
DECL|variable|image_type
name|'image_type'
op|'='
name|'Column'
op|'('
name|'String'
op|')'
newline|'\n'
DECL|variable|public
name|'public'
op|'='
name|'Column'
op|'('
name|'Boolean'
op|','
name|'default'
op|'='
name|'False'
op|')'
newline|'\n'
DECL|variable|state
name|'state'
op|'='
name|'Column'
op|'('
name|'String'
op|')'
newline|'\n'
DECL|variable|location
name|'location'
op|'='
name|'Column'
op|'('
name|'String'
op|')'
newline|'\n'
DECL|variable|arch
name|'arch'
op|'='
name|'Column'
op|'('
name|'String'
op|')'
newline|'\n'
DECL|variable|default_kernel_id
name|'default_kernel_id'
op|'='
name|'Column'
op|'('
name|'String'
op|')'
newline|'\n'
DECL|variable|default_ramdisk_id
name|'default_ramdisk_id'
op|'='
name|'Column'
op|'('
name|'String'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|created_at
name|'created_at'
op|'='
name|'Column'
op|'('
name|'DateTime'
op|')'
newline|'\n'
DECL|variable|updated_at
name|'updated_at'
op|'='
name|'Column'
op|'('
name|'DateTime'
op|')'
comment|'# auto update on change FIXME'
newline|'\n'
nl|'\n'
nl|'\n'
op|'@'
name|'validates'
op|'('
string|"'image_type'"
op|')'
newline|'\n'
DECL|member|validate_image_type
name|'def'
name|'validate_image_type'
op|'('
name|'self'
op|','
name|'key'
op|','
name|'image_type'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'assert'
op|'('
name|'image_type'
name|'in'
op|'['
string|"'machine'"
op|','
string|"'kernel'"
op|','
string|"'ramdisk'"
op|','
string|"'raw'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'validates'
op|'('
string|"'state'"
op|')'
newline|'\n'
DECL|member|validate_state
name|'def'
name|'validate_state'
op|'('
name|'self'
op|','
name|'key'
op|','
name|'state'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'assert'
op|'('
name|'state'
name|'in'
op|'['
string|"'available'"
op|','
string|"'pending'"
op|','
string|"'disabled'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'validates'
op|'('
string|"'default_kernel_id'"
op|')'
newline|'\n'
DECL|member|validate_kernel_id
name|'def'
name|'validate_kernel_id'
op|'('
name|'self'
op|','
name|'key'
op|','
name|'val'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'val'
op|'!='
string|"'machine'"
op|':'
newline|'\n'
indent|'            '
name|'assert'
op|'('
name|'val'
name|'is'
name|'None'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'validates'
op|'('
string|"'default_ramdisk_id'"
op|')'
newline|'\n'
DECL|member|validate_ramdisk_id
name|'def'
name|'validate_ramdisk_id'
op|'('
name|'self'
op|','
name|'key'
op|','
name|'val'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'val'
op|'!='
string|"'machine'"
op|':'
newline|'\n'
indent|'            '
name|'assert'
op|'('
name|'val'
name|'is'
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|class|Network
dedent|''
dedent|''
dedent|''
name|'class'
name|'Network'
op|'('
name|'Base'
op|')'
op|':'
newline|'\n'
DECL|variable|__tablename__
indent|'    '
name|'__tablename__'
op|'='
string|"'networks'"
newline|'\n'
DECL|variable|id
name|'id'
op|'='
name|'Column'
op|'('
name|'Integer'
op|','
name|'primary_key'
op|'='
name|'True'
op|')'
newline|'\n'
DECL|variable|bridge
name|'bridge'
op|'='
name|'Column'
op|'('
name|'String'
op|')'
newline|'\n'
DECL|variable|vlan
name|'vlan'
op|'='
name|'Column'
op|'('
name|'String'
op|')'
newline|'\n'
comment|'#vpn_port = Column(Integer)'
nl|'\n'
DECL|variable|project_id
name|'project_id'
op|'='
name|'Column'
op|'('
name|'String'
op|')'
comment|"#, ForeignKey('projects.id'), nullable=False)"
newline|'\n'
nl|'\n'
DECL|class|PhysicalNode
dedent|''
name|'class'
name|'PhysicalNode'
op|'('
name|'Base'
op|')'
op|':'
newline|'\n'
DECL|variable|__tablename__
indent|'    '
name|'__tablename__'
op|'='
string|"'physical_nodes'"
newline|'\n'
DECL|variable|id
name|'id'
op|'='
name|'Column'
op|'('
name|'Integer'
op|','
name|'primary_key'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|class|Instance
dedent|''
name|'class'
name|'Instance'
op|'('
name|'Base'
op|')'
op|':'
newline|'\n'
DECL|variable|__tablename__
indent|'    '
name|'__tablename__'
op|'='
string|"'instances'"
newline|'\n'
DECL|variable|id
name|'id'
op|'='
name|'Column'
op|'('
name|'Integer'
op|','
name|'primary_key'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|user_id
name|'user_id'
op|'='
name|'Column'
op|'('
name|'String'
op|')'
comment|"#, ForeignKey('users.id'), nullable=False)"
newline|'\n'
DECL|variable|project_id
name|'project_id'
op|'='
name|'Column'
op|'('
name|'String'
op|')'
comment|"#, ForeignKey('projects.id'))"
newline|'\n'
nl|'\n'
op|'@'
name|'property'
newline|'\n'
DECL|member|user
name|'def'
name|'user'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'auth'
op|'.'
name|'manager'
op|'.'
name|'AuthManager'
op|'('
op|')'
op|'.'
name|'get_user'
op|'('
name|'self'
op|'.'
name|'user_id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|project
name|'def'
name|'project'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'auth'
op|'.'
name|'manager'
op|'.'
name|'AuthManager'
op|'('
op|')'
op|'.'
name|'get_project'
op|'('
name|'self'
op|'.'
name|'project_id'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|image_id
dedent|''
name|'image_id'
op|'='
name|'Column'
op|'('
name|'Integer'
op|','
name|'ForeignKey'
op|'('
string|"'images.id'"
op|')'
op|','
name|'nullable'
op|'='
name|'False'
op|')'
newline|'\n'
DECL|variable|kernel_id
name|'kernel_id'
op|'='
name|'Column'
op|'('
name|'String'
op|','
name|'ForeignKey'
op|'('
string|"'images.id'"
op|')'
op|','
name|'nullable'
op|'='
name|'True'
op|')'
newline|'\n'
DECL|variable|ramdisk_id
name|'ramdisk_id'
op|'='
name|'Column'
op|'('
name|'String'
op|','
name|'ForeignKey'
op|'('
string|"'images.id'"
op|')'
op|','
name|'nullable'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|launch_index
name|'launch_index'
op|'='
name|'Column'
op|'('
name|'Integer'
op|')'
newline|'\n'
DECL|variable|key_name
name|'key_name'
op|'='
name|'Column'
op|'('
name|'String'
op|')'
newline|'\n'
DECL|variable|key_data
name|'key_data'
op|'='
name|'Column'
op|'('
name|'Text'
op|')'
newline|'\n'
DECL|variable|security_group
name|'security_group'
op|'='
name|'Column'
op|'('
name|'String'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|state
name|'state'
op|'='
name|'Column'
op|'('
name|'String'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|hostname
name|'hostname'
op|'='
name|'Column'
op|'('
name|'String'
op|')'
newline|'\n'
DECL|variable|physical_node_id
name|'physical_node_id'
op|'='
name|'Column'
op|'('
name|'Integer'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|instance_type
name|'instance_type'
op|'='
name|'Column'
op|'('
name|'Integer'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|user_data
name|'user_data'
op|'='
name|'Column'
op|'('
name|'Text'
op|')'
newline|'\n'
nl|'\n'
comment|"#    ramdisk = relationship(Ramdisk, backref=backref('instances', order_by=id))"
nl|'\n'
comment|"#    kernel = relationship(Kernel, backref=backref('instances', order_by=id))"
nl|'\n'
comment|"#    project = relationship(Project, backref=backref('instances', order_by=id))"
nl|'\n'
nl|'\n'
comment|"#TODO - see Ewan's email about state improvements"
nl|'\n'
comment|'# vmstate_state = running, halted, suspended, paused'
nl|'\n'
comment|'# power_state = what we have'
nl|'\n'
comment|'# task_state = transitory and may trigger power state transition'
nl|'\n'
nl|'\n'
op|'@'
name|'validates'
op|'('
string|"'state'"
op|')'
newline|'\n'
DECL|member|validate_state
name|'def'
name|'validate_state'
op|'('
name|'self'
op|','
name|'key'
op|','
name|'state'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'assert'
op|'('
name|'state'
name|'in'
op|'['
string|"'nostate'"
op|','
string|"'running'"
op|','
string|"'blocked'"
op|','
string|"'paused'"
op|','
string|"'shutdown'"
op|','
string|"'shutoff'"
op|','
string|"'crashed'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|class|Volume
dedent|''
dedent|''
name|'class'
name|'Volume'
op|'('
name|'Base'
op|')'
op|':'
newline|'\n'
DECL|variable|__tablename__
indent|'    '
name|'__tablename__'
op|'='
string|"'volumes'"
newline|'\n'
DECL|variable|id
name|'id'
op|'='
name|'Column'
op|'('
name|'Integer'
op|','
name|'primary_key'
op|'='
name|'True'
op|')'
newline|'\n'
DECL|variable|shelf_id
name|'shelf_id'
op|'='
name|'Column'
op|'('
name|'Integer'
op|')'
newline|'\n'
DECL|variable|blade_id
name|'blade_id'
op|'='
name|'Column'
op|'('
name|'Integer'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|engine
dedent|''
name|'engine'
op|'='
name|'None'
newline|'\n'
DECL|function|create_engine
name|'def'
name|'create_engine'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
name|'global'
name|'engine'
newline|'\n'
name|'if'
name|'engine'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'       '
name|'return'
name|'engine'
newline|'\n'
dedent|''
name|'from'
name|'sqlalchemy'
name|'import'
name|'create_engine'
newline|'\n'
name|'engine'
op|'='
name|'create_engine'
op|'('
string|"'sqlite:///:memory:'"
op|','
name|'echo'
op|'='
name|'True'
op|')'
newline|'\n'
name|'Base'
op|'.'
name|'metadata'
op|'.'
name|'create_all'
op|'('
name|'engine'
op|')'
newline|'\n'
name|'return'
name|'engine'
newline|'\n'
nl|'\n'
DECL|function|create_session
dedent|''
name|'def'
name|'create_session'
op|'('
name|'engine'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'engine'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'        '
name|'engine'
op|'='
name|'create_engine'
op|'('
op|')'
newline|'\n'
dedent|''
name|'from'
name|'sqlalchemy'
op|'.'
name|'orm'
name|'import'
name|'sessionmaker'
newline|'\n'
name|'Session'
op|'='
name|'sessionmaker'
op|'('
name|'bind'
op|'='
name|'engine'
op|')'
newline|'\n'
name|'return'
name|'Session'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'__name__'
op|'=='
string|"'__main__'"
op|':'
newline|'\n'
DECL|variable|engine
indent|'    '
name|'engine'
op|'='
name|'create_engine'
op|'('
op|')'
newline|'\n'
DECL|variable|session
name|'session'
op|'='
name|'create_session'
op|'('
name|'engine'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|instance
name|'instance'
op|'='
name|'Instance'
op|'('
name|'image_id'
op|'='
string|"'as'"
op|','
name|'ramdisk_id'
op|'='
string|"'AS'"
op|','
name|'user_id'
op|'='
string|"'anthony'"
op|')'
newline|'\n'
DECL|variable|user
name|'user'
op|'='
name|'User'
op|'('
name|'id'
op|'='
string|"'anthony'"
op|')'
newline|'\n'
name|'session'
op|'.'
name|'add'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'session'
op|'.'
name|'commit'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
endmarker|''
end_unit
