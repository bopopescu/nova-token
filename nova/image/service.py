begin_unit
comment|'# vim: tabstop=4 shiftwidth=4 softtabstop=4'
nl|'\n'
nl|'\n'
comment|'# Copyright 2010 OpenStack LLC.'
nl|'\n'
comment|'# All Rights Reserved.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'cPickle'
name|'as'
name|'pickle'
newline|'\n'
name|'import'
name|'os'
op|'.'
name|'path'
newline|'\n'
name|'import'
name|'random'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
name|'import'
name|'flags'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
nl|'\n'
DECL|variable|FLAGS
name|'FLAGS'
op|'='
name|'flags'
op|'.'
name|'FLAGS'
newline|'\n'
nl|'\n'
nl|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'glance_teller_address'"
op|','
string|"'http://127.0.0.1'"
op|','
nl|'\n'
string|"'IP address or URL where Glance\\'s Teller service resides'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'glance_teller_port'"
op|','
string|"'9191'"
op|','
nl|'\n'
string|"'Port for Glance\\'s Teller service'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'glance_parallax_address'"
op|','
string|"'http://127.0.0.1'"
op|','
nl|'\n'
string|"'IP address or URL where Glance\\'s Parallax service '"
nl|'\n'
string|"'resides'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'glance_parallax_port'"
op|','
string|"'9292'"
op|','
nl|'\n'
string|"'Port for Glance\\'s Parallax service'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|BaseImageService
name|'class'
name|'BaseImageService'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'    '
string|'"""Base class for providing image search and retrieval services"""'
newline|'\n'
nl|'\n'
DECL|member|index
name|'def'
name|'index'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Returns a sequence of mappings of id and name information about\n        images.\n\n        :retval a sequence of mappings with the following signature:\n\n            [\n            {\'id\': opaque id of image,\n             \'name\': name of image\n             }, ...\n            ]\n\n        """'
newline|'\n'
name|'raise'
name|'NotImplementedError'
newline|'\n'
nl|'\n'
DECL|member|detail
dedent|''
name|'def'
name|'detail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Returns a sequence of mappings of detailed information about images.\n\n        :retval a sequence of mappings with the following signature:\n\n            [\n            {\'id\': opaque id of image,\n             \'name\': name of image,\n             \'created_at\': creation timestamp,\n             \'updated_at\': modification timestamp,\n             \'deleted_at\': deletion timestamp or None,\n             \'deleted\': boolean indicating if image has been deleted,\n             \'status\': string description of image status,\n             \'is_public\': boolean indicating if image is public\n             }, ...\n            ]\n\n        If the service does not implement a method that provides a detailed\n        set of information about images, then the method should raise\n        NotImplementedError, in which case Nova will emulate this method\n        with repeated calls to show() for each image received from the\n        index() method.\n        """'
newline|'\n'
name|'raise'
name|'NotImplementedError'
newline|'\n'
nl|'\n'
DECL|member|show
dedent|''
name|'def'
name|'show'
op|'('
name|'self'
op|','
name|'id'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Returns a dict containing image data for the given opaque image id.\n\n        :retval a mapping with the following signature:\n\n            {\'id\': opaque id of image,\n             \'name\': name of image,\n             \'created_at\': creation timestamp,\n             \'updated_at\': modification timestamp,\n             \'deleted_at\': deletion timestamp or None,\n             \'deleted\': boolean indicating if image has been deleted,\n             \'status\': string description of image status,\n             \'is_public\': boolean indicating if image is public\n             }, ...\n\n        :raises NotFound if the image does not exist\n        """'
newline|'\n'
name|'raise'
name|'NotImplementedError'
newline|'\n'
nl|'\n'
DECL|member|create
dedent|''
name|'def'
name|'create'
op|'('
name|'self'
op|','
name|'data'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Store the image data and return the new image id.\n\n        :raises AlreadyExists if the image already exist.\n\n        """'
newline|'\n'
name|'raise'
name|'NotImplementedError'
newline|'\n'
nl|'\n'
DECL|member|update
dedent|''
name|'def'
name|'update'
op|'('
name|'self'
op|','
name|'image_id'
op|','
name|'data'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Replace the contents of the given image with the new data.\n\n        :raises NotFound if the image does not exist.\n\n        """'
newline|'\n'
name|'raise'
name|'NotImplementedError'
newline|'\n'
nl|'\n'
DECL|member|delete
dedent|''
name|'def'
name|'delete'
op|'('
name|'self'
op|','
name|'image_id'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Delete the given image.\n\n        :raises NotFound if the image does not exist.\n\n        """'
newline|'\n'
name|'raise'
name|'NotImplementedError'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|LocalImageService
dedent|''
dedent|''
name|'class'
name|'LocalImageService'
op|'('
name|'BaseImageService'
op|')'
op|':'
newline|'\n'
nl|'\n'
indent|'    '
string|'"""Image service storing images to local disk.\n\n    It assumes that image_ids are integers."""'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_path'
op|'='
string|'"/tmp/nova/images"'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'os'
op|'.'
name|'makedirs'
op|'('
name|'self'
op|'.'
name|'_path'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'OSError'
op|':'
comment|'# Exists'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
nl|'\n'
DECL|member|_path_to
dedent|''
dedent|''
name|'def'
name|'_path_to'
op|'('
name|'self'
op|','
name|'image_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'self'
op|'.'
name|'_path'
op|','
name|'str'
op|'('
name|'image_id'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_ids
dedent|''
name|'def'
name|'_ids'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""The list of all image ids."""'
newline|'\n'
name|'return'
op|'['
name|'int'
op|'('
name|'i'
op|')'
name|'for'
name|'i'
name|'in'
name|'os'
op|'.'
name|'listdir'
op|'('
name|'self'
op|'.'
name|'_path'
op|')'
op|']'
newline|'\n'
nl|'\n'
DECL|member|index
dedent|''
name|'def'
name|'index'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
op|'['
name|'dict'
op|'('
name|'id'
op|'='
name|'i'
op|'['
string|"'id'"
op|']'
op|','
name|'name'
op|'='
name|'i'
op|'['
string|"'name'"
op|']'
op|')'
name|'for'
name|'i'
name|'in'
name|'self'
op|'.'
name|'detail'
op|'('
op|')'
op|']'
newline|'\n'
nl|'\n'
DECL|member|detail
dedent|''
name|'def'
name|'detail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
op|'['
name|'self'
op|'.'
name|'show'
op|'('
name|'id'
op|')'
name|'for'
name|'id'
name|'in'
name|'self'
op|'.'
name|'_ids'
op|'('
op|')'
op|']'
newline|'\n'
nl|'\n'
DECL|member|show
dedent|''
name|'def'
name|'show'
op|'('
name|'self'
op|','
name|'id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'pickle'
op|'.'
name|'load'
op|'('
name|'open'
op|'('
name|'self'
op|'.'
name|'_path_to'
op|'('
name|'id'
op|')'
op|')'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'IOError'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
newline|'\n'
nl|'\n'
DECL|member|create
dedent|''
dedent|''
name|'def'
name|'create'
op|'('
name|'self'
op|','
name|'data'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Store the image data and return the new image id.\n        """'
newline|'\n'
name|'id'
op|'='
name|'random'
op|'.'
name|'randint'
op|'('
number|'0'
op|','
number|'2'
op|'**'
number|'32'
op|'-'
number|'1'
op|')'
newline|'\n'
name|'data'
op|'['
string|"'id'"
op|']'
op|'='
name|'id'
newline|'\n'
name|'self'
op|'.'
name|'update'
op|'('
name|'id'
op|','
name|'data'
op|')'
newline|'\n'
name|'return'
name|'id'
newline|'\n'
nl|'\n'
DECL|member|update
dedent|''
name|'def'
name|'update'
op|'('
name|'self'
op|','
name|'image_id'
op|','
name|'data'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Replace the contents of the given image with the new data."""'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'pickle'
op|'.'
name|'dump'
op|'('
name|'data'
op|','
name|'open'
op|'('
name|'self'
op|'.'
name|'_path_to'
op|'('
name|'image_id'
op|')'
op|','
string|"'w'"
op|')'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'IOError'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
newline|'\n'
nl|'\n'
DECL|member|delete
dedent|''
dedent|''
name|'def'
name|'delete'
op|'('
name|'self'
op|','
name|'image_id'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Delete the given image.  Raises OSError if the image does not exist.\n        """'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'os'
op|'.'
name|'unlink'
op|'('
name|'self'
op|'.'
name|'_path_to'
op|'('
name|'image_id'
op|')'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'IOError'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
newline|'\n'
nl|'\n'
DECL|member|delete_all
dedent|''
dedent|''
name|'def'
name|'delete_all'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Clears out all images in local directory\n        """'
newline|'\n'
name|'for'
name|'id'
name|'in'
name|'self'
op|'.'
name|'_ids'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'os'
op|'.'
name|'unlink'
op|'('
name|'self'
op|'.'
name|'_path_to'
op|'('
name|'id'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
endmarker|''
end_unit
