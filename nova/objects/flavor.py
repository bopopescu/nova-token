begin_unit
comment|'#    Copyright 2013 Red Hat, Inc'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
name|'from'
name|'oslo_db'
name|'import'
name|'exception'
name|'as'
name|'db_exc'
newline|'\n'
name|'from'
name|'oslo_db'
op|'.'
name|'sqlalchemy'
name|'import'
name|'utils'
name|'as'
name|'sqlalchemyutils'
newline|'\n'
name|'from'
name|'oslo_log'
name|'import'
name|'log'
name|'as'
name|'logging'
newline|'\n'
name|'from'
name|'sqlalchemy'
name|'import'
name|'or_'
newline|'\n'
name|'from'
name|'sqlalchemy'
op|'.'
name|'orm'
name|'import'
name|'joinedload'
newline|'\n'
name|'from'
name|'sqlalchemy'
op|'.'
name|'sql'
op|'.'
name|'expression'
name|'import'
name|'asc'
newline|'\n'
name|'from'
name|'sqlalchemy'
op|'.'
name|'sql'
name|'import'
name|'func'
newline|'\n'
name|'from'
name|'sqlalchemy'
op|'.'
name|'sql'
name|'import'
name|'text'
newline|'\n'
name|'from'
name|'sqlalchemy'
op|'.'
name|'sql'
name|'import'
name|'true'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
name|'import'
name|'db'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'db'
op|'.'
name|'sqlalchemy'
name|'import'
name|'api'
name|'as'
name|'db_api'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'db'
op|'.'
name|'sqlalchemy'
op|'.'
name|'api'
name|'import'
name|'require_context'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'db'
op|'.'
name|'sqlalchemy'
name|'import'
name|'api_models'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'db'
op|'.'
name|'sqlalchemy'
name|'import'
name|'models'
name|'as'
name|'main_models'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'i18n'
name|'import'
name|'_LW'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'objects'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'objects'
name|'import'
name|'base'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'objects'
name|'import'
name|'fields'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|LOG
name|'LOG'
op|'='
name|'logging'
op|'.'
name|'getLogger'
op|'('
name|'__name__'
op|')'
newline|'\n'
DECL|variable|OPTIONAL_FIELDS
name|'OPTIONAL_FIELDS'
op|'='
op|'['
string|"'extra_specs'"
op|','
string|"'projects'"
op|']'
newline|'\n'
DECL|variable|DEPRECATED_FIELDS
name|'DEPRECATED_FIELDS'
op|'='
op|'['
string|"'deleted'"
op|','
string|"'deleted_at'"
op|']'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|_dict_with_extra_specs
name|'def'
name|'_dict_with_extra_specs'
op|'('
name|'flavor_model'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'extra_specs'
op|'='
op|'{'
name|'x'
op|'['
string|"'key'"
op|']'
op|':'
name|'x'
op|'['
string|"'value'"
op|']'
nl|'\n'
name|'for'
name|'x'
name|'in'
name|'flavor_model'
op|'['
string|"'extra_specs'"
op|']'
op|'}'
newline|'\n'
name|'return'
name|'dict'
op|'('
name|'flavor_model'
op|','
name|'extra_specs'
op|'='
name|'extra_specs'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
comment|'# NOTE(danms): There are some issues with the oslo_db context manager'
nl|'\n'
comment|'# decorators with static methods. We pull these out for now and can'
nl|'\n'
comment|'# move them back into the actual staticmethods on the object when those'
nl|'\n'
comment|'# issues are resolved.'
nl|'\n'
dedent|''
op|'@'
name|'db_api'
op|'.'
name|'api_context_manager'
op|'.'
name|'reader'
newline|'\n'
DECL|function|_get_projects_from_db
name|'def'
name|'_get_projects_from_db'
op|'('
name|'context'
op|','
name|'flavorid'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'db_flavor'
op|'='
name|'context'
op|'.'
name|'session'
op|'.'
name|'query'
op|'('
name|'api_models'
op|'.'
name|'Flavors'
op|')'
op|'.'
name|'filter_by'
op|'('
name|'flavorid'
op|'='
name|'flavorid'
op|')'
op|'.'
name|'options'
op|'('
name|'joinedload'
op|'('
string|"'projects'"
op|')'
op|')'
op|'.'
name|'first'
op|'('
op|')'
newline|'\n'
name|'if'
name|'not'
name|'db_flavor'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'exception'
op|'.'
name|'FlavorNotFound'
op|'('
name|'flavor_id'
op|'='
name|'flavorid'
op|')'
newline|'\n'
dedent|''
name|'return'
op|'['
name|'x'
op|'['
string|"'project_id'"
op|']'
name|'for'
name|'x'
name|'in'
name|'db_flavor'
op|'['
string|"'projects'"
op|']'
op|']'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
op|'@'
name|'db_api'
op|'.'
name|'api_context_manager'
op|'.'
name|'writer'
newline|'\n'
DECL|function|_flavor_add_project
name|'def'
name|'_flavor_add_project'
op|'('
name|'context'
op|','
name|'flavor_id'
op|','
name|'project_id'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'project'
op|'='
name|'api_models'
op|'.'
name|'FlavorProjects'
op|'('
op|')'
newline|'\n'
name|'project'
op|'.'
name|'update'
op|'('
op|'{'
string|"'flavor_id'"
op|':'
name|'flavor_id'
op|','
nl|'\n'
string|"'project_id'"
op|':'
name|'project_id'
op|'}'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'project'
op|'.'
name|'save'
op|'('
name|'context'
op|'.'
name|'session'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'db_exc'
op|'.'
name|'DBDuplicateEntry'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'exception'
op|'.'
name|'FlavorAccessExists'
op|'('
name|'flavor_id'
op|'='
name|'flavor_id'
op|','
nl|'\n'
name|'project_id'
op|'='
name|'project_id'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'db_api'
op|'.'
name|'api_context_manager'
op|'.'
name|'writer'
newline|'\n'
DECL|function|_flavor_del_project
name|'def'
name|'_flavor_del_project'
op|'('
name|'context'
op|','
name|'flavor_id'
op|','
name|'project_id'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'result'
op|'='
name|'context'
op|'.'
name|'session'
op|'.'
name|'query'
op|'('
name|'api_models'
op|'.'
name|'FlavorProjects'
op|')'
op|'.'
name|'filter_by'
op|'('
name|'project_id'
op|'='
name|'project_id'
op|')'
op|'.'
name|'filter_by'
op|'('
name|'flavor_id'
op|'='
name|'flavor_id'
op|')'
op|'.'
name|'delete'
op|'('
op|')'
newline|'\n'
name|'if'
name|'result'
op|'=='
number|'0'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'exception'
op|'.'
name|'FlavorAccessNotFound'
op|'('
name|'flavor_id'
op|'='
name|'flavor_id'
op|','
nl|'\n'
name|'project_id'
op|'='
name|'project_id'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'db_api'
op|'.'
name|'api_context_manager'
op|'.'
name|'writer'
newline|'\n'
DECL|function|_flavor_extra_specs_add
name|'def'
name|'_flavor_extra_specs_add'
op|'('
name|'context'
op|','
name|'flavor_id'
op|','
name|'specs'
op|','
name|'max_retries'
op|'='
number|'10'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'writer'
op|'='
name|'db_api'
op|'.'
name|'api_context_manager'
op|'.'
name|'writer'
newline|'\n'
name|'for'
name|'attempt'
name|'in'
name|'range'
op|'('
name|'max_retries'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'spec_refs'
op|'='
name|'context'
op|'.'
name|'session'
op|'.'
name|'query'
op|'('
nl|'\n'
name|'api_models'
op|'.'
name|'FlavorExtraSpecs'
op|')'
op|'.'
name|'filter_by'
op|'('
name|'flavor_id'
op|'='
name|'flavor_id'
op|')'
op|'.'
name|'filter'
op|'('
name|'api_models'
op|'.'
name|'FlavorExtraSpecs'
op|'.'
name|'key'
op|'.'
name|'in_'
op|'('
nl|'\n'
name|'specs'
op|'.'
name|'keys'
op|'('
op|')'
op|')'
op|')'
op|'.'
name|'all'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'existing_keys'
op|'='
name|'set'
op|'('
op|')'
newline|'\n'
name|'for'
name|'spec_ref'
name|'in'
name|'spec_refs'
op|':'
newline|'\n'
indent|'                '
name|'key'
op|'='
name|'spec_ref'
op|'['
string|'"key"'
op|']'
newline|'\n'
name|'existing_keys'
op|'.'
name|'add'
op|'('
name|'key'
op|')'
newline|'\n'
name|'with'
name|'writer'
op|'.'
name|'savepoint'
op|'.'
name|'using'
op|'('
name|'context'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'spec_ref'
op|'.'
name|'update'
op|'('
op|'{'
string|'"value"'
op|':'
name|'specs'
op|'['
name|'key'
op|']'
op|'}'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'for'
name|'key'
op|','
name|'value'
name|'in'
name|'specs'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'key'
name|'in'
name|'existing_keys'
op|':'
newline|'\n'
indent|'                    '
name|'continue'
newline|'\n'
dedent|''
name|'spec_ref'
op|'='
name|'api_models'
op|'.'
name|'FlavorExtraSpecs'
op|'('
op|')'
newline|'\n'
name|'with'
name|'writer'
op|'.'
name|'savepoint'
op|'.'
name|'using'
op|'('
name|'context'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'spec_ref'
op|'.'
name|'update'
op|'('
op|'{'
string|'"key"'
op|':'
name|'key'
op|','
string|'"value"'
op|':'
name|'value'
op|','
nl|'\n'
string|'"flavor_id"'
op|':'
name|'flavor_id'
op|'}'
op|')'
newline|'\n'
name|'context'
op|'.'
name|'session'
op|'.'
name|'add'
op|'('
name|'spec_ref'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'return'
name|'specs'
newline|'\n'
dedent|''
name|'except'
name|'db_exc'
op|'.'
name|'DBDuplicateEntry'
op|':'
newline|'\n'
comment|'# a concurrent transaction has been committed,'
nl|'\n'
comment|'# try again unless this was the last attempt'
nl|'\n'
indent|'            '
name|'if'
name|'attempt'
op|'=='
name|'max_retries'
op|'-'
number|'1'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'exception'
op|'.'
name|'FlavorExtraSpecUpdateCreateFailed'
op|'('
nl|'\n'
name|'id'
op|'='
name|'flavor_id'
op|','
name|'retries'
op|'='
name|'max_retries'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
dedent|''
op|'@'
name|'db_api'
op|'.'
name|'api_context_manager'
op|'.'
name|'writer'
newline|'\n'
DECL|function|_flavor_extra_specs_del
name|'def'
name|'_flavor_extra_specs_del'
op|'('
name|'context'
op|','
name|'flavor_id'
op|','
name|'key'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'result'
op|'='
name|'context'
op|'.'
name|'session'
op|'.'
name|'query'
op|'('
name|'api_models'
op|'.'
name|'FlavorExtraSpecs'
op|')'
op|'.'
name|'filter_by'
op|'('
name|'flavor_id'
op|'='
name|'flavor_id'
op|')'
op|'.'
name|'filter_by'
op|'('
name|'key'
op|'='
name|'key'
op|')'
op|'.'
name|'delete'
op|'('
op|')'
newline|'\n'
name|'if'
name|'result'
op|'=='
number|'0'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'exception'
op|'.'
name|'FlavorExtraSpecsNotFound'
op|'('
nl|'\n'
name|'extra_specs_key'
op|'='
name|'key'
op|','
name|'flavor_id'
op|'='
name|'flavor_id'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'db_api'
op|'.'
name|'api_context_manager'
op|'.'
name|'writer'
newline|'\n'
DECL|function|_flavor_create
name|'def'
name|'_flavor_create'
op|'('
name|'context'
op|','
name|'values'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'specs'
op|'='
name|'values'
op|'.'
name|'get'
op|'('
string|"'extra_specs'"
op|')'
newline|'\n'
name|'db_specs'
op|'='
op|'['
op|']'
newline|'\n'
name|'if'
name|'specs'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'k'
op|','
name|'v'
name|'in'
name|'specs'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'db_spec'
op|'='
name|'api_models'
op|'.'
name|'FlavorExtraSpecs'
op|'('
op|')'
newline|'\n'
name|'db_spec'
op|'['
string|"'key'"
op|']'
op|'='
name|'k'
newline|'\n'
name|'db_spec'
op|'['
string|"'value'"
op|']'
op|'='
name|'v'
newline|'\n'
name|'db_specs'
op|'.'
name|'append'
op|'('
name|'db_spec'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'projects'
op|'='
name|'values'
op|'.'
name|'get'
op|'('
string|"'projects'"
op|')'
newline|'\n'
name|'db_projects'
op|'='
op|'['
op|']'
newline|'\n'
name|'if'
name|'projects'
op|':'
newline|'\n'
indent|'        '
name|'for'
name|'project'
name|'in'
name|'set'
op|'('
name|'projects'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'db_project'
op|'='
name|'api_models'
op|'.'
name|'FlavorProjects'
op|'('
op|')'
newline|'\n'
name|'db_project'
op|'['
string|"'project_id'"
op|']'
op|'='
name|'project'
newline|'\n'
name|'db_projects'
op|'.'
name|'append'
op|'('
name|'db_project'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'values'
op|'['
string|"'extra_specs'"
op|']'
op|'='
name|'db_specs'
newline|'\n'
name|'values'
op|'['
string|"'projects'"
op|']'
op|'='
name|'db_projects'
newline|'\n'
name|'db_flavor'
op|'='
name|'api_models'
op|'.'
name|'Flavors'
op|'('
op|')'
newline|'\n'
name|'db_flavor'
op|'.'
name|'update'
op|'('
name|'values'
op|')'
newline|'\n'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'db_flavor'
op|'.'
name|'save'
op|'('
name|'context'
op|'.'
name|'session'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'db_exc'
op|'.'
name|'DBDuplicateEntry'
name|'as'
name|'e'
op|':'
newline|'\n'
indent|'        '
name|'if'
string|"'flavorid'"
name|'in'
name|'e'
op|'.'
name|'columns'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'FlavorIdExists'
op|'('
name|'flavor_id'
op|'='
name|'values'
op|'['
string|"'flavorid'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'raise'
name|'exception'
op|'.'
name|'FlavorExists'
op|'('
name|'name'
op|'='
name|'values'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
name|'as'
name|'e'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'db_exc'
op|'.'
name|'DBError'
op|'('
name|'e'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
name|'_dict_with_extra_specs'
op|'('
name|'db_flavor'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
op|'@'
name|'db_api'
op|'.'
name|'api_context_manager'
op|'.'
name|'writer'
newline|'\n'
DECL|function|_flavor_destroy
name|'def'
name|'_flavor_destroy'
op|'('
name|'context'
op|','
name|'flavor_id'
op|'='
name|'None'
op|','
name|'name'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'query'
op|'='
name|'context'
op|'.'
name|'session'
op|'.'
name|'query'
op|'('
name|'api_models'
op|'.'
name|'Flavors'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'flavor_id'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'        '
name|'query'
op|'='
name|'query'
op|'.'
name|'filter'
op|'('
name|'api_models'
op|'.'
name|'Flavors'
op|'.'
name|'id'
op|'=='
name|'flavor_id'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'query'
op|'='
name|'query'
op|'.'
name|'filter'
op|'('
name|'api_models'
op|'.'
name|'Flavors'
op|'.'
name|'name'
op|'=='
name|'name'
op|')'
newline|'\n'
dedent|''
name|'result'
op|'='
name|'query'
op|'.'
name|'first'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'not'
name|'result'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'flavor_id'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'FlavorNotFound'
op|'('
name|'flavor_id'
op|'='
name|'flavor_id'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'FlavorNotFoundByName'
op|'('
name|'flavor_name'
op|'='
name|'name'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'context'
op|'.'
name|'session'
op|'.'
name|'query'
op|'('
name|'api_models'
op|'.'
name|'FlavorProjects'
op|')'
op|'.'
name|'filter_by'
op|'('
name|'flavor_id'
op|'='
name|'result'
op|'.'
name|'id'
op|')'
op|'.'
name|'delete'
op|'('
op|')'
newline|'\n'
name|'context'
op|'.'
name|'session'
op|'.'
name|'query'
op|'('
name|'api_models'
op|'.'
name|'FlavorExtraSpecs'
op|')'
op|'.'
name|'filter_by'
op|'('
name|'flavor_id'
op|'='
name|'result'
op|'.'
name|'id'
op|')'
op|'.'
name|'delete'
op|'('
op|')'
newline|'\n'
name|'context'
op|'.'
name|'session'
op|'.'
name|'delete'
op|'('
name|'result'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
op|'@'
name|'db_api'
op|'.'
name|'main_context_manager'
op|'.'
name|'reader'
newline|'\n'
DECL|function|_ensure_migrated
name|'def'
name|'_ensure_migrated'
op|'('
name|'context'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'result'
op|'='
name|'context'
op|'.'
name|'session'
op|'.'
name|'query'
op|'('
name|'main_models'
op|'.'
name|'InstanceTypes'
op|')'
op|'.'
name|'filter_by'
op|'('
name|'deleted'
op|'='
number|'0'
op|')'
op|'.'
name|'count'
op|'('
op|')'
newline|'\n'
name|'if'
name|'result'
op|':'
newline|'\n'
indent|'        '
name|'LOG'
op|'.'
name|'warning'
op|'('
name|'_LW'
op|'('
string|"'Main database contains %(count)i unmigrated flavors'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'count'"
op|':'
name|'result'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'result'
op|'=='
number|'0'
newline|'\n'
nl|'\n'
nl|'\n'
comment|'# TODO(berrange): Remove NovaObjectDictCompat'
nl|'\n'
dedent|''
op|'@'
name|'base'
op|'.'
name|'NovaObjectRegistry'
op|'.'
name|'register'
newline|'\n'
name|'class'
name|'Flavor'
op|'('
name|'base'
op|'.'
name|'NovaPersistentObject'
op|','
name|'base'
op|'.'
name|'NovaObject'
op|','
nl|'\n'
DECL|class|Flavor
name|'base'
op|'.'
name|'NovaObjectDictCompat'
op|')'
op|':'
newline|'\n'
comment|'# Version 1.0: Initial version'
nl|'\n'
comment|'# Version 1.1: Added save_projects(), save_extra_specs(), removed'
nl|'\n'
comment|'#              remoteable from save()'
nl|'\n'
DECL|variable|VERSION
indent|'    '
name|'VERSION'
op|'='
string|"'1.1'"
newline|'\n'
nl|'\n'
DECL|variable|fields
name|'fields'
op|'='
op|'{'
nl|'\n'
string|"'id'"
op|':'
name|'fields'
op|'.'
name|'IntegerField'
op|'('
op|')'
op|','
nl|'\n'
string|"'name'"
op|':'
name|'fields'
op|'.'
name|'StringField'
op|'('
name|'nullable'
op|'='
name|'True'
op|')'
op|','
nl|'\n'
string|"'memory_mb'"
op|':'
name|'fields'
op|'.'
name|'IntegerField'
op|'('
op|')'
op|','
nl|'\n'
string|"'vcpus'"
op|':'
name|'fields'
op|'.'
name|'IntegerField'
op|'('
op|')'
op|','
nl|'\n'
string|"'root_gb'"
op|':'
name|'fields'
op|'.'
name|'IntegerField'
op|'('
op|')'
op|','
nl|'\n'
string|"'ephemeral_gb'"
op|':'
name|'fields'
op|'.'
name|'IntegerField'
op|'('
op|')'
op|','
nl|'\n'
string|"'flavorid'"
op|':'
name|'fields'
op|'.'
name|'StringField'
op|'('
op|')'
op|','
nl|'\n'
string|"'swap'"
op|':'
name|'fields'
op|'.'
name|'IntegerField'
op|'('
op|')'
op|','
nl|'\n'
string|"'rxtx_factor'"
op|':'
name|'fields'
op|'.'
name|'FloatField'
op|'('
name|'nullable'
op|'='
name|'True'
op|','
name|'default'
op|'='
number|'1.0'
op|')'
op|','
nl|'\n'
string|"'vcpu_weight'"
op|':'
name|'fields'
op|'.'
name|'IntegerField'
op|'('
name|'nullable'
op|'='
name|'True'
op|')'
op|','
nl|'\n'
string|"'disabled'"
op|':'
name|'fields'
op|'.'
name|'BooleanField'
op|'('
op|')'
op|','
nl|'\n'
string|"'is_public'"
op|':'
name|'fields'
op|'.'
name|'BooleanField'
op|'('
op|')'
op|','
nl|'\n'
string|"'extra_specs'"
op|':'
name|'fields'
op|'.'
name|'DictOfStringsField'
op|'('
op|')'
op|','
nl|'\n'
string|"'projects'"
op|':'
name|'fields'
op|'.'
name|'ListOfStringsField'
op|'('
op|')'
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'Flavor'
op|','
name|'self'
op|')'
op|'.'
name|'__init__'
op|'('
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_orig_extra_specs'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'_orig_projects'
op|'='
op|'['
op|']'
newline|'\n'
name|'self'
op|'.'
name|'_in_api'
op|'='
name|'False'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|in_api
name|'def'
name|'in_api'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'_in_api'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'True'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'if'
string|"'id'"
name|'in'
name|'self'
op|':'
newline|'\n'
indent|'                    '
name|'self'
op|'.'
name|'_flavor_get_from_db'
op|'('
name|'self'
op|'.'
name|'_context'
op|','
name|'self'
op|'.'
name|'id'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'flavor'
op|'='
name|'self'
op|'.'
name|'_flavor_get_by_flavor_id_from_db'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'flavorid'
op|')'
newline|'\n'
comment|'# Fix us up so we can use our real id'
nl|'\n'
name|'self'
op|'.'
name|'id'
op|'='
name|'flavor'
op|'['
string|"'id'"
op|']'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_in_api'
op|'='
name|'True'
newline|'\n'
dedent|''
name|'except'
name|'exception'
op|'.'
name|'FlavorNotFound'
op|':'
newline|'\n'
indent|'                '
name|'pass'
newline|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'_in_api'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'staticmethod'
newline|'\n'
DECL|member|_from_db_object
name|'def'
name|'_from_db_object'
op|'('
name|'context'
op|','
name|'flavor'
op|','
name|'db_flavor'
op|','
name|'expected_attrs'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'expected_attrs'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'expected_attrs'
op|'='
op|'['
op|']'
newline|'\n'
dedent|''
name|'flavor'
op|'.'
name|'_context'
op|'='
name|'context'
newline|'\n'
name|'for'
name|'name'
op|','
name|'field'
name|'in'
name|'flavor'
op|'.'
name|'fields'
op|'.'
name|'items'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'name'
name|'in'
name|'OPTIONAL_FIELDS'
op|':'
newline|'\n'
indent|'                '
name|'continue'
newline|'\n'
dedent|''
name|'if'
name|'name'
name|'in'
name|'DEPRECATED_FIELDS'
name|'and'
name|'name'
name|'not'
name|'in'
name|'db_flavor'
op|':'
newline|'\n'
indent|'                '
name|'continue'
newline|'\n'
dedent|''
name|'value'
op|'='
name|'db_flavor'
op|'['
name|'name'
op|']'
newline|'\n'
name|'if'
name|'isinstance'
op|'('
name|'field'
op|','
name|'fields'
op|'.'
name|'IntegerField'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'value'
op|'='
name|'value'
name|'if'
name|'value'
name|'is'
name|'not'
name|'None'
name|'else'
number|'0'
newline|'\n'
dedent|''
name|'flavor'
op|'['
name|'name'
op|']'
op|'='
name|'value'
newline|'\n'
nl|'\n'
comment|'# NOTE(danms): This is to support processing the API flavor'
nl|'\n'
comment|'# model, which does not have these deprecated fields. When we'
nl|'\n'
comment|'# remove compatibility with the old InstanceType model, we can'
nl|'\n'
comment|'# remove this as well.'
nl|'\n'
dedent|''
name|'if'
name|'any'
op|'('
name|'f'
name|'not'
name|'in'
name|'db_flavor'
name|'for'
name|'f'
name|'in'
name|'DEPRECATED_FIELDS'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'flavor'
op|'.'
name|'deleted_at'
op|'='
name|'None'
newline|'\n'
name|'flavor'
op|'.'
name|'deleted'
op|'='
name|'False'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
string|"'extra_specs'"
name|'in'
name|'expected_attrs'
op|':'
newline|'\n'
indent|'            '
name|'flavor'
op|'.'
name|'extra_specs'
op|'='
name|'db_flavor'
op|'['
string|"'extra_specs'"
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
string|"'projects'"
name|'in'
name|'expected_attrs'
op|':'
newline|'\n'
indent|'            '
name|'if'
string|"'projects'"
name|'in'
name|'db_flavor'
op|':'
newline|'\n'
indent|'                '
name|'flavor'
op|'['
string|"'projects'"
op|']'
op|'='
op|'['
name|'x'
op|'['
string|"'project_id'"
op|']'
nl|'\n'
name|'for'
name|'x'
name|'in'
name|'db_flavor'
op|'['
string|"'projects'"
op|']'
op|']'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'flavor'
op|'.'
name|'_load_projects'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'flavor'
op|'.'
name|'obj_reset_changes'
op|'('
op|')'
newline|'\n'
name|'return'
name|'flavor'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'staticmethod'
newline|'\n'
op|'@'
name|'db_api'
op|'.'
name|'api_context_manager'
op|'.'
name|'reader'
newline|'\n'
DECL|member|_flavor_get_query_from_db
name|'def'
name|'_flavor_get_query_from_db'
op|'('
name|'context'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'query'
op|'='
name|'context'
op|'.'
name|'session'
op|'.'
name|'query'
op|'('
name|'api_models'
op|'.'
name|'Flavors'
op|')'
op|'.'
name|'options'
op|'('
name|'joinedload'
op|'('
string|"'extra_specs'"
op|')'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'context'
op|'.'
name|'is_admin'
op|':'
newline|'\n'
indent|'            '
name|'the_filter'
op|'='
op|'['
name|'api_models'
op|'.'
name|'Flavors'
op|'.'
name|'is_public'
op|'=='
name|'true'
op|'('
op|')'
op|']'
newline|'\n'
name|'the_filter'
op|'.'
name|'extend'
op|'('
op|'['
nl|'\n'
name|'api_models'
op|'.'
name|'Flavors'
op|'.'
name|'projects'
op|'.'
name|'any'
op|'('
name|'project_id'
op|'='
name|'context'
op|'.'
name|'project_id'
op|')'
nl|'\n'
op|']'
op|')'
newline|'\n'
name|'query'
op|'='
name|'query'
op|'.'
name|'filter'
op|'('
name|'or_'
op|'('
op|'*'
name|'the_filter'
op|')'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'query'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'staticmethod'
newline|'\n'
op|'@'
name|'require_context'
newline|'\n'
DECL|member|_flavor_get_from_db
name|'def'
name|'_flavor_get_from_db'
op|'('
name|'context'
op|','
name|'id'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Returns a dict describing specific flavor."""'
newline|'\n'
name|'result'
op|'='
name|'Flavor'
op|'.'
name|'_flavor_get_query_from_db'
op|'('
name|'context'
op|')'
op|'.'
name|'filter_by'
op|'('
name|'id'
op|'='
name|'id'
op|')'
op|'.'
name|'first'
op|'('
op|')'
newline|'\n'
name|'if'
name|'not'
name|'result'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'FlavorNotFound'
op|'('
name|'flavor_id'
op|'='
name|'id'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'db_api'
op|'.'
name|'_dict_with_extra_specs'
op|'('
name|'result'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'staticmethod'
newline|'\n'
op|'@'
name|'require_context'
newline|'\n'
DECL|member|_flavor_get_by_name_from_db
name|'def'
name|'_flavor_get_by_name_from_db'
op|'('
name|'context'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Returns a dict describing specific flavor."""'
newline|'\n'
name|'result'
op|'='
name|'Flavor'
op|'.'
name|'_flavor_get_query_from_db'
op|'('
name|'context'
op|')'
op|'.'
name|'filter_by'
op|'('
name|'name'
op|'='
name|'name'
op|')'
op|'.'
name|'first'
op|'('
op|')'
newline|'\n'
name|'if'
name|'not'
name|'result'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'FlavorNotFoundByName'
op|'('
name|'flavor_name'
op|'='
name|'name'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'db_api'
op|'.'
name|'_dict_with_extra_specs'
op|'('
name|'result'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'staticmethod'
newline|'\n'
op|'@'
name|'require_context'
newline|'\n'
DECL|member|_flavor_get_by_flavor_id_from_db
name|'def'
name|'_flavor_get_by_flavor_id_from_db'
op|'('
name|'context'
op|','
name|'flavor_id'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Returns a dict describing specific flavor_id."""'
newline|'\n'
name|'result'
op|'='
name|'Flavor'
op|'.'
name|'_flavor_get_query_from_db'
op|'('
name|'context'
op|')'
op|'.'
name|'filter_by'
op|'('
name|'flavorid'
op|'='
name|'flavor_id'
op|')'
op|'.'
name|'order_by'
op|'('
name|'asc'
op|'('
name|'api_models'
op|'.'
name|'Flavors'
op|'.'
name|'id'
op|')'
op|')'
op|'.'
name|'first'
op|'('
op|')'
newline|'\n'
name|'if'
name|'not'
name|'result'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'FlavorNotFound'
op|'('
name|'flavor_id'
op|'='
name|'flavor_id'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'db_api'
op|'.'
name|'_dict_with_extra_specs'
op|'('
name|'result'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'staticmethod'
newline|'\n'
DECL|member|_get_projects_from_db
name|'def'
name|'_get_projects_from_db'
op|'('
name|'context'
op|','
name|'flavorid'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'_get_projects_from_db'
op|'('
name|'context'
op|','
name|'flavorid'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'base'
op|'.'
name|'remotable'
newline|'\n'
DECL|member|_load_projects
name|'def'
name|'_load_projects'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'projects'
op|'='
name|'self'
op|'.'
name|'_get_projects_from_db'
op|'('
name|'self'
op|'.'
name|'_context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'flavorid'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'exception'
op|'.'
name|'FlavorNotFound'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'projects'
op|'='
op|'['
name|'x'
op|'['
string|"'project_id'"
op|']'
name|'for'
name|'x'
name|'in'
nl|'\n'
name|'db'
op|'.'
name|'flavor_access_get_by_flavor_id'
op|'('
name|'self'
op|'.'
name|'_context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'flavorid'
op|')'
op|']'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'obj_reset_changes'
op|'('
op|'['
string|"'projects'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|obj_load_attr
dedent|''
name|'def'
name|'obj_load_attr'
op|'('
name|'self'
op|','
name|'attrname'
op|')'
op|':'
newline|'\n'
comment|'# NOTE(danms): Only projects could be lazy-loaded right now'
nl|'\n'
indent|'        '
name|'if'
name|'attrname'
op|'!='
string|"'projects'"
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'ObjectActionError'
op|'('
nl|'\n'
name|'action'
op|'='
string|"'obj_load_attr'"
op|','
name|'reason'
op|'='
string|"'unable to load %s'"
op|'%'
name|'attrname'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'_load_projects'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|obj_reset_changes
dedent|''
name|'def'
name|'obj_reset_changes'
op|'('
name|'self'
op|','
name|'fields'
op|'='
name|'None'
op|','
name|'recursive'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'Flavor'
op|','
name|'self'
op|')'
op|'.'
name|'obj_reset_changes'
op|'('
name|'fields'
op|'='
name|'fields'
op|','
nl|'\n'
name|'recursive'
op|'='
name|'recursive'
op|')'
newline|'\n'
name|'if'
name|'fields'
name|'is'
name|'None'
name|'or'
string|"'extra_specs'"
name|'in'
name|'fields'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_orig_extra_specs'
op|'='
op|'('
name|'dict'
op|'('
name|'self'
op|'.'
name|'extra_specs'
op|')'
nl|'\n'
name|'if'
name|'self'
op|'.'
name|'obj_attr_is_set'
op|'('
string|"'extra_specs'"
op|')'
nl|'\n'
name|'else'
op|'{'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'fields'
name|'is'
name|'None'
name|'or'
string|"'projects'"
name|'in'
name|'fields'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_orig_projects'
op|'='
op|'('
name|'list'
op|'('
name|'self'
op|'.'
name|'projects'
op|')'
nl|'\n'
name|'if'
name|'self'
op|'.'
name|'obj_attr_is_set'
op|'('
string|"'projects'"
op|')'
nl|'\n'
name|'else'
op|'['
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|obj_what_changed
dedent|''
dedent|''
name|'def'
name|'obj_what_changed'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'changes'
op|'='
name|'super'
op|'('
name|'Flavor'
op|','
name|'self'
op|')'
op|'.'
name|'obj_what_changed'
op|'('
op|')'
newline|'\n'
name|'if'
op|'('
string|"'extra_specs'"
name|'in'
name|'self'
name|'and'
nl|'\n'
name|'self'
op|'.'
name|'extra_specs'
op|'!='
name|'self'
op|'.'
name|'_orig_extra_specs'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'changes'
op|'.'
name|'add'
op|'('
string|"'extra_specs'"
op|')'
newline|'\n'
dedent|''
name|'if'
string|"'projects'"
name|'in'
name|'self'
name|'and'
name|'self'
op|'.'
name|'projects'
op|'!='
name|'self'
op|'.'
name|'_orig_projects'
op|':'
newline|'\n'
indent|'            '
name|'changes'
op|'.'
name|'add'
op|'('
string|"'projects'"
op|')'
newline|'\n'
dedent|''
name|'return'
name|'changes'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'classmethod'
newline|'\n'
DECL|member|_obj_from_primitive
name|'def'
name|'_obj_from_primitive'
op|'('
name|'cls'
op|','
name|'context'
op|','
name|'objver'
op|','
name|'primitive'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'='
name|'super'
op|'('
name|'Flavor'
op|','
name|'cls'
op|')'
op|'.'
name|'_obj_from_primitive'
op|'('
name|'context'
op|','
name|'objver'
op|','
nl|'\n'
name|'primitive'
op|')'
newline|'\n'
name|'changes'
op|'='
name|'self'
op|'.'
name|'obj_what_changed'
op|'('
op|')'
newline|'\n'
name|'if'
string|"'extra_specs'"
name|'not'
name|'in'
name|'changes'
op|':'
newline|'\n'
comment|'# This call left extra_specs "clean" so update our tracker'
nl|'\n'
indent|'            '
name|'self'
op|'.'
name|'_orig_extra_specs'
op|'='
op|'('
name|'dict'
op|'('
name|'self'
op|'.'
name|'extra_specs'
op|')'
nl|'\n'
name|'if'
name|'self'
op|'.'
name|'obj_attr_is_set'
op|'('
string|"'extra_specs'"
op|')'
nl|'\n'
name|'else'
op|'{'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'if'
string|"'projects'"
name|'not'
name|'in'
name|'changes'
op|':'
newline|'\n'
comment|'# This call left projects "clean" so update our tracker'
nl|'\n'
indent|'            '
name|'self'
op|'.'
name|'_orig_projects'
op|'='
op|'('
name|'list'
op|'('
name|'self'
op|'.'
name|'projects'
op|')'
nl|'\n'
name|'if'
name|'self'
op|'.'
name|'obj_attr_is_set'
op|'('
string|"'projects'"
op|')'
nl|'\n'
name|'else'
op|'['
op|']'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'self'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'base'
op|'.'
name|'remotable_classmethod'
newline|'\n'
DECL|member|get_by_id
name|'def'
name|'get_by_id'
op|'('
name|'cls'
op|','
name|'context'
op|','
name|'id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'db_flavor'
op|'='
name|'cls'
op|'.'
name|'_flavor_get_from_db'
op|'('
name|'context'
op|','
name|'id'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'exception'
op|'.'
name|'FlavorNotFound'
op|':'
newline|'\n'
indent|'            '
name|'db_flavor'
op|'='
name|'db'
op|'.'
name|'flavor_get'
op|'('
name|'context'
op|','
name|'id'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'cls'
op|'.'
name|'_from_db_object'
op|'('
name|'context'
op|','
name|'cls'
op|'('
name|'context'
op|')'
op|','
name|'db_flavor'
op|','
nl|'\n'
name|'expected_attrs'
op|'='
op|'['
string|"'extra_specs'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'base'
op|'.'
name|'remotable_classmethod'
newline|'\n'
DECL|member|get_by_name
name|'def'
name|'get_by_name'
op|'('
name|'cls'
op|','
name|'context'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'db_flavor'
op|'='
name|'cls'
op|'.'
name|'_flavor_get_by_name_from_db'
op|'('
name|'context'
op|','
name|'name'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'exception'
op|'.'
name|'FlavorNotFoundByName'
op|':'
newline|'\n'
indent|'            '
name|'db_flavor'
op|'='
name|'db'
op|'.'
name|'flavor_get_by_name'
op|'('
name|'context'
op|','
name|'name'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'cls'
op|'.'
name|'_from_db_object'
op|'('
name|'context'
op|','
name|'cls'
op|'('
name|'context'
op|')'
op|','
name|'db_flavor'
op|','
nl|'\n'
name|'expected_attrs'
op|'='
op|'['
string|"'extra_specs'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'base'
op|'.'
name|'remotable_classmethod'
newline|'\n'
DECL|member|get_by_flavor_id
name|'def'
name|'get_by_flavor_id'
op|'('
name|'cls'
op|','
name|'context'
op|','
name|'flavor_id'
op|','
name|'read_deleted'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'db_flavor'
op|'='
name|'cls'
op|'.'
name|'_flavor_get_by_flavor_id_from_db'
op|'('
name|'context'
op|','
nl|'\n'
name|'flavor_id'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'exception'
op|'.'
name|'FlavorNotFound'
op|':'
newline|'\n'
indent|'            '
name|'db_flavor'
op|'='
name|'db'
op|'.'
name|'flavor_get_by_flavor_id'
op|'('
name|'context'
op|','
name|'flavor_id'
op|','
nl|'\n'
name|'read_deleted'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'cls'
op|'.'
name|'_from_db_object'
op|'('
name|'context'
op|','
name|'cls'
op|'('
name|'context'
op|')'
op|','
name|'db_flavor'
op|','
nl|'\n'
name|'expected_attrs'
op|'='
op|'['
string|"'extra_specs'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'staticmethod'
newline|'\n'
DECL|member|_flavor_add_project
name|'def'
name|'_flavor_add_project'
op|'('
name|'context'
op|','
name|'flavor_id'
op|','
name|'project_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'_flavor_add_project'
op|'('
name|'context'
op|','
name|'flavor_id'
op|','
name|'project_id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'staticmethod'
newline|'\n'
DECL|member|_flavor_del_project
name|'def'
name|'_flavor_del_project'
op|'('
name|'context'
op|','
name|'flavor_id'
op|','
name|'project_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'_flavor_del_project'
op|'('
name|'context'
op|','
name|'flavor_id'
op|','
name|'project_id'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_add_access
dedent|''
name|'def'
name|'_add_access'
op|'('
name|'self'
op|','
name|'project_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'in_api'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_flavor_add_project'
op|'('
name|'self'
op|'.'
name|'_context'
op|','
name|'self'
op|'.'
name|'id'
op|','
name|'project_id'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'flavor_access_add'
op|'('
name|'self'
op|'.'
name|'_context'
op|','
name|'self'
op|'.'
name|'flavorid'
op|','
name|'project_id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'base'
op|'.'
name|'remotable'
newline|'\n'
DECL|member|add_access
name|'def'
name|'add_access'
op|'('
name|'self'
op|','
name|'project_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
string|"'projects'"
name|'in'
name|'self'
op|'.'
name|'obj_what_changed'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'ObjectActionError'
op|'('
name|'action'
op|'='
string|"'add_access'"
op|','
nl|'\n'
name|'reason'
op|'='
string|"'projects modified'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_add_access'
op|'('
name|'project_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_load_projects'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|_remove_access
dedent|''
name|'def'
name|'_remove_access'
op|'('
name|'self'
op|','
name|'project_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'in_api'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_flavor_del_project'
op|'('
name|'self'
op|'.'
name|'_context'
op|','
name|'self'
op|'.'
name|'id'
op|','
name|'project_id'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'flavor_access_remove'
op|'('
name|'self'
op|'.'
name|'_context'
op|','
name|'self'
op|'.'
name|'flavorid'
op|','
name|'project_id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'base'
op|'.'
name|'remotable'
newline|'\n'
DECL|member|remove_access
name|'def'
name|'remove_access'
op|'('
name|'self'
op|','
name|'project_id'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
string|"'projects'"
name|'in'
name|'self'
op|'.'
name|'obj_what_changed'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'ObjectActionError'
op|'('
name|'action'
op|'='
string|"'remove_access'"
op|','
nl|'\n'
name|'reason'
op|'='
string|"'projects modified'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_remove_access'
op|'('
name|'project_id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_load_projects'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'staticmethod'
newline|'\n'
DECL|member|_flavor_create
name|'def'
name|'_flavor_create'
op|'('
name|'context'
op|','
name|'updates'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'_flavor_create'
op|'('
name|'context'
op|','
name|'updates'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'staticmethod'
newline|'\n'
DECL|member|_ensure_migrated
name|'def'
name|'_ensure_migrated'
op|'('
name|'context'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'_ensure_migrated'
op|'('
name|'context'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'base'
op|'.'
name|'remotable'
newline|'\n'
DECL|member|create
name|'def'
name|'create'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'obj_attr_is_set'
op|'('
string|"'id'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'ObjectActionError'
op|'('
name|'action'
op|'='
string|"'create'"
op|','
nl|'\n'
name|'reason'
op|'='
string|"'already created'"
op|')'
newline|'\n'
nl|'\n'
comment|'# NOTE(danms): Once we have made it past a point where we know'
nl|'\n'
comment|'# all flavors have been migrated, we can remove this. Ideally'
nl|'\n'
comment|'# in Ocata with a blocker migration to be sure.'
nl|'\n'
dedent|''
name|'if'
name|'not'
name|'self'
op|'.'
name|'_ensure_migrated'
op|'('
name|'self'
op|'.'
name|'_context'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'ObjectActionError'
op|'('
nl|'\n'
name|'action'
op|'='
string|"'create'"
op|','
nl|'\n'
name|'reason'
op|'='
string|"'main database still contains flavors'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'updates'
op|'='
name|'self'
op|'.'
name|'obj_get_changes'
op|'('
op|')'
newline|'\n'
name|'expected_attrs'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'attr'
name|'in'
name|'OPTIONAL_FIELDS'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'attr'
name|'in'
name|'updates'
op|':'
newline|'\n'
indent|'                '
name|'expected_attrs'
op|'.'
name|'append'
op|'('
name|'attr'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'db_flavor'
op|'='
name|'self'
op|'.'
name|'_flavor_create'
op|'('
name|'self'
op|'.'
name|'_context'
op|','
name|'updates'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_from_db_object'
op|'('
name|'self'
op|'.'
name|'_context'
op|','
name|'self'
op|','
name|'db_flavor'
op|','
nl|'\n'
name|'expected_attrs'
op|'='
name|'expected_attrs'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'base'
op|'.'
name|'remotable'
newline|'\n'
DECL|member|save_projects
name|'def'
name|'save_projects'
op|'('
name|'self'
op|','
name|'to_add'
op|'='
name|'None'
op|','
name|'to_delete'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Add or delete projects.\n\n        :param:to_add: A list of projects to add\n        :param:to_delete: A list of projects to remove\n        """'
newline|'\n'
nl|'\n'
name|'to_add'
op|'='
name|'to_add'
name|'if'
name|'to_add'
name|'is'
name|'not'
name|'None'
name|'else'
op|'['
op|']'
newline|'\n'
name|'to_delete'
op|'='
name|'to_delete'
name|'if'
name|'to_delete'
name|'is'
name|'not'
name|'None'
name|'else'
op|'['
op|']'
newline|'\n'
nl|'\n'
name|'for'
name|'project_id'
name|'in'
name|'to_add'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_add_access'
op|'('
name|'project_id'
op|')'
newline|'\n'
dedent|''
name|'for'
name|'project_id'
name|'in'
name|'to_delete'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_remove_access'
op|'('
name|'project_id'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'obj_reset_changes'
op|'('
op|'['
string|"'projects'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'staticmethod'
newline|'\n'
DECL|member|_flavor_extra_specs_add
name|'def'
name|'_flavor_extra_specs_add'
op|'('
name|'context'
op|','
name|'flavor_id'
op|','
name|'specs'
op|','
name|'max_retries'
op|'='
number|'10'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'_flavor_extra_specs_add'
op|'('
name|'context'
op|','
name|'flavor_id'
op|','
name|'specs'
op|','
name|'max_retries'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'staticmethod'
newline|'\n'
DECL|member|_flavor_extra_specs_del
name|'def'
name|'_flavor_extra_specs_del'
op|'('
name|'context'
op|','
name|'flavor_id'
op|','
name|'key'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'_flavor_extra_specs_del'
op|'('
name|'context'
op|','
name|'flavor_id'
op|','
name|'key'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'base'
op|'.'
name|'remotable'
newline|'\n'
DECL|member|save_extra_specs
name|'def'
name|'save_extra_specs'
op|'('
name|'self'
op|','
name|'to_add'
op|'='
name|'None'
op|','
name|'to_delete'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Add or delete extra_specs.\n\n        :param:to_add: A dict of new keys to add/update\n        :param:to_delete: A list of keys to remove\n        """'
newline|'\n'
nl|'\n'
name|'if'
name|'self'
op|'.'
name|'in_api'
op|':'
newline|'\n'
indent|'            '
name|'add_fn'
op|'='
name|'self'
op|'.'
name|'_flavor_extra_specs_add'
newline|'\n'
name|'del_fn'
op|'='
name|'self'
op|'.'
name|'_flavor_extra_specs_del'
newline|'\n'
name|'ident'
op|'='
name|'self'
op|'.'
name|'id'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'add_fn'
op|'='
name|'db'
op|'.'
name|'flavor_extra_specs_update_or_create'
newline|'\n'
name|'del_fn'
op|'='
name|'db'
op|'.'
name|'flavor_extra_specs_delete'
newline|'\n'
name|'ident'
op|'='
name|'self'
op|'.'
name|'flavorid'
newline|'\n'
nl|'\n'
dedent|''
name|'to_add'
op|'='
name|'to_add'
name|'if'
name|'to_add'
name|'is'
name|'not'
name|'None'
name|'else'
op|'{'
op|'}'
newline|'\n'
name|'to_delete'
op|'='
name|'to_delete'
name|'if'
name|'to_delete'
name|'is'
name|'not'
name|'None'
name|'else'
op|'['
op|']'
newline|'\n'
nl|'\n'
name|'if'
name|'to_add'
op|':'
newline|'\n'
indent|'            '
name|'add_fn'
op|'('
name|'self'
op|'.'
name|'_context'
op|','
name|'ident'
op|','
name|'to_add'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'for'
name|'key'
name|'in'
name|'to_delete'
op|':'
newline|'\n'
indent|'            '
name|'del_fn'
op|'('
name|'self'
op|'.'
name|'_context'
op|','
name|'ident'
op|','
name|'key'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'obj_reset_changes'
op|'('
op|'['
string|"'extra_specs'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|member|save
dedent|''
name|'def'
name|'save'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'updates'
op|'='
name|'self'
op|'.'
name|'obj_get_changes'
op|'('
op|')'
newline|'\n'
name|'projects'
op|'='
name|'updates'
op|'.'
name|'pop'
op|'('
string|"'projects'"
op|','
name|'None'
op|')'
newline|'\n'
name|'extra_specs'
op|'='
name|'updates'
op|'.'
name|'pop'
op|'('
string|"'extra_specs'"
op|','
name|'None'
op|')'
newline|'\n'
name|'if'
name|'updates'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'ObjectActionError'
op|'('
nl|'\n'
name|'action'
op|'='
string|"'save'"
op|','
name|'reason'
op|'='
string|"'read-only fields were changed'"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'extra_specs'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'deleted_keys'
op|'='
op|'('
name|'set'
op|'('
name|'self'
op|'.'
name|'_orig_extra_specs'
op|'.'
name|'keys'
op|'('
op|')'
op|')'
op|'-'
nl|'\n'
name|'set'
op|'('
name|'extra_specs'
op|'.'
name|'keys'
op|'('
op|')'
op|')'
op|')'
newline|'\n'
name|'added_keys'
op|'='
name|'self'
op|'.'
name|'extra_specs'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'added_keys'
op|'='
name|'deleted_keys'
op|'='
name|'None'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'projects'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'deleted_projects'
op|'='
name|'set'
op|'('
name|'self'
op|'.'
name|'_orig_projects'
op|')'
op|'-'
name|'set'
op|'('
name|'projects'
op|')'
newline|'\n'
name|'added_projects'
op|'='
name|'set'
op|'('
name|'projects'
op|')'
op|'-'
name|'set'
op|'('
name|'self'
op|'.'
name|'_orig_projects'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'added_projects'
op|'='
name|'deleted_projects'
op|'='
name|'None'
newline|'\n'
nl|'\n'
comment|'# NOTE(danms): The first remotable method we call will reset'
nl|'\n'
comment|'# our of the original values for projects and extra_specs. Thus,'
nl|'\n'
comment|'# we collect the added/deleted lists for both above and /then/'
nl|'\n'
comment|'# call these methods to update them.'
nl|'\n'
nl|'\n'
dedent|''
name|'if'
name|'added_keys'
name|'or'
name|'deleted_keys'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'save_extra_specs'
op|'('
name|'self'
op|'.'
name|'extra_specs'
op|','
name|'deleted_keys'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'added_projects'
name|'or'
name|'deleted_projects'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'save_projects'
op|'('
name|'added_projects'
op|','
name|'deleted_projects'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'staticmethod'
newline|'\n'
DECL|member|_flavor_destroy
name|'def'
name|'_flavor_destroy'
op|'('
name|'context'
op|','
name|'flavor_id'
op|'='
name|'None'
op|','
name|'name'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'_flavor_destroy'
op|'('
name|'context'
op|','
name|'flavor_id'
op|'='
name|'flavor_id'
op|','
name|'name'
op|'='
name|'name'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'base'
op|'.'
name|'remotable'
newline|'\n'
DECL|member|destroy
name|'def'
name|'destroy'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# NOTE(danms): Historically the only way to delete a flavor'
nl|'\n'
comment|'# is via name, which is not very precise. We need to be able to'
nl|'\n'
comment|'# support the light construction of a flavor object and subsequent'
nl|'\n'
comment|'# delete request with only our name filled out. However, if we have'
nl|'\n'
comment|"# our id property, we should instead delete with that since it's"
nl|'\n'
comment|'# far more specific.'
nl|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'if'
string|"'id'"
name|'in'
name|'self'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'_flavor_destroy'
op|'('
name|'self'
op|'.'
name|'_context'
op|','
name|'flavor_id'
op|'='
name|'self'
op|'.'
name|'id'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'_flavor_destroy'
op|'('
name|'self'
op|'.'
name|'_context'
op|','
name|'name'
op|'='
name|'self'
op|'.'
name|'name'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'exception'
op|'.'
name|'FlavorNotFound'
op|':'
newline|'\n'
indent|'            '
name|'db'
op|'.'
name|'flavor_destroy'
op|'('
name|'self'
op|'.'
name|'_context'
op|','
name|'self'
op|'.'
name|'name'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
op|'@'
name|'db_api'
op|'.'
name|'api_context_manager'
op|'.'
name|'reader'
newline|'\n'
DECL|function|_flavor_get_all_from_db
name|'def'
name|'_flavor_get_all_from_db'
op|'('
name|'context'
op|','
name|'inactive'
op|','
name|'filters'
op|','
name|'sort_key'
op|','
name|'sort_dir'
op|','
nl|'\n'
name|'limit'
op|','
name|'marker'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Returns all flavors.\n    """'
newline|'\n'
name|'filters'
op|'='
name|'filters'
name|'or'
op|'{'
op|'}'
newline|'\n'
nl|'\n'
name|'query'
op|'='
name|'Flavor'
op|'.'
name|'_flavor_get_query_from_db'
op|'('
name|'context'
op|')'
newline|'\n'
nl|'\n'
name|'if'
string|"'min_memory_mb'"
name|'in'
name|'filters'
op|':'
newline|'\n'
indent|'        '
name|'query'
op|'='
name|'query'
op|'.'
name|'filter'
op|'('
nl|'\n'
name|'api_models'
op|'.'
name|'Flavors'
op|'.'
name|'memory_mb'
op|'>='
name|'filters'
op|'['
string|"'min_memory_mb'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
string|"'min_root_gb'"
name|'in'
name|'filters'
op|':'
newline|'\n'
indent|'        '
name|'query'
op|'='
name|'query'
op|'.'
name|'filter'
op|'('
nl|'\n'
name|'api_models'
op|'.'
name|'Flavors'
op|'.'
name|'root_gb'
op|'>='
name|'filters'
op|'['
string|"'min_root_gb'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
string|"'disabled'"
name|'in'
name|'filters'
op|':'
newline|'\n'
indent|'        '
name|'query'
op|'='
name|'query'
op|'.'
name|'filter'
op|'('
nl|'\n'
name|'api_models'
op|'.'
name|'Flavors'
op|'.'
name|'disabled'
op|'=='
name|'filters'
op|'['
string|"'disabled'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
string|"'is_public'"
name|'in'
name|'filters'
name|'and'
name|'filters'
op|'['
string|"'is_public'"
op|']'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'        '
name|'the_filter'
op|'='
op|'['
name|'api_models'
op|'.'
name|'Flavors'
op|'.'
name|'is_public'
op|'=='
name|'filters'
op|'['
string|"'is_public'"
op|']'
op|']'
newline|'\n'
name|'if'
name|'filters'
op|'['
string|"'is_public'"
op|']'
name|'and'
name|'context'
op|'.'
name|'project_id'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'the_filter'
op|'.'
name|'extend'
op|'('
op|'['
name|'api_models'
op|'.'
name|'Flavors'
op|'.'
name|'projects'
op|'.'
name|'any'
op|'('
nl|'\n'
name|'project_id'
op|'='
name|'context'
op|'.'
name|'project_id'
op|')'
op|']'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'the_filter'
op|')'
op|'>'
number|'1'
op|':'
newline|'\n'
indent|'            '
name|'query'
op|'='
name|'query'
op|'.'
name|'filter'
op|'('
name|'or_'
op|'('
op|'*'
name|'the_filter'
op|')'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'query'
op|'='
name|'query'
op|'.'
name|'filter'
op|'('
name|'the_filter'
op|'['
number|'0'
op|']'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'marker_row'
op|'='
name|'None'
newline|'\n'
name|'if'
name|'marker'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'        '
name|'marker_row'
op|'='
name|'Flavor'
op|'.'
name|'_flavor_get_query_from_db'
op|'('
name|'context'
op|')'
op|'.'
name|'filter_by'
op|'('
name|'flavorid'
op|'='
name|'marker'
op|')'
op|'.'
name|'first'
op|'('
op|')'
newline|'\n'
name|'if'
name|'not'
name|'marker_row'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'MarkerNotFound'
op|'('
name|'marker'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'query'
op|'='
name|'sqlalchemyutils'
op|'.'
name|'paginate_query'
op|'('
name|'query'
op|','
name|'api_models'
op|'.'
name|'Flavors'
op|','
nl|'\n'
name|'limit'
op|','
nl|'\n'
op|'['
name|'sort_key'
op|','
string|"'id'"
op|']'
op|','
nl|'\n'
name|'marker'
op|'='
name|'marker_row'
op|','
nl|'\n'
name|'sort_dir'
op|'='
name|'sort_dir'
op|')'
newline|'\n'
name|'return'
op|'['
name|'_dict_with_extra_specs'
op|'('
name|'i'
op|')'
name|'for'
name|'i'
name|'in'
name|'query'
op|'.'
name|'all'
op|'('
op|')'
op|']'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
op|'@'
name|'base'
op|'.'
name|'NovaObjectRegistry'
op|'.'
name|'register'
newline|'\n'
DECL|class|FlavorList
name|'class'
name|'FlavorList'
op|'('
name|'base'
op|'.'
name|'ObjectListBase'
op|','
name|'base'
op|'.'
name|'NovaObject'
op|')'
op|':'
newline|'\n'
DECL|variable|VERSION
indent|'    '
name|'VERSION'
op|'='
string|"'1.1'"
newline|'\n'
nl|'\n'
DECL|variable|fields
name|'fields'
op|'='
op|'{'
nl|'\n'
string|"'objects'"
op|':'
name|'fields'
op|'.'
name|'ListOfObjectsField'
op|'('
string|"'Flavor'"
op|')'
op|','
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
op|'@'
name|'base'
op|'.'
name|'remotable_classmethod'
newline|'\n'
DECL|member|get_all
name|'def'
name|'get_all'
op|'('
name|'cls'
op|','
name|'context'
op|','
name|'inactive'
op|'='
name|'False'
op|','
name|'filters'
op|'='
name|'None'
op|','
nl|'\n'
name|'sort_key'
op|'='
string|"'flavorid'"
op|','
name|'sort_dir'
op|'='
string|"'asc'"
op|','
name|'limit'
op|'='
name|'None'
op|','
name|'marker'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'api_db_flavors'
op|'='
name|'_flavor_get_all_from_db'
op|'('
name|'context'
op|','
nl|'\n'
name|'inactive'
op|'='
name|'inactive'
op|','
nl|'\n'
name|'filters'
op|'='
name|'filters'
op|','
nl|'\n'
name|'sort_key'
op|'='
name|'sort_key'
op|','
nl|'\n'
name|'sort_dir'
op|'='
name|'sort_dir'
op|','
nl|'\n'
name|'limit'
op|'='
name|'limit'
op|','
nl|'\n'
name|'marker'
op|'='
name|'marker'
op|')'
newline|'\n'
comment|'# NOTE(danms): If we were asked for a marker and found it in'
nl|'\n'
comment|'# results from the API DB, we must continue our pagination with'
nl|'\n'
comment|'# just the limit (if any) to the main DB.'
nl|'\n'
name|'marker'
op|'='
name|'None'
newline|'\n'
dedent|''
name|'except'
name|'exception'
op|'.'
name|'MarkerNotFound'
op|':'
newline|'\n'
indent|'            '
name|'api_db_flavors'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'limit'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'limit_more'
op|'='
name|'limit'
op|'-'
name|'len'
op|'('
name|'api_db_flavors'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'limit_more'
op|'='
name|'None'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'limit_more'
name|'is'
name|'None'
name|'or'
name|'limit_more'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'db_flavors'
op|'='
name|'db'
op|'.'
name|'flavor_get_all'
op|'('
name|'context'
op|','
name|'inactive'
op|'='
name|'inactive'
op|','
nl|'\n'
name|'filters'
op|'='
name|'filters'
op|','
name|'sort_key'
op|'='
name|'sort_key'
op|','
nl|'\n'
name|'sort_dir'
op|'='
name|'sort_dir'
op|','
name|'limit'
op|'='
name|'limit_more'
op|','
nl|'\n'
name|'marker'
op|'='
name|'marker'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'db_flavors'
op|'='
op|'['
op|']'
newline|'\n'
dedent|''
name|'return'
name|'base'
op|'.'
name|'obj_make_list'
op|'('
name|'context'
op|','
name|'cls'
op|'('
name|'context'
op|')'
op|','
name|'objects'
op|'.'
name|'Flavor'
op|','
nl|'\n'
name|'api_db_flavors'
op|'+'
name|'db_flavors'
op|','
nl|'\n'
name|'expected_attrs'
op|'='
op|'['
string|"'extra_specs'"
op|']'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'db_api'
op|'.'
name|'main_context_manager'
op|'.'
name|'reader'
newline|'\n'
DECL|function|_get_main_db_flavor_ids
name|'def'
name|'_get_main_db_flavor_ids'
op|'('
name|'context'
op|','
name|'limit'
op|')'
op|':'
newline|'\n'
comment|"# NOTE(danms): We don't need this imported at runtime, so"
nl|'\n'
comment|'# keep it separate here'
nl|'\n'
indent|'    '
name|'from'
name|'nova'
op|'.'
name|'db'
op|'.'
name|'sqlalchemy'
name|'import'
name|'models'
newline|'\n'
name|'return'
op|'['
name|'x'
op|'['
number|'0'
op|']'
name|'for'
name|'x'
name|'in'
name|'context'
op|'.'
name|'session'
op|'.'
name|'query'
op|'('
name|'models'
op|'.'
name|'InstanceTypes'
op|'.'
name|'id'
op|')'
op|'.'
nl|'\n'
name|'filter_by'
op|'('
name|'deleted'
op|'='
number|'0'
op|')'
op|'.'
nl|'\n'
name|'limit'
op|'('
name|'limit'
op|')'
op|']'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
op|'@'
name|'db_api'
op|'.'
name|'main_context_manager'
op|'.'
name|'writer'
newline|'\n'
DECL|function|_destroy_flavor_hard
name|'def'
name|'_destroy_flavor_hard'
op|'('
name|'context'
op|','
name|'name'
op|')'
op|':'
newline|'\n'
comment|"# NOTE(danms): We don't need this imported at runtime, so"
nl|'\n'
comment|'# keep it separate here'
nl|'\n'
indent|'    '
name|'from'
name|'nova'
op|'.'
name|'db'
op|'.'
name|'sqlalchemy'
name|'import'
name|'models'
newline|'\n'
name|'context'
op|'.'
name|'session'
op|'.'
name|'query'
op|'('
name|'models'
op|'.'
name|'InstanceTypes'
op|')'
op|'.'
name|'filter_by'
op|'('
name|'name'
op|'='
name|'name'
op|')'
op|'.'
name|'delete'
op|'('
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|migrate_flavors
dedent|''
name|'def'
name|'migrate_flavors'
op|'('
name|'ctxt'
op|','
name|'count'
op|','
name|'hard_delete'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'main_db_ids'
op|'='
name|'_get_main_db_flavor_ids'
op|'('
name|'ctxt'
op|','
name|'count'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'main_db_ids'
op|':'
newline|'\n'
indent|'        '
name|'return'
number|'0'
op|','
number|'0'
newline|'\n'
nl|'\n'
dedent|''
name|'count_all'
op|'='
name|'len'
op|'('
name|'main_db_ids'
op|')'
newline|'\n'
name|'count_hit'
op|'='
number|'0'
newline|'\n'
nl|'\n'
name|'for'
name|'flavor_id'
name|'in'
name|'main_db_ids'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'flavor'
op|'='
name|'Flavor'
op|'.'
name|'get_by_id'
op|'('
name|'ctxt'
op|','
name|'flavor_id'
op|')'
newline|'\n'
name|'flavor_values'
op|'='
op|'{'
name|'field'
op|':'
name|'getattr'
op|'('
name|'flavor'
op|','
name|'field'
op|')'
nl|'\n'
name|'for'
name|'field'
name|'in'
name|'flavor'
op|'.'
name|'fields'
op|'}'
newline|'\n'
name|'flavor'
op|'.'
name|'_flavor_create'
op|'('
name|'ctxt'
op|','
name|'flavor_values'
op|')'
newline|'\n'
name|'count_hit'
op|'+='
number|'1'
newline|'\n'
name|'if'
name|'hard_delete'
op|':'
newline|'\n'
indent|'                '
name|'_destroy_flavor_hard'
op|'('
name|'ctxt'
op|','
name|'flavor'
op|'.'
name|'name'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'db'
op|'.'
name|'flavor_destroy'
op|'('
name|'ctxt'
op|','
name|'flavor'
op|'.'
name|'name'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'exception'
op|'.'
name|'FlavorNotFound'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'warning'
op|'('
name|'_LW'
op|'('
string|"'Flavor id %(id)i disappeared during migration'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
name|'flavor_id'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'except'
op|'('
name|'exception'
op|'.'
name|'FlavorExists'
op|','
name|'exception'
op|'.'
name|'FlavorIdExists'
op|')'
name|'as'
name|'e'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'error'
op|'('
name|'str'
op|'('
name|'e'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'return'
name|'count_all'
op|','
name|'count_hit'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|_adjust_autoincrement
dedent|''
name|'def'
name|'_adjust_autoincrement'
op|'('
name|'context'
op|','
name|'value'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'engine'
op|'='
name|'db_api'
op|'.'
name|'get_api_engine'
op|'('
op|')'
newline|'\n'
name|'if'
name|'engine'
op|'.'
name|'name'
op|'=='
string|"'postgresql'"
op|':'
newline|'\n'
comment|'# NOTE(danms): If we migrated some flavors in the above function,'
nl|'\n'
comment|"# then we will have confused postgres' sequence for the autoincrement"
nl|'\n'
comment|'# primary key. MySQL does not care about this, but since postgres does,'
nl|'\n'
comment|'# we need to reset this to avoid a failure on the next flavor creation.'
nl|'\n'
indent|'        '
name|'engine'
op|'.'
name|'execute'
op|'('
nl|'\n'
name|'text'
op|'('
string|"'ALTER SEQUENCE flavors_id_seq RESTART WITH %i;'"
op|'%'
op|'('
nl|'\n'
name|'value'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
op|'@'
name|'db_api'
op|'.'
name|'api_context_manager'
op|'.'
name|'reader'
newline|'\n'
DECL|function|_get_max_flavor_id
name|'def'
name|'_get_max_flavor_id'
op|'('
name|'context'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'return'
name|'context'
op|'.'
name|'session'
op|'.'
name|'query'
op|'('
name|'func'
op|'.'
name|'max'
op|'('
name|'api_models'
op|'.'
name|'Flavors'
op|'.'
name|'id'
op|')'
op|')'
op|'.'
name|'one'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|migrate_flavor_reset_autoincrement
dedent|''
name|'def'
name|'migrate_flavor_reset_autoincrement'
op|'('
name|'ctxt'
op|','
name|'count'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'max_id'
op|'='
name|'_get_max_flavor_id'
op|'('
name|'ctxt'
op|')'
newline|'\n'
name|'_adjust_autoincrement'
op|'('
name|'ctxt'
op|','
name|'max_id'
op|'+'
number|'1'
op|')'
newline|'\n'
name|'return'
number|'0'
op|','
number|'0'
newline|'\n'
dedent|''
endmarker|''
end_unit
