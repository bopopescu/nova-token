begin_unit
comment|'# Copyright (c) 2016 Red Hat, Inc'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
nl|'\n'
string|'"""Utility methods to manage guests migration\n\n"""'
newline|'\n'
nl|'\n'
name|'from'
name|'lxml'
name|'import'
name|'etree'
newline|'\n'
name|'from'
name|'oslo_log'
name|'import'
name|'log'
name|'as'
name|'logging'
newline|'\n'
nl|'\n'
DECL|variable|LOG
name|'LOG'
op|'='
name|'logging'
op|'.'
name|'getLogger'
op|'('
name|'__name__'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|graphics_listen_addrs
name|'def'
name|'graphics_listen_addrs'
op|'('
name|'migrate_data'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Returns listen addresses of vnc/spice from a LibvirtLiveMigrateData"""'
newline|'\n'
name|'listen_addrs'
op|'='
name|'None'
newline|'\n'
name|'if'
op|'('
name|'migrate_data'
op|'.'
name|'obj_attr_is_set'
op|'('
string|"'graphics_listen_addr_vnc'"
op|')'
nl|'\n'
name|'or'
name|'migrate_data'
op|'.'
name|'obj_attr_is_set'
op|'('
string|"'graphics_listen_addr_spice'"
op|')'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'listen_addrs'
op|'='
op|'{'
string|"'vnc'"
op|':'
name|'None'
op|','
string|"'spice'"
op|':'
name|'None'
op|'}'
newline|'\n'
dedent|''
name|'if'
name|'migrate_data'
op|'.'
name|'obj_attr_is_set'
op|'('
string|"'graphics_listen_addr_vnc'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'listen_addrs'
op|'['
string|"'vnc'"
op|']'
op|'='
name|'str'
op|'('
name|'migrate_data'
op|'.'
name|'graphics_listen_addr_vnc'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'migrate_data'
op|'.'
name|'obj_attr_is_set'
op|'('
string|"'graphics_listen_addr_spice'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'listen_addrs'
op|'['
string|"'spice'"
op|']'
op|'='
name|'str'
op|'('
nl|'\n'
name|'migrate_data'
op|'.'
name|'graphics_listen_addr_spice'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'listen_addrs'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|serial_listen_addr
dedent|''
name|'def'
name|'serial_listen_addr'
op|'('
name|'migrate_data'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Returns listen address serial from a LibvirtLiveMigrateData"""'
newline|'\n'
name|'listen_addr'
op|'='
name|'None'
newline|'\n'
name|'if'
name|'migrate_data'
op|'.'
name|'obj_attr_is_set'
op|'('
string|"'serial_listen_addr'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'listen_addr'
op|'='
name|'str'
op|'('
name|'migrate_data'
op|'.'
name|'serial_listen_addr'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'listen_addr'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|get_updated_guest_xml
dedent|''
name|'def'
name|'get_updated_guest_xml'
op|'('
name|'guest'
op|','
name|'migrate_data'
op|','
name|'get_volume_config'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'xml_doc'
op|'='
name|'etree'
op|'.'
name|'fromstring'
op|'('
name|'guest'
op|'.'
name|'get_xml_desc'
op|'('
name|'dump_migratable'
op|'='
name|'True'
op|')'
op|')'
newline|'\n'
name|'xml_doc'
op|'='
name|'_update_graphics_xml'
op|'('
name|'xml_doc'
op|','
name|'migrate_data'
op|')'
newline|'\n'
name|'xml_doc'
op|'='
name|'_update_serial_xml'
op|'('
name|'xml_doc'
op|','
name|'migrate_data'
op|')'
newline|'\n'
name|'xml_doc'
op|'='
name|'_update_volume_xml'
op|'('
name|'xml_doc'
op|','
name|'migrate_data'
op|','
name|'get_volume_config'
op|')'
newline|'\n'
name|'return'
name|'etree'
op|'.'
name|'tostring'
op|'('
name|'xml_doc'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|_update_graphics_xml
dedent|''
name|'def'
name|'_update_graphics_xml'
op|'('
name|'xml_doc'
op|','
name|'migrate_data'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'listen_addrs'
op|'='
name|'graphics_listen_addrs'
op|'('
name|'migrate_data'
op|')'
newline|'\n'
nl|'\n'
comment|'# change over listen addresses'
nl|'\n'
name|'for'
name|'dev'
name|'in'
name|'xml_doc'
op|'.'
name|'findall'
op|'('
string|"'./devices/graphics'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'gr_type'
op|'='
name|'dev'
op|'.'
name|'get'
op|'('
string|"'type'"
op|')'
newline|'\n'
name|'listen_tag'
op|'='
name|'dev'
op|'.'
name|'find'
op|'('
string|"'listen'"
op|')'
newline|'\n'
name|'if'
name|'gr_type'
name|'in'
op|'('
string|"'vnc'"
op|','
string|"'spice'"
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'listen_tag'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'                '
name|'listen_tag'
op|'.'
name|'set'
op|'('
string|"'address'"
op|','
name|'listen_addrs'
op|'['
name|'gr_type'
op|']'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'dev'
op|'.'
name|'get'
op|'('
string|"'listen'"
op|')'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'                '
name|'dev'
op|'.'
name|'set'
op|'('
string|"'listen'"
op|','
name|'listen_addrs'
op|'['
name|'gr_type'
op|']'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'return'
name|'xml_doc'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|_update_serial_xml
dedent|''
name|'def'
name|'_update_serial_xml'
op|'('
name|'xml_doc'
op|','
name|'migrate_data'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'listen_addr'
op|'='
name|'serial_listen_addr'
op|'('
name|'migrate_data'
op|')'
newline|'\n'
name|'for'
name|'dev'
name|'in'
name|'xml_doc'
op|'.'
name|'findall'
op|'('
string|'"./devices/serial[@type=\'tcp\']/source"'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'dev'
op|'.'
name|'get'
op|'('
string|"'host'"
op|')'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'dev'
op|'.'
name|'set'
op|'('
string|"'host'"
op|','
name|'listen_addr'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'for'
name|'dev'
name|'in'
name|'xml_doc'
op|'.'
name|'findall'
op|'('
string|'"./devices/console[@type=\'tcp\']/source"'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'dev'
op|'.'
name|'get'
op|'('
string|"'host'"
op|')'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'dev'
op|'.'
name|'set'
op|'('
string|"'host'"
op|','
name|'listen_addr'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'xml_doc'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|_update_volume_xml
dedent|''
name|'def'
name|'_update_volume_xml'
op|'('
name|'xml_doc'
op|','
name|'migrate_data'
op|','
name|'get_volume_config'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Update XML using device information of destination host."""'
newline|'\n'
name|'migrate_bdm_info'
op|'='
name|'migrate_data'
op|'.'
name|'bdms'
newline|'\n'
nl|'\n'
comment|'# Update volume xml'
nl|'\n'
name|'parser'
op|'='
name|'etree'
op|'.'
name|'XMLParser'
op|'('
name|'remove_blank_text'
op|'='
name|'True'
op|')'
newline|'\n'
name|'disk_nodes'
op|'='
name|'xml_doc'
op|'.'
name|'findall'
op|'('
string|"'./devices/disk'"
op|')'
newline|'\n'
nl|'\n'
name|'bdm_info_by_serial'
op|'='
op|'{'
name|'x'
op|'.'
name|'serial'
op|':'
name|'x'
name|'for'
name|'x'
name|'in'
name|'migrate_bdm_info'
op|'}'
newline|'\n'
name|'for'
name|'pos'
op|','
name|'disk_dev'
name|'in'
name|'enumerate'
op|'('
name|'disk_nodes'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'serial_source'
op|'='
name|'disk_dev'
op|'.'
name|'findtext'
op|'('
string|"'serial'"
op|')'
newline|'\n'
name|'bdm_info'
op|'='
name|'bdm_info_by_serial'
op|'.'
name|'get'
op|'('
name|'serial_source'
op|')'
newline|'\n'
name|'if'
op|'('
name|'serial_source'
name|'is'
name|'None'
name|'or'
nl|'\n'
name|'not'
name|'bdm_info'
name|'or'
name|'not'
name|'bdm_info'
op|'.'
name|'connection_info'
name|'or'
nl|'\n'
name|'serial_source'
name|'not'
name|'in'
name|'bdm_info_by_serial'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'continue'
newline|'\n'
dedent|''
name|'conf'
op|'='
name|'get_volume_config'
op|'('
nl|'\n'
name|'bdm_info'
op|'.'
name|'connection_info'
op|','
name|'bdm_info'
op|'.'
name|'as_disk_info'
op|'('
op|')'
op|')'
newline|'\n'
name|'xml_doc2'
op|'='
name|'etree'
op|'.'
name|'XML'
op|'('
name|'conf'
op|'.'
name|'to_xml'
op|'('
op|')'
op|','
name|'parser'
op|')'
newline|'\n'
name|'serial_dest'
op|'='
name|'xml_doc2'
op|'.'
name|'findtext'
op|'('
string|"'serial'"
op|')'
newline|'\n'
nl|'\n'
comment|'# Compare source serial and destination serial number.'
nl|'\n'
comment|'# If these serial numbers match, continue the process.'
nl|'\n'
name|'if'
op|'('
name|'serial_dest'
name|'and'
op|'('
name|'serial_source'
op|'=='
name|'serial_dest'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
string|'"Find same serial number: pos=%(pos)s, "'
nl|'\n'
string|'"serial=%(num)s"'
op|','
nl|'\n'
op|'{'
string|"'pos'"
op|':'
name|'pos'
op|','
string|"'num'"
op|':'
name|'serial_source'
op|'}'
op|')'
newline|'\n'
name|'for'
name|'cnt'
op|','
name|'item_src'
name|'in'
name|'enumerate'
op|'('
name|'disk_dev'
op|')'
op|':'
newline|'\n'
comment|'# If source and destination have same item, update'
nl|'\n'
comment|'# the item using destination value.'
nl|'\n'
indent|'                '
name|'for'
name|'item_dst'
name|'in'
name|'xml_doc2'
op|'.'
name|'findall'
op|'('
name|'item_src'
op|'.'
name|'tag'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'disk_dev'
op|'.'
name|'remove'
op|'('
name|'item_src'
op|')'
newline|'\n'
name|'item_dst'
op|'.'
name|'tail'
op|'='
name|'None'
newline|'\n'
name|'disk_dev'
op|'.'
name|'insert'
op|'('
name|'cnt'
op|','
name|'item_dst'
op|')'
newline|'\n'
nl|'\n'
comment|'# If destination has additional items, thses items should be'
nl|'\n'
comment|'# added here.'
nl|'\n'
dedent|''
dedent|''
name|'for'
name|'item_dst'
name|'in'
name|'list'
op|'('
name|'xml_doc2'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'item_dst'
op|'.'
name|'tail'
op|'='
name|'None'
newline|'\n'
name|'disk_dev'
op|'.'
name|'insert'
op|'('
name|'cnt'
op|','
name|'item_dst'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'return'
name|'xml_doc'
newline|'\n'
dedent|''
endmarker|''
end_unit
