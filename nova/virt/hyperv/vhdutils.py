begin_unit
comment|'# Copyright 2013 Cloudbase Solutions Srl'
nl|'\n'
comment|'# All Rights Reserved.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
string|'"""\nUtility class for VHD related operations.\n\nOfficial VHD format specs can be retrieved at:\nhttp://technet.microsoft.com/en-us/library/bb676673.aspx\nSee "Download the Specifications Without Registering"\n\nOfficial VHDX format specs can be retrieved at:\nhttp://www.microsoft.com/en-us/download/details.aspx?id=34750\n"""'
newline|'\n'
name|'import'
name|'struct'
newline|'\n'
name|'import'
name|'sys'
newline|'\n'
nl|'\n'
name|'if'
name|'sys'
op|'.'
name|'platform'
op|'=='
string|"'win32'"
op|':'
newline|'\n'
indent|'    '
name|'import'
name|'wmi'
newline|'\n'
nl|'\n'
dedent|''
name|'from'
name|'xml'
op|'.'
name|'etree'
name|'import'
name|'ElementTree'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
op|'.'
name|'i18n'
name|'import'
name|'_'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'hyperv'
name|'import'
name|'constants'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'hyperv'
name|'import'
name|'vmutils'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|VHD_HEADER_SIZE_FIX
name|'VHD_HEADER_SIZE_FIX'
op|'='
number|'512'
newline|'\n'
DECL|variable|VHD_BAT_ENTRY_SIZE
name|'VHD_BAT_ENTRY_SIZE'
op|'='
number|'4'
newline|'\n'
DECL|variable|VHD_DYNAMIC_DISK_HEADER_SIZE
name|'VHD_DYNAMIC_DISK_HEADER_SIZE'
op|'='
number|'1024'
newline|'\n'
DECL|variable|VHD_HEADER_SIZE_DYNAMIC
name|'VHD_HEADER_SIZE_DYNAMIC'
op|'='
number|'512'
newline|'\n'
DECL|variable|VHD_FOOTER_SIZE_DYNAMIC
name|'VHD_FOOTER_SIZE_DYNAMIC'
op|'='
number|'512'
newline|'\n'
DECL|variable|VHD_BLK_SIZE_OFFSET
name|'VHD_BLK_SIZE_OFFSET'
op|'='
number|'544'
newline|'\n'
nl|'\n'
DECL|variable|VHD_SIGNATURE
name|'VHD_SIGNATURE'
op|'='
string|"'conectix'"
newline|'\n'
DECL|variable|VHDX_SIGNATURE
name|'VHDX_SIGNATURE'
op|'='
string|"'vhdxfile'"
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|VHDUtils
name|'class'
name|'VHDUtils'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
nl|'\n'
DECL|member|__init__
indent|'    '
name|'def'
name|'__init__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_vmutils'
op|'='
name|'vmutils'
op|'.'
name|'VMUtils'
op|'('
op|')'
newline|'\n'
name|'if'
name|'sys'
op|'.'
name|'platform'
op|'=='
string|"'win32'"
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_conn'
op|'='
name|'wmi'
op|'.'
name|'WMI'
op|'('
name|'moniker'
op|'='
string|"'//./root/virtualization'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|validate_vhd
dedent|''
dedent|''
name|'def'
name|'validate_vhd'
op|'('
name|'self'
op|','
name|'vhd_path'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'image_man_svc'
op|'='
name|'self'
op|'.'
name|'_conn'
op|'.'
name|'Msvm_ImageManagementService'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
op|'('
name|'job_path'
op|','
name|'ret_val'
op|')'
op|'='
name|'image_man_svc'
op|'.'
name|'ValidateVirtualHardDisk'
op|'('
nl|'\n'
name|'Path'
op|'='
name|'vhd_path'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_vmutils'
op|'.'
name|'check_ret_val'
op|'('
name|'ret_val'
op|','
name|'job_path'
op|')'
newline|'\n'
nl|'\n'
DECL|member|create_dynamic_vhd
dedent|''
name|'def'
name|'create_dynamic_vhd'
op|'('
name|'self'
op|','
name|'path'
op|','
name|'max_internal_size'
op|','
name|'format'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'format'
op|'!='
name|'constants'
op|'.'
name|'DISK_FORMAT_VHD'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'vmutils'
op|'.'
name|'HyperVException'
op|'('
name|'_'
op|'('
string|'"Unsupported disk format: %s"'
op|')'
op|'%'
nl|'\n'
name|'format'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'image_man_svc'
op|'='
name|'self'
op|'.'
name|'_conn'
op|'.'
name|'Msvm_ImageManagementService'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
op|'('
name|'job_path'
op|','
name|'ret_val'
op|')'
op|'='
name|'image_man_svc'
op|'.'
name|'CreateDynamicVirtualHardDisk'
op|'('
nl|'\n'
name|'Path'
op|'='
name|'path'
op|','
name|'MaxInternalSize'
op|'='
name|'max_internal_size'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_vmutils'
op|'.'
name|'check_ret_val'
op|'('
name|'ret_val'
op|','
name|'job_path'
op|')'
newline|'\n'
nl|'\n'
DECL|member|create_differencing_vhd
dedent|''
name|'def'
name|'create_differencing_vhd'
op|'('
name|'self'
op|','
name|'path'
op|','
name|'parent_path'
op|','
name|'size'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'size'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'vmutils'
op|'.'
name|'HyperVException'
op|'('
name|'_'
op|'('
string|"'VHD differencing disks cannot be '"
nl|'\n'
string|"'resized'"
op|')'
op|')'
newline|'\n'
dedent|''
name|'image_man_svc'
op|'='
name|'self'
op|'.'
name|'_conn'
op|'.'
name|'Msvm_ImageManagementService'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
op|'('
name|'job_path'
op|','
name|'ret_val'
op|')'
op|'='
name|'image_man_svc'
op|'.'
name|'CreateDifferencingVirtualHardDisk'
op|'('
nl|'\n'
name|'Path'
op|'='
name|'path'
op|','
name|'ParentPath'
op|'='
name|'parent_path'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_vmutils'
op|'.'
name|'check_ret_val'
op|'('
name|'ret_val'
op|','
name|'job_path'
op|')'
newline|'\n'
nl|'\n'
DECL|member|reconnect_parent_vhd
dedent|''
name|'def'
name|'reconnect_parent_vhd'
op|'('
name|'self'
op|','
name|'child_vhd_path'
op|','
name|'parent_vhd_path'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'image_man_svc'
op|'='
name|'self'
op|'.'
name|'_conn'
op|'.'
name|'Msvm_ImageManagementService'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
op|'('
name|'job_path'
op|','
name|'ret_val'
op|')'
op|'='
name|'image_man_svc'
op|'.'
name|'ReconnectParentVirtualHardDisk'
op|'('
nl|'\n'
name|'ChildPath'
op|'='
name|'child_vhd_path'
op|','
nl|'\n'
name|'ParentPath'
op|'='
name|'parent_vhd_path'
op|','
nl|'\n'
name|'Force'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_vmutils'
op|'.'
name|'check_ret_val'
op|'('
name|'ret_val'
op|','
name|'job_path'
op|')'
newline|'\n'
nl|'\n'
DECL|member|merge_vhd
dedent|''
name|'def'
name|'merge_vhd'
op|'('
name|'self'
op|','
name|'src_vhd_path'
op|','
name|'dest_vhd_path'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'image_man_svc'
op|'='
name|'self'
op|'.'
name|'_conn'
op|'.'
name|'Msvm_ImageManagementService'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
op|'('
name|'job_path'
op|','
name|'ret_val'
op|')'
op|'='
name|'image_man_svc'
op|'.'
name|'MergeVirtualHardDisk'
op|'('
nl|'\n'
name|'SourcePath'
op|'='
name|'src_vhd_path'
op|','
nl|'\n'
name|'DestinationPath'
op|'='
name|'dest_vhd_path'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_vmutils'
op|'.'
name|'check_ret_val'
op|'('
name|'ret_val'
op|','
name|'job_path'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_resize_method
dedent|''
name|'def'
name|'_get_resize_method'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'image_man_svc'
op|'='
name|'self'
op|'.'
name|'_conn'
op|'.'
name|'Msvm_ImageManagementService'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'return'
name|'image_man_svc'
op|'.'
name|'ExpandVirtualHardDisk'
newline|'\n'
nl|'\n'
DECL|member|resize_vhd
dedent|''
name|'def'
name|'resize_vhd'
op|'('
name|'self'
op|','
name|'vhd_path'
op|','
name|'new_max_size'
op|','
name|'is_file_max_size'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'is_file_max_size'
op|':'
newline|'\n'
indent|'            '
name|'new_internal_max_size'
op|'='
name|'self'
op|'.'
name|'get_internal_vhd_size_by_file_size'
op|'('
nl|'\n'
name|'vhd_path'
op|','
name|'new_max_size'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'new_internal_max_size'
op|'='
name|'new_max_size'
newline|'\n'
nl|'\n'
dedent|''
name|'resize'
op|'='
name|'self'
op|'.'
name|'_get_resize_method'
op|'('
op|')'
newline|'\n'
nl|'\n'
op|'('
name|'job_path'
op|','
name|'ret_val'
op|')'
op|'='
name|'resize'
op|'('
nl|'\n'
name|'Path'
op|'='
name|'vhd_path'
op|','
name|'MaxInternalSize'
op|'='
name|'new_internal_max_size'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_vmutils'
op|'.'
name|'check_ret_val'
op|'('
name|'ret_val'
op|','
name|'job_path'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_internal_vhd_size_by_file_size
dedent|''
name|'def'
name|'get_internal_vhd_size_by_file_size'
op|'('
name|'self'
op|','
name|'vhd_path'
op|','
name|'new_vhd_file_size'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Fixed VHD size = Data Block size + 512 bytes\n           Dynamic_VHD_size = Dynamic Disk Header\n                             + Copy of hard disk footer\n                             + Hard Disk Footer\n                             + Data Block\n                             + BAT\n           Dynamic Disk header fields\n                Copy of hard disk footer (512 bytes)\n                Dynamic Disk Header (1024 bytes)\n                BAT (Block Allocation table)\n                Data Block 1\n                Data Block 2\n                Data Block n\n                Hard Disk Footer (512 bytes)\n           Default block size is 2M\n           BAT entry size is 4byte\n        """'
newline|'\n'
name|'base_vhd_info'
op|'='
name|'self'
op|'.'
name|'get_vhd_info'
op|'('
name|'vhd_path'
op|')'
newline|'\n'
name|'vhd_type'
op|'='
name|'base_vhd_info'
op|'['
string|"'Type'"
op|']'
newline|'\n'
nl|'\n'
name|'if'
name|'vhd_type'
op|'=='
name|'constants'
op|'.'
name|'VHD_TYPE_FIXED'
op|':'
newline|'\n'
indent|'            '
name|'vhd_header_size'
op|'='
name|'VHD_HEADER_SIZE_FIX'
newline|'\n'
name|'return'
name|'new_vhd_file_size'
op|'-'
name|'vhd_header_size'
newline|'\n'
dedent|''
name|'elif'
name|'vhd_type'
op|'=='
name|'constants'
op|'.'
name|'VHD_TYPE_DYNAMIC'
op|':'
newline|'\n'
indent|'            '
name|'bs'
op|'='
name|'self'
op|'.'
name|'_get_vhd_dynamic_blk_size'
op|'('
name|'vhd_path'
op|')'
newline|'\n'
name|'bes'
op|'='
name|'VHD_BAT_ENTRY_SIZE'
newline|'\n'
name|'ddhs'
op|'='
name|'VHD_DYNAMIC_DISK_HEADER_SIZE'
newline|'\n'
name|'hs'
op|'='
name|'VHD_HEADER_SIZE_DYNAMIC'
newline|'\n'
name|'fs'
op|'='
name|'VHD_FOOTER_SIZE_DYNAMIC'
newline|'\n'
nl|'\n'
name|'max_internal_size'
op|'='
op|'('
name|'new_vhd_file_size'
op|'-'
nl|'\n'
op|'('
name|'hs'
op|'+'
name|'ddhs'
op|'+'
name|'fs'
op|')'
op|')'
op|'*'
name|'bs'
op|'/'
op|'('
name|'bes'
op|'+'
name|'bs'
op|')'
newline|'\n'
name|'return'
name|'max_internal_size'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'vhd_parent'
op|'='
name|'self'
op|'.'
name|'get_vhd_parent_path'
op|'('
name|'vhd_path'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'get_internal_vhd_size_by_file_size'
op|'('
name|'vhd_parent'
op|','
nl|'\n'
name|'new_vhd_file_size'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_vhd_dynamic_blk_size
dedent|''
dedent|''
name|'def'
name|'_get_vhd_dynamic_blk_size'
op|'('
name|'self'
op|','
name|'vhd_path'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'blk_size_offset'
op|'='
name|'VHD_BLK_SIZE_OFFSET'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'open'
op|'('
name|'vhd_path'
op|','
string|'"rb"'
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
indent|'                '
name|'f'
op|'.'
name|'seek'
op|'('
name|'blk_size_offset'
op|')'
newline|'\n'
name|'version'
op|'='
name|'f'
op|'.'
name|'read'
op|'('
number|'4'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'IOError'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'vmutils'
op|'.'
name|'HyperVException'
op|'('
name|'_'
op|'('
string|'"Unable to obtain block size from"'
nl|'\n'
string|'" VHD %(vhd_path)s"'
op|')'
op|'%'
nl|'\n'
op|'{'
string|'"vhd_path"'
op|':'
name|'vhd_path'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'struct'
op|'.'
name|'unpack'
op|'('
string|"'>i'"
op|','
name|'version'
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
DECL|member|get_vhd_parent_path
dedent|''
name|'def'
name|'get_vhd_parent_path'
op|'('
name|'self'
op|','
name|'vhd_path'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'get_vhd_info'
op|'('
name|'vhd_path'
op|')'
op|'.'
name|'get'
op|'('
string|'"ParentPath"'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_vhd_info
dedent|''
name|'def'
name|'get_vhd_info'
op|'('
name|'self'
op|','
name|'vhd_path'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'image_man_svc'
op|'='
name|'self'
op|'.'
name|'_conn'
op|'.'
name|'Msvm_ImageManagementService'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
op|'('
name|'vhd_info'
op|','
nl|'\n'
name|'job_path'
op|','
nl|'\n'
name|'ret_val'
op|')'
op|'='
name|'image_man_svc'
op|'.'
name|'GetVirtualHardDiskInfo'
op|'('
name|'vhd_path'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_vmutils'
op|'.'
name|'check_ret_val'
op|'('
name|'ret_val'
op|','
name|'job_path'
op|')'
newline|'\n'
nl|'\n'
name|'vhd_info_dict'
op|'='
op|'{'
op|'}'
newline|'\n'
nl|'\n'
name|'et'
op|'='
name|'ElementTree'
op|'.'
name|'fromstring'
op|'('
name|'vhd_info'
op|')'
newline|'\n'
name|'for'
name|'item'
name|'in'
name|'et'
op|'.'
name|'findall'
op|'('
string|'"PROPERTY"'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'name'
op|'='
name|'item'
op|'.'
name|'attrib'
op|'['
string|'"NAME"'
op|']'
newline|'\n'
name|'value_text'
op|'='
name|'item'
op|'.'
name|'find'
op|'('
string|'"VALUE"'
op|')'
op|'.'
name|'text'
newline|'\n'
name|'if'
name|'name'
op|'=='
string|'"ParentPath"'
op|':'
newline|'\n'
indent|'                '
name|'vhd_info_dict'
op|'['
name|'name'
op|']'
op|'='
name|'value_text'
newline|'\n'
dedent|''
name|'elif'
name|'name'
name|'in'
op|'['
string|'"FileSize"'
op|','
string|'"MaxInternalSize"'
op|']'
op|':'
newline|'\n'
indent|'                '
name|'vhd_info_dict'
op|'['
name|'name'
op|']'
op|'='
name|'long'
op|'('
name|'value_text'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'name'
name|'in'
op|'['
string|'"InSavedState"'
op|','
string|'"InUse"'
op|']'
op|':'
newline|'\n'
indent|'                '
name|'vhd_info_dict'
op|'['
name|'name'
op|']'
op|'='
name|'bool'
op|'('
name|'value_text'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'name'
op|'=='
string|'"Type"'
op|':'
newline|'\n'
indent|'                '
name|'vhd_info_dict'
op|'['
name|'name'
op|']'
op|'='
name|'int'
op|'('
name|'value_text'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'return'
name|'vhd_info_dict'
newline|'\n'
nl|'\n'
DECL|member|get_vhd_format
dedent|''
name|'def'
name|'get_vhd_format'
op|'('
name|'self'
op|','
name|'path'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'with'
name|'open'
op|'('
name|'path'
op|','
string|"'rb'"
op|')'
name|'as'
name|'f'
op|':'
newline|'\n'
comment|'# Read header'
nl|'\n'
indent|'            '
name|'if'
name|'f'
op|'.'
name|'read'
op|'('
number|'8'
op|')'
op|'=='
name|'VHDX_SIGNATURE'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'constants'
op|'.'
name|'DISK_FORMAT_VHDX'
newline|'\n'
nl|'\n'
comment|'# Read footer'
nl|'\n'
dedent|''
name|'f'
op|'.'
name|'seek'
op|'('
number|'0'
op|','
number|'2'
op|')'
newline|'\n'
name|'file_size'
op|'='
name|'f'
op|'.'
name|'tell'
op|'('
op|')'
newline|'\n'
name|'if'
name|'file_size'
op|'>='
number|'512'
op|':'
newline|'\n'
indent|'                '
name|'f'
op|'.'
name|'seek'
op|'('
op|'-'
number|'512'
op|','
number|'2'
op|')'
newline|'\n'
name|'if'
name|'f'
op|'.'
name|'read'
op|'('
number|'8'
op|')'
op|'=='
name|'VHD_SIGNATURE'
op|':'
newline|'\n'
indent|'                    '
name|'return'
name|'constants'
op|'.'
name|'DISK_FORMAT_VHD'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
name|'raise'
name|'vmutils'
op|'.'
name|'HyperVException'
op|'('
name|'_'
op|'('
string|"'Unsupported virtual disk format'"
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_best_supported_vhd_format
dedent|''
name|'def'
name|'get_best_supported_vhd_format'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'constants'
op|'.'
name|'DISK_FORMAT_VHD'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
