begin_unit
comment|'# vim: tabstop=4 shiftwidth=4 softtabstop=4'
nl|'\n'
nl|'\n'
comment|'# Copyright (c) 2012 VMware, Inc.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
string|'"""\nManagement class for Storage-related functions (attach, detach, etc).\n"""'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'cfg'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'log'
name|'as'
name|'logging'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'vmwareapi'
name|'import'
name|'vim_util'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'vmwareapi'
name|'import'
name|'vm_util'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'vmwareapi'
name|'import'
name|'volume_util'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|CONF
name|'CONF'
op|'='
name|'cfg'
op|'.'
name|'CONF'
newline|'\n'
DECL|variable|LOG
name|'LOG'
op|'='
name|'logging'
op|'.'
name|'getLogger'
op|'('
name|'__name__'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|VMwareVolumeOps
name|'class'
name|'VMwareVolumeOps'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Management class for Volume-related tasks\n    """'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'session'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_session'
op|'='
name|'session'
newline|'\n'
nl|'\n'
DECL|member|attach_disk_to_vm
dedent|''
name|'def'
name|'attach_disk_to_vm'
op|'('
name|'self'
op|','
name|'vm_ref'
op|','
name|'instance_name'
op|','
nl|'\n'
name|'adapter_type'
op|','
name|'disk_type'
op|','
name|'vmdk_path'
op|'='
name|'None'
op|','
nl|'\n'
name|'disk_size'
op|'='
name|'None'
op|','
name|'linked_clone'
op|'='
name|'False'
op|','
nl|'\n'
name|'controller_key'
op|'='
name|'None'
op|','
name|'unit_number'
op|'='
name|'None'
op|','
nl|'\n'
name|'device_name'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Attach disk to VM by reconfiguration.\n        """'
newline|'\n'
name|'client_factory'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|'.'
name|'client'
op|'.'
name|'factory'
newline|'\n'
name|'vmdk_attach_config_spec'
op|'='
name|'vm_util'
op|'.'
name|'get_vmdk_attach_config_spec'
op|'('
nl|'\n'
name|'client_factory'
op|','
name|'adapter_type'
op|','
name|'disk_type'
op|','
nl|'\n'
name|'vmdk_path'
op|','
name|'disk_size'
op|','
name|'linked_clone'
op|','
nl|'\n'
name|'controller_key'
op|','
name|'unit_number'
op|','
name|'device_name'
op|')'
newline|'\n'
nl|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Reconfiguring VM instance %(instance_name)s to attach "'
nl|'\n'
string|'"disk %(vmdk_path)s or device %(device_name)s with type "'
nl|'\n'
string|'"%(disk_type)s"'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'reconfig_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"ReconfigVM_Task"'
op|','
name|'vm_ref'
op|','
nl|'\n'
name|'spec'
op|'='
name|'vmdk_attach_config_spec'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance_name'
op|','
name|'reconfig_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Reconfigured VM instance %(instance_name)s to attach "'
nl|'\n'
string|'"disk %(vmdk_path)s or device %(device_name)s with type "'
nl|'\n'
string|'"%(disk_type)s"'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|detach_disk_from_vm
dedent|''
name|'def'
name|'detach_disk_from_vm'
op|'('
name|'self'
op|','
name|'vm_ref'
op|','
name|'instance_name'
op|','
name|'device'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Detach disk from VM by reconfiguration.\n        """'
newline|'\n'
name|'client_factory'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|'.'
name|'client'
op|'.'
name|'factory'
newline|'\n'
name|'vmdk_detach_config_spec'
op|'='
name|'vm_util'
op|'.'
name|'get_vmdk_detach_config_spec'
op|'('
nl|'\n'
name|'client_factory'
op|','
name|'device'
op|')'
newline|'\n'
name|'disk_key'
op|'='
name|'device'
op|'.'
name|'key'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Reconfiguring VM instance %(instance_name)s to detach "'
nl|'\n'
string|'"disk %(disk_key)s"'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'reconfig_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"ReconfigVM_Task"'
op|','
name|'vm_ref'
op|','
nl|'\n'
name|'spec'
op|'='
name|'vmdk_detach_config_spec'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance_name'
op|','
name|'reconfig_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Reconfigured VM instance %(instance_name)s to detach "'
nl|'\n'
string|'"disk %(disk_key)s"'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|discover_st
dedent|''
name|'def'
name|'discover_st'
op|'('
name|'self'
op|','
name|'data'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Discover iSCSI targets."""'
newline|'\n'
name|'target_portal'
op|'='
name|'data'
op|'['
string|"'target_portal'"
op|']'
newline|'\n'
name|'target_iqn'
op|'='
name|'data'
op|'['
string|"'target_iqn'"
op|']'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Discovering iSCSI target %(target_iqn)s from "'
nl|'\n'
string|'"%(target_portal)s."'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'device_name'
op|','
name|'uuid'
op|'='
name|'volume_util'
op|'.'
name|'find_st'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'data'
op|')'
newline|'\n'
name|'if'
name|'device_name'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Storage target found. No need to discover"'
op|')'
op|')'
newline|'\n'
name|'return'
op|'('
name|'device_name'
op|','
name|'uuid'
op|')'
newline|'\n'
comment|'# Rescan iSCSI HBA'
nl|'\n'
dedent|''
name|'volume_util'
op|'.'
name|'rescan_iscsi_hba'
op|'('
name|'self'
op|'.'
name|'_session'
op|')'
newline|'\n'
comment|'# Find iSCSI Target again'
nl|'\n'
name|'device_name'
op|','
name|'uuid'
op|'='
name|'volume_util'
op|'.'
name|'find_st'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'data'
op|')'
newline|'\n'
name|'if'
name|'device_name'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Discovered iSCSI target %(target_iqn)s from "'
nl|'\n'
string|'"%(target_portal)s."'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Unable to discovered iSCSI target %(target_iqn)s "'
nl|'\n'
string|'"from %(target_portal)s."'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
name|'return'
op|'('
name|'device_name'
op|','
name|'uuid'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_volume_connector
dedent|''
name|'def'
name|'get_volume_connector'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return volume connector information."""'
newline|'\n'
name|'iqn'
op|'='
name|'volume_util'
op|'.'
name|'get_host_iqn'
op|'('
name|'self'
op|'.'
name|'_session'
op|')'
newline|'\n'
name|'return'
op|'{'
nl|'\n'
string|"'ip'"
op|':'
name|'CONF'
op|'.'
name|'vmwareapi_host_ip'
op|','
nl|'\n'
string|"'initiator'"
op|':'
name|'iqn'
op|','
nl|'\n'
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'vmwareapi_host_ip'
nl|'\n'
op|'}'
newline|'\n'
nl|'\n'
DECL|member|attach_volume
dedent|''
name|'def'
name|'attach_volume'
op|'('
name|'self'
op|','
name|'connection_info'
op|','
name|'instance'
op|','
name|'mountpoint'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Attach volume storage to VM instance."""'
newline|'\n'
name|'instance_name'
op|'='
name|'instance'
op|'['
string|"'name'"
op|']'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance_name'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance_name'
op|')'
newline|'\n'
comment|'# Attach Volume to VM'
nl|'\n'
dedent|''
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Attach_volume: %(connection_info)s, %(instance_name)s, "'
nl|'\n'
string|'"%(mountpoint)s"'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'driver_type'
op|'='
name|'connection_info'
op|'['
string|"'driver_volume_type'"
op|']'
newline|'\n'
name|'if'
name|'driver_type'
name|'not'
name|'in'
op|'['
string|"'iscsi'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'VolumeDriverNotFound'
op|'('
name|'driver_type'
op|'='
name|'driver_type'
op|')'
newline|'\n'
dedent|''
name|'data'
op|'='
name|'connection_info'
op|'['
string|"'data'"
op|']'
newline|'\n'
name|'mount_unit'
op|'='
name|'volume_util'
op|'.'
name|'mountpoint_to_number'
op|'('
name|'mountpoint'
op|')'
newline|'\n'
nl|'\n'
comment|'# Discover iSCSI Target'
nl|'\n'
name|'device_name'
op|','
name|'uuid'
op|'='
name|'self'
op|'.'
name|'discover_st'
op|'('
name|'data'
op|')'
newline|'\n'
name|'if'
name|'device_name'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'volume_util'
op|'.'
name|'StorageError'
op|'('
name|'_'
op|'('
string|'"Unable to find iSCSI Target"'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# Get the vmdk file name that the VM is pointing to'
nl|'\n'
dedent|''
name|'hardware_devices'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
nl|'\n'
string|'"get_dynamic_property"'
op|','
name|'vm_ref'
op|','
nl|'\n'
string|'"VirtualMachine"'
op|','
string|'"config.hardware.device"'
op|')'
newline|'\n'
name|'vmdk_file_path'
op|','
name|'controller_key'
op|','
name|'adapter_type'
op|','
name|'disk_type'
op|','
name|'unit_number'
op|'='
name|'vm_util'
op|'.'
name|'get_vmdk_path_and_adapter_type'
op|'('
name|'hardware_devices'
op|')'
newline|'\n'
comment|'# Figure out the correct unit number'
nl|'\n'
name|'if'
name|'unit_number'
op|'<'
name|'mount_unit'
op|':'
newline|'\n'
indent|'            '
name|'unit_number'
op|'='
name|'mount_unit'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'unit_number'
op|'='
name|'unit_number'
op|'+'
number|'1'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'attach_disk_to_vm'
op|'('
name|'vm_ref'
op|','
name|'instance_name'
op|','
nl|'\n'
name|'adapter_type'
op|','
name|'disk_type'
op|'='
string|'"rdmp"'
op|','
nl|'\n'
name|'controller_key'
op|'='
name|'controller_key'
op|','
nl|'\n'
name|'unit_number'
op|'='
name|'unit_number'
op|','
nl|'\n'
name|'device_name'
op|'='
name|'device_name'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|'"Mountpoint %(mountpoint)s attached to "'
nl|'\n'
string|'"instance %(instance_name)s"'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|detach_volume
dedent|''
name|'def'
name|'detach_volume'
op|'('
name|'self'
op|','
name|'connection_info'
op|','
name|'instance'
op|','
name|'mountpoint'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Detach volume storage to VM instance."""'
newline|'\n'
name|'instance_name'
op|'='
name|'instance'
op|'['
string|"'name'"
op|']'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance_name'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance_name'
op|')'
newline|'\n'
comment|'# Detach Volume from VM'
nl|'\n'
dedent|''
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Detach_volume: %(instance_name)s, %(mountpoint)s"'
op|')'
nl|'\n'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'driver_type'
op|'='
name|'connection_info'
op|'['
string|"'driver_volume_type'"
op|']'
newline|'\n'
name|'if'
name|'driver_type'
name|'not'
name|'in'
op|'['
string|"'iscsi'"
op|']'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'VolumeDriverNotFound'
op|'('
name|'driver_type'
op|'='
name|'driver_type'
op|')'
newline|'\n'
dedent|''
name|'data'
op|'='
name|'connection_info'
op|'['
string|"'data'"
op|']'
newline|'\n'
nl|'\n'
comment|'# Discover iSCSI Target'
nl|'\n'
name|'device_name'
op|','
name|'uuid'
op|'='
name|'volume_util'
op|'.'
name|'find_st'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'data'
op|')'
newline|'\n'
name|'if'
name|'device_name'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'volume_util'
op|'.'
name|'StorageError'
op|'('
name|'_'
op|'('
string|'"Unable to find iSCSI Target"'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# Get the vmdk file name that the VM is pointing to'
nl|'\n'
dedent|''
name|'hardware_devices'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
nl|'\n'
string|'"get_dynamic_property"'
op|','
name|'vm_ref'
op|','
nl|'\n'
string|'"VirtualMachine"'
op|','
string|'"config.hardware.device"'
op|')'
newline|'\n'
name|'device'
op|'='
name|'vm_util'
op|'.'
name|'get_rdm_disk'
op|'('
name|'hardware_devices'
op|','
name|'uuid'
op|')'
newline|'\n'
name|'if'
name|'device'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'volume_util'
op|'.'
name|'StorageError'
op|'('
name|'_'
op|'('
string|'"Unable to find volume"'
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'detach_disk_from_vm'
op|'('
name|'vm_ref'
op|','
name|'instance_name'
op|','
name|'device'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|'"Mountpoint %(mountpoint)s detached from "'
nl|'\n'
string|'"instance %(instance_name)s"'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
