begin_unit
comment|'# vim: tabstop=4 shiftwidth=4 softtabstop=4'
nl|'\n'
nl|'\n'
comment|'# Copyright (c) 2012 VMware, Inc.'
nl|'\n'
comment|'# Copyright (c) 2011 Citrix Systems, Inc.'
nl|'\n'
comment|'# Copyright 2011 OpenStack LLC.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
string|'"""\nClass for VM tasks like spawn, snapshot, suspend, resume etc.\n"""'
newline|'\n'
nl|'\n'
name|'import'
name|'base64'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'time'
newline|'\n'
name|'import'
name|'urllib'
newline|'\n'
name|'import'
name|'urllib2'
newline|'\n'
name|'import'
name|'uuid'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
name|'import'
name|'block_device'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'compute'
name|'import'
name|'api'
name|'as'
name|'compute'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'compute'
name|'import'
name|'power_state'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'compute'
name|'import'
name|'task_states'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'context'
name|'as'
name|'nova_context'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'cfg'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'excutils'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'log'
name|'as'
name|'logging'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
name|'import'
name|'driver'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'vmwareapi'
name|'import'
name|'network_util'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'vmwareapi'
name|'import'
name|'vif'
name|'as'
name|'vmwarevif'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'vmwareapi'
name|'import'
name|'vim_util'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'vmwareapi'
name|'import'
name|'vm_util'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'vmwareapi'
name|'import'
name|'vmware_images'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|vmware_vif_opts
name|'vmware_vif_opts'
op|'='
op|'['
nl|'\n'
name|'cfg'
op|'.'
name|'StrOpt'
op|'('
string|"'integration_bridge'"
op|','
nl|'\n'
DECL|variable|default
name|'default'
op|'='
string|"'br-int'"
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'Name of Integration Bridge'"
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
DECL|variable|vmware_group
name|'vmware_group'
op|'='
name|'cfg'
op|'.'
name|'OptGroup'
op|'('
name|'name'
op|'='
string|"'vmware'"
op|','
nl|'\n'
DECL|variable|title
name|'title'
op|'='
string|"'VMware Options'"
op|')'
newline|'\n'
nl|'\n'
DECL|variable|CONF
name|'CONF'
op|'='
name|'cfg'
op|'.'
name|'CONF'
newline|'\n'
name|'CONF'
op|'.'
name|'register_group'
op|'('
name|'vmware_group'
op|')'
newline|'\n'
name|'CONF'
op|'.'
name|'register_opts'
op|'('
name|'vmware_vif_opts'
op|','
name|'vmware_group'
op|')'
newline|'\n'
name|'CONF'
op|'.'
name|'import_opt'
op|'('
string|"'vnc_enabled'"
op|','
string|"'nova.vnc'"
op|')'
newline|'\n'
nl|'\n'
DECL|variable|LOG
name|'LOG'
op|'='
name|'logging'
op|'.'
name|'getLogger'
op|'('
name|'__name__'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|VMWARE_POWER_STATES
name|'VMWARE_POWER_STATES'
op|'='
op|'{'
nl|'\n'
string|"'poweredOff'"
op|':'
name|'power_state'
op|'.'
name|'SHUTDOWN'
op|','
nl|'\n'
string|"'poweredOn'"
op|':'
name|'power_state'
op|'.'
name|'RUNNING'
op|','
nl|'\n'
string|"'suspended'"
op|':'
name|'power_state'
op|'.'
name|'SUSPENDED'
op|'}'
newline|'\n'
DECL|variable|VMWARE_PREFIX
name|'VMWARE_PREFIX'
op|'='
string|"'vmware'"
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|RESIZE_TOTAL_STEPS
name|'RESIZE_TOTAL_STEPS'
op|'='
number|'4'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|VMwareVMOps
name|'class'
name|'VMwareVMOps'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Management class for VM-related tasks."""'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'session'
op|','
name|'virtapi'
op|','
name|'volumeops'
op|','
name|'cluster_name'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Initializer."""'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'='
name|'compute'
op|'.'
name|'API'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'='
name|'session'
newline|'\n'
name|'self'
op|'.'
name|'_virtapi'
op|'='
name|'virtapi'
newline|'\n'
name|'self'
op|'.'
name|'_volumeops'
op|'='
name|'volumeops'
newline|'\n'
name|'if'
name|'not'
name|'cluster_name'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_cluster'
op|'='
name|'None'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_cluster'
op|'='
name|'vm_util'
op|'.'
name|'get_cluster_ref_from_name'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|','
name|'cluster_name'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_instance_path_base'
op|'='
name|'VMWARE_PREFIX'
op|'+'
name|'CONF'
op|'.'
name|'base_dir_name'
newline|'\n'
name|'self'
op|'.'
name|'_default_root_device'
op|'='
string|"'vda'"
newline|'\n'
name|'self'
op|'.'
name|'_rescue_suffix'
op|'='
string|"'-rescue'"
newline|'\n'
name|'self'
op|'.'
name|'_poll_rescue_last_ran'
op|'='
name|'None'
newline|'\n'
nl|'\n'
DECL|member|list_instances
dedent|''
name|'def'
name|'list_instances'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Lists the VM instances that are registered with the ESX host."""'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Getting list of instances"'
op|')'
op|')'
newline|'\n'
name|'vms'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
string|'"get_objects"'
op|','
nl|'\n'
string|'"VirtualMachine"'
op|','
nl|'\n'
op|'['
string|'"name"'
op|','
string|'"runtime.connectionState"'
op|']'
op|')'
newline|'\n'
name|'lst_vm_names'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'vm'
name|'in'
name|'vms'
op|':'
newline|'\n'
indent|'            '
name|'vm_name'
op|'='
name|'None'
newline|'\n'
name|'conn_state'
op|'='
name|'None'
newline|'\n'
name|'for'
name|'prop'
name|'in'
name|'vm'
op|'.'
name|'propSet'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'prop'
op|'.'
name|'name'
op|'=='
string|'"name"'
op|':'
newline|'\n'
indent|'                    '
name|'vm_name'
op|'='
name|'prop'
op|'.'
name|'val'
newline|'\n'
dedent|''
name|'elif'
name|'prop'
op|'.'
name|'name'
op|'=='
string|'"runtime.connectionState"'
op|':'
newline|'\n'
indent|'                    '
name|'conn_state'
op|'='
name|'prop'
op|'.'
name|'val'
newline|'\n'
comment|'# Ignoring the orphaned or inaccessible VMs'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'conn_state'
name|'not'
name|'in'
op|'['
string|'"orphaned"'
op|','
string|'"inaccessible"'
op|']'
op|':'
newline|'\n'
indent|'                '
name|'lst_vm_names'
op|'.'
name|'append'
op|'('
name|'vm_name'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Got total of %s instances"'
op|')'
op|'%'
name|'str'
op|'('
name|'len'
op|'('
name|'lst_vm_names'
op|')'
op|')'
op|')'
newline|'\n'
name|'return'
name|'lst_vm_names'
newline|'\n'
nl|'\n'
DECL|member|spawn
dedent|''
name|'def'
name|'spawn'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'image_meta'
op|','
name|'network_info'
op|','
nl|'\n'
name|'block_device_info'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Creates a VM instance.\n\n        Steps followed are:\n\n        1. Create a VM with no disk and the specifics in the instance object\n           like RAM size.\n        2. For flat disk\n          2.1. Create a dummy vmdk of the size of the disk file that is to be\n               uploaded. This is required just to create the metadata file.\n          2.2. Delete the -flat.vmdk file created in the above step and retain\n               the metadata .vmdk file.\n          2.3. Upload the disk file.\n        3. For sparse disk\n          3.1. Upload the disk file to a -sparse.vmdk file.\n          3.2. Copy/Clone the -sparse.vmdk file to a thin vmdk.\n          3.3. Delete the -sparse.vmdk file.\n        4. Attach the disk to the VM by reconfiguring the same.\n        5. Power on the VM.\n        """'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceExists'
op|'('
name|'name'
op|'='
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'client_factory'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|'.'
name|'client'
op|'.'
name|'factory'
newline|'\n'
name|'service_content'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|'.'
name|'get_service_content'
op|'('
op|')'
newline|'\n'
name|'ds'
op|'='
name|'vm_util'
op|'.'
name|'get_datastore_ref_and_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'self'
op|'.'
name|'_cluster'
op|')'
newline|'\n'
name|'data_store_ref'
op|'='
name|'ds'
op|'['
number|'0'
op|']'
newline|'\n'
name|'data_store_name'
op|'='
name|'ds'
op|'['
number|'1'
op|']'
newline|'\n'
nl|'\n'
DECL|function|_get_image_properties
name|'def'
name|'_get_image_properties'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
string|'"""\n            Get the Size of the flat vmdk file that is there on the storage\n            repository.\n            """'
newline|'\n'
name|'_image_info'
op|'='
name|'vmware_images'
op|'.'
name|'get_vmdk_size_and_properties'
op|'('
name|'context'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'image_ref'"
op|']'
op|','
nl|'\n'
name|'instance'
op|')'
newline|'\n'
name|'image_size'
op|','
name|'image_properties'
op|'='
name|'_image_info'
newline|'\n'
name|'vmdk_file_size_in_kb'
op|'='
name|'int'
op|'('
name|'image_size'
op|')'
op|'/'
number|'1024'
newline|'\n'
name|'os_type'
op|'='
name|'image_properties'
op|'.'
name|'get'
op|'('
string|'"vmware_ostype"'
op|','
string|'"otherGuest"'
op|')'
newline|'\n'
name|'adapter_type'
op|'='
name|'image_properties'
op|'.'
name|'get'
op|'('
string|'"vmware_adaptertype"'
op|','
nl|'\n'
string|'"lsiLogic"'
op|')'
newline|'\n'
name|'disk_type'
op|'='
name|'image_properties'
op|'.'
name|'get'
op|'('
string|'"vmware_disktype"'
op|','
nl|'\n'
string|'"preallocated"'
op|')'
newline|'\n'
name|'return'
name|'vmdk_file_size_in_kb'
op|','
name|'os_type'
op|','
name|'adapter_type'
op|','
name|'disk_type'
newline|'\n'
nl|'\n'
dedent|''
op|'('
name|'vmdk_file_size_in_kb'
op|','
name|'os_type'
op|','
name|'adapter_type'
op|','
nl|'\n'
name|'disk_type'
op|')'
op|'='
name|'_get_image_properties'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'vm_folder_ref'
op|'='
name|'self'
op|'.'
name|'_get_vmfolder_ref'
op|'('
op|')'
newline|'\n'
name|'res_pool_ref'
op|'='
name|'self'
op|'.'
name|'_get_res_pool_ref'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|_check_if_network_bridge_exists
name|'def'
name|'_check_if_network_bridge_exists'
op|'('
name|'network_name'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'network_ref'
op|'='
name|'network_util'
op|'.'
name|'get_network_with_the_name'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|','
name|'network_name'
op|','
name|'self'
op|'.'
name|'_cluster'
op|')'
newline|'\n'
name|'if'
name|'network_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'exception'
op|'.'
name|'NetworkNotFoundForBridge'
op|'('
name|'bridge'
op|'='
name|'network_name'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'network_ref'
newline|'\n'
nl|'\n'
DECL|function|_get_vif_infos
dedent|''
name|'def'
name|'_get_vif_infos'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'vif_infos'
op|'='
op|'['
op|']'
newline|'\n'
name|'if'
name|'network_info'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'vif_infos'
newline|'\n'
dedent|''
name|'for'
name|'vif'
name|'in'
name|'network_info'
op|':'
newline|'\n'
indent|'                '
name|'mac_address'
op|'='
name|'vif'
op|'['
string|"'address'"
op|']'
newline|'\n'
name|'network_name'
op|'='
name|'vif'
op|'['
string|"'network'"
op|']'
op|'['
string|"'bridge'"
op|']'
name|'or'
name|'CONF'
op|'.'
name|'vmware'
op|'.'
name|'integration_bridge'
newline|'\n'
name|'if'
name|'vif'
op|'['
string|"'network'"
op|']'
op|'.'
name|'get_meta'
op|'('
string|"'should_create_vlan'"
op|','
name|'False'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'network_ref'
op|'='
name|'vmwarevif'
op|'.'
name|'ensure_vlan_bridge'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|','
name|'vif'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_cluster'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'network_ref'
op|'='
name|'_check_if_network_bridge_exists'
op|'('
name|'network_name'
op|')'
newline|'\n'
dedent|''
name|'vif_infos'
op|'.'
name|'append'
op|'('
op|'{'
string|"'network_name'"
op|':'
name|'network_name'
op|','
nl|'\n'
string|"'mac_address'"
op|':'
name|'mac_address'
op|','
nl|'\n'
string|"'network_ref'"
op|':'
name|'network_ref'
op|','
nl|'\n'
string|"'iface_id'"
op|':'
name|'vif'
op|'.'
name|'get_meta'
op|'('
string|"'iface_id'"
op|')'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'vif_infos'
newline|'\n'
nl|'\n'
dedent|''
name|'vif_infos'
op|'='
name|'_get_vif_infos'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# Get the create vm config spec'
nl|'\n'
name|'config_spec'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_create_spec'
op|'('
nl|'\n'
name|'client_factory'
op|','
name|'instance'
op|','
nl|'\n'
name|'data_store_name'
op|','
name|'vif_infos'
op|','
name|'os_type'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_execute_create_vm
name|'def'
name|'_execute_create_vm'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
string|'"""Create VM on ESX host."""'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Creating VM on the ESX host"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
comment|'# Create the VM on the ESX host'
nl|'\n'
name|'vm_create_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"CreateVM_Task"'
op|','
name|'vm_folder_ref'
op|','
nl|'\n'
name|'config'
op|'='
name|'config_spec'
op|','
name|'pool'
op|'='
name|'res_pool_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'vm_create_task'
op|')'
newline|'\n'
nl|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Created VM on the ESX host"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'_execute_create_vm'
op|'('
op|')'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
nl|'\n'
comment|'# Set the machine.id parameter of the instance to inject'
nl|'\n'
comment|'# the NIC configuration inside the VM'
nl|'\n'
name|'if'
name|'CONF'
op|'.'
name|'flat_injected'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_set_machine_id'
op|'('
name|'client_factory'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
newline|'\n'
nl|'\n'
comment|'# Set the vnc configuration of the instance, vnc port starts from 5900'
nl|'\n'
dedent|''
name|'if'
name|'CONF'
op|'.'
name|'vnc_enabled'
op|':'
newline|'\n'
indent|'            '
name|'vnc_port'
op|'='
name|'self'
op|'.'
name|'_get_vnc_port'
op|'('
name|'vm_ref'
op|')'
newline|'\n'
name|'vnc_pass'
op|'='
name|'CONF'
op|'.'
name|'vnc_password'
name|'or'
string|"''"
newline|'\n'
name|'self'
op|'.'
name|'_set_vnc_config'
op|'('
name|'client_factory'
op|','
name|'instance'
op|','
name|'vnc_port'
op|','
name|'vnc_pass'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_create_virtual_disk
dedent|''
name|'def'
name|'_create_virtual_disk'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
string|'"""Create a virtual disk of the size of flat vmdk file."""'
newline|'\n'
comment|'# Create a Virtual Disk of the size of the flat vmdk file. This is'
nl|'\n'
comment|'# done just to generate the meta-data file whose specifics'
nl|'\n'
comment|'# depend on the size of the disk, thin/thick provisioning and the'
nl|'\n'
comment|'# storage adapter type.'
nl|'\n'
comment|'# Here we assume thick provisioning and lsiLogic for the adapter'
nl|'\n'
comment|'# type'
nl|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Creating Virtual Disk of size  "'
nl|'\n'
string|'"%(vmdk_file_size_in_kb)s KB and adapter type "'
nl|'\n'
string|'"%(adapter_type)s on the ESX host local store "'
nl|'\n'
string|'"%(data_store_name)s"'
op|')'
op|'%'
nl|'\n'
op|'{'
string|'"vmdk_file_size_in_kb"'
op|':'
name|'vmdk_file_size_in_kb'
op|','
nl|'\n'
string|'"adapter_type"'
op|':'
name|'adapter_type'
op|','
nl|'\n'
string|'"data_store_name"'
op|':'
name|'data_store_name'
op|'}'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'vmdk_create_spec'
op|'='
name|'vm_util'
op|'.'
name|'get_vmdk_create_spec'
op|'('
name|'client_factory'
op|','
nl|'\n'
name|'vmdk_file_size_in_kb'
op|','
name|'adapter_type'
op|','
nl|'\n'
name|'disk_type'
op|')'
newline|'\n'
name|'vmdk_create_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"CreateVirtualDisk_Task"'
op|','
nl|'\n'
name|'service_content'
op|'.'
name|'virtualDiskManager'
op|','
nl|'\n'
name|'name'
op|'='
name|'uploaded_vmdk_path'
op|','
nl|'\n'
name|'datacenter'
op|'='
name|'dc_ref'
op|','
nl|'\n'
name|'spec'
op|'='
name|'vmdk_create_spec'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'vmdk_create_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Created Virtual Disk of size %(vmdk_file_size_in_kb)s"'
nl|'\n'
string|'" KB and type %(disk_type)s on "'
nl|'\n'
string|'"the ESX host local store %(data_store_name)s"'
op|')'
op|'%'
nl|'\n'
op|'{'
string|'"vmdk_file_size_in_kb"'
op|':'
name|'vmdk_file_size_in_kb'
op|','
nl|'\n'
string|'"disk_type"'
op|':'
name|'disk_type'
op|','
nl|'\n'
string|'"data_store_name"'
op|':'
name|'data_store_name'
op|'}'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_delete_disk_file
dedent|''
name|'def'
name|'_delete_disk_file'
op|'('
name|'vmdk_path'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Deleting the file %(vmdk_path)s "'
nl|'\n'
string|'"on the ESX host local"'
nl|'\n'
string|'"store %(data_store_name)s"'
op|')'
op|'%'
nl|'\n'
op|'{'
string|'"vmdk_path"'
op|':'
name|'vmdk_path'
op|','
nl|'\n'
string|'"data_store_name"'
op|':'
name|'data_store_name'
op|'}'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
comment|'# Delete the vmdk file.'
nl|'\n'
name|'vmdk_delete_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"DeleteDatastoreFile_Task"'
op|','
nl|'\n'
name|'service_content'
op|'.'
name|'fileManager'
op|','
nl|'\n'
name|'name'
op|'='
name|'vmdk_path'
op|','
nl|'\n'
name|'datacenter'
op|'='
name|'dc_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'vmdk_delete_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Deleted the file %(vmdk_path)s on the "'
nl|'\n'
string|'"ESX host local store %(data_store_name)s"'
op|')'
op|'%'
nl|'\n'
op|'{'
string|'"vmdk_path"'
op|':'
name|'vmdk_path'
op|','
nl|'\n'
string|'"data_store_name"'
op|':'
name|'data_store_name'
op|'}'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_fetch_image_on_esx_datastore
dedent|''
name|'def'
name|'_fetch_image_on_esx_datastore'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
string|'"""Fetch image from Glance to ESX datastore."""'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Downloading image file data %(image_ref)s to the ESX "'
nl|'\n'
string|'"data store %(data_store_name)s"'
op|')'
op|'%'
nl|'\n'
op|'{'
string|"'image_ref'"
op|':'
name|'instance'
op|'['
string|"'image_ref'"
op|']'
op|','
nl|'\n'
string|"'data_store_name'"
op|':'
name|'data_store_name'
op|'}'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
comment|'# For flat disk, upload the -flat.vmdk file whose meta-data file'
nl|'\n'
comment|'# we just created above'
nl|'\n'
comment|'# For sparse disk, upload the -sparse.vmdk file to be copied into'
nl|'\n'
comment|'# a flat vmdk'
nl|'\n'
name|'upload_vmdk_name'
op|'='
name|'sparse_uploaded_vmdk_name'
name|'if'
name|'disk_type'
op|'=='
string|'"sparse"'
name|'else'
name|'flat_uploaded_vmdk_name'
newline|'\n'
name|'vmware_images'
op|'.'
name|'fetch_image'
op|'('
nl|'\n'
name|'context'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'image_ref'"
op|']'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
name|'host'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_host_ip'
op|','
nl|'\n'
name|'data_center_name'
op|'='
name|'self'
op|'.'
name|'_get_datacenter_ref_and_name'
op|'('
op|')'
op|'['
number|'1'
op|']'
op|','
nl|'\n'
name|'datastore_name'
op|'='
name|'data_store_name'
op|','
nl|'\n'
name|'cookies'
op|'='
name|'cookies'
op|','
nl|'\n'
name|'file_path'
op|'='
name|'upload_vmdk_name'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Downloaded image file data %(image_ref)s to "'
nl|'\n'
string|'"%(upload_vmdk_name)s on the ESX data store "'
nl|'\n'
string|'"%(data_store_name)s"'
op|')'
op|'%'
nl|'\n'
op|'{'
string|"'image_ref'"
op|':'
name|'instance'
op|'['
string|"'image_ref'"
op|']'
op|','
nl|'\n'
string|"'upload_vmdk_name'"
op|':'
name|'upload_vmdk_name'
op|','
nl|'\n'
string|"'data_store_name'"
op|':'
name|'data_store_name'
op|'}'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_copy_virtual_disk
dedent|''
name|'def'
name|'_copy_virtual_disk'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
string|'"""Copy a sparse virtual disk to a thin virtual disk."""'
newline|'\n'
comment|'# Copy a sparse virtual disk to a thin virtual disk. This is also'
nl|'\n'
comment|'# done to generate the meta-data file whose specifics'
nl|'\n'
comment|'# depend on the size of the disk, thin/thick provisioning and the'
nl|'\n'
comment|'# storage adapter type.'
nl|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Copying Virtual Disk of size "'
nl|'\n'
string|'"%(vmdk_file_size_in_kb)s KB and adapter type "'
nl|'\n'
string|'"%(adapter_type)s on the ESX host local store "'
nl|'\n'
string|'"%(data_store_name)s to disk type %(disk_type)s"'
op|')'
op|'%'
nl|'\n'
op|'{'
string|'"vmdk_file_size_in_kb"'
op|':'
name|'vmdk_file_size_in_kb'
op|','
nl|'\n'
string|'"adapter_type"'
op|':'
name|'adapter_type'
op|','
nl|'\n'
string|'"data_store_name"'
op|':'
name|'data_store_name'
op|','
nl|'\n'
string|'"disk_type"'
op|':'
name|'disk_type'
op|'}'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'vmdk_copy_spec'
op|'='
name|'vm_util'
op|'.'
name|'get_vmdk_create_spec'
op|'('
name|'client_factory'
op|','
nl|'\n'
name|'vmdk_file_size_in_kb'
op|','
name|'adapter_type'
op|','
nl|'\n'
name|'disk_type'
op|')'
newline|'\n'
name|'vmdk_copy_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"CopyVirtualDisk_Task"'
op|','
nl|'\n'
name|'service_content'
op|'.'
name|'virtualDiskManager'
op|','
nl|'\n'
name|'sourceName'
op|'='
name|'sparse_uploaded_vmdk_path'
op|','
nl|'\n'
name|'sourceDatacenter'
op|'='
name|'self'
op|'.'
name|'_get_datacenter_ref_and_name'
op|'('
op|')'
op|'['
number|'0'
op|']'
op|','
nl|'\n'
name|'destName'
op|'='
name|'uploaded_vmdk_path'
op|','
nl|'\n'
name|'destSpec'
op|'='
name|'vmdk_copy_spec'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'vmdk_copy_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Copied Virtual Disk of size %(vmdk_file_size_in_kb)s"'
nl|'\n'
string|'" KB and type %(disk_type)s on "'
nl|'\n'
string|'"the ESX host local store %(data_store_name)s"'
op|')'
op|'%'
nl|'\n'
op|'{'
string|'"vmdk_file_size_in_kb"'
op|':'
name|'vmdk_file_size_in_kb'
op|','
nl|'\n'
string|'"disk_type"'
op|':'
name|'disk_type'
op|','
nl|'\n'
string|'"data_store_name"'
op|':'
name|'data_store_name'
op|'}'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'ebs_root'
op|'='
name|'block_device'
op|'.'
name|'volume_in_mapping'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_default_root_device'
op|','
name|'block_device_info'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'not'
name|'ebs_root'
op|':'
newline|'\n'
indent|'            '
name|'linked_clone'
op|'='
name|'CONF'
op|'.'
name|'use_linked_clone'
newline|'\n'
name|'if'
name|'linked_clone'
op|':'
newline|'\n'
indent|'                '
name|'upload_folder'
op|'='
name|'self'
op|'.'
name|'_instance_path_base'
newline|'\n'
name|'upload_name'
op|'='
name|'instance'
op|'['
string|"'image_ref'"
op|']'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'upload_folder'
op|'='
name|'instance'
op|'['
string|"'name'"
op|']'
newline|'\n'
name|'upload_name'
op|'='
name|'instance'
op|'['
string|"'name'"
op|']'
newline|'\n'
nl|'\n'
comment|'# The vmdk meta-data file'
nl|'\n'
dedent|''
name|'uploaded_vmdk_name'
op|'='
string|'"%s/%s.vmdk"'
op|'%'
op|'('
name|'upload_folder'
op|','
name|'upload_name'
op|')'
newline|'\n'
name|'uploaded_vmdk_path'
op|'='
name|'vm_util'
op|'.'
name|'build_datastore_path'
op|'('
name|'data_store_name'
op|','
nl|'\n'
name|'uploaded_vmdk_name'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'not'
op|'('
name|'linked_clone'
name|'and'
name|'self'
op|'.'
name|'_check_if_folder_file_exists'
op|'('
nl|'\n'
name|'data_store_ref'
op|','
name|'data_store_name'
op|','
nl|'\n'
name|'upload_folder'
op|','
name|'upload_name'
op|'+'
string|'".vmdk"'
op|')'
op|')'
op|':'
newline|'\n'
nl|'\n'
comment|'# Naming the VM files in correspondence with the VM instance'
nl|'\n'
comment|'# The flat vmdk file name'
nl|'\n'
indent|'                '
name|'flat_uploaded_vmdk_name'
op|'='
string|'"%s/%s-flat.vmdk"'
op|'%'
op|'('
nl|'\n'
name|'upload_folder'
op|','
name|'upload_name'
op|')'
newline|'\n'
comment|'# The sparse vmdk file name for sparse disk image'
nl|'\n'
name|'sparse_uploaded_vmdk_name'
op|'='
string|'"%s/%s-sparse.vmdk"'
op|'%'
op|'('
nl|'\n'
name|'upload_folder'
op|','
name|'upload_name'
op|')'
newline|'\n'
nl|'\n'
name|'flat_uploaded_vmdk_path'
op|'='
name|'vm_util'
op|'.'
name|'build_datastore_path'
op|'('
nl|'\n'
name|'data_store_name'
op|','
nl|'\n'
name|'flat_uploaded_vmdk_name'
op|')'
newline|'\n'
name|'sparse_uploaded_vmdk_path'
op|'='
name|'vm_util'
op|'.'
name|'build_datastore_path'
op|'('
nl|'\n'
name|'data_store_name'
op|','
nl|'\n'
name|'sparse_uploaded_vmdk_name'
op|')'
newline|'\n'
name|'dc_ref'
op|'='
name|'self'
op|'.'
name|'_get_datacenter_ref_and_name'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
name|'if'
name|'disk_type'
op|'!='
string|'"sparse"'
op|':'
newline|'\n'
comment|'# Create a flat virtual disk and retain the metadata file.'
nl|'\n'
indent|'                    '
name|'_create_virtual_disk'
op|'('
op|')'
newline|'\n'
name|'_delete_disk_file'
op|'('
name|'flat_uploaded_vmdk_path'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'cookies'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|'.'
name|'client'
op|'.'
name|'options'
op|'.'
name|'transport'
op|'.'
name|'cookiejar'
newline|'\n'
name|'_fetch_image_on_esx_datastore'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'disk_type'
op|'=='
string|'"sparse"'
op|':'
newline|'\n'
comment|'# Copy the sparse virtual disk to a thin virtual disk.'
nl|'\n'
indent|'                    '
name|'disk_type'
op|'='
string|'"thin"'
newline|'\n'
name|'_copy_virtual_disk'
op|'('
op|')'
newline|'\n'
name|'_delete_disk_file'
op|'('
name|'sparse_uploaded_vmdk_path'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
comment|'# linked clone base disk exists'
nl|'\n'
indent|'                '
name|'if'
name|'disk_type'
op|'=='
string|'"sparse"'
op|':'
newline|'\n'
indent|'                    '
name|'disk_type'
op|'='
string|'"thin"'
newline|'\n'
nl|'\n'
comment|'# Attach the vmdk uploaded to the VM.'
nl|'\n'
dedent|''
dedent|''
name|'self'
op|'.'
name|'_volumeops'
op|'.'
name|'attach_disk_to_vm'
op|'('
nl|'\n'
name|'vm_ref'
op|','
name|'instance'
op|','
nl|'\n'
name|'adapter_type'
op|','
name|'disk_type'
op|','
name|'uploaded_vmdk_path'
op|','
nl|'\n'
name|'vmdk_file_size_in_kb'
op|','
name|'linked_clone'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
comment|'# Attach the root disk to the VM.'
nl|'\n'
indent|'            '
name|'root_disk'
op|'='
name|'driver'
op|'.'
name|'block_device_info_get_mapping'
op|'('
nl|'\n'
name|'block_device_info'
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'connection_info'
op|'='
name|'root_disk'
op|'['
string|"'connection_info'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'_volumeops'
op|'.'
name|'attach_volume'
op|'('
name|'connection_info'
op|','
name|'instance'
op|'['
string|"'name'"
op|']'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_default_root_device'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_power_on_vm
dedent|''
name|'def'
name|'_power_on_vm'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
string|'"""Power on the VM."""'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Powering on the VM instance"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
comment|'# Power On the VM'
nl|'\n'
name|'power_on_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"PowerOnVM_Task"'
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'power_on_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Powered on the VM instance"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
dedent|''
name|'_power_on_vm'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|snapshot
dedent|''
name|'def'
name|'snapshot'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'snapshot_name'
op|','
name|'update_task_state'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Create snapshot from a running VM instance.\n\n        Steps followed are:\n\n        1. Get the name of the vmdk file which the VM points to right now.\n           Can be a chain of snapshots, so we need to know the last in the\n           chain.\n        2. Create the snapshot. A new vmdk is created which the VM points to\n           now. The earlier vmdk becomes read-only.\n        3. Call CopyVirtualDisk which coalesces the disk chain to form a single\n           vmdk, rather a .vmdk metadata file and a -flat.vmdk disk data file.\n        4. Now upload the -flat.vmdk file to the image store.\n        5. Delete the coalesced .vmdk and -flat.vmdk created.\n        """'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'client_factory'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|'.'
name|'client'
op|'.'
name|'factory'
newline|'\n'
name|'service_content'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|'.'
name|'get_service_content'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|_get_vm_and_vmdk_attribs
name|'def'
name|'_get_vm_and_vmdk_attribs'
op|'('
op|')'
op|':'
newline|'\n'
comment|'# Get the vmdk file name that the VM is pointing to'
nl|'\n'
indent|'            '
name|'hardware_devices'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
nl|'\n'
string|'"get_dynamic_property"'
op|','
name|'vm_ref'
op|','
nl|'\n'
string|'"VirtualMachine"'
op|','
string|'"config.hardware.device"'
op|')'
newline|'\n'
op|'('
name|'vmdk_file_path_before_snapshot'
op|','
name|'controller_key'
op|','
name|'adapter_type'
op|','
nl|'\n'
name|'disk_type'
op|','
name|'unit_number'
op|')'
op|'='
name|'vm_util'
op|'.'
name|'get_vmdk_path_and_adapter_type'
op|'('
nl|'\n'
name|'hardware_devices'
op|')'
newline|'\n'
name|'datastore_name'
op|'='
name|'vm_util'
op|'.'
name|'split_datastore_path'
op|'('
nl|'\n'
name|'vmdk_file_path_before_snapshot'
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'os_type'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
nl|'\n'
string|'"get_dynamic_property"'
op|','
name|'vm_ref'
op|','
nl|'\n'
string|'"VirtualMachine"'
op|','
string|'"summary.config.guestId"'
op|')'
newline|'\n'
name|'return'
op|'('
name|'vmdk_file_path_before_snapshot'
op|','
name|'adapter_type'
op|','
name|'disk_type'
op|','
nl|'\n'
name|'datastore_name'
op|','
name|'os_type'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'('
name|'vmdk_file_path_before_snapshot'
op|','
name|'adapter_type'
op|','
name|'disk_type'
op|','
nl|'\n'
name|'datastore_name'
op|','
name|'os_type'
op|')'
op|'='
name|'_get_vm_and_vmdk_attribs'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|_create_vm_snapshot
name|'def'
name|'_create_vm_snapshot'
op|'('
op|')'
op|':'
newline|'\n'
comment|'# Create a snapshot of the VM'
nl|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Creating Snapshot of the VM instance"'
op|')'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'snapshot_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"CreateSnapshot_Task"'
op|','
name|'vm_ref'
op|','
nl|'\n'
name|'name'
op|'='
string|'"%s-snapshot"'
op|'%'
name|'instance'
op|'['
string|"'name'"
op|']'
op|','
nl|'\n'
name|'description'
op|'='
string|'"Taking Snapshot of the VM"'
op|','
nl|'\n'
name|'memory'
op|'='
name|'False'
op|','
nl|'\n'
name|'quiesce'
op|'='
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'snapshot_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Created Snapshot of the VM instance"'
op|')'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'_create_vm_snapshot'
op|'('
op|')'
newline|'\n'
name|'update_task_state'
op|'('
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'IMAGE_PENDING_UPLOAD'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_check_if_tmp_folder_exists
name|'def'
name|'_check_if_tmp_folder_exists'
op|'('
op|')'
op|':'
newline|'\n'
comment|'# Copy the contents of the VM that were there just before the'
nl|'\n'
comment|'# snapshot was taken'
nl|'\n'
indent|'            '
name|'ds_ref_ret'
op|'='
name|'vim_util'
op|'.'
name|'get_dynamic_property'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
name|'vm_ref'
op|','
nl|'\n'
string|'"VirtualMachine"'
op|','
nl|'\n'
string|'"datastore"'
op|')'
newline|'\n'
name|'if'
name|'ds_ref_ret'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'                '
name|'raise'
name|'exception'
op|'.'
name|'DatastoreNotFound'
op|'('
op|')'
newline|'\n'
dedent|''
name|'ds_ref'
op|'='
name|'ds_ref_ret'
op|'.'
name|'ManagedObjectReference'
op|'['
number|'0'
op|']'
newline|'\n'
name|'ds_browser'
op|'='
name|'vim_util'
op|'.'
name|'get_dynamic_property'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
name|'ds_ref'
op|','
nl|'\n'
string|'"Datastore"'
op|','
nl|'\n'
string|'"browser"'
op|')'
newline|'\n'
comment|'# Check if the vmware-tmp folder exists or not. If not, create one'
nl|'\n'
name|'tmp_folder_path'
op|'='
name|'vm_util'
op|'.'
name|'build_datastore_path'
op|'('
name|'datastore_name'
op|','
nl|'\n'
string|'"vmware-tmp"'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'self'
op|'.'
name|'_path_exists'
op|'('
name|'ds_browser'
op|','
name|'tmp_folder_path'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'_mkdir'
op|'('
name|'vm_util'
op|'.'
name|'build_datastore_path'
op|'('
name|'datastore_name'
op|','
nl|'\n'
string|'"vmware-tmp"'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'_check_if_tmp_folder_exists'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# Generate a random vmdk file name to which the coalesced vmdk content'
nl|'\n'
comment|"# will be copied to. A random name is chosen so that we don't have"
nl|'\n'
comment|'# name clashes.'
nl|'\n'
name|'random_name'
op|'='
name|'str'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|')'
newline|'\n'
name|'dest_vmdk_file_location'
op|'='
name|'vm_util'
op|'.'
name|'build_datastore_path'
op|'('
name|'datastore_name'
op|','
nl|'\n'
string|'"vmware-tmp/%s.vmdk"'
op|'%'
name|'random_name'
op|')'
newline|'\n'
name|'dc_ref'
op|'='
name|'self'
op|'.'
name|'_get_datacenter_ref_and_name'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
DECL|function|_copy_vmdk_content
name|'def'
name|'_copy_vmdk_content'
op|'('
op|')'
op|':'
newline|'\n'
comment|'# Copy the contents of the disk ( or disks, if there were snapshots'
nl|'\n'
comment|'# done earlier) to a temporary vmdk file.'
nl|'\n'
indent|'            '
name|'copy_spec'
op|'='
name|'vm_util'
op|'.'
name|'get_copy_virtual_disk_spec'
op|'('
name|'client_factory'
op|','
nl|'\n'
name|'adapter_type'
op|','
nl|'\n'
name|'disk_type'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|"'Copying disk data before snapshot of the VM'"
op|')'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'copy_disk_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"CopyVirtualDisk_Task"'
op|','
nl|'\n'
name|'service_content'
op|'.'
name|'virtualDiskManager'
op|','
nl|'\n'
name|'sourceName'
op|'='
name|'vmdk_file_path_before_snapshot'
op|','
nl|'\n'
name|'sourceDatacenter'
op|'='
name|'dc_ref'
op|','
nl|'\n'
name|'destName'
op|'='
name|'dest_vmdk_file_location'
op|','
nl|'\n'
name|'destDatacenter'
op|'='
name|'dc_ref'
op|','
nl|'\n'
name|'destSpec'
op|'='
name|'copy_spec'
op|','
nl|'\n'
name|'force'
op|'='
name|'False'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'copy_disk_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Copied disk data before snapshot of the VM"'
op|')'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'_copy_vmdk_content'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'cookies'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|'.'
name|'client'
op|'.'
name|'options'
op|'.'
name|'transport'
op|'.'
name|'cookiejar'
newline|'\n'
nl|'\n'
DECL|function|_upload_vmdk_to_image_repository
name|'def'
name|'_upload_vmdk_to_image_repository'
op|'('
op|')'
op|':'
newline|'\n'
comment|'# Upload the contents of -flat.vmdk file which has the disk data.'
nl|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Uploading image %s"'
op|')'
op|'%'
name|'snapshot_name'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'vmware_images'
op|'.'
name|'upload_image'
op|'('
nl|'\n'
name|'context'
op|','
nl|'\n'
name|'snapshot_name'
op|','
nl|'\n'
name|'instance'
op|','
nl|'\n'
name|'os_type'
op|'='
name|'os_type'
op|','
nl|'\n'
name|'adapter_type'
op|'='
name|'adapter_type'
op|','
nl|'\n'
name|'image_version'
op|'='
number|'1'
op|','
nl|'\n'
name|'host'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_host_ip'
op|','
nl|'\n'
name|'data_center_name'
op|'='
name|'self'
op|'.'
name|'_get_datacenter_ref_and_name'
op|'('
op|')'
op|'['
number|'1'
op|']'
op|','
nl|'\n'
name|'datastore_name'
op|'='
name|'datastore_name'
op|','
nl|'\n'
name|'cookies'
op|'='
name|'cookies'
op|','
nl|'\n'
name|'file_path'
op|'='
string|'"vmware-tmp/%s-flat.vmdk"'
op|'%'
name|'random_name'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Uploaded image %s"'
op|')'
op|'%'
name|'snapshot_name'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'update_task_state'
op|'('
name|'task_state'
op|'='
name|'task_states'
op|'.'
name|'IMAGE_UPLOADING'
op|','
nl|'\n'
name|'expected_state'
op|'='
name|'task_states'
op|'.'
name|'IMAGE_PENDING_UPLOAD'
op|')'
newline|'\n'
name|'_upload_vmdk_to_image_repository'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|function|_clean_temp_data
name|'def'
name|'_clean_temp_data'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
string|'"""\n            Delete temporary vmdk files generated in image handling\n            operations.\n            """'
newline|'\n'
comment|'# Delete the temporary vmdk created above.'
nl|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Deleting temporary vmdk file %s"'
op|')'
nl|'\n'
op|'%'
name|'dest_vmdk_file_location'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'remove_disk_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"DeleteVirtualDisk_Task"'
op|','
nl|'\n'
name|'service_content'
op|'.'
name|'virtualDiskManager'
op|','
nl|'\n'
name|'name'
op|'='
name|'dest_vmdk_file_location'
op|','
nl|'\n'
name|'datacenter'
op|'='
name|'dc_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'remove_disk_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Deleted temporary vmdk file %s"'
op|')'
nl|'\n'
op|'%'
name|'dest_vmdk_file_location'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'_clean_temp_data'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|reboot
dedent|''
name|'def'
name|'reboot'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Reboot a VM instance."""'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'plug_vifs'
op|'('
name|'instance'
op|','
name|'network_info'
op|')'
newline|'\n'
nl|'\n'
name|'lst_properties'
op|'='
op|'['
string|'"summary.guest.toolsStatus"'
op|','
string|'"runtime.powerState"'
op|','
nl|'\n'
string|'"summary.guest.toolsRunningStatus"'
op|']'
newline|'\n'
name|'props'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
string|'"get_object_properties"'
op|','
nl|'\n'
name|'None'
op|','
name|'vm_ref'
op|','
string|'"VirtualMachine"'
op|','
nl|'\n'
name|'lst_properties'
op|')'
newline|'\n'
name|'pwr_state'
op|'='
name|'None'
newline|'\n'
name|'tools_status'
op|'='
name|'None'
newline|'\n'
name|'tools_running_status'
op|'='
name|'False'
newline|'\n'
name|'for'
name|'elem'
name|'in'
name|'props'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'prop'
name|'in'
name|'elem'
op|'.'
name|'propSet'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'prop'
op|'.'
name|'name'
op|'=='
string|'"runtime.powerState"'
op|':'
newline|'\n'
indent|'                    '
name|'pwr_state'
op|'='
name|'prop'
op|'.'
name|'val'
newline|'\n'
dedent|''
name|'elif'
name|'prop'
op|'.'
name|'name'
op|'=='
string|'"summary.guest.toolsStatus"'
op|':'
newline|'\n'
indent|'                    '
name|'tools_status'
op|'='
name|'prop'
op|'.'
name|'val'
newline|'\n'
dedent|''
name|'elif'
name|'prop'
op|'.'
name|'name'
op|'=='
string|'"summary.guest.toolsRunningStatus"'
op|':'
newline|'\n'
indent|'                    '
name|'tools_running_status'
op|'='
name|'prop'
op|'.'
name|'val'
newline|'\n'
nl|'\n'
comment|'# Raise an exception if the VM is not powered On.'
nl|'\n'
dedent|''
dedent|''
dedent|''
name|'if'
name|'pwr_state'
name|'not'
name|'in'
op|'['
string|'"poweredOn"'
op|']'
op|':'
newline|'\n'
indent|'            '
name|'reason'
op|'='
name|'_'
op|'('
string|'"instance is not powered on"'
op|')'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'InstanceRebootFailure'
op|'('
name|'reason'
op|'='
name|'reason'
op|')'
newline|'\n'
nl|'\n'
comment|'# If latest vmware tools are installed in the VM, and that the tools'
nl|'\n'
comment|'# are running, then only do a guest reboot. Otherwise do a hard reset.'
nl|'\n'
dedent|''
name|'if'
op|'('
name|'tools_status'
op|'=='
string|'"toolsOk"'
name|'and'
nl|'\n'
name|'tools_running_status'
op|'=='
string|'"guestToolsRunning"'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Rebooting guest OS of VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
string|'"RebootGuest"'
op|','
nl|'\n'
name|'vm_ref'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Rebooted guest OS of VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Doing hard reboot of VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'reset_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"ResetVM_Task"'
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'reset_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Did hard reboot of VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_delete
dedent|''
dedent|''
name|'def'
name|'_delete'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Destroy a VM instance. Steps followed are:\n        1. Power off the VM, if it is in poweredOn state.\n        2. Destroy the VM.\n        """'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"instance not present"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'return'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'power_off'
op|'('
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Destroying the VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'destroy_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"Destroy_Task"'
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'destroy_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Destroyed the VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|','
name|'excep'
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'warn'
op|'('
name|'_'
op|'('
string|'"In vmwareapi:vmops:delete, got this exception"'
nl|'\n'
string|'" while destroying the VM: %s"'
op|')'
op|'%'
name|'str'
op|'('
name|'excep'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'network_info'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'unplug_vifs'
op|'('
name|'instance'
op|','
name|'network_info'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'Exception'
op|','
name|'exc'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'exception'
op|'('
name|'exc'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|destroy
dedent|''
dedent|''
name|'def'
name|'destroy'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'network_info'
op|','
name|'destroy_disks'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Destroy a VM instance. Steps followed are:\n        1. Power off the VM, if it is in poweredOn state.\n        2. Un-register a VM.\n        3. Delete the contents of the folder holding the VM related data.\n        """'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"instance not present"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'return'
newline|'\n'
dedent|''
name|'lst_properties'
op|'='
op|'['
string|'"config.files.vmPathName"'
op|','
string|'"runtime.powerState"'
op|']'
newline|'\n'
name|'props'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
nl|'\n'
string|'"get_object_properties"'
op|','
nl|'\n'
name|'None'
op|','
name|'vm_ref'
op|','
string|'"VirtualMachine"'
op|','
name|'lst_properties'
op|')'
newline|'\n'
name|'pwr_state'
op|'='
name|'None'
newline|'\n'
name|'for'
name|'elem'
name|'in'
name|'props'
op|':'
newline|'\n'
indent|'                '
name|'vm_config_pathname'
op|'='
name|'None'
newline|'\n'
name|'for'
name|'prop'
name|'in'
name|'elem'
op|'.'
name|'propSet'
op|':'
newline|'\n'
indent|'                    '
name|'if'
name|'prop'
op|'.'
name|'name'
op|'=='
string|'"runtime.powerState"'
op|':'
newline|'\n'
indent|'                        '
name|'pwr_state'
op|'='
name|'prop'
op|'.'
name|'val'
newline|'\n'
dedent|''
name|'elif'
name|'prop'
op|'.'
name|'name'
op|'=='
string|'"config.files.vmPathName"'
op|':'
newline|'\n'
indent|'                        '
name|'vm_config_pathname'
op|'='
name|'prop'
op|'.'
name|'val'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'if'
name|'vm_config_pathname'
op|':'
newline|'\n'
indent|'                '
name|'_ds_path'
op|'='
name|'vm_util'
op|'.'
name|'split_datastore_path'
op|'('
name|'vm_config_pathname'
op|')'
newline|'\n'
name|'datastore_name'
op|','
name|'vmx_file_path'
op|'='
name|'_ds_path'
newline|'\n'
comment|'# Power off the VM if it is in PoweredOn state.'
nl|'\n'
dedent|''
name|'if'
name|'pwr_state'
op|'=='
string|'"poweredOn"'
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Powering off the VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'poweroff_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"PowerOffVM_Task"'
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'poweroff_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Powered off the VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
comment|'# Un-register the VM'
nl|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Unregistering the VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"UnregisterVM"'
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Unregistered the VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|','
name|'excep'
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'warn'
op|'('
name|'_'
op|'('
string|'"In vmwareapi:vmops:destroy, got this exception"'
nl|'\n'
string|'" while un-registering the VM: %s"'
op|')'
op|'%'
name|'str'
op|'('
name|'excep'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'network_info'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'unplug_vifs'
op|'('
name|'instance'
op|','
name|'network_info'
op|')'
newline|'\n'
nl|'\n'
comment|'# Delete the folder holding the VM related content on'
nl|'\n'
comment|'# the datastore.'
nl|'\n'
dedent|''
name|'if'
name|'destroy_disks'
op|':'
newline|'\n'
indent|'                '
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'dir_ds_compliant_path'
op|'='
name|'vm_util'
op|'.'
name|'build_datastore_path'
op|'('
nl|'\n'
name|'datastore_name'
op|','
nl|'\n'
name|'os'
op|'.'
name|'path'
op|'.'
name|'dirname'
op|'('
name|'vmx_file_path'
op|')'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Deleting contents of the VM from "'
nl|'\n'
string|'"datastore %(datastore_name)s"'
op|')'
op|'%'
nl|'\n'
op|'{'
string|"'datastore_name'"
op|':'
name|'datastore_name'
op|'}'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'vim'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
newline|'\n'
name|'delete_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'vim'
op|','
nl|'\n'
string|'"DeleteDatastoreFile_Task"'
op|','
nl|'\n'
name|'vim'
op|'.'
name|'get_service_content'
op|'('
op|')'
op|'.'
name|'fileManager'
op|','
nl|'\n'
name|'name'
op|'='
name|'dir_ds_compliant_path'
op|','
nl|'\n'
name|'datacenter'
op|'='
name|'self'
op|'.'
name|'_get_datacenter_ref_and_name'
op|'('
op|')'
op|'['
number|'0'
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'delete_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Deleted contents of the VM from "'
nl|'\n'
string|'"datastore %(datastore_name)s"'
op|')'
op|'%'
nl|'\n'
op|'{'
string|"'datastore_name'"
op|':'
name|'datastore_name'
op|'}'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|','
name|'excep'
op|':'
newline|'\n'
indent|'                    '
name|'LOG'
op|'.'
name|'warn'
op|'('
name|'_'
op|'('
string|'"In vmwareapi:vmops:destroy, "'
nl|'\n'
string|'"got this exception while deleting"'
nl|'\n'
string|'" the VM contents from the disk: %s"'
op|')'
nl|'\n'
op|'%'
name|'str'
op|'('
name|'excep'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'except'
name|'Exception'
op|','
name|'exc'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'exception'
op|'('
name|'exc'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|pause
dedent|''
dedent|''
name|'def'
name|'pause'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'msg'
op|'='
name|'_'
op|'('
string|'"pause not supported for vmwareapi"'
op|')'
newline|'\n'
name|'raise'
name|'NotImplementedError'
op|'('
name|'msg'
op|')'
newline|'\n'
nl|'\n'
DECL|member|unpause
dedent|''
name|'def'
name|'unpause'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'msg'
op|'='
name|'_'
op|'('
string|'"unpause not supported for vmwareapi"'
op|')'
newline|'\n'
name|'raise'
name|'NotImplementedError'
op|'('
name|'msg'
op|')'
newline|'\n'
nl|'\n'
DECL|member|suspend
dedent|''
name|'def'
name|'suspend'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Suspend the specified instance."""'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'pwr_state'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
nl|'\n'
string|'"get_dynamic_property"'
op|','
name|'vm_ref'
op|','
nl|'\n'
string|'"VirtualMachine"'
op|','
string|'"runtime.powerState"'
op|')'
newline|'\n'
comment|'# Only PoweredOn VMs can be suspended.'
nl|'\n'
name|'if'
name|'pwr_state'
op|'=='
string|'"poweredOn"'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Suspending the VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'suspend_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"SuspendVM_Task"'
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'suspend_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Suspended the VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
comment|'# Raise Exception if VM is poweredOff'
nl|'\n'
dedent|''
name|'elif'
name|'pwr_state'
op|'=='
string|'"poweredOff"'
op|':'
newline|'\n'
indent|'            '
name|'reason'
op|'='
name|'_'
op|'('
string|'"instance is powered off and cannot be suspended."'
op|')'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'InstanceSuspendFailure'
op|'('
name|'reason'
op|'='
name|'reason'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"VM was already in suspended state. So returning "'
nl|'\n'
string|'"without doing anything"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|resume
dedent|''
dedent|''
name|'def'
name|'resume'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Resume the specified instance."""'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'pwr_state'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
nl|'\n'
string|'"get_dynamic_property"'
op|','
name|'vm_ref'
op|','
nl|'\n'
string|'"VirtualMachine"'
op|','
string|'"runtime.powerState"'
op|')'
newline|'\n'
name|'if'
name|'pwr_state'
op|'.'
name|'lower'
op|'('
op|')'
op|'=='
string|'"suspended"'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Resuming the VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'suspend_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"PowerOnVM_Task"'
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'suspend_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Resumed the VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'reason'
op|'='
name|'_'
op|'('
string|'"instance is not in a suspended state"'
op|')'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'InstanceResumeFailure'
op|'('
name|'reason'
op|'='
name|'reason'
op|')'
newline|'\n'
nl|'\n'
DECL|member|rescue
dedent|''
dedent|''
name|'def'
name|'rescue'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'network_info'
op|','
name|'image_meta'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Rescue the specified instance.\n\n            - shutdown the instance VM.\n            - spawn a rescue VM (the vm name-label will be instance-N-rescue).\n\n        """'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'power_off'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'instance'
op|'['
string|"'name'"
op|']'
op|'='
name|'instance'
op|'['
string|"'name'"
op|']'
op|'+'
name|'self'
op|'.'
name|'_rescue_suffix'
newline|'\n'
name|'self'
op|'.'
name|'spawn'
op|'('
name|'context'
op|','
name|'instance'
op|','
name|'image_meta'
op|','
name|'network_info'
op|')'
newline|'\n'
nl|'\n'
comment|'# Attach vmdk to the rescue VM'
nl|'\n'
name|'hardware_devices'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
nl|'\n'
string|'"get_dynamic_property"'
op|','
name|'vm_ref'
op|','
nl|'\n'
string|'"VirtualMachine"'
op|','
string|'"config.hardware.device"'
op|')'
newline|'\n'
name|'vmdk_path'
op|','
name|'controller_key'
op|','
name|'adapter_type'
op|','
name|'disk_type'
op|','
name|'unit_number'
op|'='
name|'vm_util'
op|'.'
name|'get_vmdk_path_and_adapter_type'
op|'('
name|'hardware_devices'
op|')'
newline|'\n'
comment|'# Figure out the correct unit number'
nl|'\n'
name|'unit_number'
op|'='
name|'unit_number'
op|'+'
number|'1'
newline|'\n'
name|'rescue_vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_volumeops'
op|'.'
name|'attach_disk_to_vm'
op|'('
nl|'\n'
name|'rescue_vm_ref'
op|','
name|'instance'
op|','
nl|'\n'
name|'adapter_type'
op|','
name|'disk_type'
op|','
name|'vmdk_path'
op|','
nl|'\n'
name|'controller_key'
op|'='
name|'controller_key'
op|','
nl|'\n'
name|'unit_number'
op|'='
name|'unit_number'
op|')'
newline|'\n'
nl|'\n'
DECL|member|unrescue
dedent|''
name|'def'
name|'unrescue'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Unrescue the specified instance."""'
newline|'\n'
name|'instance_orig_name'
op|'='
name|'instance'
op|'['
string|"'name'"
op|']'
newline|'\n'
name|'instance'
op|'['
string|"'name'"
op|']'
op|'='
name|'instance'
op|'['
string|"'name'"
op|']'
op|'+'
name|'self'
op|'.'
name|'_rescue_suffix'
newline|'\n'
name|'self'
op|'.'
name|'destroy'
op|'('
name|'instance'
op|','
name|'None'
op|')'
newline|'\n'
name|'instance'
op|'['
string|"'name'"
op|']'
op|'='
name|'instance_orig_name'
newline|'\n'
name|'self'
op|'.'
name|'power_on'
op|'('
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|power_off
dedent|''
name|'def'
name|'power_off'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Power off the specified instance."""'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'pwr_state'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
nl|'\n'
string|'"get_dynamic_property"'
op|','
name|'vm_ref'
op|','
nl|'\n'
string|'"VirtualMachine"'
op|','
string|'"runtime.powerState"'
op|')'
newline|'\n'
comment|'# Only PoweredOn VMs can be powered off.'
nl|'\n'
name|'if'
name|'pwr_state'
op|'=='
string|'"poweredOn"'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Powering off the VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'poweroff_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"PowerOffVM_Task"'
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'poweroff_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Powered off the VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
comment|'# Raise Exception if VM is suspended'
nl|'\n'
dedent|''
name|'elif'
name|'pwr_state'
op|'=='
string|'"suspended"'
op|':'
newline|'\n'
indent|'            '
name|'reason'
op|'='
name|'_'
op|'('
string|'"instance is suspended and cannot be powered off."'
op|')'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'InstancePowerOffFailure'
op|'('
name|'reason'
op|'='
name|'reason'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"VM was already in powered off state. So returning "'
nl|'\n'
string|'"without doing anything"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|power_on
dedent|''
dedent|''
name|'def'
name|'power_on'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Power on the specified instance."""'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'pwr_state'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
nl|'\n'
string|'"get_dynamic_property"'
op|','
name|'vm_ref'
op|','
nl|'\n'
string|'"VirtualMachine"'
op|','
string|'"runtime.powerState"'
op|')'
newline|'\n'
name|'if'
name|'pwr_state'
op|'=='
string|'"poweredOn"'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"VM was already in powered on state. So returning "'
nl|'\n'
string|'"without doing anything"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
comment|'# Only PoweredOff and Suspended VMs can be powered on.'
nl|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Powering on the VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'poweron_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"PowerOnVM_Task"'
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'poweron_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Powered on the VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_orig_vm_name_label
dedent|''
dedent|''
name|'def'
name|'_get_orig_vm_name_label'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'instance'
op|'['
string|"'name'"
op|']'
op|'+'
string|"'-orig'"
newline|'\n'
nl|'\n'
DECL|member|_update_instance_progress
dedent|''
name|'def'
name|'_update_instance_progress'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'step'
op|','
name|'total_steps'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Update instance progress percent to reflect current step number\n        """'
newline|'\n'
comment|'# Divide the action\'s workflow into discrete steps and "bump" the'
nl|'\n'
comment|"# instance's progress field as each step is completed."
nl|'\n'
comment|'#'
nl|'\n'
comment|'# For a first cut this should be fine, however, for large VM images,'
nl|'\n'
comment|'# the clone disk step begins to dominate the equation. A'
nl|'\n'
comment|'# better approximation would use the percentage of the VM image that'
nl|'\n'
comment|'# has been streamed to the destination host.'
nl|'\n'
name|'progress'
op|'='
name|'round'
op|'('
name|'float'
op|'('
name|'step'
op|')'
op|'/'
name|'total_steps'
op|'*'
number|'100'
op|')'
newline|'\n'
name|'instance_uuid'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Updating instance \'%(instance_uuid)s\' progress to"'
nl|'\n'
string|'" %(progress)d"'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_virtapi'
op|'.'
name|'instance_update'
op|'('
name|'context'
op|','
name|'instance_uuid'
op|','
nl|'\n'
op|'{'
string|"'progress'"
op|':'
name|'progress'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|migrate_disk_and_power_off
dedent|''
name|'def'
name|'migrate_disk_and_power_off'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'dest'
op|','
nl|'\n'
name|'instance_type'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Transfers the disk of a running instance in multiple phases, turning\n        off the instance before the end.\n        """'
newline|'\n'
comment|'# 0. Zero out the progress to begin'
nl|'\n'
name|'self'
op|'.'
name|'_update_instance_progress'
op|'('
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'step'
op|'='
number|'0'
op|','
nl|'\n'
name|'total_steps'
op|'='
name|'RESIZE_TOTAL_STEPS'
op|')'
newline|'\n'
nl|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'host_ref'
op|'='
name|'self'
op|'.'
name|'_get_host_ref_from_name'
op|'('
name|'dest'
op|')'
newline|'\n'
name|'if'
name|'host_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'HostNotFound'
op|'('
name|'host'
op|'='
name|'dest'
op|')'
newline|'\n'
nl|'\n'
comment|'# 1. Power off the instance'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'power_off'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_update_instance_progress'
op|'('
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'step'
op|'='
number|'1'
op|','
nl|'\n'
name|'total_steps'
op|'='
name|'RESIZE_TOTAL_STEPS'
op|')'
newline|'\n'
nl|'\n'
comment|"# 2. Rename the original VM with suffix '-orig'"
nl|'\n'
name|'name_label'
op|'='
name|'self'
op|'.'
name|'_get_orig_vm_name_label'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Renaming the VM to %s"'
op|')'
op|'%'
name|'name_label'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'rename_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"Rename_Task"'
op|','
name|'vm_ref'
op|','
name|'newName'
op|'='
name|'name_label'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'rename_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Renamed the VM to %s"'
op|')'
op|'%'
name|'name_label'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_update_instance_progress'
op|'('
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'step'
op|'='
number|'2'
op|','
nl|'\n'
name|'total_steps'
op|'='
name|'RESIZE_TOTAL_STEPS'
op|')'
newline|'\n'
nl|'\n'
comment|'# Get the clone vm spec'
nl|'\n'
name|'ds_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_datastore_ref_and_name'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|','
name|'None'
op|','
name|'dest'
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'client_factory'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|'.'
name|'client'
op|'.'
name|'factory'
newline|'\n'
name|'rel_spec'
op|'='
name|'vm_util'
op|'.'
name|'relocate_vm_spec'
op|'('
name|'client_factory'
op|','
name|'ds_ref'
op|','
name|'host_ref'
op|')'
newline|'\n'
name|'clone_spec'
op|'='
name|'vm_util'
op|'.'
name|'clone_vm_spec'
op|'('
name|'client_factory'
op|','
name|'rel_spec'
op|')'
newline|'\n'
name|'vm_folder_ref'
op|'='
name|'self'
op|'.'
name|'_get_vmfolder_ref'
op|'('
op|')'
newline|'\n'
nl|'\n'
comment|'# 3. Clone VM on ESX host'
nl|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Cloning VM to host %s"'
op|')'
op|'%'
name|'dest'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'vm_clone_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"CloneVM_Task"'
op|','
name|'vm_ref'
op|','
nl|'\n'
name|'folder'
op|'='
name|'vm_folder_ref'
op|','
nl|'\n'
name|'name'
op|'='
name|'instance'
op|'['
string|"'name'"
op|']'
op|','
nl|'\n'
name|'spec'
op|'='
name|'clone_spec'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'vm_clone_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Cloned VM to host %s"'
op|')'
op|'%'
name|'dest'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_update_instance_progress'
op|'('
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'step'
op|'='
number|'3'
op|','
nl|'\n'
name|'total_steps'
op|'='
name|'RESIZE_TOTAL_STEPS'
op|')'
newline|'\n'
nl|'\n'
DECL|member|confirm_migration
dedent|''
name|'def'
name|'confirm_migration'
op|'('
name|'self'
op|','
name|'migration'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Confirms a resize, destroying the source VM."""'
newline|'\n'
name|'instance_name'
op|'='
name|'self'
op|'.'
name|'_get_orig_vm_name_label'
op|'('
name|'instance'
op|')'
newline|'\n'
comment|'# Destroy the original VM.'
nl|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance_name'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"instance not present"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'return'
newline|'\n'
nl|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Destroying the VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'destroy_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"Destroy_Task"'
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'destroy_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Destroyed the VM"'
op|')'
op|','
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|','
name|'excep'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'warn'
op|'('
name|'_'
op|'('
string|'"In vmwareapi:vmops:confirm_migration, got this "'
nl|'\n'
string|'"exception while destroying the VM: %s"'
op|')'
op|'%'
name|'str'
op|'('
name|'excep'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'network_info'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'unplug_vifs'
op|'('
name|'instance'
op|','
name|'network_info'
op|')'
newline|'\n'
nl|'\n'
DECL|member|finish_revert_migration
dedent|''
dedent|''
name|'def'
name|'finish_revert_migration'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Finish reverting a resize, powering back on the instance."""'
newline|'\n'
comment|"# The original vm was suffixed with '-orig'; find it using"
nl|'\n'
comment|'# the old suffix, remove the suffix, then power it back on.'
nl|'\n'
name|'name_label'
op|'='
name|'self'
op|'.'
name|'_get_orig_vm_name_label'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'name_label'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'name_label'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Renaming the VM from %s"'
op|')'
op|'%'
name|'name_label'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'rename_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"Rename_Task"'
op|','
name|'vm_ref'
op|','
name|'newName'
op|'='
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'rename_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Renamed the VM from %s"'
op|')'
op|'%'
name|'name_label'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'power_on'
op|'('
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|finish_migration
dedent|''
name|'def'
name|'finish_migration'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'migration'
op|','
name|'instance'
op|','
name|'disk_info'
op|','
nl|'\n'
name|'network_info'
op|','
name|'image_meta'
op|','
name|'resize_instance'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Completes a resize, turning on the migrated instance."""'
newline|'\n'
comment|'# 4. Start VM'
nl|'\n'
name|'self'
op|'.'
name|'power_on'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_update_instance_progress'
op|'('
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
name|'step'
op|'='
number|'4'
op|','
nl|'\n'
name|'total_steps'
op|'='
name|'RESIZE_TOTAL_STEPS'
op|')'
newline|'\n'
nl|'\n'
DECL|member|live_migration
dedent|''
name|'def'
name|'live_migration'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance_ref'
op|','
name|'dest'
op|','
nl|'\n'
name|'post_method'
op|','
name|'recover_method'
op|','
name|'block_migration'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Spawning live_migration operation for distributing high-load."""'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance_ref'
op|'.'
name|'name'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance_ref'
op|'.'
name|'name'
op|')'
newline|'\n'
dedent|''
name|'host_ref'
op|'='
name|'self'
op|'.'
name|'_get_host_ref_from_name'
op|'('
name|'dest'
op|')'
newline|'\n'
name|'if'
name|'host_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'HostNotFound'
op|'('
name|'host'
op|'='
name|'dest'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Migrating VM to host %s"'
op|')'
op|'%'
name|'dest'
op|','
name|'instance'
op|'='
name|'instance_ref'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'vm_migrate_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"MigrateVM_Task"'
op|','
name|'vm_ref'
op|','
nl|'\n'
name|'host'
op|'='
name|'host_ref'
op|','
nl|'\n'
name|'priority'
op|'='
string|'"defaultPriority"'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance_ref'
op|'['
string|"'uuid'"
op|']'
op|','
name|'vm_migrate_task'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'Exception'
op|':'
newline|'\n'
indent|'            '
name|'with'
name|'excutils'
op|'.'
name|'save_and_reraise_exception'
op|'('
op|')'
op|':'
newline|'\n'
indent|'                '
name|'recover_method'
op|'('
name|'context'
op|','
name|'instance_ref'
op|','
name|'dest'
op|','
name|'block_migration'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'post_method'
op|'('
name|'context'
op|','
name|'instance_ref'
op|','
name|'dest'
op|','
name|'block_migration'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Migrated VM to host %s"'
op|')'
op|'%'
name|'dest'
op|','
name|'instance'
op|'='
name|'instance_ref'
op|')'
newline|'\n'
nl|'\n'
DECL|member|poll_rebooting_instances
dedent|''
name|'def'
name|'poll_rebooting_instances'
op|'('
name|'self'
op|','
name|'timeout'
op|','
name|'instances'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Poll for rebooting instances."""'
newline|'\n'
name|'ctxt'
op|'='
name|'nova_context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'instances_info'
op|'='
name|'dict'
op|'('
name|'instance_count'
op|'='
name|'len'
op|'('
name|'instances'
op|')'
op|','
nl|'\n'
name|'timeout'
op|'='
name|'timeout'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'instances_info'
op|'['
string|'"instance_count"'
op|']'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|'"Found %(instance_count)d hung reboots "'
nl|'\n'
string|'"older than %(timeout)d seconds"'
op|')'
op|'%'
name|'instances_info'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'for'
name|'instance'
name|'in'
name|'instances'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|'"Automatically hard rebooting %d"'
op|')'
op|'%'
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'compute_api'
op|'.'
name|'reboot'
op|'('
name|'ctxt'
op|','
name|'instance'
op|','
string|'"HARD"'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_info
dedent|''
dedent|''
name|'def'
name|'get_info'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return data about the VM instance."""'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'lst_properties'
op|'='
op|'['
string|'"summary.config.numCpu"'
op|','
nl|'\n'
string|'"summary.config.memorySizeMB"'
op|','
nl|'\n'
string|'"runtime.powerState"'
op|']'
newline|'\n'
name|'vm_props'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
nl|'\n'
string|'"get_object_properties"'
op|','
name|'None'
op|','
name|'vm_ref'
op|','
string|'"VirtualMachine"'
op|','
nl|'\n'
name|'lst_properties'
op|')'
newline|'\n'
name|'max_mem'
op|'='
name|'None'
newline|'\n'
name|'pwr_state'
op|'='
name|'None'
newline|'\n'
name|'num_cpu'
op|'='
name|'None'
newline|'\n'
name|'for'
name|'elem'
name|'in'
name|'vm_props'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'prop'
name|'in'
name|'elem'
op|'.'
name|'propSet'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'prop'
op|'.'
name|'name'
op|'=='
string|'"summary.config.numCpu"'
op|':'
newline|'\n'
indent|'                    '
name|'num_cpu'
op|'='
name|'int'
op|'('
name|'prop'
op|'.'
name|'val'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'prop'
op|'.'
name|'name'
op|'=='
string|'"summary.config.memorySizeMB"'
op|':'
newline|'\n'
comment|'# In MB, but we want in KB'
nl|'\n'
indent|'                    '
name|'max_mem'
op|'='
name|'int'
op|'('
name|'prop'
op|'.'
name|'val'
op|')'
op|'*'
number|'1024'
newline|'\n'
dedent|''
name|'elif'
name|'prop'
op|'.'
name|'name'
op|'=='
string|'"runtime.powerState"'
op|':'
newline|'\n'
indent|'                    '
name|'pwr_state'
op|'='
name|'VMWARE_POWER_STATES'
op|'['
name|'prop'
op|'.'
name|'val'
op|']'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
name|'return'
op|'{'
string|"'state'"
op|':'
name|'pwr_state'
op|','
nl|'\n'
string|"'max_mem'"
op|':'
name|'max_mem'
op|','
nl|'\n'
string|"'mem'"
op|':'
name|'max_mem'
op|','
nl|'\n'
string|"'num_cpu'"
op|':'
name|'num_cpu'
op|','
nl|'\n'
string|"'cpu_time'"
op|':'
number|'0'
op|'}'
newline|'\n'
nl|'\n'
DECL|member|get_diagnostics
dedent|''
name|'def'
name|'get_diagnostics'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return data about VM diagnostics."""'
newline|'\n'
name|'msg'
op|'='
name|'_'
op|'('
string|'"get_diagnostics not implemented for vmwareapi"'
op|')'
newline|'\n'
name|'raise'
name|'NotImplementedError'
op|'('
name|'msg'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_console_output
dedent|''
name|'def'
name|'get_console_output'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return snapshot of console."""'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
dedent|''
name|'param_list'
op|'='
op|'{'
string|'"id"'
op|':'
name|'str'
op|'('
name|'vm_ref'
op|')'
op|'}'
newline|'\n'
name|'base_url'
op|'='
string|'"%s://%s/screen?%s"'
op|'%'
op|'('
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_scheme'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_host_ip'
op|','
nl|'\n'
name|'urllib'
op|'.'
name|'urlencode'
op|'('
name|'param_list'
op|')'
op|')'
newline|'\n'
name|'request'
op|'='
name|'urllib2'
op|'.'
name|'Request'
op|'('
name|'base_url'
op|')'
newline|'\n'
name|'base64string'
op|'='
name|'base64'
op|'.'
name|'encodestring'
op|'('
nl|'\n'
string|"'%s:%s'"
op|'%'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_host_username'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_host_password'
op|')'
op|')'
op|'.'
name|'replace'
op|'('
string|"'\\n'"
op|','
string|"''"
op|')'
newline|'\n'
name|'request'
op|'.'
name|'add_header'
op|'('
string|'"Authorization"'
op|','
string|'"Basic %s"'
op|'%'
name|'base64string'
op|')'
newline|'\n'
name|'result'
op|'='
name|'urllib2'
op|'.'
name|'urlopen'
op|'('
name|'request'
op|')'
newline|'\n'
name|'if'
name|'result'
op|'.'
name|'code'
op|'=='
number|'200'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'result'
op|'.'
name|'read'
op|'('
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
string|'""'
newline|'\n'
nl|'\n'
DECL|member|get_vnc_console
dedent|''
dedent|''
name|'def'
name|'get_vnc_console'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return connection info for a vnc console."""'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
op|'{'
string|"'host'"
op|':'
name|'CONF'
op|'.'
name|'vmwareapi_host_ip'
op|','
nl|'\n'
string|"'port'"
op|':'
name|'self'
op|'.'
name|'_get_vnc_port'
op|'('
name|'vm_ref'
op|')'
op|','
nl|'\n'
string|"'internal_access_path'"
op|':'
name|'None'
op|'}'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'staticmethod'
newline|'\n'
DECL|member|_get_vnc_port
name|'def'
name|'_get_vnc_port'
op|'('
name|'vm_ref'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return VNC port for an VM."""'
newline|'\n'
name|'vm_id'
op|'='
name|'int'
op|'('
name|'vm_ref'
op|'.'
name|'value'
op|'.'
name|'replace'
op|'('
string|"'vm-'"
op|','
string|"''"
op|')'
op|')'
newline|'\n'
name|'port'
op|'='
name|'CONF'
op|'.'
name|'vnc_port'
op|'+'
name|'vm_id'
op|'%'
name|'CONF'
op|'.'
name|'vnc_port_total'
newline|'\n'
nl|'\n'
name|'return'
name|'port'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'staticmethod'
newline|'\n'
DECL|member|_get_machine_id_str
name|'def'
name|'_get_machine_id_str'
op|'('
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'machine_id_str'
op|'='
string|"''"
newline|'\n'
name|'for'
name|'vif'
name|'in'
name|'network_info'
op|':'
newline|'\n'
comment|'# TODO(vish): add support for dns2'
nl|'\n'
comment|'# TODO(sateesh): add support for injection of ipv6 configuration'
nl|'\n'
indent|'            '
name|'network'
op|'='
name|'vif'
op|'['
string|"'network'"
op|']'
newline|'\n'
name|'ip_v4'
op|'='
name|'netmask_v4'
op|'='
name|'gateway_v4'
op|'='
name|'broadcast_v4'
op|'='
name|'dns'
op|'='
name|'None'
newline|'\n'
name|'subnets_v4'
op|'='
op|'['
name|'s'
name|'for'
name|'s'
name|'in'
name|'network'
op|'['
string|"'subnets'"
op|']'
name|'if'
name|'s'
op|'['
string|"'version'"
op|']'
op|'=='
number|'4'
op|']'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'subnets_v4'
op|'['
number|'0'
op|']'
op|'['
string|"'ips'"
op|']'
op|')'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'                '
name|'ip_v4'
op|'='
name|'subnets_v4'
op|'['
number|'0'
op|']'
op|'['
string|"'ips'"
op|']'
op|'['
number|'0'
op|']'
newline|'\n'
dedent|''
name|'if'
name|'len'
op|'('
name|'subnets_v4'
op|'['
number|'0'
op|']'
op|'['
string|"'dns'"
op|']'
op|')'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'                '
name|'dns'
op|'='
name|'subnets_v4'
op|'['
number|'0'
op|']'
op|'['
string|"'dns'"
op|']'
op|'['
number|'0'
op|']'
op|'['
string|"'address'"
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'netmask_v4'
op|'='
name|'str'
op|'('
name|'subnets_v4'
op|'['
number|'0'
op|']'
op|'.'
name|'as_netaddr'
op|'('
op|')'
op|'.'
name|'netmask'
op|')'
newline|'\n'
name|'gateway_v4'
op|'='
name|'subnets_v4'
op|'['
number|'0'
op|']'
op|'['
string|"'gateway'"
op|']'
op|'['
string|"'address'"
op|']'
newline|'\n'
name|'broadcast_v4'
op|'='
name|'str'
op|'('
name|'subnets_v4'
op|'['
number|'0'
op|']'
op|'.'
name|'as_netaddr'
op|'('
op|')'
op|'.'
name|'broadcast'
op|')'
newline|'\n'
nl|'\n'
name|'interface_str'
op|'='
string|'";"'
op|'.'
name|'join'
op|'('
op|'['
name|'vif'
op|'['
string|"'address'"
op|']'
op|','
nl|'\n'
name|'ip_v4'
name|'and'
name|'ip_v4'
op|'['
string|"'address'"
op|']'
name|'or'
string|"''"
op|','
nl|'\n'
name|'netmask_v4'
name|'or'
string|"''"
op|','
nl|'\n'
name|'gateway_v4'
name|'or'
string|"''"
op|','
nl|'\n'
name|'broadcast_v4'
name|'or'
string|"''"
op|','
nl|'\n'
name|'dns'
name|'or'
string|"''"
op|']'
op|')'
newline|'\n'
name|'machine_id_str'
op|'='
name|'machine_id_str'
op|'+'
name|'interface_str'
op|'+'
string|"'#'"
newline|'\n'
dedent|''
name|'return'
name|'machine_id_str'
newline|'\n'
nl|'\n'
DECL|member|_set_machine_id
dedent|''
name|'def'
name|'_set_machine_id'
op|'('
name|'self'
op|','
name|'client_factory'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Set the machine id of the VM for guest tools to pick up and reconfigure\n        the network interfaces.\n        """'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'machine_id_change_spec'
op|'='
name|'vm_util'
op|'.'
name|'get_machine_id_change_spec'
op|'('
nl|'\n'
name|'client_factory'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_get_machine_id_str'
op|'('
name|'network_info'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Reconfiguring VM instance to set the machine id"'
op|')'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'reconfig_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"ReconfigVM_Task"'
op|','
name|'vm_ref'
op|','
nl|'\n'
name|'spec'
op|'='
name|'machine_id_change_spec'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'reconfig_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Reconfigured VM instance to set the machine id"'
op|')'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_set_vnc_config
dedent|''
name|'def'
name|'_set_vnc_config'
op|'('
name|'self'
op|','
name|'client_factory'
op|','
name|'instance'
op|','
name|'port'
op|','
name|'password'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Set the vnc configuration of the VM.\n        """'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'vnc_config_spec'
op|'='
name|'vm_util'
op|'.'
name|'get_vnc_config_spec'
op|'('
nl|'\n'
name|'client_factory'
op|','
name|'port'
op|','
name|'password'
op|')'
newline|'\n'
nl|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Reconfiguring VM instance to enable vnc on "'
nl|'\n'
string|'"port - %(port)s"'
op|')'
op|'%'
op|'{'
string|"'port'"
op|':'
name|'port'
op|'}'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
name|'reconfig_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"ReconfigVM_Task"'
op|','
name|'vm_ref'
op|','
nl|'\n'
name|'spec'
op|'='
name|'vnc_config_spec'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_wait_for_task'
op|'('
name|'instance'
op|'['
string|"'uuid'"
op|']'
op|','
name|'reconfig_task'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Reconfigured VM instance to enable vnc on "'
nl|'\n'
string|'"port - %(port)s"'
op|')'
op|'%'
op|'{'
string|"'port'"
op|':'
name|'port'
op|'}'
op|','
nl|'\n'
name|'instance'
op|'='
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_datacenter_ref_and_name
dedent|''
name|'def'
name|'_get_datacenter_ref_and_name'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Get the datacenter name and the reference."""'
newline|'\n'
name|'dc_obj'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
string|'"get_objects"'
op|','
nl|'\n'
string|'"Datacenter"'
op|','
op|'['
string|'"name"'
op|']'
op|')'
newline|'\n'
name|'return'
name|'dc_obj'
op|'['
number|'0'
op|']'
op|'.'
name|'obj'
op|','
name|'dc_obj'
op|'['
number|'0'
op|']'
op|'.'
name|'propSet'
op|'['
number|'0'
op|']'
op|'.'
name|'val'
newline|'\n'
nl|'\n'
DECL|member|_get_host_ref_from_name
dedent|''
name|'def'
name|'_get_host_ref_from_name'
op|'('
name|'self'
op|','
name|'host_name'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Get reference to the host with the name specified."""'
newline|'\n'
name|'host_objs'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
string|'"get_objects"'
op|','
nl|'\n'
string|'"HostSystem"'
op|','
op|'['
string|'"name"'
op|']'
op|')'
newline|'\n'
name|'for'
name|'host'
name|'in'
name|'host_objs'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'host'
op|'.'
name|'propSet'
op|'['
number|'0'
op|']'
op|'.'
name|'val'
op|'=='
name|'host_name'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'host'
op|'.'
name|'obj'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'None'
newline|'\n'
nl|'\n'
DECL|member|_get_vmfolder_ref
dedent|''
name|'def'
name|'_get_vmfolder_ref'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Get the Vm folder ref from the datacenter."""'
newline|'\n'
name|'dc_objs'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
string|'"get_objects"'
op|','
nl|'\n'
string|'"Datacenter"'
op|','
op|'['
string|'"vmFolder"'
op|']'
op|')'
newline|'\n'
comment|'# There is only one default datacenter in a standalone ESX host'
nl|'\n'
name|'vm_folder_ref'
op|'='
name|'dc_objs'
op|'['
number|'0'
op|']'
op|'.'
name|'propSet'
op|'['
number|'0'
op|']'
op|'.'
name|'val'
newline|'\n'
name|'return'
name|'vm_folder_ref'
newline|'\n'
nl|'\n'
DECL|member|_get_res_pool_ref
dedent|''
name|'def'
name|'_get_res_pool_ref'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
comment|'# Get the resource pool. Taking the first resource pool coming our'
nl|'\n'
comment|'# way. Assuming that is the default resource pool.'
nl|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'_cluster'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'res_pool_ref'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
string|'"get_objects"'
op|','
nl|'\n'
string|'"ResourcePool"'
op|')'
op|'['
number|'0'
op|']'
op|'.'
name|'obj'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'res_pool_ref'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
nl|'\n'
string|'"get_dynamic_property"'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_cluster'
op|','
nl|'\n'
string|'"ClusterComputeResource"'
op|','
nl|'\n'
string|'"resourcePool"'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'res_pool_ref'
newline|'\n'
nl|'\n'
DECL|member|_path_exists
dedent|''
name|'def'
name|'_path_exists'
op|'('
name|'self'
op|','
name|'ds_browser'
op|','
name|'ds_path'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Check if the path exists on the datastore."""'
newline|'\n'
name|'search_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"SearchDatastore_Task"'
op|','
nl|'\n'
name|'ds_browser'
op|','
nl|'\n'
name|'datastorePath'
op|'='
name|'ds_path'
op|')'
newline|'\n'
comment|'# Wait till the state changes from queued or running.'
nl|'\n'
comment|"# If an error state is returned, it means that the path doesn't exist."
nl|'\n'
name|'while'
name|'True'
op|':'
newline|'\n'
indent|'            '
name|'task_info'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
nl|'\n'
string|'"get_dynamic_property"'
op|','
nl|'\n'
name|'search_task'
op|','
string|'"Task"'
op|','
string|'"info"'
op|')'
newline|'\n'
name|'if'
name|'task_info'
op|'.'
name|'state'
name|'in'
op|'['
string|"'queued'"
op|','
string|"'running'"
op|']'
op|':'
newline|'\n'
indent|'                '
name|'time'
op|'.'
name|'sleep'
op|'('
number|'2'
op|')'
newline|'\n'
name|'continue'
newline|'\n'
dedent|''
name|'break'
newline|'\n'
dedent|''
name|'if'
name|'task_info'
op|'.'
name|'state'
op|'=='
string|'"error"'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'False'
newline|'\n'
dedent|''
name|'return'
name|'True'
newline|'\n'
nl|'\n'
DECL|member|_path_file_exists
dedent|''
name|'def'
name|'_path_file_exists'
op|'('
name|'self'
op|','
name|'ds_browser'
op|','
name|'ds_path'
op|','
name|'file_name'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Check if the path and file exists on the datastore."""'
newline|'\n'
name|'client_factory'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|'.'
name|'client'
op|'.'
name|'factory'
newline|'\n'
name|'search_spec'
op|'='
name|'vm_util'
op|'.'
name|'search_datastore_spec'
op|'('
name|'client_factory'
op|','
name|'file_name'
op|')'
newline|'\n'
name|'search_task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
string|'"SearchDatastore_Task"'
op|','
nl|'\n'
name|'ds_browser'
op|','
nl|'\n'
name|'datastorePath'
op|'='
name|'ds_path'
op|','
nl|'\n'
name|'searchSpec'
op|'='
name|'search_spec'
op|')'
newline|'\n'
comment|'# Wait till the state changes from queued or running.'
nl|'\n'
comment|"# If an error state is returned, it means that the path doesn't exist."
nl|'\n'
name|'while'
name|'True'
op|':'
newline|'\n'
indent|'            '
name|'task_info'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
nl|'\n'
string|'"get_dynamic_property"'
op|','
nl|'\n'
name|'search_task'
op|','
string|'"Task"'
op|','
string|'"info"'
op|')'
newline|'\n'
name|'if'
name|'task_info'
op|'.'
name|'state'
name|'in'
op|'['
string|"'queued'"
op|','
string|"'running'"
op|']'
op|':'
newline|'\n'
indent|'                '
name|'time'
op|'.'
name|'sleep'
op|'('
number|'2'
op|')'
newline|'\n'
name|'continue'
newline|'\n'
dedent|''
name|'break'
newline|'\n'
dedent|''
name|'if'
name|'task_info'
op|'.'
name|'state'
op|'=='
string|'"error"'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'False'
op|','
name|'False'
newline|'\n'
nl|'\n'
dedent|''
name|'file_exists'
op|'='
op|'('
name|'getattr'
op|'('
name|'task_info'
op|'.'
name|'result'
op|','
string|"'file'"
op|','
name|'False'
op|')'
name|'and'
nl|'\n'
name|'task_info'
op|'.'
name|'result'
op|'.'
name|'file'
op|'['
number|'0'
op|']'
op|'.'
name|'path'
op|'=='
name|'file_name'
op|')'
newline|'\n'
name|'return'
name|'True'
op|','
name|'file_exists'
newline|'\n'
nl|'\n'
DECL|member|_mkdir
dedent|''
name|'def'
name|'_mkdir'
op|'('
name|'self'
op|','
name|'ds_path'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Creates a directory at the path specified. If it is just "NAME",\n        then a directory with this name is created at the topmost level of the\n        DataStore.\n        """'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Creating directory with path %s"'
op|')'
op|'%'
name|'ds_path'
op|')'
newline|'\n'
name|'dc_ref'
op|'='
name|'self'
op|'.'
name|'_get_datacenter_ref_and_name'
op|'('
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
string|'"MakeDirectory"'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|'.'
name|'get_service_content'
op|'('
op|')'
op|'.'
name|'fileManager'
op|','
nl|'\n'
name|'name'
op|'='
name|'ds_path'
op|','
name|'datacenter'
op|'='
name|'dc_ref'
op|','
nl|'\n'
name|'createParentDirectories'
op|'='
name|'False'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Created directory with path %s"'
op|')'
op|'%'
name|'ds_path'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_check_if_folder_file_exists
dedent|''
name|'def'
name|'_check_if_folder_file_exists'
op|'('
name|'self'
op|','
name|'ds_ref'
op|','
name|'ds_name'
op|','
nl|'\n'
name|'folder_name'
op|','
name|'file_name'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ds_browser'
op|'='
name|'vim_util'
op|'.'
name|'get_dynamic_property'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|','
nl|'\n'
name|'ds_ref'
op|','
nl|'\n'
string|'"Datastore"'
op|','
nl|'\n'
string|'"browser"'
op|')'
newline|'\n'
comment|'# Check if the folder exists or not. If not, create one'
nl|'\n'
comment|'# Check if the file exists or not.'
nl|'\n'
name|'folder_path'
op|'='
name|'vm_util'
op|'.'
name|'build_datastore_path'
op|'('
name|'ds_name'
op|','
name|'folder_name'
op|')'
newline|'\n'
name|'folder_exists'
op|','
name|'file_exists'
op|'='
name|'self'
op|'.'
name|'_path_file_exists'
op|'('
name|'ds_browser'
op|','
nl|'\n'
name|'folder_path'
op|','
nl|'\n'
name|'file_name'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'folder_exists'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_mkdir'
op|'('
name|'vm_util'
op|'.'
name|'build_datastore_path'
op|'('
name|'ds_name'
op|','
name|'folder_name'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'return'
name|'file_exists'
newline|'\n'
nl|'\n'
DECL|member|inject_network_info
dedent|''
name|'def'
name|'inject_network_info'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""inject network info for specified instance."""'
newline|'\n'
comment|'# Set the machine.id parameter of the instance to inject'
nl|'\n'
comment|'# the NIC configuration inside the VM'
nl|'\n'
name|'client_factory'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_get_vim'
op|'('
op|')'
op|'.'
name|'client'
op|'.'
name|'factory'
newline|'\n'
name|'self'
op|'.'
name|'_set_machine_id'
op|'('
name|'client_factory'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
newline|'\n'
nl|'\n'
DECL|member|plug_vifs
dedent|''
name|'def'
name|'plug_vifs'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Plug VIFs into networks."""'
newline|'\n'
name|'pass'
newline|'\n'
nl|'\n'
DECL|member|unplug_vifs
dedent|''
name|'def'
name|'unplug_vifs'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Unplug VIFs from networks."""'
newline|'\n'
name|'pass'
newline|'\n'
nl|'\n'
DECL|member|list_interfaces
dedent|''
name|'def'
name|'list_interfaces'
op|'('
name|'self'
op|','
name|'instance_name'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Return the IDs of all the virtual network interfaces attached to the\n        specified instance, as a list.  These IDs are opaque to the caller\n        (they are only useful for giving back to this layer as a parameter to\n        interface_stats).  These IDs only need to be unique for a given\n        instance.\n        """'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_util'
op|'.'
name|'get_vm_ref_from_name'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance_name'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotFound'
op|'('
name|'instance_id'
op|'='
name|'instance_name'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'interfaces'
op|'='
op|'['
op|']'
newline|'\n'
comment|'# Get the virtual network interfaces attached to the VM'
nl|'\n'
name|'hardware_devices'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'_call_method'
op|'('
name|'vim_util'
op|','
nl|'\n'
string|'"get_dynamic_property"'
op|','
name|'vm_ref'
op|','
nl|'\n'
string|'"VirtualMachine"'
op|','
string|'"config.hardware.device"'
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'device'
name|'in'
name|'hardware_devices'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'device'
op|'.'
name|'__class__'
op|'.'
name|'__name__'
name|'in'
op|'['
string|'"VirtualE1000"'
op|','
string|'"VirtualE1000e"'
op|','
nl|'\n'
string|'"VirtualPCNet32"'
op|','
string|'"VirtualVmxnet"'
op|']'
op|':'
newline|'\n'
indent|'                '
name|'interfaces'
op|'.'
name|'append'
op|'('
name|'device'
op|'.'
name|'key'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'return'
name|'interfaces'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
