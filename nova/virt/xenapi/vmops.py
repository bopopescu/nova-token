begin_unit
comment|'# vim: tabstop=4 shiftwidth=4 softtabstop=4'
nl|'\n'
nl|'\n'
comment|'# Copyright (c) 2010 Citrix Systems, Inc.'
nl|'\n'
comment|'# Copyright 2010 OpenStack LLC.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
string|'"""\nManagement class for VM-related functions (spawn, reboot, etc).\n"""'
newline|'\n'
nl|'\n'
name|'import'
name|'base64'
newline|'\n'
name|'import'
name|'json'
newline|'\n'
name|'import'
name|'M2Crypto'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'pickle'
newline|'\n'
name|'import'
name|'random'
newline|'\n'
name|'import'
name|'subprocess'
newline|'\n'
name|'import'
name|'sys'
newline|'\n'
name|'import'
name|'time'
newline|'\n'
name|'import'
name|'uuid'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
name|'import'
name|'context'
name|'as'
name|'nova_context'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'db'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'flags'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'ipv6'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'log'
name|'as'
name|'logging'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'utils'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
op|'.'
name|'compute'
name|'import'
name|'power_state'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
name|'import'
name|'driver'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'xenapi'
op|'.'
name|'network_utils'
name|'import'
name|'NetworkHelper'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'xenapi'
op|'.'
name|'vm_utils'
name|'import'
name|'VMHelper'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'xenapi'
op|'.'
name|'vm_utils'
name|'import'
name|'ImageType'
newline|'\n'
nl|'\n'
DECL|variable|XenAPI
name|'XenAPI'
op|'='
name|'None'
newline|'\n'
DECL|variable|LOG
name|'LOG'
op|'='
name|'logging'
op|'.'
name|'getLogger'
op|'('
string|'"nova.virt.xenapi.vmops"'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|FLAGS
name|'FLAGS'
op|'='
name|'flags'
op|'.'
name|'FLAGS'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_integer'
op|'('
string|"'windows_version_timeout'"
op|','
number|'300'
op|','
nl|'\n'
string|"'number of seconds to wait for windows agent to be '"
nl|'\n'
string|"'fully operational'"
op|')'
newline|'\n'
name|'flags'
op|'.'
name|'DEFINE_string'
op|'('
string|"'xenapi_vif_driver'"
op|','
nl|'\n'
string|"'nova.virt.xenapi.vif.XenAPIBridgeDriver'"
op|','
nl|'\n'
string|"'The XenAPI VIF driver using XenServer Network APIs.'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|cmp_version
name|'def'
name|'cmp_version'
op|'('
name|'a'
op|','
name|'b'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Compare two version strings (eg 0.0.1.10 > 0.0.1.9)"""'
newline|'\n'
name|'a'
op|'='
name|'a'
op|'.'
name|'split'
op|'('
string|"'.'"
op|')'
newline|'\n'
name|'b'
op|'='
name|'b'
op|'.'
name|'split'
op|'('
string|"'.'"
op|')'
newline|'\n'
nl|'\n'
comment|'# Compare each individual portion of both version strings'
nl|'\n'
name|'for'
name|'va'
op|','
name|'vb'
name|'in'
name|'zip'
op|'('
name|'a'
op|','
name|'b'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ret'
op|'='
name|'int'
op|'('
name|'va'
op|')'
op|'-'
name|'int'
op|'('
name|'vb'
op|')'
newline|'\n'
name|'if'
name|'ret'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'ret'
newline|'\n'
nl|'\n'
comment|'# Fallback to comparing length last'
nl|'\n'
dedent|''
dedent|''
name|'return'
name|'len'
op|'('
name|'a'
op|')'
op|'-'
name|'len'
op|'('
name|'b'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|VMOps
dedent|''
name|'class'
name|'VMOps'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Management class for VM-related tasks\n    """'
newline|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'session'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'XenAPI'
op|'='
name|'session'
op|'.'
name|'get_imported_xenapi'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'='
name|'session'
newline|'\n'
name|'self'
op|'.'
name|'poll_rescue_last_ran'
op|'='
name|'None'
newline|'\n'
name|'VMHelper'
op|'.'
name|'XenAPI'
op|'='
name|'self'
op|'.'
name|'XenAPI'
newline|'\n'
name|'self'
op|'.'
name|'vif_driver'
op|'='
name|'utils'
op|'.'
name|'import_object'
op|'('
name|'FLAGS'
op|'.'
name|'xenapi_vif_driver'
op|')'
newline|'\n'
nl|'\n'
DECL|member|list_instances
dedent|''
name|'def'
name|'list_instances'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""List VM instances."""'
newline|'\n'
comment|'# TODO(justinsb): Should we just always use the details method?'
nl|'\n'
comment|'#  Seems to be the same number of API calls..'
nl|'\n'
name|'vm_refs'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'vm_ref'
name|'in'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'get_xenapi'
op|'('
op|')'
op|'.'
name|'VM'
op|'.'
name|'get_all'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'vm_rec'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'get_xenapi'
op|'('
op|')'
op|'.'
name|'VM'
op|'.'
name|'get_record'
op|'('
name|'vm_ref'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'vm_rec'
op|'['
string|'"is_a_template"'
op|']'
name|'and'
name|'not'
name|'vm_rec'
op|'['
string|'"is_control_domain"'
op|']'
op|':'
newline|'\n'
indent|'                '
name|'vm_refs'
op|'.'
name|'append'
op|'('
name|'vm_rec'
op|'['
string|'"name_label"'
op|']'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'vm_refs'
newline|'\n'
nl|'\n'
DECL|member|list_instances_detail
dedent|''
name|'def'
name|'list_instances_detail'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""List VM instances, returning InstanceInfo objects."""'
newline|'\n'
name|'instance_infos'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'vm_ref'
name|'in'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'get_xenapi'
op|'('
op|')'
op|'.'
name|'VM'
op|'.'
name|'get_all'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'vm_rec'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'get_xenapi'
op|'('
op|')'
op|'.'
name|'VM'
op|'.'
name|'get_record'
op|'('
name|'vm_ref'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'vm_rec'
op|'['
string|'"is_a_template"'
op|']'
name|'and'
name|'not'
name|'vm_rec'
op|'['
string|'"is_control_domain"'
op|']'
op|':'
newline|'\n'
indent|'                '
name|'name'
op|'='
name|'vm_rec'
op|'['
string|'"name_label"'
op|']'
newline|'\n'
nl|'\n'
comment|'# TODO(justinsb): This a roundabout way to map the state'
nl|'\n'
name|'openstack_format'
op|'='
name|'VMHelper'
op|'.'
name|'compile_info'
op|'('
name|'vm_rec'
op|')'
newline|'\n'
name|'state'
op|'='
name|'openstack_format'
op|'['
string|"'state'"
op|']'
newline|'\n'
nl|'\n'
name|'instance_info'
op|'='
name|'driver'
op|'.'
name|'InstanceInfo'
op|'('
name|'name'
op|','
name|'state'
op|')'
newline|'\n'
name|'instance_infos'
op|'.'
name|'append'
op|'('
name|'instance_info'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'instance_infos'
newline|'\n'
nl|'\n'
DECL|member|revert_migration
dedent|''
name|'def'
name|'revert_migration'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'vm_ref'
op|'='
name|'VMHelper'
op|'.'
name|'lookup'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'.'
name|'name'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_start'
op|'('
name|'instance'
op|','
name|'vm_ref'
op|')'
newline|'\n'
nl|'\n'
DECL|member|finish_migration
dedent|''
name|'def'
name|'finish_migration'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'disk_info'
op|','
name|'network_info'
op|','
nl|'\n'
name|'resize_instance'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'vdi_uuid'
op|'='
name|'self'
op|'.'
name|'link_disks'
op|'('
name|'instance'
op|','
name|'disk_info'
op|'['
string|"'base_copy'"
op|']'
op|','
nl|'\n'
name|'disk_info'
op|'['
string|"'cow'"
op|']'
op|')'
newline|'\n'
name|'vm_ref'
op|'='
name|'self'
op|'.'
name|'_create_vm'
op|'('
name|'context'
op|','
name|'instance'
op|','
nl|'\n'
op|'['
name|'dict'
op|'('
name|'vdi_type'
op|'='
string|"'os'"
op|','
name|'vdi_uuid'
op|'='
name|'vdi_uuid'
op|')'
op|']'
op|','
nl|'\n'
name|'network_info'
op|')'
newline|'\n'
name|'if'
name|'resize_instance'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'resize_instance'
op|'('
name|'instance'
op|','
name|'vdi_uuid'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_start'
op|'('
name|'instance'
op|','
name|'vm_ref'
op|'='
name|'vm_ref'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_start
dedent|''
name|'def'
name|'_start'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'vm_ref'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Power on a VM instance"""'
newline|'\n'
name|'if'
name|'not'
name|'vm_ref'
op|':'
newline|'\n'
indent|'            '
name|'vm_ref'
op|'='
name|'VMHelper'
op|'.'
name|'lookup'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'.'
name|'name'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'Exception'
op|'('
name|'_'
op|'('
string|"'Attempted to power on non-existent instance'"
nl|'\n'
string|"' bad instance id %s'"
op|')'
op|'%'
name|'instance'
op|'.'
name|'id'
op|')'
newline|'\n'
dedent|''
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Starting instance %s"'
op|')'
op|','
name|'instance'
op|'.'
name|'name'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'VM.start'"
op|','
name|'vm_ref'
op|','
name|'False'
op|','
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_create_disks
dedent|''
name|'def'
name|'_create_disks'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'disk_image_type'
op|'='
name|'VMHelper'
op|'.'
name|'determine_disk_image_type'
op|'('
name|'instance'
op|','
name|'context'
op|')'
newline|'\n'
name|'vdis'
op|'='
name|'VMHelper'
op|'.'
name|'fetch_image'
op|'('
name|'context'
op|','
name|'self'
op|'.'
name|'_session'
op|','
nl|'\n'
name|'instance'
op|','
name|'instance'
op|'.'
name|'image_ref'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'user_id'
op|','
name|'instance'
op|'.'
name|'project_id'
op|','
nl|'\n'
name|'disk_image_type'
op|')'
newline|'\n'
name|'return'
name|'vdis'
newline|'\n'
nl|'\n'
DECL|member|spawn
dedent|''
name|'def'
name|'spawn'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'vdis'
op|'='
name|'None'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'vdis'
op|'='
name|'self'
op|'.'
name|'_create_disks'
op|'('
name|'context'
op|','
name|'instance'
op|')'
newline|'\n'
name|'vm_ref'
op|'='
name|'self'
op|'.'
name|'_create_vm'
op|'('
name|'context'
op|','
name|'instance'
op|','
name|'vdis'
op|','
name|'network_info'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_spawn'
op|'('
name|'instance'
op|','
name|'vm_ref'
op|')'
newline|'\n'
dedent|''
name|'except'
op|'('
name|'self'
op|'.'
name|'XenAPI'
op|'.'
name|'Failure'
op|','
name|'OSError'
op|','
name|'IOError'
op|')'
name|'as'
name|'spawn_error'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'exception'
op|'('
name|'_'
op|'('
string|'"instance %s: Failed to spawn"'
op|')'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'id'
op|','
name|'exc_info'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|"'Instance %s failed to spawn - performing clean-up'"
op|')'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'id'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_handle_spawn_error'
op|'('
name|'vdis'
op|','
name|'spawn_error'
op|')'
newline|'\n'
name|'raise'
name|'spawn_error'
newline|'\n'
nl|'\n'
DECL|member|spawn_rescue
dedent|''
dedent|''
name|'def'
name|'spawn_rescue'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Spawn a rescue instance."""'
newline|'\n'
name|'self'
op|'.'
name|'spawn'
op|'('
name|'context'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_create_vm
dedent|''
name|'def'
name|'_create_vm'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'vdis'
op|','
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Create VM instance."""'
newline|'\n'
name|'instance_name'
op|'='
name|'instance'
op|'.'
name|'name'
newline|'\n'
name|'vm_ref'
op|'='
name|'VMHelper'
op|'.'
name|'lookup'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance_name'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceExists'
op|'('
name|'name'
op|'='
name|'instance_name'
op|')'
newline|'\n'
nl|'\n'
comment|'#ensure enough free memory is available'
nl|'\n'
dedent|''
name|'if'
name|'not'
name|'VMHelper'
op|'.'
name|'ensure_free_mem'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'exception'
op|'('
name|'_'
op|'('
string|"'instance %(instance_name)s: not enough free '"
nl|'\n'
string|"'memory'"
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'instance_set_state'
op|'('
name|'nova_context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'id'"
op|']'
op|','
nl|'\n'
name|'power_state'
op|'.'
name|'SHUTDOWN'
op|')'
newline|'\n'
name|'return'
newline|'\n'
nl|'\n'
dedent|''
name|'disk_image_type'
op|'='
name|'VMHelper'
op|'.'
name|'determine_disk_image_type'
op|'('
name|'instance'
op|','
name|'context'
op|')'
newline|'\n'
name|'kernel'
op|'='
name|'None'
newline|'\n'
name|'ramdisk'
op|'='
name|'None'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'instance'
op|'.'
name|'kernel_id'
op|':'
newline|'\n'
indent|'                '
name|'kernel'
op|'='
name|'VMHelper'
op|'.'
name|'fetch_image'
op|'('
name|'context'
op|','
name|'self'
op|'.'
name|'_session'
op|','
nl|'\n'
name|'instance'
op|','
name|'instance'
op|'.'
name|'kernel_id'
op|','
name|'instance'
op|'.'
name|'user_id'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'project_id'
op|','
name|'ImageType'
op|'.'
name|'KERNEL'
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
dedent|''
name|'if'
name|'instance'
op|'.'
name|'ramdisk_id'
op|':'
newline|'\n'
indent|'                '
name|'ramdisk'
op|'='
name|'VMHelper'
op|'.'
name|'fetch_image'
op|'('
name|'context'
op|','
name|'self'
op|'.'
name|'_session'
op|','
nl|'\n'
name|'instance'
op|','
name|'instance'
op|'.'
name|'ramdisk_id'
op|','
name|'instance'
op|'.'
name|'user_id'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'project_id'
op|','
name|'ImageType'
op|'.'
name|'RAMDISK'
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
nl|'\n'
comment|"# NOTE(jk0): Since vdi_type may contain either 'os' or 'swap', we"
nl|'\n'
comment|"# need to ensure that the 'swap' VDI is not chosen as the mount"
nl|'\n'
comment|'# point for file injection.'
nl|'\n'
dedent|''
name|'first_vdi_ref'
op|'='
name|'None'
newline|'\n'
name|'for'
name|'vdi'
name|'in'
name|'vdis'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'vdi'
op|'.'
name|'get'
op|'('
string|"'vdi_type'"
op|')'
op|'!='
string|"'swap'"
op|':'
newline|'\n'
comment|'# Create the VM ref and attach the first disk'
nl|'\n'
indent|'                    '
name|'first_vdi_ref'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
nl|'\n'
string|"'VDI.get_by_uuid'"
op|','
name|'vdi'
op|'['
string|"'vdi_uuid'"
op|']'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'vm_mode'
op|'='
name|'instance'
op|'.'
name|'vm_mode'
name|'and'
name|'instance'
op|'.'
name|'vm_mode'
op|'.'
name|'lower'
op|'('
op|')'
newline|'\n'
name|'if'
name|'vm_mode'
op|'=='
string|"'pv'"
op|':'
newline|'\n'
indent|'                '
name|'use_pv_kernel'
op|'='
name|'True'
newline|'\n'
dedent|''
name|'elif'
name|'vm_mode'
name|'in'
op|'('
string|"'hv'"
op|','
string|"'hvm'"
op|')'
op|':'
newline|'\n'
indent|'                '
name|'use_pv_kernel'
op|'='
name|'False'
newline|'\n'
name|'vm_mode'
op|'='
string|"'hvm'"
comment|'# Normalize'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'use_pv_kernel'
op|'='
name|'VMHelper'
op|'.'
name|'determine_is_pv'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'id'
op|','
name|'first_vdi_ref'
op|','
name|'disk_image_type'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'os_type'
op|')'
newline|'\n'
name|'vm_mode'
op|'='
name|'use_pv_kernel'
name|'and'
string|"'pv'"
name|'or'
string|"'hvm'"
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'instance'
op|'.'
name|'vm_mode'
op|'!='
name|'vm_mode'
op|':'
newline|'\n'
comment|'# Update database with normalized (or determined) value'
nl|'\n'
indent|'                '
name|'db'
op|'.'
name|'instance_update'
op|'('
name|'nova_context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
op|','
nl|'\n'
name|'instance'
op|'['
string|"'id'"
op|']'
op|','
op|'{'
string|"'vm_mode'"
op|':'
name|'vm_mode'
op|'}'
op|')'
newline|'\n'
dedent|''
name|'vm_ref'
op|'='
name|'VMHelper'
op|'.'
name|'create_vm'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|','
nl|'\n'
name|'kernel'
name|'and'
name|'kernel'
op|'.'
name|'get'
op|'('
string|"'file'"
op|','
name|'None'
op|')'
name|'or'
name|'None'
op|','
nl|'\n'
name|'ramdisk'
name|'and'
name|'ramdisk'
op|'.'
name|'get'
op|'('
string|"'file'"
op|','
name|'None'
op|')'
name|'or'
name|'None'
op|','
nl|'\n'
name|'use_pv_kernel'
op|')'
newline|'\n'
dedent|''
name|'except'
op|'('
name|'self'
op|'.'
name|'XenAPI'
op|'.'
name|'Failure'
op|','
name|'OSError'
op|','
name|'IOError'
op|')'
name|'as'
name|'vm_create_error'
op|':'
newline|'\n'
comment|'# Collect VDI/file resources to clean up;'
nl|'\n'
comment|'# These resources will be removed by _handle_spawn_error.'
nl|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'exception'
op|'('
name|'_'
op|'('
string|'"instance %s: Failed to spawn - "'
op|'+'
nl|'\n'
string|'"Unable to create VM"'
op|')'
op|','
nl|'\n'
name|'instance'
op|'.'
name|'id'
op|','
name|'exc_info'
op|'='
name|'sys'
op|'.'
name|'exc_info'
op|'('
op|')'
op|')'
newline|'\n'
name|'last_arg'
op|'='
name|'None'
newline|'\n'
name|'resources'
op|'='
op|'['
op|']'
newline|'\n'
nl|'\n'
name|'if'
name|'vm_create_error'
op|'.'
name|'args'
op|':'
newline|'\n'
indent|'                '
name|'last_arg'
op|'='
name|'vm_create_error'
op|'.'
name|'args'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
dedent|''
name|'if'
name|'isinstance'
op|'('
name|'last_arg'
op|','
name|'list'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'resources'
op|'='
name|'last_arg'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'vm_create_error'
op|'.'
name|'args'
op|'='
name|'vm_create_error'
op|'.'
name|'args'
op|'+'
op|'('
name|'resources'
op|','
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'kernel'
op|':'
newline|'\n'
indent|'                '
name|'resources'
op|'.'
name|'append'
op|'('
name|'kernel'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'ramdisk'
op|':'
newline|'\n'
indent|'                '
name|'resources'
op|'.'
name|'append'
op|'('
name|'ramdisk'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'raise'
name|'vm_create_error'
newline|'\n'
nl|'\n'
comment|'# Add disks to VM'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'_attach_disks'
op|'('
name|'instance'
op|','
name|'disk_image_type'
op|','
name|'vm_ref'
op|','
name|'first_vdi_ref'
op|','
nl|'\n'
name|'vdis'
op|')'
newline|'\n'
nl|'\n'
comment|'# Alter the image before VM start for network injection.'
nl|'\n'
name|'if'
name|'FLAGS'
op|'.'
name|'flat_injected'
op|':'
newline|'\n'
indent|'            '
name|'VMHelper'
op|'.'
name|'preconfigure_instance'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|','
nl|'\n'
name|'first_vdi_ref'
op|','
name|'network_info'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'create_vifs'
op|'('
name|'vm_ref'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'inject_network_info'
op|'('
name|'instance'
op|','
name|'network_info'
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'inject_hostname'
op|'('
name|'instance'
op|','
name|'vm_ref'
op|','
name|'instance'
op|'['
string|"'hostname'"
op|']'
op|')'
newline|'\n'
nl|'\n'
name|'return'
name|'vm_ref'
newline|'\n'
nl|'\n'
DECL|member|_attach_disks
dedent|''
name|'def'
name|'_attach_disks'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'disk_image_type'
op|','
name|'vm_ref'
op|','
name|'first_vdi_ref'
op|','
nl|'\n'
name|'vdis'
op|')'
op|':'
newline|'\n'
comment|'# device 0 reserved for RW disk'
nl|'\n'
indent|'        '
name|'userdevice'
op|'='
number|'0'
newline|'\n'
nl|'\n'
comment|'# DISK_ISO needs two VBDs: the ISO disk and a blank RW disk'
nl|'\n'
name|'if'
name|'disk_image_type'
op|'=='
name|'ImageType'
op|'.'
name|'DISK_ISO'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
string|'"detected ISO image type, going to create blank VM for "'
nl|'\n'
string|'"install"'
op|')'
newline|'\n'
nl|'\n'
name|'cd_vdi_ref'
op|'='
name|'first_vdi_ref'
newline|'\n'
name|'first_vdi_ref'
op|'='
name|'VMHelper'
op|'.'
name|'fetch_blank_disk'
op|'('
name|'session'
op|'='
name|'self'
op|'.'
name|'_session'
op|','
nl|'\n'
name|'instance_type_id'
op|'='
name|'instance'
op|'.'
name|'instance_type_id'
op|')'
newline|'\n'
nl|'\n'
name|'VMHelper'
op|'.'
name|'create_vbd'
op|'('
name|'session'
op|'='
name|'self'
op|'.'
name|'_session'
op|','
name|'vm_ref'
op|'='
name|'vm_ref'
op|','
nl|'\n'
name|'vdi_ref'
op|'='
name|'first_vdi_ref'
op|','
name|'userdevice'
op|'='
name|'userdevice'
op|','
name|'bootable'
op|'='
name|'False'
op|')'
newline|'\n'
nl|'\n'
comment|"# device 1 reserved for rescue disk and we've used '0'"
nl|'\n'
name|'userdevice'
op|'='
number|'2'
newline|'\n'
name|'VMHelper'
op|'.'
name|'create_cd_vbd'
op|'('
name|'session'
op|'='
name|'self'
op|'.'
name|'_session'
op|','
name|'vm_ref'
op|'='
name|'vm_ref'
op|','
nl|'\n'
name|'vdi_ref'
op|'='
name|'cd_vdi_ref'
op|','
name|'userdevice'
op|'='
name|'userdevice'
op|','
name|'bootable'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
comment|'# set user device to next free value'
nl|'\n'
name|'userdevice'
op|'+='
number|'1'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'VMHelper'
op|'.'
name|'create_vbd'
op|'('
name|'session'
op|'='
name|'self'
op|'.'
name|'_session'
op|','
name|'vm_ref'
op|'='
name|'vm_ref'
op|','
nl|'\n'
name|'vdi_ref'
op|'='
name|'first_vdi_ref'
op|','
name|'userdevice'
op|'='
name|'userdevice'
op|','
name|'bootable'
op|'='
name|'True'
op|')'
newline|'\n'
comment|'# set user device to next free value'
nl|'\n'
comment|"# userdevice 1 is reserved for rescue and we've used '0'"
nl|'\n'
name|'userdevice'
op|'='
number|'2'
newline|'\n'
nl|'\n'
comment|'# Attach any other disks'
nl|'\n'
dedent|''
name|'for'
name|'vdi'
name|'in'
name|'vdis'
op|'['
number|'1'
op|':'
op|']'
op|':'
newline|'\n'
comment|"# vdi['vdi_type'] is either 'os' or 'swap', but we don't"
nl|'\n'
comment|'# really care what it is right here.'
nl|'\n'
indent|'            '
name|'vdi_ref'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'VDI.get_by_uuid'"
op|','
nl|'\n'
name|'vdi'
op|'['
string|"'vdi_uuid'"
op|']'
op|')'
newline|'\n'
name|'VMHelper'
op|'.'
name|'create_vbd'
op|'('
name|'session'
op|'='
name|'self'
op|'.'
name|'_session'
op|','
name|'vm_ref'
op|'='
name|'vm_ref'
op|','
nl|'\n'
name|'vdi_ref'
op|'='
name|'vdi_ref'
op|','
name|'userdevice'
op|'='
name|'userdevice'
op|','
nl|'\n'
name|'bootable'
op|'='
name|'False'
op|')'
newline|'\n'
name|'userdevice'
op|'+='
number|'1'
newline|'\n'
nl|'\n'
DECL|member|_spawn
dedent|''
dedent|''
name|'def'
name|'_spawn'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'vm_ref'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Spawn a new instance."""'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|"'Starting VM %s...'"
op|')'
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_start'
op|'('
name|'instance'
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'instance_name'
op|'='
name|'instance'
op|'.'
name|'name'
newline|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|"'Spawning VM %(instance_name)s created %(vm_ref)s.'"
op|')'
nl|'\n'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'ctx'
op|'='
name|'nova_context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'agent_build'
op|'='
name|'db'
op|'.'
name|'agent_build_get_by_triple'
op|'('
name|'ctx'
op|','
string|"'xen'"
op|','
nl|'\n'
name|'instance'
op|'.'
name|'os_type'
op|','
name|'instance'
op|'.'
name|'architecture'
op|')'
newline|'\n'
name|'if'
name|'agent_build'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|"'Latest agent build for %(hypervisor)s/%(os)s'"
op|'+'
string|"'/%(architecture)s is %(version)s'"
op|')'
op|'%'
name|'agent_build'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|"'No agent build found for %(hypervisor)s/%(os)s'"
op|'+'
string|"'/%(architecture)s'"
op|')'
op|'%'
op|'{'
nl|'\n'
string|"'hypervisor'"
op|':'
string|"'xen'"
op|','
nl|'\n'
string|"'os'"
op|':'
name|'instance'
op|'.'
name|'os_type'
op|','
nl|'\n'
string|"'architecture'"
op|':'
name|'instance'
op|'.'
name|'architecture'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_check_agent_version
dedent|''
name|'def'
name|'_check_agent_version'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Querying agent version"'
op|')'
op|')'
newline|'\n'
name|'if'
name|'instance'
op|'.'
name|'os_type'
op|'=='
string|"'windows'"
op|':'
newline|'\n'
comment|'# Windows will generally perform a setup process on first boot'
nl|'\n'
comment|'# that can take a couple of minutes and then reboot. So we'
nl|'\n'
comment|'# need to be more patient than normal as well as watch for'
nl|'\n'
comment|'# domid changes'
nl|'\n'
indent|'                '
name|'version'
op|'='
name|'self'
op|'.'
name|'get_agent_version'
op|'('
name|'instance'
op|','
nl|'\n'
name|'timeout'
op|'='
name|'FLAGS'
op|'.'
name|'windows_version_timeout'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'version'
op|'='
name|'self'
op|'.'
name|'get_agent_version'
op|'('
name|'instance'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'version'
op|':'
newline|'\n'
indent|'                '
name|'return'
newline|'\n'
nl|'\n'
dedent|''
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|"'Instance agent version: %s'"
op|')'
op|'%'
name|'version'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'agent_build'
op|':'
newline|'\n'
indent|'                '
name|'return'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'cmp_version'
op|'('
name|'version'
op|','
name|'agent_build'
op|'['
string|"'version'"
op|']'
op|')'
op|'<'
number|'0'
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|"'Updating Agent to %s'"
op|')'
op|'%'
name|'agent_build'
op|'['
string|"'version'"
op|']'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'agent_update'
op|'('
name|'instance'
op|','
name|'agent_build'
op|'['
string|"'url'"
op|']'
op|','
nl|'\n'
name|'agent_build'
op|'['
string|"'md5hash'"
op|']'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_inject_files
dedent|''
dedent|''
name|'def'
name|'_inject_files'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'injected_files'
op|'='
name|'instance'
op|'.'
name|'injected_files'
newline|'\n'
name|'if'
name|'injected_files'
op|':'
newline|'\n'
comment|'# Check if this is a JSON-encoded string and convert if needed.'
nl|'\n'
indent|'                '
name|'if'
name|'isinstance'
op|'('
name|'injected_files'
op|','
name|'basestring'
op|')'
op|':'
newline|'\n'
indent|'                    '
name|'try'
op|':'
newline|'\n'
indent|'                        '
name|'injected_files'
op|'='
name|'json'
op|'.'
name|'loads'
op|'('
name|'injected_files'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'ValueError'
op|':'
newline|'\n'
indent|'                        '
name|'LOG'
op|'.'
name|'exception'
op|'('
nl|'\n'
name|'_'
op|'('
string|'"Invalid value for injected_files: \'%s\'"'
op|')'
nl|'\n'
op|'%'
name|'injected_files'
op|')'
newline|'\n'
name|'injected_files'
op|'='
op|'['
op|']'
newline|'\n'
comment|'# Inject any files, if specified'
nl|'\n'
dedent|''
dedent|''
name|'for'
name|'path'
op|','
name|'contents'
name|'in'
name|'instance'
op|'.'
name|'injected_files'
op|':'
newline|'\n'
indent|'                    '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Injecting file path: \'%s\'"'
op|')'
op|'%'
name|'path'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'inject_file'
op|'('
name|'instance'
op|','
name|'path'
op|','
name|'contents'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_set_admin_password
dedent|''
dedent|''
dedent|''
name|'def'
name|'_set_admin_password'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'admin_password'
op|'='
name|'instance'
op|'.'
name|'admin_pass'
newline|'\n'
name|'if'
name|'admin_password'
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Setting admin password"'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'set_admin_password'
op|'('
name|'instance'
op|','
name|'admin_password'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_reset_network
dedent|''
dedent|''
name|'def'
name|'_reset_network'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Resetting network"'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'reset_network'
op|'('
name|'instance'
op|','
name|'vm_ref'
op|')'
newline|'\n'
nl|'\n'
comment|'# NOTE(armando): Do we really need to do this in virt?'
nl|'\n'
comment|'# NOTE(tr3buchet): not sure but wherever we do it, we need to call'
nl|'\n'
comment|'#                  reset_network afterwards'
nl|'\n'
dedent|''
name|'timer'
op|'='
name|'utils'
op|'.'
name|'LoopingCall'
op|'('
name|'f'
op|'='
name|'None'
op|')'
newline|'\n'
nl|'\n'
DECL|function|_wait_for_boot
name|'def'
name|'_wait_for_boot'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'state'
op|'='
name|'self'
op|'.'
name|'get_info'
op|'('
name|'instance_name'
op|')'
op|'['
string|"'state'"
op|']'
newline|'\n'
name|'if'
name|'state'
op|'=='
name|'power_state'
op|'.'
name|'RUNNING'
op|':'
newline|'\n'
indent|'                    '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|"'Instance %s: booted'"
op|')'
op|','
name|'instance_name'
op|')'
newline|'\n'
name|'timer'
op|'.'
name|'stop'
op|'('
op|')'
newline|'\n'
name|'_check_agent_version'
op|'('
op|')'
newline|'\n'
name|'_inject_files'
op|'('
op|')'
newline|'\n'
name|'_set_admin_password'
op|'('
op|')'
newline|'\n'
name|'_reset_network'
op|'('
op|')'
newline|'\n'
name|'return'
name|'True'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'Exception'
op|','
name|'exc'
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'warn'
op|'('
name|'exc'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'exception'
op|'('
name|'_'
op|'('
string|"'Instance %s: failed to boot'"
op|')'
op|','
name|'instance_name'
op|')'
newline|'\n'
name|'timer'
op|'.'
name|'stop'
op|'('
op|')'
newline|'\n'
name|'return'
name|'False'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'timer'
op|'.'
name|'f'
op|'='
name|'_wait_for_boot'
newline|'\n'
nl|'\n'
name|'return'
name|'timer'
op|'.'
name|'start'
op|'('
name|'interval'
op|'='
number|'0.5'
op|','
name|'now'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_handle_spawn_error
dedent|''
name|'def'
name|'_handle_spawn_error'
op|'('
name|'self'
op|','
name|'vdis'
op|','
name|'spawn_error'
op|')'
op|':'
newline|'\n'
comment|'# Extract resource list from spawn_error.'
nl|'\n'
indent|'        '
name|'resources'
op|'='
op|'['
op|']'
newline|'\n'
name|'if'
name|'spawn_error'
op|'.'
name|'args'
op|':'
newline|'\n'
indent|'            '
name|'last_arg'
op|'='
name|'spawn_error'
op|'.'
name|'args'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
name|'resources'
op|'='
name|'last_arg'
newline|'\n'
dedent|''
name|'if'
name|'vdis'
op|':'
newline|'\n'
indent|'            '
name|'for'
name|'vdi'
name|'in'
name|'vdis'
op|':'
newline|'\n'
indent|'                '
name|'resources'
op|'.'
name|'append'
op|'('
name|'dict'
op|'('
name|'vdi_type'
op|'='
name|'vdi'
op|'['
string|"'vdi_type'"
op|']'
op|','
nl|'\n'
name|'vdi_uuid'
op|'='
name|'vdi'
op|'['
string|"'vdi_uuid'"
op|']'
op|','
nl|'\n'
name|'file'
op|'='
name|'None'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Resources to remove:%s"'
op|')'
op|','
name|'resources'
op|')'
newline|'\n'
name|'kernel_file'
op|'='
name|'None'
newline|'\n'
name|'ramdisk_file'
op|'='
name|'None'
newline|'\n'
nl|'\n'
name|'for'
name|'item'
name|'in'
name|'resources'
op|':'
newline|'\n'
indent|'            '
name|'vdi_type'
op|'='
name|'item'
op|'['
string|"'vdi_type'"
op|']'
newline|'\n'
name|'vdi_to_remove'
op|'='
name|'item'
op|'['
string|"'vdi_uuid'"
op|']'
newline|'\n'
name|'if'
name|'vdi_to_remove'
op|':'
newline|'\n'
indent|'                '
name|'try'
op|':'
newline|'\n'
indent|'                    '
name|'vdi_ref'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'VDI.get_by_uuid'"
op|','
nl|'\n'
name|'vdi_to_remove'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|"'Removing VDI %(vdi_ref)s'"
op|'+'
nl|'\n'
string|"'(uuid:%(vdi_to_remove)s)'"
op|')'
op|','
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'VMHelper'
op|'.'
name|'destroy_vdi'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'vdi_ref'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'XenAPI'
op|'.'
name|'Failure'
op|':'
newline|'\n'
comment|'# Vdi has already been deleted'
nl|'\n'
indent|'                    '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Skipping VDI destroy for %s"'
op|')'
op|','
name|'vdi_to_remove'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'if'
name|'item'
op|'['
string|"'file'"
op|']'
op|':'
newline|'\n'
comment|'# There is also a file to remove.'
nl|'\n'
indent|'                '
name|'if'
name|'vdi_type'
op|'=='
name|'ImageType'
op|'.'
name|'KERNEL_STR'
op|':'
newline|'\n'
indent|'                    '
name|'kernel_file'
op|'='
name|'item'
op|'['
string|"'file'"
op|']'
newline|'\n'
dedent|''
name|'elif'
name|'vdi_type'
op|'=='
name|'ImageType'
op|'.'
name|'RAMDISK_STR'
op|':'
newline|'\n'
indent|'                    '
name|'ramdisk_file'
op|'='
name|'item'
op|'['
string|"'file'"
op|']'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
dedent|''
name|'if'
name|'kernel_file'
name|'or'
name|'ramdisk_file'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Removing kernel/ramdisk files from dom0"'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_destroy_kernel_ramdisk_plugin_call'
op|'('
name|'kernel_file'
op|','
nl|'\n'
name|'ramdisk_file'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_vm_opaque_ref
dedent|''
dedent|''
name|'def'
name|'_get_vm_opaque_ref'
op|'('
name|'self'
op|','
name|'instance_or_vm'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Refactored out the common code of many methods that receive either\n        a vm name or a vm instance, and want a vm instance in return.\n        """'
newline|'\n'
comment|'# if instance_or_vm is a string it must be opaque ref or instance name'
nl|'\n'
name|'if'
name|'isinstance'
op|'('
name|'instance_or_vm'
op|','
name|'basestring'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'obj'
op|'='
name|'None'
newline|'\n'
name|'try'
op|':'
newline|'\n'
comment|'# check for opaque ref'
nl|'\n'
indent|'                '
name|'obj'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'get_xenapi'
op|'('
op|')'
op|'.'
name|'VM'
op|'.'
name|'get_uuid'
op|'('
name|'instance_or_vm'
op|')'
newline|'\n'
name|'return'
name|'instance_or_vm'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'XenAPI'
op|'.'
name|'Failure'
op|':'
newline|'\n'
comment|"# wasn't an opaque ref, can be an instance name"
nl|'\n'
indent|'                '
name|'instance_name'
op|'='
name|'instance_or_vm'
newline|'\n'
nl|'\n'
comment|'# if instance_or_vm is an int/long it must be instance id'
nl|'\n'
dedent|''
dedent|''
name|'elif'
name|'isinstance'
op|'('
name|'instance_or_vm'
op|','
op|'('
name|'int'
op|','
name|'long'
op|')'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'ctx'
op|'='
name|'nova_context'
op|'.'
name|'get_admin_context'
op|'('
op|')'
newline|'\n'
name|'instance_obj'
op|'='
name|'db'
op|'.'
name|'instance_get'
op|'('
name|'ctx'
op|','
name|'instance_or_vm'
op|')'
newline|'\n'
name|'instance_name'
op|'='
name|'instance_obj'
op|'.'
name|'name'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'instance_name'
op|'='
name|'instance_or_vm'
op|'.'
name|'name'
newline|'\n'
dedent|''
name|'vm_ref'
op|'='
name|'VMHelper'
op|'.'
name|'lookup'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance_name'
op|')'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'NotFound'
op|'('
name|'_'
op|'('
string|'"No opaque_ref could be determined "'
nl|'\n'
string|'"for \'%s\'."'
op|')'
op|'%'
name|'instance_or_vm'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'vm_ref'
newline|'\n'
nl|'\n'
DECL|member|_acquire_bootlock
dedent|''
name|'def'
name|'_acquire_bootlock'
op|'('
name|'self'
op|','
name|'vm'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Prevent an instance from booting."""'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
nl|'\n'
string|'"VM.set_blocked_operations"'
op|','
nl|'\n'
name|'vm'
op|','
nl|'\n'
op|'{'
string|'"start"'
op|':'
string|'""'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_release_bootlock
dedent|''
name|'def'
name|'_release_bootlock'
op|'('
name|'self'
op|','
name|'vm'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Allow an instance to boot."""'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
nl|'\n'
string|'"VM.remove_from_blocked_operations"'
op|','
nl|'\n'
name|'vm'
op|','
nl|'\n'
string|'"start"'
op|')'
newline|'\n'
nl|'\n'
DECL|member|snapshot
dedent|''
name|'def'
name|'snapshot'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'image_id'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Create snapshot from a running VM instance.\n\n        :param context: request context\n        :param instance: instance to be snapshotted\n        :param image_id: id of image to upload to\n\n        Steps involved in a XenServer snapshot:\n\n        1. XAPI-Snapshot: Snapshotting the instance using XenAPI. This\n            creates: Snapshot (Template) VM, Snapshot VBD, Snapshot VDI,\n            Snapshot VHD\n\n        2. Wait-for-coalesce: The Snapshot VDI and Instance VDI both point to\n            a \'base-copy\' VDI.  The base_copy is immutable and may be chained\n            with other base_copies.  If chained, the base_copies\n            coalesce together, so, we must wait for this coalescing to occur to\n            get a stable representation of the data on disk.\n\n        3. Push-to-glance: Once coalesced, we call a plugin on the XenServer\n            that will bundle the VHDs together and then push the bundle into\n            Glance.\n\n        """'
newline|'\n'
name|'template_vm_ref'
op|'='
name|'None'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'template_vm_ref'
op|','
name|'template_vdi_uuids'
op|'='
name|'self'
op|'.'
name|'_get_snapshot'
op|'('
name|'instance'
op|')'
newline|'\n'
comment|'# call plugin to ship snapshot off to glance'
nl|'\n'
name|'VMHelper'
op|'.'
name|'upload_image'
op|'('
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|','
name|'template_vdi_uuids'
op|','
name|'image_id'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'template_vm_ref'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'_destroy'
op|'('
name|'instance'
op|','
name|'template_vm_ref'
op|','
nl|'\n'
name|'shutdown'
op|'='
name|'False'
op|','
name|'destroy_kernel_ramdisk'
op|'='
name|'False'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'logging'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Finished snapshot and upload for VM %s"'
op|')'
op|','
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_get_snapshot
dedent|''
name|'def'
name|'_get_snapshot'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
comment|'#TODO(sirp): Add quiesce and VSS locking support when Windows support'
nl|'\n'
comment|'# is added'
nl|'\n'
nl|'\n'
indent|'        '
name|'logging'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Starting snapshot for VM %s"'
op|')'
op|','
name|'instance'
op|')'
newline|'\n'
name|'vm_ref'
op|'='
name|'VMHelper'
op|'.'
name|'lookup'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'.'
name|'name'
op|')'
newline|'\n'
nl|'\n'
name|'label'
op|'='
string|'"%s-snapshot"'
op|'%'
name|'instance'
op|'.'
name|'name'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'template_vm_ref'
op|','
name|'template_vdi_uuids'
op|'='
name|'VMHelper'
op|'.'
name|'create_snapshot'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'.'
name|'id'
op|','
name|'vm_ref'
op|','
name|'label'
op|')'
newline|'\n'
name|'return'
name|'template_vm_ref'
op|','
name|'template_vdi_uuids'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'XenAPI'
op|'.'
name|'Failure'
op|','
name|'exc'
op|':'
newline|'\n'
indent|'            '
name|'logging'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
string|'"Unable to Snapshot %(vm_ref)s: %(exc)s"'
op|')'
nl|'\n'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'return'
newline|'\n'
nl|'\n'
DECL|member|migrate_disk_and_power_off
dedent|''
dedent|''
name|'def'
name|'migrate_disk_and_power_off'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'dest'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Copies a VHD from one host machine to another.\n\n        :param instance: the instance that owns the VHD in question.\n        :param dest: the destination host machine.\n        :param disk_type: values are \'primary\' or \'cow\'.\n\n        """'
newline|'\n'
name|'vm_ref'
op|'='
name|'VMHelper'
op|'.'
name|'lookup'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'.'
name|'name'
op|')'
newline|'\n'
nl|'\n'
comment|'# The primary VDI becomes the COW after the snapshot, and we can'
nl|'\n'
comment|'# identify it via the VBD. The base copy is the parent_uuid returned'
nl|'\n'
comment|'# from the snapshot creation'
nl|'\n'
nl|'\n'
name|'base_copy_uuid'
op|'='
name|'cow_uuid'
op|'='
name|'None'
newline|'\n'
name|'template_vdi_uuids'
op|'='
name|'template_vm_ref'
op|'='
name|'None'
newline|'\n'
name|'try'
op|':'
newline|'\n'
comment|'# transfer the base copy'
nl|'\n'
indent|'            '
name|'template_vm_ref'
op|','
name|'template_vdi_uuids'
op|'='
name|'self'
op|'.'
name|'_get_snapshot'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'base_copy_uuid'
op|'='
name|'template_vdi_uuids'
op|'['
string|"'image'"
op|']'
newline|'\n'
name|'vdi_ref'
op|','
name|'vm_vdi_rec'
op|'='
name|'VMHelper'
op|'.'
name|'get_vdi_for_vm_safely'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'cow_uuid'
op|'='
name|'vm_vdi_rec'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
nl|'\n'
name|'params'
op|'='
op|'{'
string|"'host'"
op|':'
name|'dest'
op|','
nl|'\n'
string|"'vdi_uuid'"
op|':'
name|'base_copy_uuid'
op|','
nl|'\n'
string|"'instance_id'"
op|':'
name|'instance'
op|'.'
name|'id'
op|','
nl|'\n'
string|"'sr_path'"
op|':'
name|'VMHelper'
op|'.'
name|'get_sr_path'
op|'('
name|'self'
op|'.'
name|'_session'
op|')'
op|'}'
newline|'\n'
nl|'\n'
name|'task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'async_call_plugin'
op|'('
string|"'migration'"
op|','
string|"'transfer_vhd'"
op|','
nl|'\n'
op|'{'
string|"'params'"
op|':'
name|'pickle'
op|'.'
name|'dumps'
op|'('
name|'params'
op|')'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'wait_for_task'
op|'('
name|'task'
op|','
name|'instance'
op|'.'
name|'id'
op|')'
newline|'\n'
nl|'\n'
comment|'# Now power down the instance and transfer the COW VHD'
nl|'\n'
name|'self'
op|'.'
name|'_shutdown'
op|'('
name|'instance'
op|','
name|'vm_ref'
op|','
name|'hard'
op|'='
name|'False'
op|')'
newline|'\n'
nl|'\n'
name|'params'
op|'='
op|'{'
string|"'host'"
op|':'
name|'dest'
op|','
nl|'\n'
string|"'vdi_uuid'"
op|':'
name|'cow_uuid'
op|','
nl|'\n'
string|"'instance_id'"
op|':'
name|'instance'
op|'.'
name|'id'
op|','
nl|'\n'
string|"'sr_path'"
op|':'
name|'VMHelper'
op|'.'
name|'get_sr_path'
op|'('
name|'self'
op|'.'
name|'_session'
op|')'
op|','
op|'}'
newline|'\n'
nl|'\n'
name|'task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'async_call_plugin'
op|'('
string|"'migration'"
op|','
string|"'transfer_vhd'"
op|','
nl|'\n'
op|'{'
string|"'params'"
op|':'
name|'pickle'
op|'.'
name|'dumps'
op|'('
name|'params'
op|')'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'wait_for_task'
op|'('
name|'task'
op|','
name|'instance'
op|'.'
name|'id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'template_vm_ref'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'_destroy'
op|'('
name|'instance'
op|','
name|'template_vm_ref'
op|','
nl|'\n'
name|'shutdown'
op|'='
name|'False'
op|','
name|'destroy_kernel_ramdisk'
op|'='
name|'False'
op|')'
newline|'\n'
nl|'\n'
comment|'# TODO(mdietz): we could also consider renaming these to something'
nl|'\n'
comment|"# sensible so we don't need to blindly pass around dictionaries"
nl|'\n'
dedent|''
dedent|''
name|'return'
op|'{'
string|"'base_copy'"
op|':'
name|'base_copy_uuid'
op|','
string|"'cow'"
op|':'
name|'cow_uuid'
op|'}'
newline|'\n'
nl|'\n'
DECL|member|link_disks
dedent|''
name|'def'
name|'link_disks'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'base_copy_uuid'
op|','
name|'cow_uuid'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Links the base copy VHD to the COW via the XAPI plugin."""'
newline|'\n'
name|'new_base_copy_uuid'
op|'='
name|'str'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|')'
newline|'\n'
name|'new_cow_uuid'
op|'='
name|'str'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|')'
newline|'\n'
name|'params'
op|'='
op|'{'
string|"'instance_id'"
op|':'
name|'instance'
op|'.'
name|'id'
op|','
nl|'\n'
string|"'old_base_copy_uuid'"
op|':'
name|'base_copy_uuid'
op|','
nl|'\n'
string|"'old_cow_uuid'"
op|':'
name|'cow_uuid'
op|','
nl|'\n'
string|"'new_base_copy_uuid'"
op|':'
name|'new_base_copy_uuid'
op|','
nl|'\n'
string|"'new_cow_uuid'"
op|':'
name|'new_cow_uuid'
op|','
nl|'\n'
string|"'sr_path'"
op|':'
name|'VMHelper'
op|'.'
name|'get_sr_path'
op|'('
name|'self'
op|'.'
name|'_session'
op|')'
op|','
op|'}'
newline|'\n'
nl|'\n'
name|'task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'async_call_plugin'
op|'('
string|"'migration'"
op|','
nl|'\n'
string|"'move_vhds_into_sr'"
op|','
op|'{'
string|"'params'"
op|':'
name|'pickle'
op|'.'
name|'dumps'
op|'('
name|'params'
op|')'
op|'}'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'wait_for_task'
op|'('
name|'task'
op|','
name|'instance'
op|'.'
name|'id'
op|')'
newline|'\n'
nl|'\n'
comment|'# Now we rescan the SR so we find the VHDs'
nl|'\n'
name|'VMHelper'
op|'.'
name|'scan_default_sr'
op|'('
name|'self'
op|'.'
name|'_session'
op|')'
newline|'\n'
nl|'\n'
name|'return'
name|'new_cow_uuid'
newline|'\n'
nl|'\n'
DECL|member|resize_instance
dedent|''
name|'def'
name|'resize_instance'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'vdi_uuid'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Resize a running instance by changing its RAM and disk size."""'
newline|'\n'
comment|'#TODO(mdietz): this will need to be adjusted for swap later'
nl|'\n'
comment|'#The new disk size must be in bytes'
nl|'\n'
nl|'\n'
name|'new_disk_size'
op|'='
name|'instance'
op|'.'
name|'local_gb'
op|'*'
number|'1024'
op|'*'
number|'1024'
op|'*'
number|'1024'
newline|'\n'
name|'if'
name|'new_disk_size'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'instance_name'
op|'='
name|'instance'
op|'.'
name|'name'
newline|'\n'
name|'instance_local_gb'
op|'='
name|'instance'
op|'.'
name|'local_gb'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Resizing VDI %(vdi_uuid)s for instance"'
nl|'\n'
string|'"%(instance_name)s. Expanding to %(instance_local_gb)d"'
nl|'\n'
string|'" GB"'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'vdi_ref'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'VDI.get_by_uuid'"
op|','
name|'vdi_uuid'
op|')'
newline|'\n'
comment|'# for an instance with no local storage'
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'VDI.resize_online'"
op|','
name|'vdi_ref'
op|','
nl|'\n'
name|'str'
op|'('
name|'new_disk_size'
op|')'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Resize instance %s complete"'
op|')'
op|'%'
op|'('
name|'instance'
op|'.'
name|'name'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|reboot
dedent|''
dedent|''
name|'def'
name|'reboot'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'reboot_type'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Reboot VM instance."""'
newline|'\n'
name|'vm_ref'
op|'='
name|'self'
op|'.'
name|'_get_vm_opaque_ref'
op|'('
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'reboot_type'
op|'=='
string|'"HARD"'
op|':'
newline|'\n'
indent|'            '
name|'task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'Async.VM.hard_reboot'"
op|','
name|'vm_ref'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'Async.VM.clean_reboot'"
op|','
name|'vm_ref'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'_session'
op|'.'
name|'wait_for_task'
op|'('
name|'task'
op|','
name|'instance'
op|'.'
name|'id'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_agent_version
dedent|''
name|'def'
name|'get_agent_version'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'timeout'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Get the version of the agent running on the VM instance."""'
newline|'\n'
nl|'\n'
DECL|function|_call
name|'def'
name|'_call'
op|'('
op|')'
op|':'
newline|'\n'
comment|'# Send the encrypted password'
nl|'\n'
indent|'            '
name|'transaction_id'
op|'='
name|'str'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|')'
newline|'\n'
name|'args'
op|'='
op|'{'
string|"'id'"
op|':'
name|'transaction_id'
op|'}'
newline|'\n'
name|'resp'
op|'='
name|'self'
op|'.'
name|'_make_agent_call'
op|'('
string|"'version'"
op|','
name|'instance'
op|','
string|"''"
op|','
name|'args'
op|')'
newline|'\n'
name|'if'
name|'resp'
op|'['
string|"'returncode'"
op|']'
op|'!='
string|"'0'"
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
string|"'Failed to query agent version: %(resp)r'"
op|')'
op|'%'
nl|'\n'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'return'
name|'None'
newline|'\n'
comment|'# Some old versions of the Windows agent have a trailing \\\\r\\\\n'
nl|'\n'
comment|'# (ie CRLF escaped) for some reason. Strip that off.'
nl|'\n'
dedent|''
name|'return'
name|'resp'
op|'['
string|"'message'"
op|']'
op|'.'
name|'replace'
op|'('
string|"'\\\\r\\\\n'"
op|','
string|"''"
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'timeout'
op|':'
newline|'\n'
indent|'            '
name|'vm_ref'
op|'='
name|'self'
op|'.'
name|'_get_vm_opaque_ref'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'vm_rec'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'get_xenapi'
op|'('
op|')'
op|'.'
name|'VM'
op|'.'
name|'get_record'
op|'('
name|'vm_ref'
op|')'
newline|'\n'
nl|'\n'
name|'domid'
op|'='
name|'vm_rec'
op|'['
string|"'domid'"
op|']'
newline|'\n'
nl|'\n'
name|'expiration'
op|'='
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'+'
name|'timeout'
newline|'\n'
name|'while'
name|'time'
op|'.'
name|'time'
op|'('
op|')'
op|'<'
name|'expiration'
op|':'
newline|'\n'
indent|'                '
name|'ret'
op|'='
name|'_call'
op|'('
op|')'
newline|'\n'
name|'if'
name|'ret'
op|':'
newline|'\n'
indent|'                    '
name|'return'
name|'ret'
newline|'\n'
nl|'\n'
dedent|''
name|'vm_rec'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'get_xenapi'
op|'('
op|')'
op|'.'
name|'VM'
op|'.'
name|'get_record'
op|'('
name|'vm_ref'
op|')'
newline|'\n'
name|'if'
name|'vm_rec'
op|'['
string|"'domid'"
op|']'
op|'!='
name|'domid'
op|':'
newline|'\n'
indent|'                    '
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|"'domid changed from %(olddomid)s to '"
nl|'\n'
string|"'%(newdomid)s'"
op|')'
op|'%'
op|'{'
nl|'\n'
string|"'olddomid'"
op|':'
name|'domid'
op|','
nl|'\n'
string|"'newdomid'"
op|':'
name|'vm_rec'
op|'['
string|"'domid'"
op|']'
op|'}'
op|')'
newline|'\n'
name|'domid'
op|'='
name|'vm_rec'
op|'['
string|"'domid'"
op|']'
newline|'\n'
dedent|''
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'_call'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|agent_update
dedent|''
dedent|''
name|'def'
name|'agent_update'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'url'
op|','
name|'md5sum'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Update agent on the VM instance."""'
newline|'\n'
nl|'\n'
comment|'# Send the encrypted password'
nl|'\n'
name|'transaction_id'
op|'='
name|'str'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|')'
newline|'\n'
name|'args'
op|'='
op|'{'
string|"'id'"
op|':'
name|'transaction_id'
op|','
string|"'url'"
op|':'
name|'url'
op|','
string|"'md5sum'"
op|':'
name|'md5sum'
op|'}'
newline|'\n'
name|'resp'
op|'='
name|'self'
op|'.'
name|'_make_agent_call'
op|'('
string|"'agentupdate'"
op|','
name|'instance'
op|','
string|"''"
op|','
name|'args'
op|')'
newline|'\n'
name|'if'
name|'resp'
op|'['
string|"'returncode'"
op|']'
op|'!='
string|"'0'"
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
string|"'Failed to update agent: %(resp)r'"
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'return'
name|'resp'
op|'['
string|"'message'"
op|']'
newline|'\n'
nl|'\n'
DECL|member|set_admin_password
dedent|''
name|'def'
name|'set_admin_password'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'new_pass'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Set the root/admin password on the VM instance.\n\n        This is done via an agent running on the VM. Communication between nova\n        and the agent is done via writing xenstore records. Since communication\n        is done over the XenAPI RPC calls, we need to encrypt the password.\n        We\'re using a simple Diffie-Hellman class instead of the more advanced\n        one in M2Crypto for compatibility with the agent code.\n\n        """'
newline|'\n'
comment|'# Need to uniquely identify this request.'
nl|'\n'
name|'key_init_transaction_id'
op|'='
name|'str'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|')'
newline|'\n'
comment|'# The simple Diffie-Hellman class is used to manage key exchange.'
nl|'\n'
name|'dh'
op|'='
name|'SimpleDH'
op|'('
op|')'
newline|'\n'
name|'key_init_args'
op|'='
op|'{'
string|"'id'"
op|':'
name|'key_init_transaction_id'
op|','
nl|'\n'
string|"'pub'"
op|':'
name|'str'
op|'('
name|'dh'
op|'.'
name|'get_public'
op|'('
op|')'
op|')'
op|'}'
newline|'\n'
name|'resp'
op|'='
name|'self'
op|'.'
name|'_make_agent_call'
op|'('
string|"'key_init'"
op|','
name|'instance'
op|','
string|"''"
op|','
name|'key_init_args'
op|')'
newline|'\n'
comment|"# Successful return code from key_init is 'D0'"
nl|'\n'
name|'if'
name|'resp'
op|'['
string|"'returncode'"
op|']'
op|'!='
string|"'D0'"
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
string|"'Failed to exchange keys: %(resp)r'"
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'return'
name|'None'
newline|'\n'
comment|'# Some old versions of the Windows agent have a trailing \\\\r\\\\n'
nl|'\n'
comment|'# (ie CRLF escaped) for some reason. Strip that off.'
nl|'\n'
dedent|''
name|'agent_pub'
op|'='
name|'int'
op|'('
name|'resp'
op|'['
string|"'message'"
op|']'
op|'.'
name|'replace'
op|'('
string|"'\\\\r\\\\n'"
op|','
string|"''"
op|')'
op|')'
newline|'\n'
name|'dh'
op|'.'
name|'compute_shared'
op|'('
name|'agent_pub'
op|')'
newline|'\n'
comment|'# Some old versions of Linux and Windows agent expect trailing \\n'
nl|'\n'
comment|'# on password to work correctly.'
nl|'\n'
name|'enc_pass'
op|'='
name|'dh'
op|'.'
name|'encrypt'
op|'('
name|'new_pass'
op|'+'
string|"'\\n'"
op|')'
newline|'\n'
comment|'# Send the encrypted password'
nl|'\n'
name|'password_transaction_id'
op|'='
name|'str'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|')'
newline|'\n'
name|'password_args'
op|'='
op|'{'
string|"'id'"
op|':'
name|'password_transaction_id'
op|','
string|"'enc_pass'"
op|':'
name|'enc_pass'
op|'}'
newline|'\n'
name|'resp'
op|'='
name|'self'
op|'.'
name|'_make_agent_call'
op|'('
string|"'password'"
op|','
name|'instance'
op|','
string|"''"
op|','
name|'password_args'
op|')'
newline|'\n'
comment|"# Successful return code from password is '0'"
nl|'\n'
name|'if'
name|'resp'
op|'['
string|"'returncode'"
op|']'
op|'!='
string|"'0'"
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
string|"'Failed to update password: %(resp)r'"
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'return'
name|'resp'
op|'['
string|"'message'"
op|']'
newline|'\n'
nl|'\n'
DECL|member|inject_file
dedent|''
name|'def'
name|'inject_file'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'path'
op|','
name|'contents'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Write a file to the VM instance.\n\n        The path to which it is to be written and the contents of the file\n        need to be supplied; both will be base64-encoded to prevent errors\n        with non-ASCII characters being transmitted. If the agent does not\n        support file injection, or the user has disabled it, a\n        NotImplementedError will be raised.\n\n        """'
newline|'\n'
comment|'# Files/paths must be base64-encoded for transmission to agent'
nl|'\n'
name|'b64_path'
op|'='
name|'base64'
op|'.'
name|'b64encode'
op|'('
name|'path'
op|')'
newline|'\n'
name|'b64_contents'
op|'='
name|'base64'
op|'.'
name|'b64encode'
op|'('
name|'contents'
op|')'
newline|'\n'
nl|'\n'
comment|'# Need to uniquely identify this request.'
nl|'\n'
name|'transaction_id'
op|'='
name|'str'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|')'
newline|'\n'
name|'args'
op|'='
op|'{'
string|"'id'"
op|':'
name|'transaction_id'
op|','
string|"'b64_path'"
op|':'
name|'b64_path'
op|','
nl|'\n'
string|"'b64_contents'"
op|':'
name|'b64_contents'
op|'}'
newline|'\n'
comment|"# If the agent doesn't support file injection, a NotImplementedError"
nl|'\n'
comment|'# will be raised with the appropriate message.'
nl|'\n'
name|'resp'
op|'='
name|'self'
op|'.'
name|'_make_agent_call'
op|'('
string|"'inject_file'"
op|','
name|'instance'
op|','
string|"''"
op|','
name|'args'
op|')'
newline|'\n'
name|'if'
name|'resp'
op|'['
string|"'returncode'"
op|']'
op|'!='
string|"'0'"
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
string|"'Failed to inject file: %(resp)r'"
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'return'
name|'resp'
op|'['
string|"'message'"
op|']'
newline|'\n'
nl|'\n'
DECL|member|_shutdown
dedent|''
name|'def'
name|'_shutdown'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'vm_ref'
op|','
name|'hard'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Shutdown an instance."""'
newline|'\n'
name|'state'
op|'='
name|'self'
op|'.'
name|'get_info'
op|'('
name|'instance'
op|'['
string|"'name'"
op|']'
op|')'
op|'['
string|"'state'"
op|']'
newline|'\n'
name|'if'
name|'state'
op|'=='
name|'power_state'
op|'.'
name|'SHUTDOWN'
op|':'
newline|'\n'
indent|'            '
name|'instance_name'
op|'='
name|'instance'
op|'.'
name|'name'
newline|'\n'
name|'LOG'
op|'.'
name|'warn'
op|'('
name|'_'
op|'('
string|'"VM %(instance_name)s already halted,"'
nl|'\n'
string|'"skipping shutdown..."'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'return'
newline|'\n'
nl|'\n'
dedent|''
name|'instance_id'
op|'='
name|'instance'
op|'.'
name|'id'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Shutting down VM for Instance %(instance_id)s"'
op|')'
nl|'\n'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'task'
op|'='
name|'None'
newline|'\n'
name|'if'
name|'hard'
op|':'
newline|'\n'
indent|'                '
name|'task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|'"Async.VM.hard_shutdown"'
op|','
nl|'\n'
name|'vm_ref'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|'"Async.VM.clean_shutdown"'
op|','
nl|'\n'
name|'vm_ref'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_session'
op|'.'
name|'wait_for_task'
op|'('
name|'task'
op|','
name|'instance'
op|'.'
name|'id'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'XenAPI'
op|'.'
name|'Failure'
op|','
name|'exc'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'exception'
op|'('
name|'exc'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_find_rescue_vbd_ref
dedent|''
dedent|''
name|'def'
name|'_find_rescue_vbd_ref'
op|'('
name|'self'
op|','
name|'vm_ref'
op|','
name|'rescue_vm_ref'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Find and return the rescue VM\'s vbd_ref.\n\n        We use the second VBD here because swap is first with the root file\n        system coming in second."""'
newline|'\n'
name|'vbd_ref'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'get_xenapi'
op|'('
op|')'
op|'.'
name|'VM'
op|'.'
name|'get_VBDs'
op|'('
name|'vm_ref'
op|')'
op|'['
number|'1'
op|']'
newline|'\n'
name|'vdi_ref'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'get_xenapi'
op|'('
op|')'
op|'.'
name|'VBD'
op|'.'
name|'get_record'
op|'('
name|'vbd_ref'
op|')'
op|'['
string|'"VDI"'
op|']'
newline|'\n'
nl|'\n'
name|'return'
name|'VMHelper'
op|'.'
name|'create_vbd'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'rescue_vm_ref'
op|','
name|'vdi_ref'
op|','
number|'1'
op|','
nl|'\n'
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_shutdown_rescue
dedent|''
name|'def'
name|'_shutdown_rescue'
op|'('
name|'self'
op|','
name|'rescue_vm_ref'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Shutdown a rescue instance."""'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|'"Async.VM.hard_shutdown"'
op|','
name|'rescue_vm_ref'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_destroy_vdis
dedent|''
name|'def'
name|'_destroy_vdis'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'vm_ref'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Destroys all VDIs associated with a VM."""'
newline|'\n'
name|'instance_id'
op|'='
name|'instance'
op|'.'
name|'id'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Destroying VDIs for Instance %(instance_id)s"'
op|')'
nl|'\n'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'vdi_refs'
op|'='
name|'VMHelper'
op|'.'
name|'lookup_vm_vdis'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'vm_ref'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'not'
name|'vdi_refs'
op|':'
newline|'\n'
indent|'            '
name|'return'
newline|'\n'
nl|'\n'
dedent|''
name|'for'
name|'vdi_ref'
name|'in'
name|'vdi_refs'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'Async.VDI.destroy'"
op|','
name|'vdi_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'wait_for_task'
op|'('
name|'task'
op|','
name|'instance'
op|'.'
name|'id'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'XenAPI'
op|'.'
name|'Failure'
op|','
name|'exc'
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'exception'
op|'('
name|'exc'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_destroy_rescue_vdis
dedent|''
dedent|''
dedent|''
name|'def'
name|'_destroy_rescue_vdis'
op|'('
name|'self'
op|','
name|'rescue_vm_ref'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Destroys all VDIs associated with a rescued VM."""'
newline|'\n'
name|'vdi_refs'
op|'='
name|'VMHelper'
op|'.'
name|'lookup_vm_vdis'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'rescue_vm_ref'
op|')'
newline|'\n'
name|'for'
name|'vdi_ref'
name|'in'
name|'vdi_refs'
op|':'
newline|'\n'
indent|'            '
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|'"Async.VDI.destroy"'
op|','
name|'vdi_ref'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'XenAPI'
op|'.'
name|'Failure'
op|':'
newline|'\n'
indent|'                '
name|'continue'
newline|'\n'
nl|'\n'
DECL|member|_destroy_rescue_vbds
dedent|''
dedent|''
dedent|''
name|'def'
name|'_destroy_rescue_vbds'
op|'('
name|'self'
op|','
name|'rescue_vm_ref'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Destroys all VBDs tied to a rescue VM."""'
newline|'\n'
name|'vbd_refs'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'get_xenapi'
op|'('
op|')'
op|'.'
name|'VM'
op|'.'
name|'get_VBDs'
op|'('
name|'rescue_vm_ref'
op|')'
newline|'\n'
name|'for'
name|'vbd_ref'
name|'in'
name|'vbd_refs'
op|':'
newline|'\n'
indent|'            '
name|'vbd_rec'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'get_xenapi'
op|'('
op|')'
op|'.'
name|'VBD'
op|'.'
name|'get_record'
op|'('
name|'vbd_ref'
op|')'
newline|'\n'
name|'if'
name|'vbd_rec'
op|'.'
name|'get'
op|'('
string|'"userdevice"'
op|','
name|'None'
op|')'
op|'=='
string|'"1"'
op|':'
comment|'# VBD is always 1'
newline|'\n'
indent|'                '
name|'VMHelper'
op|'.'
name|'unplug_vbd'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'vbd_ref'
op|')'
newline|'\n'
name|'VMHelper'
op|'.'
name|'destroy_vbd'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'vbd_ref'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_destroy_kernel_ramdisk_plugin_call
dedent|''
dedent|''
dedent|''
name|'def'
name|'_destroy_kernel_ramdisk_plugin_call'
op|'('
name|'self'
op|','
name|'kernel'
op|','
name|'ramdisk'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'args'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'if'
name|'kernel'
op|':'
newline|'\n'
indent|'            '
name|'args'
op|'['
string|"'kernel-file'"
op|']'
op|'='
name|'kernel'
newline|'\n'
dedent|''
name|'if'
name|'ramdisk'
op|':'
newline|'\n'
indent|'            '
name|'args'
op|'['
string|"'ramdisk-file'"
op|']'
op|'='
name|'ramdisk'
newline|'\n'
dedent|''
name|'task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'async_call_plugin'
op|'('
nl|'\n'
string|"'glance'"
op|','
string|"'remove_kernel_ramdisk'"
op|','
name|'args'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'wait_for_task'
op|'('
name|'task'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_destroy_kernel_ramdisk
dedent|''
name|'def'
name|'_destroy_kernel_ramdisk'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'vm_ref'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Three situations can occur:\n\n            1. We have neither a ramdisk nor a kernel, in which case we are a\n               RAW image and can omit this step\n\n            2. We have one or the other, in which case, we should flag as an\n               error\n\n            3. We have both, in which case we safely remove both the kernel\n               and the ramdisk.\n\n        """'
newline|'\n'
name|'instance_id'
op|'='
name|'instance'
op|'.'
name|'id'
newline|'\n'
name|'if'
name|'not'
name|'instance'
op|'.'
name|'kernel_id'
name|'and'
name|'not'
name|'instance'
op|'.'
name|'ramdisk_id'
op|':'
newline|'\n'
comment|'# 1. No kernel or ramdisk'
nl|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Instance %(instance_id)s using RAW or VHD, "'
nl|'\n'
string|'"skipping kernel and ramdisk deletion"'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'return'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'not'
op|'('
name|'instance'
op|'.'
name|'kernel_id'
name|'and'
name|'instance'
op|'.'
name|'ramdisk_id'
op|')'
op|':'
newline|'\n'
comment|'# 2. We only have kernel xor ramdisk'
nl|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceUnacceptable'
op|'('
name|'instance_id'
op|'='
name|'instance_id'
op|','
nl|'\n'
name|'reason'
op|'='
name|'_'
op|'('
string|'"instance has a kernel or ramdisk but not both"'
op|')'
op|')'
newline|'\n'
nl|'\n'
comment|'# 3. We have both kernel and ramdisk'
nl|'\n'
dedent|''
op|'('
name|'kernel'
op|','
name|'ramdisk'
op|')'
op|'='
name|'VMHelper'
op|'.'
name|'lookup_kernel_ramdisk'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
nl|'\n'
name|'vm_ref'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_destroy_kernel_ramdisk_plugin_call'
op|'('
name|'kernel'
op|','
name|'ramdisk'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"kernel/ramdisk files removed"'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_destroy_vm
dedent|''
name|'def'
name|'_destroy_vm'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'vm_ref'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Destroys a VM record."""'
newline|'\n'
name|'instance_id'
op|'='
name|'instance'
op|'.'
name|'id'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'Async.VM.destroy'"
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'wait_for_task'
op|'('
name|'task'
op|','
name|'instance_id'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'XenAPI'
op|'.'
name|'Failure'
op|','
name|'exc'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'exception'
op|'('
name|'exc'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"Instance %(instance_id)s VM destroyed"'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_destroy_rescue_instance
dedent|''
name|'def'
name|'_destroy_rescue_instance'
op|'('
name|'self'
op|','
name|'rescue_vm_ref'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Destroy a rescue instance."""'
newline|'\n'
name|'self'
op|'.'
name|'_destroy_rescue_vbds'
op|'('
name|'rescue_vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_shutdown_rescue'
op|'('
name|'rescue_vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_destroy_rescue_vdis'
op|'('
name|'rescue_vm_ref'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|'"Async.VM.destroy"'
op|','
name|'rescue_vm_ref'
op|')'
newline|'\n'
nl|'\n'
DECL|member|destroy
dedent|''
name|'def'
name|'destroy'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Destroy VM instance.\n\n        This is the method exposed by xenapi_conn.destroy(). The rest of the\n        destroy_* methods are internal.\n\n        """'
newline|'\n'
name|'instance_id'
op|'='
name|'instance'
op|'.'
name|'id'
newline|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_'
op|'('
string|'"Destroying VM for Instance %(instance_id)s"'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'vm_ref'
op|'='
name|'VMHelper'
op|'.'
name|'lookup'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'.'
name|'name'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'_destroy'
op|'('
name|'instance'
op|','
name|'vm_ref'
op|','
name|'network_info'
op|','
name|'shutdown'
op|'='
name|'True'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_destroy
dedent|''
name|'def'
name|'_destroy'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'vm_ref'
op|','
name|'network_info'
op|'='
name|'None'
op|','
name|'shutdown'
op|'='
name|'True'
op|','
nl|'\n'
name|'destroy_kernel_ramdisk'
op|'='
name|'True'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Destroys VM instance by performing:\n\n            1. A shutdown if requested.\n            2. Destroying associated VDIs.\n            3. Destroying kernel and ramdisk files (if necessary).\n            4. Destroying that actual VM record.\n\n        """'
newline|'\n'
name|'if'
name|'vm_ref'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'warning'
op|'('
name|'_'
op|'('
string|'"VM is not present, skipping destroy..."'
op|')'
op|')'
newline|'\n'
name|'return'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'shutdown'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_shutdown'
op|'('
name|'instance'
op|','
name|'vm_ref'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'_destroy_vdis'
op|'('
name|'instance'
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'if'
name|'destroy_kernel_ramdisk'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_destroy_kernel_ramdisk'
op|'('
name|'instance'
op|','
name|'vm_ref'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_destroy_vm'
op|'('
name|'instance'
op|','
name|'vm_ref'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'network_info'
op|':'
newline|'\n'
indent|'            '
name|'for'
op|'('
name|'network'
op|','
name|'mapping'
op|')'
name|'in'
name|'network_info'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'vif_driver'
op|'.'
name|'unplug'
op|'('
name|'instance'
op|','
name|'network'
op|','
name|'mapping'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_wait_with_callback
dedent|''
dedent|''
dedent|''
name|'def'
name|'_wait_with_callback'
op|'('
name|'self'
op|','
name|'instance_id'
op|','
name|'task'
op|','
name|'callback'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'ret'
op|'='
name|'None'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'ret'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'wait_for_task'
op|'('
name|'task'
op|','
name|'instance_id'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'XenAPI'
op|'.'
name|'Failure'
op|','
name|'exc'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'exception'
op|'('
name|'exc'
op|')'
newline|'\n'
dedent|''
name|'callback'
op|'('
name|'ret'
op|')'
newline|'\n'
nl|'\n'
DECL|member|pause
dedent|''
name|'def'
name|'pause'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'callback'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Pause VM instance."""'
newline|'\n'
name|'vm_ref'
op|'='
name|'self'
op|'.'
name|'_get_vm_opaque_ref'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'Async.VM.pause'"
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_wait_with_callback'
op|'('
name|'instance'
op|'.'
name|'id'
op|','
name|'task'
op|','
name|'callback'
op|')'
newline|'\n'
nl|'\n'
DECL|member|unpause
dedent|''
name|'def'
name|'unpause'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'callback'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Unpause VM instance."""'
newline|'\n'
name|'vm_ref'
op|'='
name|'self'
op|'.'
name|'_get_vm_opaque_ref'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'Async.VM.unpause'"
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_wait_with_callback'
op|'('
name|'instance'
op|'.'
name|'id'
op|','
name|'task'
op|','
name|'callback'
op|')'
newline|'\n'
nl|'\n'
DECL|member|suspend
dedent|''
name|'def'
name|'suspend'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'callback'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Suspend the specified instance."""'
newline|'\n'
name|'vm_ref'
op|'='
name|'self'
op|'.'
name|'_get_vm_opaque_ref'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'Async.VM.suspend'"
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_wait_with_callback'
op|'('
name|'instance'
op|'.'
name|'id'
op|','
name|'task'
op|','
name|'callback'
op|')'
newline|'\n'
nl|'\n'
DECL|member|resume
dedent|''
name|'def'
name|'resume'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'callback'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Resume the specified instance."""'
newline|'\n'
name|'vm_ref'
op|'='
name|'self'
op|'.'
name|'_get_vm_opaque_ref'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'Async.VM.resume'"
op|','
name|'vm_ref'
op|','
name|'False'
op|','
nl|'\n'
name|'True'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_wait_with_callback'
op|'('
name|'instance'
op|'.'
name|'id'
op|','
name|'task'
op|','
name|'callback'
op|')'
newline|'\n'
nl|'\n'
DECL|member|rescue
dedent|''
name|'def'
name|'rescue'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'_callback'
op|','
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Rescue the specified instance.\n\n            - shutdown the instance VM.\n            - set \'bootlock\' to prevent the instance from starting in rescue.\n            - spawn a rescue VM (the vm name-label will be instance-N-rescue).\n\n        """'
newline|'\n'
name|'rescue_vm_ref'
op|'='
name|'VMHelper'
op|'.'
name|'lookup'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
nl|'\n'
string|'"%s-rescue"'
op|'%'
name|'instance'
op|'.'
name|'name'
op|')'
newline|'\n'
name|'if'
name|'rescue_vm_ref'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'RuntimeError'
op|'('
name|'_'
op|'('
nl|'\n'
string|'"Instance is already in Rescue Mode: %s"'
op|'%'
name|'instance'
op|'.'
name|'name'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'vm_ref'
op|'='
name|'VMHelper'
op|'.'
name|'lookup'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'.'
name|'name'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_shutdown'
op|'('
name|'instance'
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_acquire_bootlock'
op|'('
name|'vm_ref'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'_rescue'
op|'='
name|'True'
newline|'\n'
name|'self'
op|'.'
name|'spawn_rescue'
op|'('
name|'context'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
newline|'\n'
name|'rescue_vm_ref'
op|'='
name|'VMHelper'
op|'.'
name|'lookup'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'.'
name|'name'
op|')'
newline|'\n'
name|'rescue_vbd_ref'
op|'='
name|'self'
op|'.'
name|'_find_rescue_vbd_ref'
op|'('
name|'vm_ref'
op|','
name|'rescue_vm_ref'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|'"Async.VBD.plug"'
op|','
name|'rescue_vbd_ref'
op|')'
newline|'\n'
nl|'\n'
DECL|member|unrescue
dedent|''
name|'def'
name|'unrescue'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'_callback'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Unrescue the specified instance.\n\n            - unplug the instance VM\'s disk from the rescue VM.\n            - teardown the rescue VM.\n            - release the bootlock to allow the instance VM to start.\n\n        """'
newline|'\n'
name|'rescue_vm_ref'
op|'='
name|'VMHelper'
op|'.'
name|'lookup'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
nl|'\n'
string|'"%s-rescue"'
op|'%'
name|'instance'
op|'.'
name|'name'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'not'
name|'rescue_vm_ref'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'InstanceNotInRescueMode'
op|'('
name|'instance_id'
op|'='
name|'instance'
op|'.'
name|'id'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'original_vm_ref'
op|'='
name|'VMHelper'
op|'.'
name|'lookup'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'.'
name|'name'
op|')'
newline|'\n'
name|'instance'
op|'.'
name|'_rescue'
op|'='
name|'False'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_destroy_rescue_instance'
op|'('
name|'rescue_vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_release_bootlock'
op|'('
name|'original_vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_start'
op|'('
name|'instance'
op|','
name|'original_vm_ref'
op|')'
newline|'\n'
nl|'\n'
DECL|member|poll_rescued_instances
dedent|''
name|'def'
name|'poll_rescued_instances'
op|'('
name|'self'
op|','
name|'timeout'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Look for expirable rescued instances.\n\n            - forcibly exit rescue mode for any instances that have been\n              in rescue mode for >= the provided timeout\n\n        """'
newline|'\n'
name|'last_ran'
op|'='
name|'self'
op|'.'
name|'poll_rescue_last_ran'
newline|'\n'
name|'if'
name|'not'
name|'last_ran'
op|':'
newline|'\n'
comment|'# We need a base time to start tracking.'
nl|'\n'
indent|'            '
name|'self'
op|'.'
name|'poll_rescue_last_ran'
op|'='
name|'utils'
op|'.'
name|'utcnow'
op|'('
op|')'
newline|'\n'
name|'return'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'not'
name|'utils'
op|'.'
name|'is_older_than'
op|'('
name|'last_ran'
op|','
name|'timeout'
op|')'
op|':'
newline|'\n'
comment|"# Do not run. Let's bail."
nl|'\n'
indent|'            '
name|'return'
newline|'\n'
nl|'\n'
comment|'# Update the time tracker and proceed.'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'poll_rescue_last_ran'
op|'='
name|'utils'
op|'.'
name|'utcnow'
op|'('
op|')'
newline|'\n'
nl|'\n'
name|'rescue_vms'
op|'='
op|'['
op|']'
newline|'\n'
name|'for'
name|'instance'
name|'in'
name|'self'
op|'.'
name|'list_instances'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'instance'
op|'.'
name|'endswith'
op|'('
string|'"-rescue"'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'rescue_vms'
op|'.'
name|'append'
op|'('
name|'dict'
op|'('
name|'name'
op|'='
name|'instance'
op|','
nl|'\n'
name|'vm_ref'
op|'='
name|'VMHelper'
op|'.'
name|'lookup'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
nl|'\n'
name|'instance'
op|')'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'for'
name|'vm'
name|'in'
name|'rescue_vms'
op|':'
newline|'\n'
indent|'            '
name|'rescue_vm_ref'
op|'='
name|'vm'
op|'['
string|'"vm_ref"'
op|']'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_destroy_rescue_instance'
op|'('
name|'rescue_vm_ref'
op|')'
newline|'\n'
nl|'\n'
name|'original_name'
op|'='
name|'vm'
op|'['
string|'"name"'
op|']'
op|'.'
name|'split'
op|'('
string|'"-rescue"'
op|','
number|'1'
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'original_vm_ref'
op|'='
name|'VMHelper'
op|'.'
name|'lookup'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'original_name'
op|')'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_release_bootlock'
op|'('
name|'original_vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|'"VM.start"'
op|','
name|'original_vm_ref'
op|','
name|'False'
op|','
nl|'\n'
name|'False'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_info
dedent|''
dedent|''
name|'def'
name|'get_info'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return data about VM instance."""'
newline|'\n'
name|'vm_ref'
op|'='
name|'self'
op|'.'
name|'_get_vm_opaque_ref'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'vm_rec'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'get_xenapi'
op|'('
op|')'
op|'.'
name|'VM'
op|'.'
name|'get_record'
op|'('
name|'vm_ref'
op|')'
newline|'\n'
name|'return'
name|'VMHelper'
op|'.'
name|'compile_info'
op|'('
name|'vm_rec'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_diagnostics
dedent|''
name|'def'
name|'get_diagnostics'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return data about VM diagnostics."""'
newline|'\n'
name|'vm_ref'
op|'='
name|'self'
op|'.'
name|'_get_vm_opaque_ref'
op|'('
name|'instance'
op|')'
newline|'\n'
name|'vm_rec'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'get_xenapi'
op|'('
op|')'
op|'.'
name|'VM'
op|'.'
name|'get_record'
op|'('
name|'vm_ref'
op|')'
newline|'\n'
name|'return'
name|'VMHelper'
op|'.'
name|'compile_diagnostics'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'vm_rec'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_console_output
dedent|''
name|'def'
name|'get_console_output'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return snapshot of console."""'
newline|'\n'
comment|'# TODO: implement this to fix pylint!'
nl|'\n'
name|'return'
string|"'FAKE CONSOLE OUTPUT of instance'"
newline|'\n'
nl|'\n'
DECL|member|get_ajax_console
dedent|''
name|'def'
name|'get_ajax_console'
op|'('
name|'self'
op|','
name|'instance'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return link to instance\'s ajax console."""'
newline|'\n'
comment|'# TODO: implement this!'
nl|'\n'
name|'return'
string|"'http://fakeajaxconsole/fake_url'"
newline|'\n'
nl|'\n'
DECL|member|host_power_action
dedent|''
name|'def'
name|'host_power_action'
op|'('
name|'self'
op|','
name|'host'
op|','
name|'action'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Reboots or shuts down the host."""'
newline|'\n'
name|'args'
op|'='
op|'{'
string|'"action"'
op|':'
name|'json'
op|'.'
name|'dumps'
op|'('
name|'action'
op|')'
op|'}'
newline|'\n'
name|'methods'
op|'='
op|'{'
string|'"reboot"'
op|':'
string|'"host_reboot"'
op|','
string|'"shutdown"'
op|':'
string|'"host_shutdown"'
op|'}'
newline|'\n'
name|'json_resp'
op|'='
name|'self'
op|'.'
name|'_call_xenhost'
op|'('
name|'methods'
op|'['
name|'action'
op|']'
op|','
name|'args'
op|')'
newline|'\n'
name|'resp'
op|'='
name|'json'
op|'.'
name|'loads'
op|'('
name|'json_resp'
op|')'
newline|'\n'
name|'return'
name|'resp'
op|'['
string|'"power_action"'
op|']'
newline|'\n'
nl|'\n'
DECL|member|set_host_enabled
dedent|''
name|'def'
name|'set_host_enabled'
op|'('
name|'self'
op|','
name|'host'
op|','
name|'enabled'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Sets the specified host\'s ability to accept new instances."""'
newline|'\n'
name|'args'
op|'='
op|'{'
string|'"enabled"'
op|':'
name|'json'
op|'.'
name|'dumps'
op|'('
name|'enabled'
op|')'
op|'}'
newline|'\n'
name|'xenapi_resp'
op|'='
name|'self'
op|'.'
name|'_call_xenhost'
op|'('
string|'"set_host_enabled"'
op|','
name|'args'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'resp'
op|'='
name|'json'
op|'.'
name|'loads'
op|'('
name|'xenapi_resp'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'TypeError'
name|'as'
name|'e'
op|':'
newline|'\n'
comment|'# Already logged; return the message'
nl|'\n'
indent|'            '
name|'return'
name|'xenapi_resp'
op|'.'
name|'details'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
dedent|''
name|'return'
name|'resp'
op|'['
string|'"status"'
op|']'
newline|'\n'
nl|'\n'
DECL|member|_call_xenhost
dedent|''
name|'def'
name|'_call_xenhost'
op|'('
name|'self'
op|','
name|'method'
op|','
name|'arg_dict'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""There will be several methods that will need this general\n        handling for interacting with the xenhost plugin, so this abstracts\n        out that behavior.\n        """'
newline|'\n'
comment|"# Create a task ID as something that won't match any instance ID"
nl|'\n'
name|'task_id'
op|'='
name|'random'
op|'.'
name|'randint'
op|'('
op|'-'
number|'80000'
op|','
op|'-'
number|'70000'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'async_call_plugin'
op|'('
string|'"xenhost"'
op|','
name|'method'
op|','
nl|'\n'
name|'args'
op|'='
name|'arg_dict'
op|')'
newline|'\n'
comment|'#args={"params": arg_dict})'
nl|'\n'
name|'ret'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'wait_for_task'
op|'('
name|'task'
op|','
name|'task_id'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'XenAPI'
op|'.'
name|'Failure'
name|'as'
name|'e'
op|':'
newline|'\n'
indent|'            '
name|'ret'
op|'='
name|'e'
newline|'\n'
name|'LOG'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
string|'"The call to %(method)s returned an error: %(e)s."'
op|')'
nl|'\n'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'ret'
newline|'\n'
nl|'\n'
DECL|member|inject_network_info
dedent|''
name|'def'
name|'inject_network_info'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'network_info'
op|','
name|'vm_ref'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Generate the network info and make calls to place it into the\n        xenstore and the xenstore param list.\n        vm_ref can be passed in because it will sometimes be different than\n        what VMHelper.lookup(session, instance.name) will find (ex: rescue)\n        """'
newline|'\n'
name|'if'
name|'vm_ref'
op|':'
newline|'\n'
comment|'# this function raises if vm_ref is not a vm_opaque_ref'
nl|'\n'
indent|'            '
name|'self'
op|'.'
name|'_session'
op|'.'
name|'get_xenapi'
op|'('
op|')'
op|'.'
name|'VM'
op|'.'
name|'get_record'
op|'('
name|'vm_ref'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'vm_ref'
op|'='
name|'VMHelper'
op|'.'
name|'lookup'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'.'
name|'name'
op|')'
newline|'\n'
dedent|''
name|'logging'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"injecting network info to xs for vm: |%s|"'
op|')'
op|','
name|'vm_ref'
op|')'
newline|'\n'
nl|'\n'
name|'for'
op|'('
name|'network'
op|','
name|'info'
op|')'
name|'in'
name|'network_info'
op|':'
newline|'\n'
indent|'            '
name|'location'
op|'='
string|"'vm-data/networking/%s'"
op|'%'
name|'info'
op|'['
string|"'mac'"
op|']'
op|'.'
name|'replace'
op|'('
string|"':'"
op|','
string|"''"
op|')'
newline|'\n'
name|'self'
op|'.'
name|'write_to_param_xenstore'
op|'('
name|'vm_ref'
op|','
op|'{'
name|'location'
op|':'
name|'info'
op|'}'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
comment|'# TODO(tr3buchet): fix function call after refactor'
nl|'\n'
comment|'#self.write_to_xenstore(vm_ref, location, info)'
nl|'\n'
indent|'                '
name|'self'
op|'.'
name|'_make_plugin_call'
op|'('
string|"'xenstore.py'"
op|','
string|"'write_record'"
op|','
name|'instance'
op|','
nl|'\n'
name|'location'
op|','
op|'{'
string|"'value'"
op|':'
name|'json'
op|'.'
name|'dumps'
op|'('
name|'info'
op|')'
op|'}'
op|','
nl|'\n'
name|'vm_ref'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'KeyError'
op|':'
newline|'\n'
comment|"# catch KeyError for domid if instance isn't running"
nl|'\n'
indent|'                '
name|'pass'
newline|'\n'
nl|'\n'
DECL|member|create_vifs
dedent|''
dedent|''
dedent|''
name|'def'
name|'create_vifs'
op|'('
name|'self'
op|','
name|'vm_ref'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Creates vifs for an instance."""'
newline|'\n'
nl|'\n'
name|'logging'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"creating vif(s) for vm: |%s|"'
op|')'
op|','
name|'vm_ref'
op|')'
newline|'\n'
nl|'\n'
comment|'# this function raises if vm_ref is not a vm_opaque_ref'
nl|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'get_xenapi'
op|'('
op|')'
op|'.'
name|'VM'
op|'.'
name|'get_record'
op|'('
name|'vm_ref'
op|')'
newline|'\n'
nl|'\n'
name|'for'
name|'device'
op|','
op|'('
name|'network'
op|','
name|'info'
op|')'
name|'in'
name|'enumerate'
op|'('
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'vif_rec'
op|'='
name|'self'
op|'.'
name|'vif_driver'
op|'.'
name|'plug'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
nl|'\n'
name|'vm_ref'
op|','
name|'instance'
op|','
name|'device'
op|','
name|'network'
op|','
name|'info'
op|')'
newline|'\n'
name|'network_ref'
op|'='
name|'vif_rec'
op|'['
string|"'network'"
op|']'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|"'Creating VIF for VM %(vm_ref)s,'"
string|"' network %(network_ref)s.'"
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'vif_ref'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'VIF.create'"
op|','
name|'vif_rec'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|"'Created VIF %(vif_ref)s for VM %(vm_ref)s,'"
nl|'\n'
string|"' network %(network_ref)s.'"
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|plug_vifs
dedent|''
dedent|''
name|'def'
name|'plug_vifs'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'network_info'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Set up VIF networking on the host."""'
newline|'\n'
name|'for'
op|'('
name|'network'
op|','
name|'mapping'
op|')'
name|'in'
name|'network_info'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'vif_driver'
op|'.'
name|'plug'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|','
name|'network'
op|','
name|'mapping'
op|')'
newline|'\n'
nl|'\n'
DECL|member|reset_network
dedent|''
dedent|''
name|'def'
name|'reset_network'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'vm_ref'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Creates uuid arg to pass to make_agent_call and calls it."""'
newline|'\n'
name|'if'
name|'not'
name|'vm_ref'
op|':'
newline|'\n'
indent|'            '
name|'vm_ref'
op|'='
name|'VMHelper'
op|'.'
name|'lookup'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'instance'
op|'.'
name|'name'
op|')'
newline|'\n'
dedent|''
name|'args'
op|'='
op|'{'
string|"'id'"
op|':'
name|'str'
op|'('
name|'uuid'
op|'.'
name|'uuid4'
op|'('
op|')'
op|')'
op|'}'
newline|'\n'
comment|'# TODO(tr3buchet): fix function call after refactor'
nl|'\n'
comment|"#resp = self._make_agent_call('resetnetwork', instance, '', args)"
nl|'\n'
name|'resp'
op|'='
name|'self'
op|'.'
name|'_make_plugin_call'
op|'('
string|"'agent'"
op|','
string|"'resetnetwork'"
op|','
name|'instance'
op|','
string|"''"
op|','
nl|'\n'
name|'args'
op|','
name|'vm_ref'
op|')'
newline|'\n'
nl|'\n'
DECL|member|inject_hostname
dedent|''
name|'def'
name|'inject_hostname'
op|'('
name|'self'
op|','
name|'instance'
op|','
name|'vm_ref'
op|','
name|'hostname'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Inject the hostname of the instance into the xenstore."""'
newline|'\n'
name|'if'
name|'instance'
op|'.'
name|'os_type'
op|'=='
string|'"windows"'
op|':'
newline|'\n'
comment|'# NOTE(jk0): Windows hostnames can only be <= 15 chars.'
nl|'\n'
indent|'            '
name|'hostname'
op|'='
name|'hostname'
op|'['
op|':'
number|'15'
op|']'
newline|'\n'
nl|'\n'
dedent|''
name|'logging'
op|'.'
name|'debug'
op|'('
name|'_'
op|'('
string|'"injecting hostname to xs for vm: |%s|"'
op|')'
op|','
name|'vm_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi_request'
op|'('
string|'"VM.add_to_xenstore_data"'
op|','
nl|'\n'
op|'('
name|'vm_ref'
op|','
string|'"vm-data/hostname"'
op|','
name|'hostname'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|list_from_xenstore
dedent|''
name|'def'
name|'list_from_xenstore'
op|'('
name|'self'
op|','
name|'vm'
op|','
name|'path'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Runs the xenstore-ls command to get a listing of all records\n        from \'path\' downward. Returns a dict with the sub-paths as keys,\n        and the value stored in those paths as values. If nothing is\n        found at that path, returns None.\n        """'
newline|'\n'
name|'ret'
op|'='
name|'self'
op|'.'
name|'_make_xenstore_call'
op|'('
string|"'list_records'"
op|','
name|'vm'
op|','
name|'path'
op|')'
newline|'\n'
name|'return'
name|'json'
op|'.'
name|'loads'
op|'('
name|'ret'
op|')'
newline|'\n'
nl|'\n'
DECL|member|read_from_xenstore
dedent|''
name|'def'
name|'read_from_xenstore'
op|'('
name|'self'
op|','
name|'vm'
op|','
name|'path'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Returns the value stored in the xenstore record for the given VM\n        at the specified location. A XenAPIPlugin.PluginError will be raised\n        if any error is encountered in the read process.\n        """'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'ret'
op|'='
name|'self'
op|'.'
name|'_make_xenstore_call'
op|'('
string|"'read_record'"
op|','
name|'vm'
op|','
name|'path'
op|','
nl|'\n'
op|'{'
string|"'ignore_missing_path'"
op|':'
string|"'True'"
op|'}'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'XenAPI'
op|'.'
name|'Failure'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'ret'
op|'='
name|'json'
op|'.'
name|'loads'
op|'('
name|'ret'
op|')'
newline|'\n'
name|'if'
name|'ret'
op|'=='
string|'"None"'
op|':'
newline|'\n'
comment|"# Can't marshall None over RPC calls."
nl|'\n'
indent|'            '
name|'return'
name|'None'
newline|'\n'
dedent|''
name|'return'
name|'ret'
newline|'\n'
nl|'\n'
DECL|member|write_to_xenstore
dedent|''
name|'def'
name|'write_to_xenstore'
op|'('
name|'self'
op|','
name|'vm'
op|','
name|'path'
op|','
name|'value'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Writes the passed value to the xenstore record for the given VM\n        at the specified location. A XenAPIPlugin.PluginError will be raised\n        if any error is encountered in the write process.\n        """'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'_make_xenstore_call'
op|'('
string|"'write_record'"
op|','
name|'vm'
op|','
name|'path'
op|','
nl|'\n'
op|'{'
string|"'value'"
op|':'
name|'json'
op|'.'
name|'dumps'
op|'('
name|'value'
op|')'
op|'}'
op|')'
newline|'\n'
nl|'\n'
DECL|member|clear_xenstore
dedent|''
name|'def'
name|'clear_xenstore'
op|'('
name|'self'
op|','
name|'vm'
op|','
name|'path'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Deletes the VM\'s xenstore record for the specified path.\n        If there is no such record, the request is ignored.\n        """'
newline|'\n'
name|'self'
op|'.'
name|'_make_xenstore_call'
op|'('
string|"'delete_record'"
op|','
name|'vm'
op|','
name|'path'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_make_xenstore_call
dedent|''
name|'def'
name|'_make_xenstore_call'
op|'('
name|'self'
op|','
name|'method'
op|','
name|'vm'
op|','
name|'path'
op|','
name|'addl_args'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Handles calls to the xenstore xenapi plugin."""'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'_make_plugin_call'
op|'('
string|"'xenstore.py'"
op|','
name|'method'
op|'='
name|'method'
op|','
name|'vm'
op|'='
name|'vm'
op|','
nl|'\n'
name|'path'
op|'='
name|'path'
op|','
name|'addl_args'
op|'='
name|'addl_args'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_make_agent_call
dedent|''
name|'def'
name|'_make_agent_call'
op|'('
name|'self'
op|','
name|'method'
op|','
name|'vm'
op|','
name|'path'
op|','
name|'addl_args'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Abstracts out the interaction with the agent xenapi plugin."""'
newline|'\n'
name|'ret'
op|'='
name|'self'
op|'.'
name|'_make_plugin_call'
op|'('
string|"'agent'"
op|','
name|'method'
op|'='
name|'method'
op|','
name|'vm'
op|'='
name|'vm'
op|','
nl|'\n'
name|'path'
op|'='
name|'path'
op|','
name|'addl_args'
op|'='
name|'addl_args'
op|')'
newline|'\n'
name|'if'
name|'isinstance'
op|'('
name|'ret'
op|','
name|'dict'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'ret'
newline|'\n'
dedent|''
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'json'
op|'.'
name|'loads'
op|'('
name|'ret'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'TypeError'
op|':'
newline|'\n'
indent|'            '
name|'instance_id'
op|'='
name|'vm'
op|'.'
name|'id'
newline|'\n'
name|'LOG'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
string|"'The agent call to %(method)s returned an invalid'"
nl|'\n'
string|"' response: %(ret)r. VM id=%(instance_id)s;'"
nl|'\n'
string|"' path=%(path)s; args=%(addl_args)r'"
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'return'
op|'{'
string|"'returncode'"
op|':'
string|"'error'"
op|','
nl|'\n'
string|"'message'"
op|':'
string|"'unable to deserialize response'"
op|'}'
newline|'\n'
nl|'\n'
DECL|member|_make_plugin_call
dedent|''
dedent|''
name|'def'
name|'_make_plugin_call'
op|'('
name|'self'
op|','
name|'plugin'
op|','
name|'method'
op|','
name|'vm'
op|','
name|'path'
op|','
name|'addl_args'
op|'='
name|'None'
op|','
nl|'\n'
name|'vm_ref'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Abstracts out the process of calling a method of a xenapi plugin.\n        Any errors raised by the plugin will in turn raise a RuntimeError here.\n        """'
newline|'\n'
name|'instance_id'
op|'='
name|'vm'
op|'.'
name|'id'
newline|'\n'
name|'vm_ref'
op|'='
name|'vm_ref'
name|'or'
name|'self'
op|'.'
name|'_get_vm_opaque_ref'
op|'('
name|'vm'
op|')'
newline|'\n'
name|'vm_rec'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'get_xenapi'
op|'('
op|')'
op|'.'
name|'VM'
op|'.'
name|'get_record'
op|'('
name|'vm_ref'
op|')'
newline|'\n'
name|'args'
op|'='
op|'{'
string|"'dom_id'"
op|':'
name|'vm_rec'
op|'['
string|"'domid'"
op|']'
op|','
string|"'path'"
op|':'
name|'path'
op|'}'
newline|'\n'
name|'args'
op|'.'
name|'update'
op|'('
name|'addl_args'
name|'or'
op|'{'
op|'}'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'task'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'async_call_plugin'
op|'('
name|'plugin'
op|','
name|'method'
op|','
name|'args'
op|')'
newline|'\n'
name|'ret'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'wait_for_task'
op|'('
name|'task'
op|','
name|'instance_id'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'XenAPI'
op|'.'
name|'Failure'
op|','
name|'e'
op|':'
newline|'\n'
indent|'            '
name|'ret'
op|'='
name|'None'
newline|'\n'
name|'err_msg'
op|'='
name|'e'
op|'.'
name|'details'
op|'['
op|'-'
number|'1'
op|']'
op|'.'
name|'splitlines'
op|'('
op|')'
op|'['
op|'-'
number|'1'
op|']'
newline|'\n'
name|'if'
string|"'TIMEOUT:'"
name|'in'
name|'err_msg'
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
string|"'TIMEOUT: The call to %(method)s timed out. '"
nl|'\n'
string|"'VM id=%(instance_id)s; args=%(args)r'"
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'return'
op|'{'
string|"'returncode'"
op|':'
string|"'timeout'"
op|','
string|"'message'"
op|':'
name|'err_msg'
op|'}'
newline|'\n'
dedent|''
name|'elif'
string|"'NOT IMPLEMENTED:'"
name|'in'
name|'err_msg'
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
string|"'NOT IMPLEMENTED: The call to %(method)s is not'"
nl|'\n'
string|"' supported by the agent. VM id=%(instance_id)s;'"
nl|'\n'
string|"' args=%(args)r'"
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'return'
op|'{'
string|"'returncode'"
op|':'
string|"'notimplemented'"
op|','
string|"'message'"
op|':'
name|'err_msg'
op|'}'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
string|"'The call to %(method)s returned an error: %(e)s. '"
nl|'\n'
string|"'VM id=%(instance_id)s; args=%(args)r'"
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'return'
op|'{'
string|"'returncode'"
op|':'
string|"'error'"
op|','
string|"'message'"
op|':'
name|'err_msg'
op|'}'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'ret'
newline|'\n'
nl|'\n'
DECL|member|add_to_xenstore
dedent|''
name|'def'
name|'add_to_xenstore'
op|'('
name|'self'
op|','
name|'vm'
op|','
name|'path'
op|','
name|'key'
op|','
name|'value'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Adds the passed key/value pair to the xenstore record for\n        the given VM at the specified location. A XenAPIPlugin.PluginError\n        will be raised if any error is encountered in the write process.\n        """'
newline|'\n'
name|'current'
op|'='
name|'self'
op|'.'
name|'read_from_xenstore'
op|'('
name|'vm'
op|','
name|'path'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'current'
op|':'
newline|'\n'
comment|'# Nothing at that location'
nl|'\n'
indent|'            '
name|'current'
op|'='
op|'{'
name|'key'
op|':'
name|'value'
op|'}'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'current'
op|'['
name|'key'
op|']'
op|'='
name|'value'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'write_to_xenstore'
op|'('
name|'vm'
op|','
name|'path'
op|','
name|'current'
op|')'
newline|'\n'
nl|'\n'
DECL|member|remove_from_xenstore
dedent|''
name|'def'
name|'remove_from_xenstore'
op|'('
name|'self'
op|','
name|'vm'
op|','
name|'path'
op|','
name|'key_or_keys'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Takes either a single key or a list of keys and removes\n        them from the xenstoreirecord data for the given VM.\n        If the key doesn\'t exist, the request is ignored.\n        """'
newline|'\n'
name|'current'
op|'='
name|'self'
op|'.'
name|'list_from_xenstore'
op|'('
name|'vm'
op|','
name|'path'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'current'
op|':'
newline|'\n'
indent|'            '
name|'return'
newline|'\n'
dedent|''
name|'if'
name|'isinstance'
op|'('
name|'key_or_keys'
op|','
name|'basestring'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'keys'
op|'='
op|'['
name|'key_or_keys'
op|']'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'keys'
op|'='
name|'key_or_keys'
newline|'\n'
dedent|''
name|'keys'
op|'.'
name|'sort'
op|'('
name|'lambda'
name|'x'
op|','
name|'y'
op|':'
name|'cmp'
op|'('
name|'y'
op|'.'
name|'count'
op|'('
string|"'/'"
op|')'
op|','
name|'x'
op|'.'
name|'count'
op|'('
string|"'/'"
op|')'
op|')'
op|')'
newline|'\n'
name|'for'
name|'key'
name|'in'
name|'keys'
op|':'
newline|'\n'
indent|'            '
name|'if'
name|'path'
op|':'
newline|'\n'
indent|'                '
name|'keypath'
op|'='
string|'"%s/%s"'
op|'%'
op|'('
name|'path'
op|','
name|'key'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'keypath'
op|'='
name|'key'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_make_xenstore_call'
op|'('
string|"'delete_record'"
op|','
name|'vm'
op|','
name|'keypath'
op|')'
newline|'\n'
nl|'\n'
comment|'########################################################################'
nl|'\n'
comment|'###### The following methods interact with the xenstore parameter'
nl|'\n'
comment|'###### record, not the live xenstore. They were created before I'
nl|'\n'
comment|'###### knew the difference, and are left in here in case they prove'
nl|'\n'
comment|"###### to be useful. They all have '_param' added to their method"
nl|'\n'
comment|'###### names to distinguish them. (dabo)'
nl|'\n'
comment|'########################################################################'
nl|'\n'
DECL|member|read_partial_from_param_xenstore
dedent|''
dedent|''
name|'def'
name|'read_partial_from_param_xenstore'
op|'('
name|'self'
op|','
name|'instance_or_vm'
op|','
name|'key_prefix'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Returns a dict of all the keys in the xenstore parameter record\n        for the given instance that begin with the key_prefix.\n        """'
newline|'\n'
name|'data'
op|'='
name|'self'
op|'.'
name|'read_from_param_xenstore'
op|'('
name|'instance_or_vm'
op|')'
newline|'\n'
name|'badkeys'
op|'='
op|'['
name|'k'
name|'for'
name|'k'
name|'in'
name|'data'
op|'.'
name|'keys'
op|'('
op|')'
nl|'\n'
name|'if'
name|'not'
name|'k'
op|'.'
name|'startswith'
op|'('
name|'key_prefix'
op|')'
op|']'
newline|'\n'
name|'for'
name|'badkey'
name|'in'
name|'badkeys'
op|':'
newline|'\n'
indent|'            '
name|'del'
name|'data'
op|'['
name|'badkey'
op|']'
newline|'\n'
dedent|''
name|'return'
name|'data'
newline|'\n'
nl|'\n'
DECL|member|read_from_param_xenstore
dedent|''
name|'def'
name|'read_from_param_xenstore'
op|'('
name|'self'
op|','
name|'instance_or_vm'
op|','
name|'keys'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Returns the xenstore parameter record data for the specified VM\n        instance as a dict. Accepts an optional key or list of keys; if a\n        value for \'keys\' is passed, the returned dict is filtered to only\n        return the values for those keys.\n        """'
newline|'\n'
name|'vm_ref'
op|'='
name|'self'
op|'.'
name|'_get_vm_opaque_ref'
op|'('
name|'instance_or_vm'
op|')'
newline|'\n'
name|'data'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi_request'
op|'('
string|"'VM.get_xenstore_data'"
op|','
nl|'\n'
op|'('
name|'vm_ref'
op|','
op|')'
op|')'
newline|'\n'
name|'ret'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'if'
name|'keys'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'keys'
op|'='
name|'data'
op|'.'
name|'keys'
op|'('
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'isinstance'
op|'('
name|'keys'
op|','
name|'basestring'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'keys'
op|'='
op|'['
name|'keys'
op|']'
newline|'\n'
dedent|''
name|'for'
name|'key'
name|'in'
name|'keys'
op|':'
newline|'\n'
indent|'            '
name|'raw'
op|'='
name|'data'
op|'.'
name|'get'
op|'('
name|'key'
op|')'
newline|'\n'
name|'if'
name|'raw'
op|':'
newline|'\n'
indent|'                '
name|'ret'
op|'['
name|'key'
op|']'
op|'='
name|'json'
op|'.'
name|'loads'
op|'('
name|'raw'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                '
name|'ret'
op|'['
name|'key'
op|']'
op|'='
name|'raw'
newline|'\n'
dedent|''
dedent|''
name|'return'
name|'ret'
newline|'\n'
nl|'\n'
DECL|member|add_to_param_xenstore
dedent|''
name|'def'
name|'add_to_param_xenstore'
op|'('
name|'self'
op|','
name|'instance_or_vm'
op|','
name|'key'
op|','
name|'val'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Takes a key/value pair and adds it to the xenstore parameter\n        record for the given vm instance. If the key exists in xenstore,\n        it is overwritten\n        """'
newline|'\n'
name|'vm_ref'
op|'='
name|'self'
op|'.'
name|'_get_vm_opaque_ref'
op|'('
name|'instance_or_vm'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'remove_from_param_xenstore'
op|'('
name|'instance_or_vm'
op|','
name|'key'
op|')'
newline|'\n'
name|'jsonval'
op|'='
name|'json'
op|'.'
name|'dumps'
op|'('
name|'val'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi_request'
op|'('
string|"'VM.add_to_xenstore_data'"
op|','
nl|'\n'
op|'('
name|'vm_ref'
op|','
name|'key'
op|','
name|'jsonval'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|write_to_param_xenstore
dedent|''
name|'def'
name|'write_to_param_xenstore'
op|'('
name|'self'
op|','
name|'instance_or_vm'
op|','
name|'mapping'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Takes a dict and writes each key/value pair to the xenstore\n        parameter record for the given vm instance. Any existing data for\n        those keys is overwritten.\n        """'
newline|'\n'
name|'for'
name|'k'
op|','
name|'v'
name|'in'
name|'mapping'
op|'.'
name|'iteritems'
op|'('
op|')'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'add_to_param_xenstore'
op|'('
name|'instance_or_vm'
op|','
name|'k'
op|','
name|'v'
op|')'
newline|'\n'
nl|'\n'
DECL|member|remove_from_param_xenstore
dedent|''
dedent|''
name|'def'
name|'remove_from_param_xenstore'
op|'('
name|'self'
op|','
name|'instance_or_vm'
op|','
name|'key_or_keys'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        Takes either a single key or a list of keys and removes\n        them from the xenstore parameter record data for the given VM.\n        If the key doesn\'t exist, the request is ignored.\n        """'
newline|'\n'
name|'vm_ref'
op|'='
name|'self'
op|'.'
name|'_get_vm_opaque_ref'
op|'('
name|'instance_or_vm'
op|')'
newline|'\n'
name|'if'
name|'isinstance'
op|'('
name|'key_or_keys'
op|','
name|'basestring'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'keys'
op|'='
op|'['
name|'key_or_keys'
op|']'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'keys'
op|'='
name|'key_or_keys'
newline|'\n'
dedent|''
name|'for'
name|'key'
name|'in'
name|'keys'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi_request'
op|'('
string|"'VM.remove_from_xenstore_data'"
op|','
nl|'\n'
op|'('
name|'vm_ref'
op|','
name|'key'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|clear_param_xenstore
dedent|''
dedent|''
name|'def'
name|'clear_param_xenstore'
op|'('
name|'self'
op|','
name|'instance_or_vm'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Removes all data from the xenstore parameter record for this VM."""'
newline|'\n'
name|'self'
op|'.'
name|'write_to_param_xenstore'
op|'('
name|'instance_or_vm'
op|','
op|'{'
op|'}'
op|')'
newline|'\n'
comment|'########################################################################'
nl|'\n'
nl|'\n'
nl|'\n'
DECL|class|SimpleDH
dedent|''
dedent|''
name|'class'
name|'SimpleDH'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    This class wraps all the functionality needed to implement\n    basic Diffie-Hellman-Merkle key exchange in Python. It features\n    intelligent defaults for the prime and base numbers needed for the\n    calculation, while allowing you to supply your own. It requires that\n    the openssl binary be installed on the system on which this is run,\n    as it uses that to handle the encryption and decryption. If openssl\n    is not available, a RuntimeError will be raised.\n    """'
newline|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'prime'
op|'='
name|'None'
op|','
name|'base'
op|'='
name|'None'
op|','
name|'secret'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""\n        You can specify the values for prime and base if you wish;\n        otherwise, reasonable default values will be used.\n        """'
newline|'\n'
name|'if'
name|'prime'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_prime'
op|'='
number|'162259276829213363391578010288127'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_prime'
op|'='
name|'prime'
newline|'\n'
dedent|''
name|'if'
name|'base'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_base'
op|'='
number|'5'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_base'
op|'='
name|'base'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_shared'
op|'='
name|'self'
op|'.'
name|'_public'
op|'='
name|'None'
newline|'\n'
nl|'\n'
name|'self'
op|'.'
name|'_dh'
op|'='
name|'M2Crypto'
op|'.'
name|'DH'
op|'.'
name|'set_params'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'dec_to_mpi'
op|'('
name|'self'
op|'.'
name|'_prime'
op|')'
op|','
nl|'\n'
name|'self'
op|'.'
name|'dec_to_mpi'
op|'('
name|'self'
op|'.'
name|'_base'
op|')'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_dh'
op|'.'
name|'gen_key'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_public'
op|'='
name|'self'
op|'.'
name|'mpi_to_dec'
op|'('
name|'self'
op|'.'
name|'_dh'
op|'.'
name|'pub'
op|')'
newline|'\n'
nl|'\n'
DECL|member|get_public
dedent|''
name|'def'
name|'get_public'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'_public'
newline|'\n'
nl|'\n'
DECL|member|compute_shared
dedent|''
name|'def'
name|'compute_shared'
op|'('
name|'self'
op|','
name|'other'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'_shared'
op|'='
name|'self'
op|'.'
name|'bin_to_dec'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'_dh'
op|'.'
name|'compute_key'
op|'('
name|'self'
op|'.'
name|'dec_to_mpi'
op|'('
name|'other'
op|')'
op|')'
op|')'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'_shared'
newline|'\n'
nl|'\n'
DECL|member|mpi_to_dec
dedent|''
name|'def'
name|'mpi_to_dec'
op|'('
name|'self'
op|','
name|'mpi'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'bn'
op|'='
name|'M2Crypto'
op|'.'
name|'m2'
op|'.'
name|'mpi_to_bn'
op|'('
name|'mpi'
op|')'
newline|'\n'
name|'hexval'
op|'='
name|'M2Crypto'
op|'.'
name|'m2'
op|'.'
name|'bn_to_hex'
op|'('
name|'bn'
op|')'
newline|'\n'
name|'dec'
op|'='
name|'int'
op|'('
name|'hexval'
op|','
number|'16'
op|')'
newline|'\n'
name|'return'
name|'dec'
newline|'\n'
nl|'\n'
DECL|member|bin_to_dec
dedent|''
name|'def'
name|'bin_to_dec'
op|'('
name|'self'
op|','
name|'binval'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'bn'
op|'='
name|'M2Crypto'
op|'.'
name|'m2'
op|'.'
name|'bin_to_bn'
op|'('
name|'binval'
op|')'
newline|'\n'
name|'hexval'
op|'='
name|'M2Crypto'
op|'.'
name|'m2'
op|'.'
name|'bn_to_hex'
op|'('
name|'bn'
op|')'
newline|'\n'
name|'dec'
op|'='
name|'int'
op|'('
name|'hexval'
op|','
number|'16'
op|')'
newline|'\n'
name|'return'
name|'dec'
newline|'\n'
nl|'\n'
DECL|member|dec_to_mpi
dedent|''
name|'def'
name|'dec_to_mpi'
op|'('
name|'self'
op|','
name|'dec'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'bn'
op|'='
name|'M2Crypto'
op|'.'
name|'m2'
op|'.'
name|'dec_to_bn'
op|'('
string|"'%s'"
op|'%'
name|'dec'
op|')'
newline|'\n'
name|'mpi'
op|'='
name|'M2Crypto'
op|'.'
name|'m2'
op|'.'
name|'bn_to_mpi'
op|'('
name|'bn'
op|')'
newline|'\n'
name|'return'
name|'mpi'
newline|'\n'
nl|'\n'
DECL|member|_run_ssl
dedent|''
name|'def'
name|'_run_ssl'
op|'('
name|'self'
op|','
name|'text'
op|','
name|'decrypt'
op|'='
name|'False'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'cmd'
op|'='
op|'['
string|"'openssl'"
op|','
string|"'aes-128-cbc'"
op|','
string|"'-A'"
op|','
string|"'-a'"
op|','
string|"'-pass'"
op|','
nl|'\n'
string|"'pass:%s'"
op|'%'
name|'self'
op|'.'
name|'_shared'
op|','
string|"'-nosalt'"
op|']'
newline|'\n'
name|'if'
name|'decrypt'
op|':'
newline|'\n'
indent|'            '
name|'cmd'
op|'.'
name|'append'
op|'('
string|"'-d'"
op|')'
newline|'\n'
dedent|''
name|'out'
op|','
name|'err'
op|'='
name|'utils'
op|'.'
name|'execute'
op|'('
op|'*'
name|'cmd'
op|','
name|'process_input'
op|'='
name|'text'
op|')'
newline|'\n'
name|'if'
name|'err'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'RuntimeError'
op|'('
name|'_'
op|'('
string|"'OpenSSL error: %s'"
op|')'
op|'%'
name|'err'
op|')'
newline|'\n'
dedent|''
name|'return'
name|'out'
newline|'\n'
nl|'\n'
DECL|member|encrypt
dedent|''
name|'def'
name|'encrypt'
op|'('
name|'self'
op|','
name|'text'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'_run_ssl'
op|'('
name|'text'
op|')'
op|'.'
name|'strip'
op|'('
string|"'\\n'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|decrypt
dedent|''
name|'def'
name|'decrypt'
op|'('
name|'self'
op|','
name|'text'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'_run_ssl'
op|'('
name|'text'
op|','
name|'decrypt'
op|'='
name|'True'
op|')'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
