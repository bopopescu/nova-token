begin_unit
comment|'# vim: tabstop=4 shiftwidth=4 softtabstop=4'
nl|'\n'
nl|'\n'
comment|'# Copyright (c) 2012 Citrix Systems, Inc.'
nl|'\n'
comment|'# Copyright 2010 OpenStack LLC.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
string|'"""\nManagement class for Pool-related functions (join, eject, etc).\n"""'
newline|'\n'
nl|'\n'
name|'import'
name|'json'
newline|'\n'
name|'import'
name|'urlparse'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
op|'.'
name|'compute'
name|'import'
name|'aggregate_states'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'db'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'flags'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'log'
name|'as'
name|'logging'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'openstack'
op|'.'
name|'common'
name|'import'
name|'cfg'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'rpc'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
op|'.'
name|'xenapi'
name|'import'
name|'vm_utils'
newline|'\n'
nl|'\n'
DECL|variable|LOG
name|'LOG'
op|'='
name|'logging'
op|'.'
name|'getLogger'
op|'('
name|'__name__'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|xenapi_pool_opts
name|'xenapi_pool_opts'
op|'='
op|'['
nl|'\n'
name|'cfg'
op|'.'
name|'BoolOpt'
op|'('
string|"'use_join_force'"
op|','
nl|'\n'
DECL|variable|default
name|'default'
op|'='
name|'True'
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'To use for hosts with different CPUs'"
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
DECL|variable|FLAGS
name|'FLAGS'
op|'='
name|'flags'
op|'.'
name|'FLAGS'
newline|'\n'
name|'FLAGS'
op|'.'
name|'register_opts'
op|'('
name|'xenapi_pool_opts'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ResourcePool
name|'class'
name|'ResourcePool'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Implements resource pool operations.\n    """'
newline|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'session'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'XenAPI'
op|'='
name|'session'
op|'.'
name|'get_imported_xenapi'
op|'('
op|')'
newline|'\n'
name|'host_ref'
op|'='
name|'session'
op|'.'
name|'get_xenapi_host'
op|'('
op|')'
newline|'\n'
name|'host_rec'
op|'='
name|'session'
op|'.'
name|'call_xenapi'
op|'('
string|"'host.get_record'"
op|','
name|'host_ref'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_host_name'
op|'='
name|'host_rec'
op|'['
string|"'hostname'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'_host_addr'
op|'='
name|'host_rec'
op|'['
string|"'address'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'_host_uuid'
op|'='
name|'host_rec'
op|'['
string|"'uuid'"
op|']'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'='
name|'session'
newline|'\n'
nl|'\n'
DECL|member|add_to_aggregate
dedent|''
name|'def'
name|'add_to_aggregate'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'aggregate'
op|','
name|'host'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Add a compute host to an aggregate."""'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'aggregate'
op|'.'
name|'hosts'
op|')'
op|'=='
number|'1'
op|':'
newline|'\n'
comment|'# this is the first host of the pool -> make it master'
nl|'\n'
indent|'            '
name|'self'
op|'.'
name|'_init_pool'
op|'('
name|'aggregate'
op|'.'
name|'id'
op|','
name|'aggregate'
op|'.'
name|'name'
op|')'
newline|'\n'
comment|'# save metadata so that we can find the master again'
nl|'\n'
name|'values'
op|'='
op|'{'
nl|'\n'
string|"'operational_state'"
op|':'
name|'aggregate_states'
op|'.'
name|'ACTIVE'
op|','
nl|'\n'
string|"'metadata'"
op|':'
op|'{'
string|"'master_compute'"
op|':'
name|'host'
op|','
nl|'\n'
name|'host'
op|':'
name|'self'
op|'.'
name|'_host_uuid'
op|'}'
op|','
nl|'\n'
op|'}'
newline|'\n'
name|'db'
op|'.'
name|'aggregate_update'
op|'('
name|'context'
op|','
name|'aggregate'
op|'.'
name|'id'
op|','
name|'values'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
comment|'# the pool is already up and running, we need to figure out'
nl|'\n'
comment|'# whether we can serve the request from this host or not.'
nl|'\n'
indent|'            '
name|'master_compute'
op|'='
name|'aggregate'
op|'.'
name|'metadetails'
op|'['
string|"'master_compute'"
op|']'
newline|'\n'
name|'if'
name|'master_compute'
op|'=='
name|'FLAGS'
op|'.'
name|'host'
name|'and'
name|'master_compute'
op|'!='
name|'host'
op|':'
newline|'\n'
comment|'# this is the master ->  do a pool-join'
nl|'\n'
comment|'# To this aim, nova compute on the slave has to go down.'
nl|'\n'
comment|'# NOTE: it is assumed that ONLY nova compute is running now'
nl|'\n'
indent|'                '
name|'self'
op|'.'
name|'_join_slave'
op|'('
name|'aggregate'
op|'.'
name|'id'
op|','
name|'host'
op|','
nl|'\n'
name|'kwargs'
op|'.'
name|'get'
op|'('
string|"'compute_uuid'"
op|')'
op|','
nl|'\n'
name|'kwargs'
op|'.'
name|'get'
op|'('
string|"'url'"
op|')'
op|','
name|'kwargs'
op|'.'
name|'get'
op|'('
string|"'user'"
op|')'
op|','
nl|'\n'
name|'kwargs'
op|'.'
name|'get'
op|'('
string|"'passwd'"
op|')'
op|')'
newline|'\n'
name|'metadata'
op|'='
op|'{'
name|'host'
op|':'
name|'kwargs'
op|'.'
name|'get'
op|'('
string|"'xenhost_uuid'"
op|')'
op|','
op|'}'
newline|'\n'
name|'db'
op|'.'
name|'aggregate_metadata_add'
op|'('
name|'context'
op|','
name|'aggregate'
op|'.'
name|'id'
op|','
name|'metadata'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'master_compute'
name|'and'
name|'master_compute'
op|'!='
name|'host'
op|':'
newline|'\n'
comment|'# send rpc cast to master, asking to add the following'
nl|'\n'
comment|'# host with specified credentials.'
nl|'\n'
indent|'                '
name|'forward_request'
op|'('
name|'context'
op|','
string|'"add_aggregate_host"'
op|','
name|'master_compute'
op|','
nl|'\n'
name|'aggregate'
op|'.'
name|'id'
op|','
name|'host'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_host_addr'
op|','
name|'self'
op|'.'
name|'_host_uuid'
op|')'
newline|'\n'
nl|'\n'
DECL|member|remove_from_aggregate
dedent|''
dedent|''
dedent|''
name|'def'
name|'remove_from_aggregate'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'aggregate'
op|','
name|'host'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Remove a compute host from an aggregate."""'
newline|'\n'
name|'master_compute'
op|'='
name|'aggregate'
op|'.'
name|'metadetails'
op|'.'
name|'get'
op|'('
string|"'master_compute'"
op|')'
newline|'\n'
name|'if'
name|'master_compute'
op|'=='
name|'FLAGS'
op|'.'
name|'host'
name|'and'
name|'master_compute'
op|'!='
name|'host'
op|':'
newline|'\n'
comment|'# this is the master -> instruct it to eject a host from the pool'
nl|'\n'
indent|'            '
name|'host_uuid'
op|'='
name|'db'
op|'.'
name|'aggregate_metadata_get'
op|'('
name|'context'
op|','
name|'aggregate'
op|'.'
name|'id'
op|')'
op|'['
name|'host'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'_eject_slave'
op|'('
name|'aggregate'
op|'.'
name|'id'
op|','
nl|'\n'
name|'kwargs'
op|'.'
name|'get'
op|'('
string|"'compute_uuid'"
op|')'
op|','
name|'host_uuid'
op|')'
newline|'\n'
name|'db'
op|'.'
name|'aggregate_metadata_delete'
op|'('
name|'context'
op|','
name|'aggregate'
op|'.'
name|'id'
op|','
name|'host'
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'master_compute'
op|'=='
name|'host'
op|':'
newline|'\n'
comment|'# Remove master from its own pool -> destroy pool only if the'
nl|'\n'
comment|'# master is on its own, otherwise raise fault. Destroying a'
nl|'\n'
comment|'# pool made only by master is fictional'
nl|'\n'
indent|'            '
name|'if'
name|'len'
op|'('
name|'aggregate'
op|'.'
name|'hosts'
op|')'
op|'>'
number|'1'
op|':'
newline|'\n'
comment|'# NOTE: this could be avoided by doing a master'
nl|'\n'
comment|'# re-election, but this is simpler for now.'
nl|'\n'
indent|'                '
name|'raise'
name|'exception'
op|'.'
name|'InvalidAggregateAction'
op|'('
nl|'\n'
name|'aggregate_id'
op|'='
name|'aggregate'
op|'.'
name|'id'
op|','
nl|'\n'
name|'action'
op|'='
string|"'remove_from_aggregate'"
op|','
nl|'\n'
name|'reason'
op|'='
name|'_'
op|'('
string|"'Unable to eject %(host)s '"
nl|'\n'
string|"'from the pool; pool not empty'"
op|')'
nl|'\n'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_clear_pool'
op|'('
name|'aggregate'
op|'.'
name|'id'
op|')'
newline|'\n'
name|'for'
name|'key'
name|'in'
op|'['
string|"'master_compute'"
op|','
name|'host'
op|']'
op|':'
newline|'\n'
indent|'                '
name|'db'
op|'.'
name|'aggregate_metadata_delete'
op|'('
name|'context'
op|','
name|'aggregate'
op|'.'
name|'id'
op|','
name|'key'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'elif'
name|'master_compute'
name|'and'
name|'master_compute'
op|'!='
name|'host'
op|':'
newline|'\n'
comment|'# A master exists -> forward pool-eject request to master'
nl|'\n'
indent|'            '
name|'forward_request'
op|'('
name|'context'
op|','
string|'"remove_aggregate_host"'
op|','
name|'master_compute'
op|','
nl|'\n'
name|'aggregate'
op|'.'
name|'id'
op|','
name|'host'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_host_addr'
op|','
name|'self'
op|'.'
name|'_host_uuid'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
comment|"# this shouldn't have happened"
nl|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'AggregateError'
op|'('
name|'aggregate_id'
op|'='
name|'aggregate'
op|'.'
name|'id'
op|','
nl|'\n'
name|'action'
op|'='
string|"'remove_from_aggregate'"
op|','
nl|'\n'
name|'reason'
op|'='
name|'_'
op|'('
string|"'Unable to eject %(host)s '"
nl|'\n'
string|"'from the pool; No master found'"
op|')'
nl|'\n'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_join_slave
dedent|''
dedent|''
name|'def'
name|'_join_slave'
op|'('
name|'self'
op|','
name|'aggregate_id'
op|','
name|'host'
op|','
name|'compute_uuid'
op|','
name|'url'
op|','
name|'user'
op|','
name|'passwd'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Joins a slave into a XenServer resource pool."""'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'args'
op|'='
op|'{'
string|"'compute_uuid'"
op|':'
name|'compute_uuid'
op|','
nl|'\n'
string|"'url'"
op|':'
name|'url'
op|','
nl|'\n'
string|"'user'"
op|':'
name|'user'
op|','
nl|'\n'
string|"'password'"
op|':'
name|'passwd'
op|','
nl|'\n'
string|"'force'"
op|':'
name|'json'
op|'.'
name|'dumps'
op|'('
name|'FLAGS'
op|'.'
name|'use_join_force'
op|')'
op|','
nl|'\n'
string|"'master_addr'"
op|':'
name|'self'
op|'.'
name|'_host_addr'
op|','
nl|'\n'
string|"'master_user'"
op|':'
name|'FLAGS'
op|'.'
name|'xenapi_connection_username'
op|','
nl|'\n'
string|"'master_pass'"
op|':'
name|'FLAGS'
op|'.'
name|'xenapi_connection_password'
op|','
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_plugin'
op|'('
string|"'xenhost'"
op|','
string|"'host_join'"
op|','
name|'args'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'XenAPI'
op|'.'
name|'Failure'
name|'as'
name|'e'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
string|'"Pool-Join failed: %(e)s"'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'AggregateError'
op|'('
name|'aggregate_id'
op|'='
name|'aggregate_id'
op|','
nl|'\n'
name|'action'
op|'='
string|"'add_to_aggregate'"
op|','
nl|'\n'
name|'reason'
op|'='
name|'_'
op|'('
string|"'Unable to join %(host)s '"
nl|'\n'
string|"'in the pool'"
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_eject_slave
dedent|''
dedent|''
name|'def'
name|'_eject_slave'
op|'('
name|'self'
op|','
name|'aggregate_id'
op|','
name|'compute_uuid'
op|','
name|'host_uuid'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Eject a slave from a XenServer resource pool."""'
newline|'\n'
name|'try'
op|':'
newline|'\n'
comment|'# shutdown nova-compute; if there are other VMs running, e.g.'
nl|'\n'
comment|"# guest instances, the eject will fail. That's a precaution"
nl|'\n'
comment|'# to deal with the fact that the admin should evacuate the host'
nl|'\n'
comment|'# first. The eject wipes out the host completely.'
nl|'\n'
indent|'            '
name|'vm_ref'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'VM.get_by_uuid'"
op|','
name|'compute_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|'"VM.clean_shutdown"'
op|','
name|'vm_ref'
op|')'
newline|'\n'
nl|'\n'
name|'host_ref'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'host.get_by_uuid'"
op|','
name|'host_uuid'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|'"pool.eject"'
op|','
name|'host_ref'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'XenAPI'
op|'.'
name|'Failure'
name|'as'
name|'e'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
string|'"Pool-eject failed: %(e)s"'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'AggregateError'
op|'('
name|'aggregate_id'
op|'='
name|'aggregate_id'
op|','
nl|'\n'
name|'action'
op|'='
string|"'remove_from_aggregate'"
op|','
nl|'\n'
name|'reason'
op|'='
name|'str'
op|'('
name|'e'
op|'.'
name|'details'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_init_pool
dedent|''
dedent|''
name|'def'
name|'_init_pool'
op|'('
name|'self'
op|','
name|'aggregate_id'
op|','
name|'aggregate_name'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Set the name label of a XenServer pool."""'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'pool_ref'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|'"pool.get_all"'
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|'"pool.set_name_label"'
op|','
nl|'\n'
name|'pool_ref'
op|','
name|'aggregate_name'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'XenAPI'
op|'.'
name|'Failure'
name|'as'
name|'e'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
string|'"Unable to set up pool: %(e)s."'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'AggregateError'
op|'('
name|'aggregate_id'
op|'='
name|'aggregate_id'
op|','
nl|'\n'
name|'action'
op|'='
string|"'add_to_aggregate'"
op|','
nl|'\n'
name|'reason'
op|'='
name|'str'
op|'('
name|'e'
op|'.'
name|'details'
op|')'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_clear_pool
dedent|''
dedent|''
name|'def'
name|'_clear_pool'
op|'('
name|'self'
op|','
name|'aggregate_id'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Clear the name label of a XenServer pool."""'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'pool_ref'
op|'='
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'pool.get_all'"
op|')'
op|'['
number|'0'
op|']'
newline|'\n'
name|'self'
op|'.'
name|'_session'
op|'.'
name|'call_xenapi'
op|'('
string|"'pool.set_name_label'"
op|','
name|'pool_ref'
op|','
string|"''"
op|')'
newline|'\n'
dedent|''
name|'except'
name|'self'
op|'.'
name|'XenAPI'
op|'.'
name|'Failure'
name|'as'
name|'e'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'error'
op|'('
name|'_'
op|'('
string|'"Pool-set_name_label failed: %(e)s"'
op|')'
op|'%'
name|'locals'
op|'('
op|')'
op|')'
newline|'\n'
name|'raise'
name|'exception'
op|'.'
name|'AggregateError'
op|'('
name|'aggregate_id'
op|'='
name|'aggregate_id'
op|','
nl|'\n'
name|'action'
op|'='
string|"'remove_from_aggregate'"
op|','
nl|'\n'
name|'reason'
op|'='
name|'str'
op|'('
name|'e'
op|'.'
name|'details'
op|')'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|forward_request
dedent|''
dedent|''
dedent|''
name|'def'
name|'forward_request'
op|'('
name|'context'
op|','
name|'request_type'
op|','
name|'master'
op|','
name|'aggregate_id'
op|','
nl|'\n'
name|'slave_compute'
op|','
name|'slave_address'
op|','
name|'slave_uuid'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Casts add/remove requests to the pool master."""'
newline|'\n'
comment|'# replace the address from the xenapi connection url'
nl|'\n'
comment|'# because this might be 169.254.0.1, i.e. xenapi'
nl|'\n'
comment|"# NOTE: password in clear is not great, but it'll do for now"
nl|'\n'
name|'sender_url'
op|'='
name|'swap_xapi_host'
op|'('
name|'FLAGS'
op|'.'
name|'xenapi_connection_url'
op|','
name|'slave_address'
op|')'
newline|'\n'
name|'rpc'
op|'.'
name|'cast'
op|'('
name|'context'
op|','
name|'db'
op|'.'
name|'queue_get_for'
op|'('
name|'context'
op|','
name|'FLAGS'
op|'.'
name|'compute_topic'
op|','
name|'master'
op|')'
op|','
nl|'\n'
op|'{'
string|'"method"'
op|':'
name|'request_type'
op|','
nl|'\n'
string|'"args"'
op|':'
op|'{'
string|'"aggregate_id"'
op|':'
name|'aggregate_id'
op|','
nl|'\n'
string|'"host"'
op|':'
name|'slave_compute'
op|','
nl|'\n'
string|'"url"'
op|':'
name|'sender_url'
op|','
nl|'\n'
string|'"user"'
op|':'
name|'FLAGS'
op|'.'
name|'xenapi_connection_username'
op|','
nl|'\n'
string|'"passwd"'
op|':'
name|'FLAGS'
op|'.'
name|'xenapi_connection_password'
op|','
nl|'\n'
string|'"compute_uuid"'
op|':'
name|'vm_utils'
op|'.'
name|'get_this_vm_uuid'
op|'('
op|')'
op|','
nl|'\n'
string|'"xenhost_uuid"'
op|':'
name|'slave_uuid'
op|','
op|'}'
op|','
nl|'\n'
op|'}'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|swap_xapi_host
dedent|''
name|'def'
name|'swap_xapi_host'
op|'('
name|'url'
op|','
name|'host_addr'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Replace the XenServer address present in \'url\' with \'host_addr\'."""'
newline|'\n'
name|'temp_url'
op|'='
name|'urlparse'
op|'.'
name|'urlparse'
op|'('
name|'url'
op|')'
newline|'\n'
name|'_netloc'
op|','
name|'sep'
op|','
name|'port'
op|'='
name|'temp_url'
op|'.'
name|'netloc'
op|'.'
name|'partition'
op|'('
string|"':'"
op|')'
newline|'\n'
name|'return'
name|'url'
op|'.'
name|'replace'
op|'('
name|'temp_url'
op|'.'
name|'netloc'
op|','
string|"'%s%s%s'"
op|'%'
op|'('
name|'host_addr'
op|','
name|'sep'
op|','
name|'port'
op|')'
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit
