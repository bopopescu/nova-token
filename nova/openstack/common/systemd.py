begin_unit
comment|'# Copyright 2012-2014 Red Hat, Inc.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
string|'"""\nHelper module for systemd service readiness notification.\n"""'
newline|'\n'
nl|'\n'
name|'import'
name|'logging'
newline|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'socket'
newline|'\n'
name|'import'
name|'sys'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|LOG
name|'LOG'
op|'='
name|'logging'
op|'.'
name|'getLogger'
op|'('
name|'__name__'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|_abstractify
name|'def'
name|'_abstractify'
op|'('
name|'socket_name'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'if'
name|'socket_name'
op|'.'
name|'startswith'
op|'('
string|"'@'"
op|')'
op|':'
newline|'\n'
comment|'# abstract namespace socket'
nl|'\n'
indent|'        '
name|'socket_name'
op|'='
string|"'\\0%s'"
op|'%'
name|'socket_name'
op|'['
number|'1'
op|':'
op|']'
newline|'\n'
dedent|''
name|'return'
name|'socket_name'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|_sd_notify
dedent|''
name|'def'
name|'_sd_notify'
op|'('
name|'unset_env'
op|','
name|'msg'
op|')'
op|':'
newline|'\n'
indent|'    '
name|'notify_socket'
op|'='
name|'os'
op|'.'
name|'getenv'
op|'('
string|"'NOTIFY_SOCKET'"
op|')'
newline|'\n'
name|'if'
name|'notify_socket'
op|':'
newline|'\n'
indent|'        '
name|'sock'
op|'='
name|'socket'
op|'.'
name|'socket'
op|'('
name|'socket'
op|'.'
name|'AF_UNIX'
op|','
name|'socket'
op|'.'
name|'SOCK_DGRAM'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'sock'
op|'.'
name|'connect'
op|'('
name|'_abstractify'
op|'('
name|'notify_socket'
op|')'
op|')'
newline|'\n'
name|'sock'
op|'.'
name|'sendall'
op|'('
name|'msg'
op|')'
newline|'\n'
name|'if'
name|'unset_env'
op|':'
newline|'\n'
indent|'                '
name|'del'
name|'os'
op|'.'
name|'environ'
op|'['
string|"'NOTIFY_SOCKET'"
op|']'
newline|'\n'
dedent|''
dedent|''
name|'except'
name|'EnvironmentError'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'debug'
op|'('
string|'"Systemd notification failed"'
op|','
name|'exc_info'
op|'='
name|'True'
op|')'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'            '
name|'sock'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|notify
dedent|''
dedent|''
dedent|''
name|'def'
name|'notify'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Send notification to Systemd that service is ready.\n\n    For details see\n    http://www.freedesktop.org/software/systemd/man/sd_notify.html\n    """'
newline|'\n'
name|'_sd_notify'
op|'('
name|'False'
op|','
string|"'READY=1'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|notify_once
dedent|''
name|'def'
name|'notify_once'
op|'('
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Send notification once to Systemd that service is ready.\n\n    Systemd sets NOTIFY_SOCKET environment variable with the name of the\n    socket listening for notifications from services.\n    This method removes the NOTIFY_SOCKET environment variable to ensure\n    notification is sent only once.\n    """'
newline|'\n'
name|'_sd_notify'
op|'('
name|'True'
op|','
string|"'READY=1'"
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|onready
dedent|''
name|'def'
name|'onready'
op|'('
name|'notify_socket'
op|','
name|'timeout'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Wait for systemd style notification on the socket.\n\n    :param notify_socket: local socket address\n    :type notify_socket:  string\n    :param timeout:       socket timeout\n    :type timeout:        float\n    :returns:             0 service ready\n                          1 service not ready\n                          2 timeout occurred\n    """'
newline|'\n'
name|'sock'
op|'='
name|'socket'
op|'.'
name|'socket'
op|'('
name|'socket'
op|'.'
name|'AF_UNIX'
op|','
name|'socket'
op|'.'
name|'SOCK_DGRAM'
op|')'
newline|'\n'
name|'sock'
op|'.'
name|'settimeout'
op|'('
name|'timeout'
op|')'
newline|'\n'
name|'sock'
op|'.'
name|'bind'
op|'('
name|'_abstractify'
op|'('
name|'notify_socket'
op|')'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'        '
name|'msg'
op|'='
name|'sock'
op|'.'
name|'recv'
op|'('
number|'512'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'socket'
op|'.'
name|'timeout'
op|':'
newline|'\n'
indent|'        '
name|'return'
number|'2'
newline|'\n'
dedent|''
name|'finally'
op|':'
newline|'\n'
indent|'        '
name|'sock'
op|'.'
name|'close'
op|'('
op|')'
newline|'\n'
dedent|''
name|'if'
string|"'READY=1'"
name|'in'
name|'msg'
op|':'
newline|'\n'
indent|'        '
name|'return'
number|'0'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'return'
number|'1'
newline|'\n'
nl|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'__name__'
op|'=='
string|"'__main__'"
op|':'
newline|'\n'
comment|'# simple CLI for testing'
nl|'\n'
indent|'    '
name|'if'
name|'len'
op|'('
name|'sys'
op|'.'
name|'argv'
op|')'
op|'=='
number|'1'
op|':'
newline|'\n'
indent|'        '
name|'notify'
op|'('
op|')'
newline|'\n'
dedent|''
name|'elif'
name|'len'
op|'('
name|'sys'
op|'.'
name|'argv'
op|')'
op|'>='
number|'2'
op|':'
newline|'\n'
DECL|variable|timeout
indent|'        '
name|'timeout'
op|'='
name|'float'
op|'('
name|'sys'
op|'.'
name|'argv'
op|'['
number|'1'
op|']'
op|')'
newline|'\n'
DECL|variable|notify_socket
name|'notify_socket'
op|'='
name|'os'
op|'.'
name|'getenv'
op|'('
string|"'NOTIFY_SOCKET'"
op|')'
newline|'\n'
name|'if'
name|'notify_socket'
op|':'
newline|'\n'
DECL|variable|retval
indent|'            '
name|'retval'
op|'='
name|'onready'
op|'('
name|'notify_socket'
op|','
name|'timeout'
op|')'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
name|'retval'
op|')'
newline|'\n'
dedent|''
dedent|''
dedent|''
endmarker|''
end_unit
