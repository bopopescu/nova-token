begin_unit
comment|'# Copyright (c) 2012 OpenStack Foundation'
nl|'\n'
comment|'# All Rights Reserved.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Licensed under the Apache License, Version 2.0 (the "License"); you may'
nl|'\n'
comment|'#    not use this file except in compliance with the License. You may obtain'
nl|'\n'
comment|'#    a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#         http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT'
nl|'\n'
comment|'#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the'
nl|'\n'
comment|'#    License for the specific language governing permissions and limitations'
nl|'\n'
comment|'#    under the License.'
nl|'\n'
nl|'\n'
string|'"""\nClaim objects for use with resource tracking.\n"""'
newline|'\n'
nl|'\n'
name|'from'
name|'oslo_log'
name|'import'
name|'log'
name|'as'
name|'logging'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'i18n'
name|'import'
name|'_'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'i18n'
name|'import'
name|'_LI'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'i18n'
name|'import'
name|'_LW'
newline|'\n'
name|'from'
name|'nova'
name|'import'
name|'objects'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'virt'
name|'import'
name|'hardware'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|variable|LOG
name|'LOG'
op|'='
name|'logging'
op|'.'
name|'getLogger'
op|'('
name|'__name__'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|NopClaim
name|'class'
name|'NopClaim'
op|'('
name|'object'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""For use with compute drivers that do not support resource tracking."""'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'migration'
op|'='
name|'kwargs'
op|'.'
name|'pop'
op|'('
string|"'migration'"
op|','
name|'None'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'claimed_numa_topology'
op|'='
name|'None'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|disk_gb
name|'def'
name|'disk_gb'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
number|'0'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|memory_mb
name|'def'
name|'memory_mb'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
number|'0'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|vcpus
name|'def'
name|'vcpus'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
number|'0'
newline|'\n'
nl|'\n'
DECL|member|__enter__
dedent|''
name|'def'
name|'__enter__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
newline|'\n'
nl|'\n'
DECL|member|__exit__
dedent|''
name|'def'
name|'__exit__'
op|'('
name|'self'
op|','
name|'exc_type'
op|','
name|'exc_val'
op|','
name|'exc_tb'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'exc_type'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'abort'
op|'('
op|')'
newline|'\n'
nl|'\n'
DECL|member|abort
dedent|''
dedent|''
name|'def'
name|'abort'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'pass'
newline|'\n'
nl|'\n'
DECL|member|__str__
dedent|''
name|'def'
name|'__str__'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
string|'"[Claim: %d MB memory, %d GB disk]"'
op|'%'
op|'('
name|'self'
op|'.'
name|'memory_mb'
op|','
nl|'\n'
name|'self'
op|'.'
name|'disk_gb'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|Claim
dedent|''
dedent|''
name|'class'
name|'Claim'
op|'('
name|'NopClaim'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""A declaration that a compute host operation will require free resources.\n    Claims serve as marker objects that resources are being held until the\n    update_available_resource audit process runs to do a full reconciliation\n    of resource usage.\n\n    This information will be used to help keep the local compute hosts\'s\n    ComputeNode model in sync to aid the scheduler in making efficient / more\n    correct decisions with respect to host selection.\n    """'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'tracker'
op|','
name|'resources'
op|','
name|'overhead'
op|'='
name|'None'
op|','
nl|'\n'
name|'limits'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'super'
op|'('
name|'Claim'
op|','
name|'self'
op|')'
op|'.'
name|'__init__'
op|'('
op|')'
newline|'\n'
comment|'# Stash a copy of the instance at the current point of time'
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|'='
name|'instance'
op|'.'
name|'obj_clone'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_numa_topology_loaded'
op|'='
name|'False'
newline|'\n'
name|'self'
op|'.'
name|'tracker'
op|'='
name|'tracker'
newline|'\n'
nl|'\n'
name|'if'
name|'not'
name|'overhead'
op|':'
newline|'\n'
indent|'            '
name|'overhead'
op|'='
op|'{'
string|"'memory_mb'"
op|':'
number|'0'
op|'}'
newline|'\n'
nl|'\n'
dedent|''
name|'self'
op|'.'
name|'overhead'
op|'='
name|'overhead'
newline|'\n'
name|'self'
op|'.'
name|'context'
op|'='
name|'context'
newline|'\n'
nl|'\n'
comment|'# Check claim at constructor to avoid mess code'
nl|'\n'
comment|'# Raise exception ComputeResourcesUnavailable if claim failed'
nl|'\n'
name|'self'
op|'.'
name|'_claim_test'
op|'('
name|'resources'
op|','
name|'limits'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|disk_gb
name|'def'
name|'disk_gb'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'instance'
op|'.'
name|'root_gb'
op|'+'
name|'self'
op|'.'
name|'instance'
op|'.'
name|'ephemeral_gb'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|memory_mb
name|'def'
name|'memory_mb'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'instance'
op|'.'
name|'memory_mb'
op|'+'
name|'self'
op|'.'
name|'overhead'
op|'['
string|"'memory_mb'"
op|']'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|vcpus
name|'def'
name|'vcpus'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'instance'
op|'.'
name|'vcpus'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|numa_topology
name|'def'
name|'numa_topology'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'self'
op|'.'
name|'_numa_topology_loaded'
op|':'
newline|'\n'
indent|'            '
name|'return'
name|'self'
op|'.'
name|'_numa_topology'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_numa_topology'
op|'='
name|'self'
op|'.'
name|'instance'
op|'.'
name|'numa_topology'
newline|'\n'
name|'return'
name|'self'
op|'.'
name|'_numa_topology'
newline|'\n'
nl|'\n'
DECL|member|abort
dedent|''
dedent|''
name|'def'
name|'abort'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Compute operation requiring claimed resources has failed or\n        been aborted.\n        """'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
string|'"Aborting claim: %s"'
op|','
name|'self'
op|','
name|'instance'
op|'='
name|'self'
op|'.'
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'abort_instance_claim'
op|'('
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_claim_test
dedent|''
name|'def'
name|'_claim_test'
op|'('
name|'self'
op|','
name|'resources'
op|','
name|'limits'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Test if this claim can be satisfied given available resources and\n        optional oversubscription limits\n\n        This should be called before the compute node actually consumes the\n        resources required to execute the claim.\n\n        :param resources: available local compute node resources\n        :returns: Return true if resources are available to claim.\n        """'
newline|'\n'
name|'if'
name|'not'
name|'limits'
op|':'
newline|'\n'
indent|'            '
name|'limits'
op|'='
op|'{'
op|'}'
newline|'\n'
nl|'\n'
comment|'# If an individual limit is None, the resource will be considered'
nl|'\n'
comment|'# unlimited:'
nl|'\n'
dedent|''
name|'memory_mb_limit'
op|'='
name|'limits'
op|'.'
name|'get'
op|'('
string|"'memory_mb'"
op|')'
newline|'\n'
name|'disk_gb_limit'
op|'='
name|'limits'
op|'.'
name|'get'
op|'('
string|"'disk_gb'"
op|')'
newline|'\n'
name|'vcpus_limit'
op|'='
name|'limits'
op|'.'
name|'get'
op|'('
string|"'vcpu'"
op|')'
newline|'\n'
name|'numa_topology_limit'
op|'='
name|'limits'
op|'.'
name|'get'
op|'('
string|"'numa_topology'"
op|')'
newline|'\n'
nl|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_LI'
op|'('
string|'"Attempting claim: memory %(memory_mb)d MB, "'
nl|'\n'
string|'"disk %(disk_gb)d GB, vcpus %(vcpus)d CPU"'
op|')'
op|','
nl|'\n'
op|'{'
string|"'memory_mb'"
op|':'
name|'self'
op|'.'
name|'memory_mb'
op|','
string|"'disk_gb'"
op|':'
name|'self'
op|'.'
name|'disk_gb'
op|','
nl|'\n'
string|"'vcpus'"
op|':'
name|'self'
op|'.'
name|'vcpus'
op|'}'
op|','
name|'instance'
op|'='
name|'self'
op|'.'
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'reasons'
op|'='
op|'['
name|'self'
op|'.'
name|'_test_memory'
op|'('
name|'resources'
op|','
name|'memory_mb_limit'
op|')'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_test_disk'
op|'('
name|'resources'
op|','
name|'disk_gb_limit'
op|')'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_test_vcpus'
op|'('
name|'resources'
op|','
name|'vcpus_limit'
op|')'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_test_numa_topology'
op|'('
name|'resources'
op|','
name|'numa_topology_limit'
op|')'
op|','
nl|'\n'
name|'self'
op|'.'
name|'_test_pci'
op|'('
op|')'
op|']'
newline|'\n'
name|'reasons'
op|'='
name|'reasons'
op|'+'
name|'self'
op|'.'
name|'_test_ext_resources'
op|'('
name|'limits'
op|')'
newline|'\n'
name|'reasons'
op|'='
op|'['
name|'r'
name|'for'
name|'r'
name|'in'
name|'reasons'
name|'if'
name|'r'
name|'is'
name|'not'
name|'None'
op|']'
newline|'\n'
name|'if'
name|'len'
op|'('
name|'reasons'
op|')'
op|'>'
number|'0'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'ComputeResourcesUnavailable'
op|'('
name|'reason'
op|'='
nl|'\n'
string|'"; "'
op|'.'
name|'join'
op|'('
name|'reasons'
op|')'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_LI'
op|'('
string|"'Claim successful'"
op|')'
op|','
name|'instance'
op|'='
name|'self'
op|'.'
name|'instance'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_memory
dedent|''
name|'def'
name|'_test_memory'
op|'('
name|'self'
op|','
name|'resources'
op|','
name|'limit'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'type_'
op|'='
name|'_'
op|'('
string|'"memory"'
op|')'
newline|'\n'
name|'unit'
op|'='
string|'"MB"'
newline|'\n'
name|'total'
op|'='
name|'resources'
op|'['
string|"'memory_mb'"
op|']'
newline|'\n'
name|'used'
op|'='
name|'resources'
op|'['
string|"'memory_mb_used'"
op|']'
newline|'\n'
name|'requested'
op|'='
name|'self'
op|'.'
name|'memory_mb'
newline|'\n'
nl|'\n'
name|'return'
name|'self'
op|'.'
name|'_test'
op|'('
name|'type_'
op|','
name|'unit'
op|','
name|'total'
op|','
name|'used'
op|','
name|'requested'
op|','
name|'limit'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_disk
dedent|''
name|'def'
name|'_test_disk'
op|'('
name|'self'
op|','
name|'resources'
op|','
name|'limit'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'type_'
op|'='
name|'_'
op|'('
string|'"disk"'
op|')'
newline|'\n'
name|'unit'
op|'='
string|'"GB"'
newline|'\n'
name|'total'
op|'='
name|'resources'
op|'['
string|"'local_gb'"
op|']'
newline|'\n'
name|'used'
op|'='
name|'resources'
op|'['
string|"'local_gb_used'"
op|']'
newline|'\n'
name|'requested'
op|'='
name|'self'
op|'.'
name|'disk_gb'
newline|'\n'
nl|'\n'
name|'return'
name|'self'
op|'.'
name|'_test'
op|'('
name|'type_'
op|','
name|'unit'
op|','
name|'total'
op|','
name|'used'
op|','
name|'requested'
op|','
name|'limit'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_vcpus
dedent|''
name|'def'
name|'_test_vcpus'
op|'('
name|'self'
op|','
name|'resources'
op|','
name|'limit'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'type_'
op|'='
name|'_'
op|'('
string|'"vcpu"'
op|')'
newline|'\n'
name|'unit'
op|'='
string|'"VCPU"'
newline|'\n'
name|'total'
op|'='
name|'resources'
op|'['
string|"'vcpus'"
op|']'
newline|'\n'
name|'used'
op|'='
name|'resources'
op|'['
string|"'vcpus_used'"
op|']'
newline|'\n'
name|'requested'
op|'='
name|'self'
op|'.'
name|'vcpus'
newline|'\n'
nl|'\n'
name|'return'
name|'self'
op|'.'
name|'_test'
op|'('
name|'type_'
op|','
name|'unit'
op|','
name|'total'
op|','
name|'used'
op|','
name|'requested'
op|','
name|'limit'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_pci
dedent|''
name|'def'
name|'_test_pci'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'pci_requests'
op|'='
name|'objects'
op|'.'
name|'InstancePCIRequests'
op|'.'
name|'get_by_instance_uuid'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'instance'
op|'.'
name|'uuid'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'pci_requests'
op|'.'
name|'requests'
op|':'
newline|'\n'
indent|'            '
name|'devs'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'pci_tracker'
op|'.'
name|'claim_instance'
op|'('
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'devs'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'_'
op|'('
string|"'Claim pci failed.'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_ext_resources
dedent|''
dedent|''
dedent|''
name|'def'
name|'_test_ext_resources'
op|'('
name|'self'
op|','
name|'limits'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'ext_resources_handler'
op|'.'
name|'test_resources'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|','
name|'limits'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_numa_topology
dedent|''
name|'def'
name|'_test_numa_topology'
op|'('
name|'self'
op|','
name|'resources'
op|','
name|'limit'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'host_topology'
op|'='
name|'resources'
op|'.'
name|'get'
op|'('
string|"'numa_topology'"
op|')'
newline|'\n'
name|'requested_topology'
op|'='
name|'self'
op|'.'
name|'numa_topology'
newline|'\n'
name|'if'
name|'host_topology'
op|':'
newline|'\n'
indent|'            '
name|'host_topology'
op|'='
name|'objects'
op|'.'
name|'NUMATopology'
op|'.'
name|'obj_from_db_obj'
op|'('
nl|'\n'
name|'host_topology'
op|')'
newline|'\n'
name|'pci_requests'
op|'='
name|'objects'
op|'.'
name|'InstancePCIRequests'
op|'.'
name|'get_by_instance_uuid'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'instance'
op|'.'
name|'uuid'
op|')'
newline|'\n'
nl|'\n'
name|'pci_stats'
op|'='
name|'None'
newline|'\n'
name|'if'
name|'pci_requests'
op|'.'
name|'requests'
op|':'
newline|'\n'
indent|'                '
name|'pci_stats'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'pci_tracker'
op|'.'
name|'stats'
newline|'\n'
nl|'\n'
dedent|''
name|'instance_topology'
op|'='
op|'('
nl|'\n'
name|'hardware'
op|'.'
name|'numa_fit_instance_to_host'
op|'('
nl|'\n'
name|'host_topology'
op|','
name|'requested_topology'
op|','
nl|'\n'
name|'limits'
op|'='
name|'limit'
op|','
nl|'\n'
name|'pci_requests'
op|'='
name|'pci_requests'
op|'.'
name|'requests'
op|','
nl|'\n'
name|'pci_stats'
op|'='
name|'pci_stats'
op|')'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'requested_topology'
name|'and'
name|'not'
name|'instance_topology'
op|':'
newline|'\n'
indent|'                '
name|'if'
name|'pci_requests'
op|'.'
name|'requests'
op|':'
newline|'\n'
indent|'                    '
name|'return'
op|'('
name|'_'
op|'('
string|'"Requested instance NUMA topology together with"'
nl|'\n'
string|'" requested PCI devices cannot fit the given"'
nl|'\n'
string|'" host NUMA topology"'
op|')'
op|')'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'                    '
name|'return'
op|'('
name|'_'
op|'('
string|'"Requested instance NUMA topology cannot fit "'
nl|'\n'
string|'"the given host NUMA topology"'
op|')'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'elif'
name|'instance_topology'
op|':'
newline|'\n'
indent|'                '
name|'self'
op|'.'
name|'claimed_numa_topology'
op|'='
name|'instance_topology'
newline|'\n'
nl|'\n'
DECL|member|_test
dedent|''
dedent|''
dedent|''
name|'def'
name|'_test'
op|'('
name|'self'
op|','
name|'type_'
op|','
name|'unit'
op|','
name|'total'
op|','
name|'used'
op|','
name|'requested'
op|','
name|'limit'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Test if the given type of resource needed for a claim can be safely\n        allocated.\n        """'
newline|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_LI'
op|'('
string|"'Total %(type)s: %(total)d %(unit)s, used: %(used).02f '"
nl|'\n'
string|"'%(unit)s'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'type'"
op|':'
name|'type_'
op|','
string|"'total'"
op|':'
name|'total'
op|','
string|"'unit'"
op|':'
name|'unit'
op|','
string|"'used'"
op|':'
name|'used'
op|'}'
op|','
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'limit'
name|'is'
name|'None'
op|':'
newline|'\n'
comment|'# treat resource as unlimited:'
nl|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_LI'
op|'('
string|"'%(type)s limit not specified, defaulting to '"
nl|'\n'
string|"'unlimited'"
op|')'
op|','
op|'{'
string|"'type'"
op|':'
name|'type_'
op|'}'
op|','
name|'instance'
op|'='
name|'self'
op|'.'
name|'instance'
op|')'
newline|'\n'
name|'return'
newline|'\n'
nl|'\n'
dedent|''
name|'free'
op|'='
name|'limit'
op|'-'
name|'used'
newline|'\n'
nl|'\n'
comment|'# Oversubscribed resource policy info:'
nl|'\n'
name|'LOG'
op|'.'
name|'info'
op|'('
name|'_LI'
op|'('
string|"'%(type)s limit: %(limit).02f %(unit)s, '"
nl|'\n'
string|"'free: %(free).02f %(unit)s'"
op|')'
op|','
nl|'\n'
op|'{'
string|"'type'"
op|':'
name|'type_'
op|','
string|"'limit'"
op|':'
name|'limit'
op|','
string|"'free'"
op|':'
name|'free'
op|','
string|"'unit'"
op|':'
name|'unit'
op|'}'
op|','
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'instance'
op|')'
newline|'\n'
nl|'\n'
name|'if'
name|'requested'
op|'>'
name|'free'
op|':'
newline|'\n'
indent|'            '
name|'return'
op|'('
name|'_'
op|'('
string|"'Free %(type)s %(free).02f '"
nl|'\n'
string|"'%(unit)s < requested %(requested)d %(unit)s'"
op|')'
op|'%'
nl|'\n'
op|'{'
string|"'type'"
op|':'
name|'type_'
op|','
string|"'free'"
op|':'
name|'free'
op|','
string|"'unit'"
op|':'
name|'unit'
op|','
nl|'\n'
string|"'requested'"
op|':'
name|'requested'
op|'}'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|MoveClaim
dedent|''
dedent|''
dedent|''
name|'class'
name|'MoveClaim'
op|'('
name|'Claim'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""Claim used for holding resources for an incoming move operation.\n\n    Move can be either a migrate/resize, live-migrate or an evacuate operation.\n    """'
newline|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
name|'context'
op|','
name|'instance'
op|','
name|'instance_type'
op|','
name|'image_meta'
op|','
name|'tracker'
op|','
nl|'\n'
name|'resources'
op|','
name|'overhead'
op|'='
name|'None'
op|','
name|'limits'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'self'
op|'.'
name|'context'
op|'='
name|'context'
newline|'\n'
name|'self'
op|'.'
name|'instance_type'
op|'='
name|'instance_type'
newline|'\n'
name|'self'
op|'.'
name|'image_meta'
op|'='
name|'image_meta'
newline|'\n'
name|'super'
op|'('
name|'MoveClaim'
op|','
name|'self'
op|')'
op|'.'
name|'__init__'
op|'('
name|'context'
op|','
name|'instance'
op|','
name|'tracker'
op|','
nl|'\n'
name|'resources'
op|','
name|'overhead'
op|'='
name|'overhead'
op|','
nl|'\n'
name|'limits'
op|'='
name|'limits'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'migration'
op|'='
name|'None'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|disk_gb
name|'def'
name|'disk_gb'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
op|'('
name|'self'
op|'.'
name|'instance_type'
op|'.'
name|'root_gb'
op|'+'
nl|'\n'
name|'self'
op|'.'
name|'instance_type'
op|'.'
name|'ephemeral_gb'
op|')'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|memory_mb
name|'def'
name|'memory_mb'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'instance_type'
op|'.'
name|'memory_mb'
op|'+'
name|'self'
op|'.'
name|'overhead'
op|'['
string|"'memory_mb'"
op|']'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|vcpus
name|'def'
name|'vcpus'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'instance_type'
op|'.'
name|'vcpus'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|numa_topology
name|'def'
name|'numa_topology'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'image_meta'
op|'='
name|'objects'
op|'.'
name|'ImageMeta'
op|'.'
name|'from_dict'
op|'('
name|'self'
op|'.'
name|'image_meta'
op|')'
newline|'\n'
name|'return'
name|'hardware'
op|'.'
name|'numa_get_constraints'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'instance_type'
op|','
name|'image_meta'
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_pci
dedent|''
name|'def'
name|'_test_pci'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'pci_requests'
op|'='
name|'objects'
op|'.'
name|'InstancePCIRequests'
op|'.'
name|'get_by_instance_uuid_and_newness'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
name|'self'
op|'.'
name|'instance'
op|'.'
name|'uuid'
op|','
name|'True'
op|')'
newline|'\n'
name|'if'
name|'pci_requests'
op|'.'
name|'requests'
op|':'
newline|'\n'
indent|'            '
name|'claim'
op|'='
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'pci_tracker'
op|'.'
name|'stats'
op|'.'
name|'support_requests'
op|'('
nl|'\n'
name|'pci_requests'
op|'.'
name|'requests'
op|')'
newline|'\n'
name|'if'
name|'not'
name|'claim'
op|':'
newline|'\n'
indent|'                '
name|'return'
name|'_'
op|'('
string|"'Claim pci failed.'"
op|')'
newline|'\n'
nl|'\n'
DECL|member|_test_ext_resources
dedent|''
dedent|''
dedent|''
name|'def'
name|'_test_ext_resources'
op|'('
name|'self'
op|','
name|'limits'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'return'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'ext_resources_handler'
op|'.'
name|'test_resources'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'instance_type'
op|','
name|'limits'
op|')'
newline|'\n'
nl|'\n'
DECL|member|abort
dedent|''
name|'def'
name|'abort'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Compute operation requiring claimed resources has failed or\n        been aborted.\n        """'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
string|'"Aborting claim: %s"'
op|','
name|'self'
op|','
name|'instance'
op|'='
name|'self'
op|'.'
name|'instance'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'tracker'
op|'.'
name|'drop_move_claim'
op|'('
nl|'\n'
name|'self'
op|'.'
name|'context'
op|','
nl|'\n'
name|'self'
op|'.'
name|'instance'
op|','
name|'instance_type'
op|'='
name|'self'
op|'.'
name|'instance_type'
op|')'
newline|'\n'
nl|'\n'
DECL|member|create_migration_context
dedent|''
name|'def'
name|'create_migration_context'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'if'
name|'not'
name|'self'
op|'.'
name|'migration'
op|':'
newline|'\n'
indent|'            '
name|'LOG'
op|'.'
name|'warn'
op|'('
name|'_LW'
op|'('
string|'"Can\'t create a migration_context record without a "'
nl|'\n'
string|'"migration object specified."'
op|')'
op|','
nl|'\n'
name|'instance'
op|'='
name|'self'
op|'.'
name|'instance'
op|')'
newline|'\n'
name|'return'
newline|'\n'
nl|'\n'
dedent|''
name|'mig_context'
op|'='
name|'objects'
op|'.'
name|'MigrationContext'
op|'('
nl|'\n'
name|'context'
op|'='
name|'self'
op|'.'
name|'context'
op|','
name|'instance_uuid'
op|'='
name|'self'
op|'.'
name|'instance'
op|'.'
name|'uuid'
op|','
nl|'\n'
name|'migration_id'
op|'='
name|'self'
op|'.'
name|'migration'
op|'.'
name|'id'
op|','
nl|'\n'
name|'old_numa_topology'
op|'='
name|'self'
op|'.'
name|'instance'
op|'.'
name|'numa_topology'
op|','
nl|'\n'
name|'new_numa_topology'
op|'='
name|'self'
op|'.'
name|'claimed_numa_topology'
op|')'
newline|'\n'
name|'return'
name|'mig_context'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
