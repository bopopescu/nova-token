begin_unit
comment|'# Copyright (c) AT&T 2012-2013 Yun Mao <yunmao@gmail.com>'
nl|'\n'
comment|'# Copyright 2012 IBM Corp.'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Licensed under the Apache License, Version 2.0 (the "License");'
nl|'\n'
comment|'# you may not use this file except in compliance with the License.'
nl|'\n'
comment|'# You may obtain a copy of the License at'
nl|'\n'
comment|'#'
nl|'\n'
comment|'#    http://www.apache.org/licenses/LICENSE-2.0'
nl|'\n'
comment|'#'
nl|'\n'
comment|'# Unless required by applicable law or agreed to in writing, software'
nl|'\n'
comment|'# distributed under the License is distributed on an "AS IS" BASIS,'
nl|'\n'
comment|'# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or'
nl|'\n'
comment|'# implied.'
nl|'\n'
comment|'# See the License for the specific language governing permissions and'
nl|'\n'
comment|'# limitations under the License.'
nl|'\n'
nl|'\n'
name|'import'
name|'os'
newline|'\n'
nl|'\n'
name|'import'
name|'eventlet'
newline|'\n'
name|'from'
name|'oslo_config'
name|'import'
name|'cfg'
newline|'\n'
name|'from'
name|'oslo_log'
name|'import'
name|'log'
name|'as'
name|'logging'
newline|'\n'
name|'from'
name|'oslo_utils'
name|'import'
name|'importutils'
newline|'\n'
nl|'\n'
name|'from'
name|'nova'
name|'import'
name|'exception'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'i18n'
name|'import'
name|'_LE'
op|','
name|'_LW'
newline|'\n'
name|'from'
name|'nova'
op|'.'
name|'servicegroup'
op|'.'
name|'drivers'
name|'import'
name|'base'
newline|'\n'
nl|'\n'
DECL|variable|evzookeeper
name|'evzookeeper'
op|'='
name|'importutils'
op|'.'
name|'try_import'
op|'('
string|"'evzookeeper'"
op|')'
newline|'\n'
DECL|variable|membership
name|'membership'
op|'='
name|'importutils'
op|'.'
name|'try_import'
op|'('
string|"'evzookeeper.membership'"
op|')'
newline|'\n'
DECL|variable|zookeeper
name|'zookeeper'
op|'='
name|'importutils'
op|'.'
name|'try_import'
op|'('
string|"'zookeeper'"
op|')'
newline|'\n'
nl|'\n'
DECL|variable|zk_driver_opts
name|'zk_driver_opts'
op|'='
op|'['
nl|'\n'
name|'cfg'
op|'.'
name|'StrOpt'
op|'('
string|"'address'"
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'The ZooKeeper addresses for servicegroup service in the '"
nl|'\n'
string|"'format of host1:port,host2:port,host3:port'"
op|')'
op|','
nl|'\n'
name|'cfg'
op|'.'
name|'IntOpt'
op|'('
string|"'recv_timeout'"
op|','
nl|'\n'
DECL|variable|default
name|'default'
op|'='
number|'4000'
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'The recv_timeout parameter for the zk session'"
op|')'
op|','
nl|'\n'
name|'cfg'
op|'.'
name|'StrOpt'
op|'('
string|"'sg_prefix'"
op|','
nl|'\n'
DECL|variable|default
name|'default'
op|'='
string|'"/servicegroups"'
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'The prefix used in ZooKeeper to store ephemeral nodes'"
op|')'
op|','
nl|'\n'
name|'cfg'
op|'.'
name|'IntOpt'
op|'('
string|"'sg_retry_interval'"
op|','
nl|'\n'
DECL|variable|default
name|'default'
op|'='
number|'5'
op|','
nl|'\n'
DECL|variable|help
name|'help'
op|'='
string|"'Number of seconds to wait until retrying to join the '"
nl|'\n'
string|"'session'"
op|')'
op|','
nl|'\n'
op|']'
newline|'\n'
nl|'\n'
DECL|variable|CONF
name|'CONF'
op|'='
name|'cfg'
op|'.'
name|'CONF'
newline|'\n'
name|'CONF'
op|'.'
name|'register_opts'
op|'('
name|'zk_driver_opts'
op|','
name|'group'
op|'='
string|'"zookeeper"'
op|')'
newline|'\n'
nl|'\n'
DECL|variable|LOG
name|'LOG'
op|'='
name|'logging'
op|'.'
name|'getLogger'
op|'('
name|'__name__'
op|')'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|class|ZooKeeperDriver
name|'class'
name|'ZooKeeperDriver'
op|'('
name|'base'
op|'.'
name|'Driver'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""ZooKeeper driver for the service group API."""'
newline|'\n'
nl|'\n'
DECL|member|__init__
name|'def'
name|'__init__'
op|'('
name|'self'
op|','
op|'*'
name|'args'
op|','
op|'**'
name|'kwargs'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Create the zk session object."""'
newline|'\n'
name|'if'
name|'not'
name|'all'
op|'('
op|'['
name|'evzookeeper'
op|','
name|'membership'
op|','
name|'zookeeper'
op|']'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'ImportError'
op|'('
string|"'zookeeper module not found'"
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_memberships'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'self'
op|'.'
name|'_monitors'
op|'='
op|'{'
op|'}'
newline|'\n'
name|'super'
op|'('
name|'ZooKeeperDriver'
op|','
name|'self'
op|')'
op|'.'
name|'__init__'
op|'('
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_cached_session'
op|'='
name|'None'
newline|'\n'
nl|'\n'
dedent|''
op|'@'
name|'property'
newline|'\n'
DECL|member|_session
name|'def'
name|'_session'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Creates zookeeper session in lazy manner.\n\n        Session is created in lazy manner to mitigate lock problem\n        in zookeeper.\n\n        Lock happens when many processes try to use the same zk handle.\n        Lazy creation allows to deffer initialization of session until\n        is really required by worker (child process).\n\n        :returns: ZKSession -- new or created earlier\n        """'
newline|'\n'
name|'if'
name|'self'
op|'.'
name|'_cached_session'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'self'
op|'.'
name|'_cached_session'
op|'='
name|'self'
op|'.'
name|'_init_session'
op|'('
op|')'
newline|'\n'
dedent|''
name|'return'
name|'self'
op|'.'
name|'_cached_session'
newline|'\n'
nl|'\n'
DECL|member|_init_session
dedent|''
name|'def'
name|'_init_session'
op|'('
name|'self'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Initializes new session.\n\n        Optionally creates required servicegroup prefix.\n\n        :returns ZKSession - newly created session\n        """'
newline|'\n'
name|'null'
op|'='
name|'open'
op|'('
name|'os'
op|'.'
name|'devnull'
op|','
string|'"w"'
op|')'
newline|'\n'
name|'session'
op|'='
name|'evzookeeper'
op|'.'
name|'ZKSession'
op|'('
name|'CONF'
op|'.'
name|'zookeeper'
op|'.'
name|'address'
op|','
nl|'\n'
name|'recv_timeout'
op|'='
nl|'\n'
name|'CONF'
op|'.'
name|'zookeeper'
op|'.'
name|'recv_timeout'
op|','
nl|'\n'
name|'zklog_fd'
op|'='
name|'null'
op|')'
newline|'\n'
comment|'# Make sure the prefix exists'
nl|'\n'
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'session'
op|'.'
name|'create'
op|'('
name|'CONF'
op|'.'
name|'zookeeper'
op|'.'
name|'sg_prefix'
op|','
string|'""'
op|','
nl|'\n'
name|'acl'
op|'='
op|'['
name|'evzookeeper'
op|'.'
name|'ZOO_OPEN_ACL_UNSAFE'
op|']'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'zookeeper'
op|'.'
name|'NodeExistsException'
op|':'
newline|'\n'
indent|'            '
name|'pass'
newline|'\n'
comment|'# Log a warning about quality for this driver.'
nl|'\n'
dedent|''
name|'LOG'
op|'.'
name|'warning'
op|'('
name|'_LW'
op|'('
string|"'The ZooKeeper service group driver in Nova is not '"
nl|'\n'
string|"'tested by the OpenStack project and thus its quality '"
nl|'\n'
string|"'can not be ensured. This may change in the future, '"
nl|'\n'
string|"'but current deployers should be aware that the use '"
nl|'\n'
string|"'of it in production right now may be risky.'"
op|')'
op|')'
newline|'\n'
name|'return'
name|'session'
newline|'\n'
nl|'\n'
DECL|member|join
dedent|''
name|'def'
name|'join'
op|'('
name|'self'
op|','
name|'member'
op|','
name|'group'
op|','
name|'service'
op|'='
name|'None'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Add a new member to a service group.\n\n        :param member: the joined member ID/name\n        :param group: the group ID/name, of the joined member\n        :param service: a `nova.service.Service` object\n        """'
newline|'\n'
name|'process_id'
op|'='
name|'str'
op|'('
name|'os'
op|'.'
name|'getpid'
op|'('
op|')'
op|')'
newline|'\n'
name|'LOG'
op|'.'
name|'debug'
op|'('
string|"'ZooKeeperDriver: join new member %(id)s(%(pid)s) to the '"
nl|'\n'
string|"'%(gr)s group, service=%(sr)s'"
op|','
nl|'\n'
op|'{'
string|"'id'"
op|':'
name|'member'
op|','
string|"'pid'"
op|':'
name|'process_id'
op|','
nl|'\n'
string|"'gr'"
op|':'
name|'group'
op|','
string|"'sr'"
op|':'
name|'service'
op|'}'
op|')'
newline|'\n'
name|'member'
op|'='
name|'self'
op|'.'
name|'_memberships'
op|'.'
name|'get'
op|'('
op|'('
name|'group'
op|','
name|'member'
op|')'
op|','
name|'None'
op|')'
newline|'\n'
name|'if'
name|'member'
name|'is'
name|'None'
op|':'
newline|'\n'
comment|'# the first time to join. Generate a new object'
nl|'\n'
indent|'            '
name|'path'
op|'='
string|'"%s/%s/%s"'
op|'%'
op|'('
name|'CONF'
op|'.'
name|'zookeeper'
op|'.'
name|'sg_prefix'
op|','
name|'group'
op|','
name|'member'
op|')'
newline|'\n'
name|'try'
op|':'
newline|'\n'
indent|'                '
name|'zk_member'
op|'='
name|'membership'
op|'.'
name|'Membership'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'path'
op|','
nl|'\n'
name|'process_id'
op|')'
newline|'\n'
dedent|''
name|'except'
name|'RuntimeError'
op|':'
newline|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'exception'
op|'('
name|'_LE'
op|'('
string|'"Unable to join. It is possible that either"'
nl|'\n'
string|'" another node exists with the same name, or"'
nl|'\n'
string|'" this node just restarted. We will try "'
nl|'\n'
string|'"again in a short while to make sure."'
op|')'
op|')'
newline|'\n'
name|'eventlet'
op|'.'
name|'sleep'
op|'('
name|'CONF'
op|'.'
name|'zookeeper'
op|'.'
name|'sg_retry_interval'
op|')'
newline|'\n'
name|'zk_member'
op|'='
name|'membership'
op|'.'
name|'Membership'
op|'('
name|'self'
op|'.'
name|'_session'
op|','
name|'path'
op|','
name|'member'
op|')'
newline|'\n'
dedent|''
name|'self'
op|'.'
name|'_memberships'
op|'['
op|'('
name|'group'
op|','
name|'member'
op|')'
op|']'
op|'='
name|'zk_member'
newline|'\n'
nl|'\n'
DECL|member|is_up
dedent|''
dedent|''
name|'def'
name|'is_up'
op|'('
name|'self'
op|','
name|'service_ref'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'group_id'
op|'='
name|'service_ref'
op|'['
string|"'topic'"
op|']'
newline|'\n'
name|'member_id'
op|'='
name|'service_ref'
op|'['
string|"'host'"
op|']'
newline|'\n'
name|'all_members'
op|'='
name|'self'
op|'.'
name|'_get_all'
op|'('
name|'group_id'
op|')'
newline|'\n'
name|'return'
name|'member_id'
name|'in'
name|'all_members'
newline|'\n'
nl|'\n'
DECL|member|_get_all
dedent|''
name|'def'
name|'_get_all'
op|'('
name|'self'
op|','
name|'group_id'
op|')'
op|':'
newline|'\n'
indent|'        '
string|'"""Return all members in a list, or a ServiceGroupUnavailable\n        exception.\n        """'
newline|'\n'
name|'monitor'
op|'='
name|'self'
op|'.'
name|'_monitors'
op|'.'
name|'get'
op|'('
name|'group_id'
op|','
name|'None'
op|')'
newline|'\n'
name|'if'
name|'monitor'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'path'
op|'='
string|'"%s/%s"'
op|'%'
op|'('
name|'CONF'
op|'.'
name|'zookeeper'
op|'.'
name|'sg_prefix'
op|','
name|'group_id'
op|')'
newline|'\n'
nl|'\n'
name|'null'
op|'='
name|'open'
op|'('
name|'os'
op|'.'
name|'devnull'
op|','
string|'"w"'
op|')'
newline|'\n'
name|'local_session'
op|'='
name|'evzookeeper'
op|'.'
name|'ZKSession'
op|'('
name|'CONF'
op|'.'
name|'zookeeper'
op|'.'
name|'address'
op|','
nl|'\n'
name|'recv_timeout'
op|'='
nl|'\n'
name|'CONF'
op|'.'
name|'zookeeper'
op|'.'
name|'recv_timeout'
op|','
nl|'\n'
name|'zklog_fd'
op|'='
name|'null'
op|')'
newline|'\n'
nl|'\n'
name|'monitor'
op|'='
name|'membership'
op|'.'
name|'MembershipMonitor'
op|'('
name|'local_session'
op|','
name|'path'
op|')'
newline|'\n'
name|'self'
op|'.'
name|'_monitors'
op|'['
name|'group_id'
op|']'
op|'='
name|'monitor'
newline|'\n'
comment|'# Note(maoy): When initialized for the first time, it takes a'
nl|'\n'
comment|'# while to retrieve all members from zookeeper. To prevent'
nl|'\n'
comment|'# None to be returned, we sleep 5 sec max to wait for data to'
nl|'\n'
comment|'# be ready.'
nl|'\n'
name|'timeout'
op|'='
number|'5'
comment|'# seconds'
newline|'\n'
name|'interval'
op|'='
number|'0.1'
newline|'\n'
name|'tries'
op|'='
name|'int'
op|'('
name|'timeout'
op|'/'
name|'interval'
op|')'
newline|'\n'
name|'for'
name|'_retry'
name|'in'
name|'range'
op|'('
name|'tries'
op|')'
op|':'
newline|'\n'
indent|'                '
name|'eventlet'
op|'.'
name|'sleep'
op|'('
name|'interval'
op|')'
newline|'\n'
name|'all_members'
op|'='
name|'monitor'
op|'.'
name|'get_all'
op|'('
op|')'
newline|'\n'
name|'if'
name|'all_members'
name|'is'
name|'not'
name|'None'
op|':'
newline|'\n'
comment|'# Stop the tries once the cache is populated'
nl|'\n'
indent|'                    '
name|'LOG'
op|'.'
name|'debug'
op|'('
string|"'got info about members in %r: %r'"
op|','
nl|'\n'
name|'path'
op|','
string|"', '"
op|'.'
name|'join'
op|'('
name|'all_members'
op|')'
op|')'
newline|'\n'
name|'break'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
comment|"# if all_members, weren't populated"
nl|'\n'
indent|'                '
name|'LOG'
op|'.'
name|'warning'
op|'('
name|'_LW'
op|'('
string|"'Problem with acquiring the list of '"
nl|'\n'
string|"'children of %(path)r within a given '"
nl|'\n'
string|"'timeout=%(timeout)d seconds'"
op|')'
op|','
nl|'\n'
name|'path'
op|','
name|'timeout'
op|')'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'            '
name|'all_members'
op|'='
name|'monitor'
op|'.'
name|'get_all'
op|'('
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'all_members'
name|'is'
name|'None'
op|':'
newline|'\n'
indent|'            '
name|'raise'
name|'exception'
op|'.'
name|'ServiceGroupUnavailable'
op|'('
name|'driver'
op|'='
string|'"ZooKeeperDriver"'
op|')'
newline|'\n'
nl|'\n'
DECL|function|have_processes
dedent|''
name|'def'
name|'have_processes'
op|'('
name|'member'
op|')'
op|':'
newline|'\n'
indent|'            '
string|'"""Predicate that given member has processes (subnode exists)."""'
newline|'\n'
name|'value'
op|','
name|'stat'
op|'='
name|'monitor'
op|'.'
name|'get_member_details'
op|'('
name|'member'
op|')'
newline|'\n'
comment|'# only check nodes that are created by Membership class'
nl|'\n'
name|'if'
name|'value'
op|'=='
string|"'ZKMembers'"
op|':'
newline|'\n'
indent|'                '
name|'num_children'
op|'='
name|'stat'
op|'['
string|"'numChildren'"
op|']'
newline|'\n'
name|'return'
name|'num_children'
op|'>'
number|'0'
newline|'\n'
dedent|''
name|'else'
op|':'
newline|'\n'
comment|'# unknown type of node found - ignoring'
nl|'\n'
indent|'                '
name|'return'
name|'False'
newline|'\n'
nl|'\n'
comment|'# filter only this members that have processes running'
nl|'\n'
dedent|''
dedent|''
name|'all_members'
op|'='
name|'filter'
op|'('
name|'have_processes'
op|','
name|'all_members'
op|')'
newline|'\n'
nl|'\n'
name|'return'
name|'all_members'
newline|'\n'
dedent|''
dedent|''
endmarker|''
end_unit
