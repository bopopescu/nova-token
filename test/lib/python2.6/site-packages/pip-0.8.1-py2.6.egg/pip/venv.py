begin_unit
string|'"""Tools for working with virtualenv environments"""'
newline|'\n'
nl|'\n'
name|'import'
name|'os'
newline|'\n'
name|'import'
name|'sys'
newline|'\n'
name|'import'
name|'subprocess'
newline|'\n'
name|'from'
name|'pip'
op|'.'
name|'exceptions'
name|'import'
name|'BadCommand'
newline|'\n'
name|'from'
name|'pip'
op|'.'
name|'log'
name|'import'
name|'logger'
newline|'\n'
nl|'\n'
nl|'\n'
DECL|function|restart_in_venv
name|'def'
name|'restart_in_venv'
op|'('
name|'venv'
op|','
name|'base'
op|','
name|'site_packages'
op|','
name|'args'
op|')'
op|':'
newline|'\n'
indent|'    '
string|'"""\n    Restart this script using the interpreter in the given virtual environment\n    """'
newline|'\n'
name|'if'
name|'base'
name|'and'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'isabs'
op|'('
name|'venv'
op|')'
name|'and'
name|'not'
name|'venv'
op|'.'
name|'startswith'
op|'('
string|"'~'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'base'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'expanduser'
op|'('
name|'base'
op|')'
newline|'\n'
comment|'# ensure we have an abs basepath at this point:'
nl|'\n'
comment|'#    a relative one makes no sense (or does it?)'
nl|'\n'
name|'if'
name|'os'
op|'.'
name|'path'
op|'.'
name|'isabs'
op|'('
name|'base'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'venv'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'base'
op|','
name|'venv'
op|')'
newline|'\n'
nl|'\n'
dedent|''
dedent|''
name|'if'
name|'venv'
op|'.'
name|'startswith'
op|'('
string|"'~'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'venv'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'expanduser'
op|'('
name|'venv'
op|')'
newline|'\n'
nl|'\n'
dedent|''
name|'if'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'venv'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'try'
op|':'
newline|'\n'
indent|'            '
name|'import'
name|'virtualenv'
newline|'\n'
dedent|''
name|'except'
name|'ImportError'
op|':'
newline|'\n'
indent|'            '
name|'print'
string|"'The virtual environment does not exist: %s'"
op|'%'
name|'venv'
newline|'\n'
name|'print'
string|"'and virtualenv is not installed, so a new environment cannot be created'"
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
number|'3'
op|')'
newline|'\n'
dedent|''
name|'print'
string|"'Creating new virtualenv environment in %s'"
op|'%'
name|'venv'
newline|'\n'
name|'virtualenv'
op|'.'
name|'logger'
op|'='
name|'logger'
newline|'\n'
name|'logger'
op|'.'
name|'indent'
op|'+='
number|'2'
newline|'\n'
name|'virtualenv'
op|'.'
name|'create_environment'
op|'('
name|'venv'
op|','
name|'site_packages'
op|'='
name|'site_packages'
op|')'
newline|'\n'
dedent|''
name|'if'
name|'sys'
op|'.'
name|'platform'
op|'=='
string|"'win32'"
op|':'
newline|'\n'
indent|'        '
name|'python'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'venv'
op|','
string|"'Scripts'"
op|','
string|"'python.exe'"
op|')'
newline|'\n'
comment|'# check for bin directory which is used in buildouts'
nl|'\n'
name|'if'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'python'
op|')'
op|':'
newline|'\n'
indent|'            '
name|'python'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'venv'
op|','
string|"'bin'"
op|','
string|"'python.exe'"
op|')'
newline|'\n'
dedent|''
dedent|''
name|'else'
op|':'
newline|'\n'
indent|'        '
name|'python'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'venv'
op|','
string|"'bin'"
op|','
string|"'python'"
op|')'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'python'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'python'
op|'='
name|'venv'
newline|'\n'
dedent|''
name|'if'
name|'not'
name|'os'
op|'.'
name|'path'
op|'.'
name|'exists'
op|'('
name|'python'
op|')'
op|':'
newline|'\n'
indent|'        '
name|'raise'
name|'BadCommand'
op|'('
string|"'Cannot find virtual environment interpreter at %s'"
op|'%'
name|'python'
op|')'
newline|'\n'
dedent|''
name|'base'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'dirname'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'dirname'
op|'('
name|'python'
op|')'
op|')'
newline|'\n'
name|'file'
op|'='
name|'os'
op|'.'
name|'path'
op|'.'
name|'join'
op|'('
name|'os'
op|'.'
name|'path'
op|'.'
name|'dirname'
op|'('
name|'__file__'
op|')'
op|','
string|"'runner.py'"
op|')'
newline|'\n'
name|'if'
name|'file'
op|'.'
name|'endswith'
op|'('
string|"'.pyc'"
op|')'
op|':'
newline|'\n'
indent|'        '
name|'file'
op|'='
name|'file'
op|'['
op|':'
op|'-'
number|'1'
op|']'
newline|'\n'
dedent|''
name|'proc'
op|'='
name|'subprocess'
op|'.'
name|'Popen'
op|'('
nl|'\n'
op|'['
name|'python'
op|','
name|'file'
op|']'
op|'+'
name|'args'
op|'+'
op|'['
name|'base'
op|','
string|"'___VENV_RESTART___'"
op|']'
op|')'
newline|'\n'
name|'proc'
op|'.'
name|'wait'
op|'('
op|')'
newline|'\n'
name|'sys'
op|'.'
name|'exit'
op|'('
name|'proc'
op|'.'
name|'returncode'
op|')'
newline|'\n'
dedent|''
endmarker|''
end_unit
